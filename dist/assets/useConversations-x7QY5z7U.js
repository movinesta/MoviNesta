import{e as z,f as W,s as M}from"./index-Be1QrzZ4.js";const Y=o=>{if(!o)return"";try{const e=JSON.parse(o);if(!e||typeof e!="object")return typeof e=="string"?e:o;if(typeof e.text=="string")return e.text;const d=e.blocks;if(Array.isArray(d)){const c=d.map(a=>typeof(a==null?void 0:a.text)=="string"?a.text.trim():"").filter(Boolean);if(c.length>0)return c.join(`
`)}return e.type==="image"?typeof e.caption=="string"&&e.caption.trim()?e.caption:"Photo":typeof e.message=="string"?e.message:o}catch{return o}},k=o=>o.replace(/\s+/g," ").replace(/\u200B/g,"").trim(),H=(o,e=80)=>{if(!o)return null;const d=Y(o),c=k(d);if(!c)return null;let a=c;return a.toLowerCase()==="photo"&&(a="ðŸ“· Photo"),a.length<=e?a:`${a.slice(0,e-1).trimEnd()}â€¦`},K=o=>{if(!o)return null;const e=new Date(o);if(Number.isNaN(e.getTime()))return null;const c=new Date().getTime()-e.getTime();if(c<=0)return"Just now";const a=Math.floor(c/1e3);if(a<45)return"Just now";const y=Math.floor(a/60);if(y<60)return`${y} min ago`;const f=Math.floor(y/60);if(f<24)return`${f} h ago`;const m=Math.floor(f/24);if(m===1)return"Yesterday";if(m<7)return`${m} days ago`;const g=Math.floor(m/7);if(g<4)return`${g} wk${g===1?"":"s"} ago`;const u=Math.floor(m/30);if(u<1)return`${g} wk${g===1?"":"s"} ago`;if(u<12)return`${u} mo${u===1?"":"s"} ago`;const A=Math.floor(u/12);return`${A} yr${A===1?"":"s"} ago`},Z=()=>{const{user:o}=z(),e=(o==null?void 0:o.id)??null;return W({queryKey:["conversations",e],enabled:!!e,refetchOnWindowFocus:!1,refetchOnReconnect:!1,queryFn:async()=>{if(!e)return[];const{data:d,error:c}=await M.from("conversation_participants").select("conversation_id").eq("user_id",e);if(c)throw console.error("[useConversations] Failed to load participants",c),new Error(c.message);if(!d||d.length===0)return[];const a=Array.from(new Set(d.map(t=>t.conversation_id).filter(t=>!!t)));if(a.length===0)return[];const{data:y,error:f}=await M.from("conversations").select("id, is_group, title, created_at, updated_at, created_by").in("id",a).order("updated_at",{ascending:!1});if(f)throw console.error("[useConversations] Failed to load conversations",f),new Error(f.message);const m=y??[],{data:g,error:u}=await M.from("conversation_participants").select("conversation_id, user_id, role, created_at").in("conversation_id",a);if(u)throw console.error("[useConversations] Failed to load conversation participants",u),new Error(u.message);const A=g??[],B=Array.from(new Set(A.map(t=>t.user_id).filter(t=>!!t)));let C=new Map;if(B.length>0){const{data:t,error:n}=await M.from("profiles").select("id, username, display_name, avatar_url").in("id",B);if(n)throw console.error("[useConversations] Failed to load profiles",n),new Error(n.message);C=new Map((t??[]).map(i=>[i.id,{id:i.id,username:i.username??null,displayName:i.display_name??null,avatarUrl:i.avatar_url??null}]))}const{data:x,error:D}=await M.from("messages").select("id, conversation_id, sender_id, body, created_at").in("conversation_id",a).order("created_at",{ascending:!1});if(D)throw console.error("[useConversations] Failed to load messages",D),new Error(D.message);const b=x??[],N=new Map;for(const t of b){const n=t.conversation_id;N.has(n)||N.set(n,[]),N.get(n).push(t)}const{data:U,error:$}=await M.from("message_read_receipts").select("conversation_id, user_id, last_read_at").in("conversation_id",a);if($)throw console.error("[useConversations] Failed to load read receipts",$),new Error($.message);const E=new Map;for(const t of U??[]){const n=t.conversation_id,i=t.user_id,_=t.last_read_at??null;let l=E.get(n);l||(l={selfLastReadAt:null,others:[]},E.set(n,l)),i===e?l.selfLastReadAt=_:l.others.push({userId:i,lastReadAt:_})}return[...m.map(t=>{const n=t.id,i=!!t.is_group,l=A.filter(s=>s.conversation_id===n).map(s=>{const r=C.get(s.user_id),T=(r==null?void 0:r.displayName)??(r==null?void 0:r.username)??"Unknown user";return{id:(r==null?void 0:r.id)??s.user_id,displayName:T,username:(r==null?void 0:r.username)??null,avatarUrl:(r==null?void 0:r.avatarUrl)??null,isSelf:s.user_id===e}}),v=l.filter(s=>!s.isSelf),J=l.some(s=>s.isSelf);let F,R;if(i)F=t.title??(v.length>0?v.slice(0,3).map(s=>s.displayName).join(", "):"Group conversation"),R=v.length>0?`${l.length} participants`:"Group conversation";else{const s=v[0]??l[0];F=(s==null?void 0:s.displayName)??"Direct message",R=(s==null?void 0:s.username)!=null?`@${s.username}`:J&&v.length===0?"Just you":"Direct message"}const p=(N.get(n)??[])[0],j=p?H(p.body):null,w=p?p.created_at:t.updated_at??t.created_at,q=K(w),h=E.get(n),I=(h==null?void 0:h.selfLastReadAt)??null,G=!!w&&(!I||new Date(w).getTime()>new Date(I).getTime()),S=!!p&&p.sender_id===e;let P=!1;if(!i&&p&&S&&w){const r=((h==null?void 0:h.others)??[])[0];if(r!=null&&r.lastReadAt){const T=new Date(w).getTime(),L=new Date(r.lastReadAt).getTime();!Number.isNaN(T)&&!Number.isNaN(L)&&L>=T&&(P=!0)}}return{id:n,isGroup:i,title:F,subtitle:R,participants:l,lastMessagePreview:j,lastMessageAt:w??null,lastMessageAtLabel:q,hasUnread:G,lastMessageIsFromSelf:S,lastMessageSeenByOthers:P}})].sort((t,n)=>{const i=t.lastMessageAt?new Date(t.lastMessageAt).getTime():0,_=n.lastMessageAt?new Date(n.lastMessageAt).getTime():0,l=Number.isNaN(i)?0:i;return(Number.isNaN(_)?0:_)-l})}})};export{Y as p,Z as u};
