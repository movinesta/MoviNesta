import{c as K,e as te,b as ne,f as se,g as Z,s as v,h as Ce,u as Te,r as m,j as e,L as Re,H as Ee,A as Ae,U as De,I as Me,i as X,R as Ie}from"./index-Be1QrzZ4.js";import{u as Pe,p as $e}from"./useConversations-x7QY5z7U.js";import{S as qe}from"./send-JzWMe0if.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=K("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=K("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=K("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=K("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]),Ue=a=>{var _,h;const{user:s}=te(),l=(s==null?void 0:s.id)??null,t=ne(),c=["block-status",l,a],x=se({queryKey:c,enabled:!!(l&&a&&l!==a),staleTime:3e4,queryFn:async()=>{if(!l||!a||l===a)return{youBlocked:!1,blockedYou:!1};const{data:y,error:E}=await v.from("blocked_users").select("blocker_id, blocked_id").or(`and(blocker_id.eq.${l},blocked_id.eq.${a}),and(blocker_id.eq.${a},blocked_id.eq.${l})`);if(E)throw console.error("[useBlockStatus] Failed to load block status",E),new Error(E.message);const D=y??[],q=D.some(R=>R.blocker_id===l&&R.blocked_id===a),L=D.some(R=>R.blocker_id===a&&R.blocked_id===l);return{youBlocked:q,blockedYou:L}}}),f=Z({mutationFn:async()=>{if(!l||!a)throw new Error("Missing user ids for block operation.");const{error:y}=await v.from("blocked_users").upsert({blocker_id:l,blocked_id:a},{onConflict:"blocker_id,blocked_id"});if(y)throw console.error("[useBlockStatus] Failed to block user",y),new Error(y.message)},onSuccess:()=>{t.invalidateQueries({queryKey:c})}}),i=Z({mutationFn:async()=>{if(!l||!a)throw new Error("Missing user ids for unblock operation.");const{error:y}=await v.from("blocked_users").delete().eq("blocker_id",l).eq("blocked_id",a);if(y)throw console.error("[useBlockStatus] Failed to unblock user",y),new Error(y.message)},onSuccess:()=>{t.invalidateQueries({queryKey:c})}}),p=((_=x.data)==null?void 0:_.youBlocked)??!1,w=((h=x.data)==null?void 0:h.blockedYou)??!1,k=p||w,N=f.isPending||i.isPending;return{youBlocked:p,blockedYou:w,isBlocked:k,isLoading:x.isLoading||N,isError:x.isError,error:x.error??null,block:f,unblock:i}},ce=a=>{const s=new Date(a);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0})},Ye=a=>se({queryKey:["conversation",a,"messages"],enabled:!!a,refetchOnWindowFocus:!1,refetchOnReconnect:!1,queryFn:async()=>{if(!a)return[];const{data:s,error:l}=await v.from("messages").select("id, conversation_id, sender_id, body, attachment_url, created_at").eq("conversation_id",a).order("created_at",{ascending:!0});if(l)throw console.error("[ConversationPage] Failed to load messages",l),new Error(l.message);return(s??[]).map(t=>({id:t.id,conversationId:t.conversation_id,senderId:t.sender_id,body:t.body??null,attachmentUrl:t.attachment_url??null,createdAt:t.created_at}))}}),Ke=a=>se({queryKey:["conversation",a,"readReceipts"],enabled:!!a,refetchOnWindowFocus:!1,refetchOnReconnect:!1,queryFn:async()=>{if(!a)return[];const{data:s,error:l}=await v.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",a);if(l)throw console.error("[ConversationPage] Failed to load read receipts",l),new Error(l.message);return(s??[]).map(t=>({userId:t.user_id,lastReadAt:t.last_read_at??null,lastReadMessageId:t.last_read_message_id??null}))}}),Oe=a=>{const{user:s}=te(),l=(s==null?void 0:s.id)??null,t=ne();return Z({mutationFn:async({text:c,attachmentPath:x})=>{if(!a)throw new Error("Missing conversation id.");if(!l)throw new Error("You must be signed in to send messages.");const f=c.trim(),i=x&&f?{type:"text+image",text:f}:x?{type:"image",text:""}:{type:"text",text:f},{data:p,error:w}=await v.from("messages").insert({conversation_id:a,sender_id:l,body:JSON.stringify(i),attachment_url:x??null}).select("id, conversation_id, sender_id, body, attachment_url, created_at").single();if(w)throw console.error("[ConversationPage] Failed to send message",w),new Error(w.message);const k={id:p.id,conversationId:p.conversation_id,senderId:p.sender_id,body:p.body??null,attachmentUrl:p.attachment_url??null,createdAt:p.created_at};try{await v.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",a)}catch(N){console.error("[ConversationPage] Failed to update conversation timestamp",N)}return k},onMutate:async({text:c,attachmentPath:x})=>{if(!a||!l)return{previousMessages:void 0,tempId:null};const f=`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,i=new Date().toISOString(),p={id:f,conversationId:a,senderId:l,body:JSON.stringify({type:"text",text:c.trim()}),attachmentUrl:x??null,createdAt:i};await t.cancelQueries({queryKey:["conversation",a,"messages"]});const w=t.getQueryData(["conversation",a,"messages"]);return t.setQueryData(["conversation",a,"messages"],k=>{const _=[...k??[],p];return _.sort((h,y)=>new Date(h.createdAt).getTime()-new Date(y.createdAt).getTime()),_}),{previousMessages:w,tempId:f}},onError:(c,x,f)=>{console.error("[ConversationPage] sendMessage error",c),f!=null&&f.previousMessages&&a&&t.setQueryData(["conversation",a,"messages"],f.previousMessages)},onSuccess:(c,x,f)=>{if(!a)return;const i=f==null?void 0:f.tempId;t.setQueryData(["conversation",a,"messages"],p=>{const w=p??[],k=i?w.filter(h=>h.id!==i):w.filter(h=>h.id!==c.id),N=k.findIndex(h=>h.id===c.id);if(N>=0){const h=[...k];return h[N]=c,h}const _=[...k,c];return _.sort((h,y)=>new Date(h.createdAt).getTime()-new Date(y.createdAt).getTime()),_}),t.invalidateQueries({queryKey:["conversations"]})}})},ze=({path:a})=>{const[s,l]=m.useState(null),[t,c]=m.useState(!1);return m.useEffect(()=>{let x=!1;return(async()=>{const{data:i,error:p}=await v.storage.from("chat-media").createSignedUrl(a,3600);if(!x){if(p||!(i!=null&&i.signedUrl)){console.error("[ChatImage] createSignedUrl error",p),c(!0);return}l(i.signedUrl)}})(),()=>{x=!0}},[a]),t?e.jsx("div",{className:"mt-1 text-[11px] text-mn-text-muted",children:"Image unavailable."}):s?e.jsx("div",{className:"mt-1 overflow-hidden rounded-xl border border-mn-border-subtle/70 bg-mn-bg/80",children:e.jsx("img",{src:s,alt:"Attachment",className:"max-h-64 w-full object-cover",loading:"lazy"})}):e.jsx("div",{className:"mt-1 h-32 w-40 animate-pulse rounded-xl bg-mn-border-subtle/40"})},Je=()=>{const{conversationId:a}=Ce(),s=a??null,l=Te(),{user:t}=te(),c=ne(),{data:x,isLoading:f}=Pe(),{data:i,isLoading:p,isError:w,error:k}=Ye(s),N=Oe(s),[_,h]=m.useState(""),y=m.useRef(null),[E,D]=m.useState(!1),q=m.useRef(null),L=m.useRef(null),R=m.useRef(null),u=m.useMemo(()=>!s||!x?null:x.find(n=>n.id===s)??null,[s,x]),O=m.useMemo(()=>{const n=new Map;if(!u)return n;for(const r of u.participants)n.set(r.id,r);return n},[u]),A=(u==null?void 0:u.isGroup)??!1,S=m.useMemo(()=>{if(!u)return null;const n=u.participants.filter(r=>!r.isSelf);return n.length>0?n[0]:u.participants.length===1?u.participants[0]:null},[u]),{youBlocked:re,blockedYou:B,isBlocked:Y,isLoading:me,block:z,unblock:V}=Ue(A?null:(S==null?void 0:S.id)??null),ae=((i==null?void 0:i.length)??0)>0,ie=f||p||me,[P,G]=m.useState([]),$=m.useRef(new Map),H=m.useRef(null),F=m.useRef({conversationId:null,messageId:null,userId:null}),M=m.useRef({isTyping:!1,timeoutId:null}),{data:W}=Ke(s),Q=m.useMemo(()=>{if(!i||!(t!=null&&t.id))return null;const n=i.filter(r=>r.senderId===t.id);return n.length>0?n[n.length-1]:null},[i,t==null?void 0:t.id]),I=m.useMemo(()=>{if(!u||!Q||!W||!(t!=null&&t.id))return null;const n=u.participants.filter(d=>!d.isSelf);if(n.length===0)return null;const r=[];let o=null;for(const d of n){const b=W.find(C=>C.userId===d.id);if(!b||!b.lastReadAt)continue;const g=new Date(b.lastReadAt).getTime(),T=new Date(Q.createdAt).getTime();Number.isNaN(g)||Number.isNaN(T)||g>=T&&(r.push(d),(!o||g<new Date(o).getTime())&&(o=b.lastReadAt))}return r.length===0?null:{seenParticipants:r,earliestSeenAt:o}},[u,Q,W,t==null?void 0:t.id]);m.useEffect(()=>{var n;!i||i.length===0||(n=y.current)==null||n.scrollIntoView({behavior:"smooth"})},[i==null?void 0:i.length]),m.useEffect(()=>{F.current={conversationId:null,messageId:null,userId:null}},[s,t==null?void 0:t.id]),m.useEffect(()=>{if(!s||!(t!=null&&t.id))return;const n=v.channel(`supabase_realtime_typing:conversation:${s}`,{config:{broadcast:{self:!1}}});return H.current=n,n.on("broadcast",{event:"typing"},({payload:r})=>{const o=r;if(!o||o.userId===t.id)return;const d=O.get(o.userId),b=(d==null?void 0:d.displayName)??"Someone",g=o.userId,T=$.current.get(g);if(T!=null&&window.clearTimeout(T),o.isTyping){G(j=>j.includes(b)?j:[...j,b]);const C=window.setTimeout(()=>{$.current.delete(g),G(j=>j.filter(U=>U!==b))},4e3);$.current.set(g,C)}else $.current.delete(g),G(C=>C.filter(j=>j!==b))}).subscribe(r=>{console.log("[ConversationPage] Typing channel status",r)}),()=>{$.current.forEach(r=>window.clearTimeout(r)),$.current.clear(),n&&v.removeChannel(n),H.current=null}},[s,t==null?void 0:t.id,O]),m.useEffect(()=>{if(!s)return;const n=v.channel(`supabase_realtime_messages_publication:conversation:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},r=>{console.log("[ConversationPage] Realtime message payload",r);const o=r.new;if(t!=null&&t.id&&o.sender_id===t.id)return;const d={id:o.id,conversationId:o.conversation_id,senderId:o.sender_id,body:o.body,attachmentUrl:o.attachment_url,createdAt:o.created_at};c.setQueryData(["conversation",s,"messages"],b=>{const g=b??[];if(g.some(j=>j.id===d.id))return g;const C=[...g,d];return C.sort((j,U)=>new Date(j.createdAt).getTime()-new Date(U.createdAt).getTime()),C}),c.invalidateQueries({queryKey:["conversations"]})});return n.subscribe(r=>{console.log("[ConversationPage] Realtime channel status (messages)",r),r==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for messages",r)}),()=>{v.removeChannel(n)}},[s,c,t==null?void 0:t.id]),m.useEffect(()=>{if(!s||!i||i.length===0||!(t!=null&&t.id))return;const n=i[i.length-1];F.current.conversationId===s&&F.current.messageId===n.id&&F.current.userId===t.id||v.from("message_read_receipts").upsert({conversation_id:s,user_id:t.id,last_read_message_id:n.id,last_read_at:new Date().toISOString()},{onConflict:"conversation_id,user_id"}).then(()=>{F.current={conversationId:s,messageId:n.id,userId:t.id},c.invalidateQueries({queryKey:["conversations"]})}).catch(r=>{console.error("[ConversationPage] Failed to update read receipt",r)})},[s,i,t==null?void 0:t.id,c]),m.useEffect(()=>{if(!s)return;const n=v.channel(`supabase_realtime_read_receipts:conversation:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},()=>{c.invalidateQueries({queryKey:["conversation",s,"readReceipts"]})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},()=>{c.invalidateQueries({queryKey:["conversation",s,"readReceipts"]})}).subscribe(r=>{console.log("[ConversationPage] Realtime channel status (read receipts)",r),r==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for read receipts",r)});return()=>{v.removeChannel(n)}},[s,c]),m.useEffect(()=>{if(!E)return;const n=r=>{const o=r.target;L.current&&!L.current.contains(o)&&q.current&&!q.current.contains(o)&&D(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[E]);const J=n=>{const r=H.current;if(!r||!s||!t)return;const d=n.trim().length>0,b=M.current.isTyping;d&&!b&&(M.current.isTyping=!0,r.send({type:"broadcast",event:"typing",payload:{userId:t.id,isTyping:!0}})),M.current.timeoutId!=null&&window.clearTimeout(M.current.timeoutId),d?M.current.timeoutId=window.setTimeout(()=>{M.current.isTyping=!1,r.send({type:"broadcast",event:"typing",payload:{userId:t.id,isTyping:!1}})},3e3):!d&&b&&(M.current.isTyping=!1,r.send({type:"broadcast",event:"typing",payload:{userId:t.id,isTyping:!1}}))},fe=n=>{const r=n.target.value;h(r),E&&D(!1),J(r)},ge=n=>{n&&h(r=>{const o=`${r}${n}`;return J(o),o})},xe=n=>{if(n.preventDefault(),Y||B)return;const r=_.trim();!r||N.isPending||(h(""),J(""),N.mutate({text:r,attachmentPath:null}))},he=()=>{!R.current||!s||!(t!=null&&t.id)||R.current.click()},be=async n=>{var o;const r=(o=n.target.files)==null?void 0:o[0];if(n.target.value="",!(!r||!s||!(t!=null&&t.id))&&!(Y||B))try{const d=r.name.split(".").pop()??"jpg",b=`${s}/${t.id}/${Date.now()}.${d}`,{error:g}=await v.storage.from("chat-media").upload(b,r,{cacheControl:"3600",upsert:!1});if(g){console.error("[ConversationPage] image upload error",g);return}N.mutate({text:"",attachmentPath:b})}catch(d){console.error("[ConversationPage] handleImageSelected failed",d)}};return s?e.jsxs("div",{className:"relative flex h-full min-h-[60vh] flex-1 flex-col items-stretch bg-mn-bg",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-10 top-4 h-32 rounded-full bg-gradient-to-r from-fuchsia-500/15 via-mn-primary/10 to-blue-500/15 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 flex-col items-stretch rounded-3xl border border-mn-border-subtle/70 bg-mn-bg/90 shadow-xl shadow-mn-primary/5 backdrop-blur",children:[e.jsxs(Ee,{className:"min-h-[3.5rem] flex-shrink-0 py-3",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>l("/messages"),className:"inline-flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-primary shadow-mn-soft transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:[e.jsx(Ae,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Back to messages"})]}),e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("div",{className:"relative flex h-11 w-11 flex-shrink-0 items-center justify-center overflow-hidden rounded-full bg-mn-bg-elevated ring-2 ring-mn-border-subtle",children:[e.jsx("div",{className:"absolute inset-0 rounded-full bg-gradient-to-br from-fuchsia-500/25 via-mn-primary/20 to-blue-500/25","aria-hidden":"true"}),e.jsx("div",{className:"relative flex h-9 w-9 items-center justify-center overflow-hidden rounded-full bg-mn-bg ring-1 ring-white/30",children:!A&&S?S.avatarUrl?e.jsx("img",{src:S.avatarUrl,alt:S.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-[13px] font-semibold text-mn-text-primary",children:(S.displayName??"U").slice(0,2).toUpperCase()}):e.jsx(De,{className:"h-4 w-4 text-mn-text-secondary","aria-hidden":"true"})})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h1",{className:"truncate text-[15px] font-heading font-semibold text-mn-text-primary",children:(u==null?void 0:u.title)??(S==null?void 0:S.displayName)??"Conversation"}),e.jsx("p",{className:"truncate text-[11px] text-mn-text-secondary",children:u?u.lastMessageAtLabel?`Active ${u.lastMessageAtLabel}`:u.subtitle??(A?`${u.participants.length} participants`:"Active now"):f?"Loadingâ€¦":"Details unavailable"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-mn-text-secondary",children:[u&&u.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Audio call",children:e.jsx(Be,{className:"h-4 w-4","aria-hidden":"true"})}),u&&u.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Video call",children:e.jsx(Qe,{className:"h-4 w-4","aria-hidden":"true"})}),u&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Conversation info",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})}),!A&&S&&e.jsxs("button",{type:"button",disabled:z.isPending||V.isPending,onClick:()=>{re?V.mutate():z.mutate()},className:"ml-1 hidden items-center gap-1 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 px-3 py-1.5 text-[11px] font-semibold text-mn-text-primary ring-1 ring-mn-border-subtle/70 transition hover:-translate-y-0.5 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg disabled:opacity-60 sm:inline-flex",children:[(z.isPending||V.isPending)&&e.jsx(X,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:re?"Unblock":"Block"})]})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col bg-gradient-to-b from-mn-bg/92 via-mn-bg/88 to-mn-bg/92",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-8 top-4 h-20 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-auto px-4 py-4 text-sm",children:[ie&&!ae&&e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-mn-border-subtle bg-mn-bg/80 px-3 py-1.5 text-[12px] text-mn-text-secondary",children:[e.jsx(X,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]})}),w&&e.jsxs("div",{className:"mb-3 rounded-md border border-mn-border-subtle bg-mn-bg/90 px-3 py-2 text-[12px] text-mn-error",children:[e.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),k instanceof Error&&e.jsx("p",{className:"mt-1 text-[11px] text-mn-text-secondary",children:k.message})]}),!ie&&!w&&!ae&&e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsxs("div",{className:"text-center text-[12px] text-mn-text-secondary",children:[e.jsx("p",{className:"font-medium",children:A?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:A?"Be the first to start the conversation.":"Say hi to start the conversation."})]})}),i==null?void 0:i.map((n,r)=>{const o=O.get(n.senderId),d=(o==null?void 0:o.isSelf)??((t==null?void 0:t.id)!=null&&n.senderId===t.id),b=Q!=null&&Q.id===n.id,g=r>0?(i==null?void 0:i[r-1])??null:null,T=r<((i==null?void 0:i.length)??0)-1?(i==null?void 0:i[r+1])??null:null,C=g!=null&&g.senderId===n.senderId,j=T!=null&&T.senderId===n.senderId,U=C&&ue(g.createdAt,n.createdAt),pe=j&&ue(n.createdAt,T.createdAt),ye=!(C&&U),oe=!(j&&pe),le=r===0||g!=null&&!ee(new Date(g.createdAt),new Date(n.createdAt)),ve=r===0||le?"mt-0":ye?"mt-3":"mt-1.5",we=d?"bg-mn-primary/90 text-white shadow-md shadow-mn-primary/20":"bg-mn-bg-elevated text-mn-text-primary border border-mn-border-subtle/80 shadow-mn-soft",je=d?"rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl rounded-br-2xl":"rounded-tr-3xl rounded-tl-3xl rounded-br-3xl rounded-bl-2xl",Ne=(o==null?void 0:o.displayName)??(d?"You":"Someone"),de=$e(n.body),_e=!d&&oe,ke=oe,Se=d?"text-right":"text-left";return e.jsxs(Ie.Fragment,{children:[le&&e.jsx("div",{className:"my-4 flex items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-3 text-[11px] text-mn-text-muted",children:[e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"}),e.jsx("span",{className:"rounded-full bg-mn-bg px-3 py-0.5 text-[11px] font-medium text-mn-text-secondary shadow-mn-soft/60 ring-1 ring-mn-border-subtle/70",children:Ve(n.createdAt)}),e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"})]})}),e.jsxs("div",{className:`flex w-full flex-col gap-0.5 ${ve}`,children:[e.jsxs("div",{className:`flex w-full items-end gap-2 ${d?"justify-end":"justify-start"}`,children:[!d&&e.jsx(e.Fragment,{children:_e?e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0 overflow-hidden rounded-full bg-mn-bg/80 ring-1 ring-mn-border-subtle",children:o!=null&&o.avatarUrl?e.jsx("img",{src:o.avatarUrl,alt:o.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] font-medium text-mn-text-secondary",children:Ne.slice(0,2).toUpperCase()})}):e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0"})}),e.jsx("div",{className:`inline-flex max-w-[80%] px-4 py-2.5 text-[13px] ${je} ${we}`,children:e.jsxs("div",{className:"flex flex-col",children:[de&&e.jsx("p",{className:"whitespace-pre-wrap break-all text-[13px] leading-snug",children:de}),n.attachmentUrl&&e.jsx(ze,{path:n.attachmentUrl})]})})]}),e.jsx("div",{className:`flex w-full ${d?"justify-end":"justify-start"}`,children:ke&&e.jsx("p",{className:`mt-0.5 text-[10px] text-mn-text-muted ${Se}`,children:ce(n.createdAt)})}),d&&b&&I&&e.jsx("div",{className:"flex w-full justify-end",children:e.jsx("p",{className:"mt-0.5 text-[10px] text-mn-text-muted",children:A?I.seenParticipants.length===1?`Seen by ${I.seenParticipants[0].displayName}`:`Seen by ${I.seenParticipants[0].displayName} and ${I.seenParticipants.length-1} others`:I.earliestSeenAt?`Seen ${ce(I.earliestSeenAt)}`:"Seen"})})]})]},n.id)}),P.length>0&&e.jsxs("div",{className:"mt-1 flex items-center justify-start gap-2 text-[11px] text-mn-text-muted",children:[e.jsx("span",{children:A?P.length===1?`${P[0]} is typingâ€¦`:P.length===2?`${P[0]} and ${P[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"})]})]}),e.jsx("div",{ref:y})]}),E&&e.jsx("div",{ref:L,className:"absolute bottom-[4.25rem] left-4 z-30 rounded-2xl border border-mn-border-subtle/60 bg-mn-bg-elevated/95 p-2 shadow-mn-card",children:e.jsx("div",{className:"flex flex-wrap gap-1.5 max-w-[260px]",children:["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ¥¹","ðŸ˜Ž","ðŸ¤”","ðŸ˜­","ðŸ”¥","â¤ï¸","ðŸ‘","ðŸ‘€","ðŸŽ¬","ðŸ¿","â­","ðŸ™Œ"].map(n=>e.jsx("button",{type:"button",onClick:()=>{ge(n),D(!1)},className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-mn-bg hover:bg-mn-bg/70 text-lg transition",children:e.jsx("span",{children:n})},n))})})]}),!Y&&!B&&e.jsx("form",{onSubmit:xe,className:"flex-shrink-0 border-t border-mn-border-subtle/70 bg-mn-bg/95 px-4 py-3 backdrop-blur",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",ref:q,onClick:()=>D(n=>!n),className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Add emoji",children:e.jsx(Fe,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:he,className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Send photo",children:e.jsx(Le,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:R,accept:"image/*",capture:"environment",className:"hidden",onChange:be}),e.jsx("div",{className:"flex min-h-[44px] max-h-[140px] flex-1 items-center rounded-full bg-mn-bg px-4 py-2.5 text-[13px] text-mn-text-primary shadow-inner ring-1 ring-mn-border-subtle/70",children:e.jsx("textarea",{id:"conversation-message",value:_,onChange:fe,onKeyDown:n=>{var r;n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),_.trim()&&((r=n.currentTarget.form)==null||r.requestSubmit()))},placeholder:"Messageâ€¦",rows:1,className:"max-h-[92px] flex-1 resize-none bg-transparent text-[13px] text-mn-text-primary outline-none placeholder:text-mn-text-muted"})}),e.jsx("button",{type:"submit",disabled:!_.trim()||N.isPending,className:"inline-flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-r from-fuchsia-500 via-mn-primary to-blue-500 text-white shadow-lg shadow-mn-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:N.isPending?e.jsx(X,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(qe,{className:"h-4 w-4","aria-hidden":"true"})})]})}),B&&e.jsx("div",{className:"flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Y&&!B&&e.jsx("div",{className:"flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]})]}):e.jsx("div",{className:"flex min-height-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-mn-card border border-mn-border-subtle bg-mn-bg-elevated/80 px-5 py-6 text-center text-sm text-mn-text-primary shadow-mn-card",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-mn-text-secondary",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Re,{to:"/messages",className:"inline-flex items-center justify-center rounded-full border border-mn-border-subtle bg-mn-bg px-3 py-1.5 text-[12px] font-medium text-mn-text-primary shadow-mn-soft transition hover:border-mn-primary/70 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:"Back to messages"})})]})})},ee=(a,s)=>a.getFullYear()===s.getFullYear()&&a.getMonth()===s.getMonth()&&a.getDate()===s.getDate(),Ve=a=>{const s=new Date(a);if(Number.isNaN(s.getTime()))return"";const l=new Date,t=new Date;return t.setDate(l.getDate()-1),ee(s,l)?"Today":ee(s,t)?"Yesterday":s.toLocaleDateString(void 0,{day:"numeric",month:"short",year:"numeric"})},ue=(a,s,l=180*1e3)=>{const t=new Date(a),c=new Date(s);return Number.isNaN(t.getTime())||Number.isNaN(c.getTime())?!1:c.getTime()-t.getTime()<=l};export{Je as default};
