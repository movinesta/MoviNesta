import{r as c,j as e,b as P,f as C,z as E,e as U,w as k,s as y,B as N,E as R}from"./index-FRLeEtOr.js";import{P as L}from"./PageChrome-BOtqw_Vo.js";import{T as S}from"./TopBar-B2GTrBpW.js";import{U as F}from"./user-CAodWlkZ.js";import{C as A}from"./circle-alert-C9LGaVPh.js";import{C as T}from"./circle-check-CsDuMvMv.js";import"./arrow-left-CN4f4Loj.js";const B=({label:t="Avatar",description:s,initialUrl:d=null,disabled:i=!1,onFileChange:n,fallbackIcon:r,className:u})=>{const[x,a]=c.useState(d),l=c.useRef(null),o=c.useRef(null);c.useEffect(()=>{a(d)},[d]),c.useEffect(()=>()=>{o.current&&URL.revokeObjectURL(o.current)},[]);const p=()=>{i||l.current?.click()},f=m=>{const h=m.target.files?.[0]??null;if(!h){n?.(null);return}o.current&&(URL.revokeObjectURL(o.current),o.current=null);const g=URL.createObjectURL(h);o.current=g,a(g),n?.(h)},b="pt-1"+(u?` ${u}`:"");return e.jsxs("div",{className:b,children:[t&&e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:t}),e.jsxs("div",{className:"mt-2 flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:p,disabled:i,className:"relative inline-flex h-12 w-12 items-center justify-center overflow-hidden rounded-full border border-dashed border-border bg-card/80 text-xs font-medium text-muted-foreground hover:border-primary hover:bg-primary/5 focus:outline-none focus:ring-2 focus:ring-primary/40 disabled:cursor-not-allowed disabled:opacity-60","aria-label":"Upload avatar",children:x?e.jsx("img",{src:x,alt:"Avatar preview",className:"h-full w-full object-cover"}):e.jsx("span",{className:"select-none text-lg",children:r??"ðŸ“½ï¸"})}),s&&e.jsx("div",{className:"text-xs text-left text-muted-foreground",children:s})]}),e.jsx("input",{ref:l,type:"file",accept:"image/*",className:"hidden",onChange:f})]})},D=({initialProfile:t,user:s})=>{const d=U(),[i,n]=c.useState({displayName:t.displayName,bio:t.bio,avatarFile:null}),r=k({mutationFn:async({displayName:a,bio:l,avatarFile:o})=>{let p=t.avatarUrl;if(o){const m=(o.name.split(".").pop()??"").trim().toLowerCase();if(!new Set(["jpg","jpeg","png","webp"]).has(m))throw new Error("Please upload a JPG, PNG, or WebP image.");const g={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"},j=`${s.id}/${Date.now()}.${m}`,{error:v,data:w}=await y.storage.from("avatars").upload(j,o,{cacheControl:"3600",upsert:!0,contentType:g[m]??"application/octet-stream"});if(v)throw v;p=w?.path??j}const{error:f}=await y.from("profiles").update({display_name:a.trim(),bio:l.trim(),avatar_url:p??""}).eq("id",s.id);if(f)throw f},onSuccess:()=>{d.invalidateQueries({queryKey:["profile"]}),n(a=>({...a,avatarFile:null}))}}),u=a=>l=>{n(o=>({...o,[a]:l.target.value}))},x=async a=>{a.preventDefault(),!r.isPending&&await r.mutateAsync({displayName:i.displayName,bio:i.bio,avatarFile:i.avatarFile})};return e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsxs("div",{className:"mb-2 flex items-start gap-3",children:[e.jsx("span",{className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-border/50",children:e.jsx(F,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("h2",{className:"text-sm font-heading font-semibold text-foreground",children:"Public profile"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your profile is shown on your diary, reviews, and social features."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(B,{initialUrl:t.avatarUrl,description:"Upload a square image (PNG/JPG) to use across the app.",disabled:r.isPending,onFileChange:a=>n(l=>({...l,avatarFile:a}))}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"displayName",className:"block text-xs font-medium uppercase tracking-[0.16em] text-muted-foreground",children:"Display name"}),e.jsx("input",{id:"displayName",type:"text",value:i.displayName,onChange:u("displayName"),maxLength:80,className:"w-full rounded-md border border-border bg-background px-3 py-2 text-sm text-foreground shadow-sm outline-none ring-0 placeholder:text-muted-foreground focus:border-border focus:ring-2 focus:ring-border/40",placeholder:"How should we show your name?"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This is the name other people see on your profile and activity."})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"bio",className:"block text-xs font-medium uppercase tracking-[0.16em] text-muted-foreground",children:"Bio"}),e.jsx("textarea",{id:"bio",value:i.bio,onChange:u("bio"),rows:4,maxLength:280,className:"w-full resize-none rounded-md border border-border bg-background px-3 py-2 text-sm text-foreground shadow-sm outline-none ring-0 placeholder:text-muted-foreground focus:border-border focus:ring-2 focus:ring-border/40",placeholder:"Tell people a bit about your taste in movies."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can use multiple lines. Keep it short and cinematic."})]})]}),(r.isError||r.isSuccess)&&e.jsxs("div",{className:"pt-1 text-xs",children:[r.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-destructive",children:[e.jsx(A,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:r.error?.message??"Couldnâ€™t save changes."})]}),r.isSuccess&&!r.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-emerald-400",children:[e.jsx(T,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:"Profile updated."})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:()=>{n({displayName:t.displayName,bio:t.bio,avatarFile:null}),r.reset()},children:"Reset"}),e.jsx(N,{type:"submit",size:"sm",disabled:r.isPending,children:r.isPending?e.jsx(R,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}):e.jsx("span",{children:"Save changes"})})]})]})},Q=()=>{const{user:t}=P(),{data:s,isLoading:d,isError:i,error:n}=C();if(!t)return e.jsx("div",{className:"flex flex-1 flex-col items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"You're signed out"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to edit your profile settings."})]})});if(d)return e.jsx(E,{message:"Loading your profileâ€¦"});if(i||!s)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Profile unavailable"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"We couldn't load your profile right now."}),n?.message&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Details:"})," ",n.message]})]})});const r={displayName:s.displayName??"",bio:s.bio??"",avatarUrl:s.avatarUrl??null};return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-2 pt-1",children:[e.jsx(S,{title:"Profile"}),e.jsx("section",{className:"px-1 pb-24",children:e.jsx(L,{children:e.jsx(D,{initialProfile:r,user:t},s?.displayName+(s?.bio??"")+(s?.avatarUrl??""))})})]})};export{Q as default};
