name: Export Full Supabase Schema

# Trigger workflow manually or on main branch push, and also schedule daily backups
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *' # Runs daily at 02:00 UTC

jobs:
  export-schema:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Install Supabase CLI
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3️⃣ Dump the full Supabase schema
      - name: Dump Full Supabase Schema
        run: |
          mkdir -p supabase
          echo "Dumping full Supabase schema including RLS policies..."
          supabase db dump \
            --db-url "$SUPABASE_DB_URL" \
            --file supabase/schema.sql
          
          echo "Listing files in supabase folder:"
          ls -l supabase/
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # 4️⃣ Commit and push schema changes automatically using PAT token
      - name: Commit Schema Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update full Supabase schema dump"
          branch: main
          file_pattern: "supabase/schema.sql"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          token: ${{ secrets.PAT_TOKEN }}
