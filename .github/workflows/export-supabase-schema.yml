name: Export Full Supabase Schema

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  export-schema:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Install Supabase CLI
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3️⃣ Dump everything including RLS
      - name: Dump Full Supabase Schema
        run: |
          mkdir -p supabase
          echo "Dumping full Supabase schema including RLS policies..."
          supabase db dump \
            --db-url "$SUPABASE_DB_URL" \
            --file supabase/schema.sql \
            --verbose
          
          echo "Listing files in supabase folder:"
          ls -l supabase/
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # 4️⃣ Commit schema changes only if modified
      - name: Commit Schema Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update full Supabase schema dump"
          branch: main
          file_pattern: "supabase/schema.sql"
