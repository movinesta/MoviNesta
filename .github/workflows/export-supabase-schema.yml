name: Export Full Supabase Schema

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # optional: runs daily at midnight UTC
  push:
    branches:
      - main

jobs:
  export-schema:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Install Supabase CLI
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3️⃣ Create backup folder
      - name: Create folder for schema dump
        run: mkdir -p supabase

      # 4️⃣ Generate timestamp
      - name: Generate timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 5️⃣ Dump full Supabase schema including RLS
      - name: Dump Supabase Schema
        run: |
          echo "Dumping full schema to supabase/schema-$TIMESTAMP.sql"
          supabase db dump \
            --db-url "$SUPABASE_DB_URL" \
            --file "supabase/schema-$TIMESTAMP.sql"
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # 6️⃣ Optional: keep a fixed filename for easy reference
      - name: Copy to supabase/schema.sql
        run: cp supabase/schema-$TIMESTAMP.sql supabase/schema.sql

      # 7️⃣ Commit and push using Personal Access Token
      - name: Commit and Push Schema
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update full Supabase schema dump"
          file_pattern: "supabase/schema.sql"
          branch: main
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          token: ${{ secrets.PAT_TOKEN }}
