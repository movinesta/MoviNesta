name: Export Supabase Schema

# Triggers: manual run or push to main
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  export-schema:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Install Supabase CLI
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3️⃣ Dump the schema from Supabase
      - name: Dump Supabase Schema
        run: |
          echo "Creating supabase folder..."
          mkdir -p supabase

          echo "Dumping public schema from Supabase..."
          supabase db dump \
            --db-url "$SUPABASE_DB_URL" \
            --schema public \
            --file supabase/schema.sql

          echo "Listing files in supabase folder for debug:"
          ls -l supabase/
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # 4️⃣ Commit schema back to repository
      - name: Commit Schema Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update Supabase schema dump"
          branch: main
