name: Deploy Admin Dashboard (GitHub Pages)

on:
  push:
    branches: ["main"]
    paths:
      - "admin-dashboard/**"
      - ".github/workflows/deploy.yml"
      - "supabase/functions/**"
      - "supabase/config.toml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.5
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: |
            admin-dashboard/pnpm-lock.yaml

      - name: Enable Corepack
        run: corepack enable

      - name: Environment diagnostics
        working-directory: admin-dashboard
        run: |
          node -v
          npm -v
          pnpm -v
          npm config list
          npm ping || true
          npm view esbuild version
          npm view vite version
          free -h
          df -h

      - name: Install dependencies (admin-dashboard) with watchdog
        working-directory: admin-dashboard
        timeout-minutes: 30
        env:
          npm_config_registry: "https://registry.npmjs.org/"
        run: |
          set -euo pipefail

          pnpm config set registry "$npm_config_registry"

          LOGFILE=$(mktemp -p "$RUNNER_TEMP" pnpm-install-XXXX.log)
          echo "Logging pnpm install output to $LOGFILE"

          stdbuf -oL -eL pnpm install --frozen-lockfile --reporter=append-only 2>&1 | tee "$LOGFILE" &
          INSTALL_PID=$!
          LAST_SIZE=0
          LAST_CHANGE=$(date +%s)

          while kill -0 $INSTALL_PID 2>/dev/null; do
            sleep 30
            CURRENT_SIZE=$(stat -c%s "$LOGFILE" 2>/dev/null || echo 0)
            if [ "$CURRENT_SIZE" -gt "$LAST_SIZE" ]; then
              LAST_SIZE=$CURRENT_SIZE
              LAST_CHANGE=$(date +%s)
            elif [ $(($(date +%s) - LAST_CHANGE)) -ge 120 ]; then
              echo "pnpm install produced no output for 120 seconds. Terminating."
              ps aux | head -200 || true
              kill $INSTALL_PID || true
              sleep 5
              kill -9 $INSTALL_PID || true
              tail -n 50 "$LOGFILE" || true
              exit 1
            fi
            echo "[watchdog] pnpm install running; log size ${CURRENT_SIZE} bytes; last update $(($(date +%s) - LAST_CHANGE))s ago"
          done

          wait $INSTALL_PID

      - name: Build admin dashboard
        working-directory: admin-dashboard
        run: pnpm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: admin-dashboard/dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-supabase-functions:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Supabase Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ] || [ -z "${PROJECT_REF:-}" ]; then
            echo "Missing secrets: SUPABASE_ACCESS_TOKEN and/or SUPABASE_PROJECT_ID"
            exit 1
          fi

          echo "Deploying functions to project: $PROJECT_REF"

          for dir in supabase/functions/*; do
            name="$(basename "$dir")"
            if [ "$name" = "_shared" ]; then
              continue
            fi
            if [ -d "$dir" ]; then
              echo "==> Deploying function: $name"
              supabase functions deploy "$name" --project-ref "$PROJECT_REF" --use-api
            fi
          done
