import{p as J,u as K,r as g,j as e,L as O,aa as C,B as x,a as j,aj as T,ak as B,al as D,am as I,an as $}from"./index-CRBf6KpQ.js";import{u as q,E as F}from"./ErrorBox-DVY8vL3c.js";import{u as y}from"./useMutation-DfZD1PiA.js";import{C as R}from"./Card-BKQRm7Rb.js";import{I as u}from"./Input-eqrST-0v.js";import{T as L,a as c,b as d}from"./Table-C_8f92Ce.js";import{E as Q}from"./EmptyState-DFwSBMQU.js";const v={key:"",description:"",status:"draft",started_at:"",ended_at:"",variants:JSON.stringify([{name:"control",weight:.5},{name:"treatment",weight:.5}],null,2),salt:""};function M(l){return e.jsx("div",{className:"text-xl font-semibold tracking-tight",children:l.children})}function P(l){if(!Array.isArray(l))return"—";const r=l.map(a=>{const i=String((a==null?void 0:a.name)??"").trim(),n=Number(a==null?void 0:a.weight);return!i||!Number.isFinite(n)?null:`${i} ${(n*100).toFixed(0)}%`}).filter(Boolean);return r.length?r.join(" · "):"—"}function A(l){try{const r=JSON.parse(l);if(!Array.isArray(r))return{value:null,error:"Variants must be a JSON array."};const a=r.map(n=>({name:String((n==null?void 0:n.name)??"").trim(),weight:Number((n==null?void 0:n.weight)??0)}));if(a.some(n=>!n.name||!Number.isFinite(n.weight)||n.weight<=0))return{value:null,error:"Each variant needs a name and a positive weight."};const i=a.reduce((n,o)=>n+o.weight,0);return!Number.isFinite(i)||i<=0?{value:null,error:"Weights must sum to a positive number."}:{value:a}}catch(r){return{value:null,error:(r==null?void 0:r.message)??"Invalid JSON."}}}function Y(){var E,S;const l=J(),r=K(),[a,i]=g.useState({...v}),n=q({queryKey:["recsys_experiments"],queryFn:()=>I()}),o=q({queryKey:["recsys_experiment_assignment_counts"],queryFn:()=>$(),staleTime:3e4,refetchInterval:6e4}),h=y({mutationFn:t=>{const s=A(t.variants);if(!s.value)throw new Error(s.error??"Invalid variants JSON.");return T({key:t.key.trim(),description:t.description.trim()||null,status:t.status,started_at:t.started_at||null,ended_at:t.ended_at||null,variants:s.value,salt:t.salt.trim()||null})},onSuccess:async()=>{await r.invalidateQueries({queryKey:["recsys_experiments"]}),l.push({title:"Experiment saved",message:"Experiment details updated.",variant:"success"}),i({...v})}}),f=y({mutationFn:t=>B({key:t}),onSuccess:async()=>{await r.invalidateQueries({queryKey:["recsys_experiments"]}),l.push({title:"Experiment activated",message:"Experiment status set to active.",variant:"success"})}}),N=y({mutationFn:t=>D({key:t}),onSuccess:async()=>{await r.invalidateQueries({queryKey:["recsys_experiments"]}),l.push({title:"Experiment ended",message:"Experiment status set to ended.",variant:"success"})}}),b=((E=n.data)==null?void 0:E.rows)??[],_=((S=o.data)==null?void 0:S.rows)??[],p=g.useMemo(()=>A(a.variants).error,[a.variants]),k=g.useMemo(()=>{const t=new Map;for(const s of _){const m=t.get(s.experiment_key)??[];m.push(s),t.set(s.experiment_key,m)}return t},[_]);return n.isLoading?e.jsx(O,{}):n.error?e.jsx(F,{error:n.error}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(M,{children:"Recsys Experiments"}),e.jsx(C,{className:"text-sm text-zinc-600 hover:text-zinc-900",to:"/recsys",children:"← Back to Recsys"})]}),e.jsx(R,{title:"Create / Edit",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Key"}),e.jsx(u,{value:a.key,onChange:t=>i(s=>({...s,key:t.target.value})),placeholder:"swipe_blend_test"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Description"}),e.jsx(u,{value:a.description,onChange:t=>i(s=>({...s,description:t.target.value})),placeholder:"Short summary of the experiment"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Status"}),e.jsxs("select",{className:"mt-1 w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900",value:a.status,onChange:t=>i(s=>({...s,status:t.target.value})),children:[e.jsx("option",{value:"draft",children:"draft"}),e.jsx("option",{value:"active",children:"active"}),e.jsx("option",{value:"ended",children:"ended"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Salt (optional)"}),e.jsx(u,{value:a.salt,onChange:t=>i(s=>({...s,salt:t.target.value})),placeholder:"leave blank for default"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Started at"}),e.jsx(u,{type:"datetime-local",value:a.started_at,onChange:t=>i(s=>({...s,started_at:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Ended at"}),e.jsx(u,{type:"datetime-local",value:a.ended_at,onChange:t=>i(s=>({...s,ended_at:t.target.value}))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-600",children:"Variants JSON"}),e.jsx("textarea",{className:"mt-1 h-40 w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300",value:a.variants,onChange:t=>i(s=>({...s,variants:t.target.value}))}),p?e.jsx("div",{className:"mt-1 text-xs text-rose-600",children:p}):null,e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:"Weights should sum to ~1.0."})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(x,{variant:"primary",onClick:()=>h.mutate(a),disabled:!a.key.trim()||!!p||h.isPending,children:h.isPending?"Saving...":"Save experiment"}),e.jsx(x,{variant:"ghost",onClick:()=>i({...v}),children:"Clear"})]})]})]})}),e.jsxs(R,{title:"Experiments",children:[o.isError?e.jsx(F,{title:"Failed to load assignment counts",error:o.error}):null,b.length===0?e.jsx(Q,{title:"No experiments yet",message:"Create a recsys experiment to start collecting variant metrics."}):e.jsxs(L,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Key"}),e.jsx(c,{children:"Status"}),e.jsx(c,{children:"Started"}),e.jsx(c,{children:"Ended"}),e.jsx(c,{children:"Last updated"}),e.jsx(c,{children:"Split"}),e.jsx(c,{children:"Assignments"}),e.jsx(c,{className:"text-right",children:"Actions"})]})}),e.jsx("tbody",{children:b.map(t=>{var s,m;return e.jsxs("tr",{children:[e.jsx(d,{className:"font-mono text-xs text-zinc-700",children:t.key}),e.jsx(d,{className:"text-xs",children:t.status}),e.jsx(d,{className:"text-xs text-zinc-600",children:j(t.started_at)}),e.jsx(d,{className:"text-xs text-zinc-600",children:j(t.ended_at)}),e.jsx(d,{className:"text-xs text-zinc-600",children:j(t.updated_at)}),e.jsx(d,{className:"text-xs text-zinc-600",children:P(t.variants)}),e.jsx(d,{className:"text-xs text-zinc-600",children:(s=k.get(t.key))!=null&&s.length?(m=k.get(t.key))==null?void 0:m.map(z=>`${z.variant}: ${z.assignments}`).join(" · "):"—"}),e.jsx(d,{className:"text-right",children:e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>i({key:t.key,description:t.description??"",status:t.status??"draft",started_at:t.started_at?t.started_at.slice(0,16):"",ended_at:t.ended_at?t.ended_at.slice(0,16):"",variants:JSON.stringify(t.variants??[],null,2),salt:t.salt??""}),children:"Edit"}),e.jsx(x,{variant:"ghost",onClick:()=>i({key:`${t.key}_copy`,description:t.description??"",status:"draft",started_at:"",ended_at:"",variants:JSON.stringify(t.variants??[],null,2),salt:""}),children:"Duplicate"}),e.jsx(x,{variant:"ghost",onClick:()=>f.mutate(t.key),disabled:t.status==="active"||f.isPending,children:"Activate"}),e.jsx(x,{variant:"ghost",onClick:()=>N.mutate(t.key),disabled:t.status==="ended"||N.isPending,children:"End"}),e.jsx(C,{to:`/recsys/experiments/${encodeURIComponent(t.key)}`,className:"rounded-xl border border-zinc-200 px-3 py-2 text-xs text-zinc-700 hover:bg-zinc-100",children:"Details"})]})})]},t.id??t.key)})})]})]})]})}export{Y as default};
