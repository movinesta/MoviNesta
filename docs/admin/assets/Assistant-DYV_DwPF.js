import{r as w,j as e,B as F,L as We,f as J,G as cs,H as ds,I as xs,J as ms,K as us,A as ps,M as hs,D as gs}from"./index-CGWJK-B7.js";import{u as he,E as ke}from"./ErrorBox-DGVAxfkB.js";import{u as Ve}from"./useMutation-CEd-E173.js";import{S as H,R as St,X as Ct,Y as Ot,T as At,B as He}from"./generateCategoricalChart-BiCnn-u3.js";import{C as E}from"./Card-BfoASP6-.js";import{C as xe}from"./CopyButton-DYYxrqKe.js";import{H as B,g as bs,S as fs,a as js}from"./settingsHints-BuWRe4Tj.js";import{I as de}from"./Input-5czXp4bm.js";import{T as G,a as j,b as f}from"./Table-DrAL3XMq.js";import{E as Mt}from"./EmptyState-D234wNkF.js";import{B as vs}from"./BarChart-BaiMNwy4.js";import{L as Ns,a as ys}from"./LineChart-7Tps1kKe.js";function ie(s){return!!s&&typeof s=="object"&&!Array.isArray(s)}function Dt(s){const n=[];for(const g of s){const v=String(g??"").trim();v&&(n.includes(v)||n.push(v))}return n}function Ye(s){return Dt(String(s??"").split(/\r?\n/).map(n=>n.trim()).filter(Boolean))}function Ze(s){return Array.isArray(s)?s.map(n=>String(n??"").trim()).filter(Boolean).join(`
`):""}function _s(s){return Dt(String(s??"").split(",").map(n=>n.trim()).filter(Boolean))}function zs(s){return Array.isArray(s)?s.map(n=>String(n??"").trim()).filter(Boolean).join(", "):""}function ge(s){const n=Number(s);if(Number.isFinite(n))return n}function Pt(s){if(typeof s=="number"&&Number.isFinite(s))return s;if(typeof s=="string"){const n=Number(s);if(Number.isFinite(n))return n}if(ie(s)){const n={};for(const g of["p50","p75","p90","p99"]){const v=Number(s[g]);Number.isFinite(v)&&(n[g]=v)}return Object.keys(n).length?n:void 0}}function qt(s){const n={};if(typeof s=="number"&&Number.isFinite(s))return{mode:"single",single:String(s),p:n};if(typeof s=="string"&&s.trim()){const g=Number(s);if(Number.isFinite(g))return{mode:"single",single:String(g),p:n}}if(ie(s)){for(const g of["p50","p75","p90","p99"]){const v=Number(s[g]);Number.isFinite(v)&&(n[g]=v)}return{mode:Object.keys(n).length?"percentiles":"single",single:"",p:n}}return{mode:"single",single:"",p:n}}function ws(s){const n=w.useMemo(()=>ie(s.value)?s.value:{},[s.value]),g=w.useMemo(()=>{const o=Array.isArray(s.providerOptions)?s.providerOptions:[],O=new Map;for(const L of o){const W=String((L==null?void 0:L.slug)??"").trim();W&&(O.has(W)||O.set(W,{slug:W,name:(L==null?void 0:L.name)??null}))}return Array.from(O.values()).sort((L,W)=>L.slug.localeCompare(W.slug))},[s.providerOptions]),v=o=>{s.onChange({...n??{},...o})},k=(o,O)=>{const L={...n??{}};O==null||typeof O=="string"&&O.trim()===""?delete L[o]:L[o]=O,s.onChange(Object.keys(L).length?L:null)},D=qt(n.preferred_min_throughput),d=qt(n.preferred_max_latency),M=ie(n.max_price)?n.max_price:{};return e.jsxs("div",{className:s.className,children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Provider routing policy (OpenRouter)"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Sort"}),e.jsxs("select",{value:typeof n.sort=="string"?n.sort:ie(n.sort)?n.sort.by:"",onChange:o=>{const O=o.target.value;if(!O)return k("sort",void 0);const L=n.sort;if(ie(L)){const W=L.partition;k("sort",{by:O,...W?{partition:W}:{}})}else k("sort",O)},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"(default)"}),e.jsx("option",{value:"price",children:"Price"}),e.jsx("option",{value:"throughput",children:"Throughput"}),e.jsx("option",{value:"latency",children:"Latency"})]}),e.jsx("span",{className:"text-[11px] text-zinc-400",children:"Setting sort disables OpenRouter load balancing."})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Sort partition"}),e.jsxs("select",{value:ie(n.sort)?String(n.sort.partition??""):"",onChange:o=>{const O=o.target.value||void 0;n.sort&&(typeof n.sort=="string"?k("sort",{by:n.sort,...O?{partition:O}:{}}):k("sort",{...n.sort,...O?{partition:O}:{}}))},disabled:!n.sort,className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm disabled:opacity-50",children:[e.jsx("option",{value:"",children:"(none)"}),e.jsx("option",{value:"model",children:"Model"}),e.jsx("option",{value:"none",children:"None"})]}),e.jsx("span",{className:"text-[11px] text-zinc-400",children:'Use "model" if you use model fallbacks.'})]}),e.jsx("div",{className:"flex items-end justify-end gap-2",children:e.jsx(F,{variant:"outline",onClick:()=>s.onChange(null),title:"Remove the provider policy section (OpenRouter defaults will apply)",children:"Clear"})})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider order (one per line)"}),e.jsx("textarea",{value:Ze(n.order),onChange:o=>k("order",Ye(o.target.value)),placeholder:g.slice(0,8).map(o=>o.slug).join(`
`),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono"}),e.jsx("span",{className:"text-[11px] text-zinc-400",children:"If set, OpenRouter tries providers in this order first."})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Only allow (one per line)"}),e.jsx("textarea",{value:Ze(n.only),onChange:o=>k("only",Ye(o.target.value)),placeholder:"openai\\nanthropic\\n...",className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Ignore providers (one per line)"}),e.jsx("textarea",{value:Ze(n.ignore),onChange:o=>k("ignore",Ye(o.target.value)),placeholder:"together\\n...",className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono"})]})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!(n.allow_fallbacks??!0),onChange:o=>v({allow_fallbacks:o.target.checked})}),e.jsx("span",{children:"Allow fallbacks"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!(n.require_parameters??!1),onChange:o=>k("require_parameters",o.target.checked)}),e.jsx("span",{children:"Require parameters support"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!(n.zdr??!1),onChange:o=>k("zdr",o.target.checked)}),e.jsx("span",{children:"ZDR"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!(n.enforce_distillable_text??!1),onChange:o=>k("enforce_distillable_text",o.target.checked)}),e.jsx("span",{children:"Enforce distillable text"})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Data collection"}),e.jsxs("select",{value:String(n.data_collection??""),onChange:o=>{const O=o.target.value;if(!O)return k("data_collection",void 0);k("data_collection",O==="deny"?"deny":"allow")},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"(default)"}),e.jsx("option",{value:"allow",children:"Allow"}),e.jsx("option",{value:"deny",children:"Deny"})]}),e.jsx("span",{className:"text-[11px] text-zinc-400",children:"If set to deny, OpenRouter filters providers by their policy."})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Quantizations (comma-separated)"}),e.jsx(de,{value:zs(n.quantizations),onChange:o=>k("quantizations",_s(o.target.value)),placeholder:"int8, fp16, bf16"}),e.jsx("span",{className:"text-[11px] text-zinc-400",children:"Optional preference; availability depends on the provider."})]})]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-zinc-200 bg-zinc-50 p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold text-zinc-600",children:"Performance preferences"}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Preferred min throughput"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"throughput_mode",checked:D.mode==="single",onChange:()=>{const o=Pt(D.single);k("preferred_min_throughput",typeof o=="number"?o:void 0)}}),e.jsx("span",{children:"Single"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"throughput_mode",checked:D.mode==="percentiles",onChange:()=>k("preferred_min_throughput",{...D.p||{}})}),e.jsx("span",{children:"Percentiles"})]})]}),D.mode==="single"?e.jsxs("div",{className:"mt-2",children:[e.jsx(de,{inputMode:"decimal",value:D.single,onChange:o=>k("preferred_min_throughput",ge(o.target.value)),placeholder:"e.g. 50"}),e.jsx("div",{className:"mt-1 text-[11px] text-zinc-400",children:"Tokens/sec threshold (approx)."})]}):e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2",children:["p50","p75","p90","p99"].map(o=>e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:o}),e.jsx(de,{inputMode:"decimal",value:String(D.p[o]??""),onChange:O=>k("preferred_min_throughput",{...D.p||{},[o]:ge(O.target.value)}),placeholder:"e.g. 50"})]},o))})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Preferred max latency"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"latency_mode",checked:d.mode==="single",onChange:()=>{const o=Pt(d.single);k("preferred_max_latency",typeof o=="number"?o:void 0)}}),e.jsx("span",{children:"Single"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"latency_mode",checked:d.mode==="percentiles",onChange:()=>k("preferred_max_latency",{...d.p||{}})}),e.jsx("span",{children:"Percentiles"})]})]}),d.mode==="single"?e.jsxs("div",{className:"mt-2",children:[e.jsx(de,{inputMode:"decimal",value:d.single,onChange:o=>k("preferred_max_latency",ge(o.target.value)),placeholder:"e.g. 2.5"}),e.jsx("div",{className:"mt-1 text-[11px] text-zinc-400",children:"Seconds threshold (approx)."})]}):e.jsx("div",{className:"mt-2 grid grid-cols-2 gap-2",children:["p50","p75","p90","p99"].map(o=>e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:o}),e.jsx(de,{inputMode:"decimal",value:String(d.p[o]??""),onChange:O=>k("preferred_max_latency",{...d.p||{},[o]:ge(O.target.value)}),placeholder:"e.g. 2.5"})]},o))})]})]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Max price (optional)"}),e.jsx("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-4",children:[["prompt","Prompt"],["completion","Completion"],["request","Request"],["image","Image"]].map(([o,O])=>e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:O}),e.jsx(de,{inputMode:"decimal",value:String(M[o]??""),onChange:L=>{const W=ge(L.target.value),re={...M};W===void 0?delete re[o]:re[o]=W,k("max_price",Object.keys(re).length?re:void 0)},placeholder:"e.g. 0.0005"})]},o))}),e.jsx("div",{className:"mt-1 text-[11px] text-zinc-400",children:"Values are in $/token for prompt/completion, $/request for request, and $/image for image."})]})]})]})}function ks(s){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:s.children})}function Rt(s){return isFinite(s)?`${Math.round(s*100)}%`:"0%"}function le(s){if(!s)return"";const n=new Date(s);return isFinite(n.getTime())?n.toISOString().replace("T"," ").slice(0,16):String(s)}function Ss(s){var g,v;return s?Array.isArray(s)?s:(Array.isArray(s==null?void 0:s.data)?s.data:null)??(Array.isArray(s==null?void 0:s.endpoints)?s.endpoints:null)??(Array.isArray(s==null?void 0:s.items)?s.items:null)??(Array.isArray(s==null?void 0:s.entries)?s.entries:null)??(Array.isArray((g=s==null?void 0:s.data)==null?void 0:g.endpoints)?s.data.endpoints:null)??(Array.isArray((v=s==null?void 0:s.endpoints)==null?void 0:v.data)?s.endpoints.data:null)??[]:[]}function Cs(s){if(!s||typeof s!="object")return null;const n=s.provider??s.provider_name??s.providerName??null;if(typeof n=="string"&&n.trim())return n.trim();if(n&&typeof n=="object"){const v=n.slug??n.id??n.name??null;if(typeof v=="string"&&v.trim())return v.trim()}const g=s.name??s.provider_id??null;return typeof g=="string"&&g.trim()?g.trim():null}const be=[{key:"temperature",label:"Temperature",type:"number",min:0,max:2,step:.05},{key:"top_p",label:"Top P",type:"number",min:0,max:1,step:.05},{key:"max_output_tokens",label:"Max output tokens",type:"number",min:1,max:32768,step:1},{key:"verbosity",label:"Verbosity",type:"text"},{key:"reasoning",label:"Reasoning (JSON)",type:"json"},{key:"native_tool_calling",label:"Native tool calling",type:"boolean"},{key:"native_tool_max_loops",label:"Native tool max loops",type:"number",min:1,max:12,step:1},{key:"native_tool_max_calls_per_loop",label:"Native tool max calls per loop",type:"number",min:1,max:20,step:1},{key:"presence_penalty",label:"Presence penalty",type:"number",min:-2,max:2,step:.1},{key:"frequency_penalty",label:"Frequency penalty",type:"number",min:-2,max:2,step:.1},{key:"seed",label:"Seed",type:"number",min:0,max:2e9,step:1},{key:"stop",label:"Stop sequences",type:"string-array"},{key:"logprobs",label:"Logprobs",type:"boolean"},{key:"top_logprobs",label:"Top logprobs",type:"number",min:0,max:20,step:1},{key:"parallel_tool_calls",label:"Parallel tool calls",type:"boolean"},{key:"stream",label:"Stream",type:"boolean"},{key:"stream_passthrough",label:"Stream passthrough (SSE)",type:"boolean"},{key:"timeout_ms",label:"Timeout (ms)",type:"number",min:1e3,max:12e4,step:1e3},{key:"user",label:"User",type:"text"},{key:"metadata",label:"Metadata (JSON)",type:"json"},{key:"tools",label:"Tools (JSON)",type:"json"},{key:"tool_choice",label:"Tool choice (JSON)",type:"json"},{key:"response_format",label:"Response format (JSON)",type:"json"},{key:"response_healing",label:"Response healing (plugin)",type:"boolean"},{key:"web_search",label:"Web search (plugin)",type:"boolean"},{key:"web_search_mode",label:"Web search mode (off/auto/always)",type:"text"},{key:"web_max_results",label:"Web search max results",type:"number",min:1,max:10,step:1},{key:"web_engine",label:"Web search engine (native/exa)",type:"text"},{key:"web_search_prompt",label:"Web search prompt",type:"text"},{key:"plugins",label:"Plugins (JSON)",type:"json"}],ee=s=>s.split(`
`).map(n=>n.trim()).filter(Boolean),Z=s=>Array.isArray(s)?s.join(`
`):"";function te(s){return!!s&&typeof s=="object"&&!Array.isArray(s)}function ne(s){return s===void 0?s:JSON.parse(JSON.stringify(s))}function c(s,n,g){let v=s;for(const k of n){if(!v||typeof v!="object")return g;v=v[k]}return v===void 0?g:v}function _(s,n,g){let v=s;for(let k=0;k<n.length-1;k++){const D=n[k];(!v[D]||typeof v[D]!="object")&&(v[D]={}),v=v[D]}v[n[n.length-1]]=g}function Se(s){if(s===null)return"null";if(s===void 0)return"undefined";if(typeof s=="string")return s.length>120?`${s.slice(0,117)}…`:s;if(typeof s=="number"||typeof s=="boolean")return String(s);try{const n=JSON.stringify(s);return n.length>200?`${n.slice(0,197)}…`:n}catch{return String(s)}}function Ce(s){return s===!0?"on":s===!1?"off":"auto"}function Oe(s){if(s==="on")return!0;if(s==="off")return!1}function Ft(s){if(!te(s))return{routing:null,decision:null};const n=te(s.routing)?s.routing:null,g=te(s.decision)?s.decision:null;return{routing:n,decision:g}}function It(s){if(!te(s))return null;const n=te(s.routing)?s.routing:null,g=n&&te(n.zdr)?n.zdr:null;return g||(te(s.zdr)?s.zdr:null)}function Qe(s,n,g=""){if(s===n)return[];const v=te(s),k=te(n);if(v&&k){const D=Array.from(new Set([...Object.keys(s),...Object.keys(n)])).sort(),d=[];for(const M of D){const o=g?`${g}.${M}`:M;d.push(...Qe(s[M],n[M],o))}return d}if(Array.isArray(s)&&Array.isArray(n)){const D=JSON.stringify(s),d=JSON.stringify(n);return D===d?[]:[{path:g||"(root)",a:s,b:n}]}return[{path:g||"(root)",a:s,b:n}]}function Bs(){var ct,dt,xt,mt;const[s,n]=w.useState("metrics"),[g,v]=w.useState(14),[k,D]=w.useState(!1),[d,M]=w.useState(null),[o,O]=w.useState(null),[L,W]=w.useState(!1),[re,Lt]=w.useState(!1),[Ae,Jt]=w.useState("Reply with exactly: OK"),[Me,Tt]=w.useState("fast"),[A,Pe]=w.useState(null),[Xe,qe]=w.useState(null),[Re,Et]=w.useState("Reply with exactly: OK"),[Ie,Bt]=w.useState("current"),[Ge,Kt]=w.useState(!1),[N,De]=w.useState(null),[et,Fe]=w.useState(null),[$t,tt]=w.useState(!1),[$,Ut]=w.useState(null),[Wt,st]=w.useState(!1),[V,rt]=w.useState(null),[fe,Le]=w.useState(null),[Je,Vt]=w.useState(50),[Te,Ht]=w.useState(""),[Ee,Yt]=w.useState("assistant-chat-reply"),nt=()=>{st(!1),rt(null)},je=he({queryKey:["assistant-metrics",g],queryFn:()=>ms({days:g}),enabled:s==="metrics"}),me=he({queryKey:["assistant-health"],queryFn:()=>us(),enabled:s==="diagnostics",refetchInterval:15e3}),ue=he({queryKey:["assistant-settings"],queryFn:()=>ps(),enabled:s==="settings"}),pe=he({queryKey:["openrouter-request-log",{limit:Je,requestId:Te,fn:Ee}],queryFn:()=>hs({limit:Je,request_id:Te.trim()||null,fn:Ee.trim()||null}),enabled:s==="diagnostics"}),Be=he({queryKey:["openrouter-endpoints",(d==null?void 0:d.openrouter_base_url)??null],queryFn:()=>{var i;return gs({base_url:((i=d==null?void 0:d.openrouter_base_url)==null?void 0:i.trim())||null})},enabled:s==="settings"}),ve=Ve({mutationFn:i=>cs(i),onSuccess:()=>{D(!1),ue.refetch()}}),Ke=Ve({mutationFn:i=>ds(i),onSuccess:i=>{qe(null),Pe(i)},onError:i=>{Pe(null),qe((i==null?void 0:i.message)??"Provider test failed")}}),$e=Ve({mutationFn:i=>xs(i),onSuccess:i=>{Fe(null),De(i)},onError:i=>{De(null),Fe((i==null?void 0:i.message)??"Routing test failed")}}),q=je.data,Zt=w.useMemo(()=>((q==null?void 0:q.series)??[]).map(i=>({...i,day:String(i.day).slice(5)})),[q]),Qt=w.useMemo(()=>((q==null?void 0:q.trigger_series)??[]).map(i=>({...i,day:String(i.day).slice(5)})),[q]),Xt=(q==null?void 0:q.by_surface_kind)??[],Gt=(q==null?void 0:q.triggers)??[],h=me.data,ae=ue.data,S=ae==null?void 0:ae.assistant_settings,K=(ct=ae==null?void 0:ae.defaults)==null?void 0:ct.settings,oe=((dt=pe.data)==null?void 0:dt.rows)??[],se=Be.data,lt=Array.isArray(se==null?void 0:se.zdr_endpoints)?se.zdr_endpoints:[],es=w.useMemo(()=>{const i=(se==null?void 0:se.payload)??null,a=Ss(i),u=new Map;for(const m of a){const z=Cs(m);if(!z)continue;let R=null;const Y=m.provider??m.provider_name??null;if(Y&&typeof Y=="object"){const Q=Y.name??Y.display_name??null;typeof Q=="string"&&Q.trim()&&(R=Q.trim())}!R&&typeof m.provider_name=="string"&&m.provider_name.trim()&&(R=String(m.provider_name).trim()),u.has(z)||u.set(z,{slug:z,name:R})}return Array.from(u.values()).sort((m,z)=>m.slug.localeCompare(z.slug))},[se]),Ne=w.useMemo(()=>oe.find(i=>String(i.id)===String(fe))??null,[oe,fe]),ce=w.useMemo(()=>{let i=0,a=0,u=0,m=0;for(const z of oe){const R=It(z.meta);R&&(R.requested&&(i+=1),R.used&&(a+=1),R.requested&&!R.used&&(m+=1),R.sensitive&&(u+=1))}return{requested:i,used:a,fallback:m,sensitive:u}},[oe]),C=(K==null?void 0:K.behavior)??{},b=w.useMemo(()=>{const i=((d==null?void 0:d.behavior_json)??"").trim();if(!i)return{ok:!0,value:ne(C)};try{return{ok:!0,value:JSON.parse(i)}}catch(a){return{ok:!1,value:ne(C),error:String((a==null?void 0:a.message)??a)}}},[d==null?void 0:d.behavior_json,C]),y=i=>{M(a=>{if(!a)return a;const u=(a.behavior_json??"").trim();let m;try{m=u?JSON.parse(u):ne(C)}catch{return a}const z=ne(m);return i(z),{...a,behavior_json:JSON.stringify(z,null,2)}})},ts={"assistant_settings.openrouter_base_url":"field-openrouter_base_url","assistant_settings.default_instructions":"field-default_instructions","assistant_settings.model_fast":"field-model_fast","assistant_settings.model_creative":"field-model_creative","assistant_settings.model_planner":"field-model_planner","assistant_settings.model_maker":"field-model_maker","assistant_settings.model_critic":"field-model_critic","assistant_settings.fallback_models":"field-fallback_models","assistant_settings.model_catalog":"field-model_catalog","assistant_settings.params.timeout_ms":"field-param-timeout_ms","assistant_settings.params.stream_passthrough":"field-param-stream_passthrough","assistant_settings.params.response_healing":"field-param-response_healing","assistant_settings.params.web_search":"field-param-web_search","assistant_settings.params.web_search_mode":"field-param-web_search_mode","assistant_settings.params.web_max_results":"field-param-web_max_results","assistant_settings.params.web_engine":"field-param-web_engine","assistant_settings.params.web_search_prompt":"field-param-web_search_prompt","behavior.diagnostics.user_error_detail":"field-behavior-user_error_detail","behavior.diagnostics.user_error_show_culprit_var":"field-behavior-user_error_show_culprit_var","behavior.diagnostics.user_error_show_culprit_value":"field-behavior-user_error_show_culprit_value","behavior.diagnostics.user_error_show_status_model":"field-behavior-user_error_show_status_model","behavior.diagnostics.user_error_show_trace_ids":"field-behavior-user_error_show_trace_ids","behavior.router.zdr.enabled":"field-zdr-enabled","behavior.router.zdr.mode":"field-zdr-mode","behavior.router.zdr.allow_fallback":"field-zdr-allow-fallback","behavior.router.zdr.base_url":"field-zdr-base-url","assistant_settings.test_provider":"field-provider_test"},ss=i=>{const a=ts[i];if(!a)return;const u=document.getElementById(a);if(u)try{u.scrollIntoView({behavior:"smooth",block:"center"})}catch{u.scrollIntoView()}},I=(i,a)=>{Ut(i),tt(!0),a!=null&&a.scroll&&(n("settings"),setTimeout(()=>ss(i),50))},rs=(i,a)=>{const u=be.find(m=>m.key===i);if(!u)return a;if(u.type==="number"){const m=Number(a);return a===""?null:Number.isFinite(m)?m:a}if(u.type==="boolean")return a===""?null:a==="true"?!0:a==="false"?!1:a;if(u.type==="string-array")return a===""?[]:ee(a);if(u.type==="json"){if(!a.trim())return null;try{return JSON.parse(a)}catch{return a}}return a},Ue=(i,a)=>{var R,Y,Q;const u=S??{},m=K??{},z=d??{};if(i.startsWith("assistant_settings.params.")){const T=i.replace("assistant_settings.params.","");return a==="effective"?(R=u==null?void 0:u.params)==null?void 0:R[T]:a==="default"?(Y=m==null?void 0:m.params)==null?void 0:Y[T]:rs(T,String(((Q=z==null?void 0:z.params)==null?void 0:Q[T])??""))}if(i.startsWith("assistant_settings.")){const T=i.replace("assistant_settings.","");return T==="fallback_models"||T==="model_catalog"?a==="effective"?(u==null?void 0:u[T])??[]:a==="default"?(m==null?void 0:m[T])??[]:(z==null?void 0:z[T])??[]:a==="effective"?u==null?void 0:u[T]:a==="default"?m==null?void 0:m[T]:z==null?void 0:z[T]}if(i.startsWith("behavior.")){const T=i.replace("behavior.","").split(".");return c(a==="effective"?(u==null?void 0:u.behavior)??(m==null?void 0:m.behavior)??{}:a==="default"?(m==null?void 0:m.behavior)??{}:b.value??{},T,void 0)}},ns=(i,a)=>{if(d){if(i.startsWith("assistant_settings.params.")){const u=i.replace("assistant_settings.params.","");M(m=>{if(!m)return m;const z=be.find(Y=>Y.key===u);let R="";return(z==null?void 0:z.type)==="json"?R=a==null?"":JSON.stringify(a,null,2):(z==null?void 0:z.type)==="string-array"?R=Array.isArray(a)?a.join(`
`):String(a??""):R=a==null?"":String(a),{...m,params:{...m.params,[u]:R}}});return}if(i.startsWith("assistant_settings.")){const u=i.replace("assistant_settings.","");M(m=>m&&{...m,[u]:a});return}if(i.startsWith("behavior.")){const u=i.replace("behavior.","").split(".");y(m=>_(m,u,a));return}}},ye=w.useMemo(()=>Qe(C??{},b.value??{}),[C,b.value]),_e=w.useMemo(()=>{const i={rate_limit:(C??{}).rate_limit,orchestrator:(C??{}).orchestrator,router:(C??{}).router},a={rate_limit:(b.value??{}).rate_limit,orchestrator:(b.value??{}).orchestrator,router:(b.value??{}).router};return Qe(i,a)},[C,b.value]);w.useEffect(()=>{if(!S||k)return;const i=u=>{var z,R;const m=((z=S==null?void 0:S.params)==null?void 0:z[u])??((R=K==null?void 0:K.params)==null?void 0:R[u]);return m==null?"":Array.isArray(m)?m.join(`
`):typeof m=="object"?JSON.stringify(m,null,2):String(m)},a={};be.forEach(u=>{a[u.key]=i(u.key)}),M({openrouter_base_url:(S==null?void 0:S.openrouter_base_url)??"",model_fast:(S==null?void 0:S.model_fast)??"",model_creative:(S==null?void 0:S.model_creative)??"",model_planner:(S==null?void 0:S.model_planner)??"",model_maker:(S==null?void 0:S.model_maker)??"",model_critic:(S==null?void 0:S.model_critic)??"",fallback_models:(S==null?void 0:S.fallback_models)??[],model_catalog:(S==null?void 0:S.model_catalog)??(K==null?void 0:K.model_catalog)??[],default_instructions:(S==null?void 0:S.default_instructions)??"",behavior_json:JSON.stringify((S==null?void 0:S.behavior)??(K==null?void 0:K.behavior)??{},null,2),params:a}),D(!0)},[S,K,k]),w.useEffect(()=>{fe&&(Ne||Le(null))},[fe,Ne]);function it(i){const a=Math.max(0,Math.floor(Number(i)||0)),u=Math.floor(a/60),m=a%60;if(u<=0)return`${m}s`;const z=Math.floor(u/60),R=u%60;return z<=0?`${u}m ${m}s`:`${z}h ${R}m`}const ls=(()=>{var i,a,u,m,z,R,Y,Q,T,ut,pt,ht,gt,bt,ft,jt,vt,Nt,yt,_t,zt,wt,kt;return s==="metrics"?je.isLoading?e.jsx(We,{}):je.isError?e.jsx(ke,{error:je.error}):q?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsx(H,{title:"Suggestions (created)",value:J(((i=q==null?void 0:q.totals)==null?void 0:i.created)??0)}),e.jsx(H,{title:"Accepted",value:J(((a=q==null?void 0:q.totals)==null?void 0:a.accepted)??0)}),e.jsx(H,{title:"Accept rate",value:Rt(Number(((u=q==null?void 0:q.totals)==null?void 0:u.acceptRate)??0))}),e.jsx(H,{title:"Tokens (est.)",value:J(((m=q==null?void 0:q.totals)==null?void 0:m.tokens)??0)})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Suggestions over time"}),e.jsx("div",{className:"h-72",children:e.jsx(St,{width:"100%",height:"100%",children:e.jsxs(vs,{data:Zt,children:[e.jsx(Ct,{dataKey:"day"}),e.jsx(Ot,{}),e.jsx(At,{}),e.jsx(He,{dataKey:"created"}),e.jsx(He,{dataKey:"accepted"}),e.jsx(He,{dataKey:"dismissed"})]})})}),e.jsxs("div",{className:"mt-2 text-xs text-zinc-500",children:["If this chart stays empty, run the rollup once: call edge function ",e.jsx("code",{children:"assistant-metrics-rollup"}),"."]})]}),e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Trigger fires over time"}),e.jsx("div",{className:"h-72",children:e.jsx(St,{width:"100%",height:"100%",children:e.jsxs(Ns,{data:Qt,children:[e.jsx(Ct,{dataKey:"day"}),e.jsx(Ot,{}),e.jsx(At,{}),e.jsx(ys,{dataKey:"fires"})]})})}),e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"Top triggers are shown below."})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"By surface + kind"}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"Day"}),e.jsx(j,{children:"Surface"}),e.jsx(j,{children:"Kind"}),e.jsx(j,{className:"text-right",children:"Created"}),e.jsx(j,{className:"text-right",children:"Accepted"}),e.jsx(j,{className:"text-right",children:"Dismissed"}),e.jsx(j,{className:"text-right",children:"Rate"})]})}),e.jsx("tbody",{children:Xt.slice(0,150).map((t,r)=>{const x=Number(t.created_count??0),l=Number(t.accepted_count??0),P=x?l/x:0;return e.jsxs("tr",{className:"border-t border-zinc-100",children:[e.jsx(f,{children:String(t.day).slice(5)}),e.jsx(f,{children:t.surface}),e.jsx(f,{children:t.kind}),e.jsx(f,{className:"text-right",children:J(x)}),e.jsx(f,{className:"text-right",children:J(l)}),e.jsx(f,{className:"text-right",children:J(Number(t.dismissed_count??0))}),e.jsx(f,{className:"text-right",children:Rt(P)})]},r)})})]})]}),e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Top triggers"}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"Trigger"}),e.jsx(j,{className:"text-right",children:"Fires"}),e.jsx(j,{className:"text-right",children:"Users"})]})}),e.jsx("tbody",{children:Gt.map((t,r)=>e.jsxs("tr",{className:"border-t border-zinc-100",children:[e.jsx(f,{children:t.name}),e.jsx(f,{className:"text-right",children:J(Number(t.fires??0))}),e.jsx(f,{className:"text-right",children:J(Number(t.unique_users??0))})]},r))})]}),e.jsxs("div",{className:"mt-3 text-xs text-zinc-500",children:["Tip: You can disable noisy triggers by setting ",e.jsx("code",{children:"assistant_triggers.enabled = false"}),"."]})]})]})]}):e.jsx(Mt,{title:"No metrics yet",message:"No assistant metrics were returned."}):s==="diagnostics"?me.isLoading?e.jsx(We,{}):me.isError?e.jsx(ke,{error:me.error}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-2 text-xs text-zinc-500",children:["Snapshot: ",le(h==null?void 0:h.ts)]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsx(H,{title:"Pending",value:J(Number(((z=h==null?void 0:h.counts)==null?void 0:z.pending)??0))}),e.jsx(H,{title:"Processing",value:J(Number(((R=h==null?void 0:h.counts)==null?void 0:R.processing)??0))}),e.jsx(H,{title:"Failed",value:J(Number(((Y=h==null?void 0:h.counts)==null?void 0:Y.failed)??0))}),e.jsx(H,{title:"Done",value:J(Number(((Q=h==null?void 0:h.counts)==null?void 0:Q.done)??0))})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Queue age"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(H,{title:"Oldest pending",value:it(Number((h==null?void 0:h.oldestPendingSec)??0))}),e.jsx(H,{title:"Oldest processing",value:it(Number((h==null?void 0:h.oldestProcessingSec)??0))})]}),e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"If queue age keeps growing, check runner health and rate limits."})]}),e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Last 24h"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsx(H,{title:"Created",value:J(Number(((T=h==null?void 0:h.last24h)==null?void 0:T.created)??0))}),e.jsx(H,{title:"Done",value:J(Number(((ut=h==null?void 0:h.last24h)==null?void 0:ut.done)??0))}),e.jsx(H,{title:"Failed",value:J(Number(((pt=h==null?void 0:h.last24h)==null?void 0:pt.failed)??0))})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Jobs by kind"}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"Kind"}),e.jsx(j,{className:"text-right",children:"Pending"}),e.jsx(j,{className:"text-right",children:"Processing"}),e.jsx(j,{className:"text-right",children:"Failed"}),e.jsx(j,{className:"text-right",children:"Done"}),e.jsx(j,{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:Object.entries((h==null?void 0:h.byKind)??{}).map(([t,r])=>e.jsxs("tr",{className:"border-t border-zinc-100",children:[e.jsx(f,{children:t}),e.jsx(f,{className:"text-right",children:J(Number((r==null?void 0:r.pending)??0))}),e.jsx(f,{className:"text-right",children:J(Number((r==null?void 0:r.processing)??0))}),e.jsx(f,{className:"text-right",children:J(Number((r==null?void 0:r.failed)??0))}),e.jsx(f,{className:"text-right",children:J(Number((r==null?void 0:r.done)??0))}),e.jsx(f,{className:"text-right",children:J(Number((r==null?void 0:r.total)??0))})]},t))})]})]}),e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Recent cron invocations"}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"When"}),e.jsx(j,{children:"Job"}),e.jsx(j,{children:"Request ID"})]})}),e.jsx("tbody",{children:((h==null?void 0:h.recentCron)??[]).map(t=>e.jsxs("tr",{className:"border-t border-zinc-100",children:[e.jsx(f,{children:le(t.createdAt)}),e.jsx(f,{children:t.job}),e.jsx(f,{className:"font-mono text-xs",children:t.requestId??""})]},t.id))})]})]})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Recent failures"}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"When"}),e.jsx(j,{children:"Kind"}),e.jsx(j,{children:"Conversation"}),e.jsx(j,{className:"text-right",children:"Attempts"}),e.jsx(j,{children:"Error"})]})}),e.jsx("tbody",{children:((h==null?void 0:h.recentFailures)??[]).map(t=>e.jsxs("tr",{className:"border-t border-zinc-100",children:[e.jsx(f,{children:le(t.updatedAt)}),e.jsx(f,{children:t.jobKind}),e.jsx(f,{className:"font-mono text-xs",children:t.conversationId}),e.jsx(f,{className:"text-right",children:J(Number(t.attempts??0))}),e.jsx(f,{className:"max-w-[520px] truncate",title:t.lastError,children:t.lastError})]},t.id))})]}),((h==null?void 0:h.recentFailures)??[]).length===0?e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"No recent failures."}):null]})}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Recent AI provider errors"}),e.jsx("div",{className:"text-xs text-zinc-500",children:'Captures OpenRouter/provider issues even when we return a user-facing fallback message (jobs may still be "done").'}),e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"When"}),e.jsx(j,{children:"Code"}),e.jsx(j,{children:"Culprit"}),e.jsx(j,{children:"Reason"}),e.jsx(j,{children:"Request"})]})}),e.jsx("tbody",{children:((h==null?void 0:h.recentAiFailures)??[]).map(t=>{var r,x;return e.jsxs("tr",{className:"border-t border-zinc-100 cursor-pointer hover:bg-zinc-50",onClick:()=>{rt(t),st(!0)},children:[e.jsx(f,{children:le(t.createdAt)}),e.jsx(f,{className:"font-mono text-xs",children:t.code}),e.jsx(f,{className:"font-mono text-xs",title:((r=t.culprit)==null?void 0:r.value_preview)??"",children:((x=t.culprit)==null?void 0:x.var)??"—"}),e.jsx(f,{className:"max-w-[520px] truncate",title:t.reason,children:t.reason}),e.jsx(f,{className:"font-mono text-xs",children:t.requestId??""})]},t.id)})})]}),((h==null?void 0:h.recentAiFailures)??[]).length===0?e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"No recent AI provider errors."}):null]})}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Routing decision log"}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Recent OpenRouter requests with routing policy details (per request ID)."}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-end gap-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Rows"}),e.jsx("input",{type:"number",min:10,max:200,value:String(Je),onChange:t=>{const r=t.target.value;if(!r)return;const x=Number(r);Number.isFinite(x)&&Vt(Math.max(10,Math.min(200,Math.trunc(x))))},className:"w-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Function"}),e.jsxs("select",{value:Ee,onChange:t=>Yt(t.target.value),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"assistant-chat-reply",children:"assistant-chat-reply"}),e.jsx("option",{value:"assistant-orchestrator",children:"assistant-orchestrator"}),e.jsx("option",{value:"admin-assistant-settings",children:"admin-assistant-settings"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Request ID"}),e.jsx("input",{value:Te,onChange:t=>Ht(t.target.value),placeholder:"req_...",className:"w-64 rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]}),e.jsx(F,{type:"button",variant:"secondary",className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs",onClick:()=>pe.refetch(),children:"Refresh"})]}),e.jsxs("div",{className:"mt-2 text-xs text-zinc-500",children:["ZDR coverage:"," ",e.jsx("span",{className:"font-mono",children:ce.used})," /"," ",e.jsx("span",{className:"font-mono",children:ce.requested})," requested",ce.fallback?e.jsxs(e.Fragment,{children:[" ","· fallback ",e.jsx("span",{className:"font-mono",children:ce.fallback})]}):null,ce.sensitive?e.jsxs(e.Fragment,{children:[" ","· sensitive ",e.jsx("span",{className:"font-mono",children:ce.sensitive})]}):null]}),pe.isLoading?e.jsx("div",{className:"mt-3 text-xs text-zinc-500",children:"Loading routing logs…"}):pe.isError?e.jsx("div",{className:"mt-3",children:e.jsx(ke,{error:pe.error})}):e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"When"}),e.jsx(j,{children:"Request ID"}),e.jsx(j,{children:"Mode"}),e.jsx(j,{children:"Model"}),e.jsx(j,{children:"Variant"}),e.jsx(j,{children:"ZDR"}),e.jsx(j,{children:"Provider"}),e.jsx(j,{children:"Function"})]})}),e.jsx("tbody",{children:oe.length?oe.map(t=>{var X;const{routing:r,decision:x}=Ft(t.meta),l=String(((X=r==null?void 0:r.policy)==null?void 0:X.mode)??"—"),P=String((x==null?void 0:x.provider)??t.provider??"—"),p=It(t.meta),U=p!=null&&p.used?"used":p!=null&&p.requested?"miss":"—";return e.jsxs("tr",{className:"border-t border-zinc-100 cursor-pointer hover:bg-zinc-50",onClick:()=>Le(String(t.id)),children:[e.jsx(f,{children:le(t.created_at)}),e.jsx(f,{className:"font-mono text-xs",children:t.request_id??"—"}),e.jsx(f,{className:"font-mono text-xs",children:l}),e.jsx(f,{className:"font-mono text-xs",children:t.model??"—"}),e.jsx(f,{className:"font-mono text-xs",children:t.variant??"—"}),e.jsx(f,{className:"font-mono text-xs",children:U}),e.jsx(f,{className:"font-mono text-xs",children:P}),e.jsx(f,{className:"font-mono text-xs",children:t.fn})]},t.id)}):e.jsx("tr",{children:e.jsx(f,{colSpan:8,className:"p-6",children:e.jsx(Mt,{title:"No routing logs",message:"No OpenRouter request logs match this filter.",className:"border-0 bg-transparent p-0"})})})})]})]})})]}):e.jsx("div",{className:"mt-4",children:ue.isLoading||!d?e.jsx(We,{}):ue.isError?e.jsx(ke,{error:ue.error}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsxs("div",{id:"field-openrouter_base_url",className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"OpenRouter base URL"}),e.jsx(B,{title:"Details",onClick:()=>I("assistant_settings.openrouter_base_url")})]}),e.jsx("input",{value:d.openrouter_base_url,onChange:t=>M(r=>r&&{...r,openrouter_base_url:t.target.value}),placeholder:"https://openrouter.ai/api/v1",className:"w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm"}),e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"Leave blank to use the environment default."})]}),e.jsxs(E,{children:[e.jsxs("div",{id:"field-default_instructions",className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Default instructions"}),e.jsx(B,{title:"Details",onClick:()=>I("assistant_settings.default_instructions")})]}),e.jsx("textarea",{value:d.default_instructions,onChange:t=>M(r=>r&&{...r,default_instructions:t.target.value}),placeholder:"Optional system instructions applied to every call.",className:"h-28 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs(E,{children:[e.jsxs("div",{id:"field-provider_test",className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Provider test (OpenRouter)"}),e.jsx(B,{title:"Details",onClick:()=>I("assistant_settings.test_provider")})]}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Runs a tiny request using the current Assistant settings. This helps you see the exact failure reason (and the culprit variable) before users hit the error."}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 md:grid-cols-5",children:[e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-1",children:[e.jsx("span",{className:"text-xs font-semibold text-zinc-600",children:"Model role"}),e.jsxs("select",{value:Me,onChange:t=>Tt(t.target.value),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"fast",children:"Fast"}),e.jsx("option",{value:"creative",children:"Creative"}),e.jsx("option",{value:"planner",children:"Planner"}),e.jsx("option",{value:"maker",children:"Maker"}),e.jsx("option",{value:"critic",children:"Critic"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-3",children:[e.jsx("span",{className:"text-xs font-semibold text-zinc-600",children:"Prompt"}),e.jsx("input",{value:Ae,onChange:t=>Jt(t.target.value),placeholder:"Reply with exactly: OK",className:"w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]}),e.jsx("div",{className:"flex items-end md:col-span-1",children:e.jsx(F,{type:"button",className:"w-full rounded-xl bg-zinc-900 px-4 py-2 text-sm text-white",disabled:Ke.isPending,onClick:async()=>{qe(null),Pe(null);try{await Ke.mutateAsync({prompt:Ae,model_key:Me})}catch{}},children:Ke.isPending?"Running…":"Run test"})})]}),Xe?e.jsx("div",{className:"mt-3 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-800",children:Xe}):null,A?e.jsxs("div",{className:"mt-3 rounded-xl border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:(ht=A==null?void 0:A.test)!=null&&ht.ok?"✅ Test ok":"⚠ Test failed"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"text-xs text-zinc-500 font-mono",children:A!=null&&A.requestId?`req ${A.requestId}`:""}),e.jsx(xe,{label:"Copy debug bundle",className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs",text:JSON.stringify({requestId:(A==null?void 0:A.requestId)??null,test:(A==null?void 0:A.test)??null,selected:{model_key:Me,prompt:Ae,base_url:(d==null?void 0:d.openrouter_base_url)??null}},null,2)})]})]}),(gt=A==null?void 0:A.test)!=null&&gt.ok?e.jsxs("div",{className:"mt-2 text-sm text-zinc-700",children:["Used model: ",e.jsx("span",{className:"font-mono text-xs",children:A.test.usedModel??""}),typeof A.test.durationMs=="number"?e.jsxs("span",{className:"ml-2 text-xs text-zinc-500",children:["(",A.test.durationMs,"ms)"]}):null,A.test.contentPreview?e.jsx("div",{className:"mt-2 rounded-lg border border-zinc-200 bg-zinc-50 p-2 font-mono text-xs",children:A.test.contentPreview}):null]}):e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsx("div",{className:"text-sm text-zinc-800",children:((bt=A==null?void 0:A.test)==null?void 0:bt.userMessage)??"Provider test failed."}),(ft=A==null?void 0:A.test)!=null&&ft.envelope?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Code: ",e.jsx("span",{className:"font-mono",children:A.test.envelope.code}),(jt=A.test.culprit)!=null&&jt.var?e.jsxs("span",{className:"ml-2",children:["Culprit: ",e.jsx("span",{className:"font-mono",children:A.test.culprit.var})]}):null,(vt=A.test.culprit)!=null&&vt.var?e.jsx(F,{type:"button",variant:"ghost",className:"ml-2 rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px]",onClick:()=>I(String(A.test.culprit.var),{scroll:!0}),children:"Open culprit"}):null]}):null]})]}):null]})}),e.jsx("div",{className:"mt-4",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 flex items-center justify-between gap-2",children:e.jsx("div",{className:"text-sm font-semibold",children:"Routing policy test"})}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Runs a tiny request using the current routing policy and captures the selected model/provider/variant."}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 md:grid-cols-5",children:[e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-1",children:[e.jsx("span",{className:"text-xs font-semibold text-zinc-600",children:"Policy mode"}),e.jsxs("select",{value:Ie,onChange:t=>Bt(t.target.value),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"current",children:"Use saved policy"}),e.jsx("option",{value:"auto",children:"Force auto"}),e.jsx("option",{value:"fallback",children:"Force fallback"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-3",children:[e.jsx("span",{className:"text-xs font-semibold text-zinc-600",children:"Prompt"}),e.jsx("input",{value:Re,onChange:t=>Et(t.target.value),placeholder:"Reply with exactly: OK",className:"w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]}),e.jsx("div",{className:"flex items-end md:col-span-1",children:e.jsx(F,{type:"button",className:"w-full rounded-xl bg-zinc-900 px-4 py-2 text-sm text-white",disabled:$e.isPending,onClick:async()=>{Fe(null),De(null);try{await $e.mutateAsync({prompt:Re,mode:Ie,simulate_advanced_params:Ge})}catch{}},children:$e.isPending?"Running…":"Run test"})})]}),e.jsxs("label",{className:"mt-3 flex items-center gap-2 text-xs text-zinc-600",children:[e.jsx("input",{type:"checkbox",checked:Ge,onChange:t=>Kt(t.target.checked)}),"Simulate advanced params (tools/tool_choice) to test provider ",e.jsx("span",{className:"font-mono",children:"require_parameters"})]}),et?e.jsx("div",{className:"mt-3 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-800",children:et}):null,N?e.jsxs("div",{className:"mt-3 rounded-xl border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:(Nt=N==null?void 0:N.test)!=null&&Nt.ok?"✅ Test ok":"⚠ Test failed"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"text-xs text-zinc-500 font-mono",children:N!=null&&N.requestId?`req ${N.requestId}`:""}),e.jsx(xe,{label:"Copy debug bundle",className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs",text:JSON.stringify({requestId:(N==null?void 0:N.requestId)??null,test:(N==null?void 0:N.test)??null,selected:{mode:Ie,prompt:Re,base_url:(d==null?void 0:d.openrouter_base_url)??null}},null,2)})]})]}),(yt=N==null?void 0:N.test)!=null&&yt.ok?e.jsxs("div",{className:"mt-2 space-y-2 text-sm text-zinc-700",children:[e.jsxs("div",{children:["Used model: ",e.jsx("span",{className:"font-mono text-xs",children:N.test.usedModel??""}),typeof N.test.durationMs=="number"?e.jsxs("span",{className:"ml-2 text-xs text-zinc-500",children:["(",N.test.durationMs,"ms)"]}):null]}),e.jsxs("div",{children:["Provider: ",e.jsx("span",{className:"font-mono text-xs",children:N.test.usedProvider??"—"}),e.jsx("span",{className:"ml-2 text-zinc-500",children:"·"}),e.jsx("span",{className:"ml-2 text-zinc-500",children:"Variant:"})," ",e.jsx("span",{className:"font-mono text-xs",children:N.test.usedVariant??"—"})]}),e.jsxs("div",{children:["require_parameters:"," ",e.jsx("span",{className:"font-mono text-xs",children:N.test.requireParameters===null||typeof N.test.requireParameters>"u"?"—":String(N.test.requireParameters)}),e.jsxs("span",{className:"ml-2 text-xs text-zinc-500",children:["(source: ",N.test.requireParametersSource??"—",")"]})]}),e.jsxs("div",{children:["Base URL: ",e.jsx("span",{className:"font-mono text-xs",children:N.test.baseUrl??"—"})]}),N.test.contentPreview?e.jsx("div",{className:"rounded-lg border border-zinc-200 bg-zinc-50 p-2 font-mono text-xs",children:N.test.contentPreview}):null]}):e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsx("div",{className:"text-sm text-zinc-800",children:((_t=N==null?void 0:N.test)==null?void 0:_t.userMessage)??"Routing test failed."}),(zt=N==null?void 0:N.test)!=null&&zt.envelope?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Code: ",e.jsx("span",{className:"font-mono",children:N.test.envelope.code}),(wt=N.test.culprit)!=null&&wt.var?e.jsxs("span",{className:"ml-2",children:["Culprit: ",e.jsx("span",{className:"font-mono",children:N.test.culprit.var})]}):null,(kt=N.test.culprit)!=null&&kt.var?e.jsx(F,{type:"button",variant:"ghost",className:"ml-2 rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px]",onClick:()=>I(String(N.test.culprit.var),{scroll:!0}),children:"Open culprit"}):null]}):null]})]}):null]})}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Models (primary)"}),e.jsx("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[{key:"model_fast",label:"Fast"},{key:"model_creative",label:"Creative"},{key:"model_planner",label:"Planner"},{key:"model_maker",label:"Maker"},{key:"model_critic",label:"Critic"}].map(t=>{const r=Array.from(new Set([...d.model_catalog??[],d[t.key]].filter(Boolean)));return e.jsxs("label",{id:`field-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),e.jsx(B,{title:"Details",onClick:()=>I(`assistant_settings.${t.key}`)})]}),e.jsxs("select",{value:d[t.key]??"",onChange:x=>M(l=>l&&{...l,[t.key]:x.target.value}),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"—"}),r.map(x=>e.jsx("option",{value:x,children:x},x))]})]},t.key)})})]}),e.jsxs(E,{children:[e.jsxs("div",{id:"field-fallback_models",className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Fallback models"}),e.jsx(B,{title:"Details",onClick:()=>I("assistant_settings.fallback_models")})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2 text-sm",children:Array.from(new Set([...d.model_catalog??[],...d.fallback_models??[]])).map(t=>{const r=d.fallback_models.includes(t);return e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:r,onChange:x=>M(l=>l&&{...l,fallback_models:x.target.checked?Array.from(new Set([...l.fallback_models,t])):l.fallback_models.filter(P=>P!==t)})}),e.jsx("span",{className:"text-xs text-zinc-700",children:t})]},t)})}),e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"These are used when the primary models fail."})]})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsxs("div",{id:"field-model_catalog",className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Model catalog"}),e.jsx(B,{title:"Details",onClick:()=>I("assistant_settings.model_catalog")})]}),e.jsx("textarea",{value:(d.model_catalog??[]).join(`
`),onChange:t=>M(r=>r&&{...r,model_catalog:ee(t.target.value)}),placeholder:"One model per line",className:"h-40 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono"}),e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"This list powers the dropdowns and fallback checkboxes."})]})}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Assistant behavior (prompts & chunking)"}),e.jsxs("div",{className:"mb-2 text-xs text-zinc-500",children:["Stored in ",e.jsx("span",{className:"font-mono",children:"assistant_settings.behavior"}),". Supports placeholders:",e.jsx("span",{className:"ml-1 font-mono",children:"{{name}}"}),", ",e.jsx("span",{className:"font-mono",children:"{{bioLine}}"}),",",e.jsx("span",{className:"font-mono",children:"{{toolProtocol}}"}),"."]}),b.ok?e.jsxs("div",{className:"mb-3 rounded-lg border border-zinc-200 bg-zinc-50 px-3 py-3",children:[e.jsxs("div",{className:"mb-2 flex flex-wrap items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-700",children:"Behavior controls (safe knobs)"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs",onClick:()=>y(t=>{t.rate_limit=ne((C??{}).rate_limit),t.orchestrator=ne((C??{}).orchestrator),_(t,["router","attribution"],ne(c(C??{},["router","attribution"],{})))}),children:"Reset proactivity controls"}),e.jsxs(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs",onClick:()=>Lt(t=>!t),children:[re?"Hide":"Show"," proactivity diff"]}),e.jsxs(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs",onClick:()=>W(t=>!t),children:[L?"Hide":"Show"," full diff"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"OpenRouter attribution"}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"HTTP-Referer"}),e.jsx("input",{type:"text",value:String(c(b.value,["router","attribution","http_referer"],"")),onChange:t=>y(r=>_(r,["router","attribution","http_referer"],t.target.value)),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["router","attribution","http_referer"],""))})]}),e.jsxs("label",{className:"mt-2 flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"X-Title"}),e.jsx("input",{type:"text",value:String(c(b.value,["router","attribution","x_title"],"")),onChange:t=>y(r=>_(r,["router","attribution","x_title"],t.target.value)),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["router","attribution","x_title"],""))})]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Chat reply rate limit"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Limit"}),e.jsx("input",{type:"number",min:1,max:100,step:1,value:String(c(b.value,["rate_limit","chat_reply","limit"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(1,Math.min(100,Number(r)));_(x,["rate_limit","chat_reply","limit"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["rate_limit","chat_reply","limit"],6))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Window (seconds)"}),e.jsx("input",{type:"number",min:5,max:3600,step:1,value:String(c(b.value,["rate_limit","chat_reply","window_seconds"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(5,Math.min(3600,Number(r)));_(x,["rate_limit","chat_reply","window_seconds"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["rate_limit","chat_reply","window_seconds"],60))})]})]}),e.jsxs("div",{className:"mt-2 text-[11px] text-zinc-500",children:["Stored at ",e.jsx("span",{className:"font-mono",children:"behavior.rate_limit.chat_reply"}),"."]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3 md:col-span-2",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2 text-[11px] font-semibold text-zinc-600",children:[e.jsx("span",{children:"Zero Data Retention (ZDR) routing"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.router.zdr.enabled")})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsxs("label",{id:"field-zdr-enabled",className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!c(b.value,["router","zdr","enabled"],!1),onChange:t=>y(r=>_(r,["router","zdr","enabled"],t.target.checked))}),e.jsx("span",{children:"Enable ZDR routing"})]}),e.jsxs("label",{id:"field-zdr-mode",className:"flex flex-col gap-1 text-xs text-zinc-700",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Mode"}),e.jsxs("select",{value:String(c(b.value,["router","zdr","mode"],"sensitive_only")),onChange:t=>y(r=>_(r,["router","zdr","mode"],t.target.value)),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"sensitive_only",children:"Sensitive only"}),e.jsx("option",{value:"all",children:"All requests"})]})]}),e.jsxs("label",{id:"field-zdr-allow-fallback",className:"flex items-center gap-2 text-xs text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!c(b.value,["router","zdr","allow_fallback"],!0),onChange:t=>y(r=>_(r,["router","zdr","allow_fallback"],t.target.checked))}),e.jsx("span",{children:"Allow fallback"})]}),e.jsxs("label",{id:"field-zdr-base-url",className:"flex flex-col gap-1 text-xs text-zinc-700 md:col-span-2",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"ZDR base URL override"}),e.jsx("input",{type:"text",value:String(c(b.value,["router","zdr","base_url"],"")),onChange:t=>y(r=>_(r,["router","zdr","base_url"],t.target.value)),placeholder:"Leave blank to use discovered ZDR endpoints",className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"mt-3 text-xs text-zinc-500",children:["Uses cached OpenRouter endpoint discovery. Refresh the ",e.jsx("span",{className:"font-mono",children:"openrouter-refresh"})," job to update."]}),Be.isLoading?e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"Loading ZDR endpoints…"}):Be.isError?e.jsx("div",{className:"mt-2 text-xs text-red-600",children:"Failed to load endpoints."}):e.jsx("div",{className:"mt-2",children:lt.length?e.jsx("ul",{className:"space-y-1 text-xs text-zinc-700",children:lt.map(t=>e.jsxs("li",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:"font-mono",children:t.base_url}),t.name?e.jsxs("span",{className:"text-zinc-500",children:["(",t.name,")"]}):null]},t.base_url))}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No ZDR endpoints found in cache."})})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3 md:col-span-2",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Routing policy"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Mode"}),e.jsxs("select",{value:String(c(b.value,["router","policy","mode"],"fallback")),onChange:t=>y(r=>_(r,["router","policy","mode"],t.target.value||"fallback")),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"fallback",children:"Fallback"}),e.jsx("option",{value:"auto",children:"Auto"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider sort"}),e.jsxs("select",{value:String(c(b.value,["router","policy","provider","sort"],"price")),onChange:t=>y(r=>_(r,["router","policy","provider","sort"],t.target.value||"price")),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"price",children:"Price"}),e.jsx("option",{value:"throughput",children:"Throughput"}),e.jsx("option",{value:"latency",children:"Latency"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Allow provider fallbacks"}),e.jsxs("select",{value:String(c(b.value,["router","policy","provider","allow_fallbacks"],!0)),onChange:t=>y(r=>_(r,["router","policy","provider","allow_fallbacks"],t.target.value==="true")),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Auto model"}),e.jsx("input",{type:"text",value:String(c(b.value,["router","policy","auto_model"],"")),onChange:t=>y(r=>_(r,["router","policy","auto_model"],t.target.value)),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["router","policy","auto_model"],""))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Fallback models (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","fallback_models"],[])),onChange:t=>y(r=>_(r,["router","policy","fallback_models"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","fallback_models"],[]))})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider order (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","provider","order"],[])),onChange:t=>y(r=>_(r,["router","policy","provider","order"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","provider","order"],[]))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider require (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","provider","require"],[])),onChange:t=>y(r=>_(r,["router","policy","provider","require"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","provider","require"],[]))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider allow (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","provider","allow"],[])),onChange:t=>y(r=>_(r,["router","policy","provider","allow"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","provider","allow"],[]))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Provider ignore (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","provider","ignore"],[])),onChange:t=>y(r=>_(r,["router","policy","provider","ignore"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","provider","ignore"],[]))})]})]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2 text-[11px] font-semibold text-zinc-600",children:[e.jsx("div",{children:"Provider policy editor (recommended)"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.router.policy.provider",{scroll:!1})})]}),e.jsx(ws,{value:c(b.value,["router","policy","provider"],null),providerOptions:es,onChange:t=>y(r=>_(r,["router","policy","provider"],t))}),e.jsxs("div",{className:"mt-2 text-[11px] text-zinc-500",children:["Uses OpenRouter's ",e.jsx("span",{className:"font-mono",children:"provider"})," routing fields (only/ignore/order, etc.)."]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Payload variants (one per line)"}),e.jsx("textarea",{value:Z(c(b.value,["router","policy","variants"],[])),onChange:t=>y(r=>_(r,["router","policy","variants"],ee(t.target.value))),className:"h-24 rounded-lg border border-zinc-200 px-3 py-2 text-sm font-mono",placeholder:Z(c(C,["router","policy","variants"],[]))})]}),e.jsxs("div",{className:"mt-2 text-[11px] text-zinc-500",children:["Stored at ",e.jsx("span",{className:"font-mono",children:"behavior.router.policy.*"}),"."]})]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2 text-[11px] font-semibold text-zinc-600",children:[e.jsx("div",{children:"User-facing AI error detail"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_detail",{scroll:!1})})]}),e.jsxs("label",{id:"field-behavior-user_error_detail",className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{children:"Mode"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_detail")})]}),e.jsxs("select",{value:String(c(b.value,["diagnostics","user_error_detail"],"friendly")),onChange:t=>y(r=>_(r,["diagnostics","user_error_detail"],t.target.value||"friendly")),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"friendly",children:"Friendly (generic)"}),e.jsx("option",{value:"code",children:"Code (show error code)"}),e.jsx("option",{value:"technical",children:"Technical (cause + details)"})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("label",{id:"field-behavior-user_error_show_culprit_var",className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{children:"Show culprit variable"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_show_culprit_var")})]}),e.jsxs("select",{value:Ce(c(b.value,["diagnostics","user_error_show_culprit_var"],void 0)),onChange:t=>y(r=>_(r,["diagnostics","user_error_show_culprit_var"],Oe(t.target.value))),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"auto",children:"Auto (by mode)"}),e.jsx("option",{value:"on",children:"On"}),e.jsx("option",{value:"off",children:"Off"})]})]}),e.jsxs("label",{id:"field-behavior-user_error_show_culprit_value",className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{children:"Show culprit value preview"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_show_culprit_value")})]}),e.jsxs("select",{value:Ce(c(b.value,["diagnostics","user_error_show_culprit_value"],void 0)),onChange:t=>y(r=>_(r,["diagnostics","user_error_show_culprit_value"],Oe(t.target.value))),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"auto",children:"Auto (by mode)"}),e.jsx("option",{value:"on",children:"On"}),e.jsx("option",{value:"off",children:"Off"})]})]}),e.jsxs("label",{id:"field-behavior-user_error_show_status_model",className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{children:"Show status / model"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_show_status_model")})]}),e.jsxs("select",{value:Ce(c(b.value,["diagnostics","user_error_show_status_model"],void 0)),onChange:t=>y(r=>_(r,["diagnostics","user_error_show_status_model"],Oe(t.target.value))),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"auto",children:"Auto (by mode)"}),e.jsx("option",{value:"on",children:"On"}),e.jsx("option",{value:"off",children:"Off"})]})]}),e.jsxs("label",{id:"field-behavior-user_error_show_trace_ids",className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{children:"Show trace IDs (requestId, upstream)"}),e.jsx(B,{title:"Details",onClick:()=>I("behavior.diagnostics.user_error_show_trace_ids")})]}),e.jsxs("select",{value:Ce(c(b.value,["diagnostics","user_error_show_trace_ids"],void 0)),onChange:t=>y(r=>_(r,["diagnostics","user_error_show_trace_ids"],Oe(t.target.value))),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"auto",children:"Auto (by mode)"}),e.jsx("option",{value:"on",children:"On"}),e.jsx("option",{value:"off",children:"Off"})]})]})]}),e.jsxs("div",{className:"mt-2 text-[11px] text-zinc-500",children:["Stored at ",e.jsx("span",{className:"font-mono",children:"behavior.diagnostics.*"}),"."]})]})]}),e.jsxs("div",{className:"mt-4 rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Orchestrator (proactive suggestions)"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-4",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Default verbosity"}),e.jsx("input",{type:"number",min:.1,max:.9,step:.05,value:String(c(b.value,["orchestrator","default_verbosity"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(.1,Math.min(.9,Number(r)));_(x,["orchestrator","default_verbosity"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","default_verbosity"],.45))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Default suggestions limit"}),e.jsx("input",{type:"number",min:1,max:6,step:1,value:String(c(b.value,["orchestrator","default_suggestions_limit"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(1,Math.min(6,Number(r)));_(x,["orchestrator","default_suggestions_limit"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","default_suggestions_limit"],3))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Max suggestions limit"}),e.jsx("input",{type:"number",min:1,max:6,step:1,value:String(c(b.value,["orchestrator","max_suggestions_limit"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(1,Math.min(6,Number(r)));_(x,["orchestrator","max_suggestions_limit"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","max_suggestions_limit"],6))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Daily cap (level2)"}),e.jsx("input",{type:"number",min:0,max:200,step:1,value:String(c(b.value,["orchestrator","daily_cap","level2"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(200,Number(r)));_(x,["orchestrator","daily_cap","level2"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","daily_cap","level2"],20))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Daily cap (level1)"}),e.jsx("input",{type:"number",min:0,max:200,step:1,value:String(c(b.value,["orchestrator","daily_cap","level1"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(200,Number(r)));_(x,["orchestrator","daily_cap","level1"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","daily_cap","level1"],12))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"Daily cap (level0)"}),e.jsx("input",{type:"number",min:0,max:200,step:1,value:String(c(b.value,["orchestrator","daily_cap","level0"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(200,Number(r)));_(x,["orchestrator","daily_cap","level0"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","daily_cap","level0"],0))})]})]}),e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-3 md:grid-cols-4",children:["home","swipe","messages","search","title","diary","default"].map(t=>e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsxs("span",{className:"text-[11px] text-zinc-500",children:["TTL ",t," (min)"]}),e.jsx("input",{type:"number",min:1,max:1440,step:1,value:String(c(b.value,["orchestrator","ttl_minutes",t],"")),onChange:r=>{const x=r.target.value;y(l=>{const P=x===""?void 0:Math.max(1,Math.min(1440,Number(x)));_(l,["orchestrator","ttl_minutes",t],isFinite(Number(P))?P:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","ttl_minutes",t],""))})]},t))}),e.jsxs("div",{className:"mt-4 rounded-lg border border-zinc-200 bg-zinc-50 p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Dismiss cooldown (minutes)"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Level 2"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"swipe"}),e.jsx("input",{type:"number",min:0,max:240,step:1,value:String(c(b.value,["orchestrator","cooldown_minutes","level2","swipe"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(240,Number(r)));_(x,["orchestrator","cooldown_minutes","level2","swipe"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","cooldown_minutes","level2","swipe"],""))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"default"}),e.jsx("input",{type:"number",min:0,max:240,step:1,value:String(c(b.value,["orchestrator","cooldown_minutes","level2","default"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(240,Number(r)));_(x,["orchestrator","cooldown_minutes","level2","default"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","cooldown_minutes","level2","default"],""))})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Level 1"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"swipe"}),e.jsx("input",{type:"number",min:0,max:240,step:1,value:String(c(b.value,["orchestrator","cooldown_minutes","level1","swipe"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(240,Number(r)));_(x,["orchestrator","cooldown_minutes","level1","swipe"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","cooldown_minutes","level1","swipe"],""))})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"default"}),e.jsx("input",{type:"number",min:0,max:240,step:1,value:String(c(b.value,["orchestrator","cooldown_minutes","level1","default"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(240,Number(r)));_(x,["orchestrator","cooldown_minutes","level1","default"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","cooldown_minutes","level1","default"],""))})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsx("div",{className:"mb-2 text-[11px] font-semibold text-zinc-600",children:"Level 0"}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[11px] text-zinc-500",children:"default"}),e.jsx("input",{type:"number",min:0,max:1440,step:1,value:String(c(b.value,["orchestrator","cooldown_minutes","level0","default"],"")),onChange:t=>{const r=t.target.value;y(x=>{const l=r===""?void 0:Math.max(0,Math.min(1440,Number(r)));_(x,["orchestrator","cooldown_minutes","level0","default"],isFinite(Number(l))?l:void 0)})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",placeholder:String(c(C,["orchestrator","cooldown_minutes","level0","default"],""))})]})]})]}),e.jsxs("div",{className:"mt-2 text-[11px] text-zinc-500",children:["Stored at ",e.jsx("span",{className:"font-mono",children:"behavior.orchestrator.cooldown_minutes"}),"."]})]})]}),re?e.jsxs("div",{className:"mt-4 rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"mb-2 text-[11px] font-semibold text-zinc-700",children:["Proactivity diff vs defaults (",_e.length,")"]}),_e.length?e.jsx("div",{className:"max-h-64 overflow-auto",children:e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"Path"}),e.jsx(j,{children:"Default"}),e.jsx(j,{children:"Current"})]})}),e.jsx("tbody",{children:_e.slice(0,80).map(t=>e.jsxs("tr",{children:[e.jsx(f,{className:"font-mono text-[11px]",children:t.path}),e.jsx(f,{className:"text-[11px]",children:Se(t.a)}),e.jsx(f,{className:"text-[11px]",children:Se(t.b)})]},t.path))})]})}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No differences."}),_e.length>80?e.jsx("div",{className:"mt-2 text-[11px] text-zinc-500",children:"Showing first 80 rows."}):null]}):null,L?e.jsxs("div",{className:"mt-4 rounded-lg border border-zinc-200 bg-white p-3",children:[e.jsxs("div",{className:"mb-2 text-[11px] font-semibold text-zinc-700",children:["Full behavior diff vs defaults (",ye.length,")"]}),ye.length?e.jsx("div",{className:"max-h-64 overflow-auto",children:e.jsxs(G,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(j,{children:"Path"}),e.jsx(j,{children:"Default"}),e.jsx(j,{children:"Current"})]})}),e.jsx("tbody",{children:ye.slice(0,80).map(t=>e.jsxs("tr",{children:[e.jsx(f,{className:"font-mono text-[11px]",children:t.path}),e.jsx(f,{className:"text-[11px]",children:Se(t.a)}),e.jsx(f,{className:"text-[11px]",children:Se(t.b)})]},t.path))})]})}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No differences."}),ye.length>80?e.jsx("div",{className:"mt-2 text-[11px] text-zinc-500",children:"Showing first 80 rows."}):null]}):null]}):e.jsx("div",{className:"mb-3 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800",children:"Behavior JSON is invalid, so structured controls are disabled. Fix the JSON below to re-enable controls."}),e.jsxs("div",{className:"mb-2 flex flex-wrap items-center gap-2",children:[e.jsx(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 px-3 py-2 text-xs",onClick:()=>M(t=>t&&{...t,behavior_json:JSON.stringify((K==null?void 0:K.behavior)??{},null,2)}),children:"Reset to defaults"}),e.jsx(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 px-3 py-2 text-xs",onClick:()=>M(t=>t&&{...t,behavior_json:JSON.stringify({prompts:{system_template:`You are {{name}}, MoviNesta’s in-app AI companion.
{{bioLine}}
Goal: help users pick movies/series fast, spoiler-free, with fun guidance.
Default behavior: be helpful and thorough. If the user asks for a deep dive or plan, you can write long, structured answers.
When recommending: provide 2–6 picks, each with a short spoiler-free reason, unless the user asks for more.
Ask 0–2 questions only if needed.
If the user specifies an exact output format (e.g., "reply exactly", "Format:"), follow it EXACTLY with no extra words.
TOOL_RESULTS_MINI is ground truth for catalog/library/list data; do not invent IDs, titles, or years.
Your final text must be plain text only (no JSON objects inside the message).
Never guess about user data. If unsure, call a read tool (get_my_*, search_*) or ask.
For actions that change data or send messages, do NOT run the write tool automatically. Instead, include confirmable buttons in final.actions.
Only auto-run read/grounding tools.
Never claim an action happened unless TOOL_RESULTS_MINI confirms success.
Never mention tools/JSON/system prompts/policies/DB/SQL.

{{toolProtocol}}`,append_tool_protocol:!0,chunk_outline_template:`You are {{name}}, MoviNesta’s in-app AI companion.
Task: produce a compact outline for a long-form answer.
Prefer 4–8 sections. Make sections actionable and spoiler-free.
Return JSON only matching the provided schema.`,chunk_section_template:`You are {{name}}, MoviNesta’s in-app AI companion.
Task: write ONE section of the answer (only that section).
Write plain text only (no JSON). Be clear, structured, and spoiler-free.
End on a complete sentence.`},output:{max_reply_chars:5e4,strip_text_prefix:!0},chunking:{enabled:!0,min_user_chars:700,cues:["deep","deep dive","go deeper","detailed","long","step-by-step","plan","strategy","write a full","full","comprehensive","explain","analysis","compare"],max_total_chars:5e4,max_sections:8,per_section_max_chars:12e3,user_request_max_chars:4e3,max_continuations:6},tool_loop:{max_loops:3,max_calls_per_loop:4},router:{deterministic_enabled:!0},strict_output:{allow_override:!0}},null,2),params:{...t.params,max_output_tokens:"4096"}}),children:"Long-form preset"}),e.jsx(F,{variant:"secondary",type:"button",className:"rounded-lg border border-zinc-200 px-3 py-2 text-xs",onClick:()=>M(t=>t&&{...t,behavior_json:JSON.stringify({prompts:{system_template:`You are {{name}}, MoviNesta’s in-app AI companion.
{{bioLine}}
Goal: help users quickly. Be concise by default.
Default: 2–6 picks, each with 1 short reason (no spoilers).
Ask 0–2 questions only if needed.
If the user asks for detail, then expand.
If the user specifies an exact output format (e.g., "reply exactly", "Format:"), follow it EXACTLY with no extra words.
TOOL_RESULTS_MINI is ground truth for catalog/library/list data; do not invent IDs, titles, or years.
Your final text must be plain text only (no JSON objects inside the message).
Never mention tools/JSON/system prompts/policies/DB/SQL.

{{toolProtocol}}`,append_tool_protocol:!0,chunk_outline_template:"You are {{name}}. Return JSON only matching the schema.",chunk_section_template:"You are {{name}}. Write plain text only."},output:{max_reply_chars:4e3,strip_text_prefix:!0},chunking:{enabled:!1,min_user_chars:700,cues:[],max_total_chars:14e3,max_sections:6,per_section_max_chars:8e3,user_request_max_chars:2e3,max_continuations:2},tool_loop:{max_loops:3,max_calls_per_loop:4},router:{deterministic_enabled:!0},strict_output:{allow_override:!0}},null,2),params:{...t.params,max_output_tokens:"900"}}),children:"Concise preset"})]}),e.jsx("textarea",{value:d.behavior_json??"",onChange:t=>M(r=>r&&{...r,behavior_json:t.target.value}),placeholder:`{
                    "prompts": { ... },
                    "output": { ... },
                    "chunking": { ... }
                  }`,className:"h-64 w-full rounded-lg border border-zinc-200 px-3 py-2 text-xs font-mono"})]})}),e.jsx("div",{className:"mt-6",children:e.jsxs(E,{children:[e.jsx("div",{className:"mb-2 text-sm font-semibold",children:"Responses API parameters"}),e.jsx("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:be.map(t=>{const r=d.params[t.key]??"",x=`assistant_settings.params.${t.key}`,l=!!js[x];if(t.key==="verbosity")return e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),e.jsxs("select",{value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Unset"}),e.jsx("option",{value:"low",children:"low"}),e.jsx("option",{value:"medium",children:"medium"}),e.jsx("option",{value:"high",children:"high"})]})]},t.key);if(t.key==="reasoning"){const P=(()=>{const p=(r??"").trim();if(!p)return"";try{const U=JSON.parse(p),X=U==null?void 0:U.effort;return X==="low"||X==="medium"||X==="high"?X:"__custom__"}catch{return"__custom__"}})();return e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),e.jsxs("select",{value:P,onChange:p=>{const U=p.target.value,X=U===""?"":U==="__custom__"?r:JSON.stringify({effort:U},null,2);M(we=>we&&{...we,params:{...we.params,[t.key]:X}})},className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Unset"}),e.jsx("option",{value:"low",children:"effort: low"}),e.jsx("option",{value:"medium",children:"effort: medium"}),e.jsx("option",{value:"high",children:"effort: high"}),e.jsx("option",{value:"__custom__",children:"Custom JSON…"})]}),e.jsx("textarea",{value:r,onChange:p=>M(U=>U&&{...U,params:{...U.params,[t.key]:p.target.value}}),placeholder:'{ "effort": "medium" }',className:"h-24 w-full rounded-lg border border-zinc-200 px-3 py-2 text-xs font-mono"})]},t.key)}return t.type==="boolean"?e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),e.jsxs("select",{value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Unset"}),e.jsx("option",{value:"true",children:"true"}),e.jsx("option",{value:"false",children:"false"})]})]},t.key):t.type==="json"?e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),e.jsx("textarea",{value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),placeholder:"{}",className:"h-28 w-full rounded-lg border border-zinc-200 px-3 py-2 text-xs font-mono"})]},t.key):t.type==="string-array"?e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),e.jsx("textarea",{value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),placeholder:"One per line",className:"h-28 w-full rounded-lg border border-zinc-200 px-3 py-2 text-xs font-mono"})]},t.key):e.jsxs("label",{id:`field-param-${t.key}`,className:"flex flex-col gap-1 text-sm",children:[e.jsxs("span",{className:"flex items-center justify-between gap-2 text-xs font-semibold text-zinc-600",children:[e.jsx("span",{children:t.label}),l?e.jsx(B,{title:"Details",onClick:()=>I(x)}):null]}),t.type==="number"?e.jsx("input",{type:"number",min:t.min,max:t.max,step:t.step,value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm"}):e.jsx("input",{type:"text",value:r,onChange:P=>M(p=>p&&{...p,params:{...p.params,[t.key]:P.target.value}}),className:"rounded-lg border border-zinc-200 px-3 py-2 text-sm"})]},t.key)})}),o?e.jsx("div",{className:"mt-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700",children:o}):null,e.jsxs("div",{className:"mt-4 flex items-center gap-3",children:[e.jsx(F,{variant:"ghost",type:"button",onClick:async()=>{if(!d)return;O(null);const t={};for(const l of be){const P=d.params[l.key]??"";if(l.type==="number"){const p=P.trim();t[l.key]=p?Number(p):null}else if(l.type==="boolean")P==="true"?t[l.key]=!0:P==="false"?t[l.key]=!1:t[l.key]=null;else if(l.type==="json"){const p=P.trim();if(!p)t[l.key]=null;else try{t[l.key]=JSON.parse(p)}catch{O(`Invalid JSON for ${l.label}.`);return}}else l.type==="string-array"?t[l.key]=P.trim()?ee(P):null:t[l.key]=P.trim()?P:null}let r=null;const x=(d.behavior_json??"").trim();if(x)try{r=JSON.parse(x)}catch{O("Invalid JSON for Behavior.");return}try{await ve.mutateAsync({openrouter_base_url:d.openrouter_base_url.trim()||null,model_fast:d.model_fast.trim()||null,model_creative:d.model_creative.trim()||null,model_planner:d.model_planner.trim()||null,model_maker:d.model_maker.trim()||null,model_critic:d.model_critic.trim()||null,fallback_models:d.fallback_models,model_catalog:d.model_catalog,default_instructions:d.default_instructions.trim()||null,params:t,behavior:r})}catch(l){O((l==null?void 0:l.message)??"Failed to save settings.");return}},className:"rounded-xl bg-zinc-900 px-4 py-2 text-sm text-white",disabled:ve.isPending,children:ve.isPending?"Saving…":"Save settings"}),ve.isSuccess?e.jsx("span",{className:"text-xs text-green-700",children:"Saved."}):null]})]})})]})})})(),ze=$?bs($):null,at=$?Ue($,"effective"):void 0,is=$?Ue($,"draft"):void 0,ot=$?Ue($,"default"):void 0,as=(()=>{if($)try{return JSON.stringify(at)===JSON.stringify(ot)?"default":"overridden"}catch{return"overridden"}})(),os=$?{scope:"admin",default:ot,description:(ze==null?void 0:ze.details)??""}:null;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx(ks,{children:"Assistant"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{variant:"ghost",type:"button",onClick:()=>n("metrics"),className:`rounded-xl px-3 py-2 text-sm ${s==="metrics"?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"Metrics"}),e.jsx(F,{variant:"ghost",type:"button",onClick:()=>n("diagnostics"),className:`rounded-xl px-3 py-2 text-sm ${s==="diagnostics"?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"Diagnostics"}),e.jsx(F,{variant:"ghost",type:"button",onClick:()=>n("settings"),className:`rounded-xl px-3 py-2 text-sm ${s==="settings"?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"Settings"}),s==="metrics"?e.jsxs("div",{className:"ml-2 flex items-center gap-2",children:[e.jsx(F,{variant:"ghost",type:"button",onClick:()=>v(7),className:`rounded-xl px-3 py-2 text-sm ${g===7?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"7d"}),e.jsx(F,{variant:"ghost",type:"button",onClick:()=>v(14),className:`rounded-xl px-3 py-2 text-sm ${g===14?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"14d"}),e.jsx(F,{variant:"ghost",type:"button",onClick:()=>v(30),className:`rounded-xl px-3 py-2 text-sm ${g===30?"bg-zinc-900 text-white":"bg-zinc-100 text-zinc-800"}`,children:"30d"})]}):s==="diagnostics"?e.jsx(F,{variant:"ghost",type:"button",onClick:()=>me.refetch(),className:"ml-2 rounded-xl bg-zinc-100 px-3 py-2 text-sm text-zinc-800",children:"Refresh"}):null]})]}),ls,e.jsx(fs,{open:$t,settingKey:$,entry:os,status:as,hint:ze,effectiveValue:at,draftValue:is,recentHistory:null,onClose:()=>tt(!1),onCopyKey:()=>{var i,a;$&&((a=(i=navigator.clipboard)==null?void 0:i.writeText)==null||a.call(i,$).catch(()=>{}))},onApplyValue:i=>{$&&ns($,i)},onNavigateToKey:i=>I(i,{scroll:!0})}),Wt&&V?e.jsxs("div",{className:"fixed inset-0 z-50 flex",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:nt}),e.jsxs("div",{className:"relative ml-auto h-full w-full max-w-[720px] overflow-auto bg-white shadow-xl",children:[e.jsx("div",{className:"border-b border-zinc-200 p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"AI provider error"}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-500",children:[le(V.createdAt)," · ",e.jsx("span",{className:"font-mono",children:V.code})]})]}),e.jsx(F,{variant:"ghost",type:"button",className:"rounded-lg border border-zinc-200 bg-white",onClick:nt,children:"Close"})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-zinc-200 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:"Summary"}),e.jsx("div",{className:"mt-1 text-sm text-zinc-800",children:V.reason}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs",children:[e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-1 font-mono",children:V.requestId??""}),e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-1 font-mono",children:V.conversationId??""}),e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-1 font-mono",children:V.userId??""})]}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(xe,{label:"Copy debug JSON",value:JSON.stringify(V,null,2),className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs"}),(xt=V.culprit)!=null&&xt.var?e.jsx(F,{variant:"ghost",type:"button",className:"rounded-lg border border-zinc-200 bg-white px-3 py-2 text-xs",onClick:()=>I(String(V.culprit.var),{scroll:!0}),children:"Open culprit setting"}):null]})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:"Culprit"}),(mt=V.culprit)!=null&&mt.var?e.jsx("span",{className:"text-xs font-mono text-zinc-700",children:V.culprit.var}):e.jsx("span",{className:"text-xs text-zinc-400",children:"—"})]}),e.jsx("pre",{className:"mt-2 overflow-auto rounded-lg bg-zinc-50 p-3 text-[11px] leading-snug text-zinc-800",children:JSON.stringify(V.culprit??{},null,2)})]}),e.jsxs("div",{className:"rounded-lg border border-zinc-200 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:"Context"}),e.jsx("pre",{className:"mt-2 overflow-auto rounded-lg bg-zinc-50 p-3 text-[11px] leading-snug text-zinc-800",children:JSON.stringify(V.context??{},null,2)})]})]})]})]}):null,e.jsx(Os,{open:!!Ne,row:Ne,onClose:()=>Le(null)})]})}function Os(s){var M;if(w.useEffect(()=>{if(!s.open)return;const o=O=>{O.key==="Escape"&&s.onClose()};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[s.open,s.onClose]),!s.open||!s.row)return null;const n=s.row,{routing:g,decision:v}=Ft(n.meta),k=String((v==null?void 0:v.provider)??n.provider??"—"),D=(()=>{try{return JSON.stringify(n.meta??{},null,2)}catch{return String(n.meta??"{}")}})(),d=(()=>{try{return JSON.stringify(g??{},null,2)}catch{return String(g??"{}")}})();return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:s.onClose}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full max-w-xl border-l border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Routing request details"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-zinc-500 font-mono",children:[e.jsx("span",{children:n.request_id??n.id}),e.jsx(xe,{text:String(n.request_id??n.id),label:"Copy request id",className:"h-8 px-2 py-1 text-xs"})]})]}),e.jsx(F,{variant:"ghost",type:"button",className:"rounded-xl px-3 py-2 text-sm text-zinc-600 hover:bg-zinc-100",onClick:s.onClose,"aria-label":"Close",children:"Close"})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"When"}),e.jsx("div",{className:"text-zinc-700",children:le(n.created_at)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Function"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.fn})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Model"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.model??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Variant"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.variant??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Provider"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:k})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Upstream request"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.upstream_request_id??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Base URL"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.base_url??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Policy mode"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:String(((M=g==null?void 0:g.policy)==null?void 0:M.mode)??"—")})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Routing policy"}),e.jsx(xe,{text:d,label:"Copy routing JSON",className:"h-8 px-2 py-1 text-xs"})]}),e.jsx("pre",{className:"mt-2 max-h-[24vh] overflow-auto rounded-2xl border border-zinc-200 bg-zinc-50 p-3 text-xs text-zinc-700",children:d})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Meta"}),e.jsx(xe,{text:D,label:"Copy JSON",className:"h-8 px-2 py-1 text-xs"})]}),e.jsx("pre",{className:"mt-2 max-h-[24vh] overflow-auto rounded-2xl border border-zinc-200 bg-zinc-50 p-3 text-xs text-zinc-700",children:D})]})]})]})}export{Bs as default};
