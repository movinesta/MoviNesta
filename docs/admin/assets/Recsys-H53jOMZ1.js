import{r as j,a1 as Te,j as e,B as O,a3 as qe,ad as Fe,i as re,ae as Re,af as Ke,ag as We,ah as Ae,ai as Be,aj as Pe,ak as Je,al as Oe,am as He,an as Ge}from"./index-CoY44SlW.js";import{u as K,E as T}from"./ErrorBox-CvgwTo6Q.js";import{C as D}from"./Card-DzyM45zw.js";import{T as P,a as c,b as l}from"./Table-BpO-pS4x.js";import{u as Ie}from"./useMutation-CglkDXYR.js";import{I as Ue}from"./Input-CFuN_OLj.js";import{S as f}from"./StatCard-Ct239vFi.js";import{R as Y,X as Q,Y as X,T as Z,L as ee}from"./generateCategoricalChart-FnZw2e2y.js";import{L as se,a as A}from"./LineChart-C8RWP0LD.js";import{C as te}from"./CartesianGrid-Ekvmrd1n.js";function E(i,a,t){return Number.isFinite(i)?Math.min(t,Math.max(a,i)):a}function $(i,a){const t=Number(i);return Number.isFinite(t)?t:a}function Ee(i){const a=(i&&typeof i=="object"?i.weights:null)??{},t=(i&&typeof i=="object"?i.source_multipliers:null)??{};return{enabled:!!((i==null?void 0:i.enabled)??!0),skip_when_mix_active:!!((i==null?void 0:i.skip_when_mix_active)??!0),weights:{position:E($(a.position,1),0,10),popularity:E($(a.popularity,.25),0,10),vote_avg:E($(a.vote_avg,.15),0,10),cf_score:E($(a.cf_score,1),0,10)},source_multipliers:{for_you:E($(t.for_you,1),0,10),combined:E($(t.combined,1),0,10),friends:E($(t.friends,1),0,10),trending:E($(t.trending,1),0,10),cf:E($(t.cf,1),0,10),seg_pop:E($(t.seg_pop,.9),0,10),other:E($(t.other,1),0,10)}}}function ie(i){const{label:a,value:t,onChange:r,min:h=0,max:z=3,step:x=.05,hint:n}=i;return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:a}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Ue,{className:"h-8 w-24",type:"number",min:h,max:z,step:x,value:Number.isFinite(t)?t:0,onChange:b=>r(E(Number(b.target.value),h,z))})})]}),e.jsx("input",{className:"w-full",type:"range",min:h,max:z,step:x,value:Number.isFinite(t)?t:0,onChange:b=>r(E(Number(b.target.value),h,z))}),n?e.jsx("div",{className:"text-xs text-zinc-500",children:n}):null]})}function Ve(){var F,q;const i=K({queryKey:["app_settings"],queryFn:async()=>qe(),staleTime:3e4,refetchInterval:6e4}),a=j.useMemo(()=>{var d,_;return((_=(((d=i.data)==null?void 0:d.registry)??{})["ranking.swipe.blend"])==null?void 0:_.default)??null},[(F=i.data)==null?void 0:F.registry]),t=j.useMemo(()=>{var W;const d=(((W=i.data)==null?void 0:W.rows)??[]).find(g=>g.key==="ranking.swipe.blend"),_=(d==null?void 0:d.value)??a;return Ee(_)},[(q=i.data)==null?void 0:q.rows,a]),[r,h]=j.useState(null),[z,x]=j.useState(!1),[n,b]=j.useState(""),[M,w]=j.useState(null),I=()=>{var u,d,_,W,g,ae;if(w(null),!n.trim()){w("Paste JSON first.");return}try{const k=JSON.parse(n),m=((d=(u=k==null?void 0:k.ranking)==null?void 0:u.swipe)==null?void 0:d.blend)??(k==null?void 0:k["ranking.swipe.blend"])??(k==null?void 0:k.blend)??k,ne={enabled:!!((m==null?void 0:m.enabled)??(r==null?void 0:r.enabled)??!0),skip_when_mix_active:!!((m==null?void 0:m.skip_when_mix_active)??(r==null?void 0:r.skip_when_mix_active)??!0),weights:{position:Number(((_=m==null?void 0:m.weights)==null?void 0:_.position)??(r==null?void 0:r.weights.position)??1),popularity:Number(((W=m==null?void 0:m.weights)==null?void 0:W.popularity)??(r==null?void 0:r.weights.popularity)??.15),vote_avg:Number(((g=m==null?void 0:m.weights)==null?void 0:g.vote_avg)??(r==null?void 0:r.weights.vote_avg)??.2),cf_score:Number(((ae=m==null?void 0:m.weights)==null?void 0:ae.cf_score)??(r==null?void 0:r.weights.cf_score)??1)},source_multipliers:{...(r==null?void 0:r.source_multipliers)??a.source_multipliers,...(m==null?void 0:m.source_multipliers)??{},...(m==null?void 0:m.suggested_source_multipliers)??{}}};h(Ee(ne)),x(!1),b("")}catch(k){w(k!=null&&k.message?String(k.message):"Invalid JSON.")}};j.useEffect(()=>{!r&&i.data&&h(t)},[i.data]),j.useEffect(()=>{if(!r)return;JSON.stringify(r)===JSON.stringify(t)&&h(t)},[t]);const S=Ie({mutationFn:async u=>{var _;const d=(_=i.data)==null?void 0:_.version;return Te({expected_version:d,updates:{"ranking.swipe.blend":u.cfg},reason:u.reason})},onSuccess:async()=>{await i.refetch()}}),J=!!r&&!S.isPending;return e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Swipe Blend Calibration"}),e.jsxs("div",{className:"text-xs text-zinc-600",children:["Controls the score-based reorder step (feature weights + per-source multipliers). Stored as ",e.jsx("span",{className:"font-mono",children:"ranking.swipe.blend"})," (server_only)."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>{w(null),x(!0)},disabled:S.isPending||i.isLoading,title:"Paste JSON to update multipliers/weights (e.g., output of suggest_blend_calibration)",children:"Import JSON"}),e.jsx(O,{variant:"secondary",onClick:()=>h(t),disabled:S.isPending||i.isLoading,title:"Reset editor to current saved values",children:"Reset"}),e.jsx(O,{onClick:()=>r&&S.mutate({cfg:r,reason:"Update swipe blend calibration"}),disabled:!J,children:"Save"})]})]}),z?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>x(!1)}),e.jsxs("div",{className:"relative w-full max-w-2xl rounded-2xl border border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Import blend JSON"}),e.jsxs("div",{className:"mt-2 text-sm text-zinc-600",children:["Paste either ",e.jsx("span",{className:"font-mono",children:'{"weights":..., "source_multipliers":...}'})," or the full"," ",e.jsx("span",{className:"font-mono",children:"ranking.swipe.blend"})," object, or the output of"," ",e.jsx("span",{className:"font-mono",children:"suggest_blend_calibration.mjs"}),"."]}),e.jsx("textarea",{className:"mt-4 h-56 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",value:n,onChange:u=>b(u.target.value),placeholder:'{"suggested_source_multipliers": {"cf": 1.1, "trending": 0.95}}'}),M?e.jsx("div",{className:"mt-3 text-sm text-red-700",children:M}):null,e.jsxs("div",{className:"mt-5 flex justify-end gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>x(!1),children:"Cancel"}),e.jsx(O,{onClick:I,children:"Apply"})]})]})]}):null,i.isError?e.jsx("div",{className:"p-4",children:e.jsx(T,{title:"Failed to load app settings",error:i.error})}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-4 p-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-800",children:[e.jsx("input",{type:"checkbox",checked:!!((r==null?void 0:r.enabled)??!0),onChange:u=>h(d=>d&&{...d,enabled:u.target.checked})}),"Enabled"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-800",children:[e.jsx("input",{type:"checkbox",checked:!!((r==null?void 0:r.skip_when_mix_active)??!0),onChange:u=>h(d=>d&&{...d,skip_when_mix_active:u.target.checked})}),"Skip when mix active"]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Feature weights"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ie,{label:"Position",value:(r==null?void 0:r.weights.position)??1,min:0,max:3,step:.05,onChange:u=>h(d=>d&&{...d,weights:{...d.weights,position:u}}),hint:"Higher = prefer earlier candidates (stability)."}),e.jsx(ie,{label:"Popularity",value:(r==null?void 0:r.weights.popularity)??.25,min:0,max:2,step:.05,onChange:u=>h(d=>d&&{...d,weights:{...d.weights,popularity:u}}),hint:"Higher = more blockbuster bias."}),e.jsx(ie,{label:"Vote avg",value:(r==null?void 0:r.weights.vote_avg)??.15,min:0,max:2,step:.05,onChange:u=>h(d=>d&&{...d,weights:{...d.weights,vote_avg:u}}),hint:"Higher = prefer higher-rated items."}),e.jsx(ie,{label:"CF score",value:(r==null?void 0:r.weights.cf_score)??1,min:0,max:3,step:.05,onChange:u=>h(d=>d&&{...d,weights:{...d.weights,cf_score:u}}),hint:"Higher = more personalized (ALS) influence."})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Source multipliers"}),e.jsx("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[["for_you","For You"],["combined","Combined"],["friends","Friends"],["trending","Trending"],["cf","CF"],["seg_pop","Seg-pop"],["other","Other"]].map(([u,d])=>{var _;return e.jsx(ie,{label:d,value:((_=r==null?void 0:r.source_multipliers)==null?void 0:_[u])??1,min:0,max:2,step:.05,onChange:W=>h(g=>g&&{...g,source_multipliers:{...g.source_multipliers,[u]:W}}),hint:""},u)})}),e.jsxs("div",{className:"mt-3 text-xs text-zinc-600",children:["Tip: generate suggested multipliers from logs using ",e.jsx("span",{className:"font-mono",children:"scripts/recsys/suggest_blend_calibration.mjs"}),"."]}),S.isError?e.jsx("div",{className:"mt-3",children:e.jsx(T,{title:"Save failed",error:S.error})}):null,S.isSuccess?e.jsx("div",{className:"mt-3 text-xs text-emerald-700",children:"Saved."}):null]})]})]})}function Ye(i){return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium text-zinc-900",children:i.label}),e.jsx("span",{className:"text-sm tabular-nums text-zinc-600",children:i.value})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("input",{type:"range",className:"flex-1 accent-zinc-900",min:i.min,max:i.max,step:i.step,value:i.value,onChange:a=>i.onChange(Number(a.target.value))})}),i.hint?e.jsx("div",{className:"mt-1.5 text-xs text-zinc-500",children:i.hint}):null]})}function v(i,a,t){return Number.isFinite(i)?Math.min(t,Math.max(a,i)):a}function y(i,a){const t=typeof i=="number"?i:Number(i);return Number.isFinite(t)?t:a}function Qe(i){return e.jsx("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:i.label}),i.hint?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:i.hint}):null]}),e.jsx("div",{className:"min-w-[180px]",children:i.children})]})})}function Xe(){const i=K({queryKey:["appSettings"],queryFn:qe,staleTime:1e4}),a=j.useMemo(()=>{var I,S;const x=((I=i.data)==null?void 0:I.rows)??[],n=((S=i.data)==null?void 0:S.registry)??{},b=J=>{var q;const F=x.find(u=>u.key===J);return F&&F.value!==void 0?F.value:(q=n==null?void 0:n[J])==null?void 0:q.default},M=b("ops.rate_limits")??{},w=(M==null?void 0:M.actions)??{};return{watchedSyntheticDwellMs:v(y(b("ranking.swipe.status_watched.synthetic_dwell_ms"),12e3),0,6e5),centroidRefreshSampleRate:v(y(b("ranking.swipe.centroids.refresh_sample_rate"),.25),0,1),centroidK:v(Math.round(y(b("ranking.swipe.centroids.k"),3)),1,10),centroidMaxItems:v(Math.round(y(b("ranking.swipe.centroids.max_items"),60)),10,200),rateSwipeDeck:v(Math.round(y(w==null?void 0:w.swipe_deck,120)),1,6e3),rateSwipeEvent:v(Math.round(y(w==null?void 0:w.swipe_event,1e3)),1,6e3),coldStartLookback:v(y(b("ranking.swipe.cold_start.lookback_days"),30),1,365),coldStartMin:v(y(b("ranking.swipe.cold_start.min_strong_positive"),3),1,100),coldStartLimit:v(y(b("ranking.swipe.cold_start.event_limit"),120),10,1e3),deckLimit:v(y(b("ranking.swipe.deck.default_limit"),60),10,200),deckMax:v(y(b("ranking.swipe.deck.max_limit"),120),10,200),rerankTtl:v(y(b("ops.rerank.cache_ttl_seconds"),600),0,86400),rerankWindow:v(y(b("ops.rerank.fresh_window_seconds"),21600),60,604800),_rateLimitsRaw:M,_rateActions:w}},[i.data]),[t,r]=j.useState(null);j.useEffect(()=>{i.data&&r({watchedSyntheticDwellMs:a.watchedSyntheticDwellMs,centroidRefreshSampleRate:a.centroidRefreshSampleRate,centroidK:a.centroidK,centroidMaxItems:a.centroidMaxItems,rateSwipeDeck:a.rateSwipeDeck,rateSwipeEvent:a.rateSwipeEvent,coldStartLookback:a.coldStartLookback,coldStartMin:a.coldStartMin,coldStartLimit:a.coldStartLimit,deckLimit:a.deckLimit,deckMax:a.deckMax,rerankTtl:a.rerankTtl,rerankWindow:a.rerankWindow})},[i.data,a]);const h=Ie({mutationFn:async()=>{var b;if(!t)throw new Error("No draft");const x={...a._rateActions,swipe_deck:v(Math.round(t.rateSwipeDeck),1,6e3),swipe_event:v(Math.round(t.rateSwipeEvent),1,6e3)},n={...a._rateLimitsRaw,actions:x};return Te({expected_version:(b=i.data)==null?void 0:b.version,reason:"Recsys knobs update",updates:{"ranking.swipe.status_watched.synthetic_dwell_ms":v(Math.round(t.watchedSyntheticDwellMs),0,6e5),"ranking.swipe.centroids.refresh_sample_rate":v(t.centroidRefreshSampleRate,0,1),"ranking.swipe.centroids.k":v(Math.round(t.centroidK),1,10),"ranking.swipe.centroids.max_items":v(Math.round(t.centroidMaxItems),10,200),"ops.rate_limits":n,"ranking.swipe.cold_start.lookback_days":v(Math.round(t.coldStartLookback),1,365),"ranking.swipe.cold_start.min_strong_positive":v(Math.round(t.coldStartMin),1,100),"ranking.swipe.cold_start.event_limit":v(Math.round(t.coldStartLimit),10,1e3),"ranking.swipe.deck.default_limit":v(Math.round(t.deckLimit),10,200),"ranking.swipe.deck.max_limit":v(Math.round(t.deckMax),10,200),"ops.rerank.cache_ttl_seconds":v(Math.round(t.rerankTtl),0,86400),"ops.rerank.fresh_window_seconds":v(Math.round(t.rerankWindow),60,604800)}})},onSuccess:()=>i.refetch()}),z=!!t&&(t.watchedSyntheticDwellMs!==a.watchedSyntheticDwellMs||Math.abs(t.centroidRefreshSampleRate-a.centroidRefreshSampleRate)>1e-9||t.centroidK!==a.centroidK||t.centroidMaxItems!==a.centroidMaxItems||t.rateSwipeDeck!==a.rateSwipeDeck||t.rateSwipeEvent!==a.rateSwipeEvent||t.coldStartLookback!==a.coldStartLookback||t.coldStartMin!==a.coldStartMin||t.coldStartLimit!==a.coldStartLimit||t.deckLimit!==a.deckLimit||t.deckMax!==a.deckMax||t.rerankTtl!==a.rerankTtl||t.rerankWindow!==a.rerankWindow);return e.jsxs(D,{title:"Core knobs",subtitle:"The key recsys knobs that previously were hard-coded. Saved into app_settings (server_only).",right:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>r({watchedSyntheticDwellMs:a.watchedSyntheticDwellMs,centroidRefreshSampleRate:a.centroidRefreshSampleRate,centroidK:a.centroidK,centroidMaxItems:a.centroidMaxItems,rateSwipeDeck:a.rateSwipeDeck,rateSwipeEvent:a.rateSwipeEvent,coldStartLookback:a.coldStartLookback,coldStartMin:a.coldStartMin,coldStartLimit:a.coldStartLimit,deckLimit:a.deckLimit,deckMax:a.deckMax,rerankTtl:a.rerankTtl,rerankWindow:a.rerankWindow}),disabled:!z||h.isPending,children:"Reset"}),e.jsx(O,{onClick:()=>h.mutate(),disabled:!z||h.isPending,children:h.isPending?"Savingâ€¦":"Save"})]}),children:[i.isError?e.jsx("div",{className:"p-4",children:e.jsx(T,{title:"Failed to load app settings",error:i.error})}):null,h.isError?e.jsx("div",{className:"p-4",children:e.jsx(T,{title:"Save failed",error:h.error})}):null,h.isSuccess?e.jsx("div",{className:"px-4 pt-4 text-xs text-emerald-700",children:"Saved."}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-4 p-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(Qe,{label:"Watched â†’ synthetic dwell (ms)",hint:"When the app marks an item as watched, we emit a synthetic dwell event to train taste feedback. Keep this moderate to avoid over-confident positives.",children:e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:0,max:6e5,step:1e3,value:(t==null?void 0:t.watchedSyntheticDwellMs)??a.watchedSyntheticDwellMs,onChange:x=>r(n=>n&&{...n,watchedSyntheticDwellMs:y(x.target.value,n.watchedSyntheticDwellMs)})})}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Centroids refresh"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ye,{label:"Refresh sample rate",value:(t==null?void 0:t.centroidRefreshSampleRate)??a.centroidRefreshSampleRate,min:0,max:1,step:.01,onChange:x=>r(n=>n&&{...n,centroidRefreshSampleRate:x}),hint:"Higher = faster adaptation, more DB work."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"k (centroids)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:10,step:1,value:(t==null?void 0:t.centroidK)??a.centroidK,onChange:x=>r(n=>n&&{...n,centroidK:y(x.target.value,n.centroidK)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"max items"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,step:5,value:(t==null?void 0:t.centroidMaxItems)??a.centroidMaxItems,onChange:x=>r(n=>n&&{...n,centroidMaxItems:y(x.target.value,n.centroidMaxItems)})})]})]}),e.jsxs("div",{className:"text-xs text-zinc-600",children:["These parameters are passed to ",e.jsx("span",{className:"font-mono",children:"media_refresh_user_centroids_v1"}),"."]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Cold Start"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Lookback (days)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:365,value:(t==null?void 0:t.coldStartLookback)??a.coldStartLookback,onChange:x=>r(n=>n&&{...n,coldStartLookback:y(x.target.value,n.coldStartLookback)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Min strong signals"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:100,value:(t==null?void 0:t.coldStartMin)??a.coldStartMin,onChange:x=>r(n=>n&&{...n,coldStartMin:y(x.target.value,n.coldStartMin)})})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Event limit"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:1e3,value:(t==null?void 0:t.coldStartLimit)??a.coldStartLimit,onChange:x=>r(n=>n&&{...n,coldStartLimit:y(x.target.value,n.coldStartLimit)})}),e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:"Max recent events to weigh"})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Deck & Rerank"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Deck Limit"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,value:(t==null?void 0:t.deckLimit)??a.deckLimit,onChange:x=>r(n=>n&&{...n,deckLimit:y(x.target.value,n.deckLimit)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Deck Max"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,value:(t==null?void 0:t.deckMax)??a.deckMax,onChange:x=>r(n=>n&&{...n,deckMax:y(x.target.value,n.deckMax)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Rerank TTL (s)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:0,max:86400,value:(t==null?void 0:t.rerankTtl)??a.rerankTtl,onChange:x=>r(n=>n&&{...n,rerankTtl:y(x.target.value,n.rerankTtl)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Fresh Window (s)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:60,max:604800,value:(t==null?void 0:t.rerankWindow)??a.rerankWindow,onChange:x=>r(n=>n&&{...n,rerankWindow:y(x.target.value,n.rerankWindow)})})]})]})]})]})]})]})}function C(i){return i==null||!Number.isFinite(i)?"â€”":`${(i*100).toFixed(1)}%`}function o(i){const a=Number(i);return Number.isFinite(a)?String(Math.trunc(a)):"0"}function ds(){var ue,pe,ge,je,be,ve,Ne,ye,fe,we,_e,ke,ze,Se,Me,Le,Ce,De;const[i,a]=j.useState(30),[t,r]=j.useState("quality"),h=K({queryKey:j.useMemo(()=>["rec_variant_metrics",i],[i]),queryFn:async()=>Ke({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="quality"}),z=K({queryKey:j.useMemo(()=>["rec_composition_metrics",i],[i]),queryFn:async()=>We({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="composition"}),x=K({queryKey:j.useMemo(()=>["rec_genre_metrics",i],[i]),queryFn:async()=>Ae({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="genres"}),n=K({queryKey:j.useMemo(()=>["rec_health_metrics",i],[i]),queryFn:async()=>Be({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),b=K({queryKey:j.useMemo(()=>["rec_diagnostics"],[]),queryFn:async()=>Pe(),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),M=K({queryKey:j.useMemo(()=>["rec_join_integrity",i],[i]),queryFn:async()=>Je({days:i,include_by_event:!0}),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),w=K({queryKey:j.useMemo(()=>["swipe_ingest_health",72],[]),queryFn:async()=>Oe({hours:72,top_n:12}),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),I=K({queryKey:j.useMemo(()=>["rec_position_metrics",i],[i]),queryFn:async()=>He({days:i,max_position:30}),staleTime:3e4,refetchInterval:6e4,enabled:t==="positions"}),S=K({queryKey:j.useMemo(()=>["rec_alerts_metrics",i],[i]),queryFn:async()=>Ge({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="alerts"}),J=((ue=h.data)==null?void 0:ue.rows)??[],F=((pe=z.data)==null?void 0:pe.rows)??[],q=((ge=x.data)==null?void 0:ge.rows)??[],u=((je=n.data)==null?void 0:je.rows)??[],d=(be=w.data)!=null&&be.ok?w.data:null,_=(d==null?void 0:d.hourly)??[],W=(d==null?void 0:d.issues)??[],g=_.length?_[0]:null,ae=j.useMemo(()=>_.slice().reverse(),[_]),k=((ve=I.data)==null?void 0:ve.rows)??[],m=((Ne=b.data)==null?void 0:Ne.row)??null,ne=((ye=M.data)==null?void 0:ye.daily)??[],xe=((fe=M.data)==null?void 0:fe.by_event)??[],L=ne[0],le=(L==null?void 0:L.day)??null,me=j.useMemo(()=>le?xe.filter(s=>s.day===le).slice().sort((s,N)=>Number(N.events_without_impression??0)-Number(s.events_without_impression??0)).slice(0,12):[],[xe,le]),B=u[0],ce=j.useMemo(()=>{const s=new Map;for(const p of k){const R=Number(p.position),U=s.get(R)??{position:R,impressions:0,likes:0,dislikes:0,watchlist_adds:0,detail_opens:0};U.impressions+=Number(p.impressions??0),U.likes+=Number(p.likes??0),U.dislikes+=Number(p.dislikes??0),U.watchlist_adds+=Number(p.watchlist_adds??0),U.detail_opens+=Number(p.detail_opens??0),s.set(R,U)}return Array.from(s.values()).sort((p,R)=>p.position-R.position).map(p=>({...p,like_rate:p.impressions?p.likes/p.impressions:0,dislike_rate:p.impressions?p.dislikes/p.impressions:0,watchlist_rate:p.impressions?p.watchlist_adds/p.impressions:0,detail_open_rate:p.impressions?p.detail_opens/p.impressions:0}))},[k]),H=F.length?F[0].day:null,de=j.useMemo(()=>F.filter(s=>H?s.day===H:!1),[F,H]),V=q.length?q[0].day:null,oe=j.useMemo(()=>q.filter(s=>V?s.day===V:!1),[q,V]),he=s=>s.reduce((N,p)=>N+p,0),G=he(de.map(s=>Number(s.impressions)||0)),$e=he(oe.map(s=>Number(s.muted_impressions)||0));return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Recsys Control Center"}),e.jsx("div",{className:"text-sm text-zinc-600",children:"Observe â†’ diagnose â†’ tune â†’ roll out (metrics, composition, drift, and controls)."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(Fe,{to:"/recsys/experiments",className:"rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm hover:bg-zinc-50",children:"Experiments"}),e.jsx(Fe,{to:"/recsys/assignments",className:"rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm hover:bg-zinc-50",children:"Assignments"}),e.jsx("label",{className:"text-xs font-medium text-zinc-700",children:"Window"}),e.jsxs("select",{className:re("h-9 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-900 shadow-sm","focus:outline-none focus:ring-2 focus:ring-zinc-300"),value:i,onChange:s=>a(Number(s.target.value)),children:[e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:14,children:"Last 14 days"}),e.jsx("option",{value:30,children:"Last 30 days"}),e.jsx("option",{value:60,children:"Last 60 days"}),e.jsx("option",{value:90,children:"Last 90 days"})]})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[{key:"health",label:"Live health"},{key:"quality",label:"Quality (A/B)"},{key:"composition",label:"Composition"},{key:"genres",label:"Genres & drift"},{key:"positions",label:"Position funnel"},{key:"alerts",label:"Alerts & guardrails"},{key:"controls",label:"Controls"}].map(s=>e.jsx("button",{onClick:()=>r(s.key),className:re("h-9 rounded-xl border px-3 text-sm shadow-sm",t===s.key?"border-zinc-900 bg-zinc-900 text-white":"border-zinc-200 bg-white text-zinc-900 hover:bg-zinc-50"),children:s.label},s.key))}),t==="health"?e.jsxs(e.Fragment,{children:[n.isError?e.jsx(T,{title:"Failed to load health",error:n.error}):null,b.isError?e.jsx(T,{title:"Failed to load diagnostics",error:b.error}):null,M.isError?e.jsx(T,{title:"Failed to load join integrity",error:M.error}):null,w.isError?e.jsx(T,{title:"Failed to load swipe ingest health",error:w.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(f,{title:"Decks (latest day)",value:B?o(B.decks):"â€”",subtitle:B?`Day: ${B.day}`:void 0}),e.jsx(f,{title:"Impressions",value:B?o(B.impressions):"â€”",subtitle:"rec_impressions rows"}),e.jsx(f,{title:"Users",value:B?o(B.users):"â€”",subtitle:"unique users"})]}),e.jsxs(D,{children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Experiment tagging health (last 7 days)"}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Tracks impressions missing experiment tags and outcomes without impressions."})]}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Window start: ",m!=null&&m.window_start?Re(m.window_start):"â€”"]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(f,{title:"Impressions (7d)",value:m?o(m.total_impressions):"â€”",subtitle:"Total impressions"}),e.jsx(f,{title:"Missing experiments",value:m?o(m.missing_experiments):"â€”",subtitle:m?`${C(m.missing_ratio)} of impressions`:void 0}),e.jsx(f,{title:"Outcomes without impression",value:m?o(m.outcomes_without_impression):"â€”",subtitle:"Join gaps (7d)"})]})]}),e.jsxs(D,{children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Join integrity (impressions â†’ outcomes)"}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Detects disconnects between rec_impressions and media_events using (user_id, served_dedupe_key)."})]}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Window: ",(we=M.data)!=null&&we.since?`${M.data.since} â†’ today`:M.isLoading?"Loadingâ€¦":"â€”"]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(f,{title:"Unjoinable rate",value:L?C(L.event_unjoinable_rate):"â€”",subtitle:L?`Day: ${L.day}`:void 0}),e.jsx(f,{title:"Events w/o impression",value:L?o(L.events_without_impression):"â€”",subtitle:"Join gaps"}),e.jsx(f,{title:"Missing served key",value:L?o(L.events_missing_served_dedupe_key):"â€”",subtitle:"Cannot link to impression"}),e.jsx(f,{title:"Invalid served key",value:L?o(L.events_invalid_served_dedupe_key):"â€”",subtitle:"Format mismatches"}),e.jsx(f,{title:"Missing rec_request_id",value:L?o(L.events_missing_rec_request_id):"â€”",subtitle:"Identity drift"})]}),e.jsx("div",{className:"mt-4 h-56",children:e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(se,{data:ne.slice().reverse(),children:[e.jsx(te,{strokeDasharray:"3 3"}),e.jsx(Q,{dataKey:"day",tick:{fontSize:12}}),e.jsx(X,{tick:{fontSize:12},domain:[0,1]}),e.jsx(Z,{}),e.jsx(ee,{}),e.jsx(A,{type:"monotone",dataKey:"event_unjoinable_rate",name:"Unjoinable rate",dot:!1})]})})}),me.length?e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Top unjoinable event types (latest day)"}),e.jsxs(P,{className:"mt-2",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Event"}),e.jsx(c,{children:"Source"}),e.jsx(c,{className:"text-right",children:"Events"}),e.jsx(c,{className:"text-right",children:"Without impression"}),e.jsx(c,{className:"text-right",children:"Unjoinable"})]})}),e.jsx("tbody",{children:me.map(s=>e.jsxs("tr",{children:[e.jsx(l,{children:s.event_type}),e.jsx(l,{children:s.source??"â€”"}),e.jsx(l,{className:"text-right",children:o(s.events)}),e.jsx(l,{className:"text-right",children:o(s.events_without_impression)}),e.jsx(l,{className:"text-right",children:C(s.event_unjoinable_rate)})]},`${s.day}_${s.event_type}_${s.source??""}`))})]})]}):null]}),e.jsxs(D,{children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Swipe ingest health (sampled rollups)"}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Edge ingestion outcomes + issue codes aggregated per hour (best-effort, sampled to control write volume)."})]}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Window: ",d!=null&&d.since?`${d.since} â†’ now`:w.isLoading?"Loadingâ€¦":"â€”"]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(f,{title:"Requests",value:g?o(g.requests):"â€”",subtitle:g?`Bucket: ${g.bucket_start}`:void 0}),e.jsx(f,{title:"Accepted",value:g?o(g.accepted_events):"â€”",subtitle:"Events"}),e.jsx(f,{title:"Rejected",value:g?o(g.rejected_events):"â€”",subtitle:g?`Rate: ${C(g.rejection_rate)}`:void 0}),e.jsx(f,{title:"Retry",value:g?o(g.retry_events):"â€”",subtitle:g?`Rate: ${C(g.retry_rate)}`:void 0}),e.jsx(f,{title:"Sample rate",value:g?String(g.sample_rate??"â€”"):"â€”",subtitle:g!=null&&g.updated_at?`Updated: ${Re(g.updated_at)}`:void 0})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-3 lg:grid-cols-3",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Rejection / retry rates (hourly)"}),e.jsx("div",{className:"mt-2 h-56",children:e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(se,{data:ae,children:[e.jsx(te,{strokeDasharray:"3 3"}),e.jsx(Q,{dataKey:"bucket_start",tick:{fontSize:10}}),e.jsx(X,{tick:{fontSize:12},domain:[0,1]}),e.jsx(Z,{}),e.jsx(ee,{}),e.jsx(A,{type:"monotone",dataKey:"rejection_rate",name:"Rejection rate",dot:!1}),e.jsx(A,{type:"monotone",dataKey:"retry_rate",name:"Retry rate",dot:!1})]})})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Top issue codes (window)"}),e.jsx("div",{className:"mt-2 rounded-xl border border-zinc-200 bg-white",children:e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Code"}),e.jsx(c,{className:"text-right",children:"Count"})]})}),e.jsx("tbody",{children:W.length?W.map(s=>e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs",children:s.code}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.count)})]},s.code)):e.jsx("tr",{children:e.jsx(l,{colSpan:2,className:"py-6 text-center text-xs text-zinc-600",children:w.isLoading?"Loadingâ€¦":"No issues recorded yet."})})})]})})})]})]})]}),e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily volume + feature flags"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(_e=n.data)!=null&&_e.since?`Since ${n.data.since}`:n.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Day"}),e.jsx(c,{className:"text-right",children:"Decks"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Users"}),e.jsx(c,{className:"text-right",children:"CF impr"}),e.jsx(c,{className:"text-right",children:"Mix impr"}),e.jsx(c,{className:"text-right",children:"Blend impr"}),e.jsx(c,{className:"text-right",children:"Diversity impr"})]})}),e.jsx("tbody",{children:u.length?u.map((s,N)=>e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.cf_impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions_in_mix_decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions_in_blend_decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions_in_diversity_decks)})]},`${s.day}:${N}`)):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:n.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="quality"?e.jsxs(e.Fragment,{children:[h.isError?e.jsx(T,{title:"Failed to load metrics",error:h.error}):null,e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily experiment metrics"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(ke=h.data)!=null&&ke.since?`Since ${h.data.since}`:h.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Day"}),e.jsx(c,{children:"Experiment"}),e.jsx(c,{children:"Variant"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Users"}),e.jsx(c,{className:"text-right",children:"Detail"}),e.jsx(c,{className:"text-right",children:"Likes"}),e.jsx(c,{className:"text-right",children:"Watchlist"}),e.jsx(c,{className:"text-right",children:"Like rate"}),e.jsx(c,{className:"text-right",children:"WL rate"})]})}),e.jsx("tbody",{children:J.length?J.map((s,N)=>e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs",children:s.experiment_key}),e.jsx(l,{className:"text-xs font-medium",children:s.variant}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.detail_opens)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.likes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.watchlist_adds)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.like_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.watchlist_add_rate)})]},`${s.day}:${s.experiment_key}:${s.variant}:${N}`)):e.jsx("tr",{children:e.jsx(l,{colSpan:10,className:"py-8 text-center text-sm text-zinc-600",children:h.isLoading?"Loadingâ€¦":"No data yet. Once users swipe, metrics will appear here."})})})]})})]})]}):null,t==="composition"?e.jsxs(e.Fragment,{children:[z.isError?e.jsx(T,{title:"Failed to load composition",error:z.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(f,{title:"Latest day",value:H??"â€”",subtitle:"Composition snapshot"}),e.jsx(f,{title:"Total impressions",value:G?o(G):"â€”",subtitle:"Across all sources"}),e.jsx(f,{title:"Top source share",value:G&&de.length?(()=>{const s=[...de].sort((p,R)=>(R.impressions??0)-(p.impressions??0))[0],N=(Number(s==null?void 0:s.impressions)||0)/G;return`${(s==null?void 0:s.source)??"â€”"} Â· ${(N*100).toFixed(0)}%`})():"â€”",subtitle:"Source dominance (watch for drift)"})]}),e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily source metrics"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(ze=z.data)!=null&&ze.since?`Since ${z.data.since}`:z.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Day"}),e.jsx(c,{children:"Mode"}),e.jsx(c,{children:"Source"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Users"}),e.jsx(c,{className:"text-right",children:"Like rate"}),e.jsx(c,{className:"text-right",children:"WL rate"}),e.jsx(c,{className:"text-right",children:"Share"})]})}),e.jsx("tbody",{children:F.length?F.map((s,N)=>{const R=(H?s.day===H:!1)&&G?(Number(s.impressions)||0)/G:null;return e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs",children:s.mode}),e.jsx(l,{className:"text-xs font-medium",children:s.source}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.like_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.watchlist_add_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:R==null?"â€”":`${(R*100).toFixed(0)}%`})]},`${s.day}:${s.mode}:${s.source}:${N}`)}):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:z.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="genres"?e.jsxs(e.Fragment,{children:[x.isError?e.jsx(T,{title:"Failed to load genre metrics",error:x.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(f,{title:"Latest day",value:V??"â€”",subtitle:"Genre exposure snapshot"}),e.jsx(f,{title:"Muted leakage (latest)",value:V?o($e):"â€”",subtitle:"Should trend to 0"}),e.jsx(f,{title:"Drift signal",value:oe.length?(()=>{const s=[...oe].map(N=>({slug:N.genre_slug,d:Math.abs((N.share_day??0)-(N.share_catalog??0))})).sort((N,p)=>p.d-N.d)[0];return s?`${s.slug} Â· ${(s.d*100).toFixed(1)}pp`:"â€”"})():"â€”",subtitle:"Largest |share_day - share_catalog|"})]}),e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily genre exposure"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(Se=x.data)!=null&&Se.since?`Since ${x.data.since}`:x.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Day"}),e.jsx(c,{children:"Genre"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Users"}),e.jsx(c,{className:"text-right",children:"Share (day)"}),e.jsx(c,{className:"text-right",children:"Share (catalog)"}),e.jsx(c,{className:"text-right",children:"Î”"}),e.jsx(c,{className:"text-right",children:"Muted leak"})]})}),e.jsx("tbody",{children:q.length?q.map((s,N)=>{const p=(s.share_day??0)-(s.share_catalog??0),R=Number(s.muted_impressions)||0;return e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs font-medium",children:s.genre_slug}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.share_day)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.share_catalog)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:`${(p*100).toFixed(1)}pp`}),e.jsx(l,{className:re("text-right text-xs tabular-nums",R>0?"font-semibold text-red-600":"text-zinc-700"),children:o(R)})]},`${s.day}:${s.genre_slug}:${N}`)}):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:x.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="positions"?e.jsxs(e.Fragment,{children:[I.isError?e.jsx(T,{title:"Failed to load position metrics",error:I.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs(D,{className:"p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Like rate by position"}),e.jsx("div",{className:"h-64",children:e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(se,{data:ce,margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(te,{strokeDasharray:"3 3"}),e.jsx(Q,{dataKey:"position",tick:{fontSize:12}}),e.jsx(X,{tick:{fontSize:12},domain:[0,1]}),e.jsx(Z,{formatter:s=>`${(Number(s)*100).toFixed(1)}%`}),e.jsx(ee,{}),e.jsx(A,{type:"monotone",dataKey:"like_rate",name:"Like rate",dot:!1}),e.jsx(A,{type:"monotone",dataKey:"dislike_rate",name:"Dislike rate",dot:!1})]})})})]}),e.jsxs(D,{className:"p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Engagement by position"}),e.jsx("div",{className:"h-64",children:e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(se,{data:ce,margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(te,{strokeDasharray:"3 3"}),e.jsx(Q,{dataKey:"position",tick:{fontSize:12}}),e.jsx(X,{tick:{fontSize:12},domain:[0,1]}),e.jsx(Z,{formatter:s=>`${(Number(s)*100).toFixed(1)}%`}),e.jsx(ee,{}),e.jsx(A,{type:"monotone",dataKey:"detail_open_rate",name:"Detail open rate",dot:!1}),e.jsx(A,{type:"monotone",dataKey:"watchlist_rate",name:"Watchlist add rate",dot:!1})]})})})]})]}),e.jsxs(D,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Aggregated counts by position (window)"}),e.jsx("div",{className:"text-xs text-zinc-600",children:I.data?`Since ${I.data.since}`:I.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(P,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 text-xs uppercase tracking-wide text-zinc-600",children:[e.jsx(c,{children:"Pos"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Likes"}),e.jsx(c,{className:"text-right",children:"Dislikes"}),e.jsx(c,{className:"text-right",children:"Detail opens"}),e.jsx(c,{className:"text-right",children:"Watchlist"}),e.jsx(c,{className:"text-right",children:"Like rate"})]})}),e.jsx("tbody",{children:ce.map(s=>e.jsxs("tr",{className:"border-b border-zinc-100 text-sm",children:[e.jsx(l,{children:s.position}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.likes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.dislikes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.detail_opens)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:o(s.watchlist_adds)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:C(s.like_rate)})]},s.position))})]})})]})]}):t==="alerts"?e.jsxs(e.Fragment,{children:[S.isError?e.jsx(T,{title:"Failed to load alerts",error:S.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs(D,{className:"p-4 md:col-span-2",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Guardrail rates over time"}),e.jsx("div",{className:"h-72",children:e.jsx(Y,{width:"100%",height:"100%",children:e.jsxs(se,{data:((Me=S.data)==null?void 0:Me.daily)??[],margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(te,{strokeDasharray:"3 3"}),e.jsx(Q,{dataKey:"day",tick:{fontSize:12}}),e.jsx(X,{tick:{fontSize:12}}),e.jsx(Z,{}),e.jsx(ee,{}),e.jsx(A,{type:"monotone",dataKey:"like_rate",name:"Like rate",dot:!1}),e.jsx(A,{type:"monotone",dataKey:"watchlist_rate",name:"Watchlist add rate",dot:!1}),e.jsx(A,{type:"monotone",dataKey:"cf_share",name:"CF share",dot:!1})]})})}),e.jsx("div",{className:"mt-2 text-xs text-zinc-600",children:"Guardrails compare today vs trailing 7-day average and require enough volume (â‰¥200 impressions/day)."})]}),e.jsxs(D,{className:"p-4",children:[e.jsxs("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:["Active alerts (last ",i,"d)"]}),e.jsxs("div",{className:"space-y-2",children:[(((Le=S.data)==null?void 0:Le.alerts)??[]).slice(0,10).map((s,N)=>e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-900",children:s.alert_key}),e.jsx("div",{className:re("rounded-full px-2 py-0.5 text-xs font-semibold",s.severity==="high"?"bg-red-100 text-red-800":s.severity==="medium"?"bg-amber-100 text-amber-900":"bg-zinc-100 text-zinc-800"),children:s.severity})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-700",children:[s.day,": ",s.message]})]},N)),(((Ce=S.data)==null?void 0:Ce.alerts)??[]).length===0?e.jsx("div",{className:"rounded-xl border p-3 text-xs text-zinc-700",children:"No active alerts ðŸŽ‰"}):null]})]})]}),e.jsxs(D,{className:"mt-3 p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Daily guardrail table"}),e.jsx(P,{children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(c,{children:"Day"}),e.jsx(c,{className:"text-right",children:"Impr"}),e.jsx(c,{className:"text-right",children:"Like%"}),e.jsx(c,{className:"text-right",children:"WL%"}),e.jsx(c,{className:"text-right",children:"CF%"}),e.jsx(c,{className:"text-right",children:"Muted"}),e.jsx(c,{children:"Flags"})]})}),e.jsx("tbody",{children:(((De=S.data)==null?void 0:De.daily)??[]).slice().reverse().map((s,N)=>e.jsxs("tr",{className:"border-t",children:[e.jsx(l,{children:s.day}),e.jsx(l,{className:"text-right",children:o(s.impressions)}),e.jsx(l,{className:"text-right",children:C(s.like_rate)}),e.jsx(l,{className:"text-right",children:C(s.watchlist_rate)}),e.jsx(l,{className:"text-right",children:C(s.cf_share)}),e.jsx(l,{className:"text-right",children:o(s.muted_impressions)}),e.jsx(l,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.alert_muted_leakage?e.jsx("span",{className:"rounded-full bg-red-100 px-2 py-0.5 text-xs font-semibold text-red-800",children:"Muted leakage"}):null,s.alert_like_rate_drop?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-900",children:"Like drop"}):null,s.alert_watchlist_rate_drop?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-900",children:"WL drop"}):null,s.alert_cf_starvation?e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-0.5 text-xs font-semibold text-zinc-800",children:"CF=0"}):null]})})]},N))})]})})]})]}):t==="controls"?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{}),e.jsx("div",{className:"mt-4",children:e.jsx(Xe,{})})]}):null]})}export{ds as default};
