import{r,j as e,L,B as x,a as E,K as T}from"./index-CoY44SlW.js";import{u as B,E as D}from"./ErrorBox-CvgwTo6Q.js";import{C as k}from"./Card-DzyM45zw.js";import{T as R,a as N,b as p}from"./Table-BpO-pS4x.js";import{I as A}from"./Input-CFuN_OLj.js";import{E as F}from"./EmptyState-DaHQMra1.js";import{C as w}from"./CopyButton-DdPzwO7I.js";function $(s){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:s.children})}function q(s,n,m="text/plain"){const u=new Blob([n],{type:m}),l=URL.createObjectURL(u),o=document.createElement("a");o.href=l,o.download=s,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(l)}function G(){const[s,n]=r.useState(100),[m,u]=r.useState(""),[l,o]=r.useState(""),[h,j]=r.useState(null),[y,g]=r.useState([]),[b,c]=r.useState(null),z=B({queryKey:["audit",{limit:s,search:l,before:h}],queryFn:()=>T({limit:s,search:l.trim()||null,before:h})}),d=z.data,f=(d==null?void 0:d.rows)??[],S=r.useMemo(()=>f.find(t=>String(t.id)===String(b))??null,[f,b]);r.useEffect(()=>{b&&(S||c(null))},[b,S]),r.useEffect(()=>{j(null),g([]),c(null)},[s,l]);const C=()=>{c(null),j(null),g([]),o(m.trim())},_=()=>{n(100),c(null),j(null),g([]),u(""),o("")},O=()=>{const t=["id","created_at","admin_user_id","admin_email","action","target","details"].join(","),a=f.map(i=>{const J=(()=>{try{return JSON.stringify(i.details??{})}catch{return"{}"}})();return[JSON.stringify(i.id??""),JSON.stringify(i.created_at??""),JSON.stringify(i.admin_user_id??""),JSON.stringify(i.admin_email??""),JSON.stringify(i.action??""),JSON.stringify(i.target??""),JSON.stringify(J)].join(",")});q(`audit_${h?"paged":"latest"}_${f.length}.csv`,[t,...a].join(`
`),"text/csv")};return z.isLoading?e.jsx(L,{}):z.error?e.jsx(D,{error:z.error}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx($,{children:"Audit log"}),(()=>{const t=[s!==100?`limit=${s}`:null,l?`q="${l}"`:null,h?`before=${h}`:null].filter(Boolean);return t.length?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Applied: ",e.jsx("span",{className:"font-mono",children:t.join(" • ")})]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No filters applied."})})()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",type:"button",onClick:O,disabled:!f.length,children:"Export CSV"}),e.jsx(x,{variant:"ghost",type:"button",onClick:_,children:"Reset filters"})]})]}),e.jsx(k,{title:"Filters",children:e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center",children:[e.jsx("div",{className:"w-40",children:e.jsx(A,{type:"number",value:String(s),min:10,max:500,onChange:t=>{const a=t.target.value;if(a==="")return;const v=Number(a);if(!Number.isFinite(v))return;const i=Math.max(10,Math.min(500,Math.trunc(v)));n(i)}})}),e.jsx("div",{className:"flex-1",children:e.jsx(A,{value:m,onChange:t=>u(t.target.value),onKeyDown:t=>{t.key==="Enter"&&C()},placeholder:"Search action/target (e.g., ban, reset_cursor, embedding_settings)"})}),e.jsx(x,{type:"button",onClick:C,children:"Apply"}),e.jsx(x,{variant:"ghost",type:"button",onClick:_,children:"Clear"})]})}),e.jsxs(k,{title:"Recent admin actions",children:[e.jsxs(R,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(N,{children:"At"}),e.jsx(N,{children:"Admin"}),e.jsx(N,{children:"Action"}),e.jsx(N,{children:"Target"}),e.jsx(N,{children:"Details"})]})}),e.jsx("tbody",{children:f.length?f.map(t=>{const a=t.admin_email??t.admin_user_id??"—",v=(()=>{try{const i=JSON.stringify(t.details??{});return i.length>120?i.slice(0,120)+"…":i}catch{return"{…}"}})();return e.jsxs("tr",{className:"cursor-pointer hover:bg-zinc-100 "+(String(b)===String(t.id)?"bg-zinc-200":""),onClick:()=>c(String(t.id)),children:[e.jsx(p,{className:"whitespace-nowrap text-xs text-zinc-600",children:E(t.created_at)}),e.jsx(p,{className:"max-w-[16rem] truncate text-xs text-zinc-600",children:a}),e.jsx(p,{className:"font-mono text-xs",children:t.action}),e.jsx(p,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:t.target}),t.target?e.jsx(w,{text:String(t.target),label:"Copy",className:"h-8 px-2 py-1 text-xs"}):null]})}),e.jsx(p,{className:"max-w-[22rem] truncate text-xs text-zinc-600",children:v})]},t.id)}):e.jsx("tr",{children:e.jsx(p,{colSpan:5,className:"p-6",children:e.jsx(F,{title:"No audit events",message:"No audit rows yet for this range.",className:"border-0 bg-transparent p-0"})})})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsx(x,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{j(null),g([]),c(null)},disabled:!h&&y.length===0,children:"First page"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{const t=y[y.length-1]??null;g(a=>a.slice(0,-1)),j(t),c(null)},disabled:y.length===0,children:"Prev"}),e.jsx(x,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{const t=(d==null?void 0:d.next_before)??null;t&&(g(a=>[...a,h]),j(t),c(null))},disabled:!(d!=null&&d.next_before),children:"Next"})]})]})]}),e.jsx(I,{open:!!S,row:S,onClose:()=>c(null)})]})}function I(s){if(r.useEffect(()=>{if(!s.open)return;const u=l=>{l.key==="Escape"&&s.onClose()};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[s.open,s.onClose]),!s.open||!s.row)return null;const n=s.row,m=(()=>{try{return JSON.stringify(n.details??{},null,2)}catch{return String(n.details??"{}")}})();return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:s.onClose}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full max-w-xl border-l border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Audit details"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-zinc-500 font-mono",children:[e.jsx("span",{children:n.id}),e.jsx(w,{text:String(n.id),label:"Copy id",className:"h-8 px-2 py-1 text-xs"})]})]}),e.jsx(x,{variant:"ghost",type:"button",className:"rounded-xl px-3 py-2 text-sm text-zinc-600 hover:bg-zinc-100",onClick:s.onClose,"aria-label":"Close",children:"Close"})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"At"}),e.jsx("div",{className:"text-zinc-700",children:E(n.created_at)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Admin"}),e.jsx("div",{className:"text-zinc-700",children:n.admin_email??n.admin_user_id??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Action"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.action})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Target"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.target})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Details"}),e.jsx(w,{text:m,label:"Copy JSON",className:"h-8 px-2 py-1 text-xs"})]}),e.jsx("pre",{className:"mt-2 max-h-[65vh] overflow-auto rounded-2xl border border-zinc-200 bg-zinc-50 p-3 text-xs text-zinc-700",children:m})]})]})]})}export{G as default};
