import{r as i,f as d,j as t,L as re,e as oe,B as x,v as ne,a as ae,w as ie}from"./index-RmnKeFJ0.js";import{u as le,E as de}from"./ErrorBox-CT9uctWi.js";import{C as N}from"./Card-BlxKcLs_.js";import{I as X}from"./Input-D4LaOzI6.js";import{S as E,R as ce,X as me,Y as ue,T as xe,L as be}from"./generateCategoricalChart-CBcHhIqz.js";import{T as A,a as u,b as c}from"./Table-CrgI8WuL.js";import{E as he}from"./EmptyState-Cd3UWduY.js";import{C as je}from"./CopyButton-CovIfS24.js";import{L as ye,a as ge}from"./LineChart-DTW0VBKU.js";function fe(l){return t.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:l.children})}function Q(l){return new Date(`${l}T00:00:00.000Z`)}function k(l,v){const m=Q(l);return Number.isNaN(m.getTime())||v==="utc"?l:m.toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"})}function R(l,v,m="text/plain"){const w=new Blob([v],{type:m}),b=URL.createObjectURL(w),h=document.createElement("a");h.href=b,h.download=l,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(b)}function ze(){var K;const[l,v]=i.useState(14),[m,w]=i.useState("utc"),[b,h]=i.useState("providers"),[P,L]=i.useState(""),[S,J]=i.useState("{}"),[O,T]=i.useState(!1),[U,p]=i.useState(null),[$,I]=i.useState(!1);function Y(){try{const e=S.trim()?JSON.parse(S):{};p(null),T(!0),J(JSON.stringify(e,null,2))}catch(e){p((e==null?void 0:e.message)??String(e))}}function W(){if(!o)return;const e=(o==null?void 0:o.budgets)??{},s=e.total_daily_budget;L(s==null?"":String(s));const r=e.by_provider_budget&&typeof e.by_provider_budget=="object"?e.by_provider_budget:{};J(JSON.stringify(r,null,2)),T(!1),p(null)}const C=le({queryKey:["costs",{days:l}],queryFn:()=>ie({days:l})}),o=C.data;i.useEffect(()=>{if(!o||O)return;const e=(o==null?void 0:o.budgets)??{},s=e.total_daily_budget;L(s==null?"":String(s));const r=e.by_provider_budget&&typeof e.by_provider_budget=="object"?e.by_provider_budget:{};J(JSON.stringify(r,null,2))},[o,O]);const j=i.useMemo(()=>{const e=o==null?void 0:o.daily;return Array.isArray(e)?e.filter(Boolean).filter(s=>typeof s.day=="string"&&typeof s.provider=="string").map(s=>({day:String(s.day),provider:String(s.provider),tokens:Number.isFinite(Number(s.tokens))?Number(s.tokens):0,runs:Number.isFinite(Number(s.runs))?Number(s.runs):0,errors:Number.isFinite(Number(s.errors))?Number(s.errors):0})):[]},[o]),z=i.useMemo(()=>{const e=o==null?void 0:o.daily_jobs;return Array.isArray(e)?e.filter(Boolean).filter(s=>typeof s.day=="string"&&typeof s.job_name=="string"&&typeof s.provider=="string").map(s=>({day:String(s.day),job_name:String(s.job_name),provider:String(s.provider),tokens:Number.isFinite(Number(s.tokens))?Number(s.tokens):0,runs:Number.isFinite(Number(s.runs))?Number(s.runs):0,errors:Number.isFinite(Number(s.errors))?Number(s.errors):0})):[]},[o]),F=i.useMemo(()=>{const e=o==null?void 0:o.jobs;return Array.isArray(e)?e.filter(Boolean).filter(s=>typeof s.job_name=="string").map(s=>({job_name:String(s.job_name),provider:s.provider==null?null:String(s.provider),tokens:Number.isFinite(Number(s.tokens))?Number(s.tokens):0,runs:Number.isFinite(Number(s.runs))?Number(s.runs):0,errors:Number.isFinite(Number(s.errors))?Number(s.errors):0,last_started_at:s.last_started_at?String(s.last_started_at):null})).sort((s,r)=>r.tokens-s.tokens):[]},[o]),y=i.useMemo(()=>{const e=new Set;for(const s of j)e.add(s.provider);return Array.from(e.values()).sort()},[j]),g=i.useMemo(()=>{var n;const e=(n=o==null?void 0:o.today)==null?void 0:n.day,s=e?Q(e):new Date;if(Number.isNaN(s.getTime()))return[];const r=[];for(let a=l-1;a>=0;a--){const f=new Date(s.getTime());f.setUTCDate(f.getUTCDate()-a),r.push(f.toISOString().slice(0,10))}return r},[o,l]),Z=i.useMemo(()=>{if(!g.length)return[];const e={};for(const s of g)e[s]={day:s,dayLabel:k(s,m)};for(const s of j)e[s.day]||(e[s.day]={day:s.day,dayLabel:k(s.day,m)}),e[s.day][s.provider]=(e[s.day][s.provider]??0)+s.tokens;for(const s of Object.keys(e))for(const r of y)e[s][r]=Number(e[s][r]??0);return Object.values(e).sort((s,r)=>String(s.day).localeCompare(String(r.day)))},[j,g,y,m]),M=i.useMemo(()=>{const e=new Map;for(const s of z)e.set(s.job_name,(e.get(s.job_name)??0)+s.tokens);return Array.from(e.entries()).sort((s,r)=>r[1]-s[1]).slice(0,6).map(([s])=>s)},[z]),G=i.useMemo(()=>{if(!g.length)return[];const e={};for(const n of g)e[n]={day:n,dayLabel:k(n,m)};const s="(other jobs)";for(const n of z){e[n.day]||(e[n.day]={day:n.day,dayLabel:k(n.day,m)});const a=M.includes(n.job_name)?n.job_name:s;e[n.day][a]=(e[n.day][a]??0)+n.tokens}const r=[...M,s];for(const n of Object.keys(e))for(const a of r)e[n][a]=Number(e[n][a]??0);return Object.values(e).sort((n,a)=>String(n.day).localeCompare(String(a.day)))},[z,g,M,m]),H=i.useMemo(()=>{const e=j.reduce((r,n)=>r+n.tokens,0),s={};for(const r of j)s[r.provider]=(s[r.provider]??0)+r.tokens;return{total:e,byProvider:s}},[j]),B=i.useMemo(()=>{const e=o==null?void 0:o.today,s=typeof(e==null?void 0:e.day)=="string"?e.day:"—",r=Number.isFinite(Number(e==null?void 0:e.total_tokens))?Number(e.total_tokens):0,n=e!=null&&e.by_provider&&typeof e.by_provider=="object"?e.by_provider:{};return{day:s,totalTokens:r,byProvider:n}},[o]),D=i.useMemo(()=>{const e=o==null?void 0:o.data_quality;return{rows:Number.isFinite(Number(e==null?void 0:e.rows))?Number(e.rows):0,rowsWithTokens:Number.isFinite(Number(e==null?void 0:e.rows_with_tokens))?Number(e.rows_with_tokens):0,rowsMissingTokens:Number.isFinite(Number(e==null?void 0:e.rows_missing_tokens))?Number(e.rows_missing_tokens):0}},[o]),q=i.useMemo(()=>{const e=[];return D.rowsMissingTokens>0&&e.push({kind:"warn",msg:`There are ${d(D.rowsMissingTokens)} job_run_log rows missing total_tokens. Those rows won’t show up in charts.`}),e},[D]),ee=()=>{const e=["day","provider","tokens","runs","errors"].join(","),s=j.map(r=>[r.day,r.provider,r.tokens,r.runs,r.errors].join(","));R(`costs_daily_${l}d.csv`,[e,...s].join(`
`),"text/csv")},te=()=>{const e=["day","job_name","provider","tokens","runs","errors"].join(","),s=z.map(r=>[r.day,JSON.stringify(r.job_name),r.provider,r.tokens,r.runs,r.errors].join(","));R(`costs_daily_jobs_${l}d.csv`,[e,...s].join(`
`),"text/csv")},se=()=>{const e=["job_name","provider","tokens","runs","errors","last_started_at"].join(","),s=F.map(r=>[JSON.stringify(r.job_name),r.provider??"",r.tokens,r.runs,r.errors,r.last_started_at??""].join(","));R(`costs_jobs_${l}d.csv`,[e,...s].join(`
`),"text/csv")};return C.isLoading?t.jsx(re,{}):C.error?t.jsx(de,{error:C.error}):t.jsxs("div",{className:"space-y-6",children:[t.jsx(fe,{children:"Costs"}),t.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[t.jsx(E,{title:`Total tokens (last ${l}d)`,value:d(H.total),subtitle:t.jsxs("span",{className:"font-mono text-zinc-500",children:["since: ",(o==null?void 0:o.since)??"—"]})}),t.jsx(E,{title:`Today (${k(B.day,"utc")})`,value:d(B.totalTokens),subtitle:((K=o==null?void 0:o.today)==null?void 0:K.total_budget)==null?t.jsx("span",{className:"text-zinc-500",children:"No daily budget set."}):t.jsxs("span",{className:"text-zinc-500",children:["Remaining: ",t.jsx("span",{className:"font-mono",children:d(Number(o.today.total_remaining??0))})]})}),t.jsx(E,{title:"Data quality",value:d(D.rows),subtitle:t.jsxs("span",{children:[t.jsx("span",{className:"font-mono",children:d(D.rowsMissingTokens)})," rows missing total_tokens"]})})]}),q.length?t.jsx(N,{title:"Alerts",children:t.jsx("div",{className:"space-y-2",children:q.map((e,s)=>t.jsx("div",{className:oe("rounded-xl border px-3 py-2 text-sm",e.kind==="warn"?"border-amber-200 bg-amber-50 text-amber-700":"border-zinc-200 bg-zinc-50 text-zinc-700"),children:e.msg},s))})}):null,t.jsx(N,{title:"Controls",children:t.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[t.jsxs("div",{children:[t.jsx("div",{className:"mb-1 text-xs text-zinc-500",children:"Days"}),t.jsx("div",{className:"w-28",children:t.jsx(X,{type:"number",value:String(l),min:3,max:60,onChange:e=>{const s=e.target.value;if(s==="")return;const r=Number(s);if(!Number.isFinite(r))return;const n=Math.max(3,Math.min(60,Math.trunc(r)));v(n)}})})]}),t.jsxs("div",{children:[t.jsx("div",{className:"mb-1 text-xs text-zinc-500",children:"Chart"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(x,{variant:b==="providers"?"primary":"ghost",onClick:()=>h("providers"),children:"Providers"}),t.jsx(x,{variant:b==="jobs"?"primary":"ghost",onClick:()=>h("jobs"),children:"Jobs"})]})]}),t.jsxs("div",{children:[t.jsx("div",{className:"mb-1 text-xs text-zinc-500",children:"X-axis labels"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(x,{variant:m==="utc"?"primary":"ghost",onClick:()=>w("utc"),children:"UTC"}),t.jsx(x,{variant:m==="local"?"primary":"ghost",onClick:()=>w("local"),children:"Local"})]})]}),t.jsx("div",{className:"flex-1"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx(x,{variant:"ghost",onClick:ee,children:"Export daily CSV"}),t.jsx(x,{variant:"ghost",onClick:te,children:"Export daily jobs CSV"}),t.jsx(x,{variant:"ghost",onClick:se,children:"Export jobs CSV"}),t.jsx(x,{variant:"ghost",onClick:()=>{v(14),w("utc"),h("providers")},children:"Reset defaults"}),t.jsxs("div",{className:"flex items-center pl-2 text-xs text-zinc-500",children:["Applied: last ",t.jsx("span",{className:"font-mono",children:l})," days · labels ",t.jsx("span",{className:"font-mono",children:m})," · view ",t.jsx("span",{className:"font-mono",children:b})]})]})]})}),t.jsxs(N,{title:b==="providers"?"Tokens by day (providers)":"Tokens by day (top jobs)",children:[t.jsx("div",{className:"h-72",children:t.jsx(ce,{width:"100%",height:"100%",children:t.jsxs(ye,{data:b==="providers"?Z:G,children:[t.jsx(me,{dataKey:"dayLabel"}),t.jsx(ue,{tickFormatter:e=>d(Number(e))}),t.jsx(xe,{formatter:e=>d(Number(e))}),t.jsx(be,{}),(b==="providers"?y:[...M,"(other jobs)"]).map(e=>t.jsx(ge,{type:"monotone",dataKey:e,dot:!1},e))]})})}),t.jsxs("div",{className:"mt-4 text-xs text-zinc-500",children:["Note: This dashboard reads ",t.jsx("span",{className:"font-mono",children:"total_tokens"})," from ",t.jsx("span",{className:"font-mono",children:"job_run_log"}),". If a provider doesn’t report tokens, its line may be empty (and will show up as missing-token rows)."]})]}),t.jsx(N,{title:"Today usage (by provider)",children:t.jsxs(A,{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx(u,{children:"Provider"}),t.jsx(u,{className:"text-right",children:"Used"}),t.jsx(u,{className:"text-right",children:"Budget"}),t.jsx(u,{className:"text-right",children:"Remaining"})]})}),t.jsx("tbody",{children:y.length?y.map(e=>{var a,f,_,V;const s=Number(B.byProvider[e]??0),r=(f=(a=o==null?void 0:o.today)==null?void 0:a.budget_by_provider)==null?void 0:f[e],n=(V=(_=o==null?void 0:o.today)==null?void 0:_.remaining_by_provider)==null?void 0:V[e];return t.jsxs("tr",{children:[t.jsx(c,{className:"font-mono",children:e}),t.jsx(c,{className:"text-right font-mono",children:d(s)}),t.jsx(c,{className:"text-right font-mono",children:r==null?"—":d(Number(r))}),t.jsx(c,{className:"text-right font-mono",children:n==null?"—":d(Number(n))})]},e)}):t.jsx("tr",{children:t.jsx(c,{colSpan:4,className:"p-6",children:t.jsx(he,{title:"No cost data",message:"No provider/model costs were returned for this period.",className:"border-0 bg-transparent p-0"})})})})]})}),t.jsxs(N,{title:"Budgets",children:[t.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[t.jsxs("div",{children:[t.jsx("div",{className:"mb-1 text-xs text-zinc-500",children:"Total daily token budget (optional)"}),t.jsx(X,{type:"number",value:P,placeholder:"0",min:0,onChange:e=>{p(null),T(!0),L(e.target.value)}}),t.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:"If set, the dashboard will show “remaining” for today."})]}),t.jsxs("div",{children:[t.jsx("div",{className:"mb-1 text-xs text-zinc-500",children:"Daily budgets by provider (JSON map)"}),t.jsx("textarea",{value:S,rows:6,onChange:e=>{p(null),T(!0),J(e.target.value)},className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 font-mono text-sm text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-2 focus:ring-zinc-300",spellCheck:!1}),t.jsxs("div",{className:"mt-1 text-xs text-zinc-500",children:["Keys must match ",t.jsx("span",{className:"font-mono",children:"job_run_log.provider"}),"."]})]})]}),t.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-3",children:[t.jsx(x,{variant:"primary",disabled:$||!O,onClick:async()=>{p(null),I(!0);try{const e=P.trim();let s=null;if(e!==""){const a=Number(e);if(!Number.isFinite(a)||a<0)throw new Error("Total daily budget must be a non-negative number");s=Math.floor(a)}let r={};try{r=JSON.parse(S||"{}")}catch{throw new Error("Provider budget JSON is invalid")}if(r==null||typeof r!="object"||Array.isArray(r))throw new Error("Provider budget JSON must be an object map");const n={};for(const[a,f]of Object.entries(r)){const _=Number(f);!Number.isFinite(_)||_<0||(n[String(a)]=Math.floor(_))}await ne({total_daily_budget:s,by_provider_budget:n}),T(!1),await C.refetch()}catch(e){p((e==null?void 0:e.message)??String(e))}finally{I(!1)}},children:$?"Saving…":"Save budgets"}),t.jsx(x,{variant:"ghost",onClick:Y,children:"Format JSON"}),t.jsx(je,{text:S,label:"Copy JSON"}),t.jsx(x,{variant:"ghost",onClick:W,disabled:!o,children:"Reset"}),t.jsxs("div",{className:"text-xs text-zinc-500",children:["Stored in DB (",t.jsx("span",{className:"font-mono",children:"admin_costs_settings"}),"). No ENV vars."]}),U?t.jsx("div",{className:"text-xs text-red-600",children:U}):null]})]}),t.jsx(N,{title:"Daily breakdown",children:t.jsxs(A,{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx(u,{children:"Day"}),t.jsx(u,{className:"text-right",children:"Total"}),y.map(e=>t.jsx(u,{className:"text-right",children:e},e))]})}),t.jsx("tbody",{children:g.length?g.map(e=>{const s={};for(const n of y)s[n]=0;for(const n of j)n.day===e&&(s[n.provider]=(s[n.provider]??0)+n.tokens);const r=Object.values(s).reduce((n,a)=>n+a,0);return t.jsxs("tr",{children:[t.jsx(c,{className:"font-mono",children:k(e,m)}),t.jsx(c,{className:"text-right font-mono",children:d(r)}),y.map(n=>t.jsx(c,{className:"text-right font-mono",children:d(s[n]??0)},n))]},e)}):t.jsx("tr",{children:t.jsx(c,{colSpan:2+y.length,className:"text-zinc-500",children:"No data."})})})]})}),t.jsxs(N,{title:"Top jobs (last period)",children:[t.jsxs(A,{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx(u,{children:"Job"}),t.jsx(u,{children:"Provider"}),t.jsx(u,{className:"text-right",children:"Tokens"}),t.jsx(u,{className:"text-right",children:"Runs"}),t.jsx(u,{className:"text-right",children:"Errors"}),t.jsx(u,{children:"Last run"})]})}),t.jsx("tbody",{children:F.length?F.slice(0,25).map(e=>t.jsxs("tr",{children:[t.jsx(c,{className:"font-mono",children:e.job_name}),t.jsx(c,{className:"font-mono",children:e.provider??"—"}),t.jsx(c,{className:"text-right font-mono",children:d(e.tokens)}),t.jsx(c,{className:"text-right font-mono",children:d(e.runs)}),t.jsx(c,{className:"text-right font-mono",children:d(e.errors)}),t.jsx(c,{className:"font-mono",children:ae(e.last_started_at)})]},`${e.job_name}|${e.provider??""}`)):t.jsx("tr",{children:t.jsx(c,{colSpan:6,className:"text-zinc-500",children:"No data."})})})]}),t.jsxs("div",{className:"mt-3 text-xs text-zinc-500",children:["Tip: If you want exact attribution, ensure every worker writes ",t.jsx("span",{className:"font-mono",children:"total_tokens"})," into ",t.jsx("span",{className:"font-mono",children:"job_run_log"}),"."]})]})]})}export{ze as default};
