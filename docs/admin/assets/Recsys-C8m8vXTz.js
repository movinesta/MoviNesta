import{r as N,_ as be,j as e,B as O,a0 as Ne,aa as ge,i as U,ab as we,ac as ye,ad as ke,ae as _e,af as ze,ag as Se,ah as Me,ai as Le}from"./index-CRBf6KpQ.js";import{u as K,E}from"./ErrorBox-DVY8vL3c.js";import{C}from"./Card-BKQRm7Rb.js";import{T as J,a as o,b as l}from"./Table-C_8f92Ce.js";import{u as ve}from"./useMutation-DfZD1PiA.js";import{I as Ce}from"./Input-eqrST-0v.js";import{S as F}from"./StatCard-B7MZSLFj.js";import{R as V,X as Y,Y as Q,T as X,L as Z}from"./generateCategoricalChart-BZg-UuSW.js";import{L as ee,a as B}from"./LineChart-BmTb63kD.js";import{C as se}from"./CartesianGrid-CesT3kVW.js";function D(i,a,t){return Number.isFinite(i)?Math.min(t,Math.max(a,i)):a}function T(i,a){const t=Number(i);return Number.isFinite(t)?t:a}function je(i){const a=(i&&typeof i=="object"?i.weights:null)??{},t=(i&&typeof i=="object"?i.source_multipliers:null)??{};return{enabled:!!((i==null?void 0:i.enabled)??!0),skip_when_mix_active:!!((i==null?void 0:i.skip_when_mix_active)??!0),weights:{position:D(T(a.position,1),0,10),popularity:D(T(a.popularity,.25),0,10),vote_avg:D(T(a.vote_avg,.15),0,10),cf_score:D(T(a.cf_score,1),0,10)},source_multipliers:{for_you:D(T(t.for_you,1),0,10),combined:D(T(t.combined,1),0,10),friends:D(T(t.friends,1),0,10),trending:D(T(t.trending,1),0,10),cf:D(T(t.cf,1),0,10),seg_pop:D(T(t.seg_pop,.9),0,10),other:D(T(t.other,1),0,10)}}}function H(i){const{label:a,value:t,onChange:r,min:m=0,max:y=3,step:d=.05,hint:n}=i;return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:a}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Ce,{className:"h-8 w-24",type:"number",min:m,max:y,step:d,value:Number.isFinite(t)?t:0,onChange:g=>r(D(Number(g.target.value),m,y))})})]}),e.jsx("input",{className:"w-full",type:"range",min:m,max:y,step:d,value:Number.isFinite(t)?t:0,onChange:g=>r(D(Number(g.target.value),m,y))}),n?e.jsx("div",{className:"text-xs text-zinc-500",children:n}):null]})}function De(){var q,$;const i=K({queryKey:["app_settings"],queryFn:async()=>Ne(),staleTime:3e4,refetchInterval:6e4}),a=N.useMemo(()=>{var c,_;return((_=(((c=i.data)==null?void 0:c.registry)??{})["ranking.swipe.blend"])==null?void 0:_.default)??null},[(q=i.data)==null?void 0:q.registry]),t=N.useMemo(()=>{var S;const c=(((S=i.data)==null?void 0:S.rows)??[]).find(M=>M.key==="ranking.swipe.blend"),_=(c==null?void 0:c.value)??a;return je(_)},[($=i.data)==null?void 0:$.rows,a]),[r,m]=N.useState(null),[y,d]=N.useState(!1),[n,g]=N.useState(""),[z,f]=N.useState(null),P=()=>{var x,c,_,S,M,W;if(f(null),!n.trim()){f("Paste JSON first.");return}try{const w=JSON.parse(n),p=((c=(x=w==null?void 0:w.ranking)==null?void 0:x.swipe)==null?void 0:c.blend)??(w==null?void 0:w["ranking.swipe.blend"])??(w==null?void 0:w.blend)??w,A={enabled:!!((p==null?void 0:p.enabled)??(r==null?void 0:r.enabled)??!0),skip_when_mix_active:!!((p==null?void 0:p.skip_when_mix_active)??(r==null?void 0:r.skip_when_mix_active)??!0),weights:{position:Number(((_=p==null?void 0:p.weights)==null?void 0:_.position)??(r==null?void 0:r.weights.position)??1),popularity:Number(((S=p==null?void 0:p.weights)==null?void 0:S.popularity)??(r==null?void 0:r.weights.popularity)??.15),vote_avg:Number(((M=p==null?void 0:p.weights)==null?void 0:M.vote_avg)??(r==null?void 0:r.weights.vote_avg)??.2),cf_score:Number(((W=p==null?void 0:p.weights)==null?void 0:W.cf_score)??(r==null?void 0:r.weights.cf_score)??1)},source_multipliers:{...(r==null?void 0:r.source_multipliers)??a.source_multipliers,...(p==null?void 0:p.source_multipliers)??{},...(p==null?void 0:p.suggested_source_multipliers)??{}}};m(je(A)),d(!1),g("")}catch(w){f(w!=null&&w.message?String(w.message):"Invalid JSON.")}};N.useEffect(()=>{!r&&i.data&&m(t)},[i.data]),N.useEffect(()=>{if(!r)return;JSON.stringify(r)===JSON.stringify(t)&&m(t)},[t]);const k=ve({mutationFn:async x=>{var _;const c=(_=i.data)==null?void 0:_.version;return be({expected_version:c,updates:{"ranking.swipe.blend":x.cfg},reason:x.reason})},onSuccess:async()=>{await i.refetch()}}),R=!!r&&!k.isPending;return e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Swipe Blend Calibration"}),e.jsxs("div",{className:"text-xs text-zinc-600",children:["Controls the score-based reorder step (feature weights + per-source multipliers). Stored as ",e.jsx("span",{className:"font-mono",children:"ranking.swipe.blend"})," (server_only)."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>{f(null),d(!0)},disabled:k.isPending||i.isLoading,title:"Paste JSON to update multipliers/weights (e.g., output of suggest_blend_calibration)",children:"Import JSON"}),e.jsx(O,{variant:"secondary",onClick:()=>m(t),disabled:k.isPending||i.isLoading,title:"Reset editor to current saved values",children:"Reset"}),e.jsx(O,{onClick:()=>r&&k.mutate({cfg:r,reason:"Update swipe blend calibration"}),disabled:!R,children:"Save"})]})]}),y?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>d(!1)}),e.jsxs("div",{className:"relative w-full max-w-2xl rounded-2xl border border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Import blend JSON"}),e.jsxs("div",{className:"mt-2 text-sm text-zinc-600",children:["Paste either ",e.jsx("span",{className:"font-mono",children:'{"weights":..., "source_multipliers":...}'})," or the full"," ",e.jsx("span",{className:"font-mono",children:"ranking.swipe.blend"})," object, or the output of"," ",e.jsx("span",{className:"font-mono",children:"suggest_blend_calibration.mjs"}),"."]}),e.jsx("textarea",{className:"mt-4 h-56 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",value:n,onChange:x=>g(x.target.value),placeholder:'{"suggested_source_multipliers": {"cf": 1.1, "trending": 0.95}}'}),z?e.jsx("div",{className:"mt-3 text-sm text-red-700",children:z}):null,e.jsxs("div",{className:"mt-5 flex justify-end gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>d(!1),children:"Cancel"}),e.jsx(O,{onClick:P,children:"Apply"})]})]})]}):null,i.isError?e.jsx("div",{className:"p-4",children:e.jsx(E,{title:"Failed to load app settings",error:i.error})}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-4 p-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-800",children:[e.jsx("input",{type:"checkbox",checked:!!((r==null?void 0:r.enabled)??!0),onChange:x=>m(c=>c&&{...c,enabled:x.target.checked})}),"Enabled"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-800",children:[e.jsx("input",{type:"checkbox",checked:!!((r==null?void 0:r.skip_when_mix_active)??!0),onChange:x=>m(c=>c&&{...c,skip_when_mix_active:x.target.checked})}),"Skip when mix active"]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Feature weights"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(H,{label:"Position",value:(r==null?void 0:r.weights.position)??1,min:0,max:3,step:.05,onChange:x=>m(c=>c&&{...c,weights:{...c.weights,position:x}}),hint:"Higher = prefer earlier candidates (stability)."}),e.jsx(H,{label:"Popularity",value:(r==null?void 0:r.weights.popularity)??.25,min:0,max:2,step:.05,onChange:x=>m(c=>c&&{...c,weights:{...c.weights,popularity:x}}),hint:"Higher = more blockbuster bias."}),e.jsx(H,{label:"Vote avg",value:(r==null?void 0:r.weights.vote_avg)??.15,min:0,max:2,step:.05,onChange:x=>m(c=>c&&{...c,weights:{...c.weights,vote_avg:x}}),hint:"Higher = prefer higher-rated items."}),e.jsx(H,{label:"CF score",value:(r==null?void 0:r.weights.cf_score)??1,min:0,max:3,step:.05,onChange:x=>m(c=>c&&{...c,weights:{...c.weights,cf_score:x}}),hint:"Higher = more personalized (ALS) influence."})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Source multipliers"}),e.jsx("div",{className:"grid grid-cols-1 gap-3 sm:grid-cols-2",children:[["for_you","For You"],["combined","Combined"],["friends","Friends"],["trending","Trending"],["cf","CF"],["seg_pop","Seg-pop"],["other","Other"]].map(([x,c])=>{var _;return e.jsx(H,{label:c,value:((_=r==null?void 0:r.source_multipliers)==null?void 0:_[x])??1,min:0,max:2,step:.05,onChange:S=>m(M=>M&&{...M,source_multipliers:{...M.source_multipliers,[x]:S}}),hint:""},x)})}),e.jsxs("div",{className:"mt-3 text-xs text-zinc-600",children:["Tip: generate suggested multipliers from logs using ",e.jsx("span",{className:"font-mono",children:"scripts/recsys/suggest_blend_calibration.mjs"}),"."]}),k.isError?e.jsx("div",{className:"mt-3",children:e.jsx(E,{title:"Save failed",error:k.error})}):null,k.isSuccess?e.jsx("div",{className:"mt-3 text-xs text-emerald-700",children:"Saved."}):null]})]})]})}function Fe(i){return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("label",{className:"text-sm font-medium text-zinc-900",children:i.label}),e.jsx("span",{className:"text-sm tabular-nums text-zinc-600",children:i.value})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("input",{type:"range",className:"flex-1 accent-zinc-900",min:i.min,max:i.max,step:i.step,value:i.value,onChange:a=>i.onChange(Number(a.target.value))})}),i.hint?e.jsx("div",{className:"mt-1.5 text-xs text-zinc-500",children:i.hint}):null]})}function j(i,a,t){return Number.isFinite(i)?Math.min(t,Math.max(a,i)):a}function b(i,a){const t=typeof i=="number"?i:Number(i);return Number.isFinite(t)?t:a}function Re(i){return e.jsx("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:i.label}),i.hint?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:i.hint}):null]}),e.jsx("div",{className:"min-w-[180px]",children:i.children})]})})}function Te(){const i=K({queryKey:["appSettings"],queryFn:Ne,staleTime:1e4}),a=N.useMemo(()=>{var P,k;const d=((P=i.data)==null?void 0:P.rows)??[],n=((k=i.data)==null?void 0:k.registry)??{},g=R=>{var $;const q=d.find(x=>x.key===R);return q&&q.value!==void 0?q.value:($=n==null?void 0:n[R])==null?void 0:$.default},z=g("ops.rate_limits")??{},f=(z==null?void 0:z.actions)??{};return{watchedSyntheticDwellMs:j(b(g("ranking.swipe.status_watched.synthetic_dwell_ms"),12e3),0,6e5),centroidRefreshSampleRate:j(b(g("ranking.swipe.centroids.refresh_sample_rate"),.25),0,1),centroidK:j(Math.round(b(g("ranking.swipe.centroids.k"),3)),1,10),centroidMaxItems:j(Math.round(b(g("ranking.swipe.centroids.max_items"),60)),10,200),rateSwipeDeck:j(Math.round(b(f==null?void 0:f.swipe_deck,120)),1,6e3),rateSwipeEvent:j(Math.round(b(f==null?void 0:f.swipe_event,1e3)),1,6e3),coldStartLookback:j(b(g("ranking.swipe.cold_start.lookback_days"),30),1,365),coldStartMin:j(b(g("ranking.swipe.cold_start.min_strong_positive"),3),1,100),coldStartLimit:j(b(g("ranking.swipe.cold_start.event_limit"),120),10,1e3),deckLimit:j(b(g("ranking.swipe.deck.default_limit"),60),10,200),deckMax:j(b(g("ranking.swipe.deck.max_limit"),120),10,200),rerankTtl:j(b(g("ops.rerank.cache_ttl_seconds"),600),0,86400),rerankWindow:j(b(g("ops.rerank.fresh_window_seconds"),21600),60,604800),_rateLimitsRaw:z,_rateActions:f}},[i.data]),[t,r]=N.useState(null);N.useEffect(()=>{i.data&&r({watchedSyntheticDwellMs:a.watchedSyntheticDwellMs,centroidRefreshSampleRate:a.centroidRefreshSampleRate,centroidK:a.centroidK,centroidMaxItems:a.centroidMaxItems,rateSwipeDeck:a.rateSwipeDeck,rateSwipeEvent:a.rateSwipeEvent,coldStartLookback:a.coldStartLookback,coldStartMin:a.coldStartMin,coldStartLimit:a.coldStartLimit,deckLimit:a.deckLimit,deckMax:a.deckMax,rerankTtl:a.rerankTtl,rerankWindow:a.rerankWindow})},[i.data,a]);const m=ve({mutationFn:async()=>{var g;if(!t)throw new Error("No draft");const d={...a._rateActions,swipe_deck:j(Math.round(t.rateSwipeDeck),1,6e3),swipe_event:j(Math.round(t.rateSwipeEvent),1,6e3)},n={...a._rateLimitsRaw,actions:d};return be({expected_version:(g=i.data)==null?void 0:g.version,reason:"Recsys knobs update",updates:{"ranking.swipe.status_watched.synthetic_dwell_ms":j(Math.round(t.watchedSyntheticDwellMs),0,6e5),"ranking.swipe.centroids.refresh_sample_rate":j(t.centroidRefreshSampleRate,0,1),"ranking.swipe.centroids.k":j(Math.round(t.centroidK),1,10),"ranking.swipe.centroids.max_items":j(Math.round(t.centroidMaxItems),10,200),"ops.rate_limits":n,"ranking.swipe.cold_start.lookback_days":j(Math.round(t.coldStartLookback),1,365),"ranking.swipe.cold_start.min_strong_positive":j(Math.round(t.coldStartMin),1,100),"ranking.swipe.cold_start.event_limit":j(Math.round(t.coldStartLimit),10,1e3),"ranking.swipe.deck.default_limit":j(Math.round(t.deckLimit),10,200),"ranking.swipe.deck.max_limit":j(Math.round(t.deckMax),10,200),"ops.rerank.cache_ttl_seconds":j(Math.round(t.rerankTtl),0,86400),"ops.rerank.fresh_window_seconds":j(Math.round(t.rerankWindow),60,604800)}})},onSuccess:()=>i.refetch()}),y=!!t&&(t.watchedSyntheticDwellMs!==a.watchedSyntheticDwellMs||Math.abs(t.centroidRefreshSampleRate-a.centroidRefreshSampleRate)>1e-9||t.centroidK!==a.centroidK||t.centroidMaxItems!==a.centroidMaxItems||t.rateSwipeDeck!==a.rateSwipeDeck||t.rateSwipeEvent!==a.rateSwipeEvent||t.coldStartLookback!==a.coldStartLookback||t.coldStartMin!==a.coldStartMin||t.coldStartLimit!==a.coldStartLimit||t.deckLimit!==a.deckLimit||t.deckMax!==a.deckMax||t.rerankTtl!==a.rerankTtl||t.rerankWindow!==a.rerankWindow);return e.jsxs(C,{title:"Core knobs",subtitle:"The key recsys knobs that previously were hard-coded. Saved into app_settings (server_only).",right:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"secondary",onClick:()=>r({watchedSyntheticDwellMs:a.watchedSyntheticDwellMs,centroidRefreshSampleRate:a.centroidRefreshSampleRate,centroidK:a.centroidK,centroidMaxItems:a.centroidMaxItems,rateSwipeDeck:a.rateSwipeDeck,rateSwipeEvent:a.rateSwipeEvent,coldStartLookback:a.coldStartLookback,coldStartMin:a.coldStartMin,coldStartLimit:a.coldStartLimit,deckLimit:a.deckLimit,deckMax:a.deckMax,rerankTtl:a.rerankTtl,rerankWindow:a.rerankWindow}),disabled:!y||m.isPending,children:"Reset"}),e.jsx(O,{onClick:()=>m.mutate(),disabled:!y||m.isPending,children:m.isPending?"Savingâ€¦":"Save"})]}),children:[i.isError?e.jsx("div",{className:"p-4",children:e.jsx(E,{title:"Failed to load app settings",error:i.error})}):null,m.isError?e.jsx("div",{className:"p-4",children:e.jsx(E,{title:"Save failed",error:m.error})}):null,m.isSuccess?e.jsx("div",{className:"px-4 pt-4 text-xs text-emerald-700",children:"Saved."}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-4 p-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(Re,{label:"Watched â†’ synthetic dwell (ms)",hint:"When the app marks an item as watched, we emit a synthetic dwell event to train taste feedback. Keep this moderate to avoid over-confident positives.",children:e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:0,max:6e5,step:1e3,value:(t==null?void 0:t.watchedSyntheticDwellMs)??a.watchedSyntheticDwellMs,onChange:d=>r(n=>n&&{...n,watchedSyntheticDwellMs:b(d.target.value,n.watchedSyntheticDwellMs)})})}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Centroids refresh"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Fe,{label:"Refresh sample rate",value:(t==null?void 0:t.centroidRefreshSampleRate)??a.centroidRefreshSampleRate,min:0,max:1,step:.01,onChange:d=>r(n=>n&&{...n,centroidRefreshSampleRate:d}),hint:"Higher = faster adaptation, more DB work."}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"k (centroids)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:10,step:1,value:(t==null?void 0:t.centroidK)??a.centroidK,onChange:d=>r(n=>n&&{...n,centroidK:b(d.target.value,n.centroidK)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"max items"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,step:5,value:(t==null?void 0:t.centroidMaxItems)??a.centroidMaxItems,onChange:d=>r(n=>n&&{...n,centroidMaxItems:b(d.target.value,n.centroidMaxItems)})})]})]}),e.jsxs("div",{className:"text-xs text-zinc-600",children:["These parameters are passed to ",e.jsx("span",{className:"font-mono",children:"media_refresh_user_centroids_v1"}),"."]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Cold Start"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Lookback (days)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:365,value:(t==null?void 0:t.coldStartLookback)??a.coldStartLookback,onChange:d=>r(n=>n&&{...n,coldStartLookback:b(d.target.value,n.coldStartLookback)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Min strong signals"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:1,max:100,value:(t==null?void 0:t.coldStartMin)??a.coldStartMin,onChange:d=>r(n=>n&&{...n,coldStartMin:b(d.target.value,n.coldStartMin)})})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Event limit"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:1e3,value:(t==null?void 0:t.coldStartLimit)??a.coldStartLimit,onChange:d=>r(n=>n&&{...n,coldStartLimit:b(d.target.value,n.coldStartLimit)})}),e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:"Max recent events to weigh"})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"mb-3 text-sm font-semibold text-zinc-900",children:"Deck & Rerank"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Deck Limit"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,value:(t==null?void 0:t.deckLimit)??a.deckLimit,onChange:d=>r(n=>n&&{...n,deckLimit:b(d.target.value,n.deckLimit)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Deck Max"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:10,max:200,value:(t==null?void 0:t.deckMax)??a.deckMax,onChange:d=>r(n=>n&&{...n,deckMax:b(d.target.value,n.deckMax)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Rerank TTL (s)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:0,max:86400,value:(t==null?void 0:t.rerankTtl)??a.rerankTtl,onChange:d=>r(n=>n&&{...n,rerankTtl:b(d.target.value,n.rerankTtl)})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Fresh Window (s)"}),e.jsx("input",{className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 outline-none focus:ring-2 focus:ring-zinc-300",type:"number",min:60,max:604800,value:(t==null?void 0:t.rerankWindow)??a.rerankWindow,onChange:d=>r(n=>n&&{...n,rerankWindow:b(d.target.value,n.rerankWindow)})})]})]})]})]})]})]})}function I(i){return i==null||!Number.isFinite(i)?"â€”":`${(i*100).toFixed(1)}%`}function h(i){const a=Number(i);return Number.isFinite(a)?String(Math.trunc(a)):"0"}function Ge(){var te,ie,ae,ne,re,le,ce,oe,de,xe,me,he,ue,pe;const[i,a]=N.useState(30),[t,r]=N.useState("quality"),m=K({queryKey:N.useMemo(()=>["rec_variant_metrics",i],[i]),queryFn:async()=>ye({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="quality"}),y=K({queryKey:N.useMemo(()=>["rec_composition_metrics",i],[i]),queryFn:async()=>ke({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="composition"}),d=K({queryKey:N.useMemo(()=>["rec_genre_metrics",i],[i]),queryFn:async()=>_e({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="genres"}),n=K({queryKey:N.useMemo(()=>["rec_health_metrics",i],[i]),queryFn:async()=>ze({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),g=K({queryKey:N.useMemo(()=>["rec_diagnostics"],[]),queryFn:async()=>Se(),staleTime:3e4,refetchInterval:6e4,enabled:t==="health"}),z=K({queryKey:N.useMemo(()=>["rec_position_metrics",i],[i]),queryFn:async()=>Me({days:i,max_position:30}),staleTime:3e4,refetchInterval:6e4,enabled:t==="positions"}),f=K({queryKey:N.useMemo(()=>["rec_alerts_metrics",i],[i]),queryFn:async()=>Le({days:i}),staleTime:3e4,refetchInterval:6e4,enabled:t==="alerts"}),P=((te=m.data)==null?void 0:te.rows)??[],k=((ie=y.data)==null?void 0:ie.rows)??[],R=((ae=d.data)==null?void 0:ae.rows)??[],q=((ne=n.data)==null?void 0:ne.rows)??[],$=((re=z.data)==null?void 0:re.rows)??[],x=((le=g.data)==null?void 0:le.row)??null,c=q[0],_=N.useMemo(()=>{const s=new Map;for(const u of $){const L=Number(u.position),G=s.get(L)??{position:L,impressions:0,likes:0,dislikes:0,watchlist_adds:0,detail_opens:0};G.impressions+=Number(u.impressions??0),G.likes+=Number(u.likes??0),G.dislikes+=Number(u.dislikes??0),G.watchlist_adds+=Number(u.watchlist_adds??0),G.detail_opens+=Number(u.detail_opens??0),s.set(L,G)}return Array.from(s.values()).sort((u,L)=>u.position-L.position).map(u=>({...u,like_rate:u.impressions?u.likes/u.impressions:0,dislike_rate:u.impressions?u.dislikes/u.impressions:0,watchlist_rate:u.impressions?u.watchlist_adds/u.impressions:0,detail_open_rate:u.impressions?u.detail_opens/u.impressions:0}))},[$]),S=k.length?k[0].day:null,M=N.useMemo(()=>k.filter(s=>S?s.day===S:!1),[k,S]),W=R.length?R[0].day:null,w=N.useMemo(()=>R.filter(s=>W?s.day===W:!1),[R,W]),p=s=>s.reduce((v,u)=>v+u,0),A=p(M.map(s=>Number(s.impressions)||0)),fe=p(w.map(s=>Number(s.muted_impressions)||0));return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Recsys Control Center"}),e.jsx("div",{className:"text-sm text-zinc-600",children:"Observe â†’ diagnose â†’ tune â†’ roll out (metrics, composition, drift, and controls)."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(ge,{to:"/recsys/experiments",className:"rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm hover:bg-zinc-50",children:"Experiments"}),e.jsx(ge,{to:"/recsys/assignments",className:"rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm hover:bg-zinc-50",children:"Assignments"}),e.jsx("label",{className:"text-xs font-medium text-zinc-700",children:"Window"}),e.jsxs("select",{className:U("h-9 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-900 shadow-sm","focus:outline-none focus:ring-2 focus:ring-zinc-300"),value:i,onChange:s=>a(Number(s.target.value)),children:[e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:14,children:"Last 14 days"}),e.jsx("option",{value:30,children:"Last 30 days"}),e.jsx("option",{value:60,children:"Last 60 days"}),e.jsx("option",{value:90,children:"Last 90 days"})]})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[{key:"health",label:"Live health"},{key:"quality",label:"Quality (A/B)"},{key:"composition",label:"Composition"},{key:"genres",label:"Genres & drift"},{key:"positions",label:"Position funnel"},{key:"alerts",label:"Alerts & guardrails"},{key:"controls",label:"Controls"}].map(s=>e.jsx("button",{onClick:()=>r(s.key),className:U("h-9 rounded-xl border px-3 text-sm shadow-sm",t===s.key?"border-zinc-900 bg-zinc-900 text-white":"border-zinc-200 bg-white text-zinc-900 hover:bg-zinc-50"),children:s.label},s.key))}),t==="health"?e.jsxs(e.Fragment,{children:[n.isError?e.jsx(E,{title:"Failed to load health",error:n.error}):null,g.isError?e.jsx(E,{title:"Failed to load diagnostics",error:g.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(F,{title:"Decks (latest day)",value:c?h(c.decks):"â€”",subtitle:c?`Day: ${c.day}`:void 0}),e.jsx(F,{title:"Impressions",value:c?h(c.impressions):"â€”",subtitle:"rec_impressions rows"}),e.jsx(F,{title:"Users",value:c?h(c.users):"â€”",subtitle:"unique users"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Experiment tagging health (last 7 days)"}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Tracks impressions missing experiment tags and outcomes without impressions."})]}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Window start: ",x!=null&&x.window_start?we(x.window_start):"â€”"]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(F,{title:"Impressions (7d)",value:x?h(x.total_impressions):"â€”",subtitle:"Total impressions"}),e.jsx(F,{title:"Missing experiments",value:x?h(x.missing_experiments):"â€”",subtitle:x?`${I(x.missing_ratio)} of impressions`:void 0}),e.jsx(F,{title:"Outcomes without impression",value:x?h(x.outcomes_without_impression):"â€”",subtitle:"Join gaps (7d)"})]})]}),e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily volume + feature flags"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(ce=n.data)!=null&&ce.since?`Since ${n.data.since}`:n.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(J,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(o,{children:"Day"}),e.jsx(o,{className:"text-right",children:"Decks"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Users"}),e.jsx(o,{className:"text-right",children:"CF impr"}),e.jsx(o,{className:"text-right",children:"Mix impr"}),e.jsx(o,{className:"text-right",children:"Blend impr"}),e.jsx(o,{className:"text-right",children:"Diversity impr"})]})}),e.jsx("tbody",{children:q.length?q.map((s,v)=>e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.cf_impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions_in_mix_decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions_in_blend_decks)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions_in_diversity_decks)})]},`${s.day}:${v}`)):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:n.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="quality"?e.jsxs(e.Fragment,{children:[m.isError?e.jsx(E,{title:"Failed to load metrics",error:m.error}):null,e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily experiment metrics"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(oe=m.data)!=null&&oe.since?`Since ${m.data.since}`:m.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(J,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(o,{children:"Day"}),e.jsx(o,{children:"Experiment"}),e.jsx(o,{children:"Variant"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Users"}),e.jsx(o,{className:"text-right",children:"Detail"}),e.jsx(o,{className:"text-right",children:"Likes"}),e.jsx(o,{className:"text-right",children:"Watchlist"}),e.jsx(o,{className:"text-right",children:"Like rate"}),e.jsx(o,{className:"text-right",children:"WL rate"})]})}),e.jsx("tbody",{children:P.length?P.map((s,v)=>e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs",children:s.experiment_key}),e.jsx(l,{className:"text-xs font-medium",children:s.variant}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.detail_opens)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.likes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.watchlist_adds)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.like_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.watchlist_add_rate)})]},`${s.day}:${s.experiment_key}:${s.variant}:${v}`)):e.jsx("tr",{children:e.jsx(l,{colSpan:10,className:"py-8 text-center text-sm text-zinc-600",children:m.isLoading?"Loadingâ€¦":"No data yet. Once users swipe, metrics will appear here."})})})]})})]})]}):null,t==="composition"?e.jsxs(e.Fragment,{children:[y.isError?e.jsx(E,{title:"Failed to load composition",error:y.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(F,{title:"Latest day",value:S??"â€”",subtitle:"Composition snapshot"}),e.jsx(F,{title:"Total impressions",value:A?h(A):"â€”",subtitle:"Across all sources"}),e.jsx(F,{title:"Top source share",value:A&&M.length?(()=>{const s=[...M].sort((u,L)=>(L.impressions??0)-(u.impressions??0))[0],v=(Number(s==null?void 0:s.impressions)||0)/A;return`${(s==null?void 0:s.source)??"â€”"} Â· ${(v*100).toFixed(0)}%`})():"â€”",subtitle:"Source dominance (watch for drift)"})]}),e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily source metrics"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(de=y.data)!=null&&de.since?`Since ${y.data.since}`:y.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(J,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(o,{children:"Day"}),e.jsx(o,{children:"Mode"}),e.jsx(o,{children:"Source"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Users"}),e.jsx(o,{className:"text-right",children:"Like rate"}),e.jsx(o,{className:"text-right",children:"WL rate"}),e.jsx(o,{className:"text-right",children:"Share"})]})}),e.jsx("tbody",{children:k.length?k.map((s,v)=>{const L=(S?s.day===S:!1)&&A?(Number(s.impressions)||0)/A:null;return e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs",children:s.mode}),e.jsx(l,{className:"text-xs font-medium",children:s.source}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.like_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.watchlist_add_rate)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:L==null?"â€”":`${(L*100).toFixed(0)}%`})]},`${s.day}:${s.mode}:${s.source}:${v}`)}):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:y.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="genres"?e.jsxs(e.Fragment,{children:[d.isError?e.jsx(E,{title:"Failed to load genre metrics",error:d.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsx(F,{title:"Latest day",value:W??"â€”",subtitle:"Genre exposure snapshot"}),e.jsx(F,{title:"Muted leakage (latest)",value:W?h(fe):"â€”",subtitle:"Should trend to 0"}),e.jsx(F,{title:"Drift signal",value:w.length?(()=>{const s=[...w].map(v=>({slug:v.genre_slug,d:Math.abs((v.share_day??0)-(v.share_catalog??0))})).sort((v,u)=>u.d-v.d)[0];return s?`${s.slug} Â· ${(s.d*100).toFixed(1)}pp`:"â€”"})():"â€”",subtitle:"Largest |share_day - share_catalog|"})]}),e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Daily genre exposure"}),e.jsx("div",{className:"text-xs text-zinc-600",children:(xe=d.data)!=null&&xe.since?`Since ${d.data.since}`:d.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(J,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(o,{children:"Day"}),e.jsx(o,{children:"Genre"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Users"}),e.jsx(o,{className:"text-right",children:"Share (day)"}),e.jsx(o,{className:"text-right",children:"Share (catalog)"}),e.jsx(o,{className:"text-right",children:"Î”"}),e.jsx(o,{className:"text-right",children:"Muted leak"})]})}),e.jsx("tbody",{children:R.length?R.map((s,v)=>{const u=(s.share_day??0)-(s.share_catalog??0),L=Number(s.muted_impressions)||0;return e.jsxs("tr",{children:[e.jsx(l,{className:"text-xs text-zinc-700",children:s.day}),e.jsx(l,{className:"text-xs font-medium",children:s.genre_slug}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.users)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.share_day)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.share_catalog)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:`${(u*100).toFixed(1)}pp`}),e.jsx(l,{className:U("text-right text-xs tabular-nums",L>0?"font-semibold text-red-600":"text-zinc-700"),children:h(L)})]},`${s.day}:${s.genre_slug}:${v}`)}):e.jsx("tr",{children:e.jsx(l,{colSpan:8,className:"py-8 text-center text-sm text-zinc-600",children:d.isLoading?"Loadingâ€¦":"No data yet."})})})]})})]})]}):null,t==="positions"?e.jsxs(e.Fragment,{children:[z.isError?e.jsx(E,{title:"Failed to load position metrics",error:z.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs(C,{className:"p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Like rate by position"}),e.jsx("div",{className:"h-64",children:e.jsx(V,{width:"100%",height:"100%",children:e.jsxs(ee,{data:_,margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(se,{strokeDasharray:"3 3"}),e.jsx(Y,{dataKey:"position",tick:{fontSize:12}}),e.jsx(Q,{tick:{fontSize:12},domain:[0,1]}),e.jsx(X,{formatter:s=>`${(Number(s)*100).toFixed(1)}%`}),e.jsx(Z,{}),e.jsx(B,{type:"monotone",dataKey:"like_rate",name:"Like rate",dot:!1}),e.jsx(B,{type:"monotone",dataKey:"dislike_rate",name:"Dislike rate",dot:!1})]})})})]}),e.jsxs(C,{className:"p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Engagement by position"}),e.jsx("div",{className:"h-64",children:e.jsx(V,{width:"100%",height:"100%",children:e.jsxs(ee,{data:_,margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(se,{strokeDasharray:"3 3"}),e.jsx(Y,{dataKey:"position",tick:{fontSize:12}}),e.jsx(Q,{tick:{fontSize:12},domain:[0,1]}),e.jsx(X,{formatter:s=>`${(Number(s)*100).toFixed(1)}%`}),e.jsx(Z,{}),e.jsx(B,{type:"monotone",dataKey:"detail_open_rate",name:"Detail open rate",dot:!1}),e.jsx(B,{type:"monotone",dataKey:"watchlist_rate",name:"Watchlist add rate",dot:!1})]})})})]})]}),e.jsxs(C,{className:"p-0",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-zinc-200 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Aggregated counts by position (window)"}),e.jsx("div",{className:"text-xs text-zinc-600",children:z.data?`Since ${z.data.since}`:z.isLoading?"Loadingâ€¦":"â€”"})]}),e.jsx(J,{children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 text-xs uppercase tracking-wide text-zinc-600",children:[e.jsx(o,{children:"Pos"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Likes"}),e.jsx(o,{className:"text-right",children:"Dislikes"}),e.jsx(o,{className:"text-right",children:"Detail opens"}),e.jsx(o,{className:"text-right",children:"Watchlist"}),e.jsx(o,{className:"text-right",children:"Like rate"})]})}),e.jsx("tbody",{children:_.map(s=>e.jsxs("tr",{className:"border-b border-zinc-100 text-sm",children:[e.jsx(l,{children:s.position}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.impressions)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.likes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.dislikes)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.detail_opens)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:h(s.watchlist_adds)}),e.jsx(l,{className:"text-right text-xs tabular-nums",children:I(s.like_rate)})]},s.position))})]})})]})]}):t==="alerts"?e.jsxs(e.Fragment,{children:[f.isError?e.jsx(E,{title:"Failed to load alerts",error:f.error}):null,e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-3",children:[e.jsxs(C,{className:"p-4 md:col-span-2",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Guardrail rates over time"}),e.jsx("div",{className:"h-72",children:e.jsx(V,{width:"100%",height:"100%",children:e.jsxs(ee,{data:((me=f.data)==null?void 0:me.daily)??[],margin:{top:10,right:20,bottom:10,left:0},children:[e.jsx(se,{strokeDasharray:"3 3"}),e.jsx(Y,{dataKey:"day",tick:{fontSize:12}}),e.jsx(Q,{tick:{fontSize:12}}),e.jsx(X,{}),e.jsx(Z,{}),e.jsx(B,{type:"monotone",dataKey:"like_rate",name:"Like rate",dot:!1}),e.jsx(B,{type:"monotone",dataKey:"watchlist_rate",name:"Watchlist add rate",dot:!1}),e.jsx(B,{type:"monotone",dataKey:"cf_share",name:"CF share",dot:!1})]})})}),e.jsx("div",{className:"mt-2 text-xs text-zinc-600",children:"Guardrails compare today vs trailing 7-day average and require enough volume (â‰¥200 impressions/day)."})]}),e.jsxs(C,{className:"p-4",children:[e.jsxs("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:["Active alerts (last ",i,"d)"]}),e.jsxs("div",{className:"space-y-2",children:[(((he=f.data)==null?void 0:he.alerts)??[]).slice(0,10).map((s,v)=>e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-900",children:s.alert_key}),e.jsx("div",{className:U("rounded-full px-2 py-0.5 text-xs font-semibold",s.severity==="high"?"bg-red-100 text-red-800":s.severity==="medium"?"bg-amber-100 text-amber-900":"bg-zinc-100 text-zinc-800"),children:s.severity})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-700",children:[s.day,": ",s.message]})]},v)),(((ue=f.data)==null?void 0:ue.alerts)??[]).length===0?e.jsx("div",{className:"rounded-xl border p-3 text-xs text-zinc-700",children:"No active alerts ðŸŽ‰"}):null]})]})]}),e.jsxs(C,{className:"mt-3 p-4",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-zinc-900",children:"Daily guardrail table"}),e.jsx(J,{children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(o,{children:"Day"}),e.jsx(o,{className:"text-right",children:"Impr"}),e.jsx(o,{className:"text-right",children:"Like%"}),e.jsx(o,{className:"text-right",children:"WL%"}),e.jsx(o,{className:"text-right",children:"CF%"}),e.jsx(o,{className:"text-right",children:"Muted"}),e.jsx(o,{children:"Flags"})]})}),e.jsx("tbody",{children:(((pe=f.data)==null?void 0:pe.daily)??[]).slice().reverse().map((s,v)=>e.jsxs("tr",{className:"border-t",children:[e.jsx(l,{children:s.day}),e.jsx(l,{className:"text-right",children:h(s.impressions)}),e.jsx(l,{className:"text-right",children:I(s.like_rate)}),e.jsx(l,{className:"text-right",children:I(s.watchlist_rate)}),e.jsx(l,{className:"text-right",children:I(s.cf_share)}),e.jsx(l,{className:"text-right",children:h(s.muted_impressions)}),e.jsx(l,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.alert_muted_leakage?e.jsx("span",{className:"rounded-full bg-red-100 px-2 py-0.5 text-xs font-semibold text-red-800",children:"Muted leakage"}):null,s.alert_like_rate_drop?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-900",children:"Like drop"}):null,s.alert_watchlist_rate_drop?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-900",children:"WL drop"}):null,s.alert_cf_starvation?e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-0.5 text-xs font-semibold text-zinc-800",children:"CF=0"}):null]})})]},v))})]})})]})]}):t==="controls"?e.jsxs(e.Fragment,{children:[e.jsx(De,{}),e.jsx("div",{className:"mt-4",children:e.jsx(Te,{})})]}):null]})}export{Ge as default};
