import{W as S,r as v,j as e,L as b,ad as k,a as l,B as T,i as q,ar as A,af as F,as as R}from"./index-CoY44SlW.js";import{u as h,E as p}from"./ErrorBox-CvgwTo6Q.js";import{C as z}from"./Card-DzyM45zw.js";import{T as K,a as w,b as j}from"./Table-BpO-pS4x.js";import{E}from"./EmptyState-DaHQMra1.js";import{R as $,X as B,Y as D,T as M,L as W}from"./generateCategoricalChart-FnZw2e2y.js";import{L as I,a as V}from"./LineChart-C8RWP0LD.js";import{C as P}from"./CartesianGrid-Ekvmrd1n.js";function C(r){return e.jsx("div",{className:"text-xl font-semibold tracking-tight",children:r.children})}function U(r){return r==null||!Number.isFinite(r)?"—":`${(r*100).toFixed(2)}%`}function te(){var y,g,N;const{key:r}=S(),x=decodeURIComponent(r??""),[n,_]=v.useState(30),c=h({queryKey:["recsys_experiments"],queryFn:()=>A()}),d=h({queryKey:["rec_variant_metrics",n],queryFn:async()=>F({days:n}),staleTime:3e4}),o=h({queryKey:["recsys_experiment_assignment_counts"],queryFn:()=>R(),staleTime:3e4,refetchInterval:6e4});if(c.isLoading||d.isLoading||o.isLoading)return e.jsx(b,{});if(c.error)return e.jsx(p,{error:c.error});if(d.error)return e.jsx(p,{error:d.error});if(o.error)return e.jsx(p,{error:o.error});const t=(((y=c.data)==null?void 0:y.rows)??[]).find(s=>s.key===x),m=(((g=d.data)==null?void 0:g.rows)??[]).filter(s=>s.experiment_key===x),u=(((N=o.data)==null?void 0:N.rows)??[]).filter(s=>s.experiment_key===x),L=v.useMemo(()=>{const s=new Map;for(const a of m){const i=a.day;s.has(i)||s.set(i,{day:i}),s.get(i)[a.variant]=a.like_rate??0}return Array.from(s.values()).sort((a,i)=>String(a.day).localeCompare(String(i.day)))},[m]);if(!t)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{children:"Experiment not found"}),e.jsx(k,{className:"text-sm text-zinc-600 hover:text-zinc-900",to:"/recsys/experiments",children:"← Back to Experiments"}),e.jsx(E,{title:"Missing experiment",message:"We could not locate this experiment key."})]});const f=Array.isArray(t.variants)?t.variants:[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(C,{children:t.key}),e.jsx("div",{className:"text-sm text-zinc-600",children:t.description??"No description."})]}),e.jsx(k,{className:"text-sm text-zinc-600 hover:text-zinc-900",to:"/recsys/experiments",children:"← Back to Experiments"})]}),e.jsx(z,{title:"Experiment details",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2 text-sm text-zinc-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Status:"})," ",t.status]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Started:"})," ",l(t.started_at)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Ended:"})," ",l(t.ended_at)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Updated:"})," ",l(t.updated_at)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Salt:"})," ",e.jsx("span",{className:"font-mono text-xs",children:t.salt??"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-zinc-900",children:"Assignments:"})," ",u.length?u.map(s=>`${s.variant}: ${s.assignments}`).join(" · "):"—"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:"Variants"}),e.jsxs(K,{className:"mt-2",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(w,{children:"Name"}),e.jsx(w,{className:"text-right",children:"Weight"})]})}),e.jsx("tbody",{children:f.length?f.map((s,a)=>e.jsxs("tr",{children:[e.jsx(j,{children:(s==null?void 0:s.name)??"—"}),e.jsx(j,{className:"text-right",children:Number((s==null?void 0:s.weight)??0).toFixed(2)})]},`${(s==null?void 0:s.name)??"variant"}-${a}`)):e.jsx("tr",{children:e.jsx(j,{colSpan:2,className:"text-center text-sm text-zinc-500",children:"No variants recorded."})})})]})]})]})}),e.jsxs(z,{title:"Variant performance (like rate)",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-500",children:["Showing last ",n," days."]}),e.jsx("div",{className:"flex items-center gap-2",children:[7,14,30,60].map(s=>e.jsxs(T,{variant:"ghost",className:q(n===s&&"bg-zinc-200"),onClick:()=>_(s),children:[s,"d"]},s))})]}),m.length?e.jsx("div",{className:"mt-4 h-72 w-full",children:e.jsx($,{width:"100%",height:"100%",children:e.jsxs(I,{data:L,children:[e.jsx(P,{strokeDasharray:"3 3"}),e.jsx(B,{dataKey:"day"}),e.jsx(D,{tickFormatter:s=>`${(s*100).toFixed(0)}%`}),e.jsx(M,{formatter:s=>U(s)}),e.jsx(W,{}),Array.from(new Set(m.map(s=>s.variant))).map(s=>e.jsx(V,{type:"monotone",dataKey:s,strokeWidth:2,dot:!1},s))]})})}):e.jsx(E,{title:"No metrics yet",message:"Impressions with experiment tags will appear here."})]})]})}export{te as default};
