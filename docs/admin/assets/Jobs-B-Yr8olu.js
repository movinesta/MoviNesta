import{u as z,r as j,j as e,L as A,B as u,a as R,e as k,h as T,i as B,k as D,l as J,m as I}from"./index-CGWJK-B7.js";import{u as M,E as h}from"./ErrorBox-DGVAxfkB.js";import{u as p}from"./useMutation-CEd-E173.js";import{C as q}from"./Card-BfoASP6-.js";import{T as E,a,b as r}from"./Table-DrAL3XMq.js";import{I as S}from"./Input-5czXp4bm.js";import{E as Q}from"./EmptyState-D234wNkF.js";import{C as v}from"./CopyButton-DYYxrqKe.js";function U(t){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:t.children})}const g={cursorSearch:"",cronSearch:""};function Z(){const t=z(),[o,w]=j.useState(g.cursorSearch),[l,C]=j.useState(g.cronSearch),[N,K]=j.useState({}),b=M({queryKey:["jobs"],queryFn:()=>I()}),c=p({mutationFn:s=>T(s,null),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),d=p({mutationFn:s=>B(s.jobname,s.active),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),x=p({mutationFn:s=>D(s.jobname,s.schedule),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),m=p({mutationFn:s=>J(s),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["logs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),P=c.isPending||d.isPending||x.isPending||m.isPending;if(b.isLoading)return e.jsx(A,{});if(b.error)return e.jsx(h,{error:b.error});const n=b.data,f=j.useMemo(()=>{const s=o.trim().toLowerCase();return s?n.job_state.filter(i=>i.job_name.toLowerCase().includes(s)||(i.cursor??"").toLowerCase().includes(s)):n.job_state},[n.job_state,o]),y=j.useMemo(()=>{const s=l.trim().toLowerCase();return s?n.cron_jobs.filter(i=>i.jobname.toLowerCase().includes(s)||String(i.jobid).includes(s)):n.cron_jobs},[n.cron_jobs,l]),_=[o.trim()?`cursors: "${o.trim()}"`:null,l.trim()?`cron: "${l.trim()}"`:null].filter(Boolean);function F(){w(g.cursorSearch),C(g.cronSearch)}return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(U,{children:"Jobs"}),_.length?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Applied: ",e.jsx("span",{className:"font-mono",children:_.join(" • ")})]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No filters applied."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(u,{variant:"ghost",onClick:F,disabled:P,children:"Reset filters"})})]}),e.jsxs(q,{title:"Saved job cursors (media_job_state)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(S,{value:o,onChange:s=>w(s.target.value),placeholder:"Filter by job name or cursor…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[f.length," rows"]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs(E,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(a,{children:"Job"}),e.jsx(a,{children:"Cursor"}),e.jsx(a,{children:"Updated"}),e.jsx(a,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:f.length?f.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.job_name}),e.jsx(v,{text:String(s.job_name),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.cursor??"—"}),s.cursor?e.jsx(v,{text:String(s.cursor),label:"Copy",className:"h-8 px-2 py-1 text-xs"}):null]})}),e.jsx(r,{className:"text-xs text-zinc-600",children:s.updated_at?R(s.updated_at):"—"}),e.jsx(r,{className:"text-right",children:e.jsx(u,{variant:"ghost",onClick:()=>c.mutate(s.job_name),disabled:c.isPending,title:"Reset stored cursor to null",children:"Reset cursor"})})]},s.job_name)):e.jsx("tr",{children:e.jsx(r,{colSpan:4,className:"p-6",children:e.jsx(Q,{title:"No saved cursors",message:"No rows in media_job_state yet.",className:"border-0 bg-transparent p-0"})})})})]}),c.isError?e.jsx(h,{error:c.error,className:"mt-2"}):null]})]}),e.jsxs(q,{title:"Cron jobs (pg_cron)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(S,{value:l,onChange:s=>C(s.target.value),placeholder:"Filter cron jobs…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[y.length," rows"]})]}),n.cron_error?e.jsxs("div",{className:"mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:[e.jsx("div",{className:"font-semibold",children:"Cron error"}),e.jsx("div",{className:"mt-1 font-mono text-xs",children:n.cron_error})]}):null,e.jsxs("div",{className:"mt-3",children:[e.jsxs(E,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(a,{children:"ID"}),e.jsx(a,{children:"Name"}),e.jsx(a,{children:"Schedule"}),e.jsx(a,{children:"Status"}),e.jsx(a,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:y.length?y.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobid??"—"}),e.jsx(v,{text:String(s.jobid??""),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobname}),e.jsx(v,{text:String(s.jobname),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"w-[220px]",children:e.jsx(S,{value:N[s.jobname]??s.schedule??"",onChange:i=>K(L=>({...L,[s.jobname]:i.target.value})),placeholder:"* * * * *",className:"py-1"})}),e.jsx(u,{variant:"ghost",onClick:()=>x.mutate({jobname:s.jobname,schedule:(N[s.jobname]??s.schedule??"").trim()}),disabled:x.isPending||!(N[s.jobname]??s.schedule??"").trim(),children:"Save"})]})}),e.jsx(r,{children:e.jsx("span",{className:k("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold",s.active?"border-emerald-200 bg-emerald-50 text-emerald-800":"border-zinc-200 bg-zinc-50 text-zinc-700"),children:s.active?"Active":"Paused"})}),e.jsx(r,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(u,{variant:"ghost",onClick:()=>d.mutate({jobname:s.jobname,active:!s.active}),disabled:d.isPending,children:s.active?"Pause":"Activate"}),e.jsx(u,{variant:"ghost",onClick:()=>m.mutate(s.jobname),disabled:m.isPending,title:"Run this cron immediately",children:"Run now"})]})})]},s.jobname)):e.jsx("tr",{children:e.jsx(r,{colSpan:5,className:"p-6",children:e.jsx(Q,{title:"No cron jobs",message:"No cron jobs registered (or pg_cron not enabled).",className:"border-0 bg-transparent p-0"})})})})]}),d.isError?e.jsx(h,{error:d.error,className:"mt-2"}):null,x.isError?e.jsx(h,{error:x.error,className:"mt-2"}):null,m.isError?e.jsx(h,{error:m.error,className:"mt-2"}):null]})]})]})}export{Z as default};
