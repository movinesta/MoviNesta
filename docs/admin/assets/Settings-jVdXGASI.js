import{r as l,j as e,i as _,u as en,p as tn,S as sn,T as nn,L as an,B as x,U as W,V as rn,W as ln,X as cn,Y as on,Z as Cs,_ as kt,$ as Et,a0 as dn,a1 as xn}from"./index-D9xRnzKs.js";import{u as Ve,E as mn}from"./ErrorBox-CDpT_uq-.js";import{u as G}from"./useMutation-BItk-FIV.js";import{C as ue}from"./Card-Aw9GMa-R.js";import{g as ke,H as Z,S as un}from"./settingsHints-D9jUy_CN.js";import{I as h}from"./Input-YDRMBIzd.js";function pn(c,o,b){const f=b==null?void 0:b.maxLines,L=c.split(`
`),te=o.split(`
`),k=L.length>f?[...L.slice(0,f),`… (truncated ${L.length-f} lines)`]:L,R=te.length>f?[...te.slice(0,f),`… (truncated ${te.length-f} lines)`]:te,O=k.length,d=R.length,T=Array.from({length:O+1},()=>new Array(d+1).fill(0));for(let C=O-1;C>=0;C--)for(let q=d-1;q>=0;q--)T[C][q]=k[C]===R[q]?T[C+1][q+1]+1:Math.max(T[C+1][q],T[C][q+1]);const U=[];let K=0,y=0;for(;K<O&&y<d;){if(k[K]===R[y]){U.push({type:"equal",line:k[K]}),K++,y++;continue}T[K+1][y]>=T[K][y+1]?(U.push({type:"del",line:k[K]}),K++):(U.push({type:"add",line:R[y]}),y++)}for(;K<O;)U.push({type:"del",line:k[K]}),K++;for(;y<d;)U.push({type:"add",line:R[y]}),y++;return U}function ks(c){try{return c===void 0?"undefined":JSON.stringify(c,null,2)}catch{try{return String(c)}catch{return"[unprintable]"}}}function hn(c){const{before:o,after:b,className:f}=c,[L,te]=l.useState(!1),k=l.useMemo(()=>ks(o),[o]),R=l.useMemo(()=>ks(b),[b]),O=l.useMemo(()=>pn(k,R,{maxLines:350}),[k,R]);return e.jsxs("div",{className:_("rounded-xl border border-zinc-200 bg-white",f),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 border-b border-zinc-200 px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-700",children:"Diff"}),e.jsxs("label",{className:"flex items-center gap-2 text-[11px] text-zinc-600",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:d=>te(d.target.checked)}),"Show unchanged"]})]}),e.jsx("pre",{className:"max-h-60 overflow-auto px-3 py-2 text-xs leading-5",children:O.filter(d=>L||d.type!=="equal").map((d,T)=>e.jsxs("div",{className:_("whitespace-pre",d.type==="add"&&"bg-emerald-50 text-emerald-900",d.type==="del"&&"bg-rose-50 text-rose-900",d.type==="equal"&&"text-zinc-600"),children:[e.jsx("span",{className:"select-none font-mono opacity-60",children:d.type==="add"?"+":d.type==="del"?"-":" "})," ",d.line]},T))})]})}function gn(c){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:c.children})}function Q(c){try{return JSON.stringify(c,null,2)}catch{return String(c)}}function Qe(c){if(c==null)return String(c);const o=typeof c;if(o==="string")return JSON.stringify(c);if(o==="number"||o==="boolean")return String(c);if(Array.isArray(c))return`[${c.map(b=>Qe(b)).join(",")}]`;if(o==="object")return`{${Object.keys(c).sort().map(L=>`${JSON.stringify(L)}:${Qe(c[L])}`).join(",")}}`;try{return JSON.stringify(c)}catch{return String(c)}}function pe(c,o){return Qe(c)===Qe(o)}function le(c){return typeof c=="string"?"string":typeof c=="number"?"number":typeof c=="boolean"?"boolean":"json"}function Es(c,o,b){if(c==="boolean")return!!b;if(c==="number"){const f=Number(o);if(!Number.isFinite(f))throw new Error("Invalid number");return Number.isInteger(f),f}if(c==="json"){const f=o.trim();if(!f)throw new Error("Empty JSON");return JSON.parse(f)}return o}function he(c){return c.split(".")[0]??"other"}function fn(c){const o=c.split(".");return o.length>=2?`${o[0]}.${o[1]}`:o[0]??"other"}function Ee(c){return l.useEffect(()=>{if(!c.open)return;const o=b=>{b.key==="Escape"&&c.onClose()};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[c.open,c.onClose]),c.open?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:c.onClose}),e.jsxs("div",{className:"relative w-full max-w-3xl rounded-2xl border border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:c.title}),e.jsx(x,{variant:"ghost",className:"rounded-lg px-2 py-1 text-xs text-zinc-500 hover:bg-zinc-100",onClick:c.onClose,children:"✕"})]}),e.jsx("div",{className:"mt-4",children:c.children})]})]}):null}function zn(){var fs,vs,js,bs,Ns,ys,ws,zs,Ss;const c=en(),o=tn(),b=sn(),f=nn(),L=f==null?void 0:f.category,te=!L,k=Ve({queryKey:["app-settings"],queryFn:dn}),R=Ve({queryKey:["app-settings-history","recent"],queryFn:()=>Et({limit:20}),staleTime:1e4}),O=Ve({queryKey:["app-settings-presets"],queryFn:xn,staleTime:3e4}),d=k.data,[T,U]=l.useState(""),K=l.useRef(null),[y,C]=l.useState("all"),[q,Re]=l.useState("all"),[J,Y]=l.useState(!1),[Ye,Ae]=l.useState(!1),[ne,Rt]=l.useState(()=>{const t=localStorage.getItem("mn_admin_settings_sort");return t==="key_asc"||t==="last_modified_desc"||t==="favorites_first"?t:"key_asc"});l.useEffect(()=>{try{localStorage.setItem("mn_admin_settings_sort",ne)}catch{}},[ne]);const[At,Rs]=l.useState("side_by_side"),[Xe,Ot]=l.useState(""),[As,ge]=l.useState(!1),[Os,We]=l.useState(null),[It,Pt]=l.useState(null),[ee,Ge]=l.useState(null),[E,Ze]=l.useState(null),[Dt,et]=l.useState(null),[Ft,tt]=l.useState(""),[Lt,Oe]=l.useState(!1),[st,Kt]=l.useState(!1),[fe,se]=l.useState(!1),[nt,ce]=l.useState(""),Mt=l.useRef(null);l.useEffect(()=>{function t(n){const s=(n.key??"").toLowerCase();(n.ctrlKey||n.metaKey)&&s==="k"&&(n.preventDefault(),se(!0),ce(""))}return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),l.useEffect(()=>{if(!fe)return;const t=setTimeout(()=>{var n;return(n=Mt.current)==null?void 0:n.focus()},0);return()=>clearTimeout(t)},[fe]),l.useEffect(()=>{const t=f==null?void 0:f.category;if(typeof t=="string"&&t.trim()){if(t==="favorites"){C("all"),Y(!0);return}Y(!1),C(t);return}Y(!1),C("all")},[f==null?void 0:f.category]);const[I,Tt]=l.useState(()=>{try{const t=localStorage.getItem("mn_admin_settings_favs_v1"),n=t?JSON.parse(t):[];return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}),[ve,qt]=l.useState(!1),[Ie,$t]=l.useState(""),[je,it]=l.useState("fallback"),[at,rt]=l.useState(null);function oe(t){return t.slice().sort().join("|")}l.useEffect(()=>{try{localStorage.setItem("mn_admin_settings_favs_v1",JSON.stringify(I))}catch{}},[I]),l.useEffect(()=>{if(!d)return;const t=d==null?void 0:d.favorites_storage;(t==="db"||t==="fallback")&&it(t)},[d]),l.useEffect(()=>{if(!d)return;const t=d==null?void 0:d.favorites;if(!Array.isArray(t)){ve||qt(!0);return}let n=[];try{const N=localStorage.getItem("mn_admin_settings_favs_v1"),z=N?JSON.parse(N):[];n=Array.isArray(z)?z.filter(m=>typeof m=="string"):[]}catch{n=[]}const s=Array.from(new Set([...t,...n].filter(N=>typeof N=="string"))),i=oe(s),r=oe(n),a=oe(t);i!==r&&Tt(s);const w=(d==null?void 0:d.favorites_storage)==="db"?"db":"fallback";w!==je&&it(w),$t(w==="db"?a:i),qt(!0)},[d]);const de=G({mutationFn:async t=>rn({favorites:t}),onSuccess:t=>{const n=t.favorites??[];$t(oe(n)),(t.favorites_storage==="db"||t.favorites_storage==="fallback")&&it(t.favorites_storage),rt(null)},onError:t=>{rt((t==null?void 0:t.message)??"Failed to sync favorites")}});l.useEffect(()=>{var s;if(!ve||!((s=d==null?void 0:d.actor)!=null&&s.userId)||je!=="db"||oe(I)===Ie)return;const n=setTimeout(()=>{de.mutate(I)},500);return()=>clearTimeout(n)},[I,ve,Ie,(fs=d==null?void 0:d.actor)==null?void 0:fs.userId,je]);const ie=l.useMemo(()=>{if(je!=="db")return{state:"Offline",detail:"Server storage not available"};if(de.isPending)return{state:"Saving",detail:null};const t=ve&&oe(I)!==Ie;return at?{state:"Error",detail:at}:t?{state:"Saving",detail:null}:{state:"Saved",detail:null}},[je,de.isPending,ve,I,Ie,at]),lt=G({mutationFn:async t=>ln({slug:t}),onSuccess:(t,n)=>{We(null),Pt(n),Ge(t.preset??null),Ze(t.preview??null),et(t.message??null),tt(""),Oe(!1),Kt(!1),ge(!0)},onError:t=>{We(null),o.push({variant:"error",title:"Preset preview failed",message:(t==null?void 0:t.message)??"Could not load preset preview."})}}),Ut=G({mutationFn:async()=>{if(!It)throw new Error("No preset selected");const t=Ft.trim();if(!t)throw new Error("Reason is required");return cn({slug:It,expected_version:H,reason:t})},onSuccess:t=>{o.push({variant:"success",title:"Preset applied",message:`${t.preset_slug}: updated ${t.updated_keys.length}, reset ${t.deleted_keys.length}.`}),ge(!1),Pt(null),Ge(null),Ze(null),et(null),tt(""),Oe(!1),c.invalidateQueries({queryKey:["app-settings"]}),c.invalidateQueries({queryKey:["app-settings-history"]}),c.invalidateQueries({queryKey:["app-settings-history","recent"]})},onError:t=>{o.push({variant:"error",title:"Preset apply failed",message:(t==null?void 0:t.message)??"Could not apply preset."})}});function Is(t){We(t),et(null),Ze(null),Ge(null),lt.mutate(t)}const[ct,Ps]=l.useState(["public","admin","server_only"]),[ae,Jt]=l.useState(""),[Pe,Ds]=l.useState(["public","admin","server_only"]),[ot,Fs]=l.useState(!1),[dt,Ls]=l.useState(""),[Ks,De]=l.useState(!1),[A,Ht]=l.useState(null),[Bt,xt]=l.useState(""),[Vt,Fe]=l.useState(!1),[j,M]=l.useState({}),[be,Le]=l.useState({}),[Ne,Qt]=l.useState({}),u=(d==null?void 0:d.registry)??{},Yt=(d==null?void 0:d.rows)??[],H=(d==null?void 0:d.version)??0,P=l.useMemo(()=>{const t=new Map;for(const n of Yt)t.set(n.key,n);return t},[Yt]),mt=l.useMemo(()=>{var n;const t=new Map;for(const[s,i]of P.entries())if(i!=null&&i.updated_at){const r=Date.parse(i.updated_at);Number.isFinite(r)&&t.set(s,r)}for(const s of((n=R.data)==null?void 0:n.rows)??[]){const i=Date.parse(s.changed_at);if(!Number.isFinite(i))continue;const r=t.get(s.key);(r===void 0||i>r)&&t.set(s.key,i)}return t},[P,R.data]);l.useEffect(()=>{if(!d)return;const t={},n={};for(const[s,i]of Object.entries(u)){const r=P.get(s),a=r?r.value:i.default,v=le(i.default);v==="boolean"?n[s]=!!a:v==="json"?t[s]=Q(a):t[s]=a==null?"":String(a)}M(t),Le(n),Qt({})},[d]);const Xt=l.useMemo(()=>{const t=new Set;for(const n of Object.keys(u))t.add(he(n));return["all",...Array.from(t).sort()]},[u]),Wt=l.useMemo(()=>{const t=new Map;for(const n of Object.keys(u)){const s=he(n);t.set(s,(t.get(s)??0)+1)}return t},[u]),ut=l.useMemo(()=>{if(!fe)return[];const t=nt.trim().toLowerCase(),n=Object.keys(u),s=[];for(const i of n){const r=u[i],a=ke(i,r?{default:r.default,description:r.description,meta:r.meta}:void 0),v=(a==null?void 0:a.title)??i,w=(r==null?void 0:r.description)??"",N=(a==null?void 0:a.details)??"",z=((a==null?void 0:a.examples)??[]).map(S=>`${S.scenario} ${S.effect}`).join(" "),m=((a==null?void 0:a.related)??[]).join(" "),$=String((a==null?void 0:a.recommended_why)??""),me=`${i} ${v} ${w} ${N} ${z} ${m} ${$}`.toLowerCase();let p=0;t?i.toLowerCase()===t?p=2e3:i.toLowerCase().startsWith(t)?p=1500:i.toLowerCase().includes(t)?p=900:v.toLowerCase().includes(t)?p=600:w.toLowerCase().includes(t)?p=450:N.toLowerCase().includes(t)?p=350:me.includes(t)&&(p=200):p=1,p>0&&s.push({key:i,title:v,description:w,score:p})}return s.sort((i,r)=>r.score-i.score||i.key.localeCompare(r.key)),s.slice(0,30)},[fe,nt,u]),Ke=l.useMemo(()=>{const t=new Map;for(const n of Object.keys(u)){const s=u[n],i=P.get(n);if(!i||pe(i.value,s==null?void 0:s.default))continue;const r=he(n);t.set(r,(t.get(r)??0)+1)}return t},[u,P]),Me=l.useMemo(()=>{const t=[];for(const n of Object.keys(u)){const s=u[n],i=P.get(n);i&&pe(i.value,s==null?void 0:s.default)&&t.push(n)}return t.sort(),t},[u,P]),pt=l.useMemo(()=>{const t=T.trim().toLowerCase(),n=Object.keys(u).filter(s=>{var w;if(y!=="all"&&he(s)!==y||q!=="all"&&((w=u[s])==null?void 0:w.scope)!==q||J&&!I.includes(s))return!1;if(Ye){const N=u[s],z=P.get(s);if(!z||pe(z.value,N==null?void 0:N.default))return!1}if(!t)return!0;const i=u[s],r=(i==null?void 0:i.description)??"",a=ke(s,{default:i==null?void 0:i.default,description:i==null?void 0:i.description,meta:i==null?void 0:i.meta});return[s,r,(a==null?void 0:a.title)??"",(a==null?void 0:a.details)??"",(a==null?void 0:a.recommended_why)??"",(a==null?void 0:a.caution)??"",...(a==null?void 0:a.related)??[],...((a==null?void 0:a.examples)??[]).flatMap(N=>[N.scenario,N.effect])].join(`
`).toLowerCase().includes(t)});return ne==="key_asc"?n.sort():ne==="favorites_first"?n.sort((s,i)=>{const r=I.includes(s)?1:0,a=I.includes(i)?1:0;return a!==r?a-r:s.localeCompare(i)}):ne==="last_modified_desc"&&n.sort((s,i)=>{const r=mt.get(s)??0,a=mt.get(i)??0;return a!==r?a-r:s.localeCompare(i)}),n},[u,T,y,q,J,I,Ye,P,ne,mt]),Ms=l.useMemo(()=>{const t=new Map;for(const n of pt){const s=fn(n),i=t.get(s);i?i.push(n):t.set(s,[n])}return Array.from(t.entries()).sort((n,s)=>n[0].localeCompare(s[0]))},[pt]),Te=l.useMemo(()=>Object.keys(Ne).filter(t=>Ne[t]),[Ne]);function Ts(t,n){try{const s=new Blob([n],{type:"application/json"}),i=URL.createObjectURL(s),r=document.createElement("a");r.href=i,r.download=t,r.click(),URL.revokeObjectURL(i)}catch{}}function Gt(t,n){return t.includes(n)?t.filter(s=>s!==n):[...t,n]}function Zt(t){const n=t.trim();if(!n)throw new Error("Import JSON is empty");return JSON.parse(n)}const es=G({mutationFn:async()=>{if(!ct.length)throw new Error("Select at least one scope to export");return on({scopes:ct})},onSuccess:t=>{const n=Q(t.bundle);Jt(n),o.push({variant:"success",title:"Export ready",message:"Settings bundle generated."})},onError:t=>{o.push({variant:"error",title:"Export failed",message:W(t)})}}),ts=G({mutationFn:async()=>{if(!Pe.length)throw new Error("Select at least one scope to import");const t=Zt(dt);return Cs({mode:"dry_run",bundle:t,scopes:Pe,delete_missing:ot})},onSuccess:t=>{Ht(t.preview??null),xt(""),Fe(!1),De(!0)},onError:t=>{o.push({variant:"error",title:"Preview failed",message:W(t),durationMs:6e3})}}),ss=G({mutationFn:async()=>{if(!A)throw new Error("Run a preview first");if(!Vt)throw new Error("Confirm before applying");const t=Bt.trim();if(!t)throw new Error("Reason is required");const n=Zt(dt);return Cs({mode:"apply",bundle:n,scopes:Pe,delete_missing:ot,expected_version:H>0?H:void 0,reason:t})},onSuccess:async()=>{o.push({variant:"success",title:"Import applied",message:"Settings updated."}),De(!1),Ht(null),xt(""),Fe(!1),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Import failed",message:W(t),durationMs:6e3})}}),ht=G({mutationFn:async()=>{const t={};for(const n of Te){const s=u[n];if(!s)continue;const i=le(s.default),r=j[n]??"",a=be[n];t[n]=Es(i,r,a)}return kt({expected_version:H>0?H:void 0,updates:t,reason:Xe.trim()||void 0})},onSuccess:async t=>{var v,w,N,z;const n=((v=t==null?void 0:t.updated_keys)==null?void 0:v.length)??0,s=((w=t==null?void 0:t.deleted_keys)==null?void 0:w.length)??0,i=((N=t==null?void 0:t.same_keys)==null?void 0:N.length)??0,r=((z=t==null?void 0:t.ignored_default_keys)==null?void 0:z.length)??0,a=[];n&&a.push(`updated ${n}`),s&&a.push(`reset ${s}`),i&&a.push(`no-op ${i}`),r&&a.push(`already default ${r}`),o.push({variant:"success",title:"Settings saved",message:a.length?a.join(", ")+".":"No changes."}),Ot(""),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Save failed",message:W(t),durationMs:6e3})}}),gt=G({mutationFn:async()=>{if(!Me.length)throw new Error("No redundant overrides to clean");const t={};for(const i of Me){const r=u[i];r&&(t[i]=r.default)}const n=Xe.trim(),s=n?`Cleanup redundant overrides: ${n}`:"Cleanup redundant overrides";return kt({expected_version:H>0?H:void 0,updates:t,reason:s})},onSuccess:async t=>{var s;const n=((s=t==null?void 0:t.deleted_keys)==null?void 0:s.length)??0;o.push({variant:"success",title:"Cleaned up",message:n?`Removed ${n} redundant override(s).`:"Nothing to remove."}),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Cleanup failed",message:W(t)})}}),[qs,ns]=l.useState(!1),[D,is]=l.useState(null),[as,rs]=l.useState([]),[qe,$s]=l.useState(30),[$e,Us]=l.useState(50),[Js,Ue]=l.useState(!1),[X,Je]=l.useState(null),[ft,ye]=l.useState("");function we(t){if(!t||t<=0)return;const n=t*24*60*60*1e3;return new Date(Date.now()-n).toISOString()}const ze=G({mutationFn:async t=>Et(t),onSuccess:t=>rs(t.rows??[]),onError:t=>{o.push({variant:"error",title:"History failed",message:W(t)})}}),Se=G({mutationFn:async()=>{if(!D||!X)throw new Error("No rollback target selected");const t=ft.trim();if(!t)throw new Error("Rollback reason is required");const n=u[D];if(!n)throw new Error("Unknown setting key");const s=X.old_value===null||X.old_value===void 0?n.default:X.old_value;return kt({expected_version:H>0?H:void 0,updates:{[D]:s},reason:`Rollback: ${t}`})},onSuccess:async()=>{o.push({variant:"success",title:"Rolled back",message:"Setting restored to the previous value."}),Ue(!1),Je(null),ye(""),await c.invalidateQueries({queryKey:["app-settings"]}),cs()},onError:t=>{o.push({variant:"error",title:"Rollback failed",message:W(t)})}});function B(t){Qt(n=>({...n,[t]:!0}))}function vt(t){return I.includes(t)}function Hs(t){Tt(n=>n.includes(t)?n.filter(s=>s!==t):[...n,t])}async function Bs(t){var n;try{if((n=navigator==null?void 0:navigator.clipboard)!=null&&n.writeText)return await navigator.clipboard.writeText(t),!0}catch{}try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.left="-9999px",document.body.appendChild(s),s.focus(),s.select();const i=document.execCommand("copy");return document.body.removeChild(s),i}catch{return!1}}async function ls(t){const n=await Bs(t);o.push({variant:n?"success":"error",title:n?"Copied":"Copy failed",message:n?t:"Could not copy to clipboard."})}function Vs(t){const n=u[t];if(!n)return;const s=le(n.default);s==="boolean"?Le(i=>({...i,[t]:!!n.default})):M(s==="json"?i=>({...i,[t]:Q(n.default)}):i=>({...i,[t]:String(n.default)})),B(t)}function jt(t){is(t),ns(!0),rs([]),ze.mutate({key:t,limit:$e,since:we(qe)})}function cs(){D&&ze.mutate({key:D,limit:$e,since:we(qe)})}function Qs(t){D&&(Je(t),ye(""),Ue(!0))}const[os,ds]=l.useState(!1),[g,xs]=l.useState(null);function V(t){xs(t),ds(!0)}function He(t,n){const s=he(t);U(""),Re("all"),Y(!1),Ae(!1),se(!1),ce(""),C(s),L!==s&&b(`/settings/${s}`),n!=null&&n.openDetails&&V(t);let i=0;const r=()=>{const a=document.getElementById(`setting-${t}`);if(a){a.scrollIntoView({behavior:"smooth",block:"start"});return}i++<10&&requestAnimationFrame(r)};setTimeout(()=>requestAnimationFrame(r),0)}function Ys(t){U(""),Re("all"),Y(!1),Ae(!1),Rt("key_asc"),se(!1),ce(""),C("all"),b("/settings")}function Xs(){ds(!1),xs(null)}function ms(t,n){const s=u[t];if(!s)return;const i=le(s.default);i==="boolean"?Le(r=>({...r,[t]:!!n})):M(i==="json"?r=>({...r,[t]:Q(n)}):r=>({...r,[t]:String(n)})),B(t)}function Ws(t){const n=u[t],s=ke(t,n?{default:n.default,description:n.description,meta:n.meta}:void 0);s.recommended!==void 0&&ms(t,s.recommended)}const bt="ops.rate_limits",xe="assistant.tool_result_truncation",Nt="assistant.reply_runner.backoff",yt="admin.users.page_limit",us="admin.users.ban_duration_days",wt="admin.overview.recent_errors_limit",ps="admin.overview.last_job_runs_limit",zt="admin.audit.default_limit",St="ux.assistant.username",_t="ux.presence.label_online",hs="ux.presence.label_active_recently",gs="ux.presence.label_active_prefix",Ct="ux.messages.search.min_query_chars";function _e(t,n,s,i){const r=Number(t);if(!Number.isFinite(r))return i;const a=Math.trunc(r);return Math.max(n,Math.min(s,a))}function Ce(t){const n=u[t];if(!n)return;const s=P.get(t);return s?s.value:n.default}function re(t){const n=j[t];if(typeof n=="string"&&n.trim())try{return JSON.parse(n)}catch{}return Ce(t)}function Be(t,n){M(s=>({...s,[t]:Q(n)})),B(t)}function F(t,n){M(s=>({...s,[t]:n})),B(t)}function Gs(t){const n=u[t];if(!n)return;if(!Ne[t])return Ce(t);const s=le(n.default);if(s==="boolean")return!!be[t];if(s==="json")return re(t);const i=(j[t]??"").trim();if(s==="number"){const r=Number(i);return Number.isFinite(r)?(Number.isInteger(r),r):i}return i}const Zs=Ve({queryKey:["app-settings-history","drawer",g??"none"],enabled:os&&!!g,queryFn:async()=>g?Et({key:g,limit:5,since:we(90)}):{ok:!0,rows:[]}});return k.isLoading?e.jsx(an,{}):k.error?e.jsx(mn,{error:k.error}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(gn,{children:"Settings"}),e.jsx(ue,{title:"Export / Import settings",right:e.jsxs("div",{className:"text-xs text-zinc-500",children:["Current version: ",e.jsx("span",{className:"font-mono",children:H})]}),children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Export bundle"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Export non-secret settings as JSON for backup or promotion between environments."}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs",children:[["public","admin","server_only"].map(t=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:ct.includes(t),onChange:()=>Ps(n=>Gt(n,t))}),e.jsx("span",{className:"font-mono",children:t})]},t)),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx(x,{onClick:()=>es.mutate(),disabled:es.isPending,children:"Export"}),e.jsx(x,{variant:"secondary",onClick:()=>{var t;ae.trim()&&((t=navigator.clipboard)==null||t.writeText(ae).then(()=>{o.push({variant:"success",title:"Copied",message:"Export JSON copied to clipboard."})}).catch(()=>{o.push({variant:"error",title:"Copy failed",message:"Could not copy to clipboard."})}))},disabled:!ae.trim(),children:"Copy"}),e.jsx(x,{variant:"secondary",onClick:()=>{if(!ae.trim())return;const t=new Date().toISOString().replace(/[:.]/g,"-");Ts(`movinesta-app-settings-${t}.json`,ae)},disabled:!ae.trim(),children:"Download"})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("textarea",{className:"h-40 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900",placeholder:"Click Export to generate a bundle JSON here…",value:ae,onChange:t=>Jt(t.target.value)})})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Import bundle"}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["Paste a bundle JSON and run a ",e.jsx("span",{className:"font-medium",children:"dry-run preview"})," before applying. This never moves secrets."]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs",children:[["public","admin","server_only"].map(t=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Pe.includes(t),onChange:()=>Ds(n=>Gt(n,t))}),e.jsx("span",{className:"font-mono",children:t})]},t)),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:ot,onChange:t=>Fs(t.target.checked)}),e.jsx("span",{children:"Delete missing keys"})]}),e.jsx("div",{className:"ml-auto",children:e.jsx(x,{onClick:()=>ts.mutate(),disabled:ts.isPending,children:"Preview"})})]}),e.jsx("div",{className:"mt-3",children:e.jsx("textarea",{className:"h-40 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900",placeholder:"Paste export JSON here…",value:dt,onChange:t=>Ls(t.target.value)})})]})]})}),e.jsxs(ue,{title:"Recommended presets",right:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-zinc-500",children:[e.jsxs("div",{children:["Presets storage: ",e.jsx("span",{className:"font-mono",children:((vs=O.data)==null?void 0:vs.presets_storage)??"…"})]}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings-presets"]}),disabled:O.isFetching,children:O.isFetching?"…":"Refresh"})]}),children:[e.jsx("div",{className:"text-xs text-zinc-600",children:"Presets apply multiple settings in one safe action. You can preview the exact diff before applying."}),O.isLoading?e.jsx("div",{className:"mt-3 text-sm text-zinc-500",children:"Loading presets…"}):(((js=O.data)==null?void 0:js.presets_storage)??"fallback")!=="db"?e.jsxs("div",{className:"mt-3 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900",children:["Presets are not available until you run the migration:",e.jsx("div",{className:"mt-2 font-mono text-[11px]",children:"supabase/migrations/20260108_000200_app_settings_presets.sql"})]}):(((bs=O.data)==null?void 0:bs.presets)??[]).length?e.jsx("div",{className:"mt-4 space-y-4",children:Object.entries((((Ns=O.data)==null?void 0:Ns.presets)??[]).reduce((t,n)=>{const s=(n.group_key??"general").toString();return(t[s]??(t[s]=[])).push(n),t},{})).map(([t,n])=>e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:t}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:[n.length," preset",n.length===1?"":"s"]})]})}),e.jsx("div",{className:"mt-3 space-y-2",children:n.map(s=>{const i=Object.keys(s.preset??{}).length;return e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3 rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:s.title}),s.is_builtin?e.jsx("span",{className:"rounded-lg bg-zinc-200 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:"Built-in"}):null,e.jsxs("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:[i," keys"]})]}),s.description?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:s.description}):null,e.jsx("div",{className:"mt-2 font-mono text-[11px] text-zinc-500",children:s.slug})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"secondary",onClick:()=>Is(s.slug),disabled:lt.isPending,children:lt.isPending&&Os===s.slug?"Loading…":"Preview"})})]},s.slug)})})]},t))}):e.jsx("div",{className:"mt-3 text-sm text-zinc-500",children:"No presets found."})]}),e.jsx(Ee,{open:As,title:(ee==null?void 0:ee.title)??"Preset preview",onClose:()=>{ge(!1),Oe(!1)},children:!ee||!E?e.jsxs("div",{className:"space-y-3",children:[Dt?e.jsx("div",{className:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:Dt}):null,e.jsx("div",{className:"text-sm text-zinc-600",children:"No preview loaded."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-zinc-900",children:[e.jsx("div",{className:"font-semibold",children:ee.title}),ee.description?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:ee.description}):null,e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 font-mono",children:ee.slug}),e.jsxs("span",{className:"rounded-lg bg-zinc-100 px-2 py-1",children:[Object.keys(ee.preset??{}).length," keys"]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Update"}),e.jsx("div",{className:"font-mono",children:E.counts.update})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Reset"}),e.jsx("div",{className:"font-mono",children:E.counts.reset})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Same"}),e.jsx("div",{className:"font-mono",children:E.counts.same})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Already default"}),e.jsx("div",{className:"font-mono",children:E.counts.already_default})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Unknown"}),e.jsx("div",{className:"font-mono",children:E.counts.unknown})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Invalid"}),e.jsx("div",{className:"font-mono",children:E.counts.invalid})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-600",children:[e.jsx("input",{type:"checkbox",checked:st,onChange:t=>Kt(t.target.checked)}),e.jsx("span",{children:"Show non-changing rows"})]}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Click a row to jump to the setting."})]})]}),E.unknown_keys.length?e.jsxs("div",{className:"rounded-2xl border border-amber-200 bg-amber-50 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-amber-900",children:"Unknown keys (ignored)"}),e.jsx("div",{className:"mt-2 max-h-24 overflow-auto rounded-xl border border-amber-200 bg-white p-2 font-mono text-[11px] text-amber-900",children:E.unknown_keys.map(t=>e.jsx("div",{children:t},t))})]}):null,E.invalid_values.length?e.jsxs("div",{className:"rounded-2xl border border-red-200 bg-red-50 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-red-900",children:"Invalid values (ignored)"}),e.jsx("div",{className:"mt-2 max-h-28 overflow-auto rounded-xl border border-red-200 bg-white p-2 text-[11px] text-red-900",children:E.invalid_values.map(t=>e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"font-mono",children:t.key}),e.jsx("div",{className:"text-right",children:t.message})]},t.key))})]}):null,e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Changes"}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Showing ",st?E.changes.length:E.changes.filter(t=>t.change_type==="update"||t.change_type==="reset").length," rows"]})]}),e.jsx("div",{className:"max-h-[320px] overflow-auto rounded-xl border border-zinc-200",children:(st?E.changes:E.changes.filter(t=>t.change_type==="update"||t.change_type==="reset")).slice(0,120).map(t=>{const n=t.change_type==="update"?"bg-emerald-100 text-emerald-800":t.change_type==="reset"?"bg-amber-100 text-amber-800":t.change_type==="already_default"?"bg-zinc-200 text-zinc-700":"bg-zinc-100 text-zinc-600",s=i=>{if(i===void 0)return"undefined";if(i===null)return"DEFAULT";if(typeof i=="string")return i.length>64?i.slice(0,64)+"…":i;try{const r=JSON.stringify(i);return r.length>90?r.slice(0,90)+"…":r}catch{return String(i)}};return e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{ge(!1),He(t.key,{openDetails:!0})},className:"w-full border-b border-zinc-100 px-3 py-2 text-left hover:bg-zinc-50",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:_("rounded-lg px-2 py-1 text-[11px] font-semibold",n),children:t.change_type}),e.jsx("span",{className:"truncate font-mono text-[11px] text-zinc-900",children:t.key}),e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:t.scope})]}),e.jsxs("div",{className:"mt-1 text-[11px] text-zinc-600",children:[e.jsx("span",{className:"font-semibold",children:"Current:"})," ",e.jsx("span",{className:"font-mono",children:s(t.current)}),e.jsx("span",{className:"mx-2 text-zinc-400",children:"→"}),e.jsx("span",{className:"font-semibold",children:"Target:"})," ",e.jsx("span",{className:"font-mono",children:s(t.target)})]})]}),e.jsx("div",{className:"shrink-0 text-[11px] text-zinc-500",children:t.had_override?"override":"default"})]})},t.key)})}),E.changes.length>120?e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"Showing first 120 rows."}):null]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Apply preset"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Applying writes to settings history and admin audit log."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Reason (required)"}),e.jsx(h,{value:Ft,onChange:t=>tt(t.target.value),placeholder:"e.g., Switch production to high-quality assistant"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",checked:Lt,onChange:t=>Oe(t.target.checked)}),e.jsx("span",{children:"I understand this changes live settings"})]})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>ge(!1),children:"Close"}),e.jsx(x,{onClick:()=>Ut.mutate(),disabled:!Lt||Ut.isPending,children:"Apply"})]})]})]})}),e.jsx(Ee,{open:Ks,title:"Import preview",onClose:()=>{De(!1),Fe(!1)},children:A?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Adds"}),e.jsx("div",{className:"font-mono",children:A.counts.add})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Updates"}),e.jsx("div",{className:"font-mono",children:A.counts.update})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Deletes"}),e.jsx("div",{className:"font-mono",children:A.counts.delete})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Same"}),e.jsx("div",{className:"font-mono",children:A.counts.same})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Skipped (scope)"}),e.jsx("div",{className:"font-mono",children:A.counts.skipped_scope})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Skipped (unknown)"}),e.jsx("div",{className:"font-mono",children:A.counts.skipped_unknown})]})]}),e.jsxs("div",{className:"mt-2 text-xs text-zinc-500",children:["Target scopes: ",e.jsx("span",{className:"font-mono",children:A.requestedScopes.join(", ")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 lg:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Adds"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.adds.length?A.adds.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Updates"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.updates.length?A.updates.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Deletes"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.deletes.length?A.deletes.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Apply changes"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Applying writes history + admin audit log and bumps the settings version."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Reason (required)"}),e.jsx(h,{value:Bt,onChange:t=>xt(t.target.value),placeholder:"e.g., Promote staging config to production"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",checked:Vt,onChange:t=>Fe(t.target.checked)}),e.jsx("span",{children:"I understand this changes live settings"})]})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>De(!1),children:"Close"}),e.jsx(x,{onClick:()=>ss.mutate(),disabled:ss.isPending,children:"Apply"})]})]})]}):e.jsx("div",{className:"text-sm text-zinc-600",children:"No preview loaded."})}),e.jsx(ue,{title:"Quick editors (server-only knobs)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Rate limits"}),e.jsx(Z,{onClick:()=>V(bt)})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["Stored as ",e.jsx("span",{className:"font-mono",children:"server_only"})," settings; used by Edge Functions only."]}),(()=>{var s;const t=re(bt)??{actions:{}},n=Number(((s=t==null?void 0:t.actions)==null?void 0:s["catalog-sync"])??60);return e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"catalog-sync (max / minute)"}),e.jsx(h,{type:"number",min:1,max:6e3,value:Number.isFinite(n)?String(n):"60",onChange:i=>{const r=_e(i.target.value,1,6e3,60),a={...t??{},actions:{...(t==null?void 0:t.actions)??{},"catalog-sync":r}};Be(bt,a)}}),e.jsxs("div",{className:"text-[11px] text-zinc-500",children:["Tip: You can add more actions in the full table editor under ",e.jsx("span",{className:"font-mono",children:"ops.rate_limits"}),"."]})]})})()]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Tool result truncation"}),e.jsx(Z,{onClick:()=>V(xe)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Controls how much tool output is returned (prevents huge payloads)."}),(()=>{const t=re(xe)??{defaults:{maxString:1200,maxArray:40,maxObjectKeys:60},caps:{maxString:4e3,maxArray:200,maxObjectKeys:200},maxDepth:4},n=(t==null?void 0:t.defaults)??{},s=(t==null?void 0:t.caps)??{},i=Number((t==null?void 0:t.maxDepth)??4),r=(a,v,w)=>{const N=re(xe)??t,z=a==="defaults"?N.defaults??{}:N.caps??{},m=Number((z==null?void 0:z[v])??(a==="defaults"?n[v]:s[v])),p=_e(w,v==="maxString"?80:v==="maxArray"?1:5,v==="maxString"?4e3:200,m),S={...N??{},[a]:{...z??{},[v]:p}};Be(xe,S)};return e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Defaults"}),e.jsxs("div",{className:"mt-2 grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxString"}),e.jsx(h,{type:"number",min:80,max:4e3,value:String(Number(n.maxString??1200)),onChange:a=>r("defaults","maxString",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxArray"}),e.jsx(h,{type:"number",min:1,max:200,value:String(Number(n.maxArray??40)),onChange:a=>r("defaults","maxArray",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxKeys"}),e.jsx(h,{type:"number",min:5,max:200,value:String(Number(n.maxObjectKeys??60)),onChange:a=>r("defaults","maxObjectKeys",a.target.value)})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Caps"}),e.jsxs("div",{className:"mt-2 grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxString"}),e.jsx(h,{type:"number",min:80,max:4e3,value:String(Number(s.maxString??4e3)),onChange:a=>r("caps","maxString",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxArray"}),e.jsx(h,{type:"number",min:1,max:200,value:String(Number(s.maxArray??200)),onChange:a=>r("caps","maxArray",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxKeys"}),e.jsx(h,{type:"number",min:5,max:200,value:String(Number(s.maxObjectKeys??200)),onChange:a=>r("caps","maxObjectKeys",a.target.value)})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"maxDepth"}),e.jsx(h,{type:"number",min:1,max:8,value:Number.isFinite(i)?String(i):"4",onChange:a=>{const v=_e(a.target.value,1,8,4),w=re(xe)??t;Be(xe,{...w??{},maxDepth:v})}})]})]})})()]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Reply runner"}),e.jsx(Z,{onClick:()=>V("assistant.reply_runner.backoff")})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Background assistant job worker knobs (claiming, retries, stuck reclaim, context size, backoff)."}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"claim limit"}),e.jsx(h,{type:"number",min:1,max:200,value:j["assistant.reply_runner.claim_limit_default"]??"",onChange:t=>F("assistant.reply_runner.claim_limit_default",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max attempts"}),e.jsx(h,{type:"number",min:1,max:10,value:j["assistant.reply_runner.max_attempts_default"]??"",onChange:t=>F("assistant.reply_runner.max_attempts_default",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"stuck minutes"}),e.jsx(h,{type:"number",min:1,max:120,value:j["assistant.reply_runner.stuck_minutes"]??"",onChange:t=>F("assistant.reply_runner.stuck_minutes",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max context msgs"}),e.jsx(h,{type:"number",min:1,max:50,value:j["assistant.reply_runner.max_context_messages"]??"",onChange:t=>F("assistant.reply_runner.max_context_messages",t.target.value)})]})]}),(()=>{const t=re(Nt)??{base_seconds:10,max_exp:10,max_seconds:3600,jitter_seconds:5},n=(s,i)=>{const r=re(Nt)??t,a=Number((r==null?void 0:r[s])??(t==null?void 0:t[s])),v=s==="base_seconds"?[1,120]:s==="max_exp"?[1,16]:s==="max_seconds"?[10,7200]:[0,30],w=_e(i,v[0],v[1],a);Be(Nt,{...r??{},[s]:w})};return e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Backoff"}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"base s"}),e.jsx(h,{type:"number",min:1,max:120,value:String(Number(t.base_seconds??10)),onChange:s=>n("base_seconds",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max exp"}),e.jsx(h,{type:"number",min:1,max:16,value:String(Number(t.max_exp??10)),onChange:s=>n("max_exp",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max s"}),e.jsx(h,{type:"number",min:10,max:7200,value:String(Number(t.max_seconds??3600)),onChange:s=>n("max_seconds",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"jitter s"}),e.jsx(h,{type:"number",min:0,max:30,value:String(Number(t.jitter_seconds??5)),onChange:s=>n("jitter_seconds",s.target.value)})]})]})]})})()]})]})]})}),e.jsx(ue,{title:"Quick editors (admin dashboard defaults)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Users"}),e.jsx(Z,{onClick:()=>V(yt)})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["List page size + ban duration (stored as ",e.jsx("span",{className:"font-mono",children:"admin"})," settings)."]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"page limit"}),e.jsx(h,{type:"number",min:10,max:500,value:j[yt]??"",onChange:t=>F(yt,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"ban duration (days)"}),e.jsx(h,{type:"number",min:1,max:36500,value:j[us]??"",onChange:t=>F(us,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Overview"}),e.jsx(Z,{onClick:()=>V(wt)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Controls how many rows the overview endpoint returns."}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"recent errors"}),e.jsx(h,{type:"number",min:1,max:200,value:j[wt]??"",onChange:t=>F(wt,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"last job runs"}),e.jsx(h,{type:"number",min:1,max:200,value:j[ps]??"",onChange:t=>F(ps,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Audit"}),e.jsx(Z,{onClick:()=>V(zt)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Default limit for listing audit rows (request may override, still clamped)."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"default limit"}),e.jsx(h,{type:"number",min:1,max:200,value:j[zt]??"",onChange:t=>F(zt,t.target.value)})]})]})]})}),e.jsx(ue,{title:"Quick editors (public UX / copy)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Assistant"}),e.jsx(Z,{onClick:()=>V(St)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Public settings: affect how the client detects the assistant thread on first run."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"assistant username"}),e.jsx(h,{value:j[St]??"",onChange:t=>F(St,t.target.value),placeholder:"movinesta"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Presence labels"}),e.jsx(Z,{onClick:()=>V(_t)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"UI copy for online / away / last-active state."}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"online label"}),e.jsx(h,{value:j[_t]??"",onChange:t=>F(_t,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"active recently label"}),e.jsx(h,{value:j[hs]??"",onChange:t=>F(hs,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"last-active prefix"}),e.jsx(h,{value:j[gs]??"",onChange:t=>F(gs,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Messages search"}),e.jsx(Z,{onClick:()=>V(Ct)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Minimum characters required to enable in-conversation search."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"min chars"}),e.jsx(h,{type:"number",min:1,max:10,value:j[Ct]??"",onChange:t=>F(Ct,t.target.value)})]})]})]})}),e.jsx(ue,{title:"App settings (non-secret)",right:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-500",children:["Version: ",e.jsx("span",{className:"font-mono",children:H})]}),e.jsx(x,{variant:"ghost",onClick:()=>gt.mutate(),disabled:!Me.length||gt.isPending,children:gt.isPending?"Cleaning…":`Clean redundant (${Me.length})`}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings"]}),disabled:k.isFetching,children:k.isFetching?"Refreshing…":"Refresh"}),e.jsx(x,{onClick:()=>{try{for(const t of Te){const n=u[t];if(!n)continue;const s=le(n.default);Es(s,j[t]??"",be[t])}}catch(t){o.push({variant:"error",title:"Invalid input",message:W(t)});return}ht.mutate()},disabled:!Te.length||ht.isPending,children:ht.isPending?"Saving…":`Save (${Te.length})`})]}),children:e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-4 md:grid-cols-12",children:[e.jsxs("div",{className:"md:col-span-4 space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-2 text-xs font-medium text-zinc-600",children:[e.jsx("span",{children:"Search"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Ys(),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-50",children:"Reset"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>se(!0),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-50",children:"Ctrl+K"})]})]}),e.jsx(h,{ref:K,value:T,onChange:t=>U(t.target.value),placeholder:"Search key, hint text, examples…"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-2 text-xs font-medium text-zinc-600",children:[e.jsx("span",{children:"Scope"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{U(""),Re("all"),Ae(!1),Y(!1),b("/settings")},className:"rounded-lg px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-100",children:"Reset"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 rounded-xl border border-zinc-200 bg-white p-2",children:[{value:"all",label:"All"},{value:"public",label:"Public"},{value:"admin",label:"Admin"},{value:"server_only",label:"Server"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Re(t.value),className:_("rounded-lg px-2 py-1 text-[11px] font-semibold",q===t.value?"bg-zinc-900 text-white":"bg-white text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Favorites"}),e.jsxs("label",{className:"flex h-[42px] items-center gap-2 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:J,onChange:t=>{const n=t.target.checked;Y(n),b(n?"/settings/favorites":y==="all"?"/settings":`/settings/${y}`)}}),e.jsx("span",{children:"Show only"})]}),e.jsxs("div",{className:"mt-1 flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("span",{children:"Sync:"}),e.jsx("span",{className:_("rounded-full px-2 py-0.5 text-[10px] font-semibold",ie.state==="Saved"&&"bg-emerald-100 text-emerald-900",ie.state==="Saving"&&"bg-zinc-200 text-zinc-800",ie.state==="Offline"&&"bg-zinc-100 text-zinc-700",ie.state==="Error"&&"bg-rose-100 text-rose-900"),children:ie.state}),ie.detail?e.jsx("span",{className:"truncate text-zinc-500",children:ie.detail}):null]}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{rt(null),de.mutate(I),c.invalidateQueries({queryKey:["app-settings"]})},disabled:de.isPending,className:_("shrink-0 rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-700 hover:bg-zinc-50",de.isPending&&"opacity-50"),children:"Retry"})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Sort"}),e.jsx("div",{className:"flex flex-wrap gap-2 rounded-xl border border-zinc-200 bg-white p-2",children:[{value:"key_asc",label:"Key"},{value:"last_modified_desc",label:"Last modified"},{value:"favorites_first",label:"Favorites first"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Rt(t.value),className:_("rounded-lg px-3 py-2 text-xs font-semibold transition",ne===t.value?"bg-zinc-900 text-white":"bg-white text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Changed from default"}),e.jsxs("label",{className:"flex h-[42px] items-center gap-2 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:Ye,onChange:t=>Ae(t.target.checked)}),e.jsx("span",{children:"Show only overrides"}),e.jsx("span",{className:"ml-auto text-xs text-zinc-500",children:"(stored values)"})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2 text-xs font-medium text-zinc-600",children:"Categories"}),e.jsxs("div",{className:"max-h-[260px] overflow-auto rounded-xl border border-zinc-200 bg-white p-2",children:[e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Y(!0),C("all"),b("/settings/favorites")},className:_("flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",J?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[14px]",children:"⭐"}),e.jsx("span",{children:"Favorites"})]}),e.jsx("span",{className:"flex items-center gap-2",children:e.jsx("span",{className:_("text-xs",J?"text-white/80":"text-zinc-500"),children:I.filter(t=>!!u[t]).length})})]}),e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Y(!1),C("all"),b("/settings")},className:_("flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",y==="all"&&!J?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsx("span",{children:"all"}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:_("text-xs",y==="all"&&!J?"text-white/80":"text-zinc-500"),children:Object.keys(u).length}),Array.from(Ke.values()).reduce((t,n)=>t+n,0)>0&&e.jsx("span",{className:_("rounded-full px-2 py-0.5 text-[10px] font-medium",y==="all"&&!J?"bg-white/15 text-white":"bg-amber-100 text-amber-900"),children:Array.from(Ke.values()).reduce((t,n)=>t+n,0)})]})]}),Xt.filter(t=>t!=="all").map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Y(!1),C(t),b(`/settings/${t}`)},className:_("mt-1 flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",y===t&&!J?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsx("span",{className:"truncate",children:t}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:_("text-xs",y===t&&!J?"text-white/80":"text-zinc-500"),children:Wt.get(t)??0}),(Ke.get(t)??0)>0&&e.jsx("span",{className:_("rounded-full px-2 py-0.5 text-[10px] font-medium",y===t&&!J?"bg-white/15 text-white":"bg-amber-100 text-amber-900"),children:Ke.get(t)??0})]})]},t))]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Recently changed"}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings-history","recent"]}),disabled:R.isFetching,children:R.isFetching?"…":"Refresh"})]}),e.jsxs("div",{className:"max-h-[220px] overflow-auto rounded-xl border border-zinc-200 bg-white",children:[(((ys=R.data)==null?void 0:ys.rows)??[]).slice(0,20).map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>jt(t.key),className:"w-full border-b border-zinc-100 px-3 py-2 text-left hover:bg-zinc-50",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"truncate font-mono text-[11px] text-zinc-900",children:t.key}),e.jsx("div",{className:"shrink-0 text-[11px] text-zinc-500",children:new Date(t.changed_at).toLocaleString()})]}),t.change_reason?e.jsx("div",{className:"mt-1 line-clamp-1 text-[11px] text-zinc-600",children:t.change_reason}):null]},t.id)),(((ws=R.data)==null?void 0:ws.rows)??[]).length?null:e.jsx("div",{className:"px-3 py-3 text-sm text-zinc-500",children:"No recent changes."})]})]})]}),e.jsxs("div",{className:"md:col-span-8",children:[te?e.jsxs("div",{className:"mb-4 rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Settings home"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Pick a category to browse, or use search & filters to find a specific key."})]}),e.jsx(x,{variant:"ghost",onClick:()=>{C("all"),b("/settings/all")},children:"Browse all"})]}),e.jsx("div",{className:"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3",children:Xt.filter(t=>t!=="all").map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{C(t),b(`/settings/${t}`)},className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-left hover:bg-zinc-100",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:t}),e.jsx("div",{className:"text-xs text-zinc-600",children:Wt.get(t)??0})]}),e.jsx("div",{className:"mt-2 text-xs text-zinc-600",children:t==="assistant"?"Models, tokens, tool policies, orchestrator behavior.":t==="ux"?"UI copy, presence/seen rules, message UX flags.":t==="ranking"?"Taste &amp; trending weights, thresholds.":t==="moderation"?"Non-secret moderation filters &amp; limits.":t==="ops"?"Timeouts, retries, rate limits, job defaults.":t==="plan"?"Tier caps &amp; quotas.":t==="integrations"?"Non-secret endpoints &amp; integration toggles.":"Settings in this category."})]},t))})]}):null,e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Reason (optional)"}),e.jsx(h,{value:Xe,onChange:t=>Ot(t.target.value),placeholder:"Why are you changing these?"})]}),e.jsxs("div",{className:"space-y-4",children:[Ms.map(([t,n])=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:t}),e.jsx("div",{className:"space-y-2",children:n.map(s=>{const i=u[s],r=P.get(s),a=!!r,v=a&&pe(r==null?void 0:r.value,i.default),w=a&&!v,N=!!Ne[s],z=le(i.default),m=i.meta,$=ke(s,{default:i.default,description:i.description,meta:i.meta}),me=($==null?void 0:$.recommended)!==void 0;return e.jsxs("div",{id:`setting-${s}`,className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"truncate font-mono text-xs text-zinc-900",children:s}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>ls(s),title:"Copy key","aria-label":"Copy key",className:"inline-flex h-6 w-6 p-0 items-center justify-center rounded-full border border-zinc-200 bg-white text-[12px] font-semibold text-zinc-500 shadow-sm hover:text-zinc-700",children:"⧉"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Hs(s),title:vt(s)?"Unfavorite":"Favorite","aria-label":vt(s)?"Unfavorite":"Favorite",className:_("inline-flex h-6 w-6 items-center justify-center rounded-full border border-zinc-200 bg-white text-[12px] font-semibold shadow-sm",vt(s)?"text-amber-600":"text-zinc-400 hover:text-zinc-600"),children:"★"}),e.jsx(Z,{onClick:()=>V(s),title:"Explain this setting"}),e.jsx("span",{className:_("rounded-lg px-2 py-1 text-xs font-semibold",i.scope==="public"&&"bg-emerald-100 text-emerald-800",i.scope==="admin"&&"bg-zinc-200 text-zinc-800",i.scope==="server_only"&&"bg-blue-100 text-blue-800"),children:i.scope}),a?w?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-900",children:"overridden"}):e.jsx("span",{className:"rounded-full bg-purple-100 px-2 py-0.5 text-[10px] font-semibold text-purple-900",children:"redundant"}):e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-0.5 text-[10px] font-semibold text-zinc-700",children:"default"}),N?e.jsx("span",{className:"rounded bg-amber-100 px-2 py-1 text-[10px] font-semibold text-amber-800",children:"modified"}):null]}),e.jsx("div",{className:"mt-2 text-sm text-zinc-700",children:i.description}),e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:a?e.jsxs("span",{children:["stored v",(r==null?void 0:r.version)??"?"]}):e.jsx("span",{children:"using default"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>Vs(s),children:"Reset"}),e.jsx(x,{variant:"ghost",onClick:()=>jt(s),children:"History"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-4 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-8",children:[(m==null?void 0:m.kind)==="enum"?e.jsx("select",{value:j[s]??String(Ce(s)??""),onChange:p=>{M(S=>({...S,[s]:p.target.value})),B(s)},className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300",children:(m.values??[]).map(p=>e.jsx("option",{value:p,children:p},p))}):z==="boolean"?e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!be[s],onChange:p=>{Le(S=>({...S,[s]:p.target.checked})),B(s)}}),be[s]?"true":"false"]}):z==="json"?e.jsx("textarea",{value:j[s]??"",onChange:p=>{M(S=>({...S,[s]:p.target.value})),B(s)},rows:6,className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 font-mono text-xs text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300"}):z==="number"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{value:j[s]??"",onChange:p=>{M(S=>({...S,[s]:p.target.value})),B(s)},type:"number",min:(m==null?void 0:m.kind)==="number"?m.min:void 0,max:(m==null?void 0:m.kind)==="number"?m.max:void 0,step:(m==null?void 0:m.kind)==="number"&&m.int?1:"any"}),(m==null?void 0:m.kind)==="number"&&typeof m.min=="number"&&typeof m.max=="number"&&m.max-m.min<=1e4?e.jsx("input",{type:"range",min:m.min,max:m.max,step:m.int?1:.1,value:(()=>{const p=(j[s]??"").trim(),S=Number(p);if(p!==""&&Number.isFinite(S))return S;const _s=Number(Ce(s));return Number.isFinite(_s)?_s:m.min})(),onChange:p=>{M(S=>({...S,[s]:p.target.value})),B(s)},className:"w-full"}):null]}):e.jsx(h,{value:j[s]??"",onChange:p=>{M(S=>({...S,[s]:p.target.value})),B(s)},type:"text"}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsxs("div",{children:["Default: ",e.jsx("span",{className:"font-mono",children:z==="json"?"(json)":String(i.default)}),(m==null?void 0:m.kind)==="number"&&(typeof m.min=="number"||typeof m.max=="number")?e.jsxs("span",{className:"ml-2",children:["Range: ",e.jsxs("span",{className:"font-mono",children:[m.min??"-∞","…",m.max??"∞"]})]}):null]}),me?e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Ws(s),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-700 hover:bg-zinc-50",children:"Apply recommended"}):null]}),z==="json"?e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{try{const p=JSON.parse((j[s]??"").trim());M(S=>({...S,[s]:Q(p)})),B(s),o.push({variant:"success",title:"Formatted",message:"JSON formatted."})}catch(p){o.push({variant:"error",title:"Invalid JSON",message:W(p)})}},children:"Format JSON"}),e.jsx(x,{variant:"ghost",onClick:()=>{try{JSON.parse((j[s]??"").trim()),o.push({variant:"success",title:"Valid",message:"JSON is valid."})}catch(p){o.push({variant:"error",title:"Invalid JSON",message:W(p)})}},children:"Validate"})]}):null]}),e.jsx("div",{className:"lg:col-span-4",children:e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-700",children:"Suggested"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:me?($==null?void 0:$.recommended_why)??"Curated recommended value.":"Default value (matches current app behavior)."}),e.jsx("pre",{className:"mt-2 max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:Q(me?$==null?void 0:$.recommended:i.default)})]})})]})]},s)})})]},t)),pt.length?null:e.jsx("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4 text-sm text-zinc-500",children:"No matching settings."})]})]})]})}),e.jsx(Ee,{open:fe,title:"Jump to setting",onClose:()=>{se(!1)},children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Search by key, title, hint text, examples…"}),e.jsx("input",{ref:Mt,value:nt,onChange:t=>ce(t.target.value),onKeyDown:t=>{var n;if(t.key==="Escape"){t.preventDefault(),se(!1);return}if(t.key==="Enter"){t.preventDefault();const s=(n=ut[0])==null?void 0:n.key;s&&(se(!1),ce(""),He(s,{openDetails:!0}))}},placeholder:"e.g., ux.presence, tokens, rate limits…",className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-2 focus:ring-zinc-300"})]}),e.jsx("div",{className:"max-h-[55vh] overflow-auto rounded-xl border border-zinc-200",children:ut.length?e.jsx("div",{className:"divide-y divide-zinc-100",children:ut.map(t=>{const n=u[t.key],s=P.get(t.key),i=s?pe(s.value,n==null?void 0:n.default)?"redundant":"overridden":"default";return e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{se(!1),ce(""),He(t.key,{openDetails:!0})},className:"w-full px-3 py-2 text-left hover:bg-zinc-50",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-mono text-xs text-zinc-900",children:t.key}),e.jsx("div",{className:"mt-1 line-clamp-1 text-xs text-zinc-600",children:t.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:he(t.key)}),e.jsx("span",{className:_("rounded-full px-2 py-0.5 text-[10px] font-semibold",i==="default"&&"bg-zinc-100 text-zinc-700",i==="overridden"&&"bg-amber-100 text-amber-900",i==="redundant"&&"bg-purple-100 text-purple-900"),children:i})]})]}),t.description?e.jsx("div",{className:"mt-1 line-clamp-2 text-xs text-zinc-500",children:t.description}):null]},t.key)})}):e.jsx("div",{className:"px-3 py-3 text-sm text-zinc-500",children:"No matching settings."})}),e.jsxs("div",{className:"text-[11px] text-zinc-500",children:["Tip: press ",e.jsx("span",{className:"font-mono",children:"Enter"})," to jump to the top result. Each result opens the details drawer."]})]})}),e.jsx(un,{open:os,settingKey:g,entry:g?u[g]:null,row:g?P.get(g)??null:null,onNavigateToKey:t=>He(t,{openDetails:!0}),status:(()=>{if(!g)return;const t=u[g],n=P.get(g);if(t)return n?pe(n.value,t.default)?"redundant":"overridden":"default"})(),hint:g?ke(g,u[g]?{default:u[g].default,description:u[g].description,meta:u[g].meta}:void 0):null,effectiveValue:g?Ce(g):void 0,draftValue:g?Gs(g):void 0,recentHistory:((zs=Zs.data)==null?void 0:zs.rows)??[],onClose:Xs,onCopyKey:g?(()=>ls(g)):void 0,onOpenHistory:g?(()=>jt(g)):void 0,onApplyValue:g?(t=>ms(g,t)):void 0}),e.jsx(Ee,{open:qs,title:D?`History: ${D}`:"History",onClose:()=>{ns(!1),is(null)},children:ze.isPending?e.jsx("div",{className:"text-sm text-zinc-500",children:"Loading history…"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Range"}),e.jsxs("select",{value:qe,onChange:t=>{const n=Number(t.target.value);$s(n),D&&ze.mutate({key:D,limit:$e,since:we(n)})},className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300",children:[e.jsx("option",{value:0,children:"All"}),e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:30,children:"Last 30 days"}),e.jsx("option",{value:90,children:"Last 90 days"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Limit"}),e.jsx(h,{type:"number",value:String($e),min:1,max:200,onChange:t=>{const n=_e(t.target.value,1,200,50);Us(n),D&&ze.mutate({key:D,limit:n,since:we(qe)})}})]}),e.jsxs("div",{className:"ml-auto flex gap-2",children:[e.jsx("div",{className:"flex rounded-xl border border-zinc-200 bg-white p-1",children:[{value:"side_by_side",label:"Side-by-side"},{value:"diff",label:"Diff"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Rs(t.value),className:_("rounded-lg px-2 py-1 text-[11px] font-semibold transition",At===t.value?"bg-zinc-900 text-white":"text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))}),e.jsx(x,{variant:"ghost",onClick:cs,children:"Refresh"})]})]}),as.length?e.jsx("div",{className:"space-y-2",children:as.map(t=>e.jsxs("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-600",children:[e.jsxs("span",{className:"font-mono",children:["v",t.old_version??"—"," → v",t.new_version??"—"]}),e.jsx("span",{className:"mx-2",children:"·"}),e.jsx("span",{className:"font-mono",children:new Date(t.changed_at).toLocaleString()})]}),t.change_reason?e.jsxs("div",{className:"text-xs text-zinc-600",children:["Reason: ",t.change_reason]}):null]}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-500",children:["Changed by: ",e.jsx("span",{className:"font-mono",children:t.changed_by??"—"}),t.request_id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2",children:"·"}),"Req: ",e.jsx("span",{className:"font-mono",children:t.request_id})]}):null]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(x,{variant:"ghost",onClick:()=>Qs(t),children:"Rollback"})})]}),At==="diff"?e.jsx("div",{className:"mt-2",children:e.jsx(hn,{before:t.old_value,after:t.new_value})}):e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Old"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:Q(t.old_value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"New"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:Q(t.new_value)})]})]})]},t.id))}):e.jsx("div",{className:"text-sm text-zinc-500",children:"No history yet."})]})}),e.jsx(Ee,{open:Js,title:X?`Rollback: ${X.key}`:"Rollback",onClose:()=>{Se.isPending||(Ue(!1),Je(null),ye(""))},children:X?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900",children:["This will write a new settings update that restores the old value from version ",e.jsxs("span",{className:"font-mono",children:["v",X.old_version??"—"]}),". The change is audited and can be rolled back again."]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Reason (required)"}),e.jsx("textarea",{value:ft,onChange:t=>ye(t.target.value),rows:3,placeholder:"Example: Accidentally set too low; restoring previous safe value.",className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Will restore"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-zinc-50 p-2 text-xs",children:Q(X.old_value??(D?(Ss=u[D])==null?void 0:Ss.default:null)??null)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Current (from history row)"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-zinc-50 p-2 text-xs",children:Q(X.new_value)})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{Ue(!1),Je(null),ye("")},disabled:Se.isPending,children:"Cancel"}),e.jsx(x,{variant:"danger",onClick:()=>Se.mutate(),disabled:Se.isPending||ft.trim().length<3,children:Se.isPending?"Rolling back…":"Confirm rollback"})]})]}):e.jsx("div",{className:"text-sm text-zinc-500",children:"No rollback target selected."})})]})}export{zn as default};
