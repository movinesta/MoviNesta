import{u as U,r as h,j as e,L as M,B as m,a as R,i as H,k as V,l as G,m as O,n as W,p as X,R as Y,o as Z,q as ee}from"./index-CoY44SlW.js";import{u as J,E as p}from"./ErrorBox-CvgwTo6Q.js";import{u as w}from"./useMutation-CglkDXYR.js";import{C as D}from"./Card-DzyM45zw.js";import{T as L,a,b as r}from"./Table-BpO-pS4x.js";import{I as k}from"./Input-CFuN_OLj.js";import{E as F}from"./EmptyState-DaHQMra1.js";import{C as z}from"./CopyButton-DdPzwO7I.js";function se(n){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:n.children})}function te(n,i){if(!n||!i)return"—";const u=new Date(n).getTime(),o=new Date(i).getTime();if(!Number.isFinite(u)||!Number.isFinite(o))return"—";const d=Math.max(0,o-u);return d<1e3?`${d}ms`:`${Math.round(d/100)/10}s`}function ne(n){const{open:i,jobname:u,keepDays:o,setKeepDays:d,onClose:l,runs:C,isLoading:x,error:b,onPrune:S,pruning:_}=n;return Y.useEffect(()=>{if(!i)return;const t=g=>{g.key==="Escape"&&l()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[i,l]),i?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("button",{type:"button","aria-label":"Close",className:"absolute inset-0 bg-black/30",onClick:l}),e.jsxs("div",{className:"absolute right-0 top-0 flex h-full w-full max-w-3xl flex-col bg-white shadow-2xl",role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 border-b border-zinc-200 px-4 py-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:"Cron runs"}),e.jsx("div",{className:"mt-1 truncate font-mono text-sm text-zinc-900",children:u??"—"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:"Source: pg_cron run history (cron.job_run_details)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-xl border border-zinc-200 bg-zinc-50 px-2 py-1",children:[e.jsx("span",{className:"text-xs text-zinc-600",children:"Keep (days)"}),e.jsx(k,{value:String(o),onChange:t=>d(Number(t.target.value)||14),className:"w-20 py-1"}),e.jsx(m,{variant:"ghost",onClick:S,disabled:_,title:"Deletes cron.job_run_details rows older than Keep days",children:_?"Pruning…":"Prune"})]}),e.jsx(m,{type:"button",variant:"ghost",className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-xs font-semibold text-zinc-700 hover:bg-zinc-50",onClick:l,children:"Close"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[x?e.jsx(M,{}):null,b?e.jsx(p,{error:b}):null,!x&&!b?e.jsx(D,{title:"Recent runs",children:e.jsxs(L,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(a,{children:"Start"}),e.jsx(a,{children:"End"}),e.jsx(a,{children:"Duration"}),e.jsx(a,{children:"Status"}),e.jsx(a,{children:"Message"})]})}),e.jsx("tbody",{children:(C??[]).length?(C??[]).map(t=>e.jsxs("tr",{children:[e.jsx(r,{className:"text-xs text-zinc-700",children:t.start_time?R(t.start_time):"—"}),e.jsx(r,{className:"text-xs text-zinc-700",children:t.end_time?R(t.end_time):"—"}),e.jsx(r,{className:"font-mono text-xs",children:te(t.start_time,t.end_time)}),e.jsx(r,{className:"font-mono text-xs",children:t.status??"—"}),e.jsx(r,{className:"max-w-[360px] truncate font-mono text-xs",title:t.return_message??"",children:t.return_message??"—"})]},String(t.runid))):e.jsx("tr",{children:e.jsx(r,{colSpan:5,className:"p-6",children:e.jsx(F,{title:"No runs found",message:"This job has no recorded runs yet.",className:"border-0 bg-transparent p-0"})})})})]})}):null]})]})]}):null}const q={cursorSearch:"",cronSearch:""};function me(){var B;const n=U(),[i,u]=h.useState(q.cursorSearch),[o,d]=h.useState(q.cronSearch),[l,C]=h.useState({}),[x,b]=h.useState(null),[S,_]=h.useState(14),t=J({queryKey:["jobs"],queryFn:()=>Z()}),g=J({queryKey:["jobs","runs",x],queryFn:()=>ee(x,30),enabled:!!x}),v=w({mutationFn:s=>V(s,null),onSuccess:async()=>{await n.invalidateQueries({queryKey:["jobs"]}),await n.invalidateQueries({queryKey:["overview"]})}}),f=w({mutationFn:s=>G(s.jobname,s.active),onSuccess:async()=>{await n.invalidateQueries({queryKey:["jobs"]}),await n.invalidateQueries({queryKey:["overview"]})}}),N=w({mutationFn:s=>O(s.jobname,s.schedule),onSuccess:async()=>{await n.invalidateQueries({queryKey:["jobs"]}),await n.invalidateQueries({queryKey:["overview"]})}}),y=w({mutationFn:s=>W(s),onSuccess:async()=>{await n.invalidateQueries({queryKey:["jobs"]}),await n.invalidateQueries({queryKey:["logs"]}),await n.invalidateQueries({queryKey:["overview"]})}}),K=w({mutationFn:s=>X(s),onSuccess:async()=>{await n.invalidateQueries({queryKey:["jobs","runs"]})}}),Q=v.isPending||f.isPending||N.isPending||y.isPending||K.isPending,c=t.data,P=h.useMemo(()=>{if(!c)return[];const s=i.trim().toLowerCase();return s?c.job_state.filter(j=>j.job_name.toLowerCase().includes(s)||(j.cursor??"").toLowerCase().includes(s)):c.job_state},[c,i]),E=h.useMemo(()=>{if(!c)return[];const s=o.trim().toLowerCase();return s?c.cron_jobs.filter(j=>j.jobname.toLowerCase().includes(s)||String(j.jobid).includes(s)):c.cron_jobs},[c,o]);if(t.isLoading)return e.jsx(M,{});if(t.error)return e.jsx(p,{error:t.error});const T=c,A=[i.trim()?`cursors: "${i.trim()}"`:null,o.trim()?`cron: "${o.trim()}"`:null].filter(Boolean);function $(){u(q.cursorSearch),d(q.cronSearch)}return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(se,{children:"Jobs"}),A.length?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Applied: ",e.jsx("span",{className:"font-mono",children:A.join(" • ")})]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No filters applied."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(m,{variant:"ghost",onClick:$,disabled:Q,children:"Reset filters"})})]}),e.jsxs(D,{title:"Saved job cursors (media_job_state)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(k,{value:i,onChange:s=>u(s.target.value),placeholder:"Filter by job name or cursor…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[P.length," rows"]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs(L,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(a,{children:"Job"}),e.jsx(a,{children:"Cursor"}),e.jsx(a,{children:"Updated"}),e.jsx(a,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:P.length?P.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.job_name}),e.jsx(z,{text:String(s.job_name),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.cursor??"—"}),s.cursor?e.jsx(z,{text:String(s.cursor),label:"Copy",className:"h-8 px-2 py-1 text-xs"}):null]})}),e.jsx(r,{className:"text-xs text-zinc-600",children:s.updated_at?R(s.updated_at):"—"}),e.jsx(r,{className:"text-right",children:e.jsx(m,{variant:"ghost",onClick:()=>v.mutate(s.job_name),disabled:v.isPending,title:"Reset stored cursor to null",children:"Reset cursor"})})]},s.job_name)):e.jsx("tr",{children:e.jsx(r,{colSpan:4,className:"p-6",children:e.jsx(F,{title:"No saved cursors",message:"No rows in media_job_state yet.",className:"border-0 bg-transparent p-0"})})})})]}),v.isError?e.jsx(p,{error:v.error,className:"mt-2"}):null]})]}),e.jsxs(D,{title:"Cron jobs (pg_cron)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(k,{value:o,onChange:s=>d(s.target.value),placeholder:"Filter cron jobs…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[E.length," rows"]})]}),T.cron_error?e.jsxs("div",{className:"mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:[e.jsx("div",{className:"font-semibold",children:"Cron error"}),e.jsx("div",{className:"mt-1 font-mono text-xs",children:T.cron_error})]}):null,e.jsxs("div",{className:"mt-3",children:[e.jsxs(L,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(a,{children:"ID"}),e.jsx(a,{children:"Name"}),e.jsx(a,{children:"Schedule"}),e.jsx(a,{children:"Status"}),e.jsx(a,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:E.length?E.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobid??"—"}),e.jsx(z,{text:String(s.jobid??""),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobname}),e.jsx(z,{text:String(s.jobname),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"w-[220px]",children:e.jsx(k,{value:l[s.jobname]??s.schedule??"",onChange:j=>C(I=>({...I,[s.jobname]:j.target.value})),placeholder:"* * * * *",className:"py-1"})}),e.jsx(m,{variant:"ghost",onClick:()=>N.mutate({jobname:s.jobname,schedule:(l[s.jobname]??s.schedule??"").trim()}),disabled:N.isPending||!(l[s.jobname]??s.schedule??"").trim(),children:"Save"})]})}),e.jsx(r,{children:e.jsx("span",{className:H("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold",s.active?"border-emerald-200 bg-emerald-50 text-emerald-800":"border-zinc-200 bg-zinc-50 text-zinc-700"),children:s.active?"Active":"Paused"})}),e.jsx(r,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(m,{variant:"ghost",onClick:()=>f.mutate({jobname:s.jobname,active:!s.active}),disabled:f.isPending,children:s.active?"Pause":"Activate"}),e.jsx(m,{variant:"ghost",onClick:()=>b(s.jobname),disabled:Q,title:"View recent runs",children:"Runs"}),e.jsx(m,{variant:"ghost",onClick:()=>y.mutate(s.jobname),disabled:y.isPending,title:"Run this cron immediately",children:"Run now"})]})})]},s.jobname)):e.jsx("tr",{children:e.jsx(r,{colSpan:5,className:"p-6",children:e.jsx(F,{title:"No cron jobs",message:"No cron jobs registered (or pg_cron not enabled).",className:"border-0 bg-transparent p-0"})})})})]}),f.isError?e.jsx(p,{error:f.error,className:"mt-2"}):null,N.isError?e.jsx(p,{error:N.error,className:"mt-2"}):null,y.isError?e.jsx(p,{error:y.error,className:"mt-2"}):null]}),e.jsx(ne,{open:!!x,jobname:x,keepDays:S,setKeepDays:_,onClose:()=>b(null),runs:((B=g.data)==null?void 0:B.runs)??null,isLoading:g.isLoading,error:g.error,onPrune:()=>K.mutate(S),pruning:K.isPending})]})]})}export{me as default};
