import{r as l,j as e,e as k,u as nn,n as an,Q as rn,S as ln,L as cn,B as x,T as X,U as on,V as dn,W as xn,X as mn,Y as Rs,Z as Ct,_ as kt,$ as un,a0 as pn}from"./index-CGWJK-B7.js";import{u as Be,E as hn}from"./ErrorBox-DGVAxfkB.js";import{u as W}from"./useMutation-CEd-E173.js";import{C as ue}from"./Card-BfoASP6-.js";import{g as ke,H as G,S as gn}from"./settingsHints-BuWRe4Tj.js";import{I as p}from"./Input-5czXp4bm.js";function fn(c,o,b){const f=b==null?void 0:b.maxLines,K=c.split(`
`),ee=o.split(`
`),h=K.length>f?[...K.slice(0,f),`… (truncated ${K.length-f} lines)`]:K,R=ee.length>f?[...ee.slice(0,f),`… (truncated ${ee.length-f} lines)`]:ee,I=h.length,C=R.length,M=Array.from({length:I+1},()=>new Array(C+1).fill(0));for(let q=I-1;q>=0;q--)for(let $=C-1;$>=0;$--)M[q][$]=h[q]===R[$]?M[q+1][$+1]+1:Math.max(M[q+1][$],M[q][$+1]);const te=[];let N=0,y=0;for(;N<I&&y<C;){if(h[N]===R[y]){te.push({type:"equal",line:h[N]}),N++,y++;continue}M[N+1][y]>=M[N][y+1]?(te.push({type:"del",line:h[N]}),N++):(te.push({type:"add",line:R[y]}),y++)}for(;N<I;)te.push({type:"del",line:h[N]}),N++;for(;y<C;)te.push({type:"add",line:R[y]}),y++;return te}function As(c){try{return c===void 0?"undefined":JSON.stringify(c,null,2)}catch{try{return String(c)}catch{return"[unprintable]"}}}function vn(c){const{before:o,after:b,className:f}=c,[K,ee]=l.useState(!1),h=l.useMemo(()=>As(o),[o]),R=l.useMemo(()=>As(b),[b]),I=l.useMemo(()=>fn(h,R,{maxLines:350}),[h,R]);return e.jsxs("div",{className:k("rounded-xl border border-zinc-200 bg-white",f),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 border-b border-zinc-200 px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-700",children:"Diff"}),e.jsxs("label",{className:"flex items-center gap-2 text-[11px] text-zinc-600",children:[e.jsx("input",{type:"checkbox",checked:K,onChange:C=>ee(C.target.checked)}),"Show unchanged"]})]}),e.jsx("pre",{className:"max-h-60 overflow-auto px-3 py-2 text-xs leading-5",children:I.filter(C=>K||C.type!=="equal").map((C,M)=>e.jsxs("div",{className:k("whitespace-pre",C.type==="add"&&"bg-emerald-50 text-emerald-900",C.type==="del"&&"bg-rose-50 text-rose-900",C.type==="equal"&&"text-zinc-600"),children:[e.jsx("span",{className:"select-none font-mono opacity-60",children:C.type==="add"?"+":C.type==="del"?"-":" "})," ",C.line]},M))})]})}function jn(c){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:c.children})}function V(c){try{return JSON.stringify(c,null,2)}catch{return String(c)}}function Ve(c){if(c==null)return String(c);const o=typeof c;if(o==="string")return JSON.stringify(c);if(o==="number"||o==="boolean")return String(c);if(Array.isArray(c))return`[${c.map(b=>Ve(b)).join(",")}]`;if(o==="object")return`{${Object.keys(c).sort().map(K=>`${JSON.stringify(K)}:${Ve(c[K])}`).join(",")}}`;try{return JSON.stringify(c)}catch{return String(c)}}function pe(c,o){return Ve(c)===Ve(o)}function ce(c){return typeof c=="string"?"string":typeof c=="number"?"number":typeof c=="boolean"?"boolean":"json"}function Os(c,o,b){if(c==="boolean")return!!b;if(c==="number"){const f=Number(o);if(!Number.isFinite(f))throw new Error("Invalid number");return Number.isInteger(f),f}if(c==="json"){const f=o.trim();if(!f)throw new Error("Empty JSON");return JSON.parse(f)}return o}function he(c){return c.split(".")[0]??"other"}function bn(c){const o=c.split(".");return o.length>=2?`${o[0]}.${o[1]}`:o[0]??"other"}function Ee(c){return l.useEffect(()=>{if(!c.open)return;const o=b=>{b.key==="Escape"&&c.onClose()};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[c.open,c.onClose]),c.open?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",role:"dialog","aria-modal":"true",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:c.onClose}),e.jsxs("div",{className:"relative w-full max-w-3xl rounded-2xl border border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:c.title}),e.jsx(x,{variant:"ghost",className:"rounded-lg px-2 py-1 text-xs text-zinc-500 hover:bg-zinc-100",onClick:c.onClose,children:"✕"})]}),e.jsx("div",{className:"mt-4",children:c.children})]})]}):null}function Cn(){var gs,fs,vs,js,bs,Ns,ys,ws,zs,Ss,_s,Cs,ks;const c=nn(),o=an(),b=rn(),f=ln(),K=f==null?void 0:f.category,ee=!K,h=Be({queryKey:["app-settings"],queryFn:un}),R=Be({queryKey:["app-settings-history","recent"],queryFn:()=>kt({limit:20}),staleTime:1e4}),I=Be({queryKey:["app-settings-presets"],queryFn:pn,staleTime:3e4}),[C,M]=l.useState(""),te=l.useRef(null),[N,y]=l.useState("all"),[q,$]=l.useState("all"),[U,Q]=l.useState(!1),[Qe,Re]=l.useState(!1),[ie,Et]=l.useState(()=>{const t=localStorage.getItem("mn_admin_settings_sort");return t==="key_asc"||t==="last_modified_desc"||t==="favorites_first"?t:"key_asc"});l.useEffect(()=>{try{localStorage.setItem("mn_admin_settings_sort",ie)}catch{}},[ie]);const[Rt,Is]=l.useState("side_by_side"),[Ye,At]=l.useState(""),[Ps,ge]=l.useState(!1),[Ds,Xe]=l.useState(null),[Ot,It]=l.useState(null),[Z,We]=l.useState(null),[E,Ge]=l.useState(null),[Pt,Ze]=l.useState(null),[Dt,et]=l.useState(""),[Ft,Ae]=l.useState(!1),[tt,Lt]=l.useState(!1),[fe,se]=l.useState(!1),[st,oe]=l.useState(""),Kt=l.useRef(null);l.useEffect(()=>{function t(n){const s=(n.key??"").toLowerCase();(n.ctrlKey||n.metaKey)&&s==="k"&&(n.preventDefault(),se(!0),oe(""))}return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),l.useEffect(()=>{if(!fe)return;const t=setTimeout(()=>{var n;return(n=Kt.current)==null?void 0:n.focus()},0);return()=>clearTimeout(t)},[fe]),l.useEffect(()=>{const t=f==null?void 0:f.category;if(typeof t=="string"&&t.trim()){if(t==="favorites"){y("all"),Q(!0);return}Q(!1),y(t);return}Q(!1),y("all")},[f==null?void 0:f.category]);const[P,Mt]=l.useState(()=>{try{const t=localStorage.getItem("mn_admin_settings_favs_v1"),n=t?JSON.parse(t):[];return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}),[ve,Tt]=l.useState(!1),[Oe,qt]=l.useState(""),[je,nt]=l.useState("fallback"),[it,at]=l.useState(null);function de(t){return t.slice().sort().join("|")}l.useEffect(()=>{try{localStorage.setItem("mn_admin_settings_favs_v1",JSON.stringify(P))}catch{}},[P]),l.useEffect(()=>{var n;if(!h.data)return;const t=(n=h.data)==null?void 0:n.favorites_storage;(t==="db"||t==="fallback")&&nt(t)},[h.data]),l.useEffect(()=>{var z,S;if(!h.data)return;const t=(z=h.data)==null?void 0:z.favorites;if(!Array.isArray(t)){ve||Tt(!0);return}let n=[];try{const d=localStorage.getItem("mn_admin_settings_favs_v1"),O=d?JSON.parse(d):[];n=Array.isArray(O)?O.filter(ne=>typeof ne=="string"):[]}catch{n=[]}const s=Array.from(new Set([...t,...n].filter(d=>typeof d=="string"))),i=de(s),r=de(n),a=de(t);i!==r&&Mt(s);const w=((S=h.data)==null?void 0:S.favorites_storage)==="db"?"db":"fallback";w!==je&&nt(w),qt(w==="db"?a:i),Tt(!0)},[h.data]);const xe=W({mutationFn:async t=>on({favorites:t}),onSuccess:t=>{const n=t.favorites??[];qt(de(n)),(t.favorites_storage==="db"||t.favorites_storage==="fallback")&&nt(t.favorites_storage),at(null)},onError:t=>{at((t==null?void 0:t.message)??"Failed to sync favorites")}});l.useEffect(()=>{var s,i;if(!ve||!((i=(s=h.data)==null?void 0:s.actor)!=null&&i.userId)||je!=="db"||de(P)===Oe)return;const n=setTimeout(()=>{xe.mutate(P)},500);return()=>clearTimeout(n)},[P,ve,Oe,(fs=(gs=h.data)==null?void 0:gs.actor)==null?void 0:fs.userId,je]);const ae=l.useMemo(()=>{if(je!=="db")return{state:"Offline",detail:"Server storage not available"};if(xe.isPending)return{state:"Saving",detail:null};const t=ve&&de(P)!==Oe;return it?{state:"Error",detail:it}:t?{state:"Saving",detail:null}:{state:"Saved",detail:null}},[je,xe.isPending,ve,P,Oe,it]),rt=W({mutationFn:async t=>dn({slug:t}),onSuccess:(t,n)=>{Xe(null),It(n),We(t.preset??null),Ge(t.preview??null),Ze(t.message??null),et(""),Ae(!1),Lt(!1),ge(!0)},onError:t=>{Xe(null),o.push({variant:"error",title:"Preset preview failed",message:(t==null?void 0:t.message)??"Could not load preset preview."})}}),$t=W({mutationFn:async()=>{if(!Ot)throw new Error("No preset selected");const t=Dt.trim();if(!t)throw new Error("Reason is required");return xn({slug:Ot,expected_version:J,reason:t})},onSuccess:t=>{o.push({variant:"success",title:"Preset applied",message:`${t.preset_slug}: updated ${t.updated_keys.length}, reset ${t.deleted_keys.length}.`}),ge(!1),It(null),We(null),Ge(null),Ze(null),et(""),Ae(!1),c.invalidateQueries({queryKey:["app-settings"]}),c.invalidateQueries({queryKey:["app-settings-history"]}),c.invalidateQueries({queryKey:["app-settings-history","recent"]})},onError:t=>{o.push({variant:"error",title:"Preset apply failed",message:(t==null?void 0:t.message)??"Could not apply preset."})}});function Fs(t){Xe(t),Ze(null),Ge(null),We(null),rt.mutate(t)}const[lt,Ls]=l.useState(["public","admin","server_only"]),[re,Ut]=l.useState(""),[Ie,Ks]=l.useState(["public","admin","server_only"]),[ct,Ms]=l.useState(!1),[ot,Ts]=l.useState(""),[qs,Pe]=l.useState(!1),[A,Jt]=l.useState(null),[Ht,dt]=l.useState(""),[Bt,De]=l.useState(!1),[j,T]=l.useState({}),[be,Fe]=l.useState({}),[Ne,Vt]=l.useState({}),m=((vs=h.data)==null?void 0:vs.registry)??{},Qt=((js=h.data)==null?void 0:js.rows)??[],J=((bs=h.data)==null?void 0:bs.version)??0,D=l.useMemo(()=>{const t=new Map;for(const n of Qt)t.set(n.key,n);return t},[Qt]),xt=l.useMemo(()=>{var n;const t=new Map;for(const[s,i]of D.entries())if(i!=null&&i.updated_at){const r=Date.parse(i.updated_at);Number.isFinite(r)&&t.set(s,r)}for(const s of((n=R.data)==null?void 0:n.rows)??[]){const i=Date.parse(s.changed_at);if(!Number.isFinite(i))continue;const r=t.get(s.key);(r===void 0||i>r)&&t.set(s.key,i)}return t},[D,R.data]);l.useEffect(()=>{if(!h.data)return;const t={},n={};for(const[s,i]of Object.entries(m)){const r=D.get(s),a=r?r.value:i.default,v=ce(i.default);v==="boolean"?n[s]=!!a:v==="json"?t[s]=V(a):t[s]=a==null?"":String(a)}T(t),Fe(n),Vt({})},[h.data]);const Yt=l.useMemo(()=>{const t=new Set;for(const n of Object.keys(m))t.add(he(n));return["all",...Array.from(t).sort()]},[m]),Xt=l.useMemo(()=>{const t=new Map;for(const n of Object.keys(m)){const s=he(n);t.set(s,(t.get(s)??0)+1)}return t},[m]),mt=l.useMemo(()=>{if(!fe)return[];const t=st.trim().toLowerCase(),n=Object.keys(m),s=[];for(const i of n){const r=m[i],a=ke(i,r?{default:r.default,description:r.description,meta:r.meta}:void 0),v=(a==null?void 0:a.title)??i,w=(r==null?void 0:r.description)??"",z=(a==null?void 0:a.details)??"",S=((a==null?void 0:a.examples)??[]).map(_=>`${_.scenario} ${_.effect}`).join(" "),d=((a==null?void 0:a.related)??[]).join(" "),O=String((a==null?void 0:a.recommended_why)??""),ne=`${i} ${v} ${w} ${z} ${S} ${d} ${O}`.toLowerCase();let u=0;t?i.toLowerCase()===t?u=2e3:i.toLowerCase().startsWith(t)?u=1500:i.toLowerCase().includes(t)?u=900:v.toLowerCase().includes(t)?u=600:w.toLowerCase().includes(t)?u=450:z.toLowerCase().includes(t)?u=350:ne.includes(t)&&(u=200):u=1,u>0&&s.push({key:i,title:v,description:w,score:u})}return s.sort((i,r)=>r.score-i.score||i.key.localeCompare(r.key)),s.slice(0,30)},[fe,st,m]),Le=l.useMemo(()=>{const t=new Map;for(const n of Object.keys(m)){const s=m[n],i=D.get(n);if(!i||pe(i.value,s==null?void 0:s.default))continue;const r=he(n);t.set(r,(t.get(r)??0)+1)}return t},[m,D]),Ke=l.useMemo(()=>{const t=[];for(const n of Object.keys(m)){const s=m[n],i=D.get(n);i&&pe(i.value,s==null?void 0:s.default)&&t.push(n)}return t.sort(),t},[m,D]),ut=l.useMemo(()=>{const t=C.trim().toLowerCase(),n=Object.keys(m).filter(s=>{var w;if(N!=="all"&&he(s)!==N||q!=="all"&&((w=m[s])==null?void 0:w.scope)!==q||U&&!P.includes(s))return!1;if(Qe){const z=m[s],S=D.get(s);if(!S||pe(S.value,z==null?void 0:z.default))return!1}if(!t)return!0;const i=m[s],r=(i==null?void 0:i.description)??"",a=ke(s,{default:i==null?void 0:i.default,description:i==null?void 0:i.description,meta:i==null?void 0:i.meta});return[s,r,(a==null?void 0:a.title)??"",(a==null?void 0:a.details)??"",(a==null?void 0:a.recommended_why)??"",(a==null?void 0:a.caution)??"",...(a==null?void 0:a.related)??[],...((a==null?void 0:a.examples)??[]).flatMap(z=>[z.scenario,z.effect])].join(`
`).toLowerCase().includes(t)});return ie==="key_asc"?n.sort():ie==="favorites_first"?n.sort((s,i)=>{const r=P.includes(s)?1:0,a=P.includes(i)?1:0;return a!==r?a-r:s.localeCompare(i)}):ie==="last_modified_desc"&&n.sort((s,i)=>{const r=xt.get(s)??0,a=xt.get(i)??0;return a!==r?a-r:s.localeCompare(i)}),n},[m,C,N,q,U,P,Qe,D,ie,xt]),$s=l.useMemo(()=>{const t=new Map;for(const n of ut){const s=bn(n),i=t.get(s);i?i.push(n):t.set(s,[n])}return Array.from(t.entries()).sort((n,s)=>n[0].localeCompare(s[0]))},[ut]),Me=l.useMemo(()=>Object.keys(Ne).filter(t=>Ne[t]),[Ne]);function Us(t,n){try{const s=new Blob([n],{type:"application/json"}),i=URL.createObjectURL(s),r=document.createElement("a");r.href=i,r.download=t,r.click(),URL.revokeObjectURL(i)}catch{}}function Wt(t,n){return t.includes(n)?t.filter(s=>s!==n):[...t,n]}function Gt(t){const n=t.trim();if(!n)throw new Error("Import JSON is empty");return JSON.parse(n)}const Zt=W({mutationFn:async()=>{if(!lt.length)throw new Error("Select at least one scope to export");return mn({scopes:lt})},onSuccess:t=>{const n=V(t.bundle);Ut(n),o.push({variant:"success",title:"Export ready",message:"Settings bundle generated."})},onError:t=>{o.push({variant:"error",title:"Export failed",message:X(t)})}}),es=W({mutationFn:async()=>{if(!Ie.length)throw new Error("Select at least one scope to import");const t=Gt(ot);return Rs({mode:"dry_run",bundle:t,scopes:Ie,delete_missing:ct})},onSuccess:t=>{Jt(t.preview??null),dt(""),De(!1),Pe(!0)},onError:t=>{o.push({variant:"error",title:"Preview failed",message:X(t),durationMs:6e3})}}),ts=W({mutationFn:async()=>{if(!A)throw new Error("Run a preview first");if(!Bt)throw new Error("Confirm before applying");const t=Ht.trim();if(!t)throw new Error("Reason is required");const n=Gt(ot);return Rs({mode:"apply",bundle:n,scopes:Ie,delete_missing:ct,expected_version:J>0?J:void 0,reason:t})},onSuccess:async()=>{o.push({variant:"success",title:"Import applied",message:"Settings updated."}),Pe(!1),Jt(null),dt(""),De(!1),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Import failed",message:X(t),durationMs:6e3})}}),pt=W({mutationFn:async()=>{const t={};for(const n of Me){const s=m[n];if(!s)continue;const i=ce(s.default),r=j[n]??"",a=be[n];t[n]=Os(i,r,a)}return Ct({expected_version:J>0?J:void 0,updates:t,reason:Ye.trim()||void 0})},onSuccess:async t=>{var v,w,z,S;const n=((v=t==null?void 0:t.updated_keys)==null?void 0:v.length)??0,s=((w=t==null?void 0:t.deleted_keys)==null?void 0:w.length)??0,i=((z=t==null?void 0:t.same_keys)==null?void 0:z.length)??0,r=((S=t==null?void 0:t.ignored_default_keys)==null?void 0:S.length)??0,a=[];n&&a.push(`updated ${n}`),s&&a.push(`reset ${s}`),i&&a.push(`no-op ${i}`),r&&a.push(`already default ${r}`),o.push({variant:"success",title:"Settings saved",message:a.length?a.join(", ")+".":"No changes."}),At(""),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Save failed",message:X(t),durationMs:6e3})}}),ht=W({mutationFn:async()=>{if(!Ke.length)throw new Error("No redundant overrides to clean");const t={};for(const i of Ke){const r=m[i];r&&(t[i]=r.default)}const n=Ye.trim(),s=n?`Cleanup redundant overrides: ${n}`:"Cleanup redundant overrides";return Ct({expected_version:J>0?J:void 0,updates:t,reason:s})},onSuccess:async t=>{var s;const n=((s=t==null?void 0:t.deleted_keys)==null?void 0:s.length)??0;o.push({variant:"success",title:"Cleaned up",message:n?`Removed ${n} redundant override(s).`:"Nothing to remove."}),await c.invalidateQueries({queryKey:["app-settings"]})},onError:t=>{o.push({variant:"error",title:"Cleanup failed",message:X(t)})}}),[Js,ss]=l.useState(!1),[F,ns]=l.useState(null),[is,as]=l.useState([]),[Te,Hs]=l.useState(30),[qe,Bs]=l.useState(50),[Vs,$e]=l.useState(!1),[Y,Ue]=l.useState(null),[gt,ye]=l.useState("");function we(t){if(!t||t<=0)return;const n=t*24*60*60*1e3;return new Date(Date.now()-n).toISOString()}const ze=W({mutationFn:async t=>kt(t),onSuccess:t=>as(t.rows??[]),onError:t=>{o.push({variant:"error",title:"History failed",message:X(t)})}}),Se=W({mutationFn:async()=>{if(!F||!Y)throw new Error("No rollback target selected");const t=gt.trim();if(!t)throw new Error("Rollback reason is required");const n=m[F];if(!n)throw new Error("Unknown setting key");const s=Y.old_value===null||Y.old_value===void 0?n.default:Y.old_value;return Ct({expected_version:J>0?J:void 0,updates:{[F]:s},reason:`Rollback: ${t}`})},onSuccess:async()=>{o.push({variant:"success",title:"Rolled back",message:"Setting restored to the previous value."}),$e(!1),Ue(null),ye(""),await c.invalidateQueries({queryKey:["app-settings"]}),ls()},onError:t=>{o.push({variant:"error",title:"Rollback failed",message:X(t)})}});function H(t){Vt(n=>({...n,[t]:!0}))}function ft(t){return P.includes(t)}function Qs(t){Mt(n=>n.includes(t)?n.filter(s=>s!==t):[...n,t])}async function Ys(t){var n;try{if((n=navigator==null?void 0:navigator.clipboard)!=null&&n.writeText)return await navigator.clipboard.writeText(t),!0}catch{}try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.left="-9999px",document.body.appendChild(s),s.focus(),s.select();const i=document.execCommand("copy");return document.body.removeChild(s),i}catch{return!1}}async function rs(t){const n=await Ys(t);o.push({variant:n?"success":"error",title:n?"Copied":"Copy failed",message:n?t:"Could not copy to clipboard."})}function Xs(t){const n=m[t];if(!n)return;const s=ce(n.default);s==="boolean"?Fe(i=>({...i,[t]:!!n.default})):T(s==="json"?i=>({...i,[t]:V(n.default)}):i=>({...i,[t]:String(n.default)})),H(t)}function vt(t){ns(t),ss(!0),as([]),ze.mutate({key:t,limit:qe,since:we(Te)})}function ls(){F&&ze.mutate({key:F,limit:qe,since:we(Te)})}function Ws(t){F&&(Ue(t),ye(""),$e(!0))}const[cs,os]=l.useState(!1),[g,ds]=l.useState(null);function B(t){ds(t),os(!0)}function Je(t,n){const s=he(t);M(""),$("all"),Q(!1),Re(!1),se(!1),oe(""),y(s),K!==s&&b(`/settings/${s}`),n!=null&&n.openDetails&&B(t);let i=0;const r=()=>{const a=document.getElementById(`setting-${t}`);if(a){a.scrollIntoView({behavior:"smooth",block:"start"});return}i++<10&&requestAnimationFrame(r)};setTimeout(()=>requestAnimationFrame(r),0)}function Gs(t){M(""),$("all"),Q(!1),Re(!1),Et("key_asc"),se(!1),oe(""),y("all"),b("/settings")}function Zs(){os(!1),ds(null)}function xs(t,n){const s=m[t];if(!s)return;const i=ce(s.default);i==="boolean"?Fe(r=>({...r,[t]:!!n})):T(i==="json"?r=>({...r,[t]:V(n)}):r=>({...r,[t]:String(n)})),H(t)}function en(t){const n=m[t],s=ke(t,n?{default:n.default,description:n.description,meta:n.meta}:void 0);s.recommended!==void 0&&xs(t,s.recommended)}const jt="ops.rate_limits",me="assistant.tool_result_truncation",bt="assistant.reply_runner.backoff",Nt="admin.users.page_limit",ms="admin.users.ban_duration_days",yt="admin.overview.recent_errors_limit",us="admin.overview.last_job_runs_limit",wt="admin.audit.default_limit",zt="ux.assistant.username",St="ux.presence.label_online",ps="ux.presence.label_active_recently",hs="ux.presence.label_active_prefix",_t="ux.messages.search.min_query_chars";function _e(t,n,s,i){const r=Number(t);if(!Number.isFinite(r))return i;const a=Math.trunc(r);return Math.max(n,Math.min(s,a))}function Ce(t){const n=m[t];if(!n)return;const s=D.get(t);return s?s.value:n.default}function le(t){const n=j[t];if(typeof n=="string"&&n.trim())try{return JSON.parse(n)}catch{}return Ce(t)}function He(t,n){T(s=>({...s,[t]:V(n)})),H(t)}function L(t,n){T(s=>({...s,[t]:n})),H(t)}function tn(t){const n=m[t];if(!n)return;if(!Ne[t])return Ce(t);const s=ce(n.default);if(s==="boolean")return!!be[t];if(s==="json")return le(t);const i=(j[t]??"").trim();if(s==="number"){const r=Number(i);return Number.isFinite(r)?(Number.isInteger(r),r):i}return i}const sn=Be({queryKey:["app-settings-history","drawer",g??"none"],enabled:cs&&!!g,queryFn:async()=>g?kt({key:g,limit:5,since:we(90)}):{ok:!0,rows:[]}});return h.isLoading?e.jsx(cn,{}):h.error?e.jsx(hn,{error:h.error}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(jn,{children:"Settings"}),e.jsx(ue,{title:"Export / Import settings",right:e.jsxs("div",{className:"text-xs text-zinc-500",children:["Current version: ",e.jsx("span",{className:"font-mono",children:J})]}),children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Export bundle"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Export non-secret settings as JSON for backup or promotion between environments."}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs",children:[["public","admin","server_only"].map(t=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:lt.includes(t),onChange:()=>Ls(n=>Wt(n,t))}),e.jsx("span",{className:"font-mono",children:t})]},t)),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx(x,{onClick:()=>Zt.mutate(),disabled:Zt.isPending,children:"Export"}),e.jsx(x,{variant:"secondary",onClick:()=>{var t;re.trim()&&((t=navigator.clipboard)==null||t.writeText(re).then(()=>{o.push({variant:"success",title:"Copied",message:"Export JSON copied to clipboard."})}).catch(()=>{o.push({variant:"error",title:"Copy failed",message:"Could not copy to clipboard."})}))},disabled:!re.trim(),children:"Copy"}),e.jsx(x,{variant:"secondary",onClick:()=>{if(!re.trim())return;const t=new Date().toISOString().replace(/[:.]/g,"-");Us(`movinesta-app-settings-${t}.json`,re)},disabled:!re.trim(),children:"Download"})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("textarea",{className:"h-40 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900",placeholder:"Click Export to generate a bundle JSON here…",value:re,onChange:t=>Ut(t.target.value)})})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Import bundle"}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["Paste a bundle JSON and run a ",e.jsx("span",{className:"font-medium",children:"dry-run preview"})," before applying. This never moves secrets."]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center gap-3 text-xs",children:[["public","admin","server_only"].map(t=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:Ie.includes(t),onChange:()=>Ks(n=>Wt(n,t))}),e.jsx("span",{className:"font-mono",children:t})]},t)),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:ct,onChange:t=>Ms(t.target.checked)}),e.jsx("span",{children:"Delete missing keys"})]}),e.jsx("div",{className:"ml-auto",children:e.jsx(x,{onClick:()=>es.mutate(),disabled:es.isPending,children:"Preview"})})]}),e.jsx("div",{className:"mt-3",children:e.jsx("textarea",{className:"h-40 w-full rounded-xl border border-zinc-200 bg-white p-3 font-mono text-xs text-zinc-900",placeholder:"Paste export JSON here…",value:ot,onChange:t=>Ts(t.target.value)})})]})]})}),e.jsxs(ue,{title:"Recommended presets",right:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-zinc-500",children:[e.jsxs("div",{children:["Presets storage: ",e.jsx("span",{className:"font-mono",children:((Ns=I.data)==null?void 0:Ns.presets_storage)??"…"})]}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings-presets"]}),disabled:I.isFetching,children:I.isFetching?"…":"Refresh"})]}),children:[e.jsx("div",{className:"text-xs text-zinc-600",children:"Presets apply multiple settings in one safe action. You can preview the exact diff before applying."}),I.isLoading?e.jsx("div",{className:"mt-3 text-sm text-zinc-500",children:"Loading presets…"}):(((ys=I.data)==null?void 0:ys.presets_storage)??"fallback")!=="db"?e.jsxs("div",{className:"mt-3 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900",children:["Presets are not available until you run the migration:",e.jsx("div",{className:"mt-2 font-mono text-[11px]",children:"supabase/migrations/20260108_000200_app_settings_presets.sql"})]}):(((ws=I.data)==null?void 0:ws.presets)??[]).length?e.jsx("div",{className:"mt-4 space-y-4",children:Object.entries((((zs=I.data)==null?void 0:zs.presets)??[]).reduce((t,n)=>{const s=(n.group_key??"general").toString();return(t[s]??(t[s]=[])).push(n),t},{})).map(([t,n])=>e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:t}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:[n.length," preset",n.length===1?"":"s"]})]})}),e.jsx("div",{className:"mt-3 space-y-2",children:n.map(s=>{const i=Object.keys(s.preset??{}).length;return e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3 rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:s.title}),s.is_builtin?e.jsx("span",{className:"rounded-lg bg-zinc-200 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:"Built-in"}):null,e.jsxs("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:[i," keys"]})]}),s.description?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:s.description}):null,e.jsx("div",{className:"mt-2 font-mono text-[11px] text-zinc-500",children:s.slug})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(x,{variant:"secondary",onClick:()=>Fs(s.slug),disabled:rt.isPending,children:rt.isPending&&Ds===s.slug?"Loading…":"Preview"})})]},s.slug)})})]},t))}):e.jsx("div",{className:"mt-3 text-sm text-zinc-500",children:"No presets found."})]}),e.jsx(Ee,{open:Ps,title:(Z==null?void 0:Z.title)??"Preset preview",onClose:()=>{ge(!1),Ae(!1)},children:!Z||!E?e.jsxs("div",{className:"space-y-3",children:[Pt?e.jsx("div",{className:"rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:Pt}):null,e.jsx("div",{className:"text-sm text-zinc-600",children:"No preview loaded."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-zinc-900",children:[e.jsx("div",{className:"font-semibold",children:Z.title}),Z.description?e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:Z.description}):null,e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-[11px] text-zinc-500",children:[e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 font-mono",children:Z.slug}),e.jsxs("span",{className:"rounded-lg bg-zinc-100 px-2 py-1",children:[Object.keys(Z.preset??{}).length," keys"]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Update"}),e.jsx("div",{className:"font-mono",children:E.counts.update})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Reset"}),e.jsx("div",{className:"font-mono",children:E.counts.reset})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Same"}),e.jsx("div",{className:"font-mono",children:E.counts.same})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Already default"}),e.jsx("div",{className:"font-mono",children:E.counts.already_default})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Unknown"}),e.jsx("div",{className:"font-mono",children:E.counts.unknown})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Invalid"}),e.jsx("div",{className:"font-mono",children:E.counts.invalid})]})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-xs text-zinc-600",children:[e.jsx("input",{type:"checkbox",checked:tt,onChange:t=>Lt(t.target.checked)}),e.jsx("span",{children:"Show non-changing rows"})]}),e.jsx("div",{className:"text-xs text-zinc-500",children:"Click a row to jump to the setting."})]})]}),E.unknown_keys.length?e.jsxs("div",{className:"rounded-2xl border border-amber-200 bg-amber-50 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-amber-900",children:"Unknown keys (ignored)"}),e.jsx("div",{className:"mt-2 max-h-24 overflow-auto rounded-xl border border-amber-200 bg-white p-2 font-mono text-[11px] text-amber-900",children:E.unknown_keys.map(t=>e.jsx("div",{children:t},t))})]}):null,E.invalid_values.length?e.jsxs("div",{className:"rounded-2xl border border-red-200 bg-red-50 p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-red-900",children:"Invalid values (ignored)"}),e.jsx("div",{className:"mt-2 max-h-28 overflow-auto rounded-xl border border-red-200 bg-white p-2 text-[11px] text-red-900",children:E.invalid_values.map(t=>e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"font-mono",children:t.key}),e.jsx("div",{className:"text-right",children:t.message})]},t.key))})]}):null,e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Changes"}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["Showing ",tt?E.changes.length:E.changes.filter(t=>t.change_type==="update"||t.change_type==="reset").length," rows"]})]}),e.jsx("div",{className:"max-h-[320px] overflow-auto rounded-xl border border-zinc-200",children:(tt?E.changes:E.changes.filter(t=>t.change_type==="update"||t.change_type==="reset")).slice(0,120).map(t=>{const n=t.change_type==="update"?"bg-emerald-100 text-emerald-800":t.change_type==="reset"?"bg-amber-100 text-amber-800":t.change_type==="already_default"?"bg-zinc-200 text-zinc-700":"bg-zinc-100 text-zinc-600",s=i=>{if(i===void 0)return"undefined";if(i===null)return"DEFAULT";if(typeof i=="string")return i.length>64?i.slice(0,64)+"…":i;try{const r=JSON.stringify(i);return r.length>90?r.slice(0,90)+"…":r}catch{return String(i)}};return e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{ge(!1),Je(t.key,{openDetails:!0})},className:"w-full border-b border-zinc-100 px-3 py-2 text-left hover:bg-zinc-50",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:k("rounded-lg px-2 py-1 text-[11px] font-semibold",n),children:t.change_type}),e.jsx("span",{className:"truncate font-mono text-[11px] text-zinc-900",children:t.key}),e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:t.scope})]}),e.jsxs("div",{className:"mt-1 text-[11px] text-zinc-600",children:[e.jsx("span",{className:"font-semibold",children:"Current:"})," ",e.jsx("span",{className:"font-mono",children:s(t.current)}),e.jsx("span",{className:"mx-2 text-zinc-400",children:"→"}),e.jsx("span",{className:"font-semibold",children:"Target:"})," ",e.jsx("span",{className:"font-mono",children:s(t.target)})]})]}),e.jsx("div",{className:"shrink-0 text-[11px] text-zinc-500",children:t.had_override?"override":"default"})]})},t.key)})}),E.changes.length>120?e.jsx("div",{className:"mt-2 text-xs text-zinc-500",children:"Showing first 120 rows."}):null]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Apply preset"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Applying writes to settings history and admin audit log."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Reason (required)"}),e.jsx(p,{value:Dt,onChange:t=>et(t.target.value),placeholder:"e.g., Switch production to high-quality assistant"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",checked:Ft,onChange:t=>Ae(t.target.checked)}),e.jsx("span",{children:"I understand this changes live settings"})]})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>ge(!1),children:"Close"}),e.jsx(x,{onClick:()=>$t.mutate(),disabled:!Ft||$t.isPending,children:"Apply"})]})]})]})}),e.jsx(Ee,{open:qs,title:"Import preview",onClose:()=>{Pe(!1),De(!1)},children:A?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Adds"}),e.jsx("div",{className:"font-mono",children:A.counts.add})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Updates"}),e.jsx("div",{className:"font-mono",children:A.counts.update})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Deletes"}),e.jsx("div",{className:"font-mono",children:A.counts.delete})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Same"}),e.jsx("div",{className:"font-mono",children:A.counts.same})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Skipped (scope)"}),e.jsx("div",{className:"font-mono",children:A.counts.skipped_scope})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-zinc-500",children:"Skipped (unknown)"}),e.jsx("div",{className:"font-mono",children:A.counts.skipped_unknown})]})]}),e.jsxs("div",{className:"mt-2 text-xs text-zinc-500",children:["Target scopes: ",e.jsx("span",{className:"font-mono",children:A.requestedScopes.join(", ")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 lg:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Adds"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.adds.length?A.adds.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Updates"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.updates.length?A.updates.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-700",children:"Deletes"}),e.jsx("div",{className:"max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 font-mono text-[11px]",children:A.deletes.length?A.deletes.map(t=>e.jsx("div",{children:t},t)):e.jsx("div",{className:"text-zinc-400",children:"None"})})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Apply changes"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Applying writes history + admin audit log and bumps the settings version."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-700",children:"Reason (required)"}),e.jsx(p,{value:Ht,onChange:t=>dt(t.target.value),placeholder:"e.g., Promote staging config to production"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"flex items-center gap-2 text-xs",children:[e.jsx("input",{type:"checkbox",checked:Bt,onChange:t=>De(t.target.checked)}),e.jsx("span",{children:"I understand this changes live settings"})]})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx(x,{variant:"secondary",onClick:()=>Pe(!1),children:"Close"}),e.jsx(x,{onClick:()=>ts.mutate(),disabled:ts.isPending,children:"Apply"})]})]})]}):e.jsx("div",{className:"text-sm text-zinc-600",children:"No preview loaded."})}),e.jsx(ue,{title:"Quick editors (server-only knobs)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Rate limits"}),e.jsx(G,{onClick:()=>B(jt)})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["Stored as ",e.jsx("span",{className:"font-mono",children:"server_only"})," settings; used by Edge Functions only."]}),(()=>{var s;const t=le(jt)??{actions:{}},n=Number(((s=t==null?void 0:t.actions)==null?void 0:s["catalog-sync"])??60);return e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"catalog-sync (max / minute)"}),e.jsx(p,{type:"number",min:1,max:6e3,value:Number.isFinite(n)?String(n):"60",onChange:i=>{const r=_e(i.target.value,1,6e3,60),a={...t??{},actions:{...(t==null?void 0:t.actions)??{},"catalog-sync":r}};He(jt,a)}}),e.jsxs("div",{className:"text-[11px] text-zinc-500",children:["Tip: You can add more actions in the full table editor under ",e.jsx("span",{className:"font-mono",children:"ops.rate_limits"}),"."]})]})})()]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Tool result truncation"}),e.jsx(G,{onClick:()=>B(me)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Controls how much tool output is returned (prevents huge payloads)."}),(()=>{const t=le(me)??{defaults:{maxString:1200,maxArray:40,maxObjectKeys:60},caps:{maxString:4e3,maxArray:200,maxObjectKeys:200},maxDepth:4},n=(t==null?void 0:t.defaults)??{},s=(t==null?void 0:t.caps)??{},i=Number((t==null?void 0:t.maxDepth)??4),r=(a,v,w)=>{const z=le(me)??t,S=a==="defaults"?z.defaults??{}:z.caps??{},d=Number((S==null?void 0:S[v])??(a==="defaults"?n[v]:s[v])),u=_e(w,v==="maxString"?80:v==="maxArray"?1:5,v==="maxString"?4e3:200,d),_={...z??{},[a]:{...S??{},[v]:u}};He(me,_)};return e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Defaults"}),e.jsxs("div",{className:"mt-2 grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxString"}),e.jsx(p,{type:"number",min:80,max:4e3,value:String(Number(n.maxString??1200)),onChange:a=>r("defaults","maxString",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxArray"}),e.jsx(p,{type:"number",min:1,max:200,value:String(Number(n.maxArray??40)),onChange:a=>r("defaults","maxArray",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxKeys"}),e.jsx(p,{type:"number",min:5,max:200,value:String(Number(n.maxObjectKeys??60)),onChange:a=>r("defaults","maxObjectKeys",a.target.value)})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Caps"}),e.jsxs("div",{className:"mt-2 grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxString"}),e.jsx(p,{type:"number",min:80,max:4e3,value:String(Number(s.maxString??4e3)),onChange:a=>r("caps","maxString",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxArray"}),e.jsx(p,{type:"number",min:1,max:200,value:String(Number(s.maxArray??200)),onChange:a=>r("caps","maxArray",a.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"maxKeys"}),e.jsx(p,{type:"number",min:5,max:200,value:String(Number(s.maxObjectKeys??200)),onChange:a=>r("caps","maxObjectKeys",a.target.value)})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"maxDepth"}),e.jsx(p,{type:"number",min:1,max:8,value:Number.isFinite(i)?String(i):"4",onChange:a=>{const v=_e(a.target.value,1,8,4),w=le(me)??t;He(me,{...w??{},maxDepth:v})}})]})]})})()]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Reply runner"}),e.jsx(G,{onClick:()=>B("assistant.reply_runner.backoff")})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Background assistant job worker knobs (claiming, retries, stuck reclaim, context size, backoff)."}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"claim limit"}),e.jsx(p,{type:"number",min:1,max:200,value:j["assistant.reply_runner.claim_limit_default"]??"",onChange:t=>L("assistant.reply_runner.claim_limit_default",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max attempts"}),e.jsx(p,{type:"number",min:1,max:10,value:j["assistant.reply_runner.max_attempts_default"]??"",onChange:t=>L("assistant.reply_runner.max_attempts_default",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"stuck minutes"}),e.jsx(p,{type:"number",min:1,max:120,value:j["assistant.reply_runner.stuck_minutes"]??"",onChange:t=>L("assistant.reply_runner.stuck_minutes",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max context msgs"}),e.jsx(p,{type:"number",min:1,max:50,value:j["assistant.reply_runner.max_context_messages"]??"",onChange:t=>L("assistant.reply_runner.max_context_messages",t.target.value)})]})]}),(()=>{const t=le(bt)??{base_seconds:10,max_exp:10,max_seconds:3600,jitter_seconds:5},n=(s,i)=>{const r=le(bt)??t,a=Number((r==null?void 0:r[s])??(t==null?void 0:t[s])),v=s==="base_seconds"?[1,120]:s==="max_exp"?[1,16]:s==="max_seconds"?[10,7200]:[0,30],w=_e(i,v[0],v[1],a);He(bt,{...r??{},[s]:w})};return e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Backoff"}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"base s"}),e.jsx(p,{type:"number",min:1,max:120,value:String(Number(t.base_seconds??10)),onChange:s=>n("base_seconds",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max exp"}),e.jsx(p,{type:"number",min:1,max:16,value:String(Number(t.max_exp??10)),onChange:s=>n("max_exp",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"max s"}),e.jsx(p,{type:"number",min:10,max:7200,value:String(Number(t.max_seconds??3600)),onChange:s=>n("max_seconds",s.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"jitter s"}),e.jsx(p,{type:"number",min:0,max:30,value:String(Number(t.jitter_seconds??5)),onChange:s=>n("jitter_seconds",s.target.value)})]})]})]})})()]})]})]})}),e.jsx(ue,{title:"Quick editors (admin dashboard defaults)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Users"}),e.jsx(G,{onClick:()=>B(Nt)})]}),e.jsxs("div",{className:"mt-1 text-xs text-zinc-600",children:["List page size + ban duration (stored as ",e.jsx("span",{className:"font-mono",children:"admin"})," settings)."]}),e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"page limit"}),e.jsx(p,{type:"number",min:10,max:500,value:j[Nt]??"",onChange:t=>L(Nt,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"ban duration (days)"}),e.jsx(p,{type:"number",min:1,max:36500,value:j[ms]??"",onChange:t=>L(ms,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Overview"}),e.jsx(G,{onClick:()=>B(yt)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Controls how many rows the overview endpoint returns."}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"recent errors"}),e.jsx(p,{type:"number",min:1,max:200,value:j[yt]??"",onChange:t=>L(yt,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"last job runs"}),e.jsx(p,{type:"number",min:1,max:200,value:j[us]??"",onChange:t=>L(us,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Admin Audit"}),e.jsx(G,{onClick:()=>B(wt)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Default limit for listing audit rows (request may override, still clamped)."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"default limit"}),e.jsx(p,{type:"number",min:1,max:200,value:j[wt]??"",onChange:t=>L(wt,t.target.value)})]})]})]})}),e.jsx(ue,{title:"Quick editors (public UX / copy)",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-3",children:[e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Assistant"}),e.jsx(G,{onClick:()=>B(zt)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Public settings: affect how the client detects the assistant thread on first run."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"assistant username"}),e.jsx(p,{value:j[zt]??"",onChange:t=>L(zt,t.target.value),placeholder:"movinesta"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Presence labels"}),e.jsx(G,{onClick:()=>B(St)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"UI copy for online / away / last-active state."}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"online label"}),e.jsx(p,{value:j[St]??"",onChange:t=>L(St,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"active recently label"}),e.jsx(p,{value:j[ps]??"",onChange:t=>L(ps,t.target.value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"last-active prefix"}),e.jsx(p,{value:j[hs]??"",onChange:t=>L(hs,t.target.value)})]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900",children:"Messages search"}),e.jsx(G,{onClick:()=>B(_t)})]}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Minimum characters required to enable in-conversation search."}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-[11px] text-zinc-500",children:"min chars"}),e.jsx(p,{type:"number",min:1,max:10,value:j[_t]??"",onChange:t=>L(_t,t.target.value)})]})]})]})}),e.jsx(ue,{title:"App settings (non-secret)",right:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-500",children:["Version: ",e.jsx("span",{className:"font-mono",children:J})]}),e.jsx(x,{variant:"ghost",onClick:()=>ht.mutate(),disabled:!Ke.length||ht.isPending,children:ht.isPending?"Cleaning…":`Clean redundant (${Ke.length})`}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings"]}),disabled:h.isFetching,children:h.isFetching?"Refreshing…":"Refresh"}),e.jsx(x,{onClick:()=>{try{for(const t of Me){const n=m[t];if(!n)continue;const s=ce(n.default);Os(s,j[t]??"",be[t])}}catch(t){o.push({variant:"error",title:"Invalid input",message:X(t)});return}pt.mutate()},disabled:!Me.length||pt.isPending,children:pt.isPending?"Saving…":`Save (${Me.length})`})]}),children:e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-4 md:grid-cols-12",children:[e.jsxs("div",{className:"md:col-span-4 space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-2 text-xs font-medium text-zinc-600",children:[e.jsx("span",{children:"Search"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Gs(),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-50",children:"Reset"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>se(!0),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-50",children:"Ctrl+K"})]})]}),e.jsx(p,{ref:te,value:C,onChange:t=>M(t.target.value),placeholder:"Search key, hint text, examples…"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-2 text-xs font-medium text-zinc-600",children:[e.jsx("span",{children:"Scope"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{M(""),$("all"),Re(!1),Q(!1),b("/settings")},className:"rounded-lg px-2 py-1 text-[11px] font-semibold text-zinc-600 hover:bg-zinc-100",children:"Reset"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 rounded-xl border border-zinc-200 bg-white p-2",children:[{value:"all",label:"All"},{value:"public",label:"Public"},{value:"admin",label:"Admin"},{value:"server_only",label:"Server"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>$(t.value),className:k("rounded-lg px-2 py-1 text-[11px] font-semibold",q===t.value?"bg-zinc-900 text-white":"bg-white text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Favorites"}),e.jsxs("label",{className:"flex h-[42px] items-center gap-2 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:U,onChange:t=>{const n=t.target.checked;Q(n),b(n?"/settings/favorites":N==="all"?"/settings":`/settings/${N}`)}}),e.jsx("span",{children:"Show only"})]}),e.jsxs("div",{className:"mt-1 flex items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("span",{children:"Sync:"}),e.jsx("span",{className:k("rounded-full px-2 py-0.5 text-[10px] font-semibold",ae.state==="Saved"&&"bg-emerald-100 text-emerald-900",ae.state==="Saving"&&"bg-zinc-200 text-zinc-800",ae.state==="Offline"&&"bg-zinc-100 text-zinc-700",ae.state==="Error"&&"bg-rose-100 text-rose-900"),children:ae.state}),ae.detail?e.jsx("span",{className:"truncate text-zinc-500",children:ae.detail}):null]}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>{at(null),xe.mutate(P),c.invalidateQueries({queryKey:["app-settings"]})},disabled:xe.isPending,className:k("shrink-0 rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-700 hover:bg-zinc-50",xe.isPending&&"opacity-50"),children:"Retry"})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Sort"}),e.jsx("div",{className:"flex flex-wrap gap-2 rounded-xl border border-zinc-200 bg-white p-2",children:[{value:"key_asc",label:"Key"},{value:"last_modified_desc",label:"Last modified"},{value:"favorites_first",label:"Favorites first"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Et(t.value),className:k("rounded-lg px-3 py-2 text-xs font-semibold transition",ie===t.value?"bg-zinc-900 text-white":"bg-white text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Changed from default"}),e.jsxs("label",{className:"flex h-[42px] items-center gap-2 rounded-xl border border-zinc-200 bg-white px-3 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:Qe,onChange:t=>Re(t.target.checked)}),e.jsx("span",{children:"Show only overrides"}),e.jsx("span",{className:"ml-auto text-xs text-zinc-500",children:"(stored values)"})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2 text-xs font-medium text-zinc-600",children:"Categories"}),e.jsxs("div",{className:"max-h-[260px] overflow-auto rounded-xl border border-zinc-200 bg-white p-2",children:[e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Q(!0),y("all"),b("/settings/favorites")},className:k("flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",U?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[14px]",children:"⭐"}),e.jsx("span",{children:"Favorites"})]}),e.jsx("span",{className:"flex items-center gap-2",children:e.jsx("span",{className:k("text-xs",U?"text-white/80":"text-zinc-500"),children:P.filter(t=>!!m[t]).length})})]}),e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Q(!1),y("all"),b("/settings")},className:k("flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",N==="all"&&!U?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsx("span",{children:"all"}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:k("text-xs",N==="all"&&!U?"text-white/80":"text-zinc-500"),children:Object.keys(m).length}),Array.from(Le.values()).reduce((t,n)=>t+n,0)>0&&e.jsx("span",{className:k("rounded-full px-2 py-0.5 text-[10px] font-medium",N==="all"&&!U?"bg-white/15 text-white":"bg-amber-100 text-amber-900"),children:Array.from(Le.values()).reduce((t,n)=>t+n,0)})]})]}),Yt.filter(t=>t!=="all").map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{Q(!1),y(t),b(`/settings/${t}`)},className:k("mt-1 flex w-full items-center justify-between rounded-lg px-2 py-1.5 text-left text-sm",N===t&&!U?"bg-zinc-900 text-white":"hover:bg-zinc-50"),children:[e.jsx("span",{className:"truncate",children:t}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:k("text-xs",N===t&&!U?"text-white/80":"text-zinc-500"),children:Xt.get(t)??0}),(Le.get(t)??0)>0&&e.jsx("span",{className:k("rounded-full px-2 py-0.5 text-[10px] font-medium",N===t&&!U?"bg-white/15 text-white":"bg-amber-100 text-amber-900"),children:Le.get(t)??0})]})]},t))]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-600",children:"Recently changed"}),e.jsx(x,{variant:"ghost",onClick:()=>c.invalidateQueries({queryKey:["app-settings-history","recent"]}),disabled:R.isFetching,children:R.isFetching?"…":"Refresh"})]}),e.jsxs("div",{className:"max-h-[220px] overflow-auto rounded-xl border border-zinc-200 bg-white",children:[(((Ss=R.data)==null?void 0:Ss.rows)??[]).slice(0,20).map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>vt(t.key),className:"w-full border-b border-zinc-100 px-3 py-2 text-left hover:bg-zinc-50",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"truncate font-mono text-[11px] text-zinc-900",children:t.key}),e.jsx("div",{className:"shrink-0 text-[11px] text-zinc-500",children:new Date(t.changed_at).toLocaleString()})]}),t.change_reason?e.jsx("div",{className:"mt-1 line-clamp-1 text-[11px] text-zinc-600",children:t.change_reason}):null]},t.id)),(((_s=R.data)==null?void 0:_s.rows)??[]).length?null:e.jsx("div",{className:"px-3 py-3 text-sm text-zinc-500",children:"No recent changes."})]})]})]}),e.jsxs("div",{className:"md:col-span-8",children:[ee?e.jsxs("div",{className:"mb-4 rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:"Settings home"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:"Pick a category to browse, or use search & filters to find a specific key."})]}),e.jsx(x,{variant:"ghost",onClick:()=>{y("all"),b("/settings/all")},children:"Browse all"})]}),e.jsx("div",{className:"mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3",children:Yt.filter(t=>t!=="all").map(t=>e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{y(t),b(`/settings/${t}`)},className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-4 text-left hover:bg-zinc-100",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-sm font-semibold text-zinc-900",children:t}),e.jsx("div",{className:"text-xs text-zinc-600",children:Xt.get(t)??0})]}),e.jsx("div",{className:"mt-2 text-xs text-zinc-600",children:t==="assistant"?"Models, tokens, tool policies, orchestrator behavior.":t==="ux"?"UI copy, presence/seen rules, message UX flags.":t==="ranking"?"Taste &amp; trending weights, thresholds.":t==="moderation"?"Non-secret moderation filters &amp; limits.":t==="ops"?"Timeouts, retries, rate limits, job defaults.":t==="plan"?"Tier caps &amp; quotas.":t==="integrations"?"Non-secret endpoints &amp; integration toggles.":"Settings in this category."})]},t))})]}):null,e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Reason (optional)"}),e.jsx(p,{value:Ye,onChange:t=>At(t.target.value),placeholder:"Why are you changing these?"})]}),e.jsxs("div",{className:"space-y-4",children:[$s.map(([t,n])=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-600",children:t}),e.jsx("div",{className:"space-y-2",children:n.map(s=>{const i=m[s],r=D.get(s),a=!!r,v=a&&pe(r==null?void 0:r.value,i.default),w=a&&!v,z=!!Ne[s],S=ce(i.default),d=i.meta,O=ke(s,{default:i.default,description:i.description,meta:i.meta}),ne=(O==null?void 0:O.recommended)!==void 0;return e.jsxs("div",{id:`setting-${s}`,className:"rounded-2xl border border-zinc-200 bg-white p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"truncate font-mono text-xs text-zinc-900",children:s}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>rs(s),title:"Copy key","aria-label":"Copy key",className:"inline-flex h-6 w-6 p-0 items-center justify-center rounded-full border border-zinc-200 bg-white text-[12px] font-semibold text-zinc-500 shadow-sm hover:text-zinc-700",children:"⧉"}),e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Qs(s),title:ft(s)?"Unfavorite":"Favorite","aria-label":ft(s)?"Unfavorite":"Favorite",className:k("inline-flex h-6 w-6 items-center justify-center rounded-full border border-zinc-200 bg-white text-[12px] font-semibold shadow-sm",ft(s)?"text-amber-600":"text-zinc-400 hover:text-zinc-600"),children:"★"}),e.jsx(G,{onClick:()=>B(s),title:"Explain this setting"}),e.jsx("span",{className:k("rounded-lg px-2 py-1 text-xs font-semibold",i.scope==="public"&&"bg-emerald-100 text-emerald-800",i.scope==="admin"&&"bg-zinc-200 text-zinc-800",i.scope==="server_only"&&"bg-blue-100 text-blue-800"),children:i.scope}),a?w?e.jsx("span",{className:"rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-900",children:"overridden"}):e.jsx("span",{className:"rounded-full bg-purple-100 px-2 py-0.5 text-[10px] font-semibold text-purple-900",children:"redundant"}):e.jsx("span",{className:"rounded-full bg-zinc-100 px-2 py-0.5 text-[10px] font-semibold text-zinc-700",children:"default"}),z?e.jsx("span",{className:"rounded bg-amber-100 px-2 py-1 text-[10px] font-semibold text-amber-800",children:"modified"}):null]}),e.jsx("div",{className:"mt-2 text-sm text-zinc-700",children:i.description}),e.jsx("div",{className:"mt-1 text-xs text-zinc-500",children:a?e.jsxs("span",{children:["stored v",(r==null?void 0:r.version)??"?"]}):e.jsx("span",{children:"using default"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>Xs(s),children:"Reset"}),e.jsx(x,{variant:"ghost",onClick:()=>vt(s),children:"History"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 gap-4 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-8",children:[(d==null?void 0:d.kind)==="enum"?e.jsx("select",{value:j[s]??String(Ce(s)??""),onChange:u=>{T(_=>({..._,[s]:u.target.value})),H(s)},className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300",children:(d.values??[]).map(u=>e.jsx("option",{value:u,children:u},u))}):S==="boolean"?e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:!!be[s],onChange:u=>{Fe(_=>({..._,[s]:u.target.checked})),H(s)}}),be[s]?"true":"false"]}):S==="json"?e.jsx("textarea",{value:j[s]??"",onChange:u=>{T(_=>({..._,[s]:u.target.value})),H(s)},rows:6,className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 font-mono text-xs text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300"}):S==="number"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{value:j[s]??"",onChange:u=>{T(_=>({..._,[s]:u.target.value})),H(s)},type:"number",min:(d==null?void 0:d.kind)==="number"?d.min:void 0,max:(d==null?void 0:d.kind)==="number"?d.max:void 0,step:(d==null?void 0:d.kind)==="number"&&d.int?1:"any"}),(d==null?void 0:d.kind)==="number"&&typeof d.min=="number"&&typeof d.max=="number"&&d.max-d.min<=1e4?e.jsx("input",{type:"range",min:d.min,max:d.max,step:d.int?1:.1,value:(()=>{const u=(j[s]??"").trim(),_=Number(u);if(u!==""&&Number.isFinite(_))return _;const Es=Number(Ce(s));return Number.isFinite(Es)?Es:d.min})(),onChange:u=>{T(_=>({..._,[s]:u.target.value})),H(s)},className:"w-full"}):null]}):e.jsx(p,{value:j[s]??"",onChange:u=>{T(_=>({..._,[s]:u.target.value})),H(s)},type:"text"}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-between gap-2 text-[11px] text-zinc-500",children:[e.jsxs("div",{children:["Default: ",e.jsx("span",{className:"font-mono",children:S==="json"?"(json)":String(i.default)}),(d==null?void 0:d.kind)==="number"&&(typeof d.min=="number"||typeof d.max=="number")?e.jsxs("span",{className:"ml-2",children:["Range: ",e.jsxs("span",{className:"font-mono",children:[d.min??"-∞","…",d.max??"∞"]})]}):null]}),ne?e.jsx(x,{variant:"ghost",type:"button",onClick:()=>en(s),className:"rounded-lg border border-zinc-200 bg-white px-2 py-1 text-[11px] font-semibold text-zinc-700 hover:bg-zinc-50",children:"Apply recommended"}):null]}),S==="json"?e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{try{const u=JSON.parse((j[s]??"").trim());T(_=>({..._,[s]:V(u)})),H(s),o.push({variant:"success",title:"Formatted",message:"JSON formatted."})}catch(u){o.push({variant:"error",title:"Invalid JSON",message:X(u)})}},children:"Format JSON"}),e.jsx(x,{variant:"ghost",onClick:()=>{try{JSON.parse((j[s]??"").trim()),o.push({variant:"success",title:"Valid",message:"JSON is valid."})}catch(u){o.push({variant:"error",title:"Invalid JSON",message:X(u)})}},children:"Validate"})]}):null]}),e.jsx("div",{className:"lg:col-span-4",children:e.jsxs("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-50 p-3",children:[e.jsx("div",{className:"text-xs font-semibold text-zinc-700",children:"Suggested"}),e.jsx("div",{className:"mt-1 text-xs text-zinc-600",children:ne?(O==null?void 0:O.recommended_why)??"Curated recommended value.":"Default value (matches current app behavior)."}),e.jsx("pre",{className:"mt-2 max-h-40 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:V(ne?O==null?void 0:O.recommended:i.default)})]})})]})]},s)})})]},t)),ut.length?null:e.jsx("div",{className:"rounded-2xl border border-zinc-200 bg-white p-4 text-sm text-zinc-500",children:"No matching settings."})]})]})]})}),e.jsx(Ee,{open:fe,title:"Jump to setting",onClose:()=>{se(!1)},children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Search by key, title, hint text, examples…"}),e.jsx("input",{ref:Kt,value:st,onChange:t=>oe(t.target.value),onKeyDown:t=>{var n;if(t.key==="Escape"){t.preventDefault(),se(!1);return}if(t.key==="Enter"){t.preventDefault();const s=(n=mt[0])==null?void 0:n.key;s&&(se(!1),oe(""),Je(s,{openDetails:!0}))}},placeholder:"e.g., ux.presence, tokens, rate limits…",className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 placeholder:text-zinc-400 focus:outline-none focus:ring-2 focus:ring-zinc-300"})]}),e.jsx("div",{className:"max-h-[55vh] overflow-auto rounded-xl border border-zinc-200",children:mt.length?e.jsx("div",{className:"divide-y divide-zinc-100",children:mt.map(t=>{const n=m[t.key],s=D.get(t.key),i=s?pe(s.value,n==null?void 0:n.default)?"redundant":"overridden":"default";return e.jsxs(x,{variant:"ghost",type:"button",onClick:()=>{se(!1),oe(""),Je(t.key,{openDetails:!0})},className:"w-full px-3 py-2 text-left hover:bg-zinc-50",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-mono text-xs text-zinc-900",children:t.key}),e.jsx("div",{className:"mt-1 line-clamp-1 text-xs text-zinc-600",children:t.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"rounded-lg bg-zinc-100 px-2 py-1 text-[11px] font-semibold text-zinc-700",children:he(t.key)}),e.jsx("span",{className:k("rounded-full px-2 py-0.5 text-[10px] font-semibold",i==="default"&&"bg-zinc-100 text-zinc-700",i==="overridden"&&"bg-amber-100 text-amber-900",i==="redundant"&&"bg-purple-100 text-purple-900"),children:i})]})]}),t.description?e.jsx("div",{className:"mt-1 line-clamp-2 text-xs text-zinc-500",children:t.description}):null]},t.key)})}):e.jsx("div",{className:"px-3 py-3 text-sm text-zinc-500",children:"No matching settings."})}),e.jsxs("div",{className:"text-[11px] text-zinc-500",children:["Tip: press ",e.jsx("span",{className:"font-mono",children:"Enter"})," to jump to the top result. Each result opens the details drawer."]})]})}),e.jsx(gn,{open:cs,settingKey:g,entry:g?m[g]:null,row:g?D.get(g)??null:null,onNavigateToKey:t=>Je(t,{openDetails:!0}),status:(()=>{if(!g)return;const t=m[g],n=D.get(g);if(t)return n?pe(n.value,t.default)?"redundant":"overridden":"default"})(),hint:g?ke(g,m[g]?{default:m[g].default,description:m[g].description,meta:m[g].meta}:void 0):null,effectiveValue:g?Ce(g):void 0,draftValue:g?tn(g):void 0,recentHistory:((Cs=sn.data)==null?void 0:Cs.rows)??[],onClose:Zs,onCopyKey:g?(()=>rs(g)):void 0,onOpenHistory:g?(()=>vt(g)):void 0,onApplyValue:g?(t=>xs(g,t)):void 0}),e.jsx(Ee,{open:Js,title:F?`History: ${F}`:"History",onClose:()=>{ss(!1),ns(null)},children:ze.isPending?e.jsx("div",{className:"text-sm text-zinc-500",children:"Loading history…"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Range"}),e.jsxs("select",{value:Te,onChange:t=>{const n=Number(t.target.value);Hs(n),F&&ze.mutate({key:F,limit:qe,since:we(n)})},className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300",children:[e.jsx("option",{value:0,children:"All"}),e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:30,children:"Last 30 days"}),e.jsx("option",{value:90,children:"Last 90 days"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Limit"}),e.jsx(p,{type:"number",value:String(qe),min:1,max:200,onChange:t=>{const n=_e(t.target.value,1,200,50);Bs(n),F&&ze.mutate({key:F,limit:n,since:we(Te)})}})]}),e.jsxs("div",{className:"ml-auto flex gap-2",children:[e.jsx("div",{className:"flex rounded-xl border border-zinc-200 bg-white p-1",children:[{value:"side_by_side",label:"Side-by-side"},{value:"diff",label:"Diff"}].map(t=>e.jsx(x,{variant:"ghost",type:"button",onClick:()=>Is(t.value),className:k("rounded-lg px-2 py-1 text-[11px] font-semibold transition",Rt===t.value?"bg-zinc-900 text-white":"text-zinc-700 hover:bg-zinc-50"),children:t.label},t.value))}),e.jsx(x,{variant:"ghost",onClick:ls,children:"Refresh"})]})]}),is.length?e.jsx("div",{className:"space-y-2",children:is.map(t=>e.jsxs("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-600",children:[e.jsxs("span",{className:"font-mono",children:["v",t.old_version??"—"," → v",t.new_version??"—"]}),e.jsx("span",{className:"mx-2",children:"·"}),e.jsx("span",{className:"font-mono",children:new Date(t.changed_at).toLocaleString()})]}),t.change_reason?e.jsxs("div",{className:"text-xs text-zinc-600",children:["Reason: ",t.change_reason]}):null]}),e.jsxs("div",{className:"mt-1 flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-xs text-zinc-500",children:["Changed by: ",e.jsx("span",{className:"font-mono",children:t.changed_by??"—"}),t.request_id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-2",children:"·"}),"Req: ",e.jsx("span",{className:"font-mono",children:t.request_id})]}):null]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(x,{variant:"ghost",onClick:()=>Ws(t),children:"Rollback"})})]}),Rt==="diff"?e.jsx("div",{className:"mt-2",children:e.jsx(vn,{before:t.old_value,after:t.new_value})}):e.jsxs("div",{className:"mt-2 grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Old"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:V(t.old_value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"New"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-white p-2 text-xs",children:V(t.new_value)})]})]})]},t.id))}):e.jsx("div",{className:"text-sm text-zinc-500",children:"No history yet."})]})}),e.jsx(Ee,{open:Vs,title:Y?`Rollback: ${Y.key}`:"Rollback",onClose:()=>{Se.isPending||($e(!1),Ue(null),ye(""))},children:Y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900",children:["This will write a new settings update that restores the old value from version ",e.jsxs("span",{className:"font-mono",children:["v",Y.old_version??"—"]}),". The change is audited and can be rolled back again."]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-medium text-zinc-600",children:"Reason (required)"}),e.jsx("textarea",{value:gt,onChange:t=>ye(t.target.value),rows:3,placeholder:"Example: Accidentally set too low; restoring previous safe value.",className:"w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-300"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Will restore"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-zinc-50 p-2 text-xs",children:V(Y.old_value??(F?(ks=m[F])==null?void 0:ks.default:null)??null)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-1 text-xs font-semibold text-zinc-700",children:"Current (from history row)"}),e.jsx("pre",{className:"max-h-48 overflow-auto rounded-xl border border-zinc-200 bg-zinc-50 p-2 text-xs",children:V(Y.new_value)})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>{$e(!1),Ue(null),ye("")},disabled:Se.isPending,children:"Cancel"}),e.jsx(x,{variant:"danger",onClick:()=>Se.mutate(),disabled:Se.isPending||gt.trim().length<3,children:Se.isPending?"Rolling back…":"Confirm rollback"})]})]}):e.jsx("div",{className:"text-sm text-zinc-500",children:"No rollback target selected."})})]})}export{Cn as default};
