import{r,j as e,L as T,B as o,a as O,F as B}from"./index-CGWJK-B7.js";import{u as D,E as R}from"./ErrorBox-DGVAxfkB.js";import{C as A}from"./Card-BfoASP6-.js";import{T as F,a as N,b}from"./Table-DrAL3XMq.js";import{I as E}from"./Input-5czXp4bm.js";import{E as $}from"./EmptyState-D234wNkF.js";import{C as S}from"./CopyButton-DYYxrqKe.js";function q(s){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:s.children})}function I(s,n,x="text/plain"){const m=new Blob([n],{type:x}),l=URL.createObjectURL(m),d=document.createElement("a");d.href=l,d.download=s,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(l)}function W(){var _,k;const[s,n]=r.useState(100),[x,m]=r.useState(""),[l,d]=r.useState(""),[u,j]=r.useState(null),[y,g]=r.useState([]),[v,c]=r.useState(null),p=D({queryKey:["audit",{limit:s,search:l,before:u}],queryFn:()=>B({limit:s,search:l.trim()||null,before:u})}),h=((_=p.data)==null?void 0:_.rows)??[],z=r.useMemo(()=>h.find(t=>String(t.id)===String(v))??null,[h,v]);r.useEffect(()=>{v&&(z||c(null))},[v,z]),r.useEffect(()=>{j(null),g([]),c(null)},[s,l]);const w=()=>{c(null),j(null),g([]),d(x.trim())},C=()=>{n(100),c(null),j(null),g([]),m(""),d("")},J=()=>{const t=["id","created_at","admin_user_id","admin_email","action","target","details"].join(","),a=h.map(i=>{const L=(()=>{try{return JSON.stringify(i.details??{})}catch{return"{}"}})();return[JSON.stringify(i.id??""),JSON.stringify(i.created_at??""),JSON.stringify(i.admin_user_id??""),JSON.stringify(i.admin_email??""),JSON.stringify(i.action??""),JSON.stringify(i.target??""),JSON.stringify(L)].join(",")});I(`audit_${u?"paged":"latest"}_${h.length}.csv`,[t,...a].join(`
`),"text/csv")};return p.isLoading?e.jsx(T,{}):p.error?e.jsx(R,{error:p.error}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(q,{children:"Audit log"}),(()=>{const t=[s!==100?`limit=${s}`:null,l?`q="${l}"`:null,u?`before=${u}`:null].filter(Boolean);return t.length?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Applied: ",e.jsx("span",{className:"font-mono",children:t.join(" • ")})]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No filters applied."})})()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"ghost",type:"button",onClick:J,disabled:!h.length,children:"Export CSV"}),e.jsx(o,{variant:"ghost",type:"button",onClick:C,children:"Reset filters"})]})]}),e.jsx(A,{title:"Filters",children:e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center",children:[e.jsx("div",{className:"w-40",children:e.jsx(E,{type:"number",value:String(s),min:10,max:500,onChange:t=>{const a=t.target.value;if(a==="")return;const f=Number(a);if(!Number.isFinite(f))return;const i=Math.max(10,Math.min(500,Math.trunc(f)));n(i)}})}),e.jsx("div",{className:"flex-1",children:e.jsx(E,{value:x,onChange:t=>m(t.target.value),onKeyDown:t=>{t.key==="Enter"&&w()},placeholder:"Search action/target (e.g., ban, reset_cursor, embedding_settings)"})}),e.jsx(o,{type:"button",onClick:w,children:"Apply"}),e.jsx(o,{variant:"ghost",type:"button",onClick:C,children:"Clear"})]})}),e.jsxs(A,{title:"Recent admin actions",children:[e.jsxs(F,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(N,{children:"At"}),e.jsx(N,{children:"Admin"}),e.jsx(N,{children:"Action"}),e.jsx(N,{children:"Target"}),e.jsx(N,{children:"Details"})]})}),e.jsx("tbody",{children:h.length?h.map(t=>{const a=t.admin_email??t.admin_user_id??"—",f=(()=>{try{const i=JSON.stringify(t.details??{});return i.length>120?i.slice(0,120)+"…":i}catch{return"{…}"}})();return e.jsxs("tr",{className:"cursor-pointer hover:bg-zinc-100 "+(String(v)===String(t.id)?"bg-zinc-200":""),onClick:()=>c(String(t.id)),children:[e.jsx(b,{className:"whitespace-nowrap text-xs text-zinc-600",children:O(t.created_at)}),e.jsx(b,{className:"max-w-[16rem] truncate text-xs text-zinc-600",children:a}),e.jsx(b,{className:"font-mono text-xs",children:t.action}),e.jsx(b,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:t.target}),t.target?e.jsx(S,{text:String(t.target),label:"Copy",className:"h-8 px-2 py-1 text-xs"}):null]})}),e.jsx(b,{className:"max-w-[22rem] truncate text-xs text-zinc-600",children:f})]},t.id)}):e.jsx("tr",{children:e.jsx(b,{colSpan:5,className:"p-6",children:e.jsx($,{title:"No audit events",message:"No audit rows yet for this range.",className:"border-0 bg-transparent p-0"})})})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsx(o,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{j(null),g([]),c(null)},disabled:!u&&y.length===0,children:"First page"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{const t=y[y.length-1]??null;g(a=>a.slice(0,-1)),j(t),c(null)},disabled:y.length===0,children:"Prev"}),e.jsx(o,{variant:"secondary",type:"button",className:"rounded-xl border border-zinc-200 bg-zinc-100 px-3 py-2 text-sm text-zinc-700 hover:bg-zinc-200 disabled:opacity-50",onClick:()=>{var a;const t=((a=p.data)==null?void 0:a.next_before)??null;t&&(g(f=>[...f,u]),j(t),c(null))},disabled:!((k=p.data)!=null&&k.next_before),children:"Next"})]})]})]}),e.jsx(M,{open:!!z,row:z,onClose:()=>c(null)})]})}function M(s){if(r.useEffect(()=>{if(!s.open)return;const m=l=>{l.key==="Escape"&&s.onClose()};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[s.open,s.onClose]),!s.open||!s.row)return null;const n=s.row,x=(()=>{try{return JSON.stringify(n.details??{},null,2)}catch{return String(n.details??"{}")}})();return e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:s.onClose}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full max-w-xl border-l border-zinc-200 bg-white p-5 shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight text-zinc-900",children:"Audit details"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-zinc-500 font-mono",children:[e.jsx("span",{children:n.id}),e.jsx(S,{text:String(n.id),label:"Copy id",className:"h-8 px-2 py-1 text-xs"})]})]}),e.jsx(o,{variant:"ghost",type:"button",className:"rounded-xl px-3 py-2 text-sm text-zinc-600 hover:bg-zinc-100",onClick:s.onClose,"aria-label":"Close",children:"Close"})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"At"}),e.jsx("div",{className:"text-zinc-700",children:O(n.created_at)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Admin"}),e.jsx("div",{className:"text-zinc-700",children:n.admin_email??n.admin_user_id??"—"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Action"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.action})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Target"}),e.jsx("div",{className:"font-mono text-xs text-zinc-700",children:n.target})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs font-medium text-zinc-500",children:"Details"}),e.jsx(S,{text:x,label:"Copy JSON",className:"h-8 px-2 py-1 text-xs"})]}),e.jsx("pre",{className:"mt-2 max-h-[65vh] overflow-auto rounded-2xl border border-zinc-200 bg-zinc-50 p-3 text-xs text-zinc-700",children:x})]})]})]})}export{W as default};
