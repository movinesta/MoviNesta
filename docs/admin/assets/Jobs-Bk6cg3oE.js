import{u as A,r as u,j as e,L as R,B as j,a as k,i as T,k as B,l as D,m as J,n as I,o as M}from"./index-Ce94cHyp.js";import{u as U,E as h}from"./ErrorBox-DZUsR5L2.js";import{u as p}from"./useMutation-BuMd4YLx.js";import{C as E}from"./Card-DXgML9lJ.js";import{T as Q,a as n,b as r}from"./Table-B-aH1K18.js";import{I as S}from"./Input-BLXhYdkr.js";import{E as K}from"./EmptyState-mcVY2n_D.js";import{C as v}from"./CopyButton-D3efaj2N.js";function $(t){return e.jsx("div",{className:"mb-4 text-xl font-semibold tracking-tight",children:t.children})}const g={cursorSearch:"",cronSearch:""};function ee(){const t=A(),[o,w]=u.useState(g.cursorSearch),[l,C]=u.useState(g.cronSearch),[f,P]=u.useState({}),b=U({queryKey:["jobs"],queryFn:()=>M()}),c=p({mutationFn:s=>B(s,null),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),d=p({mutationFn:s=>D(s.jobname,s.active),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),x=p({mutationFn:s=>J(s.jobname,s.schedule),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),m=p({mutationFn:s=>I(s),onSuccess:async()=>{await t.invalidateQueries({queryKey:["jobs"]}),await t.invalidateQueries({queryKey:["logs"]}),await t.invalidateQueries({queryKey:["overview"]})}}),F=c.isPending||d.isPending||x.isPending||m.isPending,a=b.data,N=u.useMemo(()=>{if(!a)return[];const s=o.trim().toLowerCase();return s?a.job_state.filter(i=>i.job_name.toLowerCase().includes(s)||(i.cursor??"").toLowerCase().includes(s)):a.job_state},[a,o]),y=u.useMemo(()=>{if(!a)return[];const s=l.trim().toLowerCase();return s?a.cron_jobs.filter(i=>i.jobname.toLowerCase().includes(s)||String(i.jobid).includes(s)):a.cron_jobs},[a,l]);if(b.isLoading)return e.jsx(R,{});if(b.error)return e.jsx(h,{error:b.error});const _=a,q=[o.trim()?`cursors: "${o.trim()}"`:null,l.trim()?`cron: "${l.trim()}"`:null].filter(Boolean);function L(){w(g.cursorSearch),C(g.cronSearch)}return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx($,{children:"Jobs"}),q.length?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Applied: ",e.jsx("span",{className:"font-mono",children:q.join(" • ")})]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"No filters applied."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(j,{variant:"ghost",onClick:L,disabled:F,children:"Reset filters"})})]}),e.jsxs(E,{title:"Saved job cursors (media_job_state)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(S,{value:o,onChange:s=>w(s.target.value),placeholder:"Filter by job name or cursor…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[N.length," rows"]})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs(Q,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(n,{children:"Job"}),e.jsx(n,{children:"Cursor"}),e.jsx(n,{children:"Updated"}),e.jsx(n,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:N.length?N.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.job_name}),e.jsx(v,{text:String(s.job_name),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.cursor??"—"}),s.cursor?e.jsx(v,{text:String(s.cursor),label:"Copy",className:"h-8 px-2 py-1 text-xs"}):null]})}),e.jsx(r,{className:"text-xs text-zinc-600",children:s.updated_at?k(s.updated_at):"—"}),e.jsx(r,{className:"text-right",children:e.jsx(j,{variant:"ghost",onClick:()=>c.mutate(s.job_name),disabled:c.isPending,title:"Reset stored cursor to null",children:"Reset cursor"})})]},s.job_name)):e.jsx("tr",{children:e.jsx(r,{colSpan:4,className:"p-6",children:e.jsx(K,{title:"No saved cursors",message:"No rows in media_job_state yet.",className:"border-0 bg-transparent p-0"})})})})]}),c.isError?e.jsx(h,{error:c.error,className:"mt-2"}):null]})]}),e.jsxs(E,{title:"Cron jobs (pg_cron)",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("div",{className:"w-[360px] max-w-full",children:e.jsx(S,{value:l,onChange:s=>C(s.target.value),placeholder:"Filter cron jobs…"})}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[y.length," rows"]})]}),_.cron_error?e.jsxs("div",{className:"mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:[e.jsx("div",{className:"font-semibold",children:"Cron error"}),e.jsx("div",{className:"mt-1 font-mono text-xs",children:_.cron_error})]}):null,e.jsxs("div",{className:"mt-3",children:[e.jsxs(Q,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"Name"}),e.jsx(n,{children:"Schedule"}),e.jsx(n,{children:"Status"}),e.jsx(n,{className:"text-right",children:"Action"})]})}),e.jsx("tbody",{children:y.length?y.map(s=>e.jsxs("tr",{children:[e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobid??"—"}),e.jsx(v,{text:String(s.jobid??""),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:s.jobname}),e.jsx(v,{text:String(s.jobname),label:"Copy",className:"h-8 px-2 py-1 text-xs"})]})}),e.jsx(r,{className:"font-mono text-xs",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"w-[220px]",children:e.jsx(S,{value:f[s.jobname]??s.schedule??"",onChange:i=>P(z=>({...z,[s.jobname]:i.target.value})),placeholder:"* * * * *",className:"py-1"})}),e.jsx(j,{variant:"ghost",onClick:()=>x.mutate({jobname:s.jobname,schedule:(f[s.jobname]??s.schedule??"").trim()}),disabled:x.isPending||!(f[s.jobname]??s.schedule??"").trim(),children:"Save"})]})}),e.jsx(r,{children:e.jsx("span",{className:T("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold",s.active?"border-emerald-200 bg-emerald-50 text-emerald-800":"border-zinc-200 bg-zinc-50 text-zinc-700"),children:s.active?"Active":"Paused"})}),e.jsx(r,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(j,{variant:"ghost",onClick:()=>d.mutate({jobname:s.jobname,active:!s.active}),disabled:d.isPending,children:s.active?"Pause":"Activate"}),e.jsx(j,{variant:"ghost",onClick:()=>m.mutate(s.jobname),disabled:m.isPending,title:"Run this cron immediately",children:"Run now"})]})})]},s.jobname)):e.jsx("tr",{children:e.jsx(r,{colSpan:5,className:"p-6",children:e.jsx(K,{title:"No cron jobs",message:"No cron jobs registered (or pg_cron not enabled).",className:"border-0 bg-transparent p-0"})})})})]}),d.isError?e.jsx(h,{error:d.error,className:"mt-2"}):null,x.isError?e.jsx(h,{error:x.error,className:"mt-2"}):null,m.isError?e.jsx(h,{error:m.error,className:"mt-2"}):null]})]})]})}export{ee as default};
