import{C as Ae,r as n,ak as De,s as W,b as _e,e as se,c as We,al as Os,w as Xe,am as Nt,an as Fs,ao as qs,o as Us,ap as Ct,n as Ps,aq as St,ar as Le,as as $s,at as Et,ah as Tt,au as Hs,av as Ks,R as Z,j as e,i as Qs,E as oe,B as $,aw as zs,ax as Js,ay as Vs,u as Dt,ai as V,I as Gs,a as Ys,A as Ws,aj as Rt,L as Xs}from"./index-DHFRnTo7.js";import{i as At,m as _t,a as Lt,b as Bt,c as Zs,n as en,r as Ot,M as Ft,d as qt,e as tn,S as sn,T as nn,u as rn,f as an}from"./scroll-area-WFgP_c77.js";import{g as on,h as ln,a as Be,b as un,u as Ze,c as et,S as cn,d as dn}from"./useConversationMessages-BRxbVw01.js";import{r as Ut,i as fn,C as mn,c as kt,u as gn,M as hn}from"./MessageRow-BfOmKWGc.js";import{u as xe}from"./conversationsCache-_zctdFM2.js";import{w as pn,a as xn,B as yn,M as bn}from"./MuteOptionsSheet-CQ34DQMY.js";import{Y as vn}from"./index-Ou-srJcE.js";import{B as wn}from"./bell-DVRPzCbj.js";import{T as Pt}from"./textarea-xzg6jW3B.js";import{C as jn}from"./circle-alert-C1loB_9g.js";import{D as tt,a as st,b as $t,c as nt,d as Ht,e as Kt}from"./dialog-Bg-HG0JV.js";import{M as J}from"./material-icon-CCSOLX5B.js";import{C as Mn}from"./copy-jck8F9gH.js";import{U as Nn}from"./user-eqfrGxiL.js";import"./format-BXv9LLlt.js";import"./index-DN-awVsS.js";import"./plus-C3tuX2q7.js";import"./x--91eKTks.js";import"./check-37UNc4XQ.js";import"./clock-CcMzpr3g.js";const Cn=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Rn=Ae("arrow-down",Cn);const kn=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],In=Ae("camera",kn);const Sn=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Qt=Ae("shield-x",Sn);const En=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Tn=Ae("smile",En);function Dn(s){const{conversation:t,deliveryReceipts:r,readReceipts:i,currentUserId:o,failedMessages:u,onlyMessageIds:f,messageCreatedAtMsById:m}=s;if(!t||!o)return()=>null;const a=t.participants.filter(g=>!g.isSelf);if(a.length===0)return()=>null;const l=new Set(a.map(g=>g.id)),p=g=>{if(!g)return null;const d=m?.get(g);return d??null},y=new Map;for(const g of i??[]){let d=null;if(g.lastReadMessageId){const x=p(g.lastReadMessageId);x!=null&&(d=x),x==null&&(d=null)}else if(g.lastReadAt){const x=new Date(g.lastReadAt).getTime();Number.isNaN(x)||(d=x)}if(d==null)continue;const v=y.get(g.userId);(v==null||d>v)&&y.set(g.userId,d)}const h=new Map;for(const g of r??[]){if(!l.has(g.userId)||f&&!f.has(g.messageId))continue;let d=h.get(g.messageId);d||(d=new Set,h.set(g.messageId,d)),d.add(g.userId)}return g=>{if(g.senderId!==o)return null;if(u[g.id])return{status:"failed"};if(At(g.id))return{status:"sending"};const d=(()=>{const C=new Date(g.createdAt??"").getTime();return Number.isNaN(C)?0:C})();let v=0,x=null;for(const C of a){const S=y.get(C.id);S!=null&&S>=d&&(v+=1,(x===null||S>x)&&(x=S))}return v===a.length&&a.length>0?{status:"seen",seenAt:x!=null?new Date(x).toISOString():null}:(h.get(g.id)?.size??0)===a.length&&a.length>0?{status:"delivered"}:{status:"sent"}}}function An(s){const{messages:t,conversation:r,currentUserId:i,participantsById:o,reactionsByMessageId:u,hiddenMessageIds:f,deliveryReceipts:m,readReceipts:a,failedMessages:l,lastOwnMessageId:p}=s,y=n.useMemo(()=>{if(!t)return[];const g=new Set;p&&g.add(p);for(const x of Object.keys(l))g.add(x);const d=new Map;for(const x of t){const M=new Date(x.createdAt??"").getTime();Number.isNaN(M)||d.set(x.id,M)}const v=Dn({conversation:r??null,deliveryReceipts:m,readReceipts:a,currentUserId:i,failedMessages:l,onlyMessageIds:g,messageCreatedAtMsById:d});return t.map(x=>{const M=De(x.body),C=o.get(x.senderId)??null,S=C?.isSelf??(i!=null&&x.senderId===i),A=S&&g.has(x.id)?v(x):null,b=!!A&&S&&!M.deleted&&(A.status==="failed"||p===x.id);return{message:x,meta:M,sender:C,isSelf:S,deliveryStatus:A,showDeliveryStatus:b,reactions:u.get(x.id)??[]}})},[r,i,m,l,p,t,o,u,a]),h=n.useMemo(()=>y.filter(({message:g})=>!f[g.id]),[y,f]);return{uiMessages:y,visibleMessages:h}}function _n(s){const{messages:t,currentUserId:r,hiddenMessageIds:i}=s;return n.useMemo(()=>{if(!t||!r)return null;for(let o=t.length-1;o>=0;o-=1){const u=t[o];if(!(i[u.id]||u.senderId!==r||De(u.body).deleted))return u.id}return null},[i,t,r])}const Ln=async s=>{const{data:t,error:r}=await W.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",s).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(t??[]).map(Lt)},Bn=async(s,t)=>{if(t.length===0)return[];const r=W.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",s).in("message_id",t),{data:i,error:o}=await r.order("created_at",{ascending:!0}).returns();if(o)throw console.error("[useConversationDeliveryReceipts] Failed to load",o),new Error(o.message);return(i??[]).map(Bt)},On=async s=>{const{data:t,error:r}=await W.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",s).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(t??[]).map(_t)},Fn=(s,t)=>{const r=new Map,i=new Map;for(const u of s){let f=r.get(u.messageId);f||(f=new Map,r.set(u.messageId,f),i.set(u.messageId,[]));let m=f.get(u.emoji);m||(m={emoji:u.emoji,count:0,reactedBySelf:!1},f.set(u.emoji,m),i.get(u.messageId).push(u.emoji)),m.count+=1,t&&u.userId===t&&(m.reactedBySelf=!0)}const o=new Map;for(const[u,f]of r.entries()){const m=i.get(u)??[];o.set(u,m.map(a=>f.get(a)).filter(Boolean))}return o},qn=(s,t,r)=>{const i=s??[],o=r.key(t),u=[...i],f=u.findIndex(m=>r.key(m)===o);return f>=0?u[f]=t:u.push(t),r.sort&&u.sort(r.sort),u},Un=(s,t,r)=>{const i=s??[];return i.length===0?[]:i.filter(o=>r.key(o)!==t)},rt=s=>t=>{const r=on(t);if(!ln(r,s.conversationId)||s.extraGuard&&!s.extraGuard(r)||!(s.getRequiredId?s.getRequiredId(r):Be(r,"id")))return;const o=r,u=s.mapRow(o);s.queryClient.setQueryData(s.queryKey,f=>qn(f,u,{key:s.key,sort:s.sort}))},Pn=s=>t=>{const r=un(t),i=s.getRowId?s.getRowId(r):Be(r,"id");if(!i){s.invalidateWhenMissingId!==!1&&s.queryClient.invalidateQueries({queryKey:s.queryKey});return}s.queryClient.setQueryData(s.queryKey,o=>Un(o,i,{key:s.key}))},$n=s=>{const{user:t}=_e(),r=t?.id??null,i=se(),o=Os(s),{pollWhenRealtimeDown:u,onRealtimeStatus:f,refetchOptions:m}=Ze(s),a=We({queryKey:o,enabled:!!s,...m,queryFn:()=>s?On(s):Promise.resolve([])}),l=n.useCallback(()=>{if(!s)return{};const h=rt({conversationId:s,queryClient:i,queryKey:o,mapRow:_t,key:d=>d.id,sort:(d,v)=>{const x=Nt(d.createdAt),M=Nt(v.createdAt);return x!==M?x-M:d.id.localeCompare(v.id)}}),g=Pn({queryClient:i,queryKey:o,key:d=>d.id});return{onStatus:f,onReactionUpsert:h,onReactionDelete:g}},[s,f,i,o]);et(s,l,[]);const p=Xe({mutationFn:async({messageId:h,emoji:g})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:d}=await W.from("message_reactions").insert({conversation_id:s,message_id:h,user_id:r,emoji:g});if(d){if(d?.code==="23505"){const{error:v}=await W.from("message_reactions").delete().eq("message_id",h).eq("user_id",r).eq("emoji",g);if(v)throw console.error("[useConversationReactions] Failed to remove reaction",v),v;return}throw console.error("[useConversationReactions] Failed to toggle reaction",d),d}},onMutate:async({messageId:h,emoji:g})=>{if(!s||!r)return{previousReactions:void 0};await i.cancelQueries({queryKey:o});const d=i.getQueryData(o);return i.setQueryData(o,v=>{const x=v??[],M=x.findIndex(S=>S.messageId===h&&S.userId===r&&S.emoji===g);if(M>=0){const S=[...x];return S.splice(M,1),S}const C={id:Zs(),conversationId:s,messageId:h,userId:r,emoji:g,createdAt:new Date().toISOString()};return[...x,C]}),{previousReactions:d}},onError:(h,g,d)=>{s&&(d?.previousReactions?i.setQueryData(o,d.previousReactions):i.invalidateQueries({queryKey:o}))},onSuccess:()=>{s&&i.invalidateQueries({queryKey:o})}}),y=n.useMemo(()=>{const h=a.data??[];return Fn(h,r)},[a.data,r]);return{reactions:a.data??[],reactionsByMessageId:y,isLoadingReactions:a.isLoading,toggleReaction:p,pollWhenRealtimeDown:u,queryKey:o}},Hn=s=>{const t=se(),r=Fs(s),{pollWhenRealtimeDown:i,onRealtimeStatus:o,refetchOptions:u}=Ze(s),f=We({queryKey:r,enabled:!!s,...u,queryFn:async()=>s?Ln(s):[]}),m=n.useCallback(()=>{if(!s)return{};const a=rt({conversationId:s,queryClient:t,queryKey:r,mapRow:Lt,key:l=>l.userId,getRequiredId:l=>Be(l,"user_id"),sort:(l,p)=>{const y=!l.lastReadAt,h=!p.lastReadAt;if(y&&h)return 0;if(y)return 1;if(h)return-1;const g=new Date(l.lastReadAt).getTime(),d=new Date(p.lastReadAt).getTime();return Number.isNaN(g)&&Number.isNaN(d)?0:Number.isNaN(g)?1:Number.isNaN(d)?-1:d-g}});return{onStatus:o,onReadReceiptUpsert:a}},[s,o,t,r]);return et(s,m,[]),n.useMemo(()=>({...f,pollWhenRealtimeDown:i,queryKey:r}),[f,i,r])},Kn=(s,t)=>{const r=se(),i=n.useMemo(()=>en(t,{excludeTemp:!0,sort:!0}),[t]),o=qs(s,i),{pollWhenRealtimeDown:u,onRealtimeStatus:f,refetchOptions:m}=Ze(s),a=We({queryKey:o,enabled:!!(s&&i.length>0),...m,queryFn:async()=>s?i.length===0?[]:Bn(s,i):[]}),l=n.useCallback(()=>{if(!s)return{};if(i.length===0)return{};const y=new Set(i),h=rt({conversationId:s,queryClient:r,queryKey:o,mapRow:Bt,key:g=>g.id,extraGuard:g=>{const d=Be(g,"message_id");return!!(d&&y.has(d))},sort:(g,d)=>{const v=new Date(g.deliveredAt??"").getTime(),x=new Date(d.deliveredAt??"").getTime(),M=Number.isNaN(v)?0:v,C=Number.isNaN(x)?0:x;return M-C}});return{onStatus:f,onDeliveryReceiptUpsert:h}},[s,i,f,r,o]),p=s&&i.length>0?s:null;return et(p,l,[]),n.useMemo(()=>({...a,pollWhenRealtimeDown:u,queryKey:o}),[a,u,o])},Qn=3e3,zn=2e3,Jn=5e3,Vn=s=>{const{conversationId:t,userId:r,displayName:i}=s,[o,u]=n.useState({}),f=n.useRef(null),m=n.useRef(new Map),a=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),l=n.useCallback(async d=>{if(!t||!r||!i)return;const v=f.current;v&&await v.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:i,isTyping:d}})},[t,r,i]),p=n.useCallback(async()=>{a.current.timeoutId!=null&&(window.clearTimeout(a.current.timeoutId),a.current.timeoutId=null),a.current.isTyping&&(a.current.isTyping=!1,a.current.lastSentAtMs=0,await l(!1))},[l]),y=n.useCallback(d=>{if(!t||!r||!i||!f.current)return;const x=a.current.isTyping;if(d){const M=Date.now();x?M-a.current.lastSentAtMs>zn&&(a.current.lastSentAtMs=M,l(!0)):(a.current.isTyping=!0,a.current.lastSentAtMs=M,l(!0)),a.current.timeoutId!=null&&window.clearTimeout(a.current.timeoutId),a.current.timeoutId=window.setTimeout(()=>{a.current.isTyping=!1,a.current.lastSentAtMs=0,a.current.timeoutId=null,l(!1)},Qn);return}x&&p()},[l,t,i,p,r]),h=n.useCallback(()=>{u({}),m.current.forEach(d=>window.clearTimeout(d)),m.current.clear()},[]);return n.useEffect(()=>{if(!t)return;h();const d=W.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});f.current=d,d.on("broadcast",{event:"typing"},({payload:M})=>{const C=M;if(!C?.userId||r&&C.userId===r)return;u(A=>{const b={...A};return C.isTyping&&C.displayName?b[C.userId]=C.displayName:delete b[C.userId],b});const S=m.current.get(C.userId);if(S!=null&&window.clearTimeout(S),C.isTyping){const A=window.setTimeout(()=>{u(b=>{const w={...b};return delete w[C.userId],w}),m.current.delete(C.userId)},Jn);m.current.set(C.userId,A)}else m.current.delete(C.userId)}).subscribe();const v=()=>{document.visibilityState==="hidden"&&p()},x=()=>{p()};return document.addEventListener("visibilitychange",v),window.addEventListener("beforeunload",x),window.addEventListener("pagehide",x),window.addEventListener("blur",x),()=>{document.removeEventListener("visibilitychange",v),window.removeEventListener("beforeunload",x),window.removeEventListener("pagehide",x),window.removeEventListener("blur",x),h(),p(),f.current&&(W.removeChannel(f.current),f.current=null)}},[t,p,r,h]),{remoteTypingUsers:n.useMemo(()=>Object.entries(o).map(([d,v])=>({userId:d,displayName:v})),[o]),noteLocalInputActivity:y,stopTyping:p}},Gn=s=>{const{conversationId:t,storageKeyPrefix:r="messages:draft:",hydrate:i,debounceMs:o=250}=s,u=n.useRef(i);n.useEffect(()=>{u.current=i},[i]);const f=n.useMemo(()=>t?`${r}${t}`:null,[t,r]),[m,a]=n.useState("");return n.useEffect(()=>{if(!f){a(""),u.current?.("");return}const y=Us(f)??"";a(y),u.current?.(y)},[f]),n.useEffect(()=>{if(!f)return;const p=window.setTimeout(()=>{m.trim().length===0?Ct(f):Ps(f,m)},o);return()=>window.clearTimeout(p)},[f,o,m]),{draft:m,setDraft:a,clearDraft:()=>{f&&Ct(f),a(""),u.current?.("")}}};function Yn({showComposer:s,initialHeaderHeight:t=72,initialComposerHeight:r=160}){const i=n.useRef(null),[o,u]=n.useState(t),[f,m]=n.useState(r),[a,l]=n.useState(null),[p,y]=n.useState(!1),h=n.useCallback(g=>m(Math.max(g,o)),[o]);return n.useEffect(()=>{const g=i.current;if(!g)return;const d=()=>u(Math.max(g.getBoundingClientRect().height,0));if(d(),typeof ResizeObserver>"u")return;const v=new ResizeObserver(d);return v.observe(g),()=>v.disconnect()},[]),n.useEffect(()=>{m(g=>Math.max(g,o))},[o]),n.useEffect(()=>{s||m(0)},[s]),{headerRef:i,headerHeight:o,composerHeight:f,isAtBottom:a,setIsAtBottom:l,handleComposerHeightChange:h,showEmojiPicker:p,setShowEmojiPicker:y}}const Wn=({conversationId:s,currentUserId:t,showComposer:r,isBlocked:i,blockedYou:o,composerTextareaRef:u,messageIds:f})=>{const[m,a]=n.useState(null),[l,p]=n.useState({}),[y,h]=n.useState(null),[g,d]=n.useState(null),[v,x]=n.useState(null),M=n.useRef(null),C=n.useRef(null);n.useEffect(()=>{if(!s||!t){p({});return}if(typeof window>"u")return;const I=`messages:hidden:${t}:${s}`;try{const k=window.localStorage.getItem(I);if(!k){p({});return}const E=JSON.parse(k);if(Array.isArray(E)){const _={};for(const q of E)typeof q=="string"&&q&&(_[q]=!0);p(_);return}if(E&&typeof E=="object"){const _={};for(const[q,ee]of Object.entries(E))ee&&(_[q]=!0);p(_);return}p({})}catch{p({})}},[s,t]),n.useEffect(()=>{if(!s||!t||typeof window>"u")return;const I=`messages:hidden:${t}:${s}`;try{const k=Object.keys(l).filter(E=>l[E]);window.localStorage.setItem(I,JSON.stringify(k))}catch{}},[s,t,l]),n.useEffect(()=>{if(!f||f.length===0)return;const I=new Set(f);p(k=>{let E=!1;const _={};for(const q of Object.keys(k))I.has(q)?_[q]=!0:E=!0;return E?_:k})},[f]);const S=n.useCallback(()=>{a(null)},[]);n.useEffect(()=>{if(!m||typeof document>"u")return;const I=E=>{const _=E.target;if(!(_ instanceof Element)){a(null);return}_.closest(`[data-message-action-scope="${m}"]`)||a(null)},k=E=>{E.key==="Escape"&&a(null)};return document.addEventListener("pointerdown",I,!0),document.addEventListener("keydown",k),()=>{document.removeEventListener("pointerdown",I,!0),document.removeEventListener("keydown",k)}},[m]);const A=n.useCallback(I=>{i||o||De(I.body).deleted||(a(I.id),u.current?.blur())},[o,u,i]),b=n.useCallback((I,k)=>{i||o||De(I.body).deleted||(k&&(C.current=k),d({messageId:I.id,text:St(I.body)??"",body:I.body??null,attachmentUrl:I.attachmentUrl??null}),x(null),S(),u.current?.blur())},[o,S,u,i]),w=n.useCallback(I=>{d(k=>k&&{...k,text:I})},[]),N=n.useCallback(()=>{d(null),x(null),C.current?.focus()},[]);n.useEffect(()=>{g&&queueMicrotask(()=>{M.current?.focus()})},[g]);const R=n.useCallback(I=>{i||o||(S(),h({messageId:I.id,attachmentUrl:I.attachmentUrl??null}),u.current?.blur())},[o,S,u,i]),L=n.useCallback(()=>{h(null)},[]),U=n.useCallback(I=>{p(k=>({...k,[I]:!0}))},[]);return n.useEffect(()=>{m===null&&r&&(g||y||queueMicrotask(()=>u.current?.focus()))},[m,y,g,r,u]),{activeActionMessageId:m,openMessageActions:A,closeMessageActions:S,hiddenMessageIds:l,hideMessageForMe:U,deleteDialog:y,openDeleteDialog:R,closeDeleteDialog:L,editingMessage:g,openEditDialog:b,updateEditingText:w,closeEditDialog:N,editTextareaRef:M,editError:v,setEditError:x}},It=3e3;function Xn(s){const{conversationId:t,userId:r,isAtBottom:i,messages:o}=s,u=se(),f=n.useRef({conversationId:null,messageId:null,userId:null}),m=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{f.current={conversationId:null,messageId:null,userId:null};const a=m.current;a.timeoutId!=null&&window.clearTimeout(a.timeoutId),a.timeoutId=null,a.pending=null,a.lastSentAt=0},[t,r]),n.useEffect(()=>()=>{const a=m.current;a.timeoutId!=null&&window.clearTimeout(a.timeoutId),a.timeoutId=null},[]),n.useEffect(()=>{if(!t||!o||o.length===0||!r||!i)return;const a=o[o.length-1];if(At(a.id)||f.current.conversationId===t&&f.current.messageId===a.id&&f.current.userId===r)return;const l=m.current,p=Date.now(),y=l.lastSentAt?p-l.lastSentAt:Number.POSITIVE_INFINITY,h=()=>{xe(u,r,t,d=>d.hasUnread?{...d,hasUnread:!1}:d)},g=d=>{l.lastSentAt=Date.now();const v=new Date().toISOString();pn({conversation_id:t,user_id:r,last_read_message_id:d,last_read_at:v}).then(()=>{f.current={conversationId:t,messageId:d,userId:r},h()}).catch(x=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",x)})};if(y<It){l.pending={conversationId:t,userId:r,messageId:a.id},l.timeoutId==null&&(l.timeoutId=window.setTimeout(()=>{const d=m.current.pending;m.current.pending=null,m.current.timeoutId=null,d&&(f.current.conversationId===d.conversationId&&f.current.messageId===d.messageId&&f.current.userId===d.userId||d.conversationId!==t||d.userId!==r||g(d.messageId))},Math.max(It-y,0)));return}l.timeoutId!=null&&(window.clearTimeout(l.timeoutId),l.timeoutId=null,l.pending=null),g(a.id)},[t,o,r,u,i])}const Zn=new Set(["text","image","text+image","system"]),er=s=>{const{user:t}=_e(),r=t?.id??null,i=se();return Xe({mutationFn:async({messageId:o,text:u,currentBody:f,attachmentUrl:m})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(m)throw new Error("Cannot edit messages with attachments.");const a=$s(f,u),l=Et(a),p=Zn.has(l.type)?l.type:"text",{data:y,error:h}=await W.from("messages").update({body:a,message_type:p,text:l.text.trim()?l.text:null,client_id:l.clientId??null,meta:l.meta??null}).eq("id",o).eq("conversation_id",s).eq("user_id",r).select(Ft).single();if(h)throw console.error("[useEditMessage] Failed to edit message",h),new Error(h.message);return qt(y)},onSuccess:o=>{if(!s)return;const u=Le(s);i.setQueryData(u,f=>Ot(f,o))}})},tr=s=>{const{user:t}=_e(),r=t?.id??null,i=se();return Xe({mutationFn:async({messageId:o,attachmentUrl:u})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const m={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},a=JSON.stringify(m),l=Et(a),{data:p,error:y}=await W.from("messages").update({body:a,message_type:"system",text:l.text.trim()?l.text:null,client_id:l.clientId??null,meta:l.meta??null,attachment_url:null}).eq("id",o).eq("conversation_id",s).eq("user_id",r).select(Ft).single();if(y)throw console.error("[useDeleteMessage] Failed to delete message",y),new Error(y.message);if(u)try{await Ut(u)}catch(g){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",g)}return qt(p)},onSuccess:o=>{if(!s)return;const u=Le(s);i.setQueryData(u,f=>Ot(f,o)),i.invalidateQueries({queryKey:Tt(r)})}})};function sr(s){const{conversationId:t,setDraft:r,messages:i}=s,o=se(),[u,f]=n.useState(null),[m,a]=n.useState(null),[l,p]=n.useState(null),[y,h]=n.useState({}),g=n.useRef({});n.useEffect(()=>{g.current=y},[y]);const d=n.useRef(t);n.useEffect(()=>{t!==d.current&&(d.current=t,f(null),a(null),p(null),h({}),g.current={})},[t]),n.useEffect(()=>()=>{const b=Object.values(g.current),w=Array.from(new Set(b.map(N=>N.attachmentPath).filter(N=>typeof N=="string"&&N.length>0&&!fn(N))));w.length!==0&&W.storage.from(mn).remove(w).then(({error:N})=>{N&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",N)}).catch(N=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",N)})},[t]),n.useEffect(()=>{i&&h(b=>{const w=new Set(i.map(L=>L.id));let N=!1;const R={...b};for(const L of Object.keys(R))w.has(L)||(delete R[L],N=!0);return N?R:b})},[i]);const v=n.useCallback(()=>{f(null),a(null),p(null)},[]),x=n.useCallback((b,w,N)=>{f(N.message||"Couldn't send. Please try again."),w.text.trim()&&r(w.text),a(w),p(b),h(R=>({...R,[b]:w}))},[r]),M=n.useCallback(b=>{b&&(h(w=>{if(!(b in w))return w;const N={...w};return delete N[b],N}),b===l&&v())},[v,l]),C=n.useCallback(()=>{if(!m)return null;const b=l;return b&&h(w=>{if(!(b in w))return w;const N={...w};return delete N[b],N}),v(),{payload:m,tempId:b}},[v,m,l]),S=n.useCallback(b=>{const w=y[b];return w?(h(N=>{if(!(b in N))return N;const R={...N};return delete R[b],R}),b===l?v():f(null),w):null},[v,y,l]),A=n.useCallback(async b=>{if(!t)return;const w=y[b];if(!w)return;const N=Le(t);if(o.setQueryData(N,R=>tn(R,b)),h(R=>{if(!(b in R))return R;const L={...R};return delete L[b],L}),b===l&&v(),w.attachmentPath)try{await Ut(w.attachmentPath)}catch(R){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",R)}},[v,t,y,l,o]);return{sendError:u,setSendError:f,lastFailedPayload:m,lastFailedTempId:l,failedMessages:y,clearBannerState:v,onSendFailed:x,onSendRecovered:M,consumeLastFailedForRetry:C,consumeFailedMessageForRetry:S,discardFailedMessage:A}}const nr=({currentUserId:s})=>{const t=se();return n.useCallback(r=>{xe(t,s,r.conversationId,i=>{const o=!!(s&&r.senderId===s);return{...i,lastMessagePreview:Ks(r.body)??i.lastMessagePreview,lastMessageAt:r.createdAt??i.lastMessageAt,lastMessageAtLabel:Hs(r.createdAt??null),hasUnread:!o,lastMessageIsFromSelf:o,lastMessageSeenByOthers:o?!1:i.lastMessageSeenByOthers}},{moveToTop:!0}),s&&r.senderId!==s&&xn({conversation_id:r.conversationId,message_id:r.id,user_id:s})},[s,t])},rr=({conversationId:s,userId:t,conversation:r,readReceipts:i,visibleMessages:o})=>{const[u,f]=n.useState(void 0),[m,a]=n.useState(void 0);return n.useEffect(()=>{f(void 0),a(void 0)},[s,t]),n.useEffect(()=>{if(!s||!t||u!==void 0)return;const p=(i??[]).find(y=>y.userId===t)??null;f(p?.lastReadMessageId??null)},[s,u,i,t]),n.useEffect(()=>{!s||!t||m===void 0&&r&&a(!!r.hasUnread)},[r,s,m,t]),{firstUnreadIndex:n.useMemo(()=>{if(m===void 0||!m||o.length===0||u===void 0)return null;if(u===null)return 0;const p=o.findIndex(h=>h.message.id===u);if(p<0)return 0;const y=p+1;return y>=o.length?null:y},[m,u,o]),lastReadMessageId:u??null,hasUnread:!!m}};function ar({items:s=[],itemContent:t,isLoading:r,loadingContent:i,errorContent:o,emptyContent:u,footer:f,bottomPadding:m,followOutput:a=!1,onAtBottomChange:l,atBottomThreshold:p,computeItemKey:y,firstItemIndex:h,onStartReached:g,header:d,ariaLabel:v,autoScrollOnNewLastItem:x,autoScrollBehavior:M,autoScrollEnabled:C=!0,virtuosoRef:S}){const A=Z.useRef(null),b=S??A,w=Math.max(0,h??0),N=Z.useRef(null),R=Z.useRef(null),L=Z.useCallback(()=>{const k=N.current;if(!k)return;const E=typeof p=="number"?p:80,q=k.scrollHeight-(k.scrollTop+k.clientHeight)<=E;R.current!==q&&(R.current=q,l?.(q))},[p,l]);Z.useEffect(()=>{L()},[L,s?.length]);const U=Z.useRef(null);if(Z.useEffect(()=>{if(!x||!C||!s||s.length===0)return;const k=s.length-1,E=s[k],_=y?y(k,E):k,q=U.current;U.current=_,!(q==null||q===_)&&requestAnimationFrame(()=>{b.current?.scrollToIndex({index:w+k,align:"end",behavior:M??"smooth"})})},[M,x,C,w,y,s]),r)return e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:i});if(o)return e.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:o});if(!(s?.length??0))return e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:u});const I=Z.forwardRef((k,E)=>e.jsx("div",{...k,ref:_=>{N.current=_,typeof E=="function"?E(_):E&&(E.current=_)},onScroll:_=>{k.onScroll?.(_),L()}}));return I.displayName="MessageListScroller",e.jsx("div",{className:"relative flex min-h-0 flex-1 overflow-hidden",role:"log","aria-live":"polite","aria-relevant":"additions text","aria-label":v??"Messages",children:e.jsx(vn,{ref:b,data:s??[],style:{height:"100%",width:"100%"},className:"scrollbar-hide px-4 pt-4",alignToBottom:!0,followOutput:a,atBottomStateChange:l,atBottomThreshold:p,startReached:g,increaseViewportBy:400,firstItemIndex:w,computeItemKey:y?(k,E)=>y(k-w,E):void 0,itemContent:(k,E)=>t(k-w,E),components:{Scroller:I,Header:()=>d?e.jsx("div",{className:"pt-2",children:d}):null,Footer:()=>e.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",style:{paddingBottom:m??"10rem"},children:f})}})})}const or=({show:s,pendingCount:t,onClick:r,shortcutHint:i})=>{if(!s)return null;const o=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":o,title:i?`${o} (${i})`:o,children:[e.jsx(Rn,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Jump to latest"}),t>0&&e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},ir=({show:s,unreadCount:t,onClick:r,shortcutHint:i})=>{if(!s||t<=0)return null;const o=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":o,title:i?`${o} (${i})`:o,children:[e.jsx(wn,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Unread"}),e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},lr=({children:s,className:t,onHeightChange:r,minHeight:i,style:o,...u})=>{const f=Z.useRef(null);return Z.useEffect(()=>{if(!r||!f.current)return;const m=f.current,a=()=>r(m.getBoundingClientRect().height);a();const l=new ResizeObserver(a);return l.observe(m),()=>l.disconnect()},[r]),e.jsx("div",{ref:f,className:"fixed inset-x-0 bottom-0 z-40 w-full",children:e.jsx("div",{className:"w-full",children:e.jsx("form",{...u,className:Qs("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",t),style:{minHeight:i,...o},children:s})})})},ur=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Te=2e3,cr=({show:s,headerHeight:t,onHeightChange:r,typingUsers:i,isGroupConversation:o,draft:u,setDraft:f,textareaRef:m,noteLocalInputActivity:a,stopTyping:l,onSendText:p,onRequestScrollToBottom:y,isUploadingImage:h,cancelImageUpload:g,sendError:d,sendErrorMessage:v,canRetrySend:x,onRetrySend:M,uploadError:C,clearUploadError:S,showEmojiPicker:A,setShowEmojiPicker:b,openCameraPicker:w,fileInputRef:N,onImageSelected:R,onImageFile:L,isSending:U,disableSend:I})=>{const k=n.useCallback(T=>{const F=T.target.value,K=F.length>Te?F.slice(0,Te):F;f(K),A&&b(!1),a(K.trim().length>0);const G=T.target;G.style.height="auto";const me=Math.min(G.scrollHeight,140);G.style.height=`${me}px`},[a,f,b,A]),E=n.useCallback(T=>{T&&(f(F=>{const K=`${F}${T}`;return a(K.trim().length>0),K}),queueMicrotask(()=>{const F=m.current;F&&(F.style.height="auto",F.style.height=`${Math.min(F.scrollHeight,140)}px`)}))},[a,f,m]),_=n.useCallback(T=>{if(T.preventDefault(),I||U||h)return;const F=u.trim();F&&(f(""),l(),y?.(),p(F))},[I,u,U,h,y,p,f,l]);if(!s)return null;const q=I||!u.trim()||U||h,ee=h||U||I;return e.jsxs(lr,{onSubmit:_,className:"space-y-2",onHeightChange:r,minHeight:t,onDragOver:T=>{!L||I||(T.preventDefault(),T.dataTransfer.dropEffect="copy",T.currentTarget.dataset.dragging="true")},onDragLeave:T=>{T.currentTarget.dataset.dragging="false"},onDrop:T=>{if(!L||I||U||h)return;T.preventDefault(),T.currentTarget.dataset.dragging="false";const F=T.dataTransfer.files;if(!F||F.length===0)return;const K=Array.from(F).find(G=>G.type.startsWith("image/"));K&&(y?.(),L(K))},children:[i.length>0&&e.jsxs("div",{className:"flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:o?i.length===1?`${i[0].displayName} is typingâ€¦`:i.length===2?`${i[0].displayName} and ${i[1].displayName} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}),h&&e.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(oe,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:"Uploading imageâ€¦"})]}),e.jsx($,{type:"button",size:"sm",variant:"outline",onClick:g,children:"Cancel"})]}),d&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:v??"Couldn't send. Please try again."})]}),x&&e.jsx($,{type:"button",size:"sm",variant:"outline",onClick:M,children:"Retry"})]}),C&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jn,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:C})]}),e.jsx($,{type:"button",size:"sm",variant:"ghost",onClick:S,children:"Dismiss"})]}),e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs(zs,{open:A,onOpenChange:b,children:[e.jsx(Js,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:e.jsx(Tn,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(Vs,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:e.jsx(sn,{className:"max-h-64",children:e.jsx("div",{className:"grid grid-cols-9 gap-2",children:ur.map(T=>e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{E(T),b(!1)},children:e.jsx("span",{children:T})},T))})})})]}),e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:w,"aria-label":"Send photo",disabled:ee,"aria-busy":h,children:e.jsx(In,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:N,accept:"image/*",className:"hidden",onChange:R}),e.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:e.jsx(Pt,{id:"conversation-message",value:u,ref:m,rows:1,autoComplete:"off",onChange:k,onBlur:l,onPaste:T=>{if(!L||I||U||h)return;const F=T.clipboardData?.items;if(!F)return;const K=Array.from(F).find(me=>me.type.startsWith("image/"));if(!K)return;const G=K.getAsFile();G&&(T.preventDefault(),y?.(),L(G))},onKeyDown:T=>{if(T.key==="Enter"&&!T.shiftKey){if(I||q||!u.trim())return;T.preventDefault(),y?.(),T.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),e.jsx($,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:T=>T.preventDefault(),disabled:q,"aria-label":"Send message","aria-busy":U||h,children:U||h?e.jsx(oe,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(cn,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsxs("div",{className:"flex items-center justify-between px-1 text-[11px] text-muted-foreground",children:[e.jsx("span",{children:"Enter to send â€¢ Shift+Enter for newline"}),e.jsxs("span",{className:u.length>=Te?"text-red-300":"",children:[u.length,"/",Te]})]})]})},dr=({open:s,editingMessage:t,onOpenChange:r,onCancel:i,onTextChange:o,onSave:u,textareaRef:f,error:m,isSaving:a})=>e.jsx(tt,{open:s,onOpenChange:r,children:e.jsxs(st,{children:[e.jsxs($t,{children:[e.jsx(nt,{children:"Edit message"}),e.jsx(Ht,{children:"Update your message for everyone in the conversation."})]}),t&&e.jsx(Pt,{ref:f,value:t.text,onChange:l=>o(l.target.value),rows:3,className:"min-h-[120px]"}),m&&e.jsx("p",{className:"text-xs text-destructive",children:m}),e.jsxs(Kt,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"ghost",onClick:i,children:"Cancel"}),e.jsxs($,{type:"button",disabled:!t?.text.trim()||a,onClick:u,children:[a&&e.jsx(oe,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),fr=({open:s,deleteDialog:t,onOpenChange:r,onHideForMe:i,onDeleteForEveryone:o,isDeleting:u})=>e.jsx(tt,{open:s,onOpenChange:r,children:e.jsxs(st,{children:[e.jsxs($t,{className:"gap-1",children:[e.jsxs(nt,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:e.jsx(nn,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),e.jsx(Ht,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),e.jsxs(Kt,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"outline",className:"flex-1",onClick:i,disabled:!t,children:"Hide for me"}),e.jsxs($,{type:"button",variant:"destructive",className:"flex-1",disabled:u||!t,onClick:o,children:[u&&e.jsx(oe,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]})]})}),mr=({participant:s,onClick:t})=>{const r=(s.displayName??s.username??"?").slice(0,1).toUpperCase();return e.jsxs("button",{type:"button",onClick:t,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!t,children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:s.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.displayName}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:s.username?`@${s.username}`:s.isSelf?"You":""})]}),t?e.jsx(J,{name:"chevron_right",className:"text-muted-foreground"}):null]})},gr=({open:s,onOpenChange:t,conversation:r,currentUserId:i,conversationId:o,isMuted:u,onToggleMute:f,otherParticipant:m,isGroupConversation:a,youBlocked:l,blockedYou:p,blockPending:y,onBlockToggle:h})=>{const g=Dt(),d=n.useMemo(()=>r?.participants??[],[r?.participants]),v=!a&&!!m?.username&&!m?.isSelf,[x,M]=n.useState(null);n.useEffect(()=>{const b=r?.mutedUntil;if(!u||!b){M(null);return}const w=Date.parse(b);if(!Number.isFinite(w)||w<=Date.now()){M(null);return}try{M(new Date(w).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{M(null)}},[r?.mutedUntil,u]);const C=async()=>{const b=`${window.location.origin}/messages/${o}`;await kt(b)?V.show("Conversation link copied."):V.error("Couldn't copy to clipboard.")},S=async()=>{await kt(o)?V.show("Conversation ID copied."):V.error("Couldn't copy to clipboard.")},A=b=>{if(!b.username){V.show("This profile can't be opened yet.");return}t(!1),g(`/u/${b.username}`)};return e.jsx(tt,{open:s,onOpenChange:t,children:e.jsxs(st,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none sm:rounded-2xl sm:bottom-6 sm:rounded-b-2xl sm:translate-y-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(nt,{className:"text-base",children:"Conversation info"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:a?`${d.length} participants`:m?.username?`@${m.username}`:"Direct message"})]}),e.jsx("button",{type:"button",onClick:()=>t(!1),className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted/60 hover:text-foreground","aria-label":"Close",children:e.jsx(J,{name:"close"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:C,children:[e.jsx(Mn,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:S,children:[e.jsx(J,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{f(),t(!1)},children:[e.jsx(yn,{className:"h-4 w-4","aria-hidden":!0}),u?"Unmute notifications":"Mute notifications"]}),x?e.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",x]}):null]}),!a&&e.jsxs("div",{className:"mt-2 grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!v||!m||A(m)},disabled:!v,children:[e.jsx(Nn,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:h,disabled:y||p&&!l,children:[e.jsx(Qt,{className:"h-4 w-4","aria-hidden":!0}),l?"Unblock":p?"Blocked":"Block"]}),(p||l)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:p&&!l?"This user has blocked you.":l?"You blocked this user.":null})]}),a&&e.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),e.jsx("div",{className:"grid gap-1",children:d.map(b=>e.jsx(mr,{participant:b,onClick:b.username&&b.id!==i?()=>A(b):void 0},b.id))})]})]})})};function hr(){const[s,t]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),i=()=>{t(r.matches)};return i(),typeof r.addEventListener=="function"?(r.addEventListener("change",i),()=>r.removeEventListener("change",i)):(r.addListener(i),()=>r.removeListener(i))},[]),s}const pr=2;function xr(s){const{items:t,onJumpToItemIndex:r,minQueryLen:i=pr}=s,[o,u]=n.useState(!1),[f,m]=n.useState(""),[a,l]=n.useState(0),p=f.trim().toLowerCase(),y=p.length>=i,h=n.useMemo(()=>{if(!y)return[];const w=[];for(let N=0;N<t.length;N++){const R=t[N];if(R.meta.deleted)continue;const L=St(R.message.body);L&&L.toLowerCase().includes(p)&&w.push(N)}return w},[t,p,y]),g=n.useMemo(()=>{const w=new Set;for(const N of h){const R=t[N]?.message.id;R&&w.add(R)}return w},[t,h]),d=h.length;n.useEffect(()=>{l(0)},[p]),n.useEffect(()=>{d!==0&&(a<0&&l(0),a>d-1&&l(d-1))},[a,d]);const v=n.useCallback(w=>{if(d===0)return;const N=(w%d+d)%d;l(N);const R=h[N];typeof R=="number"&&r?.(R)},[d,h,r]),x=n.useCallback(()=>{v(a+1)},[a,v]),M=n.useCallback(()=>{v(a-1)},[a,v]),C=n.useCallback(()=>{v(0)},[v]),S=n.useCallback(()=>{m(""),l(0)},[]),A=n.useCallback(()=>{u(!1),m(""),l(0)},[]),b=n.useMemo(()=>{if(d===0)return null;const w=h[a];return t[w]?.message.id??null},[a,t,d,h]);return{query:f,setQuery:m,isOpen:o,setIsOpen:u,matchCount:d,activeMatchNumber:d===0?0:a+1,activeMatchIndex:d===0?-1:a,activeMessageId:b,isMatch:w=>g.has(w),jumpNext:x,jumpPrev:M,jumpToFirst:C,clear:S,close:A}}const yr="movinesta",br="31661b41-efc0-4f29-ba72-1a3e48cb1c80",Ur=()=>{const{conversationId:s}=Gs(),t=s??null,r=n.useRef(null),i=Dt();Ys();const{user:o}=_e(),u=se(),{data:f,isLoading:m}=Ws(),a=o?.id??null,l=n.useMemo(()=>!t||!f?null:f.find(c=>c.id===t)??null,[t,f]),p=l?.isMuted??!1,[y,h]=n.useState(!1),g=n.useCallback(()=>{if(!t)return;if(!a){V.error("Please sign in to manage messages.");return}const c=l?.isMuted??!1,j=l?.mutedUntil??null,O=l?.isHidden??!1;xe(u,a,t,P=>({...P,isMuted:!1,mutedUntil:null})),V.show("Unmuted notifications."),Rt(a,t,{muted:!1,hidden:O,mutedUntil:null}).then(({ok:P})=>{P||(xe(u,a,t,H=>({...H,isMuted:c,mutedUntil:j})),V.error("Couldn't update preferences."))})},[t,a,l,u]),d=n.useCallback(c=>{if(!t)return;if(!a){V.error("Please sign in to manage messages.");return}const j=l?.isMuted??!1,O=l?.mutedUntil??null,P=l?.isHidden??!1;let H=!1,X=null;c.kind==="indefinite"?(H=!0,X=null):(H=!1,X=new Date(Date.now()+c.minutes*6e4).toISOString()),xe(u,a,t,Ce=>({...Ce,isMuted:!0,mutedUntil:X})),V.show(`Muted notifications for ${c.label}.`),Rt(a,t,{muted:H,hidden:P,mutedUntil:X}).then(({ok:Ce})=>{Ce||(xe(u,a,t,Ye=>({...Ye,isMuted:j,mutedUntil:O})),V.error("Couldn't update preferences."))})},[t,a,l,u]),v=n.useCallback(()=>{if(p){g();return}h(!0)},[p,g]),x=nr({currentUserId:o?.id??null}),{data:M,isLoading:C,isError:S,error:A,loadOlder:b,hasMore:w,isLoadingOlder:N,firstItemIndex:R,pollWhenRealtimeDown:L}=dn(t,{onInsert:x}),U=n.useRef(new Set);n.useEffect(()=>{if(!t||!M||M.length===0)return;const c=U.current,j=new Set(M.map(O=>O.id));for(const O of M)c.has(O.id)||x(O);U.current=j},[t,M,x]);const{draft:I,setDraft:k}=Gn({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const c=ye.current;c&&(c.style.height="auto",c.style.height=`${Math.min(c.scrollHeight,140)}px`)})}}),{sendError:E,lastFailedPayload:_,failedMessages:q,clearBannerState:ee,onSendFailed:T,onSendRecovered:F,consumeLastFailedForRetry:K,consumeFailedMessageForRetry:G,discardFailedMessage:me}=sr({conversationId:t,setDraft:c=>k(c),messages:M}),Y=l?.isGroup??!1,z=n.useMemo(()=>{if(!l)return null;const c=l.participants.filter(j=>!j.isSelf);return c.length>0?c[0]:l.participants.length===1?l.participants[0]:null},[l]),at=n.useMemo(()=>{const c=z;return c?c.id===br||c.username?.toLowerCase()===yr:!1},[z]),[ot,it]=n.useState(!1),Oe=l?.title??z?.displayName??z?.username??"Conversation",Fe=rn(t,{onFailed:T,onRecovered:F,otherUserId:Y?null:z?.id??null}),ge=n.useCallback((c,j)=>{ee(),Fe.mutate({text:c.text,attachmentPath:c.attachmentPath,clientId:c.clientId,tempId:j?.tempId},{onSuccess:async O=>{if(ee(),at&&t&&a&&c.text.trim().length>0)try{it(!0);const{data:P,error:H}=await W.functions.invoke("assistant-chat-reply",{body:{conversationId:t,userMessageId:O.id}});H?console.error("assistant-chat-reply failed",H):P?.ok||console.warn("assistant-chat-reply not ok",P)}catch(P){console.error("assistant-chat-reply threw",P)}finally{it(!1),u.invalidateQueries({queryKey:Le(t)}),u.invalidateQueries({queryKey:Tt(a)})}}})},[ee,t,a,at,u,Fe]),ye=n.useRef(null),qe=n.useRef(null),ie=n.useRef(!1),zt=n.useMemo(()=>{const c=new Map;if(!l)return c;for(const j of l.participants)c.set(j.id,j);return c},[l]),{youBlocked:be,blockedYou:Q,isBlocked:le,block:Re,unblock:ke}=an(Y?null:z?.id??null),{fileInputRef:Jt,isUploadingImage:Vt,uploadError:Gt,cancelImageUpload:Yt,clearUploadError:Wt,handleImageSelected:Xt,sendImageFile:Zt,openFilePicker:es}=gn({conversationId:t,userId:a,isBlocked:le,blockedYou:Q,attemptSend:ge}),ve=!le&&!Q,Ue=!!z&&!Y,ts=Re.isPending||ke.isPending,[ss,lt]=n.useState(!1),ns=n.useCallback(()=>{if(Ue){if(be){ke.mutate();return}Q||Re.mutate()}},[Re,Q,Ue,ke,be]),Pe=Ue?{label:be?"Unblock":Q?"Blocked":"Block",onClick:()=>{be?ke.mutate():Q||Re.mutate()}}:null,{headerRef:rs,headerHeight:as,composerHeight:ut,isAtBottom:te,setIsAtBottom:ct,handleComposerHeightChange:dt,showEmojiPicker:os,setShowEmojiPicker:Ie}=Yn({showComposer:ve}),[is,ls]=n.useState(!1),us=ve?`calc(${Math.max(ut,0)}px + 20px)`:"2.5rem",cs=ve?Math.max(120,Math.max(ut,0)+24):80,ds=n.useCallback(c=>{ct(c),ls(!0)},[ct]),fs=n.useMemo(()=>l?.participants.find(c=>c.isSelf)?.displayName??"You",[l]),{remoteTypingUsers:Se,noteLocalInputActivity:ms,stopTyping:gs}=Vn({conversationId:t,userId:o?.id??null,displayName:fs}),{data:ft}=Hn(t);Xn({conversationId:t,userId:o?.id??null,isAtBottom:te===!0&&is,messages:M});const{reactionsByMessageId:hs,toggleReaction:mt}=$n(t),ps=n.useCallback((c,j)=>{mt.mutate({messageId:c,emoji:j})},[mt]),ne=n.useRef(null),$e=n.useRef(!1),we=n.useRef(null),He=n.useRef(!1),[gt,je]=n.useState(0),he=hr(),{activeActionMessageId:xs,openMessageActions:ht,closeMessageActions:Ee,hiddenMessageIds:pt,hideMessageForMe:ys,deleteDialog:ue,openDeleteDialog:bs,closeDeleteDialog:Ke,editingMessage:ce,openEditDialog:vs,updateEditingText:ws,closeEditDialog:Qe,editTextareaRef:js,editError:Ms,setEditError:xt}=Wn({conversationId:t,currentUserId:a,showComposer:ve,isBlocked:le,blockedYou:Q,composerTextareaRef:ye,messageIds:M?.map(c=>c.id)??[]}),ze=_n({messages:M,currentUserId:a,hiddenMessageIds:pt}),{data:Ns}=Kn(t,ze?[ze]:[]),yt=er(t),bt=tr(t),{visibleMessages:B}=An({messages:M,conversation:l,currentUserId:a,participantsById:zt,reactionsByMessageId:hs,hiddenMessageIds:pt,deliveryReceipts:Ns??[],readReceipts:ft??[],failedMessages:q,lastOwnMessageId:ze}),{firstUnreadIndex:pe,lastReadMessageId:Je,hasUnread:Me}=rr({conversationId:t,userId:o?.id??null,conversation:l,readReceipts:ft,visibleMessages:B}),vt=n.useMemo(()=>pe==null?Me?1:0:B.slice(pe).filter(c=>!c.isSelf&&!c.meta.deleted).length,[pe,Me,B]),wt=B.length>0,jt=n.useRef(B),Mt=n.useRef(w);n.useEffect(()=>{jt.current=B},[B]),n.useEffect(()=>{Mt.current=w},[w]),n.useEffect(()=>{const c=B.length?B[B.length-1]?.message.id??null:null;if(te===!0){we.current=c,je(0);return}if(!c)return;const j=we.current;if(j===c)return;const O=j?B.findIndex(X=>X.message.id===j):-1;if(j&&O<0){we.current=c,je(0);return}const H=B.slice(Math.max(0,O+1)).filter(X=>!X.isSelf).length;H<=0||je(H)},[te,B]),n.useEffect(()=>()=>{ne.current!=null&&window.clearTimeout(ne.current)},[]);const Cs=()=>{const c=K();c&&ge(c.payload,{tempId:c.tempId??void 0})},Rs=c=>{ne.current!=null&&window.clearTimeout(ne.current),$e.current=!1,ne.current=window.setTimeout(()=>{$e.current=!0,ht(c)},500)},ks=()=>{ne.current!=null&&(window.clearTimeout(ne.current),ne.current=null)},Is=n.useCallback(c=>{const j=G(c.id);j&&ge(j,{tempId:c.id})},[ge,G]),Ss=n.useCallback(c=>{me(c.id)},[me]),de=he?"auto":"smooth",Es=n.useCallback(c=>{c<0||r.current?.scrollToIndex({index:R+c,align:"center",behavior:de})},[R,de]),D=xr({items:B,onJumpToItemIndex:c=>{ie.current=!0,Es(c)}}),re=D.query.trim().length>=2;n.useEffect(()=>{D.close()},[t,D.close]);const Ve=()=>{Ee(),Ie(!1),D.setIsOpen(!0),queueMicrotask(()=>qe.current?.focus())},Ne=()=>{D.close()};n.useEffect(()=>{const c=j=>{if(j.key==="Escape"){if(D.isOpen){j.preventDefault(),Ne();return}Ee(),Ie(!1)}};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[Ee,Ne,D.isOpen,Ie]),n.useEffect(()=>{ie.current=!1},[D.query]);const ae=n.useCallback(c=>{const j=B.length-1;if(j<0)return;const O=B[j]?.message.id??null;O&&(we.current=O),je(0),r.current?.scrollToIndex({index:R+j,align:"end",behavior:c??de}),window.setTimeout(()=>{ye.current?.focus()},he?0:200)},[R,de,he,B]),Ts=n.useCallback(c=>{dt(c),te===!0&&requestAnimationFrame(()=>{const j=B.length-1;j<0||r.current?.scrollToIndex({index:R+j,align:"end",behavior:"auto"})})},[R,dt,te,B.length]),Ge=n.useCallback(async c=>{if(Me&&!He.current){He.current=!0;try{let j=pe;if(j==null&&Je){let O=0;for(;Mt.current&&O<8;){const P=jt.current.findIndex(H=>H.message.id===Je);if(P>=0){j=P+1;break}await b(),O+=1}}if(j==null)return;r.current?.scrollToIndex({index:R+j,align:"start",behavior:c??de}),window.setTimeout(()=>{ye.current?.focus()},he?0:150)}finally{He.current=!1}}},[R,pe,Me,Je,b,he,de]),Ds=n.useCallback(c=>{c.trim()&&(ee(),ae("auto"),ge({text:c.trim(),attachmentPath:null}),requestAnimationFrame(()=>ae("smooth")))},[ge,ee,ae]);n.useEffect(()=>{we.current=null,je(0)},[t]),n.useEffect(()=>{const c=j=>{if(j.key.toLowerCase()==="f"&&(j.metaKey||j.ctrlKey)){j.preventDefault(),Ve();return}if(j.key==="End"||j.key==="ArrowDown"&&(j.metaKey||j.ctrlKey)||j.key==="End"&&(j.metaKey||j.ctrlKey)){j.preventDefault(),ae();return}j.key.toLowerCase()==="u"&&j.altKey&&(j.preventDefault(),Ge())};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[ae,Ge,Ve]);const fe=n.useMemo(()=>Se.map(c=>c.displayName).filter(Boolean),[Se]),As=n.useMemo(()=>Q?"You are blocked":le?"You blocked them":ot?"Typingâ€¦":fe.length>0?Y?fe.length===1?`${fe[0]} is typingâ€¦`:fe.length===2?`${fe[0]} and ${fe[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦":l?.subtitle||(Y?"Group chat":"Direct message"),[Q,le,ot,fe,Y,l?.subtitle]);return t?e.jsxs("div",{className:"conversation-page relative flex min-h-screen w-full flex-col items-stretch bg-background text-foreground",children:[e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[e.jsxs("div",{ref:rs,className:"sticky top-0 z-20 border-b border-border bg-background/80 backdrop-blur-md",children:[e.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>i(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:e.jsx(J,{name:"arrow_back"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:z?.avatarUrl?e.jsx("img",{src:z.avatarUrl,alt:z.displayName??"Conversation",className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(z?.displayName??Oe).slice(0,2).toUpperCase()})}),!Y&&Se.length>0&&e.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background bg-green-500"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:Oe}),e.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:As})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Search in conversation",onClick:()=>{D.isOpen?Ne():Ve()},children:e.jsx(J,{name:"search"})}),e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",onClick:()=>V.show("Video calls are coming soon."),children:e.jsx(J,{name:"videocam"})}),e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",onClick:()=>lt(!0),children:e.jsx(J,{name:"info"})}),Pe?e.jsx("button",{type:"button",onClick:Pe.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":Pe.label,children:e.jsx(Qt,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),D.isOpen&&e.jsxs("div",{className:"px-4 pb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:e.jsx(J,{name:"search",className:"text-muted-foreground"})}),e.jsx("input",{ref:qe,value:D.query,onChange:c=>D.setQuery(c.target.value),onKeyDown:c=>{if(c.key==="Enter"){if(c.preventDefault(),!re||D.matchCount===0)return;if(c.shiftKey){ie.current=!0,D.jumpPrev();return}if(!ie.current){D.jumpToFirst(),ie.current=!0;return}D.jumpNext()}c.key==="Escape"&&(c.preventDefault(),Ne())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary",autoComplete:"off",spellCheck:!1}),D.query.trim()&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground transition hover:text-foreground","aria-label":"Clear search",onClick:()=>{D.clear(),queueMicrotask(()=>qe.current?.focus())},children:e.jsx(J,{name:"close"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Previous match",disabled:!re||D.matchCount===0,onClick:()=>{ie.current=!0,D.jumpPrev()},children:e.jsx(J,{name:"keyboard_arrow_up"})}),e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Next match",disabled:!re||D.matchCount===0,onClick:()=>{ie.current=!0,D.jumpNext()},children:e.jsx(J,{name:"keyboard_arrow_down"})}),e.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:re?`${D.activeMatchNumber}/${D.matchCount}`:"0/0"}),e.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Close search",onClick:Ne,children:e.jsx(J,{name:"close"})})]})]}),re&&D.matchCount===0&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[L&&e.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:e.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[e.jsx(oe,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),e.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),e.jsx(ar,{items:B,isLoading:C&&!wt,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(oe,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:S?e.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[e.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),A instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:A.message})]}):void 0,emptyContent:wt?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:Y?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:Y?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:e.jsx("div",{className:"h-1","aria-hidden":!0}),header:w?e.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:N?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(oe,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):e.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:us,followOutput:te===!0?he?!0:"smooth":!1,autoScrollOnNewLastItem:!0,autoScrollBehavior:de,autoScrollEnabled:te===!0,atBottomThreshold:cs,onAtBottomChange:ds,onStartReached:()=>{w&&!N&&b()},firstItemIndex:R,virtuosoRef:r,computeItemKey:(c,j)=>j.message.id,itemContent:(c,j)=>{const{message:O,meta:P,sender:H,isSelf:X,deliveryStatus:Ce,reactions:Ye,showDeliveryStatus:_s}=j,Ls=c>0?B[c-1]?.message??null:null,Bs=c<B.length-1?B[c+1]?.message??null:null;return e.jsx(hn,{message:O,meta:P,sender:H,isSelf:X,deliveryStatus:Ce,showDeliveryStatus:_s,reactions:Ye,index:c,previousMessage:Ls,nextMessage:Bs,firstUnreadIndex:pe,activeActionMessageId:xs,longPressTriggeredRef:$e,onOpenMessageActions:ht,onCloseMessageActions:Ee,onOpenEditDialog:vs,onOpenDeleteDialog:bs,onToggleReaction:ps,onRetryMessage:Is,onDiscardFailedMessage:Ss,onBubbleTouchStart:Rs,onBubbleTouchEndOrCancel:ks,searchQuery:re?D.query:void 0,isSearchMatch:re?D.isMatch(O.id):!1,isActiveSearchMatch:re?D.activeMessageId===O.id:!1})}}),e.jsx(ir,{show:!!(Me&&vt>0&&te!==!0),unreadCount:vt,onClick:Ge,shortcutHint:"Alt+U"}),e.jsx(or,{show:te!==!0&&gt>0,pendingCount:gt,onClick:ae,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),e.jsx(cr,{show:ve,headerHeight:as,onHeightChange:Ts,typingUsers:Se,isGroupConversation:Y,draft:I,setDraft:k,textareaRef:ye,noteLocalInputActivity:ms,stopTyping:gs,onSendText:Ds,onRequestScrollToBottom:ae,isUploadingImage:Vt,cancelImageUpload:Yt,sendError:!!E,sendErrorMessage:E,canRetrySend:!!_,onRetrySend:Cs,uploadError:Gt,clearUploadError:Wt,showEmojiPicker:os,setShowEmojiPicker:Ie,openCameraPicker:es,fileInputRef:Jt,onImageSelected:c=>{ae("auto"),Xt(c)},onImageFile:c=>Zt(c),isSending:Fe.isPending,disableSend:!!(le||Q)}),Q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),le&&!Q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),e.jsx(dr,{open:!!ce,editingMessage:ce,onOpenChange:c=>{c||Qe()},onCancel:Qe,onTextChange:ws,textareaRef:js,error:Ms,isSaving:yt.isPending,onSave:()=>{if(!ce)return;const c=ce.text.trim();c&&(xt(null),yt.mutate({messageId:ce.messageId,text:c,currentBody:ce.body,attachmentUrl:ce.attachmentUrl},{onSuccess:()=>{Qe()},onError:()=>{xt("Couldn't save changes. Please try again.")}}))}}),e.jsx(fr,{open:!!ue,deleteDialog:ue,onOpenChange:c=>{c||Ke()},onHideForMe:()=>{ue&&(ys(ue.messageId),Ke())},onDeleteForEveryone:()=>{ue&&bt.mutate({messageId:ue.messageId,attachmentUrl:ue.attachmentUrl},{onSettled:()=>{Ke()}})},isDeleting:bt.isPending}),t&&e.jsx(gr,{open:ss,onOpenChange:lt,conversation:l,currentUserId:a,conversationId:t,isMuted:p,onToggleMute:v,otherParticipant:z,isGroupConversation:Y,youBlocked:be,blockedYou:Q,blockPending:ts,onBlockToggle:ns}),t&&e.jsx(bn,{open:y,onOpenChange:h,conversationTitle:Oe,onSelect:c=>d(c)})]}):e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Xs,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Ur as default,rn as useSendMessage};
