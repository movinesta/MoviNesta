import{g as p,n as w,o as f,z as l,s as y,h as b}from"./index-D8UbFo8l.js";const q=(r,e)=>{const{user:a}=p(),o=e??(a==null?void 0:a.id)??null,u=b({queryKey:["diary","library",o],enabled:!!o,queryFn:async()=>{if(!o)return[];const{data:n,error:c}=await y.from("library_entries").select(`
            id, title_id, status, updated_at,
            titles!inner (
              title_id, primary_title, release_year, content_type, poster_url, backdrop_url
            )
          `).eq("user_id",o).order("updated_at",{ascending:!1}).limit(500);if(c)throw new Error(c.message);const d=n??[];if(!d.length)return[];const _=Array.from(new Set(d.map(i=>i.title_id).filter(i=>!!i)));let m=new Map;if(_.length){const{data:i,error:t}=await y.from("ratings").select("title_id, rating").eq("user_id",o).in("title_id",_);!t&&i?m=new Map(i.map(g=>[g.title_id,g.rating])):t&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",t.message)}return d.map(i=>{const t=i.titles,g=m.get(i.title_id)??null;return{id:i.id,titleId:i.title_id,status:i.status,updatedAt:i.updated_at,title:(t==null?void 0:t.primary_title)??"Untitled",year:(t==null?void 0:t.release_year)??null,type:(t==null?void 0:t.content_type)??null,posterUrl:(t==null?void 0:t.poster_url)??(t==null?void 0:t.backdrop_url)??null,rating:g}})}});return{entries:(u.data??[]).filter(n=>!(r.status&&r.status!=="all"&&n.status!==r.status||r.type&&r.type!=="all"&&n.type!==r.type)),isLoading:u.isLoading,isError:u.isError,error:u.error instanceof Error?u.error.message:null}},S=r=>{const{user:e}=p(),a=(e==null?void 0:e.id)??null;return b({queryKey:l.titleDiary(a,r),enabled:!!(a&&r),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!a||!r)return{status:null,rating:null};const[{data:o,error:u},{data:s,error:n}]=await Promise.all([y.from("library_entries").select("status").eq("user_id",a).eq("title_id",r).maybeSingle(),y.from("ratings").select("rating").eq("user_id",a).eq("title_id",r).maybeSingle()]);if(u&&u.code!=="PGRST116")throw u;if(n&&n.code!=="PGRST116")throw n;return{status:(o==null?void 0:o.status)??null,rating:(s==null?void 0:s.rating)??null}}})},E=()=>{const{user:r}=p(),e=(r==null?void 0:r.id)??null,a=w(),o=f({mutationFn:async({titleId:s,status:n,type:c})=>{if(!e)throw new Error("Not authenticated");if(!c)throw new Error("Content type is required");const{error:d}=await y.from("library_entries").upsert({user_id:e,title_id:s,status:n,updated_at:new Date().toISOString(),content_type:c},{onConflict:"user_id,title_id"});if(d)throw new Error(d.message);return{titleId:s,status:n}},onSuccess:()=>{e&&(a.invalidateQueries({queryKey:l.diaryLibrary(e)}),a.invalidateQueries({queryKey:l.diaryStats(e)}),a.invalidateQueries({queryKey:l.homeForYou(e)}),a.invalidateQueries({queryKey:l.titleDiary(e,void 0)}))}}),u=f({mutationFn:async({titleId:s,rating:n,type:c})=>{if(!e)throw new Error("Not authenticated");if(!c)throw new Error("Content type is required");if(n==null){const{error:_}=await y.from("ratings").delete().eq("user_id",e).eq("title_id",s);if(_)throw new Error(_.message);return{titleId:s,rating:null}}const{error:d}=await y.from("ratings").upsert({user_id:e,title_id:s,rating:n,updated_at:new Date().toISOString(),content_type:c},{onConflict:"user_id,title_id"});if(d)throw new Error(d.message);return{titleId:s,rating:n}},onSuccess:()=>{e&&(a.invalidateQueries({queryKey:l.diaryLibrary(e)}),a.invalidateQueries({queryKey:l.diaryStats(e)}),a.invalidateQueries({queryKey:l.homeForYou(e)}),a.invalidateQueries({queryKey:l.titleDiary(e,void 0)}))}});return{updateStatus:o,updateRating:u}},v=r=>{switch(r){case"want_to_watch":return"Want to watch";case"watching":return"Watching";case"watched":return"Watched";case"dropped":return"Dropped";default:return"Tap to add status"}},D=r=>{switch(r){case"want_to_watch":return"border-amber-500/40 bg-amber-500/10 text-amber-200";case"watching":return"border-sky-500/40 bg-sky-500/10 text-sky-200";case"watched":return"border-emerald-500/40 bg-emerald-500/10 text-emerald-200";case"dropped":return"border-rose-500/40 bg-rose-500/10 text-rose-200";default:return"border-mn-border-subtle bg-mn-bg/60 text-mn-text-secondary"}};export{E as a,D as b,S as c,v as d,q as u};
