import{c as M,d as J,v as K,e as re,w as G,s as y,r as c,j as e,p as W,R as Kt,o as Yt,u as zt,g as Ht,z as De,L as Vt,A as ot}from"./index-DhZ1aP8k.js";import{f as Wt,b as Gt}from"./format-DWLSBLoY.js";import{H as Jt,A as Xt}from"./PageChrome-D5rVYUnf.js";import{U as Zt}from"./users-B9oifkuI.js";import{I as es}from"./info-Bp5B4Gdq.js";import{Y as ts}from"./index-iD4_ZCVg.js";import{C as lt}from"./circle-alert-CddkEOkp.js";import{X as Me}from"./x-DiTvPX9C.js";import"./brand-DTIDtbc4.js";const ss=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],dt=M("camera",ss);const rs=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],ns=M("check-check",rs);const as=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],is=M("check",as);const os=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ct=M("image",os);const ls=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],ds=M("pen-line",ls);const cs=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],us=M("phone",cs);const ms=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],ut=M("send",ms);const fs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],gs=M("smile",fs);const hs=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],mt=M("trash-2",hs);const xs=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],bs=M("video",xs);async function ht(t,r,o){const{data:a,error:i}=await t.from("blocked_users").select("blocker_id, blocked_id").or(`and(blocker_id.eq.${r},blocked_id.eq.${o}),and(blocker_id.eq.${o},blocked_id.eq.${r})`);if(i)throw i;const u=a??[],f=u.some(m=>m.blocker_id===r&&m.blocked_id===o),d=u.some(m=>m.blocker_id===o&&m.blocked_id===r);return{youBlocked:f,blockedYou:d}}const ps=t=>{const{user:r}=J(),o=r?.id??null,a=K(),i=["block-status",o,t],u=re({queryKey:i,enabled:!!(o&&t&&o!==t),staleTime:3e4,queryFn:async()=>{if(!o||!t||o===t)return{youBlocked:!1,blockedYou:!1};try{return await ht(y,o,t)}catch(g){console.error("[useBlockStatus] Failed to load block status",g);const _=g;throw new Error(_.message??"Failed to load block status")}}}),f=G({mutationFn:async()=>{if(!o||!t)throw new Error("Missing user ids for block operation.");const{error:g}=await y.from("blocked_users").upsert({blocker_id:o,blocked_id:t},{onConflict:"blocker_id,blocked_id"});if(g)throw console.error("[useBlockStatus] Failed to block user",g),new Error(g.message)},onSuccess:()=>{a.invalidateQueries({queryKey:i})}}),d=G({mutationFn:async()=>{if(!o||!t)throw new Error("Missing user ids for unblock operation.");const{error:g}=await y.from("blocked_users").delete().eq("blocker_id",o).eq("blocked_id",t);if(g)throw console.error("[useBlockStatus] Failed to unblock user",g),new Error(g.message)},onSuccess:()=>{a.invalidateQueries({queryKey:i})}}),m=u.data?.youBlocked??!1,x=u.data?.blockedYou??!1,h=m||x,p=f.isPending||d.isPending;return{youBlocked:m,blockedYou:x,isBlocked:h,isLoading:u.isLoading||p,isError:u.isError,error:u.error??null,block:f,unblock:d}},ys=({isSelf:t,isDeleted:r})=>({bubbleColors:r?"bg-card/80 text-muted-foreground border border-dashed border-border":t?"bg-primary/90 text-white shadow-md shadow-primary/20":"bg-card text-foreground border border-border shadow-md",bubbleShape:t?"rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl rounded-br-2xl":"rounded-tr-3xl rounded-tl-3xl rounded-br-3xl rounded-bl-2xl"}),ft=t=>{const r=new Date(t);return Number.isNaN(r.getTime())?"":Gt(r,{hour:"numeric",minute:"2-digit",hour12:!0})},Ie=(t,r)=>t.getFullYear()===r.getFullYear()&&t.getMonth()===r.getMonth()&&t.getDate()===r.getDate(),vs=t=>{const r=new Date(t);if(Number.isNaN(r.getTime()))return"";const o=new Date,a=new Date;return a.setDate(o.getDate()-1),Ie(r,o)?"Today":Ie(r,a)?"Yesterday":Wt(r,{day:"numeric",month:"short",year:"numeric"})},gt=(t,r,o=180*1e3)=>{const a=new Date(t),i=new Date(r);return Number.isNaN(a.getTime())||Number.isNaN(i.getTime())?!1:i.getTime()-a.getTime()<=o},xt=t=>({id:t.id,conversationId:t.conversation_id,senderId:t.user_id,body:t.body??null,attachmentUrl:t.attachment_url??null,createdAt:t.created_at??new Date().toISOString()}),ws="id, conversation_id, user_id, body, attachment_url, created_at",js=(t,r)=>{const o=Array.isArray(r)?r:[r],a=new Map;for(const i of t??[])a.set(i.id,i);for(const i of o)a.set(i.id,xt(i));return Array.from(a.values()).sort((i,u)=>new Date(i.createdAt??"").getTime()-new Date(u.createdAt??"").getTime())},Ns=t=>{const r=K(),o=re({queryKey:["conversation",t,"messages"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,staleTime:15e3,queryFn:async()=>{if(!t)return[];const{data:a,error:i}=await y.from("messages").select(ws).eq("conversation_id",t).order("created_at",{ascending:!0});if(i)throw console.error("[useConversationMessages] Failed to load messages",i),new Error(i.message);return(a??[]).map(xt)}});return c.useEffect(()=>{if(!t)return;const a=y.channel(`conversation-messages-${t}`),i=u=>{const f=u.new;!f||!f.id||f.conversation_id!==t||r.setQueryData(["conversation",t,"messages"],d=>js(d,f))};return a.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},i).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},i).subscribe(),()=>{y.removeChannel(a)}},[t,r]),o},ks=t=>["conversation",t,"reactions"],_s=t=>({id:t.id,conversationId:t.conversation_id,messageId:t.message_id,userId:t.user_id,emoji:t.emoji,createdAt:t.created_at}),Cs=async t=>{const{data:r,error:o}=await y.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(o)throw console.error("[useConversationReactions] Failed to load reactions",o),new Error(o.message);return(r??[]).map(_s)},Ss=t=>{const{user:r}=J(),o=r?.id??null,a=K(),i=ks(t),u=re({queryKey:i,enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:()=>t?Cs(t):Promise.resolve([])}),f=G({mutationFn:async({messageId:m,emoji:x})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to react to messages.");const{error:h}=await y.from("message_reactions").insert({conversation_id:t,message_id:m,user_id:o,emoji:x});if(h){if(h?.code==="23505"){const{error:p}=await y.from("message_reactions").delete().eq("conversation_id",t).eq("message_id",m).eq("user_id",o).eq("emoji",x);if(p)throw console.error("[useConversationReactions] Failed to remove reaction",p),p;return}throw console.error("[useConversationReactions] Failed to toggle reaction",h),h}},onMutate:async({messageId:m,emoji:x})=>{if(!t||!o)return{previousReactions:void 0};await a.cancelQueries({queryKey:i});const h=a.getQueryData(i);return a.setQueryData(i,p=>{const g=p??[],_=g.findIndex(N=>N.messageId===m&&N.userId===o&&N.emoji===x);if(_>=0){const N=[...g];return N.splice(_,1),N}const w={id:`temp-${Date.now()}`,conversationId:t,messageId:m,userId:o,emoji:x,createdAt:new Date().toISOString()};return[...g,w]}),{previousReactions:h}},onError:(m,x,h)=>{t&&(h?.previousReactions?a.setQueryData(i,h.previousReactions):a.invalidateQueries({queryKey:i}))},onSuccess:()=>{t&&a.invalidateQueries({queryKey:i})}}),d=c.useMemo(()=>{const m=new Map,x=u.data??[];for(const h of x){const p=m.get(h.messageId)??[];let g=p.find(_=>_.emoji===h.emoji);g?(g.count+=1,g.reactedBySelf=g.reactedBySelf||(o?h.userId===o:!1)):(g={count:1,emoji:h.emoji,reactedBySelf:!!(o&&h.userId===o)},p.push(g)),m.set(h.messageId,p)}return m},[u.data,o]);return{reactions:u.data??[],reactionsByMessageId:d,isLoadingReactions:u.isLoading,toggleReaction:f,queryKey:i}},Rs=({conversation:t,isLoading:r,isGroupConversation:o,otherParticipant:a,onBack:i,onToggleBlock:u,blockPending:f=!1,youBlocked:d=!1})=>e.jsxs(Jt,{className:"min-h-[3.5rem] flex-shrink-0 py-3",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:i,className:"inline-flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-card/80 text-foreground shadow-md transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:[e.jsx(Xt,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Back to messages"})]}),e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("div",{className:"relative flex h-11 w-11 flex-shrink-0 items-center justify-center overflow-hidden rounded-full bg-card ring-2 ring-border",children:[e.jsx("div",{className:"absolute inset-0 rounded-full bg-gradient-to-br from-fuchsia-500/25 via-primary/20 to-blue-500/25","aria-hidden":"true"}),e.jsx("div",{className:"relative flex h-9 w-9 items-center justify-center overflow-hidden rounded-full bg-background ring-1 ring-white/30",children:!o&&a?a.avatarUrl?e.jsx("img",{src:a.avatarUrl,alt:a.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-sm font-semibold text-foreground",children:(a.displayName??"U").slice(0,2).toUpperCase()}):e.jsx(Zt,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h1",{className:"truncate text-[15px] font-heading font-semibold text-foreground",children:t?.title??a?.displayName??"Conversation"}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:t?t.lastMessageAtLabel?`Active ${t.lastMessageAtLabel}`:t.subtitle??(o?`${t.participants.length} participants`:"Active now"):r?"Loadingâ€¦":"Details unavailable"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[t&&t.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-card/70 shadow-md transition hover:-translate-y-0.5 hover:bg-background","aria-label":"Audio call",children:e.jsx(us,{className:"h-4 w-4","aria-hidden":"true"})}),t&&t.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-card/70 shadow-md transition hover:-translate-y-0.5 hover:bg-background","aria-label":"Video call",children:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"})}),t&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-card/70 shadow-md transition hover:-translate-y-0.5 hover:bg-background","aria-label":"Conversation info",children:e.jsx(es,{className:"h-4 w-4","aria-hidden":"true"})}),!o&&a&&u&&e.jsxs("button",{type:"button",disabled:f,onClick:u,className:"ml-1 hidden items-center gap-1 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-primary/10 to-blue-500/10 px-3 py-1.5 text-xs font-semibold text-foreground ring-1 ring-border/70 transition hover:-translate-y-0.5 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:opacity-60 sm:inline-flex",children:[f&&e.jsx(W,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:d?"Unblock":"Block"})]})]})]});function Es({items:t,itemContent:r,isLoading:o,loadingContent:a,errorContent:i,emptyContent:u,footer:f,followOutput:d=!1,onAtBottomChange:m,computeItemKey:x}){const h=Kt.useRef(null);return o?e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:a}):i?e.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:i}):t.length?e.jsx("div",{className:"relative flex flex-1",children:e.jsx(ts,{ref:h,data:t,style:{height:"100%",width:"100%"},className:"px-4 py-4",alignToBottom:!0,followOutput:d,atBottomStateChange:m,increaseViewportBy:400,computeItemKey:x,itemContent:(p,g)=>r(p,g),components:f?{Footer:()=>e.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",children:f})}:void 0})}):e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:u})}const Ds=({isSelf:t,isDeleted:r,children:o,className:a="",...i})=>{const{bubbleColors:u,bubbleShape:f}=ys({isSelf:t,isDeleted:r});return e.jsx("button",{type:"button",className:`inline-flex max-w-[80%] px-4 py-2.5 text-sm ${f} ${u} select-none transition-transform duration-150 ease-out ${a}`,...i,children:e.jsx("div",{className:"flex flex-col",children:o})})},Ms=({children:t,...r})=>e.jsx("form",{...r,className:`border-t border-border bg-background/90 px-4 py-3 backdrop-blur ${r.className??""}`,children:t}),Is=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ™","ðŸ”¥","ðŸ˜"],Ae="chat-media",As=(t,r,o)=>{const a=o.split(".").pop()??"jpg",i=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():Date.now();return`message_attachments/${t}/${r}/${Date.now()}-${i}.${a}`},Ts=t=>re({queryKey:["conversation",t,"readReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?12e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:r,error:o}=await y.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1});if(o)throw console.error("[ConversationPage] Failed to load read receipts",o),new Error(o.message);return(r??[]).map(a=>({userId:a.user_id,lastReadAt:a.last_read_at??null,lastReadMessageId:a.last_read_message_id??null}))}}),qs=t=>re({queryKey:["conversation",t,"deliveryReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:r,error:o}=await y.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).order("created_at",{ascending:!0});if(o)throw console.error("[ConversationPage] Failed to load delivery receipts",o),new Error(o.message);return(r??[]).map(a=>({id:a.id,conversationId:a.conversation_id,messageId:a.message_id,userId:a.user_id,deliveredAt:a.delivered_at??a.created_at}))}}),Ps=(t,r)=>{const{user:o}=J(),a=o?.id??null,i=K();return G({mutationFn:async({text:u,attachmentPath:f})=>{if(!t)throw new Error("Missing conversation id.");if(!a)throw new Error("You must be signed in to send messages.");if(r?.otherUserId){const g=await ht(y,a,r.otherUserId);if(g.youBlocked)throw new Error("You have blocked this user. Unblock them to send messages.");if(g.blockedYou)throw new Error("You cannot send messages because this user blocked you.")}const d=u.trim(),m=f&&d?{type:"text+image",text:d}:f?{type:"image",text:""}:{type:"text",text:d},{data:x,error:h}=await y.from("messages").insert({conversation_id:t,user_id:a,body:JSON.stringify(m),attachment_url:f??null}).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(h)throw console.error("[ConversationPage] Failed to send message",h),new Error(h.message);const p={id:x.id,conversationId:x.conversation_id,senderId:x.user_id,body:x.body??null,attachmentUrl:x.attachment_url??null,createdAt:x.created_at};try{await y.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",t)}catch(g){console.error("[ConversationPage] Failed to update conversation timestamp",g)}return p},onMutate:async({text:u,attachmentPath:f})=>{if(!t||!a)return{previousMessages:void 0,tempId:null};const d=`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,m=new Date().toISOString(),x={id:d,conversationId:t,senderId:a,body:JSON.stringify({type:"text",text:u.trim()}),attachmentUrl:f??null,createdAt:m};await i.cancelQueries({queryKey:["conversation",t,"messages"]});const h=i.getQueryData(["conversation",t,"messages"]);return i.setQueryData(["conversation",t,"messages"],p=>{const _=[...p??[],x];return _.sort((w,N)=>new Date(w.createdAt).getTime()-new Date(N.createdAt).getTime()),_}),{previousMessages:h,tempId:d,optimistic:x,payload:{text:u.trim(),attachmentPath:f??null}}},onError:(u,f,d)=>{if(console.error("[ConversationPage] sendMessage error",u),t){const{previousMessages:m,optimistic:x,payload:h,tempId:p}=d??{},g=m??i.getQueryData(["conversation",t,"messages"])??[],_=x?[...g,x]:[...g];_.sort((w,N)=>new Date(w.createdAt).getTime()-new Date(N.createdAt).getTime()),i.setQueryData(["conversation",t,"messages"],_),p&&h&&r?.onFailed&&r.onFailed(p,h)}},onSuccess:(u,f,d)=>{if(!t)return;const m=d?.tempId;i.setQueryData(["conversation",t,"messages"],x=>{const h=x??[],p=m?h.filter(w=>w.id!==m):h.filter(w=>w.id!==u.id),g=p.findIndex(w=>w.id===u.id);if(g>=0){const w=[...p];return w[g]=u,w}const _=[...p,u];return _.sort((w,N)=>new Date(w.createdAt).getTime()-new Date(N.createdAt).getTime()),_}),i.invalidateQueries({queryKey:["conversations"]}),r?.onRecovered&&r.onRecovered(d?.tempId??null)}})},$s=t=>{const{user:r}=J(),o=r?.id??null,a=K();return G({mutationFn:async({messageId:i,text:u})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to edit messages.");const d={type:"text",text:u.trim(),editedAt:new Date().toISOString()},{data:m,error:x}=await y.from("messages").update({body:JSON.stringify(d)}).eq("id",i).eq("user_id",o).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(x)throw console.error("[ConversationPage] Failed to edit message",x),new Error(x.message);return{id:m.id,conversationId:m.conversation_id,senderId:m.user_id,body:m.body??null,attachmentUrl:m.attachment_url??null,createdAt:m.created_at}},onSuccess:i=>{if(!t)return;const u=["conversation",t,"messages"];a.setQueryData(u,f=>f?f.map(d=>d.id===i.id?i:d):[i])}})},Bs=t=>{const{user:r}=J(),o=r?.id??null,a=K();return G({mutationFn:async({messageId:i})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to delete messages.");const f={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},{data:d,error:m}=await y.from("messages").update({body:JSON.stringify(f),attachment_url:null}).eq("id",i).eq("user_id",o).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(m)throw console.error("[ConversationPage] Failed to delete message",m),new Error(m.message);return{id:d.id,conversationId:d.conversation_id,senderId:d.user_id,body:d.body??null,attachmentUrl:d.attachment_url??null,createdAt:d.created_at}},onSuccess:i=>{if(!t)return;const u=["conversation",t,"messages"];a.setQueryData(u,f=>f?f.map(d=>d.id===i.id?i:d):[i]),a.invalidateQueries({queryKey:["conversations"]})}})},Fs=({path:t})=>{const[r,o]=c.useState(null),[a,i]=c.useState(!1);return c.useEffect(()=>{let u=!1;return(async()=>{const{data:d,error:m}=await y.storage.from(Ae).createSignedUrl(t,3600);if(!u){if(m||!d?.signedUrl){console.error("[ChatImage] createSignedUrl error",m),i(!0);return}o(d.signedUrl)}})(),()=>{u=!0}},[t]),a?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"Image unavailable."}):r?e.jsx("div",{className:"mt-1 overflow-hidden rounded-xl border border-border bg-background/80",children:e.jsx("img",{src:r,alt:"Attachment",className:"max-h-64 w-full object-cover",loading:"lazy"})}):e.jsx("div",{className:"mt-1 h-32 w-40 animate-pulse rounded-xl bg-border/40"})},Gs=()=>{const{conversationId:t}=Yt(),r=t??null,o=zt(),{user:a}=J(),i=K(),{data:u,isLoading:f}=Ht(),{data:d,isLoading:m,isError:x,error:h}=Ns(r),[p,g]=c.useState(""),[_,w]=c.useState(null),[N,E]=c.useState(null),[T,$]=c.useState(null),[me,fe]=c.useState({}),bt=(s,n)=>{w("Couldn't send. Please try again."),g(n.text),V(),$(n),fe(l=>({...l,[s]:n}))},pt=s=>{s&&fe(n=>{if(!(s in n))return n;const l={...n};return delete l[s],l})},S=c.useMemo(()=>!r||!u?null:u.find(s=>s.id===r)??null,[r,u]),B=S?.isGroup??!1,ne=c.useMemo(()=>{if(!S)return null;const s=S.participants.filter(n=>!n.isSelf);return s.length>0?s[0]:S.participants.length===1?S.participants[0]:null},[S]),yt=Ps(r,{onFailed:bt,onRecovered:pt,otherUserId:B?null:ne?.id??null}),[vt,wt]=c.useState(!0),Y=c.useRef(null),[ae,ie]=c.useState(!1),ge=c.useRef(null),he=c.useRef(null),[jt,Te]=c.useState(!1),[oe,qe]=c.useState(null),[I,Pe]=c.useState(null),[xe,$e]=c.useState(!1),be=c.useRef(null);c.useEffect(()=>()=>{I&&URL.revokeObjectURL(I)},[I]),c.useEffect(()=>{d&&fe(s=>{const n=new Set(d.map(b=>b.id));let l=!1;const j={...s};for(const b of Object.keys(j))n.has(b)||(delete j[b],l=!0);return l?j:s})},[d]);const le=c.useMemo(()=>{const s=new Map;if(!S)return s;for(const n of S.participants)s.set(n.id,n);return s},[S]),{youBlocked:Be,blockedYou:q,isBlocked:F,isLoading:Nt,block:Fe,unblock:Le}=ps(B?null:ne?.id??null),kt=(d?.length??0)>0,_t=f||m||Nt,L=a?.id??null,Ue=c.useMemo(()=>{if(!d||!L)return null;for(let s=d.length-1;s>=0;s-=1){const n=d[s];if(n.senderId===L&&!De(n.body).deleted)return n.id}return null},[d,L]),[z,pe]=c.useState([]),H=c.useRef(new Map),ye=c.useRef(null),X=c.useRef({conversationId:null,messageId:null,userId:null}),U=c.useRef({isTyping:!1,timeoutId:null}),{data:Oe}=Ts(r),{reactionsByMessageId:Qe,toggleReaction:Ke,queryKey:ve}=Ss(r),{data:Ye}=qs(r),we=$s(r),je=Bs(r),P=c.useRef(null),de=c.useRef(!1),[ze,Z]=c.useState(null),[He,Ct]=c.useState({}),[Ne,ee]=c.useState(null),[O,ke]=c.useState(null),Ve=c.useRef(null),We=c.useRef(null),_e=c.useRef(null),[Ge,ce]=c.useState(null),te=c.useCallback(()=>{ke(null),ce(null),_e.current&&_e.current.focus()},[]);c.useEffect(()=>{if(!O)return;const s=Ve.current,n=s?.querySelectorAll("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])"),l=j=>{if(!s)return;if(j.key==="Escape"){j.preventDefault(),te();return}if(j.key!=="Tab"||!n||n.length===0)return;const b=n[0],v=n[n.length-1];j.shiftKey?document.activeElement===b&&(j.preventDefault(),v.focus()):document.activeElement===v&&(j.preventDefault(),b.focus())};return s?.addEventListener("keydown",l),queueMicrotask(()=>{We.current?.focus()}),()=>s?.removeEventListener("keydown",l)},[O,te]);const Je=c.useMemo(()=>d?d.map(s=>{const n=De(s.body),l=le.get(s.senderId)??null,j=l?.isSelf??(L!=null&&s.senderId===L),b=Ls(s,S??null,Ye,Oe,L,me),v=!!b&&j&&!n.deleted&&(b.status==="failed"||Ue===s.id);return{message:s,meta:n,sender:l,isSelf:j,deliveryStatus:b,showDeliveryStatus:v,reactions:Qe.get(s.id)??[]}}):[],[S,L,Ye,me,Ue,d,le,Qe,Oe]),se=c.useMemo(()=>Je.filter(({message:s})=>!He[s.id]),[Je,He]),St=se.length>0;c.useEffect(()=>{X.current={conversationId:null,messageId:null,userId:null}},[r,a?.id]),c.useEffect(()=>()=>{P.current!=null&&window.clearTimeout(P.current)},[]),c.useEffect(()=>{if(!r||!a?.id)return;const s=y.channel(`supabase_realtime_typing:conversation:${r}`,{config:{broadcast:{self:!1}}});return ye.current=s,s.on("broadcast",{event:"typing"},({payload:n})=>{const l=n;if(!l||l.userId===a.id)return;const b=le.get(l.userId)?.displayName??"Someone",v=l.userId,D=H.current.get(v);if(D!=null&&window.clearTimeout(D),l.isTyping){pe(C=>C.includes(b)?C:[...C,b]);const R=window.setTimeout(()=>{H.current.delete(v),pe(C=>C.filter(A=>A!==b))},4e3);H.current.set(v,R)}else H.current.delete(v),pe(R=>R.filter(C=>C!==b))}).subscribe(n=>{console.log("[ConversationPage] Typing channel status",n)}),()=>{H.current.forEach(n=>window.clearTimeout(n)),H.current.clear(),s&&y.removeChannel(s),ye.current=null}},[r,a?.id,le]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_messages_publication:conversation:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${r}`},n=>{console.log("[ConversationPage] Realtime message payload",n);const l=n.new;if(a?.id&&l.user_id===a.id)return;const j={id:l.id,conversationId:l.conversation_id,senderId:l.user_id,body:l.body,attachmentUrl:l.attachment_url,createdAt:l.created_at};i.setQueryData(["conversation",r,"messages"],b=>{const v=b??[];if(v.some(C=>C.id===j.id))return v;const R=[...v,j];return R.sort((C,A)=>new Date(C.createdAt).getTime()-new Date(A.createdAt).getTime()),R}),i.invalidateQueries({queryKey:["conversations"]}),a?.id&&l.user_id!==a.id&&y.from("message_delivery_receipts").insert({conversation_id:l.conversation_id,message_id:l.id,user_id:a.id}).then(({error:b})=>{b&&console.error("[ConversationPage] Failed to insert delivery receipt",b)},b=>{console.error("[ConversationPage] Unexpected error inserting delivery receipt",b)})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${r}`},n=>{const l=n.new,j={id:l.id,conversationId:l.conversation_id,senderId:l.user_id,body:l.body,attachmentUrl:l.attachment_url,createdAt:l.created_at};i.setQueryData(["conversation",r,"messages"],b=>{const v=b??[],D=v.findIndex(C=>C.id===j.id);if(D===-1)return v;const R=[...v];return R[D]=j,R})});return s.subscribe(n=>{console.log("[ConversationPage] Realtime channel status (messages)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for messages",n)}),()=>{y.removeChannel(s)}},[r,i,a?.id]),c.useEffect(()=>{if(!r||!d||d.length===0||!a?.id)return;const s=d[d.length-1];X.current.conversationId===r&&X.current.messageId===s.id&&X.current.userId===a.id||y.from("message_read_receipts").upsert({conversation_id:r,user_id:a.id,last_read_message_id:s.id,last_read_at:new Date().toISOString()},{onConflict:"conversation_id,user_id"}).then(()=>{X.current={conversationId:r,messageId:s.id,userId:a.id},i.invalidateQueries({queryKey:["conversations"]})},n=>{console.error("[ConversationPage] Failed to update read receipt",n)})},[r,d,a?.id,i]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_read_receipts:conversation:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${r}`},()=>{i.invalidateQueries({queryKey:["conversation",r,"readReceipts"]})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${r}`},()=>{i.invalidateQueries({queryKey:["conversation",r,"readReceipts"]})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (read receipts)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for read receipts",n)});return()=>{y.removeChannel(s)}},[r,i]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_message_reactions:conversation:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${r}`},()=>{ve&&i.invalidateQueries({queryKey:ve})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (reactions)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for reactions",n)});return()=>{y.removeChannel(s)}},[r,i,ve]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_message_delivery_receipts:conversation:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${r}`},()=>{i.invalidateQueries({queryKey:["conversation",r,"deliveryReceipts"]})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (delivery receipts)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for delivery receipts",n)});return()=>{y.removeChannel(s)}},[r,i]),c.useEffect(()=>{if(!ae)return;const s=n=>{const l=n.target;he.current&&!he.current.contains(l)&&ge.current&&!ge.current.contains(l)&&ie(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[ae]);const V=()=>{const s=Y.current;if(!s)return;s.style.height="auto";const n=Math.min(140,s.scrollHeight);s.style.height=`${n}px`,s.style.overflowY=s.scrollHeight>n?"auto":"hidden"};c.useEffect(()=>{V()},[p]);const Ce=s=>{const n=ye.current;if(!n||!r||!a)return;const j=s.trim().length>0,b=U.current.isTyping;j&&!b&&(U.current.isTyping=!0,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!0}})),U.current.timeoutId!=null&&window.clearTimeout(U.current.timeoutId),j?U.current.timeoutId=window.setTimeout(()=>{U.current.isTyping=!1,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!1}})},3e3):!j&&b&&(U.current.isTyping=!1,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!1}}))},Rt=s=>{const n=s.target.value;g(n),V(),ae&&ie(!1),Ce(n)},Et=s=>{s&&g(n=>{const l=`${n}${s}`;return V(),Ce(l),l})},Se=s=>{yt.mutate({text:s.text,attachmentPath:s.attachmentPath},{onError:n=>{console.error("[ConversationPage] sendMessage mutate error",n),w("Couldn't send. Please try again."),g(s.text),V(),$(s)},onSuccess:()=>{w(null),$(null)}})},Dt=s=>{if(s.preventDefault(),F||q)return;const n=p.trim();n&&(g(""),V(),w(null),$(null),Ce(""),Se({text:n,attachmentPath:null}))},Mt=()=>{T&&(w(null),Se(T))},It=()=>{!r||!a?.id||F||q||be.current?.click()},At=async s=>{const n=s.target.files?.[0];if(s.target.value="",!n||!r||!a?.id||F||q)return;const l=URL.createObjectURL(n);I&&URL.revokeObjectURL(I),qe(n),Pe(l),Te(!0)},Xe=()=>{I&&URL.revokeObjectURL(I),Pe(null),qe(null),Te(!1),E(null)},Tt=async()=>{if(!(!oe||!r||!a?.id)&&!(F||q)){E(null),$e(!0);try{const s=As(r,a.id,oe.name),{error:n}=await y.storage.from(Ae).upload(s,oe,{cacheControl:"3600",upsert:!1});if(n){console.error("[ConversationPage] image upload error",n),E("Upload failed. Please try another image.");return}const{error:l}=await y.storage.from(Ae).createSignedUrl(s,3600);if(l){console.error("[ConversationPage] signed URL generation failed",l),E("Could not generate a secure download link.");return}Se({text:"",attachmentPath:s}),Xe()}catch(s){console.error("[ConversationPage] handleSendSelectedImage failed",s),E("Something went wrong while sending your image.")}finally{$e(!1)}}},Ze=s=>{F||q||De(s.body).deleted||(Z(s.id),Y.current&&Y.current.blur())},qt=s=>{P.current!=null&&window.clearTimeout(P.current),de.current=!1,P.current=window.setTimeout(()=>{de.current=!0,Ze(s)},500)},et=()=>{P.current!=null&&(window.clearTimeout(P.current),P.current=null)};if(!r)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-5 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Vt,{to:"/messages",className:"inline-flex items-center justify-center rounded-full border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground shadow-md transition hover:border-primary/70 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:"Back to messages"})})]})});const Pt=s=>{const n=me[s.id];n&&(g(n.text),$(n))};return e.jsxs("div",{className:"relative flex min-h-screen w-full flex-col items-stretch bg-background",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-10 top-4 h-32 rounded-full bg-gradient-to-r from-fuchsia-500/15 via-primary/10 to-blue-500/15 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 flex-col items-stretch rounded-none border border-border bg-background shadow-xl shadow-primary/5 backdrop-blur sm:rounded-3xl",children:[e.jsx(Rs,{conversation:S,isLoading:f,isGroupConversation:B,otherParticipant:ne??void 0,onBack:()=>o("/messages"),onToggleBlock:!B&&ne?()=>{Be?Le.mutate():Fe.mutate()}:void 0,blockPending:Fe.isPending||Le.isPending,youBlocked:Be}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col bg-gradient-to-b from-background via-background to-background",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-8 top-4 h-20 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-primary/10 to-blue-500/10 blur-3xl","aria-hidden":"true"}),e.jsx(Es,{items:se,isLoading:_t&&!kt,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(W,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:x?e.jsxs("div",{className:"mb-3 rounded-md border border-border bg-background/90 px-3 py-2 text-[12px] text-destructive",children:[e.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),h instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:h.message})]}):void 0,emptyContent:St?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium",children:B?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:B?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:z.length>0?e.jsxs("div",{className:"mt-1 flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:B?z.length===1?`${z[0]} is typingâ€¦`:z.length===2?`${z[0]} and ${z[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}):e.jsx("div",{className:"h-1","aria-hidden":!0}),followOutput:vt?"smooth":!1,onAtBottomChange:wt,computeItemKey:(s,n)=>n.message.id,itemContent:(s,n)=>{const{message:l,meta:j,sender:b,isSelf:v,deliveryStatus:D,reactions:R,showDeliveryStatus:C}=n,A=s>0?se[s-1]?.message??null:null,Re=s<se.length-1?se[s+1]?.message??null:null,tt=A!=null&&A.senderId===l.senderId,st=Re!=null&&Re.senderId===l.senderId,$t=tt&&gt(A.createdAt,l.createdAt),Bt=st&&gt(l.createdAt,Re.createdAt),Ft=!(tt&&$t),Lt=!(st&&Bt),rt=s===0||A!=null&&!Ie(new Date(A.createdAt),new Date(l.createdAt)),Ut=s===0||rt?"mt-0":Ft?"mt-3":"mt-1.5",Q=j.deleted===!0,nt=j.editedAt,at=j.deletedAt,it=b?.displayName??(v?"You":"Someone"),ue=Q?"This message was deleted":ot(l.body),Ot=(()=>{const k=v?"You":it;return Q?`${k} deleted a message`:ue?`${k} said: ${ue}`:l.attachmentUrl?`${k} sent an attachment`:`${k} sent a message`})(),Qt=!v&&Lt,Ee=()=>{if(de.current){de.current=!1;return}ze===l.id?Z(null):Ze(l)};return e.jsxs("div",{className:"px-0",children:[rt&&e.jsx("div",{className:"my-4 flex items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-border to-transparent","aria-hidden":"true"}),e.jsx("span",{className:"rounded-full bg-background px-3 py-0.5 text-xs font-medium text-muted-foreground shadow-md/60 ring-1 ring-border/70",children:vs(l.createdAt)}),e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-border to-transparent","aria-hidden":"true"})]})}),e.jsxs("div",{className:`flex w-full flex-col gap-0.5 ${Ut}`,children:[e.jsxs("div",{className:`flex w-full items-end gap-2 ${v?"justify-end":"justify-start"}`,children:[!v&&e.jsx(e.Fragment,{children:Qt?e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0 overflow-hidden rounded-full bg-background/80 ring-1 ring-border",children:b?.avatarUrl?e.jsx("img",{src:b.avatarUrl,alt:b.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-medium text-muted-foreground",children:it.slice(0,2).toUpperCase()})}):e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0"})}),e.jsxs(Ds,{isSelf:v,isDeleted:Q,onClick:Ee,onContextMenu:k=>{k.preventDefault(),Ee()},onKeyDown:k=>{(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),Ee())},onTouchStart:()=>qt(l),onTouchEnd:et,onTouchCancel:et,"aria-label":Ot,children:[ue&&e.jsx("p",{className:"whitespace-pre-wrap break-all text-sm leading-snug",children:ue}),!Q&&l.attachmentUrl&&e.jsx(Fs,{path:l.attachmentUrl})]})]}),R.length>0&&e.jsx("div",{className:`mt-0.5 flex w-full ${v?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsx("div",{className:"inline-flex flex-wrap items-center gap-1 rounded-full bg-card/80 px-1.5 py-0.5 text-xs text-foreground shadow-md ring-1 ring-border/70",children:R.map(k=>e.jsxs("button",{type:"button",onClick:()=>Ke.mutate({messageId:l.id,emoji:k.emoji}),className:`inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 transition transform hover:bg-background hover:scale-110 active:scale-90 ${k.reactedBySelf?"bg-primary/5 ring-1 ring-primary/40":""}`,children:[e.jsx("span",{className:"text-[17px]",children:k.emoji}),k.count>1&&e.jsx("span",{className:"text-xs text-muted-foreground",children:k.count})]},k.emoji))})}),ze===l.id&&!Q&&e.jsx("div",{className:`mt-1 flex w-full ${v?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsxs("div",{className:"inline-flex flex-col items-stretch gap-1 rounded-2xl bg-card/95 px-2.5 py-1.5 text-xs text-foreground shadow-md ring-1 ring-border/70 select-none",children:[e.jsx("div",{className:"flex items-center justify-center gap-1",children:Is.map(k=>e.jsx("button",{type:"button",onClick:()=>{Ke.mutate({messageId:l.id,emoji:k}),Z(null)},className:"flex h-7 w-7 items-center justify-center rounded-full transition transform hover:bg-background hover:-translate-y-0.5 hover:scale-110 active:scale-90",children:e.jsx("span",{className:"text-[17px]",children:k})},k))}),v&&e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("button",{type:"button",onClick:k=>{_e.current=k.currentTarget,ke({messageId:l.id,text:ot(l.body)??""}),ce(null),Z(null),Y.current&&Y.current.blur()},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs text-muted-foreground hover:bg-background",children:[e.jsx(ds,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Edit"})]}),e.jsxs("button",{type:"button",onClick:()=>{Z(null),ee({messageId:l.id})},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs text-destructive hover:bg-destructive/10",children:[e.jsx(mt,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Delete"})]})]})]})}),C&&D&&e.jsx("div",{className:`flex items-center gap-1 text-xs text-muted-foreground ${v?"justify-end pr-1":"justify-start pl-7"}`,children:D.status==="failed"?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:"h-3 w-3 text-destructive","aria-hidden":!0}),e.jsx("span",{children:"Failed to send."}),e.jsx("button",{type:"button",className:"text-destructive underline",onClick:()=>Pt(l),children:"Retry"})]}):D.status==="delivered"?e.jsxs(e.Fragment,{children:[e.jsx(is,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Delivered"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ns,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Seen"})]})}),Q&&at&&e.jsxs("p",{className:`text-xs text-muted-foreground ${v?"text-right pr-1":"text-left pl-7"}`,children:["Deleted ",ft(at)]}),!Q&&nt&&e.jsxs("p",{className:`text-xs text-muted-foreground ${v?"text-right pr-1":"text-left pl-7"}`,children:["Edited ",ft(nt)]})]})]},l.id)}}),ae&&e.jsx("div",{ref:he,className:"absolute bottom-[4.25rem] left-4 z-30 rounded-2xl border border-border bg-card/95 p-2 shadow-lg",children:e.jsx("div",{className:"flex max-w-[260px] flex-wrap gap-1.5",children:["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ”¥","â­","âœ¨","ðŸ‘€","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"].map(s=>e.jsx("button",{type:"button",onClick:()=>{Et(s),ie(!1)},className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-background text-lg transition hover:bg-background/70",children:e.jsx("span",{children:s})},s))})})]}),!F&&!q&&e.jsxs(Ms,{onSubmit:Dt,className:"sticky bottom-0 z-20 flex-shrink-0 space-y-2",children:[_&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),T&&e.jsx("button",{type:"button",onClick:Mt,className:"inline-flex items-center gap-1 rounded-full bg-primary/10 px-2 py-1 text-xs font-semibold text-primary ring-1 ring-primary/40 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:e.jsx("span",{children:"Retry"})})]}),N&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:N})]}),e.jsx("button",{type:"button",onClick:()=>E(null),className:"inline-flex items-center gap-1 rounded-full bg-card/80 px-2 py-1 text-xs font-semibold text-muted-foreground ring-1 ring-border/70 transition hover:-translate-y-0.5 hover:text-foreground",children:e.jsx("span",{children:"Dismiss"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",ref:ge,onClick:()=>ie(s=>!s),className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Add emoji",children:e.jsx(gs,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:It,className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Send photo",children:e.jsx(dt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:be,accept:"image/*",className:"hidden",onChange:At}),e.jsx("div",{className:"flex min-h-[44px] max-h-[160px] flex-1 items-center rounded-full bg-background px-4 py-2.5 text-sm text-foreground shadow-inner ring-1 ring-border/70 focus-within:outline-none focus-within:ring-0 focus-within:shadow-none",children:e.jsx("textarea",{id:"conversation-message",value:p,ref:Y,onChange:Rt,onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),p.trim()&&s.currentTarget.form?.requestSubmit())},placeholder:"Messageâ€¦",rows:1,className:"max-h-[160px] flex-1 resize-none bg-transparent text-sm text-foreground outline-none placeholder:text-muted-foreground focus:border-transparent focus:outline-none focus:ring-0 focus:shadow-none"})}),e.jsx("button",{type:"submit",onMouseDown:s=>s.preventDefault(),onTouchStart:s=>s.preventDefault(),disabled:!p.trim(),className:"inline-flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-r from-fuchsia-500 via-primary to-blue-500 text-white shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"})})]})]}),q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),F&&!q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),O&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{ref:Ve,role:"dialog","aria-modal":"true","aria-labelledby":"edit-message-title",className:"w-[min(480px,calc(100%-2.5rem))] rounded-2xl border border-border bg-card p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{id:"edit-message-title",className:"text-[15px] font-semibold text-foreground",children:"Edit message"}),e.jsx("button",{type:"button",onClick:te,className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-background text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-card focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close edit message",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("div",{className:"mt-3 rounded-2xl bg-background px-3 py-2 ring-1 ring-border/70",children:e.jsx("textarea",{ref:We,value:O.text,onChange:s=>ke(n=>n&&{...n,text:s.target.value}),rows:3,className:"w-full resize-none border-0 bg-transparent text-sm text-foreground outline-none focus:outline-none focus:ring-0"})}),Ge&&e.jsx("p",{className:"mt-2 text-xs text-destructive",children:Ge}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2 text-sm",children:[e.jsx(Button,{type:"button",variant:"ghost",size:"sm",onClick:te,children:"Cancel"}),e.jsxs(Button,{type:"button",size:"sm",disabled:!O.text.trim()||we.isPending,onClick:()=>{const s=O.text.trim();s&&(ce(null),we.mutate({messageId:O.messageId,text:s},{onSuccess:()=>{te()},onError:()=>{ce("Couldn't save changes. Please try again.")}}))},children:[we.isPending&&e.jsx(W,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),Ne&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"w-[min(420px,calc(100%-2.5rem))] rounded-2xl border border-border bg-card p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-destructive/10 text-destructive",children:e.jsx(mt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("h2",{className:"text-[15px] font-semibold text-foreground",children:"Delete message"})]}),e.jsx("button",{type:"button",onClick:()=>ee(null),className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-background text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-card focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close delete dialog",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("p",{className:"mt-3 text-[12px] text-muted-foreground",children:"Choose whether to remove this message only from your chat or from the conversation for everyone."}),e.jsxs("div",{className:"mt-5 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{Ct(s=>({...s,[Ne.messageId]:!0})),ee(null)},className:"flex-1 rounded-full bg-background px-3 py-2 text-sm font-semibold text-foreground shadow-md ring-1 ring-border/80 transition hover:-translate-y-0.5 hover:bg-card",children:"Delete for me"}),e.jsxs("button",{type:"button",disabled:je.isPending,onClick:()=>{je.mutate({messageId:Ne.messageId},{onSettled:()=>{ee(null)}})},className:"flex-1 inline-flex items-center justify-center gap-1 rounded-full bg-destructive px-3 py-2 text-sm font-semibold text-white shadow-md transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",children:[je.isPending&&e.jsx(W,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]}),e.jsx("button",{type:"button",onClick:()=>ee(null),className:"self-center text-[12px] text-muted-foreground hover:text-foreground",children:"Cancel"})]})]})}),jt&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-[min(520px,calc(100%-2rem))] rounded-3xl border border-border bg-background/95 p-5 shadow-2xl",children:[e.jsx("button",{type:"button",onClick:Xe,className:"absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close gallery picker",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"flex items-start gap-3 pr-10",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-fuchsia-500/10 via-primary/10 to-blue-500/10 text-foreground ring-1 ring-border",children:e.jsx(dt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-foreground",children:"Send from your gallery"}),e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"Pick a recent photo to drop into the chatâ€”just like Instagram DMs."})]})]}),e.jsxs("div",{className:"mt-4 rounded-2xl border border-dashed border-border bg-background/80 p-4",children:[I?e.jsx("div",{className:"overflow-hidden rounded-xl border border-border bg-card/80",children:e.jsx("img",{src:I,alt:"Selected",className:"max-h-[320px] w-full object-cover"})}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-10 text-center text-muted-foreground",children:[e.jsx(ct,{className:"h-8 w-8","aria-hidden":"true"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a photo from your camera roll."})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>be.current?.click(),className:"inline-flex items-center gap-2 rounded-full bg-card/80 px-4 py-2 text-sm font-semibold text-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:[e.jsx(ct,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:"Choose another photo"})]}),e.jsxs("button",{type:"button",onClick:Tt,disabled:!oe||xe,className:"inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-fuchsia-500 via-primary to-blue-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:[xe?e.jsx(W,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:xe?"Sendingâ€¦":"Send photo"})]})]})]})]})})]})},Ls=(t,r,o,a,i,u)=>{if(!r||!i||t.senderId!==i)return null;if(u[t.id])return{status:"failed"};if(t.id.startsWith("temp-"))return{status:"sending"};const f=r.participants.filter(N=>!N.isSelf);if(f.length===0)return null;const d=f.map(N=>N.id),m=new Date(t.createdAt).getTime(),p=(o??[]).filter(N=>N.messageId===t.id&&d.includes(N.userId)).length,g=a??[];let _=0,w=null;for(const N of f){const E=g.find($=>$.userId===N.id);if(!E||!E.lastReadAt)continue;const T=new Date(E.lastReadAt).getTime();Number.isNaN(T)||T>=m&&(_+=1,(w===null||T>w)&&(w=T))}return _===f.length&&f.length>0?{status:"seen",seenAt:w!=null?new Date(w).toISOString():null}:p>0?{status:"delivered"}:{status:"sent"}};export{Fs as ChatImage,Gs as default,Ps as useSendMessage};
