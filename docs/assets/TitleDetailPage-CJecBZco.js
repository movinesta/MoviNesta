import{j as e,o as le,u as oe,R as Q,e as H,d as de,q as Z,t as ce,L as M,k as me,s as w}from"./index-DhZ1aP8k.js";import{u as ue,a as xe}from"./useDiaryLibrary-erQe_aZ2.js";import{d as pe,a as ge}from"./diaryStatus-BH3whMXG.js";import{P as k}from"./PageChrome-D5rVYUnf.js";import{C as D}from"./Chip-BzWWSk8Y.js";import{T as $}from"./TopBar-DqXtwt_r.js";import"./brand-DTIDtbc4.js";const J=({value:a,max:c=5,disabled:l,onChange:g,size:h="sm"})=>{const t=a??0,b=h==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-xs transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-sm transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:c}).map((L,i)=>{const o=i+1,f=t>=o;return e.jsx("button",{type:"button",onClick:()=>{if(!g||l)return;g(t===o?null:o)},disabled:l,className:`${b} ${f?"border-primary/80 bg-primary/90 text-primary-foreground":"border-border bg-card/60 text-muted-foreground hover:border-primary/70 hover:text-primary/90"}`,"aria-label":`Rate ${o} star${o===1?"":"s"}`,children:"★"},o)})})},fe=({imdb_rating:a,rt_tomato_pct:c,metascore:l})=>{if(!(typeof a=="number"&&a>0||typeof c=="number"&&c>0||typeof l=="number"&&l>0))return null;const h=typeof a=="number"&&!Number.isNaN(a)&&a>0,t=typeof c=="number"&&!Number.isNaN(c)&&c>0,b=typeof l=="number"&&!Number.isNaN(l)&&l>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-muted-foreground",children:[h&&e.jsxs(D,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"IMDb"}),e.jsx("span",{children:a.toFixed(1)})]}),t&&e.jsxs(D,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"Tomatometer"}),e.jsxs("span",{children:[c,"%"]})]}),b&&e.jsxs(D,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"MC"}),e.jsx("span",{children:l})]})]})},we=()=>{const{titleId:a}=le(),c=oe(),[l,g]=Q.useState(null),h=async r=>{if(!i?.id){alert("You need to be signed in to start a conversation.");return}if(i.id!==r){g(r);try{const s=await me("create-direct-conversation",{targetUserId:r},{timeoutMs:25e3});if(!s?.ok||!s.conversationId){const d=s?.errorCode;let x=s?.error??"Failed to get conversation id. Please try again.";d==="UNAUTHORIZED"?x="You need to be signed in to start a conversation.":d==="BAD_REQUEST_SELF_TARGET"?x="You can't start a conversation with yourself.":d==="SERVER_MISCONFIGURED"&&(x="Messaging is temporarily unavailable due to a server issue. Please try again later.");const v=new Error(x);throw v.code=d,v}c(`/messages/${s.conversationId}`)}catch(s){console.error("[TitleDetailPage] Failed to start conversation",s);const d=s instanceof Error?s.message:"Something went wrong while starting the conversation. Please try again.";alert(d)}finally{g(null)}}},{data:t,isLoading:b,isError:L}=H({queryKey:Z.titleDetail(a),enabled:!!a,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!a)return null;const{data:r,error:s}=await w.from("titles").select(`
          title_id,
          content_type,
          primary_title,
          original_title,
          sort_title,
          release_year,
          release_date,
          runtime_minutes,
          tmdb_runtime,
          tmdb_episode_run_time,
          plot,
          tmdb_overview,
          tagline,
          omdb_director,
          omdb_actors,
          genres,
          tmdb_genre_names,
          language,
          omdb_language,
          tmdb_original_language,
          country,
          omdb_country,
          imdb_rating,
          imdb_votes,
          metascore,
          rt_tomato_pct,
          poster_url,
          tmdb_poster_path,
          backdrop_url
        `).eq("title_id",a).maybeSingle();if(s)throw s;return r}}),{user:i}=de(),{updateStatus:o,updateRating:f}=ue(),{data:A}=xe(a),m=A??{status:null,rating:null},{data:I,isLoading:X}=H({queryKey:Z.friendsTitleReactions(i?.id??null,a),enabled:!!(i?.id&&a),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!i?.id||!a)return[];const r=i.id,{data:s,error:d}=await w.from("follows").select("followed_id").eq("follower_id",r).limit(80);if(d)throw d;const x=(s??[]).map(n=>n.followed_id).filter(Boolean);if(!x.length)return[];const{data:v,error:K}=await w.from("ratings").select("user_id, rating, created_at").eq("title_id",a).in("user_id",x).order("rating",{ascending:!1}).limit(40);if(K)throw K;const V=(v??[]).map(n=>n.user_id);if(!V.length)return[];const{data:ae,error:G}=await w.from("profiles").select("id, display_name, username, avatar_url").in("id",V);if(G)throw G;const ne=new Map((ae??[]).map(n=>[n.id,{displayName:n.display_name??null,username:n.username??null,avatarUrl:n.avatar_url??null}])),ie=(v??[]).map(n=>{const p=n.user_id,F=ne.get(p);return{userId:p,displayName:F?.displayName??null,username:F?.username??null,avatarUrl:F?.avatarUrl??null,rating:n.rating??null,createdAt:n.created_at??null}}),P=new Map;for(const n of ie){const p=P.get(n.userId);(!p||(n.rating??0)>(p.rating??0))&&P.set(n.userId,n)}return Array.from(P.values()).sort((n,p)=>(p.rating??0)-(n.rating??0))}}),N=t?t.poster_url??ce(t.tmdb_poster_path,"w500"):null,_=t?t.backdrop_url:null;if(Q.useEffect(()=>{const r=[N,_].filter(s=>!!s);r.length!==0&&r.forEach(s=>{const d=new Image;d.src=s})},[N,_]),!a)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx($,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(k,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(b)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx($,{title:"Loading title"}),e.jsx(k,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-card/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-card/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-card/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-card/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-card/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-card/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-card/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-card/40"})]})]})]})})]});if(L||!t)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx($,{title:"Title not found"}),e.jsxs(k,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"We couldn't find that title."}),e.jsx(M,{to:"/search",className:"mt-3 inline-block text-sm text-primary underline",children:"Back to search"})]})]});const S=t.primary_title??t.original_title??"Untitled",U=t.release_year??(t.release_date?new Date(t.release_date).getFullYear():null),y=t.runtime_minutes??t.tmdb_runtime??(Array.isArray(t.tmdb_episode_run_time)&&t.tmdb_episode_run_time.length>0?t.tmdb_episode_run_time[0]:null),q=typeof y=="number"&&y>0?`${Math.floor(y/60)}h ${y%60?`${y%60}m`:""}`.trim():null,T=t.content_type==="movie"?"Movie":t.content_type==="series"?"TV Series":t.content_type??null,B=t.language??t.omdb_language??t.tmdb_original_language??null,Y=t.country??t.omdb_country??null,R=t.genres&&t.genres.length>0&&t.genres||t.tmdb_genre_names&&t.tmdb_genre_names.length>0&&t.tmdb_genre_names||[],j=t.plot??t.tmdb_overview??null,u=[];U&&u.push(String(U)),T&&u.push(T),q&&u.push(q),Y&&u.push(Y),B&&u.push(B);const ee=t.imdb_rating,te=t.metascore,re=t.rt_tomato_pct,O=t.content_type==="movie"||t.content_type==="series"?t.content_type:null,W=()=>i?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),C=r=>{!W()||o.isPending||o.mutate({titleId:t.title_id,status:r,type:O})},z=r=>{!W()||f.isPending||f.mutate({titleId:t.title_id,rating:r,type:O})},se=u.length>0?u.join(" · "):"Title details",E=r=>m?.status===r;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-border bg-card/80 shadow-md",children:[e.jsxs("div",{className:"absolute inset-0",children:[_?e.jsx("img",{src:_,alt:S,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-background via-background/70 to-card"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-background via-background/80 to-background/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:N?e.jsx("img",{src:N,alt:S,className:"aspect-[2/3] w-full rounded-2xl object-cover shadow-lg",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-2xl border border-dashed border-border bg-background/70 text-xs text-muted-foreground",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.12em] text-muted-foreground",children:T??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground sm:text-3xl",children:S}),e.jsx("p",{className:"text-[12.5px] text-muted-foreground",children:se})]}),j&&e.jsx("p",{className:"max-w-3xl text-sm leading-relaxed text-muted-foreground sm:text-[14px]",children:j}),e.jsx(fe,{imdb_rating:ee,rt_tomato_pct:re,metascore:te}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>C("want_to_watch"),disabled:o.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("want_to_watch")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>C("watching"),disabled:o.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("watching")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>C("watched"),disabled:o.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("watched")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-muted-foreground",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Your rating"}),e.jsx(J,{value:m?.rating??null,disabled:f.isPending,onChange:z}),m?.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[m.rating,"/10"]})]}),!i&&e.jsxs("p",{className:"text-[11.5px] text-muted-foreground",children:[e.jsx(M,{to:"/auth",className:"font-medium text-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsx(k,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-background/80 px-3 py-3 text-[12px] text-muted-foreground",children:[t.tagline&&e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.tagline}),j&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-muted-foreground",children:j}),!t.tagline&&!j&&e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"We don't have a plot summary for this title yet."}),R&&R.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:R.slice(0,6).map(r=>e.jsx("span",{className:"rounded-full border border-border px-2 py-[2px] text-xs text-muted-foreground",children:r},r))}),(t.omdb_director||t.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-muted-foreground",children:[t.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Director:"})," ",t.omdb_director]}),t.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Cast:"})," ",t.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),i&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs",children:[e.jsx("span",{className:ge(m?.status),children:pe(m?.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Rating"}),e.jsx(J,{value:m?.rating??null,disabled:f.isPending,onChange:z})]})]})]}),!i&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to see your diary status and ratings for this title."})]}),i&&!X&&I&&I.length>0&&e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:I.slice(0,4).map(r=>{const s=r.displayName??(r.username?`@${r.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-card text-xs font-semibold text-foreground",children:r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:s??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(s??"?")[0]?.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-foreground",children:s}),r.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Rated ",r.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(M,{to:r.username?`/u/${r.username}`:`/u/${r.userId}`,className:"text-xs font-medium text-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>h(r.userId),disabled:l===r.userId,className:"text-xs font-medium text-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:l===r.userId?"Starting…":"Message"})]})]},r.userId)})})]})]})})})]})};export{we as default};
