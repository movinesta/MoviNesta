import{c as D,g as M,h as W,s as L,j as e,R as C,L as j,S as q,M as R,r as A}from"./index-DLcJPtaT.js";import{q as T}from"./index-C72iKZMJ.js";import{a as B}from"./format-DWLSBLoY.js";import{F as w}from"./film-B1-3ac0G.js";import{U as Y}from"./users-DO_B5-1n.js";import{B as K}from"./bookmark-plus-BM2IOAAq.js";import{S as U}from"./star-DI-RvBk9.js";import{u as z,a as P,d as Q,b as G}from"./diaryStatus-PxY8UPfv.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=D("ListFilter",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M7 12h10",key:"b7w52i"}],["path",{d:"M10 18h4",key:"1ulq68"}]]),H=a=>{switch(a){case"rating_created":return"rating";case"review_created":return"review";case"watchlist_added":return"watchlist";case"follow_created":return"follow";default:return"other"}},o=a=>typeof a=="string"?a:void 0,F=a=>typeof a=="number"&&Number.isFinite(a)?a:void 0,J=(a,d)=>{if(!d||typeof d!="object")return null;const n=d;switch(a){case"rating_created":{const c=F(n.rating);return c===void 0?null:{event_type:a,rating:c,headline:o(n.headline),emoji:o(n.emoji)}}case"review_created":return{event_type:a,rating:F(n.rating),review_snippet:o(n.review_snippet),headline:o(n.headline),emoji:o(n.emoji)};case"watchlist_added":case"watchlist_removed":return{event_type:a,extra:o(n.extra)};case"follow_created":return{event_type:a,extra:o(n.extra)};case"comment_created":case"reply_created":return{event_type:a,extra:o(n.extra)};case"list_created":case"list_item_added":return{event_type:a,extra:o(n.extra)};case"message_sent":return{event_type:a,extra:o(n.extra)};default:return null}},V=a=>{const{user:d}=M(),n=a??(d==null?void 0:d.id)??null,c=W({queryKey:["diary","timeline",n],enabled:!!n,queryFn:async()=>{if(!n)return[];const{data:m,error:h}=await L.from("activity_events").select("id, created_at, event_type, title_id, payload").eq("user_id",n).order("created_at",{ascending:!1}).limit(100);if(h)throw new Error(h.message);if(!(m!=null&&m.length))return[];const x=Array.from(new Set(m.map(i=>i.title_id).filter(i=>!!i)));let p=new Map;if(x.length){const{data:i,error:l}=await L.from("titles").select("title_id, primary_title, release_year, poster_url, backdrop_url").in("title_id",x);!l&&i?p=new Map(i.map(s=>[s.title_id,s])):l&&console.warn("[useDiaryTimeline] Failed to load titles",l.message)}return m.map(i=>{const l=i.title_id?p.get(i.title_id)??null:null,s=H(i.event_type),t=J(i.event_type,i.payload);return{id:i.id,createdAt:i.created_at,kind:s,titleId:i.title_id,title:(l==null?void 0:l.primary_title)??null,year:(l==null?void 0:l.release_year)??null,posterUrl:(l==null?void 0:l.poster_url)??(l==null?void 0:l.backdrop_url)??null,rating:(t==null?void 0:t.event_type)==="rating_created"?t.rating:(t==null?void 0:t.event_type)==="review_created"?t.rating??null:null,reviewSnippet:(t==null?void 0:t.event_type)==="review_created"?t.review_snippet??null:null,headline:(t==null?void 0:t.event_type)==="rating_created"||(t==null?void 0:t.event_type)==="review_created"?t.headline??null:null,extra:(t==null?void 0:t.extra)??null,emoji:(t==null?void 0:t.event_type)==="rating_created"||(t==null?void 0:t.event_type)==="review_created"?t.emoji??null:null}})}});return{items:c.data??[],isLoading:c.isLoading,isError:c.isError,error:c.error instanceof Error?c.error.message:null}},X=a=>{switch(a.kind){case"rating":return a.rating!=null?`Rated ${a.rating.toFixed(1)}★`:"Rated";case"review":return"Wrote a review";case"watchlist":return"Updated watchlist";case"follow":return"Followed someone";default:return"Activity"}},Z=a=>{switch(a){case"rating":return U;case"review":return R;case"watchlist":return K;case"follow":return Y;default:return q}},ce=({userId:a,isOwnProfile:d=!1,displayName:n,username:c})=>{const{items:m,isLoading:h,isError:x,error:p}=V(a),i=n||(c?`@${c}`:"this user");return h?e.jsx("div",{className:"px-2 pb-4",children:e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((l,s)=>e.jsxs("div",{className:"flex gap-3 rounded-mn-card border border-mn-border-subtle/60 bg-mn-bg-elevated/80 p-3 shadow-mn-card",children:[e.jsx("div",{className:"h-12 w-8 rounded bg-mn-bg/60"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-2",children:[e.jsx("div",{className:"h-3 w-1/3 rounded bg-mn-bg/70"}),e.jsx("div",{className:"h-3 w-2/3 rounded bg-mn-bg/80"}),e.jsx("div",{className:"h-2.5 w-1/2 rounded bg-mn-bg/80"})]})]},s))})}):x?e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-mn-card border border-mn-error/40 bg-mn-error/5 p-4 text-center text-[11px] text-mn-text-primary shadow-mn-card",children:[e.jsxs("p",{className:"font-semibold",children:["Unable to load ",d?"your":"this profile&apos;s"," activity."]}),e.jsx("p",{className:"mt-1 text-[10px] text-mn-text-secondary",children:p??"Please try again in a moment."})]})}):m.length?e.jsx("div",{className:"px-2 pb-4",children:e.jsx(T,{style:{height:"70vh"},data:m,computeItemKey:(l,s)=>s.id,components:{List:C.forwardRef((l,s)=>e.jsx("ol",{ref:s,className:"space-y-3",...l}))},itemContent:(l,s)=>{const t=Z(s.kind),g=s.titleId?`/title/${s.titleId}`:null;return e.jsx("li",{className:"pb-1",children:e.jsxs("article",{className:"flex gap-3 rounded-mn-card border border-mn-border-subtle/60 bg-mn-bg-elevated/80 p-3 shadow-mn-card",children:[e.jsx("div",{className:"relative h-16 w-11 overflow-hidden rounded bg-mn-bg/70",children:s.posterUrl?e.jsx("img",{src:s.posterUrl,alt:s.title??"",className:"h-full w-full object-cover"}):e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] text-mn-text-muted",children:[e.jsx(w,{className:"mr-1 h-3.5 w-3.5"}),"No poster"]})}),e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"flex items-center gap-1.5 text-[11px] text-mn-text-secondary",children:e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-mn-primary/10 px-2 py-0.5 text-[10px] font-medium text-mn-text-primary",children:[e.jsx(t,{className:"h-3 w-3","aria-hidden":"true"}),X(s)]})}),e.jsx("span",{className:"shrink-0 text-[10px] text-mn-text-muted",children:B(s.createdAt)})]}),e.jsx("div",{className:"min-w-0",children:g?e.jsxs(j,{to:g,className:"line-clamp-2 text-sm font-medium text-mn-text-primary hover:underline",children:[s.title??"Untitled",s.year?e.jsxs("span",{className:"ml-1 text-[11px] text-mn-text-secondary",children:["(",s.year,")"]}):null]}):e.jsx("p",{className:"line-clamp-2 text-sm font-medium text-mn-text-primary",children:s.title??"Activity"})}),s.reviewSnippet&&e.jsxs("p",{className:"line-clamp-2 text-[11px] text-mn-text-secondary",children:["“",s.reviewSnippet,"”"]}),s.extra&&e.jsx("p",{className:"text-[10px] text-mn-text-muted",children:s.extra})]})]})},s.id)}})}):e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-mn-card border border-mn-border-subtle bg-mn-bg-elevated/80 p-5 text-center text-[11px] text-mn-text-secondary shadow-mn-card",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-2xl bg-mn-primary/15",children:e.jsx(w,{className:"h-5 w-5 text-mn-primary","aria-hidden":"true"})}),e.jsx("p",{className:"font-heading text-sm font-semibold text-mn-text-primary",children:d?"Your diary is waiting":`${i}'s diary is quiet`}),e.jsx("p",{className:"mt-1 text-[11px]",children:d?"As you rate titles, write reviews, and update your library, they’ll show up here in a cozy, chronological timeline.":"When they rate titles, share reviews, or log films, their updates will collect here for you to browse."})]})})},O=[{value:"all",label:"All"},{value:"want_to_watch",label:"Want to Watch"},{value:"watching",label:"Watching"},{value:"watched",label:"Watched"},{value:"dropped",label:"Dropped"}],ee=[{value:"all",label:"All types"},{value:"movie",label:"Movies"},{value:"series",label:"Series"},{value:"anime",label:"Anime"}],me=({userId:a,isOwnProfile:d=!1,displayName:n,username:c})=>{const[m,h]=A.useState("all"),[x,p]=A.useState("all"),{entries:i,isLoading:l,isError:s,error:t}=z({status:m==="all"?void 0:m,type:x==="all"?void 0:x},a),{updateStatus:g,updateRating:_}=P(),N=g.isPending||_.isPending,v=d,S=n||(c?`@${c}`:"this user");return l?e.jsxs("div",{className:"px-2 pb-4",children:[e.jsx("div",{className:"mb-3 flex items-center justify-between gap-2 px-1 text-[11px] text-mn-text-secondary",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(I,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:d?"Loading your library…":`Loading ${S}’s library…`})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((r,y)=>e.jsxs("div",{className:"overflow-hidden rounded-mn-card border border-mn-border-subtle/60 bg-mn-bg-elevated/80 shadow-mn-card",children:[e.jsx("div",{className:"h-40 w-full bg-mn-bg/70"}),e.jsxs("div",{className:"space-y-1.5 p-2.5",children:[e.jsx("div",{className:"h-3 w-3/4 rounded bg-mn-bg/70"}),e.jsx("div",{className:"h-2.5 w-1/2 rounded bg-mn-bg/80"}),e.jsx("div",{className:"h-2.5 w-2/3 rounded bg-mn-bg/80"})]})]},y))})]}):s?e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-mn-card border border-mn-error/40 bg-mn-error/5 p-4 text-center text-[11px] text-mn-text-primary shadow-mn-card",children:[e.jsxs("p",{className:"font-semibold",children:["Unable to load ",d?"your":"their"," library."]}),e.jsx("p",{className:"mt-1 text-[10px] text-mn-text-secondary",children:t??"Please try again in a moment."})]})}):i.length?e.jsxs("div",{className:"px-2 pb-4",children:[e.jsxs("div",{className:"mb-3 flex flex-wrap items-center justify-between gap-2 px-1 text-[11px]",children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:O.map(r=>{const y=m===r.value;return e.jsx("button",{type:"button",onClick:()=>h(r.value),className:`rounded-full border px-2.5 py-1 text-[10px] transition ${y?"border-mn-primary/60 bg-mn-primary-soft text-mn-text-primary shadow-sm":"border-mn-border-subtle bg-mn-bg-elevated/80 text-mn-text-secondary hover:border-mn-border-subtle/80 hover:text-mn-text-primary"}`,children:r.label},r.value)})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(I,{className:"h-3.5 w-3.5 text-mn-text-muted","aria-hidden":"true"}),e.jsxs("label",{className:"flex items-center gap-1 text-[10px] text-mn-text-secondary",children:[e.jsx("span",{children:"Type"}),e.jsx("select",{value:x,onChange:r=>p(r.target.value),className:"rounded-full border border-mn-border-subtle bg-mn-bg-elevated/80 px-2 py-1 text-[10px] text-mn-text-primary",children:ee.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 sm:grid-cols-3",children:i.length===0?e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center py-12 text-center text-sm text-mn-text-muted",children:[e.jsx("p",{className:"font-medium text-mn-text-primary",children:d?"Your diary is empty":"No diary entries yet"}),e.jsx("p",{className:"mt-1 max-w-xs text-xs text-mn-text-muted",children:d?"Start by searching for a movie or show and adding it to your diary.":"When they start logging what they watch, it will show up here."}),d&&e.jsx(j,{to:"/search",className:"mt-4 inline-flex items-center rounded-full bg-mn-primary px-4 py-1.5 text-xs font-medium text-mn-bg shadow-sm hover:bg-mn-primary/90",children:"Search titles"})]}):i.map(r=>{const y=()=>{if(!v)return;const u=["want_to_watch","watching","watched","dropped"],b=u.indexOf(r.status),f=u[(b+1)%u.length];g.mutate({titleId:r.titleId,status:f,type:r.type})},$=u=>{if(!v)return;const b=r.rating===u?null:u;_.mutate({titleId:r.titleId,rating:b,type:r.type})},k=`/title/${r.titleId}`;return e.jsxs("article",{className:"group flex flex-col overflow-hidden rounded-mn-card border border-mn-border-subtle/60 bg-mn-bg-elevated/80 shadow-mn-card",children:[e.jsx(j,{to:k,className:"relative block",children:e.jsx("div",{className:"aspect-[2/3] w-full overflow-hidden bg-mn-bg/80",children:r.posterUrl?e.jsx("img",{src:r.posterUrl,alt:r.title,className:"h-full w-full object-cover transition-transform duration-200 group-hover:scale-[1.03]"}):e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] text-mn-text-muted",children:[e.jsx(w,{className:"mr-1 h-4 w-4"}),"No poster"]})})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-1.5 p-2.5",children:[e.jsxs("div",{className:"min-h-[2.4rem]",children:[e.jsx(j,{to:k,className:"line-clamp-2 text-[13px] font-medium text-mn-text-primary hover:underline",children:r.title}),r.year&&e.jsxs("p",{className:"text-[10px] text-mn-text-secondary",children:["(",r.year,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-1",children:[e.jsx("button",{type:"button",onClick:y,disabled:N||!v,className:`rounded-full border px-2 py-0.5 text-[9px] font-medium transition ${G(r.status??null)} ${N?"opacity-70":v?"hover:border-mn-primary/70 hover:bg-mn-primary-soft":"opacity-80"}`,children:Q(r.status??null)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:5}).map((u,b)=>{const f=b+1,E=(r.rating??0)>=f;return e.jsx("button",{type:"button",className:"p-0.5",disabled:N||!v,onClick:()=>$(f),children:e.jsx(U,{className:`h-3.5 w-3.5 ${E?"fill-yellow-400 text-yellow-300":"text-mn-text-muted"}`})},b)})}),e.jsx("span",{className:"text-[10px] text-mn-text-muted",children:r.rating!=null?`${r.rating}/5`:"No rating"})]})]})]})]},r.id)})})]}):e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-mn-card border border-mn-border-subtle bg-mn-bg-elevated/80 p-5 text-center text-[11px] text-mn-text-secondary shadow-mn-card",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-2xl bg-mn-primary/15",children:e.jsx(w,{className:"h-5 w-5 text-mn-primary","aria-hidden":"true"})}),e.jsx("p",{className:"font-heading text-sm font-semibold text-mn-text-primary",children:d?"Your library is empty":`${S}'s library is empty`}),e.jsx("p",{className:"mt-1 text-[11px]",children:d?"As you add titles to your Watchlist and mark them as watched, this tab will turn into a sortable diary of everything you’ve seen.":"When they add titles to their Watchlist or mark them watched, you’ll be able to browse their picks here."})]})})};export{ce as D,me as a};
