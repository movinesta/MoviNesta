import{b as A,c as F,ai as B,s as h,d as g}from"./index-DuL1-P9A.js";const i=t=>{if(t?.aborted)throw t.reason??new DOMException("Aborted","AbortError")},N=t=>{const n=t.trim().replace(/^@+/,""),s=n.toLowerCase(),{user:u}=A();return F({queryKey:["search","people",{query:n,userId:u?.id??null}],enabled:n.length>=2,placeholderData:B,staleTime:1e3*60*15,gcTime:1e3*60*30,refetchOnWindowFocus:!1,retry:1,queryFn:async({signal:r})=>{i(r);const v=n.replace(/%/g,"\\%").replace(/_/g,"\\_");let c=h.from("profiles_public").select("id, username, display_name, avatar_url, bio").or(`username.ilike.%${v}%,display_name.ilike.%${v}%`).limit(20);r&&(c=c.abortSignal(r));const d=await c;if(i(r),d.error)throw new Error(d.error.message);const m=d.data??[],C=m.map(e=>e.id);let f=new Map;if(C.length){let e=h.from("user_stats").select("user_id, followers_count, following_count").in("user_id",C);r&&(e=e.abortSignal(r));const o=await e;i(r),o.error?console.warn("[useSearchPeople] Failed to load user_stats",o.error.message):f=new Map((o.data??[]).map(a=>[a.user_id,{followersCount:a.followers_count??0,followingCount:a.following_count??0}]))}if(!u?.id)return Promise.all(m.map(async e=>{const o=f.get(e.id);return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:await g(e.avatar_url),bio:e.bio,followersCount:o?.followersCount??null,followingCount:o?.followingCount??null,isFollowing:!1,matchPercent:null}}));let p=h.from("follows").select("followed_id").eq("follower_id",u.id);r&&(p=p.abortSignal(r));const w=await p;i(r),w.error&&console.warn("[useSearchPeople] Failed to load follows for current user",w.error.message);const P=new Set((w.data??[]).map(e=>e.followed_id)),S=m.map(e=>{const o=f.get(e.id),a=e.username??"",y=e.display_name??"",_=a.toLowerCase(),b=y.toLowerCase();let l=0;_===s?l+=100:_.startsWith(s)?l+=80:b.startsWith(s)?l+=60:_.includes(s)?l+=40:b.includes(s)&&(l+=30);const U=Math.min(15,Math.floor((o?.followersCount??0)/500));return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:e.avatar_url,bio:e.bio,followersCount:o?.followersCount??null,followingCount:o?.followingCount??null,isFollowing:P.has(e.id),matchPercent:null,relevance:l+U}}).sort((e,o)=>{if(o.relevance!==e.relevance)return o.relevance-e.relevance;const a=(e.displayName??e.username??"").toLowerCase(),y=(o.displayName??o.username??"").toLowerCase();return a.localeCompare(y)}).map(({relevance:e,...o})=>o);return Promise.all(S.map(async e=>({...e,avatarUrl:await g(e.avatarUrl)})))}})};export{N as u};
