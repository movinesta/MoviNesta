import{d as p,v as b,w,e as q,q as d,s as c}from"./index-fug2llhW.js";const E=(a,e)=>{const{user:r}=p(),u=e??r?.id??null,s=q({queryKey:["diary","library",u],enabled:!!u,queryFn:async()=>{if(!u)return[];const{data:t,error:y}=await c.from("library_entries").select("id, title_id, status, updated_at").eq("user_id",u).order("updated_at",{ascending:!1}).limit(500);if(y)throw new Error(y.message);const l=t??[];if(!l.length)return[];const _=Array.from(new Set(l.map(i=>i.title_id).filter(i=>!!i)));let g=new Map;if(_.length){const{data:i,error:n}=await c.from("titles").select("title_id, primary_title, release_year, content_type, poster_url, backdrop_url").in("title_id",_);n?console.warn("[useDiaryLibrary] Failed to load titles for library entries",n.message):g=new Map(i.map(f=>[f.title_id,f]))}let m=new Map;if(_.length){const{data:i,error:n}=await c.from("ratings").select("title_id, rating").eq("user_id",u).in("title_id",_);!n&&i?m=new Map(i.map(f=>[f.title_id,f.rating])):n&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",n.message)}return l.map(i=>{const n=g.get(i.title_id),f=m.get(i.title_id)??null;return{id:i.id,titleId:i.title_id,status:i.status,updatedAt:i.updated_at,title:n?.primary_title??"Untitled",year:n?.release_year??null,type:n?.content_type??null,posterUrl:n?.poster_url??n?.backdrop_url??null,rating:f}})}});return{entries:(s.data??[]).filter(t=>!(a.status&&a.status!=="all"&&t.status!==a.status||a.type&&a.type!=="all"&&t.type!==a.type)),isLoading:s.isLoading,isError:s.isError,error:s.error instanceof Error?s.error.message:null}},S=a=>{const{user:e}=p(),r=e?.id??null;return q({queryKey:d.titleDiary(r,a),enabled:!!(r&&a),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!r||!a)return{status:null,rating:null};const[{data:u,error:s},{data:o,error:t}]=await Promise.all([c.from("library_entries").select("status").eq("user_id",r).eq("title_id",a).maybeSingle(),c.from("ratings").select("rating").eq("user_id",r).eq("title_id",a).maybeSingle()]);if(s&&s.code!=="PGRST116")throw s;if(t&&t.code!=="PGRST116")throw t;return{status:u?.status??null,rating:o?.rating??null}}})},v=()=>{const{user:a}=p(),e=a?.id??null,r=b(),u=w({mutationFn:async({titleId:o,status:t,type:y})=>{if(!e)throw new Error("Not authenticated");if(!y)throw new Error("Content type is required");const{error:l}=await c.from("library_entries").upsert({user_id:e,title_id:o,status:t,updated_at:new Date().toISOString(),content_type:y},{onConflict:"user_id,title_id"});if(l)throw new Error(l.message);return{titleId:o,status:t}},onSuccess:()=>{e&&(r.invalidateQueries({queryKey:d.diaryLibrary(e)}),r.invalidateQueries({queryKey:d.diaryStats(e)}),r.invalidateQueries({queryKey:d.homeForYou(e)}),r.invalidateQueries({queryKey:d.titleDiary(e,void 0)}))}}),s=w({mutationFn:async({titleId:o,rating:t,type:y})=>{if(!e)throw new Error("Not authenticated");if(!y)throw new Error("Content type is required");if(t==null){const{error:_}=await c.from("ratings").delete().eq("user_id",e).eq("title_id",o);if(_)throw new Error(_.message);return{titleId:o,rating:null}}const{error:l}=await c.from("ratings").upsert({user_id:e,title_id:o,rating:t,updated_at:new Date().toISOString(),content_type:y},{onConflict:"user_id,title_id"});if(l)throw new Error(l.message);return{titleId:o,rating:t}},onSuccess:()=>{e&&(r.invalidateQueries({queryKey:d.diaryLibrary(e)}),r.invalidateQueries({queryKey:d.diaryStats(e)}),r.invalidateQueries({queryKey:d.homeForYou(e)}),r.invalidateQueries({queryKey:d.titleDiary(e,void 0)}))}});return{updateStatus:u,updateRating:s}};export{S as a,E as b,v as u};
