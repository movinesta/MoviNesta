import{g as f,n as w,o as g,z as c,s as y,h as b}from"./index-DLcJPtaT.js";const q=(r,e)=>{const{user:n}=f(),l=e??(n==null?void 0:n.id)??null,d=b({queryKey:["diary","library",l],enabled:!!l,queryFn:async()=>{if(!l)return[];const{data:i,error:p}=await y.from("library_entries").select(`
            id, title_id, status, updated_at, content_type,
            titles!inner (
              title_id, primary_title, release_year, content_type, poster_url, backdrop_url
            )
          `).returns().eq("user_id",l).order("updated_at",{ascending:!1}).limit(500);if(p)throw new Error(p.message);const o=i??[];if(!o.length)return[];const _=Array.from(new Set(o.map(t=>t.title_id).filter(t=>!!t)));let u=new Map;if(_.length){const{data:t,error:a}=await y.from("ratings").select("title_id, rating").returns().eq("user_id",l).in("title_id",_);!a&&t?u=new Map(t.map(m=>[m.title_id,m.rating])):a&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",a.message)}return o.map(t=>{const a=t.titles,m=u.get(t.title_id)??null;return{id:t.id,titleId:t.title_id,status:t.status,updatedAt:t.updated_at,title:(a==null?void 0:a.primary_title)??"Untitled",year:(a==null?void 0:a.release_year)??null,type:(a==null?void 0:a.content_type)??null,posterUrl:(a==null?void 0:a.poster_url)??(a==null?void 0:a.backdrop_url)??null,rating:m}})}});return{entries:(d.data??[]).filter(i=>!(r.status&&r.status!=="all"&&i.status!==r.status||r.type&&r.type!=="all"&&i.type!==r.type)),isLoading:d.isLoading,isError:d.isError,error:d.error instanceof Error?d.error.message:null}},E=r=>{const{user:e}=f(),n=(e==null?void 0:e.id)??null;return b({queryKey:c.titleDiary(n,r),enabled:!!(n&&r),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!n||!r)return{status:null,rating:null};const[{data:l,error:d},{data:s,error:i}]=await Promise.all([y.from("library_entries").select("status").returns().eq("user_id",n).eq("title_id",r).maybeSingle(),y.from("ratings").select("rating").returns().eq("user_id",n).eq("title_id",r).maybeSingle()]);if(d&&d.code!=="PGRST116")throw d;if(i&&i.code!=="PGRST116")throw i;return{status:(l==null?void 0:l.status)??null,rating:(s==null?void 0:s.rating)??null}}})},S=()=>{const{user:r}=f(),e=(r==null?void 0:r.id)??null,n=w(),l=g({mutationFn:async({titleId:s,status:i,type:p})=>{if(!e)throw new Error("Not authenticated");let o=p??null;if(!o){const{data:u,error:t}=await y.from("titles").select("content_type").eq("title_id",s).maybeSingle();if(t)throw new Error(t.message);o=(u==null?void 0:u.content_type)??null}if(!o)throw new Error("Unable to determine title type for library entry");const{error:_}=await y.from("library_entries").upsert({user_id:e,title_id:s,status:i,content_type:o,updated_at:new Date().toISOString()},{onConflict:"user_id,title_id"});if(_)throw new Error(_.message);return{titleId:s,status:i}},onSuccess:()=>{e&&(n.invalidateQueries({queryKey:c.diaryLibrary(e)}),n.invalidateQueries({queryKey:c.diaryStats(e)}),n.invalidateQueries({queryKey:c.homeForYou(e)}),n.invalidateQueries({queryKey:c.titleDiary(e,void 0)}))}}),d=g({mutationFn:async({titleId:s,rating:i,type:p})=>{if(!e)throw new Error("Not authenticated");if(i==null){const{error:u}=await y.from("ratings").delete().eq("user_id",e).eq("title_id",s);if(u)throw new Error(u.message);return{titleId:s,rating:null}}let o=p??null;if(!o){const{data:u,error:t}=await y.from("titles").select("content_type").eq("title_id",s).maybeSingle();if(t)throw new Error(t.message);o=(u==null?void 0:u.content_type)??null}if(!o)throw new Error("Unable to determine title type for rating");const{error:_}=await y.from("ratings").upsert({user_id:e,title_id:s,content_type:o,rating:i,updated_at:new Date().toISOString()},{onConflict:"user_id,title_id"});if(_)throw new Error(_.message);return{titleId:s,rating:i}},onSuccess:()=>{e&&(n.invalidateQueries({queryKey:c.diaryLibrary(e)}),n.invalidateQueries({queryKey:c.diaryStats(e)}),n.invalidateQueries({queryKey:c.homeForYou(e)}),n.invalidateQueries({queryKey:c.titleDiary(e,void 0)}))}});return{updateStatus:l,updateRating:d}},v=r=>{switch(r){case"want_to_watch":return"Want to watch";case"watching":return"Watching";case"watched":return"Watched";case"dropped":return"Dropped";default:return"Tap to add status"}},D=r=>{switch(r){case"want_to_watch":return"border-amber-500/40 bg-amber-500/10 text-amber-200";case"watching":return"border-sky-500/40 bg-sky-500/10 text-sky-200";case"watched":return"border-emerald-500/40 bg-emerald-500/10 text-emerald-200";case"dropped":return"border-rose-500/40 bg-rose-500/10 text-rose-200";default:return"border-mn-border-subtle bg-mn-bg/60 text-mn-text-secondary"}};export{S as a,D as b,E as c,v as d,q as u};
