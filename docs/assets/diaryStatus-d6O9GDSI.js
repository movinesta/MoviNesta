import{h as b,b as h,q as l,s as y,i as w,o as q}from"./index-BJNwabbL.js";import{u as f}from"./useMutation-CiYMdxMt.js";const D=(t,e)=>{const{user:r}=b(),d=e??r?.id??null,s=w({queryKey:["diary","library",d],enabled:!!d,queryFn:async()=>{if(!d)return[];const{data:a,error:c}=await y.from("library_entries").select("id, title_id, status, updated_at").eq("user_id",d).order("updated_at",{ascending:!1}).limit(500);if(c)throw new Error(c.message);const u=a??[];if(!u.length)return[];const m=Array.from(new Set(u.map(i=>i.title_id).filter(i=>!!i)));let g=new Map;if(m.length){const{data:i,error:n}=await y.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",m);n?console.warn("[useDiaryLibrary] Failed to load titles for library entries",n.message):g=new Map(i.map(_=>[_.id,q(_)]))}let p=new Map;if(m.length){const{data:i,error:n}=await y.from("ratings").select("title_id, rating").eq("user_id",d).in("title_id",m);!n&&i?p=new Map(i.map(_=>[_.title_id,_.rating])):n&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",n.message)}return u.map(i=>{const n=g.get(i.title_id),_=p.get(i.title_id)??null;return{id:i.id,titleId:i.title_id,status:i.status,updatedAt:i.updated_at,title:n?.title??"Untitled",year:n?.year??null,type:n?.type??null,posterUrl:n?.posterUrl??n?.backdropUrl??null,rating:_}})}});return{entries:(s.data??[]).filter(a=>!(t.status&&t.status!=="all"&&a.status!==t.status||t.type&&t.type!=="all"&&a.type!==t.type)),isLoading:s.isLoading,isError:s.isError,error:s.error instanceof Error?s.error.message:null}},v=t=>{const{user:e}=b(),r=e?.id??null;return w({queryKey:l.titleDiary(r,t),enabled:!!(r&&t),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!r||!t)return{status:null,rating:null};const[{data:d,error:s},{data:o,error:a}]=await Promise.all([y.from("library_entries").select("status").eq("user_id",r).eq("title_id",t).maybeSingle(),y.from("ratings").select("rating").eq("user_id",r).eq("title_id",t).maybeSingle()]);if(s&&s.code!=="PGRST116")throw s;if(a&&a.code!=="PGRST116")throw a;return{status:d?.status??null,rating:o?.rating??null}}})},K=()=>{const{user:t}=b(),e=t?.id??null,r=h(),d=f({mutationFn:async({titleId:o,status:a,type:c})=>{if(!e)throw new Error("Not authenticated");if(!c)throw new Error("Content type is required");const{error:u}=await y.from("library_entries").upsert({user_id:e,title_id:o,status:a,updated_at:new Date().toISOString(),content_type:c},{onConflict:"user_id,title_id"});if(u)throw new Error(u.message);return{titleId:o,status:a}},onSuccess:()=>{e&&(r.invalidateQueries({queryKey:l.diaryLibrary(e)}),r.invalidateQueries({queryKey:l.diaryStats(e)}),r.invalidateQueries({queryKey:l.homeForYou(e)}),r.invalidateQueries({queryKey:l.titleDiary(e,void 0)}))}}),s=f({mutationFn:async({titleId:o,rating:a,type:c})=>{if(!e)throw new Error("Not authenticated");if(!c)throw new Error("Content type is required");if(a==null){const{error:m}=await y.from("ratings").delete().eq("user_id",e).eq("title_id",o);if(m)throw new Error(m.message);return{titleId:o,rating:null}}const{error:u}=await y.from("ratings").upsert({user_id:e,title_id:o,rating:a,updated_at:new Date().toISOString(),content_type:c},{onConflict:"user_id,title_id"});if(u)throw new Error(u.message);return{titleId:o,rating:a}},onSuccess:()=>{e&&(r.invalidateQueries({queryKey:l.diaryLibrary(e)}),r.invalidateQueries({queryKey:l.diaryStats(e)}),r.invalidateQueries({queryKey:l.homeForYou(e)}),r.invalidateQueries({queryKey:l.titleDiary(e,void 0)}))}});return{updateStatus:d,updateRating:s}},Q=t=>{switch(t){case"want_to_watch":return"Want to watch";case"watching":return"Watching";case"watched":return"Watched";case"dropped":return"Dropped";default:return"Tap to add status"}},F=t=>{switch(t){case"want_to_watch":return"border-amber-500/40 bg-amber-500/10 text-amber-200";case"watching":return"border-sky-500/40 bg-sky-500/10 text-sky-200";case"watched":return"border-emerald-500/40 bg-emerald-500/10 text-emerald-200";case"dropped":return"border-rose-500/40 bg-rose-500/10 text-rose-200";default:return"border-border bg-background/60 text-muted-foreground"}};export{K as a,F as b,v as c,Q as d,D as u};
