import{c as $,j as e,o as D,u as L,r as g,d as z,f as B,B as h,p as U,M as R,s as u}from"./index-DhZ1aP8k.js";import{P as f}from"./PageChrome-D5rVYUnf.js";import{T as b}from"./TopBar-DqXtwt_r.js";import{u as q}from"./useProfile-eNjuBR3L.js";import{D as Y,a as O}from"./DiaryLibraryTab-D1PTD1wZ.js";import{u as K,U as V,a as W}from"./useToggleFollow-BcLCdC_E.js";import{S as G}from"./sparkles-BJZdJSJT.js";import{U as H}from"./users-B9oifkuI.js";import"./brand-DTIDtbc4.js";import"./index-iD4_ZCVg.js";import"./format-DWLSBLoY.js";import"./film-CREplfjy.js";import"./bookmark-plus-BV4gvKYq.js";import"./star-Bb9N3hIp.js";import"./useDiaryLibrary-erQe_aZ2.js";import"./diaryStatus-BH3whMXG.js";const J=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],_=$("settings",J),Q=({profileId:s,displayName:a,username:t,isCurrentUser:i=!1})=>e.jsx("div",{className:"mt-2",children:e.jsx(Y,{userId:s,isOwnProfile:i,displayName:a,username:t})}),X=({profileId:s,displayName:a,username:t,isCurrentUser:i=!1})=>e.jsx("div",{className:"mt-2",children:e.jsx(O,{userId:s,isOwnProfile:i,displayName:a,username:t})}),F=s=>s>=1e6?`${(s/1e6).toFixed(1).replace(/\.0$/,"")}M`:s>=1e3?`${(s/1e3).toFixed(1).replace(/\.0$/,"")}K`:String(s??0),Z=(s,a)=>{const i=(s||a||"").replace(/^@/,"").trim();if(!i)return"?";const n=i.split(/\s+/);return n.length===1?n[0].slice(0,2).toUpperCase():(n[0][0]+n[1][0]).toUpperCase()},ge=()=>{const{username:s}=D(),a=L(),[t,i]=g.useState("activity"),[n,y]=g.useState(!1),{data:r,isLoading:I,isError:S,error:v}=q(s??null),{user:w}=z(),p=K(),j=g.useMemo(()=>r?r.displayName||r.username||"Profile":s?`@${s}`:"Profile",[r,s]);if(!s)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-4 pt-2 sm:px-4 lg:px-6",children:[e.jsx(b,{title:"Profile",subtitle:"This route needs a username to show someone’s profile."}),e.jsx(f,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Make sure you are visiting a URL like",e.jsx("span",{className:"mx-1 rounded bg-card px-1.5 py-0.5 font-mono text-xs",children:"/u/<username>"}),"so we know whose profile to display."]})})]});if(I)return e.jsx(B,{message:"Fetching profile details…"});if(S||!r)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-4 pt-2 sm:px-4 lg:px-6",children:[e.jsx(b,{title:"Profile not found"}),e.jsxs(f,{children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["We couldn't find a profile for username",e.jsxs("span",{className:"mx-1 rounded bg-card px-1.5 py-0.5 font-mono text-xs",children:["@",s]}),"."]}),v?.message&&e.jsxs("p",{className:"mt-3 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Details:"})," ",v.message]})]})]});const N=async()=>{if(r){if(r.isCurrentUser){a("/settings");return}p.isPending||p.mutate({targetUserId:r.id,currentlyFollowing:r.isFollowing})}},T=async()=>{if(!(!r||r.isCurrentUser)){if(!w?.id){alert("You need to be signed in to message other members.");return}y(!0);try{const l=w.id,{data:M,error:C}=await u.from("conversation_participants").select("conversation_id").eq("user_id",l);if(C)throw C;const k=(M??[]).map(m=>m.conversation_id);let c=null;if(k.length>0){const{data:m,error:x}=await u.from("conversation_participants").select("conversation_id").eq("user_id",r.id).in("conversation_id",k);if(x)throw x;const d=Array.from(new Set((m??[]).map(o=>o.conversation_id)));if(d.length>0){const{data:o,error:P}=await u.from("conversations").select("id, is_group, updated_at").in("id",d).eq("is_group",!1).order("updated_at",{ascending:!1}).limit(1);if(P)throw P;o&&o.length>0&&(c=o[0].id)}}if(!c){const{data:m,error:x}=await u.from("conversations").insert({is_group:!1,title:null,created_by:l}).select("id").single();if(x)throw x;const d=m?.id,{error:o}=await u.from("conversation_participants").insert([{conversation_id:d,user_id:l,role:"member"},{conversation_id:d,user_id:r.id,role:"member"}]);if(o)throw o;c=d}if(!c)throw new Error("Failed to start a conversation.");a(`/messages/${c}`)}catch(l){console.error("[ProfilePage] Failed to start conversation",l),alert(l?.message??"Something went wrong while starting the conversation. Please try again.")}finally{y(!1)}}},E=r.isCurrentUser?"Edit profile":r.isFollowing?"Following":"Follow",A=r.isCurrentUser?_:r.isFollowing?V:W;return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(b,{title:j,subtitle:r.bio||"See their diary entries, activity, and who they follow."}),e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col gap-6 rounded-2xl border border-border bg-gradient-to-r from-background to-card/60 p-4 shadow-lg sm:p-5",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-start sm:gap-6",children:[e.jsxs("div",{className:"flex items-start gap-4 sm:gap-5",children:[e.jsxs("div",{className:"relative flex h-20 w-20 items-center justify-center rounded-[28px] bg-gradient-to-br from-primary/15 via-primary/20 to-background ring-1 ring-border/80",children:[r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:r.displayName||r.username||"Profile avatar",className:"h-20 w-20 rounded-[22px] object-cover"}):e.jsx("span",{className:"text-lg font-semibold text-primary","aria-hidden":"true",children:Z(r.displayName,r.username)}),!r.isCurrentUser&&e.jsx("span",{className:"absolute -bottom-2 left-1/2 -translate-x-1/2 rounded-full bg-primary/10 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-primary ring-1 ring-primary/30",children:r.isFollowing?"Following":"New"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h2",{className:"text-lg font-heading font-semibold text-foreground",children:j}),r.username&&e.jsxs("span",{className:"rounded-full bg-background px-2 py-0.5 text-xs font-mono text-muted-foreground ring-1 ring-border",children:["@",r.username]}),r.isCurrentUser&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-primary/10 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-primary ring-1 ring-primary/30",children:[e.jsx(G,{className:"h-3 w-3","aria-hidden":"true"}),"You"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-6 text-center text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex min-w-[80px] flex-col",children:[e.jsx("span",{className:"text-base font-semibold text-foreground",children:F(r.followersCount)}),e.jsx("span",{className:"text-xs uppercase tracking-wide",children:"Followers"})]}),e.jsxs("div",{className:"flex min-w-[80px] flex-col",children:[e.jsx("span",{className:"text-base font-semibold text-foreground",children:F(r.followingCount)}),e.jsx("span",{className:"text-xs uppercase tracking-wide",children:"Following"})]}),e.jsxs("div",{className:"flex min-w-[80px] flex-col",children:[e.jsx("span",{className:"text-base font-semibold text-foreground",children:t==="activity"?"Activity":"Diary"}),e.jsx("span",{className:"text-xs uppercase tracking-wide",children:"View"})]})]}),r.bio&&e.jsx("p",{className:"max-w-2xl whitespace-pre-line text-[12px] leading-snug text-muted-foreground",children:r.bio})]})]}),e.jsx("div",{className:"flex flex-1 flex-wrap items-start justify-end gap-2",children:r.isCurrentUser?e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:N,children:[e.jsx(_,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:"Edit profile"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(h,{type:"button",size:"sm",onClick:N,disabled:p.isPending,className:r.isFollowing?"border border-border bg-card text-foreground hover:bg-background":"",children:[p.isPending?e.jsx(U,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(A,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:E})]}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:T,disabled:n,children:[n?e.jsx(U,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(R,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:n?"Starting…":"Message"})]})]})})]}),!r.isCurrentUser&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 rounded-xl border border-dashed border-border bg-background/70 px-3 py-2 text-xs text-muted-foreground shadow-md",children:[e.jsx(H,{className:"h-4 w-4 text-primary","aria-hidden":"true"}),e.jsx("p",{className:"font-medium text-foreground",children:"Follow to catch their latest reviews and diary logs."})]})]})}),e.jsx(f,{tone:"muted",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-xl bg-background/70 px-3 py-2 text-xs text-muted-foreground ring-1 ring-border/70",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"rounded-full bg-primary/10 px-2 py-0.5 text-xs font-semibold uppercase tracking-wide text-primary",children:"Profile view"}),e.jsxs("p",{className:"text-foreground",children:["You're browsing ",r.isCurrentUser?"your":"their"," latest activity and"," ","diary entries."]})]}),!r.isCurrentUser&&r.username&&e.jsxs("span",{className:"rounded-full bg-background px-2 py-0.5 font-mono text-xs text-muted-foreground ring-1 ring-border/70",children:["@",r.username]})]}),e.jsxs("nav",{className:"flex items-center gap-1.5 rounded-lg bg-muted p-1.5 text-xs text-muted-foreground","aria-label":"Profile tabs",children:[e.jsx("button",{type:"button",onClick:()=>i("activity"),className:`inline-flex flex-1 items-center justify-center rounded-md px-3 py-1.5 text-xs font-medium ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 transition-all ${t==="activity"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:bg-background/80"}`,"aria-pressed":t==="activity",children:"Activity"}),e.jsx("button",{type:"button",onClick:()=>i("diary"),className:`inline-flex flex-1 items-center justify-center rounded-md px-3 py-1.5 text-xs font-medium ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 transition-all ${t==="diary"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:bg-background/80"}`,"aria-pressed":t==="diary",children:"Diary"})]}),e.jsx("div",{"aria-live":"polite",className:"rounded-xl border border-border bg-card/60 px-3 py-3 shadow-md",children:t==="activity"?e.jsx(Q,{profileId:r.id,displayName:r.displayName,username:r.username,isCurrentUser:r.isCurrentUser}):e.jsx(X,{profileId:r.id,displayName:r.displayName,username:r.username,isCurrentUser:r.isCurrentUser})})]})})]})};export{ge as default};
