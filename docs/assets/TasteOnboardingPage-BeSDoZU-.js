import{u as A,r,h as B,s as q,af as H,j as e,z as Q,ag as g,B as f,S as _,l as $,t as K}from"./index-Bghr9v56.js";import{I as V}from"./input-DfCZuzqY.js";import{a as W,u as X}from"./useSearchTitles-BZGeTroe.js";import{X as M}from"./x-C_YReo_I.js";import{C as m}from"./circle-check-DV_fQF9J.js";import{P as j}from"./plus-BjSwKdJ7.js";function Y(n){const c=n.posterUrl??(n.tmdbPosterPath?K(n.tmdbPosterPath,"w342"):null);return{id:n.mediaItemId,title:n.title??"Untitled",posterUrl:c}}function J(n){return{id:n.id,title:n.title,posterUrl:n.posterUrl??null}}const U=5,Z=["Action","Adventure","Animation","Comedy","Crime","Documentary","Drama","Family","Fantasy","History","Horror","Mystery","Romance","Sci-Fi","Thriller","War"],le=()=>{const n=A(),c=r.useMemo(()=>B(),[]),[b,L]=r.useState(""),N=W(b,250),[F,G]=r.useState([]),[T,y]=r.useState(!0),[v,w]=r.useState(null),[i,S]=r.useState({}),d=Object.keys(i).length,[x,D]=r.useState({}),u=r.useMemo(()=>Object.keys(x),[x]),[p,k]=r.useState(!1),[C,P]=r.useState(null),o=X({query:N,filters:{type:"all"}}),I=r.useMemo(()=>(o.data?.pages??[]).flatMap(t=>t.results??[]),[o.data]),E=r.useCallback(s=>{const t=String(s).trim();t&&D(a=>{const l={...a};return l[t]?(delete l[t],l):Object.keys(l).length>=6?l:{...l,[t]:!0}})},[]),O=r.useCallback(s=>{S(t=>{const a={...t};return a[s.id]?(delete a[s.id],a):{...a,[s.id]:s}})},[]),R=r.useCallback(s=>{S(t=>{const a={...t};return delete a[s],a})},[]),h=r.useCallback(async()=>{try{await q.auth.updateUser({data:{onboarded:!0}})}catch{}n("/swipe",{replace:!0})},[n]),z=r.useCallback(async()=>{P(null),k(!0);try{const s=Object.keys(i),t=await H({sessionId:c,mediaItemIds:s,preferredGenres:u},{timeoutMs:45e3});if(!t.ok)throw new Error(t.message??"Onboarding failed");await h()}catch(s){console.error(s),P(s?.message??"Something went wrong")}finally{k(!1)}},[h,i,u,c]);return r.useEffect(()=>{let s=!1;return(async()=>{y(!0),w(null);try{const a=await $({sessionId:c,mode:"trending",limit:24,seed:`onb:${new Date().toISOString().slice(0,10)}`},{timeoutMs:3e4});if(s)return;const l=a.cards??[];G(l.map(Y))}catch(a){console.error(a),s||w("Couldn’t load suggestions. You can still search below.")}finally{s||y(!1)}})(),()=>{s=!0}},[c]),p?e.jsx(Q,{}):e.jsxs("div",{className:"mx-auto flex min-h-screen w-full max-w-5xl flex-col gap-6 px-4 py-10",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"type-heading text-foreground",children:"Pick a few titles you like"}),e.jsxs("p",{className:"type-body text-muted-foreground",children:["Choose at least ",U,". This helps MoviNesta personalize your “For you” deck immediately."]})]}),C&&e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:C}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"type-caption text-muted-foreground",children:"Selected:"}),d===0?e.jsx("span",{className:"type-caption text-foreground",children:"None yet"}):Object.values(i).slice(0,12).map(s=>e.jsx(g,{onClick:()=>R(s.id),children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(M,{className:"h-3.5 w-3.5"}),s.title]})},s.id)),d>12&&e.jsxs("span",{className:"type-caption text-muted-foreground",children:["+",d-12," more"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(f,{onClick:z,disabled:d<U||p,className:"rounded-2xl",children:[e.jsx(m,{className:"mr-2 h-4 w-4"}),"Continue"]}),e.jsx(f,{variant:"ghost",onClick:h,className:"rounded-2xl",disabled:p,children:"Skip for now"})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"type-subheading text-foreground",children:"Optional: pick genres you enjoy"}),e.jsx("p",{className:"type-caption text-muted-foreground",children:"This helps diversify your deck and improves cold-start recommendations."})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Z.map(s=>{const t=!!x[s];return e.jsx(g,{onClick:()=>E(s),className:t?"border-foreground/30 bg-foreground/10":void 0,children:e.jsxs("span",{className:"flex items-center gap-1",children:[t?e.jsx(m,{className:"h-3.5 w-3.5"}):e.jsx(j,{className:"h-3.5 w-3.5"}),s]})},s)})}),u.length>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"type-caption text-muted-foreground",children:"Genres:"}),u.map(s=>e.jsx(g,{onClick:()=>E(s),children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(M,{className:"h-3.5 w-3.5"}),s]})},s))]})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"type-subheading text-foreground",children:"Popular picks"}),e.jsxs("span",{className:"type-caption text-muted-foreground",children:["Tap to ",d?"toggle":"select"]})]}),T?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"Loading suggestions…"})}):v?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:v})}):e.jsx("div",{className:"grid grid-cols-2 gap-3",children:F.map(s=>{const t=!!i[s.id];return e.jsxs("button",{type:"button",onClick:()=>O(s),className:"group relative overflow-hidden rounded-2xl border border-border bg-card/60 text-left",children:[s.posterUrl?e.jsx("img",{src:s.posterUrl,alt:s.title,className:"h-44 w-full object-cover transition-transform group-hover:scale-[1.02]",loading:"lazy"}):e.jsx("div",{className:"flex h-44 w-full items-center justify-center text-xs text-muted-foreground",children:"No poster"}),e.jsx("div",{className:"p-2",children:e.jsx("div",{className:"line-clamp-2 type-caption font-medium text-foreground",children:s.title})}),e.jsx("div",{className:"absolute right-2 top-2 grid h-9 w-9 place-items-center rounded-full bg-background/80 shadow",children:t?e.jsx(m,{className:"h-4 w-4"}):e.jsx(j,{className:"h-4 w-4"})})]},s.id)})})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsx("h2",{className:"type-subheading text-foreground",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(_,{className:"pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(V,{value:b,onChange:s=>L(s.target.value),placeholder:"Search movies and series…",className:"pl-9"})]}),o.isLoading?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"Searching…"})}):N.trim().length>0&&I.length===0?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"No results."})}):e.jsxs("div",{className:"space-y-2",children:[I.slice(0,20).map(s=>{const t=J(s),a=!!i[t.id];return e.jsxs("button",{type:"button",onClick:()=>O(t),className:"soft-row-card soft-row-card-interactive flex w-full items-center gap-3 row-pad text-left",children:[t.posterUrl?e.jsx("img",{src:t.posterUrl,alt:t.title,className:"h-16 w-12 rounded-xl object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-16 w-12 items-center justify-center rounded-xl bg-background/60 text-xs text-muted-foreground",children:"—"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"truncate type-label text-foreground",children:t.title}),e.jsxs("div",{className:"type-caption text-muted-foreground",children:[s.type??"title"," ",typeof s.year=="number"?`• ${s.year}`:""]})]}),e.jsx("div",{className:"grid h-9 w-9 place-items-center rounded-full bg-background/80 shadow",children:a?e.jsx(m,{className:"h-4 w-4"}):e.jsx(j,{className:"h-4 w-4"})})]},s.id)}),o.hasNextPage&&e.jsx("div",{className:"pt-2",children:e.jsx(f,{variant:"ghost",className:"rounded-2xl",disabled:o.isFetchingNextPage,onClick:()=>o.fetchNextPage(),children:o.isFetchingNextPage?"Loading…":"Load more"})})]})]})]})};export{le as default};
