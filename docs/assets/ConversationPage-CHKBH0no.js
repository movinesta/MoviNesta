import{C as $e,s as Q,r as n,an as Re,e as ee,a7 as kn,ao as rt,b as at,ap as In,c as ot,w as Nt,aq as os,ar as En,as as Tn,o as An,at as is,n as _n,au as fs,av as Dn,aw as ms,ak as Rt,N as gs,ax as Ln,R as W,j as s,i as Ct,E as ce,B as K,ay as Un,az as qn,aA as Bn,u as ps,al as H,aB as hs,I as On,A as Pn,am as ls,K as Fn,L as $n}from"./index-FRLeEtOr.js";import{m as it,a as Hn,b as Kn,M as St,s as Qn,i as xs,c as ys,d as bs,e as vs,f as zn,n as Vn,r as ws,g as Ms,h as Jn,C as Wn,j as Gn,k as Yn,S as Xn,T as Zn,l as cs,u as er,o as tr,p as sr,q as nr,t as rr,v as ar}from"./scroll-area-DWfK_X0v.js";import{u as Me}from"./conversationsCache-y5RHZfL7.js";import{w as or,a as ir,B as lr,u as cr,M as ur}from"./useAssistantCache-DLvOENRu.js";import{B as dr}from"./bell-BSzNUAEB.js";import{T as Rs}from"./textarea-8R5PEgzx.js";import{C as fr}from"./circle-alert-C9LGaVPh.js";import{D as kt,a as It,b as js,c as Et,d as Ns,e as Cs}from"./dialog-D6_lOO3L.js";import{M as z}from"./material-icon-BwQ7CAOZ.js";import{C as mr}from"./copy-DQ5V5Cjh.js";import{U as gr}from"./user-CAodWlkZ.js";import{u as pr}from"./useUserLastActive-Di4eoglR.js";import"./format-BXv9LLlt.js";import"./plus-aqzEzVew.js";import"./x-DxtH38RV.js";import"./index-QF19Xe59.js";import"./clock-B5yAEKO4.js";const hr=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],xr=$e("arrow-down",hr);const yr=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],br=$e("camera",yr);const vr=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],wr=$e("send",vr);const Mr=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Ss=$e("shield-x",Mr);const Rr=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],jr=$e("smile",Rr),jt=new Map,Nr=t=>{const e=jt.get(t);if(e)return e;const r=Q.channel(`conversation-db-${t}`),o={conversationId:t,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.messageInsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(a=>{const l=a;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),jt.set(t,o),o},Cr=(t,e)=>{const r=Nr(t);r.refCount+=1;const o=[];return e.onStatus&&(r.statusListeners.add(e.onStatus),o.push(()=>r.statusListeners.delete(e.onStatus)),r.lastStatus&&e.onStatus(r.lastStatus)),e.onMessageInsert&&(r.messageInsertListeners.add(e.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(e.onMessageInsert))),e.onMessageUpdate&&(r.messageUpdateListeners.add(e.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(e.onMessageUpdate))),e.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(e.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(e.onReadReceiptUpsert))),e.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(e.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(e.onDeliveryReceiptUpsert))),e.onReactionUpsert&&(r.reactionUpsertListeners.add(e.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(e.onReactionUpsert))),e.onReactionDelete&&(r.reactionDeleteListeners.add(e.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(e.onReactionDelete))),()=>{for(const a of o)a();if(r.refCount-=1,r.refCount<=0){try{Q.removeChannel(r.channel)}catch{}jt.delete(t)}}},lt=(t,e,r)=>{n.useEffect(()=>{if(t)return Cr(t,e())},[t,e,...r])},Sr=5e3,kr=1500,Ir=5e3,Er=t=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?kr:Sr,refetchIntervalInBackground:!1}),Tr=new Set(["SUBSCRIBED"]),Ar=t=>!Tr.has(t),_r=t=>{const[e,r]=n.useState(!1),o=n.useRef(t);n.useEffect(()=>{Object.is(o.current,t)||(o.current=t,r(!1))},[t]);const a=n.useCallback(l=>{const c=Ar(l);r(d=>d===c?d:c)},[]);return{pollWhenRealtimeDown:e,onStatus:a}},ct=t=>{const{pollWhenRealtimeDown:e,onStatus:r}=_r(t);return{pollWhenRealtimeDown:e,onRealtimeStatus:r,refetchOptions:Er(e)}},Dr=t=>typeof t=="object"&&t!==null,ks=t=>t.new,Lr=t=>t.old,je=(t,e)=>{if(!Dr(t))return null;const r=t[e];return typeof r=="string"?r:null},Is=(t,e)=>je(t,"conversation_id")===e,Es=40,nt=1e5,Ur=t=>`"${t.replace(/"/g,'\\"')}"`,qr=t=>{const e=Ur(t.createdAt),r=t.id;return`created_at.lt.${e},and(created_at.eq.${e},id.lt.${r})`},Br=t=>{const e=Qn((t??[]).map(it)),r=(t??[]).length>=Es,o=e.length?{createdAt:e[0].createdAt,id:e[0].id}:null;return{items:e,hasMore:r,cursor:o}},Or=(t,e)=>{const r=n.useMemo(()=>Re(t),[t]),o=ee(),[a,l]=n.useState(nt),{pollWhenRealtimeDown:c,onRealtimeStatus:d,refetchOptions:f}=ct(t),u=n.useRef(e);n.useEffect(()=>{u.current=e},[e]);const b=n.useRef({pages:0,total:0}),h=kn({queryKey:r,enabled:!!t,initialPageParam:null,...f,staleTime:Ir,queryFn:async({pageParam:x})=>{if(!t)return{items:[],hasMore:!1,cursor:null};let y=Q.from("messages").select(St).eq("conversation_id",t).order("created_at",{ascending:!1}).order("id",{ascending:!1});x&&(y=y.or(qr(x)));const{data:R,error:N}=await y.limit(Es);if(N)throw console.error(`[useConversationMessages] Failed to load ${x?"older messages":"messages"}`,N),new Error(N.message);return Br(R??[])},getNextPageParam:()=>{},getPreviousPageParam:x=>{if(x.hasMore)return x.cursor??void 0},structuralSharing:(x,y)=>Kn(x,y)});n.useEffect(()=>{const x=h.data?.pages??[],y=x.reduce((E,M)=>E+M.items.length,0),R=b.current;if(x.length===0){b.current={pages:0,total:0},l(nt);return}if(R.pages===0){b.current={pages:x.length,total:y},l(nt);return}const N=y-R.total,k=x.length-R.pages;N>0&&k>0&&l(E=>Math.max(0,E-N)),b.current={pages:x.length,total:y}},[h.data?.pages]);const v=n.useCallback(()=>{if(!t)return{};const x=(y,R)=>{const N=ks(y);if(!Is(N,t)||!je(N,"id"))return;const E=N,M=it(E);o.setQueryData(r,j=>Hn(j,E,{allowAppend:R==="insert"})),R==="insert"?u.current?.onInsert?.(M):u.current?.onUpdate?.(M)};return{onStatus:d,onMessageInsert:y=>{x(y,"insert")},onMessageUpdate:y=>{x(y,"update")}}},[t,d,o,r]);lt(t,v,[]),n.useEffect(()=>{l(nt),b.current={pages:0,total:0}},[t]);const p=n.useMemo(()=>(h.data?.pages??[]).flatMap(y=>y.items),[h.data?.pages]),m=n.useCallback(async()=>{t&&h.hasPreviousPage&&await h.fetchPreviousPage()},[t,h]);return n.useMemo(()=>({data:p,dataUpdatedAt:h.dataUpdatedAt,isLoading:h.isLoading,isFetching:h.isFetching,isError:h.isError,error:h.error,refetch:h.refetch,loadOlder:m,hasMore:!!h.hasPreviousPage,isLoadingOlder:h.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:c}),[p,h.dataUpdatedAt,h.isLoading,h.isFetching,h.isError,h.error,h.refetch,m,h.hasPreviousPage,h.isFetchingPreviousPage,a,r,c])};function Pr(t){const{conversation:e,deliveryReceipts:r,readReceipts:o,currentUserId:a,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:d}=t;if(!e||!a)return()=>null;const f=e.participants.filter(p=>!p.isSelf);if(f.length===0)return()=>null;const u=new Set(f.map(p=>p.id)),b=p=>{if(!p)return null;const m=d?.get(p);return m??null},h=new Map;for(const p of o??[]){let m=null;if(p.lastReadMessageId){const R=b(p.lastReadMessageId);R!=null&&(m=R),R==null&&(m=null)}else if(p.lastReadAt){const R=new Date(p.lastReadAt).getTime();Number.isNaN(R)||(m=R)}if(m==null)continue;const x=(()=>{if(!p.lastReadAt)return null;const R=new Date(p.lastReadAt).getTime();return Number.isNaN(R)?null:R})(),y=h.get(p.userId);if(!y||m>y.upToMs){h.set(p.userId,{upToMs:m,readAtMs:x});continue}m===y.upToMs&&x!=null&&(y.readAtMs==null||x>y.readAtMs)&&h.set(p.userId,{upToMs:m,readAtMs:x})}const v=new Map;for(const p of r??[]){if(!u.has(p.userId)||c&&!c.has(p.messageId))continue;let m=v.get(p.messageId);m||(m=new Set,v.set(p.messageId,m)),m.add(p.userId)}return p=>{if(p.senderId!==a)return null;if(l[p.id])return{status:"failed"};if(xs(p.id))return{status:"sending"};const m=(()=>{const N=new Date(p.createdAt??"").getTime();return Number.isNaN(N)?0:N})();let x=0,y=null;for(const N of f){const k=h.get(N.id);if(k&&k.upToMs>=m){x+=1;const E=k.readAtMs??k.upToMs;(y===null||E>y)&&(y=E)}}return x===f.length&&f.length>0?{status:"seen",seenAt:y!=null?new Date(y).toISOString():null}:(v.get(p.id)?.size??0)===f.length&&f.length>0?{status:"delivered"}:{status:"sent"}}}function Fr(t){const{messages:e,conversation:r,currentUserId:o,participantsById:a,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:d,readReceipts:f,failedMessages:u,lastOwnMessageId:b}=t,h=n.useMemo(()=>{if(!e)return[];const p=new Set;b&&p.add(b);for(const y of Object.keys(u))p.add(y);const m=new Map;for(const y of e){const R=new Date(y.createdAt??"").getTime();Number.isNaN(R)||m.set(y.id,R)}const x=Pr({conversation:r??null,deliveryReceipts:d,readReceipts:f,currentUserId:o,failedMessages:u,onlyMessageIds:p,messageCreatedAtMsById:m});return e.map(y=>{const R=rt(y.body),N=a.get(y.senderId)??null,k=N?.isSelf??(o!=null&&y.senderId===o),E=k&&p.has(y.id)?x(y):null,M=!!E&&k&&!R.deleted&&(E.status==="failed"||b===y.id);return{message:y,meta:R,sender:N,isSelf:k,deliveryStatus:E,showDeliveryStatus:M,reactions:l.get(y.id)??[]}})},[r,o,d,u,b,e,a,l,f]),v=n.useMemo(()=>h.filter(({message:p})=>!c[p.id]),[h,c]);return{uiMessages:h,visibleMessages:v}}function $r(t){const{messages:e,currentUserId:r,hiddenMessageIds:o}=t;return n.useMemo(()=>{if(!e||!r)return null;for(let a=e.length-1;a>=0;a-=1){const l=e[a];if(!(o[l.id]||l.senderId!==r||rt(l.body).deleted))return l.id}return null},[o,e,r])}const Hr=async t=>{const{data:e,error:r}=await Q.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(e??[]).map(bs)},Kr=async(t,e)=>{if(e.length===0)return[];const r=Q.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).in("message_id",e),{data:o,error:a}=await r.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(o??[]).map(vs)},Qr=async t=>{const{data:e,error:r}=await Q.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(e??[]).map(ys)},zr=(t,e)=>{const r=new Map,o=new Map;for(const l of t){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let d=c.get(l.emoji);d||(d={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,d),o.get(l.messageId).push(l.emoji)),d.count+=1,e&&l.userId===e&&(d.reactedBySelf=!0)}const a=new Map;for(const[l,c]of r.entries()){const d=o.get(l)??[];a.set(l,d.map(f=>c.get(f)).filter(Boolean))}return a},Vr=(t,e,r)=>{const o=t??[],a=r.key(e),l=[...o],c=l.findIndex(d=>r.key(d)===a);return c>=0?l[c]=e:l.push(e),r.sort&&l.sort(r.sort),l},Jr=(t,e,r)=>{const o=t??[];return o.length===0?[]:o.filter(a=>r.key(a)!==e)},Tt=t=>e=>{const r=ks(e);if(!Is(r,t.conversationId)||t.extraGuard&&!t.extraGuard(r)||!(t.getRequiredId?t.getRequiredId(r):je(r,"id")))return;const a=r,l=t.mapRow(a);t.queryClient.setQueryData(t.queryKey,c=>Vr(c,l,{key:t.key,sort:t.sort}))},Wr=t=>e=>{const r=Lr(e),o=t.getRowId?t.getRowId(r):je(r,"id");if(!o){t.invalidateWhenMissingId!==!1&&t.queryClient.invalidateQueries({queryKey:t.queryKey});return}t.queryClient.setQueryData(t.queryKey,a=>Jr(a,o,{key:t.key}))},Gr=t=>{const{user:e}=at(),r=e?.id??null,o=ee(),a=n.useMemo(()=>In(t),[t]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:d}=ct(t),f=ot({queryKey:a,enabled:!!t,...d,queryFn:()=>t?Qr(t):Promise.resolve([])}),u=n.useCallback(()=>{if(!t)return{};const v=Tt({conversationId:t,queryClient:o,queryKey:a,mapRow:ys,key:m=>m.id,sort:(m,x)=>{const y=os(m.createdAt),R=os(x.createdAt);return y!==R?y-R:m.id.localeCompare(x.id)}}),p=Wr({queryClient:o,queryKey:a,key:m=>m.id});return{onStatus:c,onReactionUpsert:v,onReactionDelete:p}},[t,c,o,a]);lt(t,u,[]);const b=Nt({mutationFn:async({messageId:v,emoji:p})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:m}=await Q.from("message_reactions").insert({conversation_id:t,message_id:v,user_id:r,emoji:p});if(m){if(m?.code==="23505"){const{error:x}=await Q.from("message_reactions").delete().eq("message_id",v).eq("user_id",r).eq("emoji",p);if(x)throw console.error("[useConversationReactions] Failed to remove reaction",x),x;return}throw console.error("[useConversationReactions] Failed to toggle reaction",m),m}},onMutate:async({messageId:v,emoji:p})=>{if(!t||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:a});const m=o.getQueryData(a);return o.setQueryData(a,x=>{const y=x??[],R=y.findIndex(k=>k.messageId===v&&k.userId===r&&k.emoji===p);if(R>=0){const k=[...y];return k.splice(R,1),k}const N={id:zn(),conversationId:t,messageId:v,userId:r,emoji:p,createdAt:new Date().toISOString()};return[...y,N]}),{previousReactions:m}},onError:(v,p,m)=>{t&&(m?.previousReactions?o.setQueryData(a,m.previousReactions):o.invalidateQueries({queryKey:a}))},onSuccess:()=>{t&&o.invalidateQueries({queryKey:a})}}),h=n.useMemo(()=>{const v=f.data??[];return zr(v,r)},[f.data,r]);return{reactions:f.data??[],reactionsByMessageId:h,isLoadingReactions:f.isLoading,toggleReaction:b,pollWhenRealtimeDown:l,queryKey:a}},Yr=t=>{const e=ee(),r=n.useMemo(()=>En(t),[t]),{pollWhenRealtimeDown:o,onRealtimeStatus:a,refetchOptions:l}=ct(t),c=ot({queryKey:r,enabled:!!t,...l,queryFn:async()=>t?Hr(t):[]}),d=n.useCallback(()=>{if(!t)return{};const f=Tt({conversationId:t,queryClient:e,queryKey:r,mapRow:bs,key:u=>u.userId,getRequiredId:u=>je(u,"user_id"),sort:(u,b)=>{const h=!u.lastReadAt,v=!b.lastReadAt;if(h&&v)return 0;if(h)return 1;if(v)return-1;const p=new Date(u.lastReadAt).getTime(),m=new Date(b.lastReadAt).getTime();return Number.isNaN(p)&&Number.isNaN(m)?0:Number.isNaN(p)?1:Number.isNaN(m)?-1:m-p}});return{onStatus:a,onReadReceiptUpsert:f}},[t,a,e,r]);return lt(t,d,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},Xr=(t,e)=>{const r=ee(),o=n.useMemo(()=>Vn(e,{excludeTemp:!0,sort:!0}),[e]),a=n.useMemo(()=>Tn(t,o),[t,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:d}=ct(t),f=ot({queryKey:a,enabled:!!(t&&o.length>0),...d,queryFn:async()=>t?o.length===0?[]:Kr(t,o):[]}),u=n.useCallback(()=>{if(!t)return{};if(o.length===0)return{};const h=new Set(o),v=Tt({conversationId:t,queryClient:r,queryKey:a,mapRow:vs,key:p=>p.id,extraGuard:p=>{const m=je(p,"message_id");return!!(m&&h.has(m))},sort:(p,m)=>{const x=new Date(p.deliveredAt??"").getTime(),y=new Date(m.deliveredAt??"").getTime(),R=Number.isNaN(x)?0:x,N=Number.isNaN(y)?0:y;return R-N}});return{onStatus:c,onDeliveryReceiptUpsert:v}},[t,o,c,r,a]),b=t&&o.length>0?t:null;return lt(b,u,[]),n.useMemo(()=>({...f,pollWhenRealtimeDown:l,queryKey:a}),[f,l,a])},Zr=3e3,ea=2e3,ta=5e3,sa=t=>{const{conversationId:e,userId:r,displayName:o}=t,[a,l]=n.useState({}),c=n.useRef(null),d=n.useRef(new Map),f=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),u=n.useCallback(async m=>{if(!e||!r||!o)return;const x=c.current;x&&await x.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:m}})},[e,r,o]),b=n.useCallback(async()=>{f.current.timeoutId!=null&&(window.clearTimeout(f.current.timeoutId),f.current.timeoutId=null),f.current.isTyping&&(f.current.isTyping=!1,f.current.lastSentAtMs=0,await u(!1))},[u]),h=n.useCallback(m=>{if(!e||!r||!o||!c.current)return;const y=f.current.isTyping;if(m){const R=Date.now();y?R-f.current.lastSentAtMs>ea&&(f.current.lastSentAtMs=R,u(!0)):(f.current.isTyping=!0,f.current.lastSentAtMs=R,u(!0)),f.current.timeoutId!=null&&window.clearTimeout(f.current.timeoutId),f.current.timeoutId=window.setTimeout(()=>{f.current.isTyping=!1,f.current.lastSentAtMs=0,f.current.timeoutId=null,u(!1)},Zr);return}y&&b()},[u,e,o,b,r]),v=n.useCallback(()=>{l({}),d.current.forEach(m=>window.clearTimeout(m)),d.current.clear()},[]);return n.useEffect(()=>{if(!e)return;v();const m=Q.channel(`supabase_realtime_typing:conversation:${e}`,{config:{broadcast:{self:!1}}});c.current=m,m.on("broadcast",{event:"typing"},({payload:R})=>{const N=R;if(!N?.userId||r&&N.userId===r)return;l(E=>{const M={...E};return N.isTyping&&N.displayName?M[N.userId]=N.displayName:delete M[N.userId],M});const k=d.current.get(N.userId);if(k!=null&&window.clearTimeout(k),N.isTyping){const E=window.setTimeout(()=>{l(M=>{const j={...M};return delete j[N.userId],j}),d.current.delete(N.userId)},ta);d.current.set(N.userId,E)}else d.current.delete(N.userId)}).subscribe();const x=()=>{document.visibilityState==="hidden"&&b()},y=()=>{b()};return document.addEventListener("visibilitychange",x),window.addEventListener("beforeunload",y),window.addEventListener("pagehide",y),window.addEventListener("blur",y),()=>{document.removeEventListener("visibilitychange",x),window.removeEventListener("beforeunload",y),window.removeEventListener("pagehide",y),window.removeEventListener("blur",y),v(),b(),c.current&&(Q.removeChannel(c.current),c.current=null)}},[e,b,r,v]),{remoteTypingUsers:n.useMemo(()=>Object.entries(a).map(([m,x])=>({userId:m,displayName:x})),[a]),noteLocalInputActivity:h,stopTyping:b}},na=t=>{const{conversationId:e,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:a=250}=t,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>e?`${r}${e}`:null,[e,r]),[d,f]=n.useState("");return n.useEffect(()=>{if(!c){f(""),l.current?.("");return}const h=An(c)??"";f(h),l.current?.(h)},[c]),n.useEffect(()=>{if(!c)return;const b=window.setTimeout(()=>{d.trim().length===0?is(c):_n(c,d)},a);return()=>window.clearTimeout(b)},[c,a,d]),{draft:d,setDraft:f,clearDraft:()=>{c&&is(c),f(""),l.current?.("")}}};function ra({showComposer:t,initialHeaderHeight:e=72,initialComposerHeight:r=160}){const o=n.useRef(null),[a,l]=n.useState(e),[c,d]=n.useState(r),[f,u]=n.useState(null),[b,h]=n.useState(!1),v=n.useCallback(p=>d(Math.max(p,a)),[a]);return n.useEffect(()=>{const p=o.current;if(!p)return;const m=()=>l(Math.max(p.getBoundingClientRect().height,0));if(m(),typeof ResizeObserver>"u")return;const x=new ResizeObserver(m);return x.observe(p),()=>x.disconnect()},[]),n.useEffect(()=>{d(p=>Math.max(p,a))},[a]),n.useEffect(()=>{t||d(0)},[t]),{headerRef:o,headerHeight:a,composerHeight:c,isAtBottom:f,setIsAtBottom:u,handleComposerHeightChange:v,showEmojiPicker:b,setShowEmojiPicker:h}}const aa=({conversationId:t,currentUserId:e,showComposer:r,isBlocked:o,blockedYou:a,composerTextareaRef:l})=>{const[c,d]=n.useState(null),[f,u]=n.useState({}),[b,h]=n.useState(null),[v,p]=n.useState(null),[m,x]=n.useState(null),y=n.useRef(null),R=n.useRef(null);n.useEffect(()=>{if(!t||!e){u({});return}if(typeof window>"u")return;const T=`messages:hidden:${e}:${t}`;try{const P=window.localStorage.getItem(T);if(!P){u({});return}const F=JSON.parse(P);if(Array.isArray(F)){const G={};for(const I of F)typeof I=="string"&&I&&(G[I]=!0);u(G);return}if(F&&typeof F=="object"){const G={};for(const[I,L]of Object.entries(F))L&&(G[I]=!0);u(G);return}u({})}catch{u({})}},[t,e]),n.useEffect(()=>{if(!t||!e||typeof window>"u")return;const T=`messages:hidden:${e}:${t}`;try{const P=Object.keys(f).filter(F=>f[F]);window.localStorage.setItem(T,JSON.stringify(P))}catch{}},[t,e,f]);const N=n.useCallback(()=>{d(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const T=F=>{const G=F.target;if(!(G instanceof Element)){d(null);return}G.closest(`[data-message-action-scope="${c}"]`)||d(null)},P=F=>{F.key==="Escape"&&d(null)};return document.addEventListener("pointerdown",T,!0),document.addEventListener("keydown",P),()=>{document.removeEventListener("pointerdown",T,!0),document.removeEventListener("keydown",P)}},[c]);const k=n.useCallback(T=>{o||a||rt(T.body).deleted||(d(T.id),l.current?.blur())},[a,l,o]),E=n.useCallback((T,P)=>{o||a||rt(T.body).deleted||(P&&(R.current=P),p({messageId:T.id,text:fs(T.body)??"",body:T.body??null,attachmentUrl:T.attachmentUrl??null}),x(null),N(),l.current?.blur())},[a,N,l,o]),M=n.useCallback(T=>{p(P=>P&&{...P,text:T})},[]),j=n.useCallback(()=>{p(null),x(null),R.current?.focus()},[]);n.useEffect(()=>{v&&queueMicrotask(()=>{y.current?.focus()})},[v]);const w=n.useCallback(T=>{o||a||(N(),h({messageId:T.id,attachmentUrl:T.attachmentUrl??null}),l.current?.blur())},[a,N,l,o]),S=n.useCallback(()=>{h(null)},[]),B=n.useCallback(T=>{u(P=>({...P,[T]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(v||b||queueMicrotask(()=>l.current?.focus()))},[c,b,v,r,l]),{activeActionMessageId:c,openMessageActions:k,closeMessageActions:N,hiddenMessageIds:f,hideMessageForMe:B,deleteDialog:b,openDeleteDialog:w,closeDeleteDialog:S,editingMessage:v,openEditDialog:E,updateEditingText:M,closeEditDialog:j,editTextareaRef:y,editError:m,setEditError:x}},us=3e3;function oa(t){const{conversationId:e,userId:r,isAtBottom:o,messages:a}=t,l=ee(),c=n.useRef({conversationId:null,messageId:null,userId:null}),d=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const f=d.current;f.timeoutId!=null&&window.clearTimeout(f.timeoutId),f.timeoutId=null,f.pending=null,f.lastSentAt=0},[e,r]),n.useEffect(()=>()=>{const f=d.current;f.timeoutId!=null&&window.clearTimeout(f.timeoutId),f.timeoutId=null},[]),n.useEffect(()=>{if(!e||!a||a.length===0||!r||!o)return;const f=a[a.length-1];if(xs(f.id)||c.current.conversationId===e&&c.current.messageId===f.id&&c.current.userId===r)return;const u=d.current,b=Date.now(),h=u.lastSentAt?b-u.lastSentAt:Number.POSITIVE_INFINITY,v=()=>{Me(l,r,e,m=>m.hasUnread?{...m,hasUnread:!1}:m)},p=m=>{u.lastSentAt=Date.now();const x=new Date().toISOString();or({conversation_id:e,user_id:r,last_read_message_id:m,last_read_at:x}).then(()=>{c.current={conversationId:e,messageId:m,userId:r},v()}).catch(y=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",y)})};if(h<us){u.pending={conversationId:e,userId:r,messageId:f.id},u.timeoutId==null&&(u.timeoutId=window.setTimeout(()=>{const m=d.current.pending;d.current.pending=null,d.current.timeoutId=null,m&&(c.current.conversationId===m.conversationId&&c.current.messageId===m.messageId&&c.current.userId===m.userId||m.conversationId!==e||m.userId!==r||p(m.messageId))},Math.max(us-h,0)));return}u.timeoutId!=null&&(window.clearTimeout(u.timeoutId),u.timeoutId=null,u.pending=null),p(f.id)},[e,a,r,l,o])}const ia=new Set(["text","image","text+image","system"]),la=t=>{const{user:e}=at(),r=e?.id??null,o=ee();return Nt({mutationFn:async({messageId:a,text:l,currentBody:c,attachmentUrl:d})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(d)throw new Error("Cannot edit messages with attachments.");const f=Dn(c,l),u=ms(f),b=ia.has(u.type)?u.type:"text",{data:h,error:v}=await Q.from("messages").update({body:f,message_type:b,text:u.text.trim()?u.text:null,client_id:u.clientId??null,meta:u.meta??null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(St).single();if(v)throw console.error("[useEditMessage] Failed to edit message",v),new Error(v.message);return it(h)},onSuccess:a=>{if(!t)return;const l=Re(t);o.setQueryData(l,c=>ws(c,a))}})},ca=t=>{const{user:e}=at(),r=e?.id??null,o=ee();return Nt({mutationFn:async({messageId:a,attachmentUrl:l})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const d={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},f=JSON.stringify(d),u=ms(f),{data:b,error:h}=await Q.from("messages").update({body:f,message_type:"system",text:u.text.trim()?u.text:null,client_id:u.clientId??null,meta:u.meta??null,attachment_url:null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(St).single();if(h)throw console.error("[useDeleteMessage] Failed to delete message",h),new Error(h.message);if(l)try{await Ms(l)}catch(p){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",p)}return it(b)},onSuccess:a=>{if(!t)return;const l=Re(t);o.setQueryData(l,c=>ws(c,a)),o.invalidateQueries({queryKey:Rt(r)})}})};function ua(t){const{conversationId:e,setDraft:r,messages:o}=t,a=ee(),[l,c]=n.useState(null),[d,f]=n.useState(null),[u,b]=n.useState(null),[h,v]=n.useState({}),p=n.useRef({});n.useEffect(()=>{p.current=h},[h]);const m=n.useRef(e);n.useEffect(()=>{e!==m.current&&(m.current=e,c(null),f(null),b(null),v({}),p.current={})},[e]),n.useEffect(()=>()=>{const M=Object.values(p.current),j=Array.from(new Set(M.map(w=>w.attachmentPath).filter(w=>typeof w=="string"&&w.length>0&&!Jn(w))));j.length!==0&&Q.storage.from(Wn).remove(j).then(({error:w})=>{w&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)}).catch(w=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)})},[e]),n.useEffect(()=>{o&&v(M=>{const j=new Set(o.map(B=>B.id));let w=!1;const S={...M};for(const B of Object.keys(S))j.has(B)||(delete S[B],w=!0);return w?S:M})},[o]);const x=n.useCallback(()=>{c(null),f(null),b(null)},[]),y=n.useCallback((M,j,w)=>{c(w.message||"Couldn't send. Please try again."),j.text.trim()&&r(j.text),f(j),b(M),v(S=>({...S,[M]:j}))},[r]),R=n.useCallback(M=>{M&&(v(j=>{if(!(M in j))return j;const w={...j};return delete w[M],w}),M===u&&x())},[x,u]),N=n.useCallback(()=>{if(!d)return null;const M=u;return M&&v(j=>{if(!(M in j))return j;const w={...j};return delete w[M],w}),x(),{payload:d,tempId:M}},[x,d,u]),k=n.useCallback(M=>{const j=h[M];return j?(v(w=>{if(!(M in w))return w;const S={...w};return delete S[M],S}),M===u?x():c(null),j):null},[x,h,u]),E=n.useCallback(async M=>{if(!e)return;const j=h[M];if(!j)return;const w=Re(e);if(a.setQueryData(w,S=>Gn(S,M)),v(S=>{if(!(M in S))return S;const B={...S};return delete B[M],B}),M===u&&x(),j.attachmentPath)try{await Ms(j.attachmentPath)}catch(S){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",S)}},[x,e,h,u,a]);return{sendError:l,setSendError:c,lastFailedPayload:d,lastFailedTempId:u,failedMessages:h,clearBannerState:x,onSendFailed:y,onSendRecovered:R,consumeLastFailedForRetry:N,consumeFailedMessageForRetry:k,discardFailedMessage:E}}const da=({currentUserId:t})=>{const e=ee();return n.useCallback(r=>{Me(e,t,r.conversationId,o=>{const a=!!(t&&r.senderId===t);return{...o,lastMessagePreview:Ln(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:gs(r.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),t&&r.senderId!==t&&ir({conversation_id:r.conversationId,message_id:r.id,user_id:t})},[t,e])},fa=({conversationId:t,userId:e,conversation:r,readReceipts:o,visibleMessages:a})=>{const[l,c]=n.useState(void 0),[d,f]=n.useState(void 0);return n.useEffect(()=>{c(void 0),f(void 0)},[t,e]),n.useEffect(()=>{if(!t||!e||l!==void 0)return;const b=(o??[]).find(h=>h.userId===e)??null;c(b?.lastReadMessageId??null)},[t,l,o,e]),n.useEffect(()=>{!t||!e||d===void 0&&r&&f(!!r.hasUnread)},[r,t,d,e]),{firstUnreadIndex:n.useMemo(()=>{if(d===void 0||!d||a.length===0||l===void 0)return null;if(l===null)return 0;const b=a.findIndex(v=>v.message.id===l);if(b<0)return 0;const h=b+1;return h>=a.length?null:h},[d,l,a]),lastReadMessageId:l,hasUnread:d??!1,isReady:d!==void 0&&l!==void 0}};function ma(t){const{items:e=[],itemContent:r,isLoading:o,loadingContent:a,errorContent:l,emptyContent:c,header:d,footer:f,bottomPadding:u,scrollerRef:b,followOutput:h,onAtBottomChange:v,atBottomThreshold:p=80,onStartReached:m,computeItemKey:x,ariaLabel:y="Messages"}=t,R=W.useRef(null),N=W.useRef(!0),k=W.useRef(null),E=W.useRef(!1),M=W.useCallback(w=>{R.current=w,b&&(typeof b=="function"?b(w):b.current=w)},[b]),j=W.useCallback(w=>w.scrollHeight-w.scrollTop-w.clientHeight<=p,[p]);return W.useLayoutEffect(()=>{const w=R.current;if(!w)return;const S=T=>{N.current=T,k.current!==T&&(k.current=T,v?.(T))},B=()=>{const T=j(w);S(T),m&&(w.scrollTop<=24?E.current||(E.current=!0,m()):w.scrollTop>=80&&(E.current=!1))};return B(),w.addEventListener("scroll",B,{passive:!0}),()=>w.removeEventListener("scroll",B)},[j,v,m]),W.useEffect(()=>{const w=R.current;if(!w)return;const S=N.current,B=typeof h=="function"?h(S):h??!1;B&&S&&requestAnimationFrame(()=>{w.scrollTo({top:w.scrollHeight,behavior:B==="smooth"?"smooth":"auto"})})},[e.length]),o?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:a}):l?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):e.length?s.jsx("div",{className:"h-full w-full",children:s.jsx("div",{ref:M,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":y,style:{paddingBottom:u??void 0},children:s.jsxs("div",{className:"px-4 pt-3",children:[d,s.jsx("div",{className:"space-y-0",children:e.map((w,S)=>s.jsx(W.Fragment,{children:r(S,w)},x?x(S,w):S))}),f]})})}):s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const ga=({show:t,pendingCount:e,onClick:r,shortcutHint:o})=>{if(!t)return null;const a=e>1?`Jump to latest message. ${e} new messages`:"Jump to latest message";return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," new message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(xr,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Jump to latest"}),e>0&&s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})},pa=({show:t,unreadCount:e,onClick:r,shortcutHint:o})=>{if(!t||e<=0)return null;const a=e===1?"Jump to the first unread message":`Jump to first unread message. ${e} unread messages`;return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," unread message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(dr,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Unread"}),s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})};function ha(t){const e=t.trim().split(/\s+/).filter(Boolean);return e.length===0?"?":e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]??""}${e[1][0]??""}`.toUpperCase()}function Mt({delayMs:t}){return s.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${t}ms`},"aria-hidden":"true"})}function xa({users:t,className:e}){if(!t.length)return null;const r=t.slice(0,3),o=Math.max(0,t.length-r.length);return s.jsxs("div",{className:Ct("mt-1 flex w-full items-end gap-2 justify-start",e),role:"status","aria-live":"polite","aria-label":t.length===1?`${t[0].displayName} is typing`:"People are typing",children:[s.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(a=>s.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:a.displayName,children:a.avatarUrl?s.jsx("img",{src:a.avatarUrl,alt:a.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:ha(a.displayName)})},a.id)),o>0&&s.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:s.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),s.jsx(Yn,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Mt,{delayMs:0}),s.jsx(Mt,{delayMs:120}),s.jsx(Mt,{delayMs:240})]})})]})}const ya=({children:t,className:e,onHeightChange:r,minHeight:o,style:a,...l})=>{const c=W.useRef(null);return W.useEffect(()=>{if(!r||!c.current)return;const d=c.current,f=()=>r(d.getBoundingClientRect().height);f();const u=new ResizeObserver(f);return u.observe(d),()=>u.disconnect()},[r]),s.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",children:s.jsx("div",{className:"w-full",children:s.jsx("form",{...l,className:Ct("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",e),style:{minHeight:o,...a},children:t})})})},ba=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],ds=2e3,va=({show:t,headerHeight:e,onHeightChange:r,draft:o,setDraft:a,textareaRef:l,noteLocalInputActivity:c,stopTyping:d,onSendText:f,onRequestScrollToBottom:u,isUploadingImage:b,cancelImageUpload:h,sendError:v,sendErrorMessage:p,canRetrySend:m,onRetrySend:x,uploadError:y,clearUploadError:R,showEmojiPicker:N,setShowEmojiPicker:k,openCameraPicker:E,fileInputRef:M,onImageSelected:j,onImageFile:w,disableSend:S})=>{const B=n.useCallback(I=>{const L=I.target.value,V=L.length>ds?L.slice(0,ds):L;a(V),N&&k(!1),c(V.trim().length>0);const X=I.target;X.style.height="auto";const Ne=Math.min(X.scrollHeight,140);X.style.height=`${Ne}px`},[c,a,k,N]),T=n.useCallback(I=>{I&&(a(L=>{const V=`${L}${I}`;return c(V.trim().length>0),V}),queueMicrotask(()=>{const L=l.current;L&&(L.style.height="auto",L.style.height=`${Math.min(L.scrollHeight,140)}px`)}))},[c,a,l]),P=n.useCallback(I=>{if(I.preventDefault(),S||b)return;const L=o.trim();L&&(a(""),d(),f(L))},[S,o,b,f,a,d]);if(!t)return null;const F=S||!o.trim()||b,G=b||S;return s.jsxs(ya,{onSubmit:P,className:"space-y-2",onHeightChange:r,minHeight:e,onDragOver:I=>{!w||S||(I.preventDefault(),I.dataTransfer.dropEffect="copy",I.currentTarget.dataset.dragging="true")},onDragLeave:I=>{I.currentTarget.dataset.dragging="false"},onDrop:I=>{if(!w||S||b)return;I.preventDefault(),I.currentTarget.dataset.dragging="false";const L=I.dataTransfer.files;if(!L||L.length===0)return;const V=Array.from(L).find(X=>X.type.startsWith("image/"));V&&w(V)},children:[b&&s.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[s.jsx(ce,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold text-foreground",children:"Uploading imageâ€¦"})]}),s.jsx(K,{type:"button",size:"sm",variant:"outline",onClick:h,children:"Cancel"})]}),v&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ce,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:p??"Couldn't send. Please try again."})]}),m&&s.jsx(K,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Retry"})]}),y&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(fr,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:y})]}),s.jsx(K,{type:"button",size:"sm",variant:"ghost",onClick:R,children:"Dismiss"})]}),s.jsxs("div",{className:"flex w-full items-center gap-2",children:[s.jsxs(Un,{open:N,onOpenChange:k,children:[s.jsx(qn,{asChild:!0,children:s.jsx(K,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:s.jsx(jr,{className:"h-4 w-4","aria-hidden":"true"})})}),s.jsx(Bn,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:s.jsx(Xn,{className:"max-h-64",children:s.jsx("div",{className:"grid grid-cols-9 gap-2",children:ba.map(I=>s.jsx(K,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{T(I),k(!1)},children:s.jsx("span",{children:I})},I))})})})]}),s.jsx(K,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:E,"aria-label":"Send photo",disabled:G,"aria-busy":b,children:s.jsx(br,{className:"h-4 w-4","aria-hidden":"true"})}),s.jsx("input",{type:"file",ref:M,accept:"image/*",className:"hidden",onChange:j}),s.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:s.jsx(Rs,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:B,onBlur:d,onPaste:I=>{if(!w||S||b)return;const L=I.clipboardData?.items;if(!L)return;const V=Array.from(L).find(Ne=>Ne.type.startsWith("image/"));if(!V)return;const X=V.getAsFile();X&&(I.preventDefault(),u?.(),w(X))},onKeyDown:I=>{if(I.key==="Enter"&&!I.shiftKey){if(S||F||!o.trim())return;I.preventDefault(),u?.(),I.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),s.jsx(K,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:I=>I.preventDefault(),disabled:F,"aria-label":"Send message","aria-busy":b,children:b?s.jsx(ce,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):s.jsx(wr,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},wa=({open:t,editingMessage:e,onOpenChange:r,onCancel:o,onTextChange:a,onSave:l,textareaRef:c,error:d,isSaving:f})=>s.jsx(kt,{open:t,onOpenChange:r,children:s.jsxs(It,{children:[s.jsxs(js,{children:[s.jsx(Et,{children:"Edit message"}),s.jsx(Ns,{children:"Update your message for everyone in the conversation."})]}),e&&s.jsx(Rs,{ref:c,value:e.text,onChange:u=>a(u.target.value),rows:3,className:"min-h-[120px]"}),d&&s.jsx("p",{className:"text-xs text-destructive",children:d}),s.jsxs(Cs,{className:"gap-2",children:[s.jsx(K,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),s.jsxs(K,{type:"button",disabled:!e?.text.trim()||f,onClick:l,children:[f&&s.jsx(ce,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Save"})]})]})]})}),Ma=({open:t,deleteDialog:e,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:a,isDeleting:l})=>s.jsx(kt,{open:t,onOpenChange:r,children:s.jsxs(It,{children:[s.jsxs(js,{className:"gap-1",children:[s.jsxs(Et,{className:"flex items-center gap-2 text-base",children:[s.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:s.jsx(Zn,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),s.jsx(Ns,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),s.jsxs(Cs,{className:"gap-2",children:[s.jsx(K,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!e,children:"Hide for me"}),s.jsxs(K,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!e,onClick:a,children:[l&&s.jsx(ce,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Delete for everyone"})]})]})]})}),Ra=({participant:t,onClick:e})=>{const r=(t.displayName??t.username??"?").slice(0,1).toUpperCase();return s.jsxs("button",{type:"button",onClick:e,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!e,children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:t.avatarUrl?s.jsx("img",{src:t.avatarUrl,alt:t.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:t.displayName}),s.jsx("p",{className:"truncate text-xs text-muted-foreground",children:t.username?`@${t.username}`:t.isSelf?"You":""})]}),e?s.jsx(z,{name:"chevron_right",className:"text-muted-foreground"}):null]})},ja=({open:t,onOpenChange:e,conversation:r,currentUserId:o,conversationId:a,isMuted:l,onToggleMute:c,otherParticipant:d,isGroupConversation:f,youBlocked:u,blockedYou:b,blockPending:h,onBlockToggle:v})=>{const p=ps(),m=n.useMemo(()=>r?.participants??[],[r?.participants]),x=!f&&!!d?.username&&!d?.isSelf,[y,R]=n.useState(null);n.useEffect(()=>{const M=r?.mutedUntil;if(!l||!M){R(null);return}const j=Date.parse(M);if(!Number.isFinite(j)||j<=Date.now()){R(null);return}try{R(new Date(j).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{R(null)}},[r?.mutedUntil,l]);const N=async()=>{const M=`${window.location.origin}/messages/${a}`;await cs(M)?H.show("Conversation link copied."):H.error("Couldn't copy to clipboard.")},k=async()=>{await cs(a)?H.show("Conversation ID copied."):H.error("Couldn't copy to clipboard.")},E=M=>{if(!M.username){H.show("This profile can't be opened yet.");return}e(!1),p(`/u/${M.username}`)};return s.jsx(kt,{open:t,onOpenChange:e,children:s.jsxs(It,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none sm:rounded-2xl sm:bottom-6 sm:rounded-b-2xl sm:translate-y-0",children:[s.jsxs("div",{className:"flex items-start justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx(Et,{className:"text-base",children:"Conversation info"}),s.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:f?`${m.length} participants`:d?.username?`@${d.username}`:"Direct message"})]}),s.jsx("button",{type:"button",onClick:()=>e(!1),className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted/60 hover:text-foreground","aria-label":"Close",children:s.jsx(z,{name:"close"})})]}),s.jsxs("div",{className:"grid gap-2",children:[s.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:N,children:[s.jsx(mr,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),s.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:k,children:[s.jsx(z,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),s.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),e(!1)},children:[s.jsx(lr,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),y?s.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",y]}):null]}),!f&&s.jsxs("div",{className:"mt-2 grid gap-2",children:[s.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!x||!d||E(d)},disabled:!x,children:[s.jsx(gr,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),s.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:v,disabled:h||b&&!u,children:[s.jsx(Ss,{className:"h-4 w-4","aria-hidden":!0}),u?"Unblock":b?"Blocked":"Block"]}),(b||u)&&s.jsx("p",{className:"text-xs text-muted-foreground",children:b&&!u?"This user has blocked you.":u?"You blocked this user.":null})]}),f&&s.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),s.jsx("div",{className:"grid gap-1",children:m.map(M=>s.jsx(Ra,{participant:M,onClick:M.username&&M.id!==o?()=>E(M):void 0},M.id))})]})]})})};function Na(){const[t,e]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{e(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),t}const Ca=2;function Sa(t){const{items:e,onJumpToItemIndex:r,minQueryLen:o=Ca}=t,[a,l]=n.useState(!1),[c,d]=n.useState(""),[f,u]=n.useState(0),b=c.trim().toLowerCase(),h=b.length>=o,v=n.useMemo(()=>{if(!h)return[];const j=[];for(let w=0;w<e.length;w++){const S=e[w];if(S.meta.deleted)continue;const B=fs(S.message.body);B&&B.toLowerCase().includes(b)&&j.push(w)}return j},[e,b,h]),p=n.useMemo(()=>{const j=new Set;for(const w of v){const S=e[w]?.message.id;S&&j.add(S)}return j},[e,v]),m=v.length;n.useEffect(()=>{u(0)},[b]),n.useEffect(()=>{m!==0&&(f<0&&u(0),f>m-1&&u(m-1))},[f,m]);const x=n.useCallback(j=>{if(m===0)return;const w=(j%m+m)%m;u(w);const S=v[w];typeof S=="number"&&r?.(S)},[m,v,r]),y=n.useCallback(()=>{x(f+1)},[f,x]),R=n.useCallback(()=>{x(f-1)},[f,x]),N=n.useCallback(()=>{x(0)},[x]),k=n.useCallback(()=>{d(""),u(0)},[]),E=n.useCallback(()=>{l(!1),d(""),u(0)},[]),M=n.useMemo(()=>{if(m===0)return null;const j=v[f];return e[j]?.message.id??null},[f,e,m,v]);return{query:c,setQuery:d,isOpen:a,setIsOpen:l,matchCount:m,activeMatchNumber:m===0?0:f+1,activeMatchIndex:m===0?-1:f,activeMessageId:M,isMatch:j=>p.has(j),jumpNext:y,jumpPrev:R,jumpToFirst:N,clear:k,close:E}}function ka(t,e){return ot({queryKey:hs(t),enabled:!!t&&e,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!t)return null;const{data:r,error:o}=await Q.rpc("assistant_reply_status_v1",{p_conversation_id:t});if(o){const a=(o.message??"").toLowerCase();if(a.includes("does not exist")||a.includes("function")||a.includes("schema"))return null;throw new Error(o.message)}return r??null}})}const Ia="movinesta",Ja=()=>{const{conversationId:t}=On(),e=t??null,r=ps(),{user:o}=at(),a=ee(),{data:l,isLoading:c}=Pn(),d=o?.id??null,f=cr(),u=n.useMemo(()=>!e||!l?null:l.find(i=>i.id===e)??null,[e,l]),b=u?.isMuted??!1,[h,v]=n.useState(!1),p=n.useCallback(()=>{if(!e)return;if(!d){H.error("Please sign in to manage messages.");return}const i=u?.isMuted??!1,g=u?.mutedUntil??null,C=u?.isHidden??!1;Me(a,d,e,D=>({...D,isMuted:!1,mutedUntil:null})),H.show("Unmuted notifications."),ls(d,e,{muted:!1,hidden:C,mutedUntil:null}).then(({ok:D})=>{D||(Me(a,d,e,A=>({...A,isMuted:i,mutedUntil:g})),H.error("Couldn't update preferences."))})},[e,d,u,a]),m=n.useCallback(i=>{if(!e)return;if(!d){H.error("Please sign in to manage messages.");return}const g=u?.isMuted??!1,C=u?.mutedUntil??null,D=u?.isHidden??!1;let A=!1,q=null;i.kind==="indefinite"?(A=!0,q=null):(A=!1,q=new Date(Date.now()+i.minutes*6e4).toISOString()),Me(a,d,e,le=>({...le,isMuted:!0,mutedUntil:q})),H.show(`Muted notifications for ${i.label}.`),ls(d,e,{muted:A,hidden:D,mutedUntil:q}).then(({ok:le})=>{le||(Me(a,d,e,wt=>({...wt,isMuted:g,mutedUntil:C})),H.error("Couldn't update preferences."))})},[e,d,u,a]),x=n.useCallback(()=>{if(b){p();return}v(!0)},[b,p]),y=da({currentUserId:o?.id??null}),{data:R,isLoading:N,isError:k,error:E,loadOlder:M,hasMore:j,isLoadingOlder:w,pollWhenRealtimeDown:S}=Or(e,{onInsert:y}),B=n.useRef(new Set);n.useEffect(()=>{if(!e||!R||R.length===0)return;const i=B.current,g=new Set(R.map(C=>C.id));for(const C of R)i.has(C.id)||y(C);B.current=g},[e,R,y]);const{draft:T,setDraft:P}=na({conversationId:e,hydrate:()=>{queueMicrotask(()=>{const i=Ie.current;i&&(i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,140)}px`)})}}),{sendError:F,lastFailedPayload:G,failedMessages:I,clearBannerState:L,onSendFailed:V,onSendRecovered:X,consumeLastFailedForRetry:Ne,consumeFailedMessageForRetry:At,discardFailedMessage:_t}=ua({conversationId:e,setDraft:i=>P(i),messages:R}),$=u?.isGroup??!1,{getStatus:Dt}=Fn(),O=n.useMemo(()=>{if(!u)return null;const i=u.participants.filter(g=>!g.isSelf);return i.length>0?i[0]:u.participants.length===1?u.participants[0]:null},[u]),Ce=n.useMemo(()=>$||!O?.id?null:Dt(O.id),[Dt,$,O?.id]),Lt=pr($?null:O?.id??null),Se=n.useMemo(()=>{const i=Lt.data??null,g=gs(i);return g?g==="Just now"?"now":g:null},[Lt.data]),te=n.useMemo(()=>{if(f?.conversationId&&e===f.conversationId)return!0;const i=O;return i?i.username?.toLowerCase()===Ia:!1},[f?.conversationId,e,O]),He=ka(e,te).data??null,[Ut,qt]=n.useState(!1),ue=W.useRef({inFlight:!1,queuedMessageId:null}),de=n.useRef(null),Ke=n.useRef(null);n.useEffect(()=>()=>{de.current&&(window.clearTimeout(de.current),de.current=null),Ke.current=null},[]);const[ut,be]=n.useState(null),Qe=n.useCallback(async i=>{if(!(!e||!d)){if(ue.current.inFlight){ue.current.queuedMessageId=i;return}ue.current.inFlight=!0,ue.current.queuedMessageId=null,qt(!0),be(null);try{const{data:g,error:C}=await Q.functions.invoke("assistant-chat-reply",{body:{conversationId:e,userMessageId:i}});if(C){const D=C?.context?.status??C?.status??null,A=String(C.message||"Assistant failed"),q=A.toLowerCase();D===429||q.includes("429")||q.includes("rate_limited")||q.includes("rate limit")||q.includes("too many requests")?H.show("Assistant queued â€” try again in a moment."):be({userMessageId:i,error:A})}else if(!g?.ok){const D=g?.code?String(g.code):"Assistant failed";D==="RATE_LIMITED"?H.show("Assistant queued â€” try again in a moment."):be({userMessageId:i,error:D})}}catch(g){be({userMessageId:i,error:g?.message||"Assistant failed"})}finally{qt(!1),a.invalidateQueries({queryKey:Re(e)}),a.invalidateQueries({queryKey:Rt(d)}),a.invalidateQueries({queryKey:hs(e)}),ue.current.inFlight=!1;const g=ue.current.queuedMessageId;ue.current.queuedMessageId=null,g&&g!==i&&Qe(g)}}},[e,d,a]),Bt=n.useCallback(i=>{!e||!d||te&&(Ke.current=i,de.current&&window.clearTimeout(de.current),de.current=window.setTimeout(()=>{const g=Ke.current;Ke.current=null,de.current=null,g&&Qe(g)},600))},[e,d,te,Qe]),Ts=n.useCallback(async(i,g)=>{if(e)try{const{data:C,error:D}=await Q.functions.invoke("assistant-message-action",{body:{conversationId:e,messageId:i,actionId:g}});if(D)throw new Error(D.message||"Action failed");if(!C?.ok)throw new Error(C?.error||"Action failed");const A=C?.toast;A&&H.success(A);const q=C?.navigateTo;q&&r(q)}catch(C){const D=C instanceof Error?C.message:String(C);H.error(D||"Action failed")}finally{e&&a.invalidateQueries({queryKey:Re(e)}),d&&a.invalidateQueries({queryKey:Rt(d)})}},[e,d,r,a]),ke=u?.title??O?.displayName??O?.username??"Conversation",Ot=er(e,{onFailed:V,onRecovered:X,otherUserId:$?null:O?.id??null}),ve=n.useCallback((i,g)=>{L(),Ot.mutate({text:i.text,attachmentPath:i.attachmentPath,clientId:i.clientId,tempId:g?.tempId},{onSuccess:async C=>{L(),te&&e&&d&&i.text.trim().length>0&&Bt(C.id)}})},[L,e,d,te,Bt,Ot]),Ie=n.useRef(null),dt=n.useRef(null),fe=n.useRef(!1),As=n.useMemo(()=>{const i=new Map;if(!u)return i;for(const g of u.participants)i.set(g.id,g);return i},[u]),{youBlocked:Ee,blockedYou:J,isBlocked:me,block:ze,unblock:Ve}=tr($?null:O?.id??null),{fileInputRef:_s,isUploadingImage:Ds,uploadError:Ls,cancelImageUpload:Us,clearUploadError:qs,handleImageSelected:Bs,sendImageFile:Os,openFilePicker:Ps}=sr({conversationId:e,userId:d,isBlocked:me,blockedYou:J,attemptSend:ve}),Te=!me&&!J,ft=!!O&&!$,Fs=ze.isPending||Ve.isPending,[$s,Pt]=n.useState(!1),Hs=n.useCallback(()=>{if(ft){if(Ee){Ve.mutate();return}J||ze.mutate()}},[ze,J,ft,Ve,Ee]),mt=ft?{label:Ee?"Unblock":J?"Blocked":"Block",onClick:()=>{Ee?Ve.mutate():J||ze.mutate()}}:null,{headerRef:Ks,headerHeight:Qs,composerHeight:zs,isAtBottom:ge,setIsAtBottom:se,handleComposerHeightChange:Ft,showEmojiPicker:Vs,setShowEmojiPicker:Je}=ra({showComposer:Te}),[Js,We]=n.useState(!1),$t=Te?Math.max(zs,0)+24:40,Ws=`${$t}px`,Ht=Math.max(80,$t+32),Gs=n.useMemo(()=>u?.participants.find(i=>i.isSelf)?.displayName??"You",[u]),{remoteTypingUsers:ne,noteLocalInputActivity:Ys,stopTyping:Xs}=sa({conversationId:e,userId:o?.id??null,displayName:Gs}),{data:Kt}=Yr(e);oa({conversationId:e,userId:o?.id??null,isAtBottom:ge===!0&&Js,messages:R});const{reactionsByMessageId:Zs,toggleReaction:Qt}=Gr(e),en=n.useCallback((i,g)=>{Qt.mutate({messageId:i,emoji:g})},[Qt]),re=n.useRef(null),gt=n.useRef(!1),pe=n.useRef(null),Ae=n.useRef(null),Ge=n.useRef(!1),we=n.useRef(!1),_e=n.useRef(!1),[zt,he]=n.useState(0),De=n.useRef(null),[ae,tn]=n.useState(null),Vt=n.useRef(new Map),sn=n.useCallback(i=>{De.current=i,tn(i)},[]),Le=n.useRef(!1),[Jt,Ye]=n.useState(!0),Wt=n.useRef(!0),Ue=Na();n.useEffect(()=>{Wt.current=Jt},[Jt]);const{activeActionMessageId:nn,openMessageActions:Gt,closeMessageActions:Xe,hiddenMessageIds:Yt,hideMessageForMe:rn,deleteDialog:xe,openDeleteDialog:an,closeDeleteDialog:pt,editingMessage:ye,openEditDialog:on,updateEditingText:ln,closeEditDialog:ht,editTextareaRef:cn,editError:un,setEditError:Xt}=aa({conversationId:e,currentUserId:d,showComposer:Te,isBlocked:me,blockedYou:J,composerTextareaRef:Ie}),Ze=$r({messages:R,currentUserId:d,hiddenMessageIds:Yt}),dn=n.useMemo(()=>Ze?[Ze]:[],[Ze]),{data:fn}=Xr(e,dn),Zt=la(e),es=ca(e),{visibleMessages:_}=Fr({messages:R,conversation:u,currentUserId:d,participantsById:As,reactionsByMessageId:Zs,hiddenMessageIds:Yt,deliveryReceipts:fn??[],readReceipts:Kt??[],failedMessages:I,lastOwnMessageId:Ze}),{firstUnreadIndex:qe,lastReadMessageId:oe,hasUnread:Be,isReady:xt}=fa({conversationId:e,userId:o?.id??null,conversation:u,readReceipts:Kt,visibleMessages:_}),ts=n.useMemo(()=>{if(!xt||!Be)return 0;let i=qe;if(i==null&&typeof oe=="string"&&oe){const g=_.findIndex(C=>C.message.id===oe);i=g>=0?g+1:null}return i==null?0:_.slice(i).filter(g=>!g.isSelf&&!g.meta.deleted).length},[qe,Be,oe,xt,_]),et=_.length>0,Oe=n.useRef(_),ss=n.useRef(j),Z=Ue?"auto":"smooth",Y=n.useCallback(i=>{const g=De.current;g&&(Le.current=!0,requestAnimationFrame(()=>{g.scrollTo({top:g.scrollHeight,behavior:i??Z}),requestAnimationFrame(()=>{Le.current=!1})}))},[Z]),ns=n.useCallback(()=>{Ge.current=!0,Ye(!0),se(!0),We(!0),Y("auto")},[Y,se]),Pe=n.useCallback((i,g)=>{const C=Vt.current.get(i);return C?(Le.current=!0,requestAnimationFrame(()=>{C.scrollIntoView({block:g?.align??"end",behavior:g?.behavior??Z}),requestAnimationFrame(()=>{Le.current=!1})}),!0):!1},[Z]);n.useEffect(()=>{Oe.current=_},[_]),n.useEffect(()=>{ss.current=j},[j]);const tt=n.useRef(null),mn=n.useCallback(()=>{const i=De.current;i&&(tt.current={active:!0,prevScrollHeight:i.scrollHeight,prevScrollTop:i.scrollTop,prevCount:Oe.current.length})},[]);W.useLayoutEffect(()=>{const i=tt.current,g=De.current;if(!i?.active||!g||_.length<=i.prevCount)return;const D=g.scrollHeight-i.prevScrollHeight;g.scrollTop=i.prevScrollTop+D,tt.current=null},[_.length]),n.useEffect(()=>{we.current=!1,pe.current=null,he(0)},[e]),n.useEffect(()=>{if(we.current||!et||!De.current)return;const i=_.length-1;i<0||(we.current=!0,requestAnimationFrame(()=>{Y("auto"),We(!0),se(!0),Ye(!0),pe.current=_[i]?.message.id??null,he(0)}))},[e,et,Y,ae,se,_]),n.useEffect(()=>{const i=Ae.current;if(!i)return;if(!_.some(D=>D.message.id===i)){Ae.current=null;return}Pe(i,{align:"end",behavior:"auto"})&&(Ae.current=null)},[Pe,_]);const st=_.length>0?_[_.length-1].message.id:null;n.useEffect(()=>{st&&Ge.current&&(Ge.current=!1,Y("auto"))},[st,Y]),n.useEffect(()=>{st&&we.current&&Wt.current&&(tt.current?.active||Ae.current||Y(Z))},[st,Z,Y]),n.useEffect(()=>{if(!ae)return;const i=()=>{const D=ae.scrollHeight-ae.scrollTop-ae.clientHeight<=Ht;Ye(A=>A===D?A:D),se(A=>A===D?A:D),We(!0)};i();const g=()=>{i(),Le.current||(we.current=!0,_e.current=!1)};return ae.addEventListener("scroll",g,{passive:!0}),()=>ae.removeEventListener("scroll",g)},[ae,Ht,se]),n.useEffect(()=>{const i=_.length?_[_.length-1]?.message.id??null:null;if(ge===!0){pe.current=i,he(0);return}if(!i)return;const g=pe.current;if(g===i)return;const C=g?_.findIndex(q=>q.message.id===g):-1;if(g&&C<0){pe.current=i,he(0);return}const A=_.slice(Math.max(0,C+1)).filter(q=>!q.isSelf).length;A<=0||he(A)},[ge,_]),n.useEffect(()=>()=>{re.current!=null&&window.clearTimeout(re.current)},[]);const gn=()=>{const i=Ne();i&&ve(i.payload,{tempId:i.tempId??void 0})},pn=i=>{re.current!=null&&window.clearTimeout(re.current),gt.current=!1,re.current=window.setTimeout(()=>{gt.current=!0,Gt(i)},500)},hn=()=>{re.current!=null&&(window.clearTimeout(re.current),re.current=null)},xn=n.useCallback(i=>{const g=At(i.id);g&&ve(g,{tempId:i.id})},[ve,At]),yn=n.useCallback(i=>{_t(i.id)},[_t]),bn=n.useCallback(i=>{if(i<0)return;const g=Oe.current[i]?.message.id??null;g&&Pe(g,{align:"center"})},[Pe]),U=Sa({items:_,onJumpToItemIndex:i=>{fe.current=!0,bn(i)}}),ie=U.query.trim().length>=2;n.useEffect(()=>{U.close()},[e,U.close]);const yt=()=>{Xe(),Je(!1),U.setIsOpen(!0),queueMicrotask(()=>dt.current?.focus())},Fe=()=>{U.close()};n.useEffect(()=>{const i=g=>{if(g.key==="Escape"){if(U.isOpen){g.preventDefault(),Fe();return}Xe(),Je(!1)}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Xe,Fe,U.isOpen,Je]),n.useEffect(()=>{fe.current=!1},[U.query]);const bt=n.useCallback(i=>{const g=_.length-1;if(g<0)return;const C=_[g]?.message.id??null;C&&(pe.current=C),he(0),Y(i??Z),window.setTimeout(()=>{Ie.current?.focus()},Ue?0:200)},[Z,Ue,_,Y]),vn=n.useCallback(i=>{Ft(i),ge===!0&&Y("auto")},[Ft,ge,Y]),vt=n.useCallback(async i=>{if(Be&&!_e.current){_e.current=!0;try{let g=qe;if(g==null&&typeof oe=="string"&&oe){let D=0;for(;ss.current&&D<8;){const A=Oe.current.findIndex(q=>q.message.id===oe);if(A>=0){g=A+1;break}await M(),D+=1}}if(g==null)return;const C=Oe.current[g]?.message.id??null;C&&Pe(C,{align:"start",behavior:i??Z}),window.setTimeout(()=>{Ie.current?.focus()},Ue?0:150)}finally{_e.current=!1}}},[qe,Be,xt,oe,M,Ue,Z]),wn=n.useCallback(i=>{if(!i.trim())return;L(),we.current=!0,_e.current=!1,Ge.current=!0;const g=nr(),C=rr();Ye(!0),se(!0),We(!0),Ae.current=g,ve({text:i.trim(),attachmentPath:null,clientId:C},{tempId:g})},[ve,L,se]);n.useEffect(()=>{pe.current=null,he(0)},[e]),n.useEffect(()=>{const i=g=>{if(g.key.toLowerCase()==="f"&&(g.metaKey||g.ctrlKey)){g.preventDefault(),yt();return}if(g.key==="End"||g.key==="ArrowDown"&&(g.metaKey||g.ctrlKey)||g.key==="End"&&(g.metaKey||g.ctrlKey)){g.preventDefault(),bt();return}g.key.toLowerCase()==="u"&&g.altKey&&(g.preventDefault(),vt())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[bt,vt,yt]);const Mn=n.useMemo(()=>{if(J)return"You are blocked";if(me)return"You blocked them";if(ne.length>0)return $?ne.length===1?`${ne[0].displayName??"Someone"} typingâ€¦`:`${ne.length} typingâ€¦`:"Typingâ€¦";if(!$&&Ce){if(Ce==="online")return"Online";if(Ce==="away")return"Active recently"}return!$&&Se?Se==="now"?"Online":`Active ${Se}`:u?.subtitle||($?"Group chat":"Direct message")},[J,me,$,Ce,Se,u?.subtitle,ne]),Rn=n.useMemo(()=>{const i=u?.participants??[],g=new Map(i.map(A=>[A.id,A])),C=[];for(const A of ne){const q=g.get(A.userId),le=q?.displayName??A.displayName??"Someone";C.push({id:A.userId,displayName:le,avatarUrl:q?.avatarUrl??null})}return te&&O?.id&&(Ut||He?.is_typing||He?.is_queued)&&(C.some(q=>q.id===O.id)||C.unshift({id:O.id,displayName:O.displayName??O.username??ke??"Assistant",avatarUrl:O.avatarUrl??null})),C},[Ut,He?.is_typing,He?.is_queued,u?.participants,ke,te,O,ne]);return e?s.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[s.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[s.jsxs("div",{ref:Ks,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[s.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("button",{type:"button",onClick:()=>r(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:s.jsx(z,{name:"arrow_back"})}),s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:O?.avatarUrl?s.jsx("img",{src:O.avatarUrl,alt:O.displayName??"Conversation",className:"h-full w-full object-cover"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(O?.displayName??ke).slice(0,2).toUpperCase()})}),!$&&(Ce==="online"||Se==="now")&&s.jsx("span",{className:Ct("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),s.jsxs("div",{className:"flex flex-col",children:[s.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:ke}),s.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:Mn})]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Search in conversation",onClick:()=>{U.isOpen?Fe():yt()},children:s.jsx(z,{name:"search"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",onClick:()=>H.show("Video calls are coming soon."),children:s.jsx(z,{name:"videocam"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",onClick:()=>Pt(!0),children:s.jsx(z,{name:"info"})}),mt?s.jsx("button",{type:"button",onClick:mt.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":mt.label,children:s.jsx(Ss,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),U.isOpen&&s.jsxs("div",{className:"px-4 pb-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:s.jsx(z,{name:"search",className:"text-muted-foreground"})}),s.jsx("input",{ref:dt,value:U.query,onChange:i=>U.setQuery(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(i.preventDefault(),!ie||U.matchCount===0)return;if(i.shiftKey){fe.current=!0,U.jumpPrev();return}if(!fe.current){U.jumpToFirst(),fe.current=!0;return}U.jumpNext()}i.key==="Escape"&&(i.preventDefault(),Fe())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary",autoComplete:"off",spellCheck:!1}),U.query.trim()&&s.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground transition hover:text-foreground","aria-label":"Clear search",onClick:()=>{U.clear(),queueMicrotask(()=>dt.current?.focus())},children:s.jsx(z,{name:"close"})})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Previous match",disabled:!ie||U.matchCount===0,onClick:()=>{fe.current=!0,U.jumpPrev()},children:s.jsx(z,{name:"keyboard_arrow_up"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Next match",disabled:!ie||U.matchCount===0,onClick:()=>{fe.current=!0,U.jumpNext()},children:s.jsx(z,{name:"keyboard_arrow_down"})}),s.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:ie?`${U.activeMatchNumber}/${U.matchCount}`:"0/0"}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Close search",onClick:Fe,children:s.jsx(z,{name:"close"})})]})]}),ie&&U.matchCount===0&&s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),s.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[s.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[S&&s.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:s.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[s.jsx(ce,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),s.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),s.jsx(ma,{items:_,isLoading:N&&!et,loadingContent:s.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[s.jsx(ce,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:k?s.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[s.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),E instanceof Error&&s.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:E.message})]}):void 0,emptyContent:et?void 0:s.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[s.jsx("p",{className:"font-medium text-foreground",children:$?"No messages in this group yet.":"No messages yet."}),s.jsx("p",{className:"mt-1",children:$?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:s.jsxs(s.Fragment,{children:[s.jsx(xa,{users:Rn}),s.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:j?s.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:w?s.jsxs("span",{className:"inline-flex items-center gap-2",children:[s.jsx(ce,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):s.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Ws,scrollerRef:sn,onStartReached:()=>{j&&!w&&(mn(),M())},computeItemKey:(i,g)=>g.message.id,itemContent:(i,g)=>{const{message:C,meta:D,sender:A,isSelf:q,deliveryStatus:le,reactions:wt,showDeliveryStatus:jn}=g,Nn=i>0?_[i-1]?.message??null:null,Cn=i<_.length-1?_[i+1]?.message??null:null,Sn=rs=>{const as=Vt.current;rs?as.set(C.id,rs):as.delete(C.id)};return s.jsx("div",{ref:Sn,"data-message-id":C.id,children:s.jsx(ar,{message:C,meta:D,sender:A,isSelf:q,deliveryStatus:le,showDeliveryStatus:jn,reactions:wt,index:i,previousMessage:Nn,nextMessage:Cn,firstUnreadIndex:qe,activeActionMessageId:nn,longPressTriggeredRef:gt,onOpenMessageActions:Gt,onCloseMessageActions:Xe,onOpenEditDialog:on,onOpenDeleteDialog:an,onToggleReaction:en,onRetryMessage:xn,onDiscardFailedMessage:yn,onAssistantAction:Ts,onBubbleTouchStart:pn,onBubbleTouchEndOrCancel:hn,searchQuery:ie?U.query:void 0,isSearchMatch:ie?U.isMatch(C.id):!1,isActiveSearchMatch:ie?U.activeMessageId===C.id:!1})})}}),s.jsx(pa,{show:!!(Be&&ts>0&&ge!==!0),unreadCount:ts,onClick:vt,shortcutHint:"Alt+U"}),s.jsx(ga,{show:ge!==!0&&zt>0,pendingCount:zt,onClick:bt,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),ut&&te&&Te&&s.jsx("div",{className:"px-4 pb-2",children:s.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(z,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),s.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:ut.error})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const i=ut.userMessageId;be(null),Qe(i)},children:[s.jsx(z,{name:"refresh",className:"text-base"}),"Retry"]}),s.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>be(null),children:"Dismiss"})]})]})}),s.jsx(va,{show:Te,headerHeight:Qs,onHeightChange:vn,typingUsers:ne,isGroupConversation:$,draft:T,setDraft:P,textareaRef:Ie,noteLocalInputActivity:Ys,stopTyping:Xs,onSendText:wn,onRequestScrollToBottom:ns,isUploadingImage:Ds,cancelImageUpload:Us,sendError:!!F,sendErrorMessage:F,canRetrySend:!!G,onRetrySend:gn,uploadError:Ls,clearUploadError:qs,showEmojiPicker:Vs,setShowEmojiPicker:Je,openCameraPicker:Ps,fileInputRef:_s,onImageSelected:i=>{ns(),Bs(i)},onImageFile:i=>Os(i),disableSend:!!(me||J)}),J&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You can't send messages because this user has blocked you."})}),me&&!J&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),s.jsx(wa,{open:!!ye,editingMessage:ye,onOpenChange:i=>{i||ht()},onCancel:ht,onTextChange:ln,textareaRef:cn,error:un,isSaving:Zt.isPending,onSave:()=>{if(!ye)return;const i=ye.text.trim();i&&(Xt(null),Zt.mutate({messageId:ye.messageId,text:i,currentBody:ye.body,attachmentUrl:ye.attachmentUrl},{onSuccess:()=>{ht()},onError:()=>{Xt("Couldn't save changes. Please try again.")}}))}}),s.jsx(Ma,{open:!!xe,deleteDialog:xe,onOpenChange:i=>{i||pt()},onHideForMe:()=>{xe&&(rn(xe.messageId),pt())},onDeleteForEveryone:()=>{xe&&es.mutate({messageId:xe.messageId,attachmentUrl:xe.attachmentUrl},{onSettled:()=>{pt()}})},isDeleting:es.isPending}),e&&s.jsx(ja,{open:$s,onOpenChange:Pt,conversation:u,currentUserId:d,conversationId:e,isMuted:b,onToggleMute:x,otherParticipant:O,isGroupConversation:$,youBlocked:Ee,blockedYou:J,blockPending:Fs,onBlockToggle:Hs}),e&&s.jsx(ur,{open:h,onOpenChange:v,conversationTitle:ke,onSelect:i=>m(i)})]}):s.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:s.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[s.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),s.jsx("p",{className:"mt-4",children:s.jsx($n,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Ja as default,er as useSendMessage};
