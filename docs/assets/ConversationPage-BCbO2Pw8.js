import{C as Fe,s as K,r as n,an as ve,e as ee,a7 as jn,ao as et,b as tt,ap as Rn,c as wt,w as Mt,aq as ss,ar as Nn,as as Cn,o as Sn,at as ns,n as kn,au as ls,av as In,aw as cs,ak as bt,N as us,ax as En,R as W,j as s,i as jt,E as ie,B as H,ay as Tn,az as An,aA as Dn,u as ds,al as z,I as _n,A as Ln,am as rs,K as Un,L as Bn}from"./index-B7GfpBhl.js";import{m as st,a as On,b as Pn,M as Rt,s as qn,i as fs,c as ms,d as gs,e as ps,f as Fn,n as $n,r as hs,g as xs,h as Hn,C as Kn,j as Qn,k as zn,S as Vn,T as Jn,l as as,u as Wn,o as Gn,p as Yn,q as Xn,t as Zn,v as er}from"./scroll-area-9dXfqrma.js";import{u as be}from"./conversationsCache-DlG040nl.js";import{w as tr,a as sr,B as nr,u as rr,M as ar}from"./useAssistantCache-BeAwzI2y.js";import{B as or}from"./bell-CFzcnMvJ.js";import{T as ys}from"./textarea-OwOqn-Q7.js";import{C as ir}from"./circle-alert-D02JIMpK.js";import{D as Nt,a as Ct,b as bs,c as St,d as vs,e as ws}from"./dialog-D8Sj3K8W.js";import{M as Q}from"./material-icon-kiLMn4z7.js";import{C as lr}from"./copy-8Rfl1Iqc.js";import{U as cr}from"./user-BJWLYjnO.js";import{u as ur}from"./useUserLastActive-xZN2feii.js";import"./format-BXv9LLlt.js";import"./plus-C9PUSvv4.js";import"./x-CDK8Axgg.js";import"./index-AQumCvZ4.js";import"./clock-BCLidhu6.js";const dr=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],fr=Fe("arrow-down",dr);const mr=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],gr=Fe("camera",mr);const pr=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],hr=Fe("send",pr);const xr=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Ms=Fe("shield-x",xr);const yr=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],br=Fe("smile",yr),vt=new Map,vr=t=>{const e=vt.get(t);if(e)return e;const r=K.channel(`conversation-db-${t}`),o={conversationId:t,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.messageInsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(a=>{const l=a;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),vt.set(t,o),o},wr=(t,e)=>{const r=vr(t);r.refCount+=1;const o=[];return e.onStatus&&(r.statusListeners.add(e.onStatus),o.push(()=>r.statusListeners.delete(e.onStatus)),r.lastStatus&&e.onStatus(r.lastStatus)),e.onMessageInsert&&(r.messageInsertListeners.add(e.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(e.onMessageInsert))),e.onMessageUpdate&&(r.messageUpdateListeners.add(e.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(e.onMessageUpdate))),e.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(e.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(e.onReadReceiptUpsert))),e.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(e.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(e.onDeliveryReceiptUpsert))),e.onReactionUpsert&&(r.reactionUpsertListeners.add(e.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(e.onReactionUpsert))),e.onReactionDelete&&(r.reactionDeleteListeners.add(e.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(e.onReactionDelete))),()=>{for(const a of o)a();if(r.refCount-=1,r.refCount<=0){try{K.removeChannel(r.channel)}catch{}vt.delete(t)}}},nt=(t,e,r)=>{n.useEffect(()=>{if(t)return wr(t,e())},[t,e,...r])},Mr=5e3,jr=1500,Rr=5e3,Nr=t=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?jr:Mr,refetchIntervalInBackground:!1}),Cr=new Set(["SUBSCRIBED"]),Sr=t=>!Cr.has(t),kr=t=>{const[e,r]=n.useState(!1),o=n.useRef(t);n.useEffect(()=>{Object.is(o.current,t)||(o.current=t,r(!1))},[t]);const a=n.useCallback(l=>{const c=Sr(l);r(d=>d===c?d:c)},[]);return{pollWhenRealtimeDown:e,onStatus:a}},rt=t=>{const{pollWhenRealtimeDown:e,onStatus:r}=kr(t);return{pollWhenRealtimeDown:e,onRealtimeStatus:r,refetchOptions:Nr(e)}},Ir=t=>typeof t=="object"&&t!==null,js=t=>t.new,Er=t=>t.old,we=(t,e)=>{if(!Ir(t))return null;const r=t[e];return typeof r=="string"?r:null},Rs=(t,e)=>we(t,"conversation_id")===e,Ns=40,Ze=1e5,Tr=t=>`"${t.replace(/"/g,'\\"')}"`,Ar=t=>{const e=Tr(t.createdAt),r=t.id;return`created_at.lt.${e},and(created_at.eq.${e},id.lt.${r})`},Dr=t=>{const e=qn((t??[]).map(st)),r=(t??[]).length>=Ns,o=e.length?{createdAt:e[0].createdAt,id:e[0].id}:null;return{items:e,hasMore:r,cursor:o}},_r=(t,e)=>{const r=n.useMemo(()=>ve(t),[t]),o=ee(),[a,l]=n.useState(Ze),{pollWhenRealtimeDown:c,onRealtimeStatus:d,refetchOptions:f}=rt(t),u=n.useRef(e);n.useEffect(()=>{u.current=e},[e]);const b=n.useRef({pages:0,total:0}),h=jn({queryKey:r,enabled:!!t,initialPageParam:null,...f,staleTime:Rr,queryFn:async({pageParam:x})=>{if(!t)return{items:[],hasMore:!1,cursor:null};let y=K.from("messages").select(Rt).eq("conversation_id",t).order("created_at",{ascending:!1}).order("id",{ascending:!1});x&&(y=y.or(Ar(x)));const{data:j,error:N}=await y.limit(Ns);if(N)throw console.error(`[useConversationMessages] Failed to load ${x?"older messages":"messages"}`,N),new Error(N.message);return Dr(j??[])},getNextPageParam:()=>{},getPreviousPageParam:x=>{if(x.hasMore)return x.cursor??void 0},structuralSharing:(x,y)=>Pn(x,y)});n.useEffect(()=>{const x=h.data?.pages??[],y=x.reduce((E,M)=>E+M.items.length,0),j=b.current;if(x.length===0){b.current={pages:0,total:0},l(Ze);return}if(j.pages===0){b.current={pages:x.length,total:y},l(Ze);return}const N=y-j.total,k=x.length-j.pages;N>0&&k>0&&l(E=>Math.max(0,E-N)),b.current={pages:x.length,total:y}},[h.data?.pages]);const v=n.useCallback(()=>{if(!t)return{};const x=(y,j)=>{const N=js(y);if(!Rs(N,t)||!we(N,"id"))return;const E=N,M=st(E);o.setQueryData(r,R=>On(R,E,{allowAppend:j==="insert"})),j==="insert"?u.current?.onInsert?.(M):u.current?.onUpdate?.(M)};return{onStatus:d,onMessageInsert:y=>{x(y,"insert")},onMessageUpdate:y=>{x(y,"update")}}},[t,d,o,r]);nt(t,v,[]),n.useEffect(()=>{l(Ze),b.current={pages:0,total:0}},[t]);const p=n.useMemo(()=>(h.data?.pages??[]).flatMap(y=>y.items),[h.data?.pages]),m=n.useCallback(async()=>{t&&h.hasPreviousPage&&await h.fetchPreviousPage()},[t,h]);return n.useMemo(()=>({data:p,dataUpdatedAt:h.dataUpdatedAt,isLoading:h.isLoading,isFetching:h.isFetching,isError:h.isError,error:h.error,refetch:h.refetch,loadOlder:m,hasMore:!!h.hasPreviousPage,isLoadingOlder:h.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:c}),[p,h.dataUpdatedAt,h.isLoading,h.isFetching,h.isError,h.error,h.refetch,m,h.hasPreviousPage,h.isFetchingPreviousPage,a,r,c])};function Lr(t){const{conversation:e,deliveryReceipts:r,readReceipts:o,currentUserId:a,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:d}=t;if(!e||!a)return()=>null;const f=e.participants.filter(p=>!p.isSelf);if(f.length===0)return()=>null;const u=new Set(f.map(p=>p.id)),b=p=>{if(!p)return null;const m=d?.get(p);return m??null},h=new Map;for(const p of o??[]){let m=null;if(p.lastReadMessageId){const j=b(p.lastReadMessageId);j!=null&&(m=j),j==null&&(m=null)}else if(p.lastReadAt){const j=new Date(p.lastReadAt).getTime();Number.isNaN(j)||(m=j)}if(m==null)continue;const x=(()=>{if(!p.lastReadAt)return null;const j=new Date(p.lastReadAt).getTime();return Number.isNaN(j)?null:j})(),y=h.get(p.userId);if(!y||m>y.upToMs){h.set(p.userId,{upToMs:m,readAtMs:x});continue}m===y.upToMs&&x!=null&&(y.readAtMs==null||x>y.readAtMs)&&h.set(p.userId,{upToMs:m,readAtMs:x})}const v=new Map;for(const p of r??[]){if(!u.has(p.userId)||c&&!c.has(p.messageId))continue;let m=v.get(p.messageId);m||(m=new Set,v.set(p.messageId,m)),m.add(p.userId)}return p=>{if(p.senderId!==a)return null;if(l[p.id])return{status:"failed"};if(fs(p.id))return{status:"sending"};const m=(()=>{const N=new Date(p.createdAt??"").getTime();return Number.isNaN(N)?0:N})();let x=0,y=null;for(const N of f){const k=h.get(N.id);if(k&&k.upToMs>=m){x+=1;const E=k.readAtMs??k.upToMs;(y===null||E>y)&&(y=E)}}return x===f.length&&f.length>0?{status:"seen",seenAt:y!=null?new Date(y).toISOString():null}:(v.get(p.id)?.size??0)===f.length&&f.length>0?{status:"delivered"}:{status:"sent"}}}function Ur(t){const{messages:e,conversation:r,currentUserId:o,participantsById:a,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:d,readReceipts:f,failedMessages:u,lastOwnMessageId:b}=t,h=n.useMemo(()=>{if(!e)return[];const p=new Set;b&&p.add(b);for(const y of Object.keys(u))p.add(y);const m=new Map;for(const y of e){const j=new Date(y.createdAt??"").getTime();Number.isNaN(j)||m.set(y.id,j)}const x=Lr({conversation:r??null,deliveryReceipts:d,readReceipts:f,currentUserId:o,failedMessages:u,onlyMessageIds:p,messageCreatedAtMsById:m});return e.map(y=>{const j=et(y.body),N=a.get(y.senderId)??null,k=N?.isSelf??(o!=null&&y.senderId===o),E=k&&p.has(y.id)?x(y):null,M=!!E&&k&&!j.deleted&&(E.status==="failed"||b===y.id);return{message:y,meta:j,sender:N,isSelf:k,deliveryStatus:E,showDeliveryStatus:M,reactions:l.get(y.id)??[]}})},[r,o,d,u,b,e,a,l,f]),v=n.useMemo(()=>h.filter(({message:p})=>!c[p.id]),[h,c]);return{uiMessages:h,visibleMessages:v}}function Br(t){const{messages:e,currentUserId:r,hiddenMessageIds:o}=t;return n.useMemo(()=>{if(!e||!r)return null;for(let a=e.length-1;a>=0;a-=1){const l=e[a];if(!(o[l.id]||l.senderId!==r||et(l.body).deleted))return l.id}return null},[o,e,r])}const Or=async t=>{const{data:e,error:r}=await K.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(e??[]).map(gs)},Pr=async(t,e)=>{if(e.length===0)return[];const r=K.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).in("message_id",e),{data:o,error:a}=await r.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(o??[]).map(ps)},qr=async t=>{const{data:e,error:r}=await K.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(e??[]).map(ms)},Fr=(t,e)=>{const r=new Map,o=new Map;for(const l of t){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let d=c.get(l.emoji);d||(d={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,d),o.get(l.messageId).push(l.emoji)),d.count+=1,e&&l.userId===e&&(d.reactedBySelf=!0)}const a=new Map;for(const[l,c]of r.entries()){const d=o.get(l)??[];a.set(l,d.map(f=>c.get(f)).filter(Boolean))}return a},$r=(t,e,r)=>{const o=t??[],a=r.key(e),l=[...o],c=l.findIndex(d=>r.key(d)===a);return c>=0?l[c]=e:l.push(e),r.sort&&l.sort(r.sort),l},Hr=(t,e,r)=>{const o=t??[];return o.length===0?[]:o.filter(a=>r.key(a)!==e)},kt=t=>e=>{const r=js(e);if(!Rs(r,t.conversationId)||t.extraGuard&&!t.extraGuard(r)||!(t.getRequiredId?t.getRequiredId(r):we(r,"id")))return;const a=r,l=t.mapRow(a);t.queryClient.setQueryData(t.queryKey,c=>$r(c,l,{key:t.key,sort:t.sort}))},Kr=t=>e=>{const r=Er(e),o=t.getRowId?t.getRowId(r):we(r,"id");if(!o){t.invalidateWhenMissingId!==!1&&t.queryClient.invalidateQueries({queryKey:t.queryKey});return}t.queryClient.setQueryData(t.queryKey,a=>Hr(a,o,{key:t.key}))},Qr=t=>{const{user:e}=tt(),r=e?.id??null,o=ee(),a=n.useMemo(()=>Rn(t),[t]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:d}=rt(t),f=wt({queryKey:a,enabled:!!t,...d,queryFn:()=>t?qr(t):Promise.resolve([])}),u=n.useCallback(()=>{if(!t)return{};const v=kt({conversationId:t,queryClient:o,queryKey:a,mapRow:ms,key:m=>m.id,sort:(m,x)=>{const y=ss(m.createdAt),j=ss(x.createdAt);return y!==j?y-j:m.id.localeCompare(x.id)}}),p=Kr({queryClient:o,queryKey:a,key:m=>m.id});return{onStatus:c,onReactionUpsert:v,onReactionDelete:p}},[t,c,o,a]);nt(t,u,[]);const b=Mt({mutationFn:async({messageId:v,emoji:p})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:m}=await K.from("message_reactions").insert({conversation_id:t,message_id:v,user_id:r,emoji:p});if(m){if(m?.code==="23505"){const{error:x}=await K.from("message_reactions").delete().eq("message_id",v).eq("user_id",r).eq("emoji",p);if(x)throw console.error("[useConversationReactions] Failed to remove reaction",x),x;return}throw console.error("[useConversationReactions] Failed to toggle reaction",m),m}},onMutate:async({messageId:v,emoji:p})=>{if(!t||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:a});const m=o.getQueryData(a);return o.setQueryData(a,x=>{const y=x??[],j=y.findIndex(k=>k.messageId===v&&k.userId===r&&k.emoji===p);if(j>=0){const k=[...y];return k.splice(j,1),k}const N={id:Fn(),conversationId:t,messageId:v,userId:r,emoji:p,createdAt:new Date().toISOString()};return[...y,N]}),{previousReactions:m}},onError:(v,p,m)=>{t&&(m?.previousReactions?o.setQueryData(a,m.previousReactions):o.invalidateQueries({queryKey:a}))},onSuccess:()=>{t&&o.invalidateQueries({queryKey:a})}}),h=n.useMemo(()=>{const v=f.data??[];return Fr(v,r)},[f.data,r]);return{reactions:f.data??[],reactionsByMessageId:h,isLoadingReactions:f.isLoading,toggleReaction:b,pollWhenRealtimeDown:l,queryKey:a}},zr=t=>{const e=ee(),r=n.useMemo(()=>Nn(t),[t]),{pollWhenRealtimeDown:o,onRealtimeStatus:a,refetchOptions:l}=rt(t),c=wt({queryKey:r,enabled:!!t,...l,queryFn:async()=>t?Or(t):[]}),d=n.useCallback(()=>{if(!t)return{};const f=kt({conversationId:t,queryClient:e,queryKey:r,mapRow:gs,key:u=>u.userId,getRequiredId:u=>we(u,"user_id"),sort:(u,b)=>{const h=!u.lastReadAt,v=!b.lastReadAt;if(h&&v)return 0;if(h)return 1;if(v)return-1;const p=new Date(u.lastReadAt).getTime(),m=new Date(b.lastReadAt).getTime();return Number.isNaN(p)&&Number.isNaN(m)?0:Number.isNaN(p)?1:Number.isNaN(m)?-1:m-p}});return{onStatus:a,onReadReceiptUpsert:f}},[t,a,e,r]);return nt(t,d,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},Vr=(t,e)=>{const r=ee(),o=n.useMemo(()=>$n(e,{excludeTemp:!0,sort:!0}),[e]),a=n.useMemo(()=>Cn(t,o),[t,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:d}=rt(t),f=wt({queryKey:a,enabled:!!(t&&o.length>0),...d,queryFn:async()=>t?o.length===0?[]:Pr(t,o):[]}),u=n.useCallback(()=>{if(!t)return{};if(o.length===0)return{};const h=new Set(o),v=kt({conversationId:t,queryClient:r,queryKey:a,mapRow:ps,key:p=>p.id,extraGuard:p=>{const m=we(p,"message_id");return!!(m&&h.has(m))},sort:(p,m)=>{const x=new Date(p.deliveredAt??"").getTime(),y=new Date(m.deliveredAt??"").getTime(),j=Number.isNaN(x)?0:x,N=Number.isNaN(y)?0:y;return j-N}});return{onStatus:c,onDeliveryReceiptUpsert:v}},[t,o,c,r,a]),b=t&&o.length>0?t:null;return nt(b,u,[]),n.useMemo(()=>({...f,pollWhenRealtimeDown:l,queryKey:a}),[f,l,a])},Jr=3e3,Wr=2e3,Gr=5e3,Yr=t=>{const{conversationId:e,userId:r,displayName:o}=t,[a,l]=n.useState({}),c=n.useRef(null),d=n.useRef(new Map),f=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),u=n.useCallback(async m=>{if(!e||!r||!o)return;const x=c.current;x&&await x.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:m}})},[e,r,o]),b=n.useCallback(async()=>{f.current.timeoutId!=null&&(window.clearTimeout(f.current.timeoutId),f.current.timeoutId=null),f.current.isTyping&&(f.current.isTyping=!1,f.current.lastSentAtMs=0,await u(!1))},[u]),h=n.useCallback(m=>{if(!e||!r||!o||!c.current)return;const y=f.current.isTyping;if(m){const j=Date.now();y?j-f.current.lastSentAtMs>Wr&&(f.current.lastSentAtMs=j,u(!0)):(f.current.isTyping=!0,f.current.lastSentAtMs=j,u(!0)),f.current.timeoutId!=null&&window.clearTimeout(f.current.timeoutId),f.current.timeoutId=window.setTimeout(()=>{f.current.isTyping=!1,f.current.lastSentAtMs=0,f.current.timeoutId=null,u(!1)},Jr);return}y&&b()},[u,e,o,b,r]),v=n.useCallback(()=>{l({}),d.current.forEach(m=>window.clearTimeout(m)),d.current.clear()},[]);return n.useEffect(()=>{if(!e)return;v();const m=K.channel(`supabase_realtime_typing:conversation:${e}`,{config:{broadcast:{self:!1}}});c.current=m,m.on("broadcast",{event:"typing"},({payload:j})=>{const N=j;if(!N?.userId||r&&N.userId===r)return;l(E=>{const M={...E};return N.isTyping&&N.displayName?M[N.userId]=N.displayName:delete M[N.userId],M});const k=d.current.get(N.userId);if(k!=null&&window.clearTimeout(k),N.isTyping){const E=window.setTimeout(()=>{l(M=>{const R={...M};return delete R[N.userId],R}),d.current.delete(N.userId)},Gr);d.current.set(N.userId,E)}else d.current.delete(N.userId)}).subscribe();const x=()=>{document.visibilityState==="hidden"&&b()},y=()=>{b()};return document.addEventListener("visibilitychange",x),window.addEventListener("beforeunload",y),window.addEventListener("pagehide",y),window.addEventListener("blur",y),()=>{document.removeEventListener("visibilitychange",x),window.removeEventListener("beforeunload",y),window.removeEventListener("pagehide",y),window.removeEventListener("blur",y),v(),b(),c.current&&(K.removeChannel(c.current),c.current=null)}},[e,b,r,v]),{remoteTypingUsers:n.useMemo(()=>Object.entries(a).map(([m,x])=>({userId:m,displayName:x})),[a]),noteLocalInputActivity:h,stopTyping:b}},Xr=t=>{const{conversationId:e,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:a=250}=t,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>e?`${r}${e}`:null,[e,r]),[d,f]=n.useState("");return n.useEffect(()=>{if(!c){f(""),l.current?.("");return}const h=Sn(c)??"";f(h),l.current?.(h)},[c]),n.useEffect(()=>{if(!c)return;const b=window.setTimeout(()=>{d.trim().length===0?ns(c):kn(c,d)},a);return()=>window.clearTimeout(b)},[c,a,d]),{draft:d,setDraft:f,clearDraft:()=>{c&&ns(c),f(""),l.current?.("")}}};function Zr({showComposer:t,initialHeaderHeight:e=72,initialComposerHeight:r=160}){const o=n.useRef(null),[a,l]=n.useState(e),[c,d]=n.useState(r),[f,u]=n.useState(null),[b,h]=n.useState(!1),v=n.useCallback(p=>d(Math.max(p,a)),[a]);return n.useEffect(()=>{const p=o.current;if(!p)return;const m=()=>l(Math.max(p.getBoundingClientRect().height,0));if(m(),typeof ResizeObserver>"u")return;const x=new ResizeObserver(m);return x.observe(p),()=>x.disconnect()},[]),n.useEffect(()=>{d(p=>Math.max(p,a))},[a]),n.useEffect(()=>{t||d(0)},[t]),{headerRef:o,headerHeight:a,composerHeight:c,isAtBottom:f,setIsAtBottom:u,handleComposerHeightChange:v,showEmojiPicker:b,setShowEmojiPicker:h}}const ea=({conversationId:t,currentUserId:e,showComposer:r,isBlocked:o,blockedYou:a,composerTextareaRef:l})=>{const[c,d]=n.useState(null),[f,u]=n.useState({}),[b,h]=n.useState(null),[v,p]=n.useState(null),[m,x]=n.useState(null),y=n.useRef(null),j=n.useRef(null);n.useEffect(()=>{if(!t||!e){u({});return}if(typeof window>"u")return;const T=`messages:hidden:${e}:${t}`;try{const P=window.localStorage.getItem(T);if(!P){u({});return}const q=JSON.parse(P);if(Array.isArray(q)){const G={};for(const I of q)typeof I=="string"&&I&&(G[I]=!0);u(G);return}if(q&&typeof q=="object"){const G={};for(const[I,_]of Object.entries(q))_&&(G[I]=!0);u(G);return}u({})}catch{u({})}},[t,e]),n.useEffect(()=>{if(!t||!e||typeof window>"u")return;const T=`messages:hidden:${e}:${t}`;try{const P=Object.keys(f).filter(q=>f[q]);window.localStorage.setItem(T,JSON.stringify(P))}catch{}},[t,e,f]);const N=n.useCallback(()=>{d(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const T=q=>{const G=q.target;if(!(G instanceof Element)){d(null);return}G.closest(`[data-message-action-scope="${c}"]`)||d(null)},P=q=>{q.key==="Escape"&&d(null)};return document.addEventListener("pointerdown",T,!0),document.addEventListener("keydown",P),()=>{document.removeEventListener("pointerdown",T,!0),document.removeEventListener("keydown",P)}},[c]);const k=n.useCallback(T=>{o||a||et(T.body).deleted||(d(T.id),l.current?.blur())},[a,l,o]),E=n.useCallback((T,P)=>{o||a||et(T.body).deleted||(P&&(j.current=P),p({messageId:T.id,text:ls(T.body)??"",body:T.body??null,attachmentUrl:T.attachmentUrl??null}),x(null),N(),l.current?.blur())},[a,N,l,o]),M=n.useCallback(T=>{p(P=>P&&{...P,text:T})},[]),R=n.useCallback(()=>{p(null),x(null),j.current?.focus()},[]);n.useEffect(()=>{v&&queueMicrotask(()=>{y.current?.focus()})},[v]);const w=n.useCallback(T=>{o||a||(N(),h({messageId:T.id,attachmentUrl:T.attachmentUrl??null}),l.current?.blur())},[a,N,l,o]),S=n.useCallback(()=>{h(null)},[]),B=n.useCallback(T=>{u(P=>({...P,[T]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(v||b||queueMicrotask(()=>l.current?.focus()))},[c,b,v,r,l]),{activeActionMessageId:c,openMessageActions:k,closeMessageActions:N,hiddenMessageIds:f,hideMessageForMe:B,deleteDialog:b,openDeleteDialog:w,closeDeleteDialog:S,editingMessage:v,openEditDialog:E,updateEditingText:M,closeEditDialog:R,editTextareaRef:y,editError:m,setEditError:x}},os=3e3;function ta(t){const{conversationId:e,userId:r,isAtBottom:o,messages:a}=t,l=ee(),c=n.useRef({conversationId:null,messageId:null,userId:null}),d=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const f=d.current;f.timeoutId!=null&&window.clearTimeout(f.timeoutId),f.timeoutId=null,f.pending=null,f.lastSentAt=0},[e,r]),n.useEffect(()=>()=>{const f=d.current;f.timeoutId!=null&&window.clearTimeout(f.timeoutId),f.timeoutId=null},[]),n.useEffect(()=>{if(!e||!a||a.length===0||!r||!o)return;const f=a[a.length-1];if(fs(f.id)||c.current.conversationId===e&&c.current.messageId===f.id&&c.current.userId===r)return;const u=d.current,b=Date.now(),h=u.lastSentAt?b-u.lastSentAt:Number.POSITIVE_INFINITY,v=()=>{be(l,r,e,m=>m.hasUnread?{...m,hasUnread:!1}:m)},p=m=>{u.lastSentAt=Date.now();const x=new Date().toISOString();tr({conversation_id:e,user_id:r,last_read_message_id:m,last_read_at:x}).then(()=>{c.current={conversationId:e,messageId:m,userId:r},v()}).catch(y=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",y)})};if(h<os){u.pending={conversationId:e,userId:r,messageId:f.id},u.timeoutId==null&&(u.timeoutId=window.setTimeout(()=>{const m=d.current.pending;d.current.pending=null,d.current.timeoutId=null,m&&(c.current.conversationId===m.conversationId&&c.current.messageId===m.messageId&&c.current.userId===m.userId||m.conversationId!==e||m.userId!==r||p(m.messageId))},Math.max(os-h,0)));return}u.timeoutId!=null&&(window.clearTimeout(u.timeoutId),u.timeoutId=null,u.pending=null),p(f.id)},[e,a,r,l,o])}const sa=new Set(["text","image","text+image","system"]),na=t=>{const{user:e}=tt(),r=e?.id??null,o=ee();return Mt({mutationFn:async({messageId:a,text:l,currentBody:c,attachmentUrl:d})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(d)throw new Error("Cannot edit messages with attachments.");const f=In(c,l),u=cs(f),b=sa.has(u.type)?u.type:"text",{data:h,error:v}=await K.from("messages").update({body:f,message_type:b,text:u.text.trim()?u.text:null,client_id:u.clientId??null,meta:u.meta??null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(Rt).single();if(v)throw console.error("[useEditMessage] Failed to edit message",v),new Error(v.message);return st(h)},onSuccess:a=>{if(!t)return;const l=ve(t);o.setQueryData(l,c=>hs(c,a))}})},ra=t=>{const{user:e}=tt(),r=e?.id??null,o=ee();return Mt({mutationFn:async({messageId:a,attachmentUrl:l})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const d={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},f=JSON.stringify(d),u=cs(f),{data:b,error:h}=await K.from("messages").update({body:f,message_type:"system",text:u.text.trim()?u.text:null,client_id:u.clientId??null,meta:u.meta??null,attachment_url:null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(Rt).single();if(h)throw console.error("[useDeleteMessage] Failed to delete message",h),new Error(h.message);if(l)try{await xs(l)}catch(p){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",p)}return st(b)},onSuccess:a=>{if(!t)return;const l=ve(t);o.setQueryData(l,c=>hs(c,a)),o.invalidateQueries({queryKey:bt(r)})}})};function aa(t){const{conversationId:e,setDraft:r,messages:o}=t,a=ee(),[l,c]=n.useState(null),[d,f]=n.useState(null),[u,b]=n.useState(null),[h,v]=n.useState({}),p=n.useRef({});n.useEffect(()=>{p.current=h},[h]);const m=n.useRef(e);n.useEffect(()=>{e!==m.current&&(m.current=e,c(null),f(null),b(null),v({}),p.current={})},[e]),n.useEffect(()=>()=>{const M=Object.values(p.current),R=Array.from(new Set(M.map(w=>w.attachmentPath).filter(w=>typeof w=="string"&&w.length>0&&!Hn(w))));R.length!==0&&K.storage.from(Kn).remove(R).then(({error:w})=>{w&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)}).catch(w=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)})},[e]),n.useEffect(()=>{o&&v(M=>{const R=new Set(o.map(B=>B.id));let w=!1;const S={...M};for(const B of Object.keys(S))R.has(B)||(delete S[B],w=!0);return w?S:M})},[o]);const x=n.useCallback(()=>{c(null),f(null),b(null)},[]),y=n.useCallback((M,R,w)=>{c(w.message||"Couldn't send. Please try again."),R.text.trim()&&r(R.text),f(R),b(M),v(S=>({...S,[M]:R}))},[r]),j=n.useCallback(M=>{M&&(v(R=>{if(!(M in R))return R;const w={...R};return delete w[M],w}),M===u&&x())},[x,u]),N=n.useCallback(()=>{if(!d)return null;const M=u;return M&&v(R=>{if(!(M in R))return R;const w={...R};return delete w[M],w}),x(),{payload:d,tempId:M}},[x,d,u]),k=n.useCallback(M=>{const R=h[M];return R?(v(w=>{if(!(M in w))return w;const S={...w};return delete S[M],S}),M===u?x():c(null),R):null},[x,h,u]),E=n.useCallback(async M=>{if(!e)return;const R=h[M];if(!R)return;const w=ve(e);if(a.setQueryData(w,S=>Qn(S,M)),v(S=>{if(!(M in S))return S;const B={...S};return delete B[M],B}),M===u&&x(),R.attachmentPath)try{await xs(R.attachmentPath)}catch(S){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",S)}},[x,e,h,u,a]);return{sendError:l,setSendError:c,lastFailedPayload:d,lastFailedTempId:u,failedMessages:h,clearBannerState:x,onSendFailed:y,onSendRecovered:j,consumeLastFailedForRetry:N,consumeFailedMessageForRetry:k,discardFailedMessage:E}}const oa=({currentUserId:t})=>{const e=ee();return n.useCallback(r=>{be(e,t,r.conversationId,o=>{const a=!!(t&&r.senderId===t);return{...o,lastMessagePreview:En(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:us(r.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),t&&r.senderId!==t&&sr({conversation_id:r.conversationId,message_id:r.id,user_id:t})},[t,e])},ia=({conversationId:t,userId:e,conversation:r,readReceipts:o,visibleMessages:a})=>{const[l,c]=n.useState(void 0),[d,f]=n.useState(void 0);return n.useEffect(()=>{c(void 0),f(void 0)},[t,e]),n.useEffect(()=>{if(!t||!e||l!==void 0)return;const b=(o??[]).find(h=>h.userId===e)??null;c(b?.lastReadMessageId??null)},[t,l,o,e]),n.useEffect(()=>{!t||!e||d===void 0&&r&&f(!!r.hasUnread)},[r,t,d,e]),{firstUnreadIndex:n.useMemo(()=>{if(d===void 0||!d||a.length===0||l===void 0)return null;if(l===null)return 0;const b=a.findIndex(v=>v.message.id===l);if(b<0)return 0;const h=b+1;return h>=a.length?null:h},[d,l,a]),lastReadMessageId:l,hasUnread:d??!1,isReady:d!==void 0&&l!==void 0}};function la(t){const{items:e=[],itemContent:r,isLoading:o,loadingContent:a,errorContent:l,emptyContent:c,header:d,footer:f,bottomPadding:u,scrollerRef:b,followOutput:h,onAtBottomChange:v,atBottomThreshold:p=80,onStartReached:m,computeItemKey:x,ariaLabel:y="Messages"}=t,j=W.useRef(null),N=W.useRef(!0),k=W.useRef(null),E=W.useRef(!1),M=W.useCallback(w=>{j.current=w,b&&(typeof b=="function"?b(w):b.current=w)},[b]),R=W.useCallback(w=>w.scrollHeight-w.scrollTop-w.clientHeight<=p,[p]);return W.useLayoutEffect(()=>{const w=j.current;if(!w)return;const S=T=>{N.current=T,k.current!==T&&(k.current=T,v?.(T))},B=()=>{const T=R(w);S(T),m&&(w.scrollTop<=24?E.current||(E.current=!0,m()):w.scrollTop>=80&&(E.current=!1))};return B(),w.addEventListener("scroll",B,{passive:!0}),()=>w.removeEventListener("scroll",B)},[R,v,m]),W.useEffect(()=>{const w=j.current;if(!w)return;const S=N.current,B=typeof h=="function"?h(S):h??!1;B&&S&&requestAnimationFrame(()=>{w.scrollTo({top:w.scrollHeight,behavior:B==="smooth"?"smooth":"auto"})})},[e.length]),o?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:a}):l?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):e.length?s.jsx("div",{className:"h-full w-full",children:s.jsx("div",{ref:M,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":y,style:{paddingBottom:u??void 0},children:s.jsxs("div",{className:"px-4 pt-3",children:[d,s.jsx("div",{className:"space-y-0",children:e.map((w,S)=>s.jsx(W.Fragment,{children:r(S,w)},x?x(S,w):S))}),f]})})}):s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const ca=({show:t,pendingCount:e,onClick:r,shortcutHint:o})=>{if(!t)return null;const a=e>1?`Jump to latest message. ${e} new messages`:"Jump to latest message";return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," new message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(fr,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Jump to latest"}),e>0&&s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})},ua=({show:t,unreadCount:e,onClick:r,shortcutHint:o})=>{if(!t||e<=0)return null;const a=e===1?"Jump to the first unread message":`Jump to first unread message. ${e} unread messages`;return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," unread message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(or,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Unread"}),s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})};function da(t){const e=t.trim().split(/\s+/).filter(Boolean);return e.length===0?"?":e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]??""}${e[1][0]??""}`.toUpperCase()}function yt({delayMs:t}){return s.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${t}ms`},"aria-hidden":"true"})}function fa({users:t,className:e}){if(!t.length)return null;const r=t.slice(0,3),o=Math.max(0,t.length-r.length);return s.jsxs("div",{className:jt("mt-1 flex w-full items-end gap-2 justify-start",e),role:"status","aria-live":"polite","aria-label":t.length===1?`${t[0].displayName} is typing`:"People are typing",children:[s.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(a=>s.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:a.displayName,children:a.avatarUrl?s.jsx("img",{src:a.avatarUrl,alt:a.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:da(a.displayName)})},a.id)),o>0&&s.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:s.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),s.jsx(zn,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(yt,{delayMs:0}),s.jsx(yt,{delayMs:120}),s.jsx(yt,{delayMs:240})]})})]})}const ma=({children:t,className:e,onHeightChange:r,minHeight:o,style:a,...l})=>{const c=W.useRef(null);return W.useEffect(()=>{if(!r||!c.current)return;const d=c.current,f=()=>r(d.getBoundingClientRect().height);f();const u=new ResizeObserver(f);return u.observe(d),()=>u.disconnect()},[r]),s.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",children:s.jsx("div",{className:"w-full",children:s.jsx("form",{...l,className:jt("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",e),style:{minHeight:o,...a},children:t})})})},ga=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],is=2e3,pa=({show:t,headerHeight:e,onHeightChange:r,draft:o,setDraft:a,textareaRef:l,noteLocalInputActivity:c,stopTyping:d,onSendText:f,onRequestScrollToBottom:u,isUploadingImage:b,cancelImageUpload:h,sendError:v,sendErrorMessage:p,canRetrySend:m,onRetrySend:x,uploadError:y,clearUploadError:j,showEmojiPicker:N,setShowEmojiPicker:k,openCameraPicker:E,fileInputRef:M,onImageSelected:R,onImageFile:w,disableSend:S})=>{const B=n.useCallback(I=>{const _=I.target.value,V=_.length>is?_.slice(0,is):_;a(V),N&&k(!1),c(V.trim().length>0);const X=I.target;X.style.height="auto";const Me=Math.min(X.scrollHeight,140);X.style.height=`${Me}px`},[c,a,k,N]),T=n.useCallback(I=>{I&&(a(_=>{const V=`${_}${I}`;return c(V.trim().length>0),V}),queueMicrotask(()=>{const _=l.current;_&&(_.style.height="auto",_.style.height=`${Math.min(_.scrollHeight,140)}px`)}))},[c,a,l]),P=n.useCallback(I=>{if(I.preventDefault(),S||b)return;const _=o.trim();_&&(a(""),d(),f(_))},[S,o,b,f,a,d]);if(!t)return null;const q=S||!o.trim()||b,G=b||S;return s.jsxs(ma,{onSubmit:P,className:"space-y-2",onHeightChange:r,minHeight:e,onDragOver:I=>{!w||S||(I.preventDefault(),I.dataTransfer.dropEffect="copy",I.currentTarget.dataset.dragging="true")},onDragLeave:I=>{I.currentTarget.dataset.dragging="false"},onDrop:I=>{if(!w||S||b)return;I.preventDefault(),I.currentTarget.dataset.dragging="false";const _=I.dataTransfer.files;if(!_||_.length===0)return;const V=Array.from(_).find(X=>X.type.startsWith("image/"));V&&w(V)},children:[b&&s.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[s.jsx(ie,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold text-foreground",children:"Uploading imageâ€¦"})]}),s.jsx(H,{type:"button",size:"sm",variant:"outline",onClick:h,children:"Cancel"})]}),v&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ie,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:p??"Couldn't send. Please try again."})]}),m&&s.jsx(H,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Retry"})]}),y&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ir,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:y})]}),s.jsx(H,{type:"button",size:"sm",variant:"ghost",onClick:j,children:"Dismiss"})]}),s.jsxs("div",{className:"flex w-full items-center gap-2",children:[s.jsxs(Tn,{open:N,onOpenChange:k,children:[s.jsx(An,{asChild:!0,children:s.jsx(H,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:s.jsx(br,{className:"h-4 w-4","aria-hidden":"true"})})}),s.jsx(Dn,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:s.jsx(Vn,{className:"max-h-64",children:s.jsx("div",{className:"grid grid-cols-9 gap-2",children:ga.map(I=>s.jsx(H,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{T(I),k(!1)},children:s.jsx("span",{children:I})},I))})})})]}),s.jsx(H,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:E,"aria-label":"Send photo",disabled:G,"aria-busy":b,children:s.jsx(gr,{className:"h-4 w-4","aria-hidden":"true"})}),s.jsx("input",{type:"file",ref:M,accept:"image/*",className:"hidden",onChange:R}),s.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:s.jsx(ys,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:B,onBlur:d,onPaste:I=>{if(!w||S||b)return;const _=I.clipboardData?.items;if(!_)return;const V=Array.from(_).find(Me=>Me.type.startsWith("image/"));if(!V)return;const X=V.getAsFile();X&&(I.preventDefault(),u?.(),w(X))},onKeyDown:I=>{if(I.key==="Enter"&&!I.shiftKey){if(S||q||!o.trim())return;I.preventDefault(),u?.(),I.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),s.jsx(H,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:I=>I.preventDefault(),disabled:q,"aria-label":"Send message","aria-busy":b,children:b?s.jsx(ie,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):s.jsx(hr,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},ha=({open:t,editingMessage:e,onOpenChange:r,onCancel:o,onTextChange:a,onSave:l,textareaRef:c,error:d,isSaving:f})=>s.jsx(Nt,{open:t,onOpenChange:r,children:s.jsxs(Ct,{children:[s.jsxs(bs,{children:[s.jsx(St,{children:"Edit message"}),s.jsx(vs,{children:"Update your message for everyone in the conversation."})]}),e&&s.jsx(ys,{ref:c,value:e.text,onChange:u=>a(u.target.value),rows:3,className:"min-h-[120px]"}),d&&s.jsx("p",{className:"text-xs text-destructive",children:d}),s.jsxs(ws,{className:"gap-2",children:[s.jsx(H,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),s.jsxs(H,{type:"button",disabled:!e?.text.trim()||f,onClick:l,children:[f&&s.jsx(ie,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Save"})]})]})]})}),xa=({open:t,deleteDialog:e,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:a,isDeleting:l})=>s.jsx(Nt,{open:t,onOpenChange:r,children:s.jsxs(Ct,{children:[s.jsxs(bs,{className:"gap-1",children:[s.jsxs(St,{className:"flex items-center gap-2 text-base",children:[s.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:s.jsx(Jn,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),s.jsx(vs,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),s.jsxs(ws,{className:"gap-2",children:[s.jsx(H,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!e,children:"Hide for me"}),s.jsxs(H,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!e,onClick:a,children:[l&&s.jsx(ie,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Delete for everyone"})]})]})]})}),ya=({participant:t,onClick:e})=>{const r=(t.displayName??t.username??"?").slice(0,1).toUpperCase();return s.jsxs("button",{type:"button",onClick:e,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!e,children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:t.avatarUrl?s.jsx("img",{src:t.avatarUrl,alt:t.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:t.displayName}),s.jsx("p",{className:"truncate text-xs text-muted-foreground",children:t.username?`@${t.username}`:t.isSelf?"You":""})]}),e?s.jsx(Q,{name:"chevron_right",className:"text-muted-foreground"}):null]})},ba=({open:t,onOpenChange:e,conversation:r,currentUserId:o,conversationId:a,isMuted:l,onToggleMute:c,otherParticipant:d,isGroupConversation:f,youBlocked:u,blockedYou:b,blockPending:h,onBlockToggle:v})=>{const p=ds(),m=n.useMemo(()=>r?.participants??[],[r?.participants]),x=!f&&!!d?.username&&!d?.isSelf,[y,j]=n.useState(null);n.useEffect(()=>{const M=r?.mutedUntil;if(!l||!M){j(null);return}const R=Date.parse(M);if(!Number.isFinite(R)||R<=Date.now()){j(null);return}try{j(new Date(R).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{j(null)}},[r?.mutedUntil,l]);const N=async()=>{const M=`${window.location.origin}/messages/${a}`;await as(M)?z.show("Conversation link copied."):z.error("Couldn't copy to clipboard.")},k=async()=>{await as(a)?z.show("Conversation ID copied."):z.error("Couldn't copy to clipboard.")},E=M=>{if(!M.username){z.show("This profile can't be opened yet.");return}e(!1),p(`/u/${M.username}`)};return s.jsx(Nt,{open:t,onOpenChange:e,children:s.jsxs(Ct,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none sm:rounded-2xl sm:bottom-6 sm:rounded-b-2xl sm:translate-y-0",children:[s.jsxs("div",{className:"flex items-start justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx(St,{className:"text-base",children:"Conversation info"}),s.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:f?`${m.length} participants`:d?.username?`@${d.username}`:"Direct message"})]}),s.jsx("button",{type:"button",onClick:()=>e(!1),className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted/60 hover:text-foreground","aria-label":"Close",children:s.jsx(Q,{name:"close"})})]}),s.jsxs("div",{className:"grid gap-2",children:[s.jsxs(H,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:N,children:[s.jsx(lr,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),s.jsxs(H,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:k,children:[s.jsx(Q,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),s.jsxs(H,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),e(!1)},children:[s.jsx(nr,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),y?s.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",y]}):null]}),!f&&s.jsxs("div",{className:"mt-2 grid gap-2",children:[s.jsxs(H,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!x||!d||E(d)},disabled:!x,children:[s.jsx(cr,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),s.jsxs(H,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:v,disabled:h||b&&!u,children:[s.jsx(Ms,{className:"h-4 w-4","aria-hidden":!0}),u?"Unblock":b?"Blocked":"Block"]}),(b||u)&&s.jsx("p",{className:"text-xs text-muted-foreground",children:b&&!u?"This user has blocked you.":u?"You blocked this user.":null})]}),f&&s.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),s.jsx("div",{className:"grid gap-1",children:m.map(M=>s.jsx(ya,{participant:M,onClick:M.username&&M.id!==o?()=>E(M):void 0},M.id))})]})]})})};function va(){const[t,e]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{e(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),t}const wa=2;function Ma(t){const{items:e,onJumpToItemIndex:r,minQueryLen:o=wa}=t,[a,l]=n.useState(!1),[c,d]=n.useState(""),[f,u]=n.useState(0),b=c.trim().toLowerCase(),h=b.length>=o,v=n.useMemo(()=>{if(!h)return[];const R=[];for(let w=0;w<e.length;w++){const S=e[w];if(S.meta.deleted)continue;const B=ls(S.message.body);B&&B.toLowerCase().includes(b)&&R.push(w)}return R},[e,b,h]),p=n.useMemo(()=>{const R=new Set;for(const w of v){const S=e[w]?.message.id;S&&R.add(S)}return R},[e,v]),m=v.length;n.useEffect(()=>{u(0)},[b]),n.useEffect(()=>{m!==0&&(f<0&&u(0),f>m-1&&u(m-1))},[f,m]);const x=n.useCallback(R=>{if(m===0)return;const w=(R%m+m)%m;u(w);const S=v[w];typeof S=="number"&&r?.(S)},[m,v,r]),y=n.useCallback(()=>{x(f+1)},[f,x]),j=n.useCallback(()=>{x(f-1)},[f,x]),N=n.useCallback(()=>{x(0)},[x]),k=n.useCallback(()=>{d(""),u(0)},[]),E=n.useCallback(()=>{l(!1),d(""),u(0)},[]),M=n.useMemo(()=>{if(m===0)return null;const R=v[f];return e[R]?.message.id??null},[f,e,m,v]);return{query:c,setQuery:d,isOpen:a,setIsOpen:l,matchCount:m,activeMatchNumber:m===0?0:f+1,activeMatchIndex:m===0?-1:f,activeMessageId:M,isMatch:R=>p.has(R),jumpNext:y,jumpPrev:j,jumpToFirst:N,clear:k,close:E}}const ja="movinesta",Fa=()=>{const{conversationId:t}=_n(),e=t??null,r=ds(),{user:o}=tt(),a=ee(),{data:l,isLoading:c}=Ln(),d=o?.id??null,f=rr(),u=n.useMemo(()=>!e||!l?null:l.find(i=>i.id===e)??null,[e,l]),b=u?.isMuted??!1,[h,v]=n.useState(!1),p=n.useCallback(()=>{if(!e)return;if(!d){z.error("Please sign in to manage messages.");return}const i=u?.isMuted??!1,g=u?.mutedUntil??null,C=u?.isHidden??!1;be(a,d,e,A=>({...A,isMuted:!1,mutedUntil:null})),z.show("Unmuted notifications."),rs(d,e,{muted:!1,hidden:C,mutedUntil:null}).then(({ok:A})=>{A||(be(a,d,e,U=>({...U,isMuted:i,mutedUntil:g})),z.error("Couldn't update preferences."))})},[e,d,u,a]),m=n.useCallback(i=>{if(!e)return;if(!d){z.error("Please sign in to manage messages.");return}const g=u?.isMuted??!1,C=u?.mutedUntil??null,A=u?.isHidden??!1;let U=!1,F=null;i.kind==="indefinite"?(U=!0,F=null):(U=!1,F=new Date(Date.now()+i.minutes*6e4).toISOString()),be(a,d,e,qe=>({...qe,isMuted:!0,mutedUntil:F})),z.show(`Muted notifications for ${i.label}.`),rs(d,e,{muted:U,hidden:A,mutedUntil:F}).then(({ok:qe})=>{qe||(be(a,d,e,xt=>({...xt,isMuted:g,mutedUntil:C})),z.error("Couldn't update preferences."))})},[e,d,u,a]),x=n.useCallback(()=>{if(b){p();return}v(!0)},[b,p]),y=oa({currentUserId:o?.id??null}),{data:j,isLoading:N,isError:k,error:E,loadOlder:M,hasMore:R,isLoadingOlder:w,pollWhenRealtimeDown:S}=_r(e,{onInsert:y}),B=n.useRef(new Set);n.useEffect(()=>{if(!e||!j||j.length===0)return;const i=B.current,g=new Set(j.map(C=>C.id));for(const C of j)i.has(C.id)||y(C);B.current=g},[e,j,y]);const{draft:T,setDraft:P}=Xr({conversationId:e,hydrate:()=>{queueMicrotask(()=>{const i=Se.current;i&&(i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,140)}px`)})}}),{sendError:q,lastFailedPayload:G,failedMessages:I,clearBannerState:_,onSendFailed:V,onSendRecovered:X,consumeLastFailedForRetry:Me,consumeFailedMessageForRetry:It,discardFailedMessage:Et}=aa({conversationId:e,setDraft:i=>P(i),messages:j}),$=u?.isGroup??!1,{getStatus:Tt}=Un(),O=n.useMemo(()=>{if(!u)return null;const i=u.participants.filter(g=>!g.isSelf);return i.length>0?i[0]:u.participants.length===1?u.participants[0]:null},[u]),je=n.useMemo(()=>$||!O?.id?null:Tt(O.id),[Tt,$,O?.id]),At=ur($?null:O?.id??null),Re=n.useMemo(()=>{const i=At.data??null,g=us(i);return g?g==="Just now"?"now":g:null},[At.data]),Ne=n.useMemo(()=>{if(f?.conversationId&&e===f.conversationId)return!0;const i=O;return i?i.username?.toLowerCase()===ja:!1},[f?.conversationId,e,O]),[Dt,_t]=n.useState(!1),le=W.useRef({inFlight:!1,queuedMessageId:null}),[at,he]=n.useState(null),ot=n.useCallback(async i=>{if(!(!e||!d)){if(le.current.inFlight){le.current.queuedMessageId=i;return}le.current.inFlight=!0,le.current.queuedMessageId=null,_t(!0),he(null);try{const{data:g,error:C}=await K.functions.invoke("assistant-chat-reply",{body:{conversationId:e,userMessageId:i}});C?he({userMessageId:i,error:C.message||"Assistant failed"}):g?.ok||he({userMessageId:i,error:g?.code?String(g.code):"Assistant failed"})}catch(g){he({userMessageId:i,error:g?.message||"Assistant failed"})}finally{_t(!1),a.invalidateQueries({queryKey:ve(e)}),a.invalidateQueries({queryKey:bt(d)}),le.current.inFlight=!1;const g=le.current.queuedMessageId;le.current.queuedMessageId=null,g&&g!==i&&ot(g)}}},[e,d,a]),Cs=n.useCallback(async(i,g)=>{if(e)try{const{data:C,error:A}=await K.functions.invoke("assistant-message-action",{body:{conversationId:e,messageId:i,actionId:g}});if(A)throw new Error(A.message||"Action failed");if(!C?.ok)throw new Error(C?.error||"Action failed");const U=C?.toast;U&&z.success(U);const F=C?.navigateTo;F&&r(F)}catch(C){const A=C instanceof Error?C.message:String(C);z.error(A||"Action failed")}finally{e&&a.invalidateQueries({queryKey:ve(e)}),d&&a.invalidateQueries({queryKey:bt(d)})}},[e,d,r,a]),Ce=u?.title??O?.displayName??O?.username??"Conversation",Lt=Wn(e,{onFailed:V,onRecovered:X,otherUserId:$?null:O?.id??null}),xe=n.useCallback((i,g)=>{_(),Lt.mutate({text:i.text,attachmentPath:i.attachmentPath,clientId:i.clientId,tempId:g?.tempId},{onSuccess:async C=>{_(),Ne&&e&&d&&i.text.trim().length>0&&ot(C.id)}})},[_,e,d,Ne,a,Lt]),Se=n.useRef(null),it=n.useRef(null),ce=n.useRef(!1),Ss=n.useMemo(()=>{const i=new Map;if(!u)return i;for(const g of u.participants)i.set(g.id,g);return i},[u]),{youBlocked:ke,blockedYou:J,isBlocked:ue,block:$e,unblock:He}=Gn($?null:O?.id??null),{fileInputRef:ks,isUploadingImage:Is,uploadError:Es,cancelImageUpload:Ts,clearUploadError:As,handleImageSelected:Ds,sendImageFile:_s,openFilePicker:Ls}=Yn({conversationId:e,userId:d,isBlocked:ue,blockedYou:J,attemptSend:xe}),Ie=!ue&&!J,lt=!!O&&!$,Us=$e.isPending||He.isPending,[Bs,Ut]=n.useState(!1),Os=n.useCallback(()=>{if(lt){if(ke){He.mutate();return}J||$e.mutate()}},[$e,J,lt,He,ke]),ct=lt?{label:ke?"Unblock":J?"Blocked":"Block",onClick:()=>{ke?He.mutate():J||$e.mutate()}}:null,{headerRef:Ps,headerHeight:qs,composerHeight:Fs,isAtBottom:de,setIsAtBottom:te,handleComposerHeightChange:Bt,showEmojiPicker:$s,setShowEmojiPicker:Ke}=Zr({showComposer:Ie}),[Hs,Qe]=n.useState(!1),Ot=Ie?Math.max(Fs,0)+24:40,Ks=`${Ot}px`,Pt=Math.max(80,Ot+32),Qs=n.useMemo(()=>u?.participants.find(i=>i.isSelf)?.displayName??"You",[u]),{remoteTypingUsers:se,noteLocalInputActivity:zs,stopTyping:Vs}=Yr({conversationId:e,userId:o?.id??null,displayName:Qs}),{data:qt}=zr(e);ta({conversationId:e,userId:o?.id??null,isAtBottom:de===!0&&Hs,messages:j});const{reactionsByMessageId:Js,toggleReaction:Ft}=Qr(e),Ws=n.useCallback((i,g)=>{Ft.mutate({messageId:i,emoji:g})},[Ft]),ne=n.useRef(null),ut=n.useRef(!1),fe=n.useRef(null),Ee=n.useRef(null),ze=n.useRef(!1),ye=n.useRef(!1),Te=n.useRef(!1),[$t,me]=n.useState(0),Ae=n.useRef(null),[re,Gs]=n.useState(null),Ht=n.useRef(new Map),Ys=n.useCallback(i=>{Ae.current=i,Gs(i)},[]),De=n.useRef(!1),[Kt,Ve]=n.useState(!0),Qt=n.useRef(!0),_e=va();n.useEffect(()=>{Qt.current=Kt},[Kt]);const{activeActionMessageId:Xs,openMessageActions:zt,closeMessageActions:Je,hiddenMessageIds:Vt,hideMessageForMe:Zs,deleteDialog:ge,openDeleteDialog:en,closeDeleteDialog:dt,editingMessage:pe,openEditDialog:tn,updateEditingText:sn,closeEditDialog:ft,editTextareaRef:nn,editError:rn,setEditError:Jt}=ea({conversationId:e,currentUserId:d,showComposer:Ie,isBlocked:ue,blockedYou:J,composerTextareaRef:Se}),We=Br({messages:j,currentUserId:d,hiddenMessageIds:Vt}),an=n.useMemo(()=>We?[We]:[],[We]),{data:on}=Vr(e,an),Wt=na(e),Gt=ra(e),{visibleMessages:D}=Ur({messages:j,conversation:u,currentUserId:d,participantsById:Ss,reactionsByMessageId:Js,hiddenMessageIds:Vt,deliveryReceipts:on??[],readReceipts:qt??[],failedMessages:I,lastOwnMessageId:We}),{firstUnreadIndex:Le,lastReadMessageId:ae,hasUnread:Ue,isReady:mt}=ia({conversationId:e,userId:o?.id??null,conversation:u,readReceipts:qt,visibleMessages:D}),Yt=n.useMemo(()=>{if(!mt||!Ue)return 0;let i=Le;if(i==null&&typeof ae=="string"&&ae){const g=D.findIndex(C=>C.message.id===ae);i=g>=0?g+1:null}return i==null?0:D.slice(i).filter(g=>!g.isSelf&&!g.meta.deleted).length},[Le,Ue,ae,mt,D]),Ge=D.length>0,Be=n.useRef(D),Xt=n.useRef(R),Z=_e?"auto":"smooth",Y=n.useCallback(i=>{const g=Ae.current;g&&(De.current=!0,requestAnimationFrame(()=>{g.scrollTo({top:g.scrollHeight,behavior:i??Z}),requestAnimationFrame(()=>{De.current=!1})}))},[Z]),Zt=n.useCallback(()=>{ze.current=!0,Ve(!0),te(!0),Qe(!0),Y("auto")},[Y,te]),Oe=n.useCallback((i,g)=>{const C=Ht.current.get(i);return C?(De.current=!0,requestAnimationFrame(()=>{C.scrollIntoView({block:g?.align??"end",behavior:g?.behavior??Z}),requestAnimationFrame(()=>{De.current=!1})}),!0):!1},[Z]);n.useEffect(()=>{Be.current=D},[D]),n.useEffect(()=>{Xt.current=R},[R]);const Ye=n.useRef(null),ln=n.useCallback(()=>{const i=Ae.current;i&&(Ye.current={active:!0,prevScrollHeight:i.scrollHeight,prevScrollTop:i.scrollTop,prevCount:Be.current.length})},[]);W.useLayoutEffect(()=>{const i=Ye.current,g=Ae.current;if(!i?.active||!g||D.length<=i.prevCount)return;const A=g.scrollHeight-i.prevScrollHeight;g.scrollTop=i.prevScrollTop+A,Ye.current=null},[D.length]),n.useEffect(()=>{ye.current=!1,fe.current=null,me(0)},[e]),n.useEffect(()=>{if(ye.current||!Ge||!Ae.current)return;const i=D.length-1;i<0||(ye.current=!0,requestAnimationFrame(()=>{Y("auto"),Qe(!0),te(!0),Ve(!0),fe.current=D[i]?.message.id??null,me(0)}))},[e,Ge,Y,re,te,D]),n.useEffect(()=>{const i=Ee.current;if(!i)return;if(!D.some(A=>A.message.id===i)){Ee.current=null;return}Oe(i,{align:"end",behavior:"auto"})&&(Ee.current=null)},[Oe,D]);const Xe=D.length>0?D[D.length-1].message.id:null;n.useEffect(()=>{Xe&&ze.current&&(ze.current=!1,Y("auto"))},[Xe,Y]),n.useEffect(()=>{Xe&&ye.current&&Qt.current&&(Ye.current?.active||Ee.current||Y(Z))},[Xe,Z,Y]),n.useEffect(()=>{if(!re)return;const i=()=>{const A=re.scrollHeight-re.scrollTop-re.clientHeight<=Pt;Ve(U=>U===A?U:A),te(U=>U===A?U:A),Qe(!0)};i();const g=()=>{i(),De.current||(ye.current=!0,Te.current=!1)};return re.addEventListener("scroll",g,{passive:!0}),()=>re.removeEventListener("scroll",g)},[re,Pt,te]),n.useEffect(()=>{const i=D.length?D[D.length-1]?.message.id??null:null;if(de===!0){fe.current=i,me(0);return}if(!i)return;const g=fe.current;if(g===i)return;const C=g?D.findIndex(F=>F.message.id===g):-1;if(g&&C<0){fe.current=i,me(0);return}const U=D.slice(Math.max(0,C+1)).filter(F=>!F.isSelf).length;U<=0||me(U)},[de,D]),n.useEffect(()=>()=>{ne.current!=null&&window.clearTimeout(ne.current)},[]);const cn=()=>{const i=Me();i&&xe(i.payload,{tempId:i.tempId??void 0})},un=i=>{ne.current!=null&&window.clearTimeout(ne.current),ut.current=!1,ne.current=window.setTimeout(()=>{ut.current=!0,zt(i)},500)},dn=()=>{ne.current!=null&&(window.clearTimeout(ne.current),ne.current=null)},fn=n.useCallback(i=>{const g=It(i.id);g&&xe(g,{tempId:i.id})},[xe,It]),mn=n.useCallback(i=>{Et(i.id)},[Et]),gn=n.useCallback(i=>{if(i<0)return;const g=Be.current[i]?.message.id??null;g&&Oe(g,{align:"center"})},[Oe]),L=Ma({items:D,onJumpToItemIndex:i=>{ce.current=!0,gn(i)}}),oe=L.query.trim().length>=2;n.useEffect(()=>{L.close()},[e,L.close]);const gt=()=>{Je(),Ke(!1),L.setIsOpen(!0),queueMicrotask(()=>it.current?.focus())},Pe=()=>{L.close()};n.useEffect(()=>{const i=g=>{if(g.key==="Escape"){if(L.isOpen){g.preventDefault(),Pe();return}Je(),Ke(!1)}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Je,Pe,L.isOpen,Ke]),n.useEffect(()=>{ce.current=!1},[L.query]);const pt=n.useCallback(i=>{const g=D.length-1;if(g<0)return;const C=D[g]?.message.id??null;C&&(fe.current=C),me(0),Y(i??Z),window.setTimeout(()=>{Se.current?.focus()},_e?0:200)},[Z,_e,D,Y]),pn=n.useCallback(i=>{Bt(i),de===!0&&Y("auto")},[Bt,de,Y]),ht=n.useCallback(async i=>{if(Ue&&!Te.current){Te.current=!0;try{let g=Le;if(g==null&&typeof ae=="string"&&ae){let A=0;for(;Xt.current&&A<8;){const U=Be.current.findIndex(F=>F.message.id===ae);if(U>=0){g=U+1;break}await M(),A+=1}}if(g==null)return;const C=Be.current[g]?.message.id??null;C&&Oe(C,{align:"start",behavior:i??Z}),window.setTimeout(()=>{Se.current?.focus()},_e?0:150)}finally{Te.current=!1}}},[Le,Ue,mt,ae,M,_e,Z]),hn=n.useCallback(i=>{if(!i.trim())return;_(),ye.current=!0,Te.current=!1,ze.current=!0;const g=Xn(),C=Zn();Ve(!0),te(!0),Qe(!0),Ee.current=g,xe({text:i.trim(),attachmentPath:null,clientId:C},{tempId:g})},[xe,_,te]);n.useEffect(()=>{fe.current=null,me(0)},[e]),n.useEffect(()=>{const i=g=>{if(g.key.toLowerCase()==="f"&&(g.metaKey||g.ctrlKey)){g.preventDefault(),gt();return}if(g.key==="End"||g.key==="ArrowDown"&&(g.metaKey||g.ctrlKey)||g.key==="End"&&(g.metaKey||g.ctrlKey)){g.preventDefault(),pt();return}g.key.toLowerCase()==="u"&&g.altKey&&(g.preventDefault(),ht())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[pt,ht,gt]);const xn=n.useMemo(()=>{if(J)return"You are blocked";if(ue)return"You blocked them";if(se.length>0)return $?se.length===1?`${se[0].displayName??"Someone"} typingâ€¦`:`${se.length} typingâ€¦`:"Typingâ€¦";if(!$&&je){if(je==="online")return"Online";if(je==="away")return"Active recently"}return!$&&Re?Re==="now"?"Online":`Active ${Re}`:u?.subtitle||($?"Group chat":"Direct message")},[J,ue,$,je,Re,u?.subtitle,se]),yn=n.useMemo(()=>{const i=u?.participants??[],g=new Map(i.map(A=>[A.id,A])),C=[];for(const A of se){const U=g.get(A.userId),F=U?.displayName??A.displayName??"Someone";C.push({id:A.userId,displayName:F,avatarUrl:U?.avatarUrl??null})}return Dt&&Ne&&O?.id&&(C.some(U=>U.id===O.id)||C.unshift({id:O.id,displayName:O.displayName??O.username??Ce??"Assistant",avatarUrl:O.avatarUrl??null})),C},[Dt,u?.participants,Ce,Ne,O,se]);return e?s.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[s.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[s.jsxs("div",{ref:Ps,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[s.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("button",{type:"button",onClick:()=>r(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:s.jsx(Q,{name:"arrow_back"})}),s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:O?.avatarUrl?s.jsx("img",{src:O.avatarUrl,alt:O.displayName??"Conversation",className:"h-full w-full object-cover"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(O?.displayName??Ce).slice(0,2).toUpperCase()})}),!$&&(je==="online"||Re==="now")&&s.jsx("span",{className:jt("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),s.jsxs("div",{className:"flex flex-col",children:[s.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:Ce}),s.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:xn})]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Search in conversation",onClick:()=>{L.isOpen?Pe():gt()},children:s.jsx(Q,{name:"search"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",onClick:()=>z.show("Video calls are coming soon."),children:s.jsx(Q,{name:"videocam"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",onClick:()=>Ut(!0),children:s.jsx(Q,{name:"info"})}),ct?s.jsx("button",{type:"button",onClick:ct.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":ct.label,children:s.jsx(Ms,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),L.isOpen&&s.jsxs("div",{className:"px-4 pb-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:s.jsx(Q,{name:"search",className:"text-muted-foreground"})}),s.jsx("input",{ref:it,value:L.query,onChange:i=>L.setQuery(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(i.preventDefault(),!oe||L.matchCount===0)return;if(i.shiftKey){ce.current=!0,L.jumpPrev();return}if(!ce.current){L.jumpToFirst(),ce.current=!0;return}L.jumpNext()}i.key==="Escape"&&(i.preventDefault(),Pe())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary",autoComplete:"off",spellCheck:!1}),L.query.trim()&&s.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground transition hover:text-foreground","aria-label":"Clear search",onClick:()=>{L.clear(),queueMicrotask(()=>it.current?.focus())},children:s.jsx(Q,{name:"close"})})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Previous match",disabled:!oe||L.matchCount===0,onClick:()=>{ce.current=!0,L.jumpPrev()},children:s.jsx(Q,{name:"keyboard_arrow_up"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Next match",disabled:!oe||L.matchCount===0,onClick:()=>{ce.current=!0,L.jumpNext()},children:s.jsx(Q,{name:"keyboard_arrow_down"})}),s.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:oe?`${L.activeMatchNumber}/${L.matchCount}`:"0/0"}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Close search",onClick:Pe,children:s.jsx(Q,{name:"close"})})]})]}),oe&&L.matchCount===0&&s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),s.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[s.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[S&&s.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:s.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[s.jsx(ie,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),s.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),s.jsx(la,{items:D,isLoading:N&&!Ge,loadingContent:s.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[s.jsx(ie,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:k?s.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[s.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),E instanceof Error&&s.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:E.message})]}):void 0,emptyContent:Ge?void 0:s.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[s.jsx("p",{className:"font-medium text-foreground",children:$?"No messages in this group yet.":"No messages yet."}),s.jsx("p",{className:"mt-1",children:$?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:s.jsxs(s.Fragment,{children:[s.jsx(fa,{users:yn}),s.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:R?s.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:w?s.jsxs("span",{className:"inline-flex items-center gap-2",children:[s.jsx(ie,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):s.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Ks,scrollerRef:Ys,onStartReached:()=>{R&&!w&&(ln(),M())},computeItemKey:(i,g)=>g.message.id,itemContent:(i,g)=>{const{message:C,meta:A,sender:U,isSelf:F,deliveryStatus:qe,reactions:xt,showDeliveryStatus:bn}=g,vn=i>0?D[i-1]?.message??null:null,wn=i<D.length-1?D[i+1]?.message??null:null,Mn=es=>{const ts=Ht.current;es?ts.set(C.id,es):ts.delete(C.id)};return s.jsx("div",{ref:Mn,"data-message-id":C.id,children:s.jsx(er,{message:C,meta:A,sender:U,isSelf:F,deliveryStatus:qe,showDeliveryStatus:bn,reactions:xt,index:i,previousMessage:vn,nextMessage:wn,firstUnreadIndex:Le,activeActionMessageId:Xs,longPressTriggeredRef:ut,onOpenMessageActions:zt,onCloseMessageActions:Je,onOpenEditDialog:tn,onOpenDeleteDialog:en,onToggleReaction:Ws,onRetryMessage:fn,onDiscardFailedMessage:mn,onAssistantAction:Cs,onBubbleTouchStart:un,onBubbleTouchEndOrCancel:dn,searchQuery:oe?L.query:void 0,isSearchMatch:oe?L.isMatch(C.id):!1,isActiveSearchMatch:oe?L.activeMessageId===C.id:!1})})}}),s.jsx(ua,{show:!!(Ue&&Yt>0&&de!==!0),unreadCount:Yt,onClick:ht,shortcutHint:"Alt+U"}),s.jsx(ca,{show:de!==!0&&$t>0,pendingCount:$t,onClick:pt,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),at&&Ne&&Ie&&s.jsx("div",{className:"px-4 pb-2",children:s.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(Q,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),s.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:at.error})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const i=at.userMessageId;he(null),ot(i)},children:[s.jsx(Q,{name:"refresh",className:"text-base"}),"Retry"]}),s.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>he(null),children:"Dismiss"})]})]})}),s.jsx(pa,{show:Ie,headerHeight:qs,onHeightChange:pn,typingUsers:se,isGroupConversation:$,draft:T,setDraft:P,textareaRef:Se,noteLocalInputActivity:zs,stopTyping:Vs,onSendText:hn,onRequestScrollToBottom:Zt,isUploadingImage:Is,cancelImageUpload:Ts,sendError:!!q,sendErrorMessage:q,canRetrySend:!!G,onRetrySend:cn,uploadError:Es,clearUploadError:As,showEmojiPicker:$s,setShowEmojiPicker:Ke,openCameraPicker:Ls,fileInputRef:ks,onImageSelected:i=>{Zt(),Ds(i)},onImageFile:i=>_s(i),disableSend:!!(ue||J)}),J&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You can't send messages because this user has blocked you."})}),ue&&!J&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),s.jsx(ha,{open:!!pe,editingMessage:pe,onOpenChange:i=>{i||ft()},onCancel:ft,onTextChange:sn,textareaRef:nn,error:rn,isSaving:Wt.isPending,onSave:()=>{if(!pe)return;const i=pe.text.trim();i&&(Jt(null),Wt.mutate({messageId:pe.messageId,text:i,currentBody:pe.body,attachmentUrl:pe.attachmentUrl},{onSuccess:()=>{ft()},onError:()=>{Jt("Couldn't save changes. Please try again.")}}))}}),s.jsx(xa,{open:!!ge,deleteDialog:ge,onOpenChange:i=>{i||dt()},onHideForMe:()=>{ge&&(Zs(ge.messageId),dt())},onDeleteForEveryone:()=>{ge&&Gt.mutate({messageId:ge.messageId,attachmentUrl:ge.attachmentUrl},{onSettled:()=>{dt()}})},isDeleting:Gt.isPending}),e&&s.jsx(ba,{open:Bs,onOpenChange:Ut,conversation:u,currentUserId:d,conversationId:e,isMuted:b,onToggleMute:x,otherParticipant:O,isGroupConversation:$,youBlocked:ke,blockedYou:J,blockPending:Us,onBlockToggle:Os}),e&&s.jsx(ar,{open:h,onOpenChange:v,conversationTitle:Ce,onSelect:i=>m(i)})]}):s.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:s.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[s.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),s.jsx("p",{className:"mt-4",children:s.jsx(Bn,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Fa as default,Wn as useSendMessage};
