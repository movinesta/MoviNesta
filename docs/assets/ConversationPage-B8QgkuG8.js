import{C as Xe,s as X,r as n,aq as Se,e as je,a8 as Er,ar as Nt,b as Qt,as as Tr,c as Jt,x as Rs,at as Xs,au as Ar,av as Lr,ak as Ss,o as _r,aw as Zs,n as Dr,ax as ln,ay as Ur,az as cn,an as Ns,O as un,aA as Or,R as Y,j as e,i as Cs,B as $,E as Ye,aB as en,aC as tn,aD as sn,u as dn,ao as G,aE as fn,J as Fr,A as Br,ap as nn,N as qr,L as Pr}from"./index-n01z0Q-I.js";import{m as Wt,a as mn,b as $r,M as ks,s as zr,i as pn,c as gn,d as hn,e as xn,f as Kr,n as Hr,r as yn,g as bn,h as Qr,C as Jr,j as Wr,k as Vr,F as jt,S as Gr,T as Yr,l as rn,u as Xr,o as Zr,p as ea,q as ta,t as sa,v as na}from"./scroll-area-C4ZR_b2m.js";import{u as Ue}from"./conversationsCache-D_XJbltN.js";import{w as ra,a as aa,B as ia,u as oa,M as la}from"./useAssistantCache-JffK51kj.js";import{B as ca}from"./bell-BqWz5DRv.js";import{T as wn}from"./textarea-YFcVWJTl.js";import{D as Vt,a as Gt,b as Is,c as Yt,f as ua,d as vn,e as jn}from"./dialog-xEYVlW9E.js";import{E as da}from"./ellipsis-nShW1yD5.js";import{X as bs}from"./x-CfKoriA-.js";import{C as an}from"./circle-alert-CmdS_X1p.js";import{M as re}from"./material-icon-ik9c9RPC.js";import{C as fa}from"./copy-gGjX7HRl.js";import{U as ma}from"./user-jb-u6yXp.js";import{u as pa}from"./useUserLastActive-BwMsZda-.js";import"./format-BXv9LLlt.js";import"./external-link-CU7gT4Sf.js";import"./plus-BLvVO9lE.js";import"./index-DNnSGIb8.js";import"./clock-DfxzXIbJ.js";const ga=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ha=Xe("arrow-down",ga);const xa=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],ws=Xe("camera",xa);const ya=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],ba=Xe("paperclip",ya);const wa=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],va=Xe("send",wa);const ja=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Nn=Xe("shield-x",ja);const Na=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Ma=Xe("smile",Na);const Ra=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],vs=Xe("volume-2",Ra),Ms=new Map,Sa=s=>{const t=Ms.get(s);if(t)return t;const r=X.channel(`conversation-db-${s}`),o={conversationId:s,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT")for(const c of o.messageInsertListeners)c(l);else if(l.eventType==="UPDATE")for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.reactionUpsertListeners)c(l);else if(l.eventType==="DELETE")for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(i=>{const l=i;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),Ms.set(s,o),o},Ca=(s,t)=>{const r=Sa(s);r.refCount+=1;const o=[];return t.onStatus&&(r.statusListeners.add(t.onStatus),o.push(()=>r.statusListeners.delete(t.onStatus)),r.lastStatus&&t.onStatus(r.lastStatus)),t.onMessageInsert&&(r.messageInsertListeners.add(t.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(r.messageUpdateListeners.add(t.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(r.reactionUpsertListeners.add(t.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(r.reactionDeleteListeners.add(t.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const i of o)i();if(r.refCount-=1,r.refCount<=0){try{X.removeChannel(r.channel)}catch{}Ms.delete(s)}}},Xt=(s,t,r)=>{n.useEffect(()=>{if(s)return Ca(s,t())},[s,t,...r])},ka=5e3,Ia=1500,Ea=5e3,Ta=s=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:s?Ia:ka,refetchIntervalInBackground:!1}),Aa=new Set(["SUBSCRIBED"]),La=s=>!Aa.has(s),_a=s=>{const[t,r]=n.useState(!1),o=n.useRef(s);n.useEffect(()=>{Object.is(o.current,s)||(o.current=s,r(!1))},[s]);const i=n.useCallback(l=>{const c=La(l);r(y=>y===c?y:c)},[]);return{pollWhenRealtimeDown:t,onStatus:i}},Zt=s=>{const{pollWhenRealtimeDown:t,onStatus:r}=_a(s);return{pollWhenRealtimeDown:t,onRealtimeStatus:r,refetchOptions:Ta(t)}},Da=s=>typeof s=="object"&&s!==null,Mn=s=>s.new,Ua=s=>s.old,rt=(s,t)=>{if(!Da(s))return null;const r=s[t];return typeof r=="string"?r:null},Rn=(s,t)=>rt(s,"conversation_id")===t,Sn=40,Ht=1e5,Oa=s=>`"${s.replace(/"/g,'\\"')}"`,Fa=s=>{const t=Oa(s.createdAt),r=s.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${r})`},Ba=s=>{const t=zr((s??[]).map(Wt)),r=(s??[]).length>=Sn,o=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:r,cursor:o}},qa=(s,t)=>{const r=n.useMemo(()=>Se(s),[s]),o=je(),[i,l]=n.useState(Ht),{pollWhenRealtimeDown:c,onRealtimeStatus:y,refetchOptions:m}=Zt(s),p=n.useRef(t);n.useEffect(()=>{p.current=t},[t]);const x=n.useRef({pages:0,total:0}),d=Er({queryKey:r,enabled:!!s,initialPageParam:null,...m,staleTime:Ea,queryFn:async({pageParam:w})=>{if(!s)return{items:[],hasMore:!1,cursor:null};let j=X.from("messages").select(ks).eq("conversation_id",s).order("created_at",{ascending:!1}).order("id",{ascending:!1});w&&(j=j.or(Fa(w)));const{data:v,error:I}=await j.limit(Sn);if(I)throw console.error(`[useConversationMessages] Failed to load ${w?"older messages":"messages"}`,I),new Error(I.message);return Ba(v??[])},getNextPageParam:()=>{},getPreviousPageParam:w=>{if(w.hasMore)return w.cursor??void 0},structuralSharing:(w,j)=>$r(w,j)});n.useEffect(()=>{const w=d.data?.pages??[],j=w.reduce((T,S)=>T+S.items.length,0),v=x.current;if(w.length===0){x.current={pages:0,total:0},l(Ht);return}if(v.pages===0){x.current={pages:w.length,total:j},l(Ht);return}const I=j-v.total,M=w.length-v.pages;I>0&&M>0&&l(T=>Math.max(0,T-I)),x.current={pages:w.length,total:j}},[d.data?.pages]);const b=n.useCallback(()=>{if(!s)return{};const w=(j,v)=>{const I=Mn(j);if(!Rn(I,s)||!rt(I,"id"))return;const T=I,S=Wt(T);o.setQueryData(r,N=>mn(N,T,{allowAppend:v==="insert"})),v==="insert"?p.current?.onInsert?.(S):p.current?.onUpdate?.(S)};return{onStatus:y,onMessageInsert:j=>{w(j,"insert")},onMessageUpdate:j=>{w(j,"update")}}},[s,y,o,r]);Xt(s,b,[]),n.useEffect(()=>{l(Ht),x.current={pages:0,total:0}},[s]);const h=n.useMemo(()=>(d.data?.pages??[]).flatMap(j=>j.items),[d.data?.pages]),f=n.useCallback(async()=>{s&&d.hasPreviousPage&&await d.fetchPreviousPage()},[s,d]);return n.useMemo(()=>({data:h,dataUpdatedAt:d.dataUpdatedAt,isLoading:d.isLoading,isFetching:d.isFetching,isError:d.isError,error:d.error,refetch:d.refetch,loadOlder:f,hasMore:!!d.hasPreviousPage,isLoadingOlder:d.isFetchingPreviousPage,firstItemIndex:i,queryKey:r,pollWhenRealtimeDown:c}),[h,d.dataUpdatedAt,d.isLoading,d.isFetching,d.isError,d.error,d.refetch,f,d.hasPreviousPage,d.isFetchingPreviousPage,i,r,c])};function Pa(s){const{conversation:t,deliveryReceipts:r,readReceipts:o,currentUserId:i,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:y}=s;if(!t||!i)return()=>null;const m=t.participants.filter(h=>!h.isSelf);if(m.length===0)return()=>null;const p=new Set(m.map(h=>h.id)),x=h=>{if(!h)return null;const f=y?.get(h);return f??null},d=new Map;for(const h of o??[]){let f=null;if(h.lastReadMessageId){const v=x(h.lastReadMessageId);v!=null&&(f=v),v==null&&(f=null)}else if(h.lastReadAt){const v=new Date(h.lastReadAt).getTime();Number.isNaN(v)||(f=v)}if(f==null)continue;const w=(()=>{if(!h.lastReadAt)return null;const v=new Date(h.lastReadAt).getTime();return Number.isNaN(v)?null:v})(),j=d.get(h.userId);if(!j||f>j.upToMs){d.set(h.userId,{upToMs:f,readAtMs:w});continue}f===j.upToMs&&w!=null&&(j.readAtMs==null||w>j.readAtMs)&&d.set(h.userId,{upToMs:f,readAtMs:w})}const b=new Map;for(const h of r??[]){if(!p.has(h.userId)||c&&!c.has(h.messageId))continue;let f=b.get(h.messageId);f||(f=new Set,b.set(h.messageId,f)),f.add(h.userId)}return h=>{if(h.senderId!==i)return null;if(l[h.id])return{status:"failed"};if(pn(h.id))return{status:"sending"};const f=(()=>{const I=new Date(h.createdAt??"").getTime();return Number.isNaN(I)?0:I})();let w=0,j=null;for(const I of m){const M=d.get(I.id);if(M&&M.upToMs>=f){w+=1;const T=M.readAtMs??M.upToMs;(j===null||T>j)&&(j=T)}}return w===m.length&&m.length>0?{status:"seen",seenAt:j!=null?new Date(j).toISOString():null}:(b.get(h.id)?.size??0)===m.length&&m.length>0?{status:"delivered"}:{status:"sent"}}}function $a(s){const{messages:t,conversation:r,currentUserId:o,participantsById:i,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:y,readReceipts:m,failedMessages:p,lastOwnMessageId:x}=s,d=n.useMemo(()=>{if(!t)return[];const h=new Set;x&&h.add(x);for(const j of Object.keys(p))h.add(j);const f=new Map;for(const j of t){const v=new Date(j.createdAt??"").getTime();Number.isNaN(v)||f.set(j.id,v)}const w=Pa({conversation:r??null,deliveryReceipts:y,readReceipts:m,currentUserId:o,failedMessages:p,onlyMessageIds:h,messageCreatedAtMsById:f});return t.map(j=>{const v=Nt(j.body),I=i.get(j.senderId)??null,M=I?.isSelf??(o!=null&&j.senderId===o),T=M&&h.has(j.id)?w(j):null,S=!!T&&M&&!v.deleted&&(T.status==="failed"||x===j.id);return{message:j,meta:v,sender:I,isSelf:M,deliveryStatus:T,showDeliveryStatus:S,reactions:l.get(j.id)??[]}})},[r,o,y,p,x,t,i,l,m]),b=n.useMemo(()=>d.filter(({message:h})=>!c[h.id]),[d,c]);return{uiMessages:d,visibleMessages:b}}function za(s){const{messages:t,currentUserId:r,hiddenMessageIds:o}=s;return n.useMemo(()=>{if(!t||!r)return null;for(let i=t.length-1;i>=0;i-=1){const l=t[i];if(!(o[l.id]||l.senderId!==r||Nt(l.body).deleted))return l.id}return null},[o,t,r])}const Ka=async s=>{const{data:t,error:r}=await X.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",s).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(t??[]).map(hn)},Ha=async(s,t)=>{if(t.length===0)return[];const r=X.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",s).in("message_id",t),{data:o,error:i}=await r.order("created_at",{ascending:!0}).returns();if(i)throw console.error("[useConversationDeliveryReceipts] Failed to load",i),new Error(i.message);return(o??[]).map(xn)},Qa=async s=>{const{data:t,error:r}=await X.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",s).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(t??[]).map(gn)},Ja=(s,t)=>{const r=new Map,o=new Map;for(const l of s){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let y=c.get(l.emoji);y||(y={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,y),o.get(l.messageId).push(l.emoji)),y.count+=1,t&&l.userId===t&&(y.reactedBySelf=!0)}const i=new Map;for(const[l,c]of r.entries()){const y=o.get(l)??[];i.set(l,y.map(m=>c.get(m)).filter(Boolean))}return i},Wa=(s,t,r)=>{const o=s??[],i=r.key(t),l=[...o],c=l.findIndex(y=>r.key(y)===i);return c>=0?l[c]=t:l.push(t),r.sort&&l.sort(r.sort),l},Va=(s,t,r)=>{const o=s??[];return o.length===0?[]:o.filter(i=>r.key(i)!==t)},Es=s=>t=>{const r=Mn(t);if(!Rn(r,s.conversationId)||s.extraGuard&&!s.extraGuard(r)||!(s.getRequiredId?s.getRequiredId(r):rt(r,"id")))return;const i=r,l=s.mapRow(i);s.queryClient.setQueryData(s.queryKey,c=>Wa(c,l,{key:s.key,sort:s.sort}))},Ga=s=>t=>{const r=Ua(t),o=s.getRowId?s.getRowId(r):rt(r,"id");if(!o){s.invalidateWhenMissingId!==!1&&s.queryClient.invalidateQueries({queryKey:s.queryKey});return}s.queryClient.setQueryData(s.queryKey,i=>Va(i,o,{key:s.key}))},Ya=s=>{const{user:t}=Qt(),r=t?.id??null,o=je(),i=n.useMemo(()=>Tr(s),[s]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Zt(s),m=Jt({queryKey:i,enabled:!!s,...y,queryFn:()=>s?Qa(s):Promise.resolve([])}),p=n.useCallback(()=>{if(!s)return{};const b=Es({conversationId:s,queryClient:o,queryKey:i,mapRow:gn,key:f=>f.id,sort:(f,w)=>{const j=Xs(f.createdAt),v=Xs(w.createdAt);return j!==v?j-v:f.id.localeCompare(w.id)}}),h=Ga({queryClient:o,queryKey:i,key:f=>f.id});return{onStatus:c,onReactionUpsert:b,onReactionDelete:h}},[s,c,o,i]);Xt(s,p,[]);const x=Rs({mutationFn:async({messageId:b,emoji:h})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:f}=await X.from("message_reactions").insert({conversation_id:s,message_id:b,user_id:r,emoji:h});if(f){if(f?.code==="23505"){const{error:w}=await X.from("message_reactions").delete().eq("message_id",b).eq("user_id",r).eq("emoji",h);if(w)throw console.error("[useConversationReactions] Failed to remove reaction",w),w;return}throw console.error("[useConversationReactions] Failed to toggle reaction",f),f}},onMutate:async({messageId:b,emoji:h})=>{if(!s||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:i});const f=o.getQueryData(i);return o.setQueryData(i,w=>{const j=w??[],v=j.findIndex(M=>M.messageId===b&&M.userId===r&&M.emoji===h);if(v>=0){const M=[...j];return M.splice(v,1),M}const I={id:Kr(),conversationId:s,messageId:b,userId:r,emoji:h,createdAt:new Date().toISOString()};return[...j,I]}),{previousReactions:f}},onError:(b,h,f)=>{s&&(f?.previousReactions?o.setQueryData(i,f.previousReactions):o.invalidateQueries({queryKey:i}))},onSuccess:()=>{s&&o.invalidateQueries({queryKey:i})}}),d=n.useMemo(()=>{const b=m.data??[];return Ja(b,r)},[m.data,r]);return{reactions:m.data??[],reactionsByMessageId:d,isLoadingReactions:m.isLoading,toggleReaction:x,pollWhenRealtimeDown:l,queryKey:i}},Xa=s=>{const t=je(),r=n.useMemo(()=>Ar(s),[s]),{pollWhenRealtimeDown:o,onRealtimeStatus:i,refetchOptions:l}=Zt(s),c=Jt({queryKey:r,enabled:!!s,...l,queryFn:async()=>s?Ka(s):[]}),y=n.useCallback(()=>{if(!s)return{};const m=Es({conversationId:s,queryClient:t,queryKey:r,mapRow:hn,key:p=>p.userId,getRequiredId:p=>rt(p,"user_id"),sort:(p,x)=>{const d=!p.lastReadAt,b=!x.lastReadAt;if(d&&b)return 0;if(d)return 1;if(b)return-1;const h=new Date(p.lastReadAt).getTime(),f=new Date(x.lastReadAt).getTime();return Number.isNaN(h)&&Number.isNaN(f)?0:Number.isNaN(h)?1:Number.isNaN(f)?-1:f-h}});return{onStatus:i,onReadReceiptUpsert:m}},[s,i,t,r]);return Xt(s,y,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},Za=(s,t)=>{const r=je(),o=n.useMemo(()=>Hr(t,{excludeTemp:!0,sort:!0}),[t]),i=n.useMemo(()=>Lr(s,o),[s,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Zt(s),m=Jt({queryKey:i,enabled:!!(s&&o.length>0),...y,queryFn:async()=>s?o.length===0?[]:Ha(s,o):[]}),p=n.useCallback(()=>{if(!s)return{};if(o.length===0)return{};const d=new Set(o),b=Es({conversationId:s,queryClient:r,queryKey:i,mapRow:xn,key:h=>h.id,extraGuard:h=>{const f=rt(h,"message_id");return!!(f&&d.has(f))},sort:(h,f)=>{const w=new Date(h.deliveredAt??"").getTime(),j=new Date(f.deliveredAt??"").getTime(),v=Number.isNaN(w)?0:w,I=Number.isNaN(j)?0:j;return v-I}});return{onStatus:c,onDeliveryReceiptUpsert:b}},[s,o,c,r,i]),x=s&&o.length>0?s:null;return Xt(x,p,[]),n.useMemo(()=>({...m,pollWhenRealtimeDown:l,queryKey:i}),[m,l,i])},ei=s=>{const{conversationId:t,userId:r,displayName:o}=s,{getNumber:i}=Ss(),l=i("ux.typing.inactivity_ms",3e3),c=i("ux.typing.heartbeat_ms",2e3),y=i("ux.typing.remote_ttl_ms",5e3),[m,p]=n.useState({}),x=n.useRef(null),d=n.useRef(new Map),b=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),h=n.useCallback(async I=>{if(!t||!r||!o)return;const M=x.current;M&&await M.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:I}})},[t,r,o]),f=n.useCallback(async()=>{b.current.timeoutId!=null&&(window.clearTimeout(b.current.timeoutId),b.current.timeoutId=null),b.current.isTyping&&(b.current.isTyping=!1,b.current.lastSentAtMs=0,await h(!1))},[h]),w=n.useCallback(I=>{if(!t||!r||!o||!x.current)return;const T=b.current.isTyping;if(I){const S=Date.now();T?S-b.current.lastSentAtMs>c&&(b.current.lastSentAtMs=S,h(!0)):(b.current.isTyping=!0,b.current.lastSentAtMs=S,h(!0)),b.current.timeoutId!=null&&window.clearTimeout(b.current.timeoutId),b.current.timeoutId=window.setTimeout(()=>{b.current.isTyping=!1,b.current.lastSentAtMs=0,b.current.timeoutId=null,h(!1)},l);return}T&&f()},[h,t,o,f,c,l,r]),j=n.useCallback(()=>{p({}),d.current.forEach(I=>window.clearTimeout(I)),d.current.clear()},[]);return n.useEffect(()=>{if(!t)return;j();const I=X.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});x.current=I,I.on("broadcast",{event:"typing"},({payload:S})=>{const N=S;if(!N?.userId||r&&N.userId===r)return;p(E=>{const F={...E};return N.isTyping&&N.displayName?F[N.userId]=N.displayName:delete F[N.userId],F});const R=d.current.get(N.userId);if(R!=null&&window.clearTimeout(R),N.isTyping){const E=window.setTimeout(()=>{p(F=>{const A={...F};return delete A[N.userId],A}),d.current.delete(N.userId)},y);d.current.set(N.userId,E)}else d.current.delete(N.userId)}).subscribe();const M=()=>{document.visibilityState==="hidden"&&f()},T=()=>{f()};return document.addEventListener("visibilitychange",M),window.addEventListener("beforeunload",T),window.addEventListener("pagehide",T),window.addEventListener("blur",T),()=>{document.removeEventListener("visibilitychange",M),window.removeEventListener("beforeunload",T),window.removeEventListener("pagehide",T),window.removeEventListener("blur",T),j(),f(),x.current&&(X.removeChannel(x.current),x.current=null)}},[t,f,r,j]),{remoteTypingUsers:n.useMemo(()=>Object.entries(m).map(([I,M])=>({userId:I,displayName:M})),[m]),noteLocalInputActivity:w,stopTyping:f}},ti=s=>{const{conversationId:t,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:i=250}=s,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>t?`${r}${t}`:null,[t,r]),[y,m]=n.useState("");return n.useEffect(()=>{if(!c){m(""),l.current?.("");return}const d=_r(c)??"";m(d),l.current?.(d)},[c]),n.useEffect(()=>{if(!c)return;const x=window.setTimeout(()=>{y.trim().length===0?Zs(c):Dr(c,y)},i);return()=>window.clearTimeout(x)},[c,i,y]),{draft:y,setDraft:m,clearDraft:()=>{c&&Zs(c),m(""),l.current?.("")}}};function si({showComposer:s,initialHeaderHeight:t=72,initialComposerHeight:r=160}){const o=n.useRef(null),[i,l]=n.useState(t),[c,y]=n.useState(r),[m,p]=n.useState(null),[x,d]=n.useState(!1),b=n.useCallback(h=>y(Math.max(h,i)),[i]);return n.useEffect(()=>{const h=o.current;if(!h)return;const f=()=>l(Math.max(h.getBoundingClientRect().height,0));if(f(),typeof ResizeObserver>"u")return;const w=new ResizeObserver(f);return w.observe(h),()=>w.disconnect()},[]),n.useEffect(()=>{y(h=>Math.max(h,i))},[i]),n.useEffect(()=>{s||y(0)},[s]),{headerRef:o,headerHeight:i,composerHeight:c,isAtBottom:m,setIsAtBottom:p,handleComposerHeightChange:b,showEmojiPicker:x,setShowEmojiPicker:d}}const ni=({conversationId:s,currentUserId:t,showComposer:r,isBlocked:o,blockedYou:i,composerTextareaRef:l})=>{const[c,y]=n.useState(null),[m,p]=n.useState({}),[x,d]=n.useState(null),[b,h]=n.useState(null),[f,w]=n.useState(null),j=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{if(!s||!t){p({});return}if(typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=window.localStorage.getItem(A);if(!U){p({});return}const z=JSON.parse(U);if(Array.isArray(z)){const K={};for(const le of z)typeof le=="string"&&le&&(K[le]=!0);p(K);return}if(z&&typeof z=="object"){const K={};for(const[le,Ne]of Object.entries(z))Ne&&(K[le]=!0);p(K);return}p({})}catch{p({})}},[s,t]),n.useEffect(()=>{if(!s||!t||typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=Object.keys(m).filter(z=>m[z]);window.localStorage.setItem(A,JSON.stringify(U))}catch{}},[s,t,m]);const I=n.useCallback(()=>{y(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const A=z=>{const K=z.target;if(!(K instanceof Element)){y(null);return}K.closest(`[data-message-action-scope="${c}"]`)||y(null)},U=z=>{z.key==="Escape"&&y(null)};return document.addEventListener("pointerdown",A,!0),document.addEventListener("keydown",U),()=>{document.removeEventListener("pointerdown",A,!0),document.removeEventListener("keydown",U)}},[c]);const M=n.useCallback(A=>{o||i||Nt(A.body).deleted||(y(A.id),l.current?.blur())},[i,l,o]),T=n.useCallback((A,U)=>{o||i||Nt(A.body).deleted||(U&&(v.current=U),h({messageId:A.id,text:ln(A.body)??"",body:A.body??null,attachmentUrl:A.attachmentUrl??null}),w(null),I(),l.current?.blur())},[i,I,l,o]),S=n.useCallback(A=>{h(U=>U&&{...U,text:A})},[]),N=n.useCallback(()=>{h(null),w(null),v.current?.focus()},[]);n.useEffect(()=>{b&&queueMicrotask(()=>{j.current?.focus()})},[b]);const R=n.useCallback(A=>{o||i||(I(),d({messageId:A.id,attachmentUrl:A.attachmentUrl??null}),l.current?.blur())},[i,I,l,o]),E=n.useCallback(()=>{d(null)},[]),F=n.useCallback(A=>{p(U=>({...U,[A]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(b||x||queueMicrotask(()=>l.current?.focus()))},[c,x,b,r,l]),{activeActionMessageId:c,openMessageActions:M,closeMessageActions:I,hiddenMessageIds:m,hideMessageForMe:F,deleteDialog:x,openDeleteDialog:R,closeDeleteDialog:E,editingMessage:b,openEditDialog:T,updateEditingText:S,closeEditDialog:N,editTextareaRef:j,editError:f,setEditError:w}},on=3e3;function ri(s){const{conversationId:t,userId:r,isAtBottom:o,messages:i}=s,l=je(),c=n.useRef({conversationId:null,messageId:null,userId:null}),y=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null,m.lastSentAt=0},[t,r]),n.useEffect(()=>()=>{const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null},[]),n.useEffect(()=>{if(!t||!i||i.length===0||!r||!o)return;const m=i[i.length-1];if(pn(m.id)||c.current.conversationId===t&&c.current.messageId===m.id&&c.current.userId===r)return;const p=y.current,x=Date.now(),d=p.lastSentAt?x-p.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{Ue(l,r,t,f=>f.hasUnread?{...f,hasUnread:!1}:f)},h=f=>{p.lastSentAt=Date.now();const w=new Date().toISOString();ra({conversation_id:t,user_id:r,last_read_message_id:f,last_read_at:w}).then(()=>{c.current={conversationId:t,messageId:f,userId:r},b()}).catch(j=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",j)})};if(d<on){p.pending={conversationId:t,userId:r,messageId:m.id},p.timeoutId==null&&(p.timeoutId=window.setTimeout(()=>{const f=y.current.pending;y.current.pending=null,y.current.timeoutId=null,f&&(c.current.conversationId===f.conversationId&&c.current.messageId===f.messageId&&c.current.userId===f.userId||f.conversationId!==t||f.userId!==r||h(f.messageId))},Math.max(on-d,0)));return}p.timeoutId!=null&&(window.clearTimeout(p.timeoutId),p.timeoutId=null,p.pending=null),h(m.id)},[t,i,r,l,o])}const ai=new Set(["text","image","text+image","system"]),ii=s=>{const{user:t}=Qt(),r=t?.id??null,o=je();return Rs({mutationFn:async({messageId:i,text:l,currentBody:c,attachmentUrl:y})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(y)throw new Error("Cannot edit messages with attachments.");const m=Ur(c,l),p=cn(m),x=ai.has(p.type)?p.type:"text",{data:d,error:b}=await X.from("messages").update({body:m,message_type:x,text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null}).eq("id",i).eq("conversation_id",s).eq("user_id",r).select(ks).single();if(b)throw console.error("[useEditMessage] Failed to edit message",b),new Error(b.message);return Wt(d)},onSuccess:i=>{if(!s)return;const l=Se(s);o.setQueryData(l,c=>yn(c,i))}})},oi=s=>{const{user:t}=Qt(),r=t?.id??null,o=je();return Rs({mutationFn:async({messageId:i,attachmentUrl:l})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const y={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},m=JSON.stringify(y),p=cn(m),{data:x,error:d}=await X.from("messages").update({body:m,message_type:"system",text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null,attachment_url:null}).eq("id",i).eq("conversation_id",s).eq("user_id",r).select(ks).single();if(d)throw console.error("[useDeleteMessage] Failed to delete message",d),new Error(d.message);if(l)try{await bn(l)}catch(h){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",h)}return Wt(x)},onSuccess:i=>{if(!s)return;const l=Se(s);o.setQueryData(l,c=>yn(c,i)),o.invalidateQueries({queryKey:Ns(r)})}})};function li(s){const{conversationId:t,setDraft:r,messages:o}=s,i=je(),[l,c]=n.useState(null),[y,m]=n.useState(null),[p,x]=n.useState(null),[d,b]=n.useState({}),h=n.useRef({});n.useEffect(()=>{h.current=d},[d]);const f=n.useRef(t);n.useEffect(()=>{t!==f.current&&(f.current=t,c(null),m(null),x(null),b({}),h.current={})},[t]),n.useEffect(()=>()=>{const S=Object.values(h.current),N=Array.from(new Set(S.map(R=>R.attachmentPath).filter(R=>typeof R=="string"&&R.length>0&&!Qr(R))));N.length!==0&&X.storage.from(Jr).remove(N).then(({error:R})=>{R&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)}).catch(R=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)})},[t]),n.useEffect(()=>{o&&b(S=>{const N=new Set(o.map(F=>F.id));let R=!1;const E={...S};for(const F of Object.keys(E))N.has(F)||(delete E[F],R=!0);return R?E:S})},[o]);const w=n.useCallback(()=>{c(null),m(null),x(null)},[]),j=n.useCallback((S,N,R)=>{c(R.message||"Couldn't send. Please try again."),N.text.trim()&&r(N.text),m(N),x(S),b(E=>({...E,[S]:N}))},[r]),v=n.useCallback(S=>{S&&(b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),S===p&&w())},[w,p]),I=n.useCallback(()=>{if(!y)return null;const S=p;return S&&b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),w(),{payload:y,tempId:S}},[w,y,p]),M=n.useCallback(S=>{const N=d[S];return N?(b(R=>{if(!(S in R))return R;const E={...R};return delete E[S],E}),S===p?w():c(null),N):null},[w,d,p]),T=n.useCallback(async S=>{if(!t)return;const N=d[S];if(!N)return;const R=Se(t);if(i.setQueryData(R,E=>Wr(E,S)),b(E=>{if(!(S in E))return E;const F={...E};return delete F[S],F}),S===p&&w(),N.attachmentPath)try{await bn(N.attachmentPath)}catch(E){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",E)}},[w,t,d,p,i]);return{sendError:l,setSendError:c,lastFailedPayload:y,lastFailedTempId:p,failedMessages:d,clearBannerState:w,onSendFailed:j,onSendRecovered:v,consumeLastFailedForRetry:I,consumeFailedMessageForRetry:M,discardFailedMessage:T}}const ci=({currentUserId:s})=>{const t=je();return n.useCallback(r=>{Ue(t,s,r.conversationId,o=>{const i=!!(s&&r.senderId===s);return{...o,lastMessagePreview:Or(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:un(r.createdAt??null),hasUnread:!i,lastMessageIsFromSelf:i,lastMessageSeenByOthers:i?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),s&&r.senderId!==s&&aa({conversation_id:r.conversationId,message_id:r.id,user_id:s})},[s,t])},ui=({conversationId:s,userId:t,conversation:r,readReceipts:o,visibleMessages:i})=>{const[l,c]=n.useState(void 0),[y,m]=n.useState(void 0);return n.useEffect(()=>{c(void 0),m(void 0)},[s,t]),n.useEffect(()=>{if(!s||!t||l!==void 0)return;const x=(o??[]).find(d=>d.userId===t)??null;c(x?.lastReadMessageId??null)},[s,l,o,t]),n.useEffect(()=>{!s||!t||y===void 0&&r&&m(!!r.hasUnread)},[r,s,y,t]),{firstUnreadIndex:n.useMemo(()=>{if(y===void 0||!y||i.length===0||l===void 0)return null;if(l===null)return 0;const x=i.findIndex(b=>b.message.id===l);if(x<0)return 0;const d=x+1;return d>=i.length?null:d},[y,l,i]),lastReadMessageId:l,hasUnread:y??!1,isReady:y!==void 0&&l!==void 0}};function di(s){const{items:t=[],itemContent:r,isLoading:o,loadingContent:i,errorContent:l,emptyContent:c,header:y,footer:m,bottomPadding:p,scrollerRef:x,followOutput:d,onAtBottomChange:b,atBottomThreshold:h=80,onStartReached:f,computeItemKey:w,ariaLabel:j="Messages"}=s,v=Y.useRef(null),I=Y.useRef(!0),M=Y.useRef(null),T=Y.useRef(!1),S=Y.useCallback(R=>{v.current=R,x&&(typeof x=="function"?x(R):x.current=R)},[x]),N=Y.useCallback(R=>R.scrollHeight-R.scrollTop-R.clientHeight<=h,[h]);return Y.useLayoutEffect(()=>{const R=v.current;if(!R)return;const E=A=>{I.current=A,M.current!==A&&(M.current=A,b?.(A))},F=()=>{const A=N(R);E(A),f&&(R.scrollTop<=24?T.current||(T.current=!0,f()):R.scrollTop>=80&&(T.current=!1))};return F(),R.addEventListener("scroll",F,{passive:!0}),()=>R.removeEventListener("scroll",F)},[N,b,f]),Y.useEffect(()=>{const R=v.current;if(!R)return;const E=I.current,F=typeof d=="function"?d(E):d??!1;F&&E&&requestAnimationFrame(()=>{R.scrollTo({top:R.scrollHeight,behavior:F==="smooth"?"smooth":"auto"})})},[t.length]),o?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:i}):l?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):t.length?e.jsx("div",{className:"h-full w-full",children:e.jsx("div",{ref:S,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":j,style:{paddingBottom:p??void 0},children:e.jsxs("div",{className:"page-pad pt-3",children:[y,e.jsx("div",{className:"space-y-0",children:t.map((R,E)=>e.jsx(Y.Fragment,{children:r(E,R)},w?w(E,R):E))}),m]})})}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const fi=({show:s,pendingCount:t,onClick:r,shortcutHint:o})=>{if(!s)return null;const i=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":i,title:o?`${i} (${o})`:i,children:[e.jsx(ha,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Jump to latest"}),t>0&&e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},mi=({show:s,unreadCount:t,onClick:r,shortcutHint:o})=>{if(!s||t<=0)return null;const i=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":i,title:o?`${i} (${o})`:i,children:[e.jsx(ca,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Unread"}),e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})};function pi(s){const t=s.trim().split(/\s+/).filter(Boolean);return t.length===0?"?":t.length===1?t[0].slice(0,2).toUpperCase():`${t[0][0]??""}${t[1][0]??""}`.toUpperCase()}function js({delayMs:s}){return e.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${s}ms`},"aria-hidden":"true"})}function gi({users:s,className:t}){if(!s.length)return null;const r=s.slice(0,3),o=Math.max(0,s.length-r.length);return e.jsxs("div",{className:Cs("mt-1 flex w-full items-end gap-2 justify-start",t),role:"status","aria-live":"polite","aria-label":s.length===1?`${s[0].displayName} is typing`:"People are typing",children:[e.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(i=>e.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:i.displayName,children:i.avatarUrl?e.jsx("img",{src:i.avatarUrl,alt:i.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:pi(i.displayName)})},i.id)),o>0&&e.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),e.jsx(Vr,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(js,{delayMs:0}),e.jsx(js,{delayMs:120}),e.jsx(js,{delayMs:240})]})})]})}const hi=({children:s,className:t,onHeightChange:r,minHeight:o,style:i,...l})=>{const c=Y.useRef(null),[y,m]=Y.useState(0);return Y.useEffect(()=>{if(!r||!c.current)return;const p=c.current,x=()=>r(p.getBoundingClientRect().height);x();const d=new ResizeObserver(x);return d.observe(p),()=>d.disconnect()},[r]),Y.useLayoutEffect(()=>{if(typeof window>"u")return;const p=window.visualViewport;if(!p){m(0);return}const x=()=>{const d=Math.max(0,window.innerHeight-p.height-p.offsetTop);m(d)};return x(),p.addEventListener("resize",x),p.addEventListener("scroll",x),window.addEventListener("orientationchange",x),()=>{p.removeEventListener("resize",x),p.removeEventListener("scroll",x),window.removeEventListener("orientationchange",x)}},[]),e.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",style:{transform:`translateY(-${y}px)`},children:e.jsx("div",{className:"w-full",children:e.jsx("form",{...l,className:Cs("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-2.5 md:p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",t),style:{minHeight:o,...i},children:s})})})},xi=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Cn="movinesta_recent_files_v1",Ts=6,yi=s=>{if(!Number.isFinite(s)||s<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,o=s;for(;o>=1024&&r<t.length-1;)o/=1024,r+=1;const i=r==0||r==1?0:1;return`${o.toFixed(i)} ${t[r]}`},bi=(s,t)=>{const r=(s.split(".").pop()??"").toUpperCase();return r||(t?.startsWith("image/")?"IMG":t?.startsWith("audio/")?"AUDIO":"FILE")},wi=s=>s?.startsWith("image/")?"image":s?.startsWith("audio/")?"audio":"file",vi=()=>{try{const s=localStorage.getItem(Cn);if(!s)return[];const t=JSON.parse(s);return Array.isArray(t)?t.filter(r=>r&&typeof r=="object").map(r=>({id:String(r?.id??""),name:String(r?.name??"File"),size:Number(r?.size??0),sizeLabel:String(r?.sizeLabel??"0 B"),badge:String(r?.badge??"FILE"),mime:String(r?.mime??""),kind:["image","audio","file"].includes(r?.kind)?r.kind:"file",lastUsed:Number(r?.lastUsed??0)})).filter(r=>r.id&&r.name).slice(0,Ts):[]}catch{return[]}},ji=s=>{try{const t=s.map(r=>{const{previewUrl:o,...i}=r;return i});localStorage.setItem(Cn,JSON.stringify(t.slice(0,Ts)))}catch{}},Ni=({show:s,headerHeight:t,onHeightChange:r,draft:o,setDraft:i,textareaRef:l,noteLocalInputActivity:c,stopTyping:y,onSendText:m,onRequestScrollToBottom:p,isUploadingAttachment:x,pendingAttachment:d,clearPendingAttachment:b,cancelAttachmentUpload:h,sendError:f,sendErrorMessage:w,canRetrySend:j,onRetrySend:v,uploadError:I,clearUploadError:M,showEmojiPicker:T,setShowEmojiPicker:S,openCameraPicker:N,onImageSelected:R,openAttachmentPicker:E,imageInputRef:F,attachmentInputRef:A,onAttachmentSelected:U,onAttachmentFile:z,disableSend:K})=>{const{getNumber:le}=Ss(),Ne=Math.max(1,Math.floor(le("ux.messages.max_message_chars",2e3))),ye=Math.max(60,Math.floor(le("ux.messages.composer_max_height_px",140))),[Mt,Ze]=n.useState(!1),[et,de]=n.useState(!1),[Ce,at]=n.useState(!1),[Oe,Rt]=n.useState([]),be=n.useRef(new Set),it=n.useRef(null),[Fe,es]=n.useState({canScrollLeft:!1,canScrollRight:!1,pages:1,active:0});n.useEffect(()=>{typeof window>"u"||Rt(vi())},[]),n.useEffect(()=>()=>{for(const g of be.current)try{URL.revokeObjectURL(g)}catch{}be.current.clear()},[]);const Me=n.useCallback(g=>{if(!g)return;const C=g.type??"",O=wi(C),W=bi(g.name,C),Q=O==="image"?URL.createObjectURL(g):void 0;Q&&be.current.add(Q);const se=`${g.name}:${g.size}:${g.lastModified}:${C}`,ae={id:se,name:g.name,size:g.size,sizeLabel:yi(g.size),badge:W,mime:C,kind:O,lastUsed:Date.now(),previewUrl:Q};Rt(ie=>{const fe=ie.filter(ce=>ce.id!==se),me=[ae,...fe].slice(0,Ts),tt=new Set(me.map(ce=>ce.id));for(const ce of ie)if(ce.previewUrl&&!tt.has(ce.id)){try{URL.revokeObjectURL(ce.previewUrl)}catch{}be.current.delete(ce.previewUrl)}return ji(me),me})},[]),ke=n.useCallback(()=>{const g=it.current;if(!g)return;const C=Math.max(0,g.scrollWidth-g.clientWidth),O=g.scrollLeft,W=O>1,Q=O<C-1,se=C>0?Math.ceil(g.scrollWidth/Math.max(1,g.clientWidth)):1,ae=Math.min(5,Math.max(1,se)),ie=C>0?O/C:0,fe=ae>1?Math.round(ie*(ae-1)):0;es({canScrollLeft:W,canScrollRight:Q,pages:ae,active:fe})},[]);n.useEffect(()=>{if(!et||Ce)return;const g=it.current;if(!g)return;let C=0;const O=()=>{C||(C=window.requestAnimationFrame(()=>{C=0,ke()}))};return ke(),g.addEventListener("scroll",O,{passive:!0}),window.addEventListener("resize",ke),()=>{g.removeEventListener("scroll",O),window.removeEventListener("resize",ke),C&&window.cancelAnimationFrame(C)}},[Oe.length,Ce,et,ke]);const H=n.useCallback(g=>{const C=g.target.value,O=C.length>Ne?C.slice(0,Ne):C;i(O),T&&S(!1),c(O.trim().length>0);const W=g.target;W.style.height="auto";const Q=Math.min(W.scrollHeight,ye);W.style.height=`${Q}px`},[ye,Ne,c,i,S,T]),St=n.useCallback(g=>{g&&(i(C=>{const O=`${C}${g}`;return c(O.trim().length>0),O}),queueMicrotask(()=>{const C=l.current;C&&(C.style.height="auto",C.style.height=`${Math.min(C.scrollHeight,ye)}px`)}))},[ye,c,i,l]),B=n.useCallback(g=>{if(g.preventDefault(),K||x)return;const C=o.trim();C&&(i(""),y(),m(C))},[K,o,x,m,i,y]),Ie=K||!o.trim()||x,Ct=n.useCallback(g=>{const C=g.target.files?.[0];C&&Me(C),R(g)},[R,Me]),Be=n.useCallback(g=>{const C=g.target.files?.[0];C&&Me(C),U(g)},[U,Me]),Z=x||K,Re=x||K,we=n.useMemo(()=>[{key:"photo",label:"Photo",icon:e.jsx(ws,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ze(!1),de(!1),N()},disabled:Z},{key:"file",label:"File",icon:e.jsx(jt,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ze(!1),de(!1),E()},disabled:Re},{key:"more",label:"More",icon:e.jsx(da,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ze(!1),de(!0)},disabled:Re}],[Re,Z,E,N]),qe=d?x?"Uploadingâ€¦":I?"Upload failed":"Ready":null;return s?e.jsxs(hi,{onSubmit:B,className:"space-y-2",onHeightChange:r,minHeight:t,onDragOver:g=>{!z||K||(g.preventDefault(),g.dataTransfer.dropEffect="copy",g.currentTarget.dataset.dragging="true")},onDragLeave:g=>{g.currentTarget.dataset.dragging="false"},onDrop:g=>{if(!z||K||x)return;g.preventDefault(),g.currentTarget.dataset.dragging="false";const C=g.dataTransfer.files;if(!C||C.length===0)return;const O=Array.from(C)[0];O&&(Me(O),z(O))},children:[d&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-start justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex min-w-0 items-start gap-3",children:[d.kind==="image"&&d.previewUrl?e.jsx("img",{src:d.previewUrl,alt:"",className:"h-12 w-12 rounded-lg object-cover"}):d.kind==="audio"&&d.previewUrl?e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(vs,{className:"h-5 w-5","aria-hidden":"true"})}):e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col gap-0.5",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("p",{className:"min-w-0 truncate text-[13px] font-semibold text-foreground",children:d.name}),qe?e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:qe}):null]}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:d.sizeLabel}),d.kind==="audio"&&d.previewUrl?e.jsx("audio",{controls:!0,src:d.previewUrl,className:"mt-2 w-52",children:e.jsx("track",{kind:"captions",srcLang:"en",label:"Captions"})}):null]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:x?h:b,"aria-label":x?"Cancel upload":"Remove attachment",children:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"})})]}),x&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-center justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Uploading attachmentâ€¦"}),e.jsx("div",{className:"mt-1 h-1.5 w-40 overflow-hidden rounded-full bg-muted/70","aria-hidden":"true",children:e.jsx("div",{className:"h-full w-1/2 animate-pulse rounded-full bg-primary/60"})})]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:h,"aria-label":"Cancel upload",children:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"})})]}),f&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(an,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:w??"Couldn't send. Please try again."})]}),j&&e.jsx($,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Retry"})]}),I&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(an,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:I})]}),e.jsx($,{type:"button",size:"sm",variant:"ghost",onClick:M,children:"Dismiss"})]}),e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs(en,{open:T,onOpenChange:S,children:[e.jsx(tn,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"icon-hit bg-muted/60 shadow-sm",children:e.jsx(Ma,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(sn,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:e.jsx(Gr,{className:"max-h-64",children:e.jsx("div",{className:"grid grid-cols-9 gap-2",children:xi.map(g=>e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit rounded-xl text-lg",onClick:()=>{St(g),S(!1)},children:e.jsx("span",{children:g})},g))})})})]}),e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm",onClick:N,"aria-label":"Send photo",disabled:Z,"aria-busy":x,children:e.jsx(ws,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:F,accept:"image/*",className:"hidden",onChange:Ct}),e.jsxs(en,{open:Mt,onOpenChange:Ze,children:[e.jsx(tn,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm","aria-label":"Add attachment",disabled:Re,"aria-busy":x,children:e.jsx(ba,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(sn,{side:"top",align:"center",className:"soft-popover w-auto p-2",children:e.jsx("div",{className:"flex items-center gap-2",children:we.map(g=>e.jsxs($,{type:"button",variant:"ghost",size:"icon",className:"h-12 w-12 flex-col gap-1 rounded-2xl text-muted-foreground hover:bg-muted/60 hover:text-foreground",onClick:g.onClick,disabled:g.disabled,"aria-label":g.label,children:[g.icon,e.jsx("span",{className:"text-[10px] font-medium leading-none",children:g.label})]},g.key))})})]}),e.jsx(Vt,{open:et,onOpenChange:g=>{de(g),g||at(!1)},children:e.jsxs(Gt,{className:"fixed left-1/2 bottom-4 top-auto -translate-x-1/2 translate-y-0 w-[calc(100%-2rem)] max-w-lg rounded-3xl border border-border/70 bg-card p-4 shadow-2xl",children:[e.jsx("div",{className:"mx-auto mb-2 h-1 w-10 rounded-full bg-muted/70","aria-hidden":"true"}),e.jsxs(Is,{className:"flex-row items-center justify-between space-y-0",children:[e.jsx(Yt,{className:"text-base",children:"Attach"}),e.jsx(ua,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit","aria-label":"Close",children:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"})})})]}),e.jsxs("div",{className:"mt-3 grid gap-2",children:[e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),N()},disabled:Z,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(ws,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Photo"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Choose an image"})]})]})}),e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),E()},disabled:Re,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"File"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"PDF, docs, audio, more"})]})]})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Recent files"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>at(g=>!g),"aria-pressed":Ce,children:Ce?"Hide":"See all"}),e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>{de(!1),E()},disabled:Re,children:"Browse"})]})]}),Ce?e.jsx("div",{className:"mt-2 grid gap-2",children:Oe.length===0?e.jsxs("div",{className:"soft-row-card px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:"No recent files yet"}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:"Attach something and it will appear here."})]}):Oe.map(g=>e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),g.kind==="image"?N():E()},disabled:Re,"aria-label":`Attach ${g.name}`,title:g.name,children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:g.kind==="image"&&g.previewUrl?e.jsx("img",{src:g.previewUrl,alt:"",className:"h-full w-full object-cover"}):g.kind==="audio"?e.jsx(vs,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col text-left",children:[e.jsx("span",{className:"min-w-0 truncate text-sm font-semibold",children:g.name}),e.jsxs("span",{className:"mt-0.5 text-xs text-muted-foreground",children:[g.badge," â€¢ ",g.sizeLabel]})]})]}),e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:"Recent"})]},g.id))}):e.jsxs("div",{className:"relative mt-2",children:[e.jsx("div",{ref:it,className:"-mx-1 flex gap-2 overflow-x-auto px-1 pb-1",role:"list","aria-label":"Recent files",children:Oe.length===0?e.jsx("div",{className:"soft-row-card flex w-[260px] shrink-0 items-center justify-between gap-3 px-3 py-2",children:e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[13px] font-semibold text-foreground",children:"No recent files yet"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Attach something to see it here."})]})}):Oe.map(g=>e.jsx("div",{role:"listitem",children:e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive flex w-[220px] shrink-0 items-center gap-3 px-3 py-2 text-left disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),g.kind==="image"?N():E()},disabled:Re,"aria-label":`Attach ${g.name}`,title:g.name,children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:g.kind==="image"&&g.previewUrl?e.jsx("img",{src:g.previewUrl,alt:"",className:"h-full w-full object-cover"}):g.kind==="audio"?e.jsx(vs,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsx("span",{className:"min-w-0 truncate text-[13px] font-semibold",children:g.name})}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2",children:[e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:g.badge}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:g.sizeLabel})]})]})]})},g.id))}),Fe.canScrollLeft?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 w-6 bg-gradient-to-r from-card to-transparent","aria-hidden":"true"}):null,Fe.canScrollRight?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 w-6 bg-gradient-to-l from-card to-transparent","aria-hidden":"true"}):null,Fe.pages>1?e.jsx("div",{className:"mt-2 flex items-center justify-center gap-1","aria-hidden":"true",children:Array.from({length:Fe.pages}).map((g,C)=>e.jsx("span",{className:C===Fe.active?"h-1.5 w-4 rounded-full bg-foreground/70 motion-safe:transition-all":"h-1.5 w-1.5 rounded-full bg-muted-foreground/30 motion-safe:transition-all"},C))}):null]})]})]})}),e.jsx("input",{type:"file",ref:A,accept:"image/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain,text/csv,application/rtf",className:"hidden",onChange:Be}),e.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border/70 bg-background/80 px-3 py-2 shadow-inner transition-shadow focus-within:ring-2 focus-within:ring-primary/25 focus-within:ring-offset-2 focus-within:ring-offset-background",children:e.jsx(wn,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:H,onBlur:y,onPaste:g=>{if(!z||K||x)return;const C=g.clipboardData?.items;if(!C)return;const O=Array.from(C).find(Q=>Q.type.startsWith("image/"));if(!O)return;const W=O.getAsFile();W&&(g.preventDefault(),p?.(),Me(W),z(W))},onKeyDown:g=>{if(!(g.isComposing||g.nativeEvent?.isComposing)&&g.key==="Enter"&&!g.shiftKey){if(K||Ie||!o.trim())return;g.preventDefault(),p?.(),g.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-[14px] leading-5 md:text-sm md:leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),e.jsx($,{type:"submit",variant:"default",size:"icon",className:"h-11 w-11 rounded-full bg-primary text-primary-foreground shadow-sm hover:bg-primary/90",onMouseDown:g=>g.preventDefault(),disabled:Ie,"aria-label":"Send message","aria-busy":x,children:x?e.jsx(Ye,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(va,{className:"h-4 w-4","aria-hidden":"true"})})]})]}):null},Mi=({open:s,editingMessage:t,onOpenChange:r,onCancel:o,onTextChange:i,onSave:l,textareaRef:c,error:y,isSaving:m})=>e.jsx(Vt,{open:s,onOpenChange:r,children:e.jsxs(Gt,{children:[e.jsxs(Is,{children:[e.jsx(Yt,{children:"Edit message"}),e.jsx(vn,{children:"Update your message for everyone in the conversation."})]}),t&&e.jsx(wn,{ref:c,value:t.text,onChange:p=>i(p.target.value),rows:3,className:"min-h-[120px]"}),y&&e.jsx("p",{className:"text-xs text-destructive",children:y}),e.jsxs(jn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),e.jsxs($,{type:"button",disabled:!t?.text.trim()||m,onClick:l,children:[m&&e.jsx(Ye,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),Ri=({open:s,deleteDialog:t,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:i,isDeleting:l})=>e.jsx(Vt,{open:s,onOpenChange:r,children:e.jsxs(Gt,{children:[e.jsxs(Is,{className:"gap-1",children:[e.jsxs(Yt,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:e.jsx(Yr,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),e.jsx(vn,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),e.jsxs(jn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!t,children:"Hide for me"}),e.jsxs($,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!t,onClick:i,children:[l&&e.jsx(Ye,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]})]})}),Si=({participant:s,onClick:t})=>{const r=(s.displayName??s.username??"?").slice(0,1).toUpperCase();return e.jsxs("button",{type:"button",onClick:t,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!t,children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:s.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.displayName}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:s.username?`@${s.username}`:s.isSelf?"You":""})]}),t?e.jsx(re,{name:"chevron_right",className:"text-muted-foreground"}):null]})},Ci=({open:s,onOpenChange:t,conversation:r,currentUserId:o,conversationId:i,isMuted:l,onToggleMute:c,otherParticipant:y,isGroupConversation:m,youBlocked:p,blockedYou:x,blockPending:d,onBlockToggle:b})=>{const h=dn(),f=n.useMemo(()=>r?.participants??[],[r?.participants]),w=!m&&!!y?.username&&!y?.isSelf,[j,v]=n.useState(null);n.useEffect(()=>{const S=r?.mutedUntil;if(!l||!S){v(null);return}const N=Date.parse(S);if(!Number.isFinite(N)||N<=Date.now()){v(null);return}try{v(new Date(N).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{v(null)}},[r?.mutedUntil,l]);const I=async()=>{const S=`${window.location.origin}/messages/${i}`;await rn(S)?G.show("Conversation link copied."):G.error("Couldn't copy to clipboard.")},M=async()=>{await rn(i)?G.show("Conversation ID copied."):G.error("Couldn't copy to clipboard.")},T=S=>{if(!S.username){G.show("This profile can't be opened yet.");return}t(!1),h(`/u/${S.username}`)};return e.jsx(Vt,{open:s,onOpenChange:t,children:e.jsxs(Gt,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none card-pad",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Yt,{className:"text-base",children:"Conversation info"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:m?`${f.length} participants`:y?.username?`@${y.username}`:"Direct message"})]}),e.jsx("button",{type:"button",onClick:()=>t(!1),className:"icon-hit","aria-label":"Close",children:e.jsx(re,{name:"close"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:I,children:[e.jsx(fa,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:M,children:[e.jsx(re,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),t(!1)},children:[e.jsx(ia,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),j?e.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",j]}):null]}),!m&&e.jsxs("div",{className:"mt-2 grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!w||!y||T(y)},disabled:!w,children:[e.jsx(ma,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:b,disabled:d||x&&!p,children:[e.jsx(Nn,{className:"h-4 w-4","aria-hidden":!0}),p?"Unblock":x?"Blocked":"Block"]}),(x||p)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:x&&!p?"This user has blocked you.":p?"You blocked this user.":null})]}),m&&e.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),e.jsx("div",{className:"grid gap-1",children:f.map(S=>e.jsx(Si,{participant:S,onClick:S.username&&S.id!==o?()=>T(S):void 0},S.id))})]})]})})};function ki(){const[s,t]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{t(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),s}const Ii=2;function Ei(s){const{items:t,onJumpToItemIndex:r,minQueryLen:o=Ii}=s,[i,l]=n.useState(!1),[c,y]=n.useState(""),[m,p]=n.useState(0),x=c.trim().toLowerCase(),d=x.length>=o,b=n.useMemo(()=>{if(!d)return[];const N=[];for(let R=0;R<t.length;R++){const E=t[R];if(E.meta.deleted)continue;const F=ln(E.message.body);F&&F.toLowerCase().includes(x)&&N.push(R)}return N},[t,x,d]),h=n.useMemo(()=>{const N=new Set;for(const R of b){const E=t[R]?.message.id;E&&N.add(E)}return N},[t,b]),f=b.length;n.useEffect(()=>{p(0)},[x]),n.useEffect(()=>{f!==0&&(m<0&&p(0),m>f-1&&p(f-1))},[m,f]);const w=n.useCallback(N=>{if(f===0)return;const R=(N%f+f)%f;p(R);const E=b[R];typeof E=="number"&&r?.(E)},[f,b,r]),j=n.useCallback(()=>{w(m+1)},[m,w]),v=n.useCallback(()=>{w(m-1)},[m,w]),I=n.useCallback(()=>{w(0)},[w]),M=n.useCallback(()=>{y(""),p(0)},[]),T=n.useCallback(()=>{l(!1),y(""),p(0)},[]),S=n.useMemo(()=>{if(f===0)return null;const N=b[m];return t[N]?.message.id??null},[m,t,f,b]);return{query:c,setQuery:y,isOpen:i,setIsOpen:l,matchCount:f,activeMatchNumber:f===0?0:m+1,activeMatchIndex:f===0?-1:m,activeMessageId:S,isMatch:N=>h.has(N),jumpNext:j,jumpPrev:v,jumpToFirst:I,clear:M,close:T}}function Ti(s,t,r,o){if(!r||typeof r!="object"||typeof r.id!="string")return!0;const i=o?.allowAppend??!0,l=o?.forceFailOnce??!1,c=o?.isMountedRef,y=o?.schedule??((d,b)=>{if(!(typeof window>"u"||typeof window.setTimeout!="function"))return window.setTimeout(d,b)});let m=!1;const p=()=>{try{return s.setQueryData(t,d=>{if(l&&!m)throw m=!0,new Error("forced cache updater failure");return mn(d,r,{allowAppend:i})}),!0}catch{return!1}};if(p())return!0;try{s.invalidateQueries?.({queryKey:t})}catch{}const x=[120,400,900];for(const d of x)y(()=>{c&&!c.current||p()},d);return!1}function Ai(s,t){return Jt({queryKey:fn(s),enabled:!!s&&t,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await X.rpc("assistant_reply_status_v1",{p_conversation_id:s});if(o){const i=(o.message??"").toLowerCase();if(i.includes("does not exist")||i.includes("function")||i.includes("schema"))return null;throw new Error(o.message)}return r??null}})}const Zi=()=>{const{conversationId:s}=Fr(),t=s??null,r=dn(),{user:o}=Qt(),i=je(),l=n.useRef(!0);n.useEffect(()=>(l.current=!0,()=>{l.current=!1}),[]);const c=n.useRef(!1);n.useEffect(()=>{},[]);const y=n.useCallback((a,u)=>{if(!t)return!0;const k=Se(t),L=c.current;return L&&(c.current=!1),Ti(i,k,a,{allowAppend:u?.allowAppend??!0,forceFailOnce:L,isMountedRef:l})},[t,i]),{getString:m,getNumber:p}=Ss(),x=n.useMemo(()=>m("ux.assistant.username","movinesta").toLowerCase(),[m]),d=n.useMemo(()=>m("ux.presence.label_online","Online"),[m]),b=n.useMemo(()=>m("ux.presence.label_active_recently","Active recently"),[m]),h=n.useMemo(()=>m("ux.presence.label_active_prefix","Active"),[m]),f=n.useMemo(()=>{const a=p("ux.messages.search.min_query_chars",2),u=Number.isFinite(a)?Math.trunc(a):2;return Math.max(1,Math.min(10,u))},[p]),{data:w,isLoading:j}=Br(),v=o?.id??null,I=oa(),M=n.useMemo(()=>!t||!w?null:w.find(a=>a.id===t)??null,[t,w]),T=M?.isMuted??!1,[S,N]=n.useState(!1),R=n.useCallback(()=>{if(!t)return;if(!v){G.error("Please sign in to manage messages.");return}const a=M?.isMuted??!1,u=M?.mutedUntil??null,k=M?.isHidden??!1;Ue(i,v,t,L=>({...L,isMuted:!1,mutedUntil:null})),G.show("Unmuted notifications."),nn(v,t,{muted:!1,hidden:k,mutedUntil:null}).then(({ok:L})=>{L||(Ue(i,v,t,_=>({..._,isMuted:a,mutedUntil:u})),G.error("Couldn't update preferences."))}).catch(L=>{console.warn("[ConversationPage] Failed to save conversation prefs (unmute)",L),Ue(i,v,t,_=>({..._,isMuted:a,mutedUntil:u})),G.error("Couldn't update preferences.")})},[t,v,M,i]),E=n.useCallback(a=>{if(!t)return;if(!v){G.error("Please sign in to manage messages.");return}const u=M?.isMuted??!1,k=M?.mutedUntil??null,L=M?.isHidden??!1;let _=!1,P=null;a.kind==="indefinite"?(_=!0,P=null):(_=!1,P=new Date(Date.now()+a.minutes*6e4).toISOString()),Ue(i,v,t,pe=>({...pe,isMuted:!0,mutedUntil:P})),G.show(`Muted notifications for ${a.label}.`),nn(v,t,{muted:_,hidden:L,mutedUntil:P}).then(({ok:pe})=>{pe||(Ue(i,v,t,Ve=>({...Ve,isMuted:u,mutedUntil:k})),G.error("Couldn't update preferences."))}).catch(pe=>{console.warn("[ConversationPage] Failed to save conversation prefs (mute preset)",pe),Ue(i,v,t,Ve=>({...Ve,isMuted:u,mutedUntil:k})),G.error("Couldn't update preferences.")})},[t,v,M,i]),F=n.useCallback(()=>{if(T){R();return}N(!0)},[T,R]),A=ci({currentUserId:o?.id??null}),{data:U,isLoading:z,isError:K,error:le,loadOlder:Ne,hasMore:ye,isLoadingOlder:Mt,pollWhenRealtimeDown:Ze}=qa(t,{onInsert:A}),et=n.useRef(new Set);n.useEffect(()=>{if(!t||!U||U.length===0)return;const a=et.current,u=new Set(U.map(k=>k.id));for(const k of U)a.has(k.id)||A(k);et.current=u},[t,U,A]);const{draft:de,setDraft:Ce}=ti({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const a=lt.current;a&&(a.style.height="auto",a.style.height=`${Math.min(a.scrollHeight,140)}px`)})}}),{sendError:at,lastFailedPayload:Oe,failedMessages:Rt,clearBannerState:be,onSendFailed:it,onSendRecovered:Fe,consumeLastFailedForRetry:es,consumeFailedMessageForRetry:Me,discardFailedMessage:ke}=li({conversationId:t,setDraft:a=>Ce(a),messages:U}),H=M?.isGroup??!1,{getStatus:St}=qr(),B=n.useMemo(()=>{if(!M)return null;const a=M.participants.filter(u=>!u.isSelf);return a.length>0?a[0]:M.participants.length===1?M.participants[0]:null},[M]),Ie=n.useMemo(()=>H||!B?.id?null:St(B.id),[St,H,B?.id]),Ct=pa(H?null:B?.id??null),Be=n.useMemo(()=>{const a=Ct.data??null,u=un(a);return u?u==="Just now"?"now":u:null},[Ct.data]),Z=n.useMemo(()=>{if(I?.conversationId&&t===I.conversationId)return!0;const a=B;return a?a.username?.toLowerCase()===x:!1},[I?.conversationId,t,B,x]),we=Ai(t,Z).data??null,[qe,g]=n.useState(!1),[C,O]=n.useState(null),W=n.useRef(null),Q=n.useRef(""),se=n.useRef(null),[ae,ie]=n.useState(null),fe=Y.useRef({inFlight:!1,queuedMessageId:null}),me=n.useRef(null),tt=n.useRef(null);n.useEffect(()=>()=>{W.current&&(W.current.abort(),W.current=null),me.current&&(window.clearTimeout(me.current),me.current=null),tt.current=null},[]);const[ce,kt]=n.useState(null),It=n.useCallback(async a=>{if(!(!t||!v)){if(fe.current.inFlight){fe.current.queuedMessageId=a;return}fe.current.inFlight=!0,fe.current.queuedMessageId=null,g(!0),kt(null);try{throw new Error("Missing Supabase config for assistant streaming.")}catch(u){se.current!==null&&(cancelAnimationFrame(se.current),se.current=null),Q.current="",O(null),ie(null),kt({userMessageId:a,error:u?.message||"Assistant failed"})}finally{g(!1),W.current=null,i.invalidateQueries({queryKey:Se(t)}),i.invalidateQueries({queryKey:Ns(v)}),i.invalidateQueries({queryKey:fn(t)}),fe.current.inFlight=!1;const u=fe.current.queuedMessageId;fe.current.queuedMessageId=null,u&&u!==a&&It(u)}}},[t,v,i]),As=n.useCallback(a=>{!t||!v||Z&&(tt.current=a,me.current&&window.clearTimeout(me.current),me.current=window.setTimeout(()=>{const u=tt.current;tt.current=null,me.current=null,u&&It(u)},600))},[t,v,Z,It]),kn=n.useCallback(async(a,u)=>{if(t)try{const{data:k,error:L}=await X.functions.invoke("assistant-message-action",{body:{conversationId:t,messageId:a,actionId:u}});if(L)throw new Error(L.message||"Action failed");if(!k?.ok)throw new Error(k?.error||"Action failed");const _=k?.toast;_&&G.success(_);const P=k?.navigateTo;P&&r(P)}catch(k){const L=k instanceof Error?k.message:String(k);G.error(L||"Action failed")}finally{t&&i.invalidateQueries({queryKey:Se(t)}),v&&i.invalidateQueries({queryKey:Ns(v)})}},[t,v,r,i]),ot=M?.title??B?.displayName??B?.username??"Conversation",Ls=Xr(t,{onFailed:it,onRecovered:Fe,otherUserId:H?null:B?.id??null}),st=n.useCallback((a,u)=>{be(),Ls.mutate({text:a.text,attachmentPath:a.attachmentPath,attachmentKind:a.attachmentKind??null,clientId:a.clientId,tempId:u?.tempId},{onSuccess:async k=>{be(),Z&&t&&v&&(a.text.trim().length>0||a.attachmentPath)&&As(k.id)}})},[be,t,v,Z,As,Ls]),lt=n.useRef(null),ts=n.useRef(null),Pe=n.useRef(!1),In=n.useMemo(()=>{const a=new Map;if(!M)return a;for(const u of M.participants)a.set(u.id,u);return a},[M]),{youBlocked:ct,blockedYou:oe,isBlocked:$e,block:Et,unblock:Tt}=Zr(H?null:B?.id??null),{imageInputRef:En,attachmentInputRef:Tn,isUploadingAttachment:An,pendingAttachment:Ln,uploadError:_n,clearPendingAttachment:Dn,cancelAttachmentUpload:Un,clearUploadError:On,handleImageSelected:Fn,handleAttachmentSelected:Bn,sendAttachmentFile:qn,openImagePicker:Pn,openAttachmentPicker:$n}=ea({conversationId:t,userId:v,isBlocked:$e,blockedYou:oe,attemptSend:st}),ut=!$e&&!oe,ss=!!B&&!H,zn=Et.isPending||Tt.isPending,[Kn,_s]=n.useState(!1),Hn=n.useCallback(()=>{if(ss){if(ct){Tt.mutate();return}oe||Et.mutate()}},[Et,oe,ss,Tt,ct]),ns=ss?{label:ct?"Unblock":oe?"Blocked":"Block",onClick:()=>{ct?Tt.mutate():oe||Et.mutate()}}:null,{headerRef:Qn,headerHeight:Jn,composerHeight:Wn,isAtBottom:ze,setIsAtBottom:Ee,handleComposerHeightChange:Ds,showEmojiPicker:Vn,setShowEmojiPicker:At}=si({showComposer:ut}),[Gn,Lt]=n.useState(!1),[Us,Os]=n.useState(0);n.useEffect(()=>{if(typeof window>"u")return;const a=window.visualViewport;if(!a){Os(0);return}const u=()=>{const k=Math.max(0,window.innerHeight-a.height-a.offsetTop);Os(k)};return u(),a.addEventListener("resize",u),a.addEventListener("scroll",u),window.addEventListener("orientationchange",u),()=>{a.removeEventListener("resize",u),a.removeEventListener("scroll",u),window.removeEventListener("orientationchange",u)}},[]);const Fs=ut?Math.max(Wn,0)+24+Us:40+Us,Yn=`${Fs}px`,Bs=Math.max(80,Fs+32),Xn=n.useMemo(()=>M?.participants.find(a=>a.isSelf)?.displayName??"You",[M]),{remoteTypingUsers:Te,noteLocalInputActivity:Zn,stopTyping:er}=ei({conversationId:t,userId:o?.id??null,displayName:Xn}),{data:qs}=Xa(t);ri({conversationId:t,userId:o?.id??null,isAtBottom:ze===!0&&Gn,messages:U});const{reactionsByMessageId:tr,toggleReaction:Ps}=Ya(t),sr=n.useCallback((a,u)=>{Ps.mutate({messageId:a,emoji:u})},[Ps]),Ae=n.useRef(null),rs=n.useRef(!1),Ke=n.useRef(null),dt=n.useRef(null),_t=n.useRef(!1),nt=n.useRef(!1),ft=n.useRef(!1),[$s,He]=n.useState(0),mt=n.useRef(null),[Le,nr]=n.useState(null),zs=n.useRef(new Map),rr=n.useCallback(a=>{mt.current=a,nr(a)},[]),pt=n.useRef(!1),[Ks,Dt]=n.useState(!0),as=n.useRef(!0),gt=ki();n.useEffect(()=>{as.current=Ks},[Ks]);const{activeActionMessageId:ar,openMessageActions:Hs,closeMessageActions:Ut,hiddenMessageIds:Qs,hideMessageForMe:ir,deleteDialog:Qe,openDeleteDialog:or,closeDeleteDialog:is,editingMessage:Je,openEditDialog:lr,updateEditingText:cr,closeEditDialog:os,editTextareaRef:ur,editError:dr,setEditError:Js}=ni({conversationId:t,currentUserId:v,showComposer:ut,isBlocked:$e,blockedYou:oe,composerTextareaRef:lt}),Ot=za({messages:U,currentUserId:v,hiddenMessageIds:Qs}),fr=n.useMemo(()=>Ot?[Ot]:[],[Ot]),{data:mr}=Za(t,fr),Ws=ii(t),Vs=oi(t),{visibleMessages:D}=$a({messages:U,conversation:M,currentUserId:v,participantsById:In,reactionsByMessageId:tr,hiddenMessageIds:Qs,deliveryReceipts:mr??[],readReceipts:qs??[],failedMessages:Rt,lastOwnMessageId:Ot});n.useEffect(()=>{const a=ae?.messageId??null;if(!a)return;if((U??[]).some(L=>String(L?.id??"")===String(a))){O(null),ie(null);return}const k=window.setTimeout(()=>{O(null),ie(null)},8e3);return()=>window.clearTimeout(k)},[ae?.messageId,U]);const ls=n.useMemo(()=>{if(!C||!t||!B?.id)return null;const a={id:`assistant_stream_${t}`,conversationId:t,senderId:B.id,createdAt:new Date().toISOString(),body:{type:"text",text:C},attachmentUrl:null,text:C},u=Array.isArray(ae?.citations)?ae?.citations:null;return u&&u.length&&(a.meta={ai:{ui:{citations:u}}}),{message:a,meta:{...Nt(a.body),streaming:!0},sender:B,isSelf:!1,deliveryStatus:null,showDeliveryStatus:!1,reactions:[]}},[C,ae,t,B]),{firstUnreadIndex:ht,lastReadMessageId:_e,hasUnread:xt,isReady:cs}=ui({conversationId:t,userId:o?.id??null,conversation:M,readReceipts:qs,visibleMessages:D}),Gs=n.useMemo(()=>{if(!cs||!xt)return 0;let a=ht;if(a==null&&typeof _e=="string"&&_e){const u=D.findIndex(k=>k.message.id===_e);a=u>=0?u+1:null}return a==null?0:D.slice(a).filter(u=>!u.isSelf&&!u.meta.deleted).length},[ht,xt,_e,cs,D]),Ft=D.length>0,yt=n.useRef(D),Ys=n.useRef(ye),We=n.useRef(null),us=n.useRef(!1),ds=n.useRef(!1),fs=n.useRef(!1),Bt=n.useMemo(()=>{if(!ls)return D;const a=ae?.messageId??null;return a&&D.some(u=>u.message.id===a)?D:[...D,ls]},[ae?.messageId,ls,D]),ve=gt?"auto":"smooth",ne=n.useCallback(a=>{const u=mt.current;u&&(pt.current=!0,requestAnimationFrame(()=>{u.scrollTo({top:u.scrollHeight,behavior:a??ve}),requestAnimationFrame(()=>{pt.current=!1})}))},[ve]),ms=n.useCallback(()=>{_t.current=!0,Dt(!0),Ee(!0),Lt(!0),ne("auto")},[ne,Ee]),bt=n.useCallback((a,u)=>{const k=zs.current.get(a);return k?(pt.current=!0,requestAnimationFrame(()=>{k.scrollIntoView({block:u?.align??"end",behavior:u?.behavior??ve}),requestAnimationFrame(()=>{pt.current=!1})}),!0):!1},[ve]);n.useEffect(()=>{yt.current=D},[D]),n.useEffect(()=>{Ys.current=ye},[ye]);const qt=n.useRef(null),pr=n.useCallback(()=>{const a=mt.current;a&&(qt.current={active:!0,prevScrollHeight:a.scrollHeight,prevScrollTop:a.scrollTop,prevCount:yt.current.length})},[]);Y.useLayoutEffect(()=>{const a=qt.current,u=mt.current;if(!a?.active||!u||D.length<=a.prevCount)return;const L=u.scrollHeight-a.prevScrollHeight;u.scrollTop=a.prevScrollTop+L,qt.current=null},[D.length]),n.useEffect(()=>{nt.current=!1,Ke.current=null,He(0)},[t]),n.useEffect(()=>{if(nt.current||!Ft||!mt.current)return;const a=D.length-1;a<0||(nt.current=!0,requestAnimationFrame(()=>{ne("auto"),Lt(!0),Ee(!0),Dt(!0),Ke.current=D[a]?.message.id??null,He(0)}))},[t,Ft,ne,Le,Ee,D]),n.useEffect(()=>{const a=dt.current;if(!a)return;if(!D.some(L=>L.message.id===a)){dt.current=null;return}bt(a,{align:"end",behavior:"auto"})&&(dt.current=null)},[bt,D]);const Pt=D.length>0?D[D.length-1].message.id:null;n.useEffect(()=>{Pt&&_t.current&&(_t.current=!1,ne("auto"))},[Pt,ne]),n.useEffect(()=>{Pt&&nt.current&&as.current&&(qt.current?.active||dt.current||ne(ve))},[Pt,ve,ne]),n.useEffect(()=>{const a=C!==null;a&&!ds.current&&(us.current=as.current),!a&&ds.current&&(us.current=!1),ds.current=a},[C]),Y.useLayoutEffect(()=>{if(!C||!us.current)return;fs.current=!0;const a=()=>{fs.current&&(ne("auto"),We.current=requestAnimationFrame(a))};return We.current!==null&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(a),()=>{fs.current=!1,We.current!==null&&(cancelAnimationFrame(We.current),We.current=null)}},[C,ne]),n.useEffect(()=>{if(!Le)return;const a=()=>{const L=Le.scrollHeight-Le.scrollTop-Le.clientHeight<=Bs;Dt(_=>_===L?_:L),Ee(_=>_===L?_:L),Lt(!0)};a();const u=()=>{a(),pt.current||(nt.current=!0,ft.current=!1)};return Le.addEventListener("scroll",u,{passive:!0}),()=>Le.removeEventListener("scroll",u)},[Le,Bs,Ee]),n.useEffect(()=>{const a=D.length?D[D.length-1]?.message.id??null:null;if(ze===!0){Ke.current=a,He(0);return}if(!a)return;const u=Ke.current;if(u===a)return;const k=u?D.findIndex(P=>P.message.id===u):-1;if(u&&k<0){Ke.current=a,He(0);return}const _=D.slice(Math.max(0,k+1)).filter(P=>!P.isSelf).length;_<=0||He(_)},[ze,D]),n.useEffect(()=>()=>{Ae.current!=null&&window.clearTimeout(Ae.current)},[]);const gr=()=>{const a=es();a&&st(a.payload,{tempId:a.tempId??void 0})},hr=a=>{Ae.current!=null&&window.clearTimeout(Ae.current),rs.current=!1,Ae.current=window.setTimeout(()=>{rs.current=!0,Hs(a)},500)},xr=()=>{Ae.current!=null&&(window.clearTimeout(Ae.current),Ae.current=null)},yr=n.useCallback(a=>{const u=Me(a.id);u&&st(u,{tempId:a.id})},[st,Me]),br=n.useCallback(a=>{ke(a.id)},[ke]),wr=n.useCallback(a=>{if(a<0)return;const u=yt.current[a]?.message.id??null;u&&bt(u,{align:"center"})},[bt]),q=Ei({items:D,onJumpToItemIndex:a=>{Pe.current=!0,wr(a)},minQueryLen:f}),De=q.query.trim().length>=f;n.useEffect(()=>{q.close()},[t,q.close]);const ps=()=>{Ut(),At(!1),q.setIsOpen(!0),queueMicrotask(()=>ts.current?.focus())},wt=()=>{q.close()};n.useEffect(()=>{const a=u=>{if(u.key==="Escape"){if(q.isOpen){u.preventDefault(),wt();return}Ut(),At(!1)}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[Ut,wt,q.isOpen,At]),n.useEffect(()=>{Pe.current=!1},[q.query]);const gs=n.useCallback(a=>{const u=D.length-1;if(u<0)return;const k=D[u]?.message.id??null;k&&(Ke.current=k),He(0),ne(a??ve),window.setTimeout(()=>{lt.current?.focus()},gt?0:200)},[ve,gt,D,ne]),vr=n.useCallback(a=>{Ds(a),ze===!0&&ne("auto")},[Ds,ze,ne]),hs=n.useCallback(async a=>{if(xt&&!ft.current){ft.current=!0;try{let u=ht;if(u==null&&typeof _e=="string"&&_e){let L=0;for(;Ys.current&&L<8;){const _=yt.current.findIndex(P=>P.message.id===_e);if(_>=0){u=_+1;break}await Ne(),L+=1}}if(u==null)return;const k=yt.current[u]?.message.id??null;k&&bt(k,{align:"start",behavior:a??ve}),window.setTimeout(()=>{lt.current?.focus()},gt?0:150)}finally{ft.current=!1}}},[ht,xt,cs,_e,Ne,gt,ve]),jr=n.useCallback(a=>{if(!a.trim())return;be(),nt.current=!0,ft.current=!1,_t.current=!0;const u=ta(),k=sa();Dt(!0),Ee(!0),Lt(!0),dt.current=u,st({text:a.trim(),attachmentPath:null,clientId:k},{tempId:u})},[st,be,Ee]);n.useEffect(()=>{Ke.current=null,He(0)},[t]),n.useEffect(()=>{const a=u=>{if(u.key.toLowerCase()==="f"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),ps();return}if(u.key==="End"||u.key==="ArrowDown"&&(u.metaKey||u.ctrlKey)||u.key==="End"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),gs();return}u.key.toLowerCase()==="u"&&u.altKey&&(u.preventDefault(),hs())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[gs,hs,ps]);const Nr=n.useMemo(()=>{if(oe)return"You are blocked";if($e)return"You blocked them";if(Z){if(C!==null)return"Streamingâ€¦";if(qe||we?.is_typing||we?.is_queued)return"Typingâ€¦"}if(Te.length>0)return H?Te.length===1?`${Te[0].displayName??"Someone"} typingâ€¦`:`${Te.length} typingâ€¦`:"Typingâ€¦";if(!H&&Ie){if(Ie==="online")return d;if(Ie==="away")return b}return!H&&Be?Be==="now"?d:`${h} ${Be}`:M?.subtitle||(H?"Group chat":"Direct message")},[oe,$e,Z,qe,we?.is_typing,we?.is_queued,C,H,Ie,Be,M?.subtitle,Te,d,b,h]),Mr=n.useMemo(()=>{const a=M?.participants??[],u=new Map(a.map(_=>[_.id,_])),k=[];for(const _ of Te){const P=u.get(_.userId),pe=P?.displayName??_.displayName??"Someone";k.push({id:_.userId,displayName:pe,avatarUrl:P?.avatarUrl??null})}return Z&&B?.id&&(qe||we?.is_typing||we?.is_queued)&&C===null&&(k.some(P=>P.id===B.id)||k.unshift({id:B.id,displayName:B.displayName??B.username??ot??"Assistant",avatarUrl:B.avatarUrl??null})),k},[qe,C,we?.is_typing,we?.is_queued,M?.participants,ot,Z,B,Te]);return t?e.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background",children:[e.jsxs("div",{ref:Qn,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[e.jsxs("header",{className:"flex items-center justify-between page-pad py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>r(-1),className:"icon-hit","aria-label":"Go back",children:e.jsx(re,{name:"arrow_back"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:B?.avatarUrl?e.jsx("img",{src:B.avatarUrl,alt:B.displayName??"Conversation",className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(B?.displayName??ot).slice(0,2).toUpperCase()})}),!H&&(Ie==="online"||Be==="now")&&e.jsx("span",{className:Cs("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:ot}),e.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:Nr})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Search in conversation",onClick:()=>{q.isOpen?wt():ps()},children:e.jsx(re,{name:"search"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Video call",onClick:()=>G.show("Video calls are coming soon."),children:e.jsx(re,{name:"videocam"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Conversation info",onClick:()=>_s(!0),children:e.jsx(re,{name:"info"})}),ns?e.jsx("button",{type:"button",onClick:ns.onClick,className:"icon-hit","aria-label":ns.label,children:e.jsx(Nn,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),q.isOpen&&e.jsxs("div",{className:"page-pad pb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:e.jsx(re,{name:"search",className:"text-muted-foreground"})}),e.jsx("input",{ref:ts,value:q.query,onChange:a=>q.setQuery(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){if(a.preventDefault(),!De||q.matchCount===0)return;if(a.shiftKey){Pe.current=!0,q.jumpPrev();return}if(!Pe.current){q.jumpToFirst(),Pe.current=!0;return}q.jumpNext()}a.key==="Escape"&&(a.preventDefault(),wt())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background",autoComplete:"off",spellCheck:!1}),q.query.trim()&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 icon-hit","aria-label":"Clear search",onClick:()=>{q.clear(),queueMicrotask(()=>ts.current?.focus())},children:e.jsx(re,{name:"close"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Previous match",disabled:!De||q.matchCount===0,onClick:()=>{Pe.current=!0,q.jumpPrev()},children:e.jsx(re,{name:"keyboard_arrow_up"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Next match",disabled:!De||q.matchCount===0,onClick:()=>{Pe.current=!0,q.jumpNext()},children:e.jsx(re,{name:"keyboard_arrow_down"})}),e.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:De?`${q.activeMatchNumber}/${q.matchCount}`:"0/0"}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Close search",onClick:wt,children:e.jsx(re,{name:"close"})})]})]}),De&&q.matchCount===0&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-muted/10",children:[Ze&&e.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center page-pad",children:e.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/85 px-3 py-1 text-[12px] text-muted-foreground shadow-sm backdrop-blur",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),e.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),e.jsx(di,{items:Bt,isLoading:z&&!Ft,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:K?e.jsxs("div",{className:"mb-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-[12px] text-destructive",children:[e.jsx("p",{className:"font-medium text-foreground",children:"We couldn't load this conversation."}),le instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:le.message})]}):void 0,emptyContent:Ft?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:H?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:H?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:e.jsxs(e.Fragment,{children:[e.jsx(gi,{users:Mr}),e.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:ye?e.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:Mt?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):e.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Yn,scrollerRef:rr,onStartReached:()=>{ye&&!Mt&&(pr(),Ne())},computeItemKey:(a,u)=>u.message.id,itemContent:(a,u)=>{const{message:k,meta:L,sender:_,isSelf:P,deliveryStatus:pe,reactions:Ve,showDeliveryStatus:$t}=u,xs=a>0?Bt[a-1]?.message??null:null,ue=a<Bt.length-1?Bt[a+1]?.message??null:null,ge=ee=>{const he=zs.current;ee?he.set(k.id,ee):he.delete(k.id)};return e.jsx("div",{ref:ge,"data-message-id":k.id,children:e.jsx(na,{message:k,meta:L,sender:_,isSelf:P,deliveryStatus:pe,showDeliveryStatus:$t,reactions:Ve,index:a,previousMessage:xs,nextMessage:ue,firstUnreadIndex:ht,activeActionMessageId:ar,longPressTriggeredRef:rs,onOpenMessageActions:Hs,onCloseMessageActions:Ut,onOpenEditDialog:lr,onOpenDeleteDialog:or,onToggleReaction:sr,onRetryMessage:yr,onDiscardFailedMessage:br,onAssistantAction:kn,onBubbleTouchStart:hr,onBubbleTouchEndOrCancel:xr,searchQuery:De?q.query:void 0,isSearchMatch:De?q.isMatch(k.id):!1,isActiveSearchMatch:De?q.activeMessageId===k.id:!1})})}}),e.jsx(mi,{show:!!(xt&&Gs>0&&ze!==!0),unreadCount:Gs,onClick:hs,shortcutHint:"Alt+U"}),e.jsx(fi,{show:ze!==!0&&$s>0,pendingCount:$s,onClick:gs,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),ce&&Z&&ut&&e.jsx("div",{className:"page-pad pb-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(re,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),e.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:ce.error})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const a=ce.userMessageId;kt(null),It(a)},children:[e.jsx(re,{name:"refresh",className:"text-base"}),"Retry"]}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>kt(null),children:"Dismiss"})]})]})}),e.jsx(Ni,{show:ut,headerHeight:Jn,onHeightChange:vr,typingUsers:Te,isGroupConversation:H,draft:de,setDraft:Ce,textareaRef:lt,noteLocalInputActivity:Zn,stopTyping:er,onSendText:jr,onRequestScrollToBottom:ms,isUploadingAttachment:An,pendingAttachment:Ln,clearPendingAttachment:Dn,cancelAttachmentUpload:Un,sendError:!!at,sendErrorMessage:at,canRetrySend:!!Oe,onRetrySend:gr,uploadError:_n,clearUploadError:On,showEmojiPicker:Vn,setShowEmojiPicker:At,openCameraPicker:Pn,openAttachmentPicker:$n,imageInputRef:En,attachmentInputRef:Tn,onImageSelected:a=>{ms(),Fn(a)},onAttachmentSelected:a=>{ms(),Bn(a)},onAttachmentFile:a=>qn(a),disableSend:!!($e||oe)}),oe&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),$e&&!oe&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),e.jsx(Mi,{open:!!Je,editingMessage:Je,onOpenChange:a=>{a||os()},onCancel:os,onTextChange:cr,textareaRef:ur,error:dr,isSaving:Ws.isPending,onSave:()=>{if(!Je)return;const a=Je.text.trim();a&&(Js(null),Ws.mutate({messageId:Je.messageId,text:a,currentBody:Je.body,attachmentUrl:Je.attachmentUrl},{onSuccess:()=>{os()},onError:()=>{Js("Couldn't save changes. Please try again.")}}))}}),e.jsx(Ri,{open:!!Qe,deleteDialog:Qe,onOpenChange:a=>{a||is()},onHideForMe:()=>{Qe&&(ir(Qe.messageId),is())},onDeleteForEveryone:()=>{Qe&&Vs.mutate({messageId:Qe.messageId,attachmentUrl:Qe.attachmentUrl},{onSettled:()=>{is()}})},isDeleting:Vs.isPending}),t&&e.jsx(Ci,{open:Kn,onOpenChange:_s,conversation:M,currentUserId:v,conversationId:t,isMuted:T,onToggleMute:F,otherParticipant:B,isGroupConversation:H,youBlocked:ct,blockedYou:oe,blockPending:zn,onBlockToggle:Hn}),t&&e.jsx(la,{open:S,onOpenChange:N,conversationTitle:ot,onSelect:a=>E(a)})]}):e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center page-pad",children:e.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Pr,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Zi as default,Xr as useSendMessage};
