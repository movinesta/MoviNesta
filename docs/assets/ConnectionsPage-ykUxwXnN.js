import{j as e,S as L,b as C,a7 as E,s as F,d as S,I as k,u as $,J as q,R as _,L as M,B as R}from"./index-B1gR2HyV.js";import{Y as T}from"./index-CLprw0ja.js";import{T as P}from"./TopBar-C50ghZjl.js";import{u as I}from"./useToggleFollow-B7cowu9k.js";import{U as z,a as A}from"./user-plus-BprlTVwP.js";const Q=({className:t="",...s})=>e.jsxs("div",{className:`flex flex-1 items-center gap-2 rounded-full border border-border bg-background px-3 py-2 text-sm shadow-md focus-within:border-primary/70 ${t}`,children:[e.jsx(L,{className:"h-3.5 w-3.5 text-muted-foreground","aria-hidden":"true"}),e.jsx("input",{...s,className:"flex w-full rounded-md border border-input transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground focus-visible:outline-none focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm h-8 flex-1 border-none bg-transparent p-0 text-sm text-foreground shadow-none outline-none ring-0 placeholder:text-muted-foreground focus-visible:ring-0"})]}),B=25,Y=t=>{if(!t)return null;const s=t.trim();return s?s.startsWith("@")?s:`@${s}`:null};function H(t,s){const{user:n}=C(),m=n?.id??null;return E({queryKey:["connections",t??null,s,m],enabled:!!t,initialPageParam:0,getNextPageParam:o=>o.nextOffset,queryFn:async({pageParam:o})=>{const d=typeof o=="number"?o:0;if(!t)return{items:[]};const w=F.from("follows").select("follower_id, followed_id, created_at").order("created_at",{ascending:!1}),{data:i,error:c}=await(s==="followers"?w.eq("followed_id",t):w.eq("follower_id",t)).range(d,d+B-1);if(c)throw new Error(c.message);const p=i??[],u=p.map(r=>s==="followers"?r.follower_id:r.followed_id);if(u.length===0)return{items:[]};const{data:b,error:f}=await F.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",u);if(f)throw new Error(f.message);const v=b??[],x=new Map(v.map(r=>[r.id,r])),N=await Promise.all(u.map(r=>S(typeof x.get(r)?.avatar_url=="string"?x.get(r).avatar_url:null)));let j=new Set;if(m){const{data:r,error:y}=await F.from("follows").select("followed_id").eq("follower_id",m).in("followed_id",u);y||(j=new Set((r??[]).map(h=>h.followed_id)))}const l=u.map((r,y)=>{const h=x.get(r);return{id:r,username:h?.username??null,displayName:h?.display_name??null,avatarUrl:N[y]??null,bio:h?.bio??null,isFollowing:j.has(r)}}),a=p.length===B?d+B:void 0;return{items:l,nextOffset:a}}})}const U=Y,O=(t,s)=>{const n=(t??s??"?").replace(/^@/,"").trim();return n?n[0]?.toUpperCase():"?"};function W({person:t,viewerId:s,onToggleFollow:n,isToggling:m}){const o=t.displayName??t.username??"Unknown user",d=U(t.username),g=!!(s&&s===t.id);return e.jsxs("div",{className:"flex items-center justify-between gap-3 px-3 py-2",children:[e.jsxs(M,{to:t.username?`/u/${t.username}`:`/u/${t.id}`,className:"flex min-w-0 flex-1 items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-card/80 text-[14px] font-semibold text-foreground",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:o,className:"h-full w-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("span",{children:O(t.displayName,t.username)})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:o}),g&&e.jsx("span",{className:"rounded-full border border-border bg-card px-2 py-0.5 text-[10px] text-muted-foreground",children:"You"})]}),d&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:d}),t.bio&&e.jsx("p",{className:"mt-0.5 line-clamp-2 text-xs text-muted-foreground",children:t.bio})]})]}),!g&&e.jsx(R,{type:"button",size:"sm",variant:t.isFollowing?"outline":"default",className:"h-8 rounded-full px-3 text-xs",onClick:()=>n(t.id,t.isFollowing),disabled:m,children:m?e.jsx("span",{children:"…"}):t.isFollowing?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Following"})]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Follow"})]})})]})}const V=({mode:t})=>{const{username:s}=k(),n=$(),{user:m}=C(),o=I(),{data:d,isLoading:g,isError:w}=q(s??""),i=H(d?.id??null,t),[c,p]=_.useState(""),u=_.useMemo(()=>(i.data?.pages??[]).flatMap(l=>l.items),[i.data?.pages]),b=_.useMemo(()=>{const l=c.trim().toLowerCase();return l?u.filter(a=>[a.displayName,a.username,U(a.username),a.bio].filter(Boolean).join(" ").toLowerCase().includes(l)):u},[u,c]),f=t==="followers"?"Followers":"Following",v=(l,a)=>{o.mutate({targetUserId:l,currentlyFollowing:a})},x=o.isPending?o.variables?.targetUserId:null,N=!!(i.hasNextPage&&!i.isFetchingNextPage),j=()=>{N&&(c.trim()||i.fetchNextPage())};return g?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:f,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"Loading connections…"})]}):w||!d?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:f,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"We couldn't load this profile."})]}):e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:f,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3",children:e.jsx(Q,{placeholder:`Search ${f.toLowerCase()}…`,value:c,onChange:l=>p(l.target.value)})}),e.jsx("div",{className:"flex-1 px-2",children:e.jsx("div",{className:"overflow-hidden rounded-2xl border border-border bg-card/80",children:i.isLoading?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:"Loading…"}):b.length===0?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:c.trim()?`No ${f.toLowerCase()} match “${c.trim()}”.`:t==="followers"?"No followers yet.":"Not following anyone yet."}):e.jsx(T,{style:{height:"100%"},data:b,endReached:j,itemContent:(l,a)=>e.jsx(W,{person:a,viewerId:m?.id??null,isToggling:!!(x&&x===a.id),onToggleFollow:v}),components:{Footer:()=>i.isFetchingNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Loading more…"}):i.hasNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Scroll for more"}):e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"End"})}})})})]})};export{V as C};
