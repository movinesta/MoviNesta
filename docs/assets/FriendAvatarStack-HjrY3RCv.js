import{j as a,d as V,r as o,i as Z,k as ee,l as te,m as re,h as _,t as q,q as L,n as ne,B as se}from"./index-C9fHGWeV.js";import{u as ae}from"./useMutation-Cbgapksf.js";function R({name:e,className:t,filled:r,ariaLabel:l}){return a.jsx("span",{className:["material-symbols-rounded",r?"is-filled":"",t??""].filter(Boolean).join(" "),"aria-hidden":l?void 0:!0,"aria-label":l,children:e})}const be=(e,t,r)=>Math.min(r,Math.max(t,e)),ie=e=>{if(!e)return null;const t=e.trim();return!t||t.toUpperCase()==="N/A"?null:t},ye=e=>{if(!e||e<=0)return null;const t=Math.floor(e/60),r=e%60;return t===0?`${r}m`:r===0?`${t}h`:`${t}h ${r}m`},we=e=>{const t=ie(e);if(!t)return null;const r=t.toLowerCase();return r==="united states"||r==="united states of america"?"US":r==="united kingdom"||r==="great britain"?"UK":r==="canada"?"CA":r==="australia"?"AU":r==="germany"?"DE":r==="france"?"FR":r==="spain"?"ES":r==="italy"?"IT":r==="japan"?"JP":r==="south korea"||r==="republic of korea"?"KR":t.length<=3?t.toUpperCase():t},oe=e=>{if(e==null)return null;if(typeof e=="number")return Number.isNaN(e)?null:e;const t=parseFloat(e);return Number.isNaN(t)?null:t},ke=e=>{const t=oe(e);return t==null?null:Math.round(t).toLocaleString()},ve=e=>{switch(e){case"from-friends":return"Friends’ picks";case"trending":return"Trending now";case"popular":return"Popular";default:return"Matched for you"}},Se=e=>{if(!e)return;const t=[];e.year&&t.push(String(e.year));const r=[];typeof e.imdbRating=="number"&&!Number.isNaN(e.imdbRating)&&r.push(`IMDb ${e.imdbRating.toFixed(1)}`),typeof e.rtTomatoMeter=="number"&&!Number.isNaN(e.rtTomatoMeter)&&r.push(`${e.rtTomatoMeter}% Rotten Tomatoes`);const l=[...t,...r].filter(Boolean).join(" · ");return l?`${e.title} (${l})`:e.title},T="movi_swipe_event_queue_v1";function le(e){if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function D(){return le(typeof localStorage<"u"?localStorage.getItem(T):null)}function ue(e){if(typeof localStorage>"u")return;const t=D();t.push({...e,queuedAt:Date.now()});const r=t.slice(-200);localStorage.setItem(T,JSON.stringify(r))}function ce(e){if(typeof localStorage>"u"||!e.length)return;const t=new Set(e),r=D().filter(l=>!l.clientEventId||!t.has(l.clientEventId));localStorage.setItem(T,JSON.stringify(r))}function de(e){return"combined"}function fe(e){if(!e)return null;const t=e.replace("-","_");return t==="for_you"?"for-you":t==="friends"?"from-friends":t==="trending"?"trending":t==="popular"?"popular":t==="explore"?"explore":t==="combined"?"combined":null}function O(e){return e==="like"?"like":e==="dislike"?"dislike":"skip"}function C(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():ne()}function me(e){const t=typeof e.posterUrl=="string"?e.posterUrl.trim():"",r=(t&&t.toLowerCase()!=="n/a"?t:"")||(e.tmdbPosterPath?q(e.tmdbPosterPath,"w500")??"":"")||(e.tmdbBackdropPath?q(e.tmdbBackdropPath,"w780")??"":"");if(!r)return null;const l=(e.title??"").trim()||"Untitled";return{...e,posterUrl:r,title:l}}function pe(e,t){if(typeof window>"u"||t<=0||navigator.connection?.saveData)return;const b=window.requestIdleCallback??(m=>window.setTimeout(m,300)),x=e.slice(0,t);b(()=>{for(const m of x){if(!m.posterUrl)continue;const p=new Image;p.decoding="async",p.loading="lazy",p.src=m.posterUrl}})}function Ie(e,t){const r=t?.limit??60,l=t?.prefetchImages??6,b=t?.dwellThresholdMs??1200,x=t?.dwellDebounceMs??8e3,m=t?.invalidateHomeQueries??!1,p=V();o.useEffect(()=>{let n=!1;const s=async()=>{if(n)return;const c=D();if(!c.length)return;const d=[];for(const h of c)try{(await _(h)).ok&&h.clientEventId&&d.push(h.clientEventId)}catch{break}d.length&&ce(d)};s();const i=()=>void s();return window.addEventListener("online",i),()=>{n=!0,window.removeEventListener("online",i)}},[]);const u=o.useMemo(()=>Z(),[]),y=o.useMemo(()=>de(),[e]),F=o.useRef(new Set),v=o.useRef(!1),M=o.useRef(0),U=o.useRef(null),N=o.useRef(new Set),j=o.useRef(new Map),[w,K]=o.useState({status:"idle",cards:[],errorMessage:null}),[E,A]=o.useState(null),f=o.useCallback(n=>{K(s=>typeof n=="function"?n(s):n)},[]),P=o.useCallback(n=>{if(!n.length)return 0;const s=F.current,i=[];for(const c of n){if(s.has(c.id))continue;const d=me(c);s.add(c.id),d&&i.push(d)}return i.length?(f(c=>{const d={...c,status:"ready",cards:[...c.cards,...i],errorMessage:null};return pe(i,l),d}),i.length):0},[l,f]),S=o.useCallback(async(n=r)=>{if(!v.current){v.current=!0,f(s=>({...s,status:s.cards.length?"ready":"loading",errorMessage:null}));try{const s=t?.kindFilter??null,i=t?.seed??ee(u,y,s);U.current!==i&&(U.current=i,M.current=0);const c=3;let d=0,h=0;for(;d<c&&h===0;){const I=`${i}:${M.current}`;M.current+=1;const $=await te({sessionId:u,mode:y,kindFilter:s??void 0,limit:n,seed:I},{timeoutMs:25e3}),G=$.deckId,B=($.cards??[]).map((k,X)=>({...k,id:k.mediaItemId,deckId:G,position:X,source:fe(k.source??e)}));if(!B.length){f(k=>({...k,status:k.cards.length?"ready":"exhausted",errorMessage:null}));return}if(h=P(B),h>0)break;d+=1,console.warn("[useMediaSwipeDeck] filtered out all cards (missing OMDb poster?). Retrying...",{attempt:d,mode:y,kind:e,batchSize:n})}h===0&&f(I=>({...I,status:I.cards.length?"ready":"exhausted",errorMessage:null}))}catch(s){const i=s instanceof Error?s.message:typeof s=="string"?s:"We couldn't load swipe cards.";f(c=>({...c,status:"error",errorMessage:i}))}finally{v.current=!1}}},[P,r,y,t?.kindFilter,t?.seed,u,f]);o.useEffect(()=>{F.current=new Set,N.current=new Set,j.current=new Map,v.current=!1,f({status:"loading",cards:[],errorMessage:null}),S(r)},[S,e,r,t?.kindFilter,f]);const Q=o.useCallback(()=>{t?.seed==null&&re(u,y,t?.kindFilter??null),M.current=0,F.current=new Set,N.current=new Set,j.current=new Map,v.current=!1,f({status:"loading",cards:[],errorMessage:null}),S(r)},[S,r,y,t?.kindFilter,t?.seed,u,f]),J=o.useCallback(n=>{n<=0||f(s=>({...s,cards:s.cards.slice(Math.min(n,s.cards.length))}))},[f]),g=ae({mutationFn:async n=>_(n,{timeoutMs:2e4}),onError:(n,s)=>{const i=n instanceof Error?n.message:typeof n=="string"?n:"We couldn't save that action.";ue(s),A({payload:s,message:i})},onSuccess:()=>{A(null),m&&(p.invalidateQueries({queryKey:L.homeFeed(null)}),p.invalidateQueries({queryKey:L.homeForYou(null)}))}}),W=o.useCallback((n,s)=>{if(!n)return;const i=`${n.deckId}:${n.id}`;N.current.has(i)||(N.current.add(i),g.mutate({sessionId:u,deckId:n.deckId,position:s??n.position,mediaItemId:n.id,eventType:"impression",source:n.source??null,clientEventId:C()}))},[g,u]),z=o.useCallback((n,s,i)=>{if(!n||!Number.isFinite(s)||s<b)return;const c=`${n.deckId}:${n.id}`,d=Date.now(),h=j.current.get(c)??0;d-h<x||(j.current.set(c,d),g.mutate({sessionId:u,deckId:n.deckId,position:i??n.position,mediaItemId:n.id,eventType:"dwell",dwellMs:Math.round(s),source:n.source??null,clientEventId:C()}))},[x,b,g,u]),H=o.useCallback(n=>{const s=n.card;g.mutate({sessionId:u,deckId:s.deckId,position:s.position,mediaItemId:s.id,eventType:O(n.direction),source:s.source??null,clientEventId:C()})},[g,u]),Y=o.useCallback(async n=>{const s=n.card;return g.mutateAsync({sessionId:u,deckId:s.deckId,position:s.position,mediaItemId:s.id,eventType:O(n.direction),source:s.source??null,clientEventId:C()})},[g,u]);return{sessionId:u,mode:y,cards:w.cards,status:w.status,isLoading:w.status==="loading",isError:w.status==="error",isExhausted:w.status==="exhausted",deckError:w.errorMessage??null,fetchMore:S,refresh:Q,trimConsumed:J,trackImpression:W,trackDwell:z,swipe:H,swipeAsync:Y,swipeSyncError:E?.message??null,retryFailedSwipe:()=>{E&&g.mutate(E.payload)},isRetryingSwipe:g.isPending&&!!E}}const Me=({message:e,onRetry:t,isRetrying:r})=>e?a.jsx("div",{className:"mx-3 mb-3 rounded-md border border-amber-500/60 bg-amber-500/10 px-3 py-2 text-xs text-amber-50",children:a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(R,{name:"error",className:"mt-0.5 text-[18px]",ariaLabel:"Error"}),a.jsxs("div",{className:"flex flex-1 flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[a.jsx("p",{className:"leading-snug",children:e}),a.jsxs(se,{type:"button",variant:"outline",size:"sm",onClick:t,disabled:r,children:[a.jsx(R,{name:"refresh",className:"text-[18px]",ariaLabel:"Retry"}),r?"Retrying…":"Retry"]})]})]})}):null,Ne=({card:e,metaLine:t,highlightLabel:r})=>a.jsxs("div",{className:"space-y-2 text-left leading-relaxed","aria-label":"Swipe card summary",children:[a.jsx("div",{className:"flex items-start justify-between gap-3",children:a.jsxs("div",{className:"min-w-0 space-y-1",children:[a.jsx("h2",{className:"line-clamp-2 text-2xl font-heading font-semibold text-foreground",children:e.title}),t&&a.jsx("p",{className:"truncate text-xs text-muted-foreground/90",children:t}),r&&a.jsx("p",{className:"text-xs font-medium text-primary/90",children:r})]})}),e.tagline&&!e.tagline.trim().startsWith("Plot")&&a.jsx("p",{className:"line-clamp-2 text-xs text-muted-foreground/90",children:e.tagline})]}),je=({title:e})=>a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-gradient-to-br from-background via-card to-background text-center",children:a.jsxs("div",{className:"flex flex-col items-center gap-2 text-muted-foreground",children:[a.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-2xl bg-card/70 shadow-md",children:a.jsx(R,{name:"image_not_supported",className:"text-[24px] text-muted-foreground"})}),a.jsx("span",{className:"text-[12px] font-semibold",children:"Artwork unavailable"}),e&&a.jsxs("span",{className:"max-w-[240px] truncate text-xs text-muted-foreground/80",children:["for ",e]})]})});function ge(e){const t=e.trim().split(/\s+/).filter(Boolean);if(!t.length)return"?";const r=t[0]?.[0]??"?",l=t.length>1?t[t.length-1]?.[0]??"":"";return(r+l).toUpperCase()}function Ee({profiles:e,max:t=3,size:r=28}){const l=Array.isArray(e)?e.filter(Boolean):[];if(!l.length)return null;const b=l.slice(0,Math.max(1,t)),x=l.length-b.length;return a.jsx("div",{className:"relative flex items-center",children:a.jsxs("div",{className:"flex -space-x-2",children:[b.map(m=>{const p=(m.display_name??m.username??"").trim(),u=ge(p||"friend");return a.jsx("div",{className:"grid place-items-center overflow-hidden rounded-full border border-background bg-muted text-[11px] font-semibold text-foreground shadow-sm",style:{width:r,height:r},title:p||"Friend","aria-label":p||"Friend",children:m.avatar_url?a.jsx("img",{src:m.avatar_url,alt:p||"Friend avatar",className:"h-full w-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):a.jsx("span",{children:u})},m.id)}),x>0&&a.jsxs("div",{className:"grid place-items-center rounded-full border border-background bg-muted text-[11px] font-semibold text-foreground shadow-sm",style:{width:r,height:r},title:`${x} more`,"aria-label":`${x} more`,children:["+",x]})]})})}export{Ne as C,Ee as F,R as M,je as P,Me as S,we as a,Se as b,ie as c,be as d,ke as e,ye as f,ve as g,oe as s,Ie as u};
