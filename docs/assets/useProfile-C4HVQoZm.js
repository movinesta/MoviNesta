import{k as m,l as p,s as n}from"./index-C0YC7Lqk.js";const h=o=>/^https?:\/\//i.test(o),g=o=>{try{const r=new URL(o);return r.hostname.endsWith(".supabase.co")||r.hostname==="localhost"||r.hostname==="127.0.0.1"}catch{return!1}};async function y(o){if(!o)return null;if(h(o))return g(o)?o:null;const{data:r,error:e}=await n.storage.from("avatars").createSignedUrl(o,3600);return e||!r?.signedUrl?null:r.signedUrl}const d=o=>o?.code==="PGRST116",q=o=>{if(!o)return null;const r=o.trim();return r?r.startsWith("@")?r.slice(1):r:null},U=o=>{const{user:r}=m(),e=q(o);return p({queryKey:["profile","byUsername",e,r?.id??null],enabled:!!e,queryFn:async()=>{if(!e)return null;const{data:t,error:s}=await n.from("profiles_public").select("id, username, display_name, avatar_url, bio").eq("username",e).maybeSingle();if(s)throw d(s)?new Error("Profile not found"):s;if(!t)throw new Error("Profile not found");const l=t.id,i=await y(t.avatar_url),[{count:u,error:a},{count:_,error:c}]=await Promise.all([n.from("follows").select("followed_id",{count:"exact",head:!0}).eq("followed_id",l),n.from("follows").select("follower_id",{count:"exact",head:!0}).eq("follower_id",l)]);if(a)throw a;if(c)throw c;let w=!1;if(r&&r.id!==l){const{data:b,error:f}=await n.from("follows").select("follower_id").eq("follower_id",r.id).eq("followed_id",l).maybeSingle();if(f&&!d(f))throw f;w=!!b}return{id:l,username:t.username,displayName:t.display_name,avatarUrl:i,bio:t.bio,followersCount:u??0,followingCount:_??0,isFollowing:w,isCurrentUser:!!r&&r.id===l}}})},C=()=>{const{user:o}=m();return p({queryKey:["profile","current",o?.id??null],enabled:!!o,queryFn:async()=>{if(!o)return null;const{data:r,error:e}=await n.from("profiles").select("id, username, display_name, avatar_url, bio").eq("id",o.id).maybeSingle();if(e)throw d(e)?new Error("Profile not found for current user"):e;if(!r)throw new Error("Profile not found for current user");const t=r.id,s=await y(r.avatar_url),{data:l,error:i}=await n.from("user_stats").select("followers_count, following_count").eq("user_id",t).maybeSingle();if(i)throw i;const u=l?.followers_count??0,a=l?.following_count??0;return{id:t,username:r.username,displayName:r.display_name,avatarUrl:s,bio:r.bio,followersCount:u,followingCount:a,isFollowing:!1,isCurrentUser:!0}}})};export{C as a,U as u};
