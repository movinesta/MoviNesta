import{c as k,e as q,s as b,v as K,b as $,d as V,w as W,u as Z,x as J,R as j,j as e,B as g,M as X,o as ee}from"./index-yaS868vE.js";import{D as te,a as se,b as re,c as ae,d as ie,e as oe}from"./dialog-D7Egbaxy.js";import{I as ne}from"./input-eTUG8pOx.js";import{D as le,a as de,b as ce,c as P,d as ue}from"./dropdown-menu-DMnOHk4s.js";import{u as me}from"./useToggleFollow-18dQkAwo.js";import{u as xe}from"./useDiaryLibrary-COWbuwqZ.js";import{D as ge,a as fe}from"./DiaryStatsTab-DQ-llg89.js";import{u as he,U as pe,E as be,C as ye}from"./useSuggestedPeople-CHfmdrWi.js";import{u as we}from"./useMutation-WGdhQwN_.js";import{T as je}from"./TopBar-DVbOlr27.js";import{M as ve}from"./menu-COpKWmYE.js";import{P as D}from"./plus-CZNhlY8I.js";import{C as Ne}from"./chevron-right-CGJTX8kZ.js";import"./index-DQ8Wqi_L.js";import"./index-B227mAYG.js";import"./index-6Jf4GuQ-.js";import"./index-3WBCh0tp.js";import"./format-DMUSBM01.js";import"./film-Did84F3L.js";import"./sparkles-DDv2xrV5.js";import"./users-DGRv-nuh.js";import"./bookmark-plus-GAFQs7EE.js";import"./star-BfXtR-rq.js";import"./resolveAvatarUrl-Bv46IzST.js";const _e=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],Ce=k("chevron-down",_e);const ke=[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]],Pe=k("layout-grid",ke);const Fe=[["rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",key:"h1oib"}],["path",{d:"M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z",key:"kmsa83"}]],Se=k("square-play",Fe);const Te=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],Ee=k("tag",Te),Ue=r=>q({queryKey:["profile","post-count",r],enabled:!!r,staleTime:1e3*60,queryFn:async()=>{if(!r)return 0;const{count:i,error:l}=await b.from("activity_events").select("id",{count:"exact",head:!0}).eq("user_id",r).in("event_type",["rating_created","review_created","watchlist_added","watchlist_removed","list_created","list_item_added"]);return l?(console.warn("[useProfilePostCount] Failed to count posts",l.message),0):i??0}}),De=(r,i)=>q({queryKey:["profile","highlights",r,i],enabled:!!r,staleTime:1e3*30,queryFn:async()=>{if(!r)return[];let l=b.from("lists").select("id, name, is_public, updated_at, created_at").eq("user_id",r).order("updated_at",{ascending:!1}).order("created_at",{ascending:!1}).limit(12);i||(l=l.eq("is_public",!0));const{data:s,error:d}=await l;if(d)throw new Error(d.message);const h=s??[];if(!h.length)return[];const y=h.map(a=>a.id),{data:c,error:w}=await b.from("list_items").select("list_id, title_id, position, created_at").in("list_id",y).order("position",{ascending:!0,nullsFirst:!0}).order("created_at",{ascending:!0}).limit(240);w&&console.warn("[useProfileHighlights] Failed to load list_items",w.message);const n=new Map;for(const a of c??[])!a?.list_id||!a?.title_id||n.has(a.list_id)||n.set(a.list_id,a.title_id);const x=Array.from(new Set(Array.from(n.values()))),o=new Map;if(x.length){const{data:a,error:m}=await b.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",x);if(m)console.warn("[useProfileHighlights] Failed to load media_items",m.message);else for(const p of a??[]){const v=K(p);o.set(p.id,v.posterUrl??v.backdropUrl??null)}}return h.map(a=>{const m=n.get(a.id)??null,p=m?o.get(m)??null:null;return{id:a.id,name:a.name,isPublic:!!a.is_public,coverPosterUrl:p}})}}),Me=()=>{const{user:r}=$(),i=V();return we({mutationFn:async({name:l,autoFillTopMovies:s=!0})=>{if(!r?.id)throw new Error("You need to be signed in.");const d=l.trim();if(!d)throw new Error("Please enter a name.");const{data:h,error:y}=await b.from("lists").insert({user_id:r.id,name:d,is_public:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select("id").single();if(y)throw new Error(y.message);const c=h?.id;if(!c)throw new Error("Failed to create highlight.");if(s){const{data:w,error:n}=await b.from("ratings").select("title_id, content_type, rating, updated_at").eq("user_id",r.id).order("rating",{ascending:!1}).order("updated_at",{ascending:!1}).limit(10);if(n)console.warn("[useCreateHighlight] Failed to load ratings",n.message);else{const o=(w??[]).filter(a=>!!a.title_id).slice(0,10).map((a,m)=>({list_id:c,title_id:a.title_id,content_type:a.content_type,position:m+1,created_at:new Date().toISOString()}));if(o.length){const{error:a}=await b.from("list_items").insert(o);a&&console.warn("[useCreateHighlight] Failed to insert list_items",a.message)}}}return{listId:c}},onSuccess:()=>{i.invalidateQueries({queryKey:["profile","highlights"]}),i.invalidateQueries({queryKey:["diary","timeline"]})}})},Ie=r=>r?r.startsWith("@")?r:`@${r}`:null,M=(r,i)=>{const s=(r||i||"").replace(/^@/,"").trim();if(!s)return"?";const d=s.split(/\s+/);return d.length===1?d[0].slice(0,2).toUpperCase():(d[0][0]+d[1][0]).toUpperCase()},I=async(r,i)=>{try{if(typeof navigator<"u"&&"share"in navigator){await navigator.share({title:r,url:i});return}}catch{}try{await navigator.clipboard.writeText(i)}catch{}},ot=()=>{const{username:r}=W(),i=Z(),{user:l}=$(),{data:s,isLoading:d,isError:h,error:y}=J(r??""),c=me(),{data:w=0}=Ue(s?.id),[n,x]=j.useState("grid");j.useEffect(()=>x("grid"),[r]);const o=!!s?.isCurrentUser,a=s?.displayName||s?.username||"Profile",m=Ie(s?.username),{data:p=[],isLoading:v}=xe(s?.id),{data:B=[],dismissPerson:L}=he(),R=B.slice(0,8),{data:H=[],isLoading:A}=De(s?.id,o),N=Me(),[O,_]=j.useState(!1),[F,z]=j.useState("Top movies"),[S,Q]=j.useState(!0),[Y,T]=j.useState(!1),G=async t=>{if(!l?.id){alert("You need to be signed in to start a conversation.");return}if(l.id===t){alert("You can't start a conversation with yourself.");return}T(!0);try{const u=await ee("create-direct-conversation",{targetUserId:t},{timeoutMs:25e3});if(!u?.ok||!u.conversationId){const f=u?.code;let C=u?.error??"Failed to get conversation id. Please try again.";throw f==="UNAUTHORIZED"?C="You need to be signed in to start a conversation.":f==="BAD_REQUEST_SELF_TARGET"?C="You can't start a conversation with yourself.":f==="SERVER_MISCONFIGURED"&&(C="Messaging is temporarily unavailable due to a server issue. Please try again later."),new Error(C)}i(`/messages/${u.conversationId}`)}catch(u){console.error("[ProfilePage] Failed to start conversation",u);const f=u instanceof Error?u.message:"Something went wrong while starting the conversation. Please try again.";alert(f)}finally{T(!1)}};if(d)return e.jsx("div",{className:"flex flex-1 items-center justify-center py-12 text-sm text-muted-foreground",children:"Loading profile…"});if(h||!s)return e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-12",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-destructive/40 bg-destructive/5 p-4 text-center text-xs text-foreground shadow-lg",children:[e.jsx("p",{className:"font-semibold",children:"Unable to load this profile."}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:y?.message??"Please try again in a moment."})]})});const E=`${window.location.origin}/u/${s.username??r??""}`,U=c.isPending&&c.variables?.targetUserId===s.id;return e.jsxs("div",{className:"flex flex-1 flex-col pb-24",children:[e.jsx(je,{title:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[s?.username??a,o?e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"}):null]}),actions:o?[{icon:ve,label:"Profile menu",onClick:()=>i("/settings")}]:void 0}),e.jsxs("section",{className:"px-3 pt-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-20 w-20 overflow-hidden rounded-full border-2 border-primary/40 bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:a,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-sm font-semibold text-foreground",children:M(s.displayName,s.username)})}),o&&e.jsx("div",{className:"absolute -top-6 left-0 rounded-full bg-muted/90 px-3 py-1 text-[11px] text-muted-foreground shadow",children:"What's on your mind?"}),o&&e.jsx("button",{type:"button",onClick:()=>i("/search?tab=titles"),className:"absolute -bottom-1 -right-1 inline-flex h-8 w-8 items-center justify-center rounded-full border border-background bg-primary text-primary-foreground shadow","aria-label":"New diary entry",children:e.jsx(D,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("div",{className:"flex flex-1 items-center justify-between gap-2",children:e.jsxs("div",{className:"flex flex-1 justify-around gap-2",children:[e.jsxs("button",{type:"button",className:"text-center",onClick:()=>x("grid"),"aria-label":"View posts",children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:w}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"posts"})]}),e.jsxs("button",{type:"button",className:"text-center",onClick:()=>{const t=s.username??r;t&&i(`/u/${t}/followers`)},"aria-label":"View followers",children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:s.followersCount}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"followers"})]}),e.jsxs("button",{type:"button",className:"text-center",onClick:()=>{const t=s.username??r;t&&i(`/u/${t}/following`)},"aria-label":"View following",children:[e.jsx("p",{className:"text-base font-semibold text-foreground",children:s.followingCount}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"following"})]})]})})]}),e.jsxs("div",{className:"mt-3",children:[m&&e.jsx("p",{className:"text-xs text-muted-foreground",children:m}),s.bio&&e.jsx("p",{className:"mt-1 text-sm text-foreground",children:s.bio})]}),e.jsx("div",{className:"mt-4 flex items-center gap-2",children:o?e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",variant:"secondary",className:"h-10 flex-1 rounded-full bg-muted text-foreground hover:bg-muted/80",onClick:()=>i("/settings/profile"),children:"Edit profile"}),e.jsx(g,{type:"button",variant:"secondary",className:"h-10 flex-1 rounded-full bg-muted text-foreground hover:bg-muted/80",onClick:()=>I("My profile",E),children:"Share profile"}),e.jsx(g,{type:"button",size:"icon",variant:"secondary",className:"h-10 w-10 rounded-full bg-muted text-foreground hover:bg-muted/80",onClick:()=>i("/suggested-people"),"aria-label":"Suggested people",children:e.jsx(pe,{className:"h-4 w-4","aria-hidden":"true"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",className:"h-10 flex-1 rounded-full",variant:s.isFollowing?"secondary":"default",disabled:U,onClick:()=>c.mutate({targetUserId:s.id,currentlyFollowing:s.isFollowing}),children:U?"…":s.isFollowing?"Following":"Follow"}),e.jsxs(g,{type:"button",variant:"secondary",className:"h-10 flex-1 rounded-full bg-muted text-foreground hover:bg-muted/80",disabled:Y,onClick:()=>G(s.id),children:[e.jsx(X,{className:"h-4 w-4","aria-hidden":"true"}),"Message"]}),e.jsxs(le,{children:[e.jsx(de,{asChild:!0,children:e.jsx(g,{type:"button",size:"icon",variant:"secondary",className:"h-10 w-10 rounded-full bg-muted text-foreground hover:bg-muted/80","aria-label":"More",children:e.jsx(be,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsxs(ce,{align:"end",className:"w-44",children:[e.jsxs(P,{onClick:()=>I(`${a}`,E),children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"Copy link"]}),e.jsx(ue,{}),e.jsx(P,{disabled:!0,children:"Report"}),e.jsx(P,{disabled:!0,children:"Block"})]})]})]})})]}),e.jsxs("section",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between px-3",children:[e.jsx("h2",{className:"text-sm font-semibold text-foreground",children:"Discover people"}),e.jsxs("button",{type:"button",onClick:()=>i("/suggested-people"),className:"inline-flex items-center gap-1 text-xs font-medium text-primary",children:["See all ",e.jsx(Ne,{className:"h-4 w-4","aria-hidden":"true"})]})]}),e.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto px-3 pb-1",children:R.map(t=>{const u=t.displayName||t.username||"User",f=c.isPending&&c.variables?.targetUserId===t.id;return e.jsxs("div",{className:"relative w-44 flex-shrink-0 overflow-hidden rounded-2xl border border-border bg-card/80 p-3 shadow-lg",children:[e.jsx("button",{type:"button",onClick:()=>L(t.id),className:"absolute right-2 top-2 inline-flex h-8 w-8 items-center justify-center rounded-full text-muted-foreground hover:bg-muted hover:text-foreground","aria-label":"Dismiss suggestion",children:"×"}),e.jsxs("button",{type:"button",onClick:()=>t.username&&i(`/u/${t.username}`),className:"flex w-full flex-col items-center",children:[t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:u,className:"h-16 w-16 rounded-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-muted text-sm font-semibold text-foreground",children:M(t.displayName,t.username)}),e.jsx("p",{className:"mt-2 w-full truncate text-center text-sm font-semibold text-foreground",children:u}),e.jsx("p",{className:"w-full truncate text-center text-xs text-muted-foreground",children:typeof t.commonTitlesCount=="number"&&t.commonTitlesCount>0?`${t.commonTitlesCount} in common`:"Suggested for you"})]}),e.jsx(g,{type:"button",className:"mt-3 h-9 w-full rounded-full",disabled:f,variant:t.isFollowing?"secondary":"default",onClick:()=>c.mutate({targetUserId:t.id,currentlyFollowing:t.isFollowing}),children:f?"…":t.isFollowing?"Following":"Follow"})]},t.id)})})]}),e.jsx("section",{className:"mt-5",children:e.jsxs("div",{className:"flex gap-3 overflow-x-auto px-3 pb-2",children:[o&&e.jsxs("button",{type:"button",onClick:()=>_(!0),className:"flex flex-col items-center gap-1.5",children:[e.jsx("span",{className:"flex h-14 w-14 items-center justify-center rounded-full border border-border bg-card/80",children:e.jsx(D,{className:"h-6 w-6","aria-hidden":"true"})}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:"New"})]}),A&&e.jsx("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:"Loading…"}),H.map(t=>e.jsxs("button",{type:"button",onClick:()=>i(`/lists/${t.id}`),className:"flex flex-col items-center gap-1.5",children:[e.jsx("span",{className:"h-14 w-14 overflow-hidden rounded-full border border-border bg-muted",children:t.coverPosterUrl?e.jsx("img",{src:t.coverPosterUrl,alt:t.name,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"flex h-full w-full items-center justify-center text-xs text-muted-foreground",children:t.name.slice(0,2).toUpperCase()})}),e.jsx("span",{className:"max-w-[64px] truncate text-[10px] text-muted-foreground",children:t.name})]},t.id))]})}),e.jsxs("section",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-around border-y border-border",children:[e.jsx("button",{type:"button",onClick:()=>x("grid"),className:"flex flex-1 items-center justify-center py-3 border-b-2 transition "+(n==="grid"?"text-foreground border-foreground":"text-muted-foreground border-transparent"),"aria-label":"Grid",children:e.jsx(Pe,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:()=>x("timeline"),className:"flex flex-1 items-center justify-center py-3 border-b-2 transition "+(n==="timeline"?"text-foreground border-foreground":"text-muted-foreground border-transparent"),"aria-label":"Timeline",children:e.jsx(Se,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:()=>o&&x("stats"),className:"flex flex-1 items-center justify-center py-3 border-b-2 transition "+(n==="stats"?"text-foreground border-foreground":"text-muted-foreground border-transparent")+(o?"":" opacity-40 pointer-events-none"),"aria-label":"Stats",disabled:!o,children:e.jsx(Ee,{className:"h-5 w-5","aria-hidden":"true"})})]}),n==="grid"&&e.jsx("div",{className:"px-2 pb-4",children:v?e.jsx("div",{className:"px-2 py-6 text-xs text-muted-foreground",children:"Loading library…"}):p.length===0?e.jsx("div",{className:"flex min-h-[30vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-border bg-card/80 p-5 text-center text-xs text-muted-foreground shadow-lg",children:[e.jsx("p",{className:"font-heading text-sm font-semibold text-foreground",children:"No titles yet"}),e.jsx("p",{className:"mt-1 text-xs",children:o?"Start rating titles and your library will appear here.":"When they add titles to their diary, they’ll show up here."})]})}):e.jsx("div",{className:"grid grid-cols-3 gap-1",children:p.map(t=>e.jsx("button",{type:"button",className:"overflow-hidden rounded-md border border-border bg-muted/30",onClick:()=>i(`/title/${t.titleId}`),children:t.posterUrl?e.jsx("img",{src:t.posterUrl,alt:t.title??"Title",className:"aspect-[2/3] w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"aspect-[2/3] w-full bg-muted"})},t.titleId))})}),n==="timeline"&&e.jsx(ge,{userId:s.id,isOwnProfile:o,displayName:s.displayName,username:s.username}),n==="stats"&&o&&e.jsx(fe,{})]}),e.jsx(te,{open:O,onOpenChange:_,children:e.jsxs(se,{children:[e.jsxs(re,{children:[e.jsx(ae,{children:"New highlight"}),e.jsx(ie,{children:'Create a saved list that shows up on your profile. "Top movies" works great as a starting point.'})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-foreground",children:"Name"}),e.jsx(ne,{value:F,onChange:t=>z(t.target.value),placeholder:"Top movies",className:"mt-1"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:t=>Q(t.target.checked)}),"Auto-fill with your top rated movies"]})]}),e.jsxs(oe,{children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>_(!1),disabled:N.isPending,children:"Cancel"}),e.jsx(g,{type:"button",onClick:()=>N.mutate({name:F,autoFillTopMovies:S},{onSuccess:({listId:t})=>{_(!1),i(`/lists/${t}`)}}),disabled:N.isPending,children:N.isPending?"Creating…":"Create"})]})]})})]})};export{ot as default};
