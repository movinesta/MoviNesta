import{b as C,c as P,s as h,d as R,m as q,u as E,R as B,j as t,i as V,B as N}from"./index-n01z0Q-I.js";import{T as L}from"./TopBar-CK7Fj6a4.js";import{V as M}from"./VerifiedBadge-BK7Fjn_d.js";import{u as z}from"./useToggleFollow-BHNH-TO0.js";import{C as O}from"./chevron-right-Bi8prcFZ.js";import{X as U}from"./x-CfKoriA-.js";import"./arrow-left-fJ-4-sS7.js";const A=s=>{if(!s)return null;const i=s.trim();return i?i.startsWith("@")?i:`@${i}`:null},Y=(s,i=80)=>{const a=s.trim().replace(/\s+/g," ");return a.length<=i?a:`${a.slice(0,i-1)}…`};async function W(s){if(!s.length)return new Map;const{data:i,error:a}=await h.from("profiles_public").select("id, username, display_name, avatar_url, is_verified, verified_type, verified_label, verified_at, verified_by_org").in("id",s);if(a)throw new Error(a.message);const u=i??[],c=new Map(u.map(r=>[r.id,r])),l=await Promise.all(s.map(async r=>{const n=c.get(r),w=await R(n?.avatar_url??null);return[r,w]})),d=new Map(l),p=new Map;return s.forEach(r=>{const n=c.get(r);p.set(r,{id:r,username:n?.username??null,displayName:n?.display_name??null,avatarUrl:d.get(r)??null,isVerified:n?.is_verified??null,verifiedType:n?.verified_type??null,verifiedLabel:n?.verified_label??null,verifiedAt:n?.verified_at??null,verifiedByOrg:n?.verified_by_org??null})}),p}async function H(s){const i=Array.from(new Set(s)).filter(Boolean);if(!i.length)return new Map;const{data:a,error:u}=await h.from("media_items").select(`id,
       kind,
       tmdb_title,
       tmdb_name,
       tmdb_original_title,
       tmdb_original_name,
       tmdb_release_date,
       tmdb_first_air_date,
       tmdb_poster_path,
       tmdb_backdrop_path,
       tmdb_original_language,
       omdb_title,
       omdb_year,
       omdb_language,
       omdb_imdb_id,
       omdb_imdb_rating,
       omdb_rating_rotten_tomatoes,
       omdb_poster,
       omdb_rated,
       tmdb_id`).in("id",i);if(u)return console.warn("[useActivityNotifications] Failed to load media_items",u.message),new Map;const c=new Map;return a?.forEach(l=>{const d=q(l);c.set(l.id,d.posterUrl??d.backdropUrl??null)}),c}function K(){const{user:s}=C(),i=s?.id??null;return P({queryKey:["activity","notifications",i],enabled:!!i,staleTime:1e3*30,queryFn:async()=>{if(!i)return{notifications:[],peopleYouDontFollowBack:[]};const{data:a,error:u}=await h.from("follows").select("follower_id, created_at").eq("followed_id",i).order("created_at",{ascending:!1}).limit(80);if(u)throw new Error(u.message);const c=a??[],l=Array.from(new Set(c.map(o=>o.follower_id).filter(Boolean)));let d=new Set;if(l.length){const{data:o,error:f}=await h.from("follows").select("followed_id").eq("follower_id",i).in("followed_id",l);f||(d=new Set((o??[]).map(v=>v.followed_id)))}const{data:p,error:r}=await h.from("comments").select("id, user_id, body, created_at, review_id, reviews!inner(user_id, title_id)").eq("reviews.user_id",i).order("created_at",{ascending:!1}).limit(80);r&&console.warn("[useActivityNotifications] Failed to load comments",r.message);const n=p??[],w=Array.from(new Set(n.map(o=>o.user_id).filter(Boolean))),y=Array.from(new Set([...l,...w])),g=await W(y),_=n.map(o=>o.reviews?.title_id).filter(o=>typeof o=="string"&&o.length>0),j=await H(_),e=c.flatMap(o=>{const f=g.get(o.follower_id);if(!f)return[];const v=A(f.username),k=f.displayName||v||"Someone",x=d.has(f.id);return[{id:`follow:${o.follower_id}:${o.created_at}`,kind:"follow",createdAt:o.created_at,actor:f,text:`${k} started following you.`,linkTo:f.username?`/u/${f.username}`:void 0,canFollowBack:!0,isFollowingBack:x}]}),m=n.flatMap(o=>{const f=g.get(o.user_id);if(!f)return[];const v=A(f.username),k=f.displayName||v||"Someone",x=o.reviews?.title_id??null,D=x?j.get(x)??null:null;return[{id:`comment:${o.id}`,kind:o.review_id?"comment":"reply",createdAt:o.created_at,actor:f,text:`${k} commented: “${Y(o.body)}”`,thumbnailUrl:D,linkTo:x?`/title/${x}`:void 0}]}),b=[...e,...m].sort((o,f)=>o.createdAt<f.createdAt?1:-1),$=l.filter(o=>!d.has(o)).map(o=>g.get(o)).filter(o=>!!o);return{notifications:b,peopleYouDontFollowBack:$}}})}const Q=s=>{const i=new Date(s),a=Date.now()-i.getTime(),u=Math.floor(a/1e3),c=[[60,"second"],[60,"minute"],[24,"hour"],[7,"day"],[4,"week"],[12,"month"]];let l=u,d="second";for(const[r,n]of c){if(Math.abs(l)<r){d=n;break}l=Math.floor(l/r),d=n}return new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}).format(-l,d)},T=(s,i)=>{const a=new Date(s);return Date.now()-a.getTime()<=i*24*60*60*1e3},S=({actor:s})=>{const i=(s.displayName||s.username||"?").replace(/^@/,"").trim().slice(0,2).toUpperCase();return s.avatarUrl?t.jsx("img",{src:s.avatarUrl,alt:"",className:"h-11 w-11 rounded-full object-cover"}):t.jsx("div",{className:"flex h-11 w-11 items-center justify-center rounded-full bg-muted text-xs font-semibold text-muted-foreground",children:i||"?"})},I=({item:s,onDismiss:i,onOpen:a,onFollowBack:u,followBackState:c})=>{const l=Q(s.createdAt),d=s.actor.displayName||s.actor.username||"Someone";return t.jsxs("div",{className:"soft-row-card flex min-h-11 items-center gap-3 row-pad",children:[t.jsx("button",{type:"button",onClick:a,className:"flex items-center gap-3 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",children:t.jsx(S,{actor:s.actor})}),t.jsx("button",{type:"button",onClick:a,className:"min-w-0 flex-1 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",children:t.jsxs("p",{className:"text-sm text-foreground",children:[t.jsxs("span",{className:"inline-flex items-center gap-1 font-semibold",children:[d,s.actor.isVerified?t.jsx(M,{isVerified:s.actor.isVerified??null,type:s.actor.verifiedType??null,label:s.actor.verifiedLabel??null,verifiedAt:s.actor.verifiedAt??null,org:s.actor.verifiedByOrg??null}):null]})," ",t.jsx("span",{className:"text-muted-foreground",children:s.text.replace(d,"").trim()})," ",t.jsx("span",{className:"text-xs text-muted-foreground",children:l})]})}),t.jsxs("div",{className:"flex items-center gap-2",children:[s.thumbnailUrl?t.jsx("button",{type:"button",onClick:a,className:"h-12 w-12 overflow-hidden rounded-lg bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30","aria-label":"Open",children:t.jsx("img",{src:s.thumbnailUrl,alt:"",className:"h-full w-full object-cover"})}):null,u&&c?t.jsx(N,{size:"sm",className:"h-9 rounded-full px-4",onClick:u,disabled:c.disabled,children:c.label}):null,t.jsx(N,{type:"button",variant:"ghost",size:"icon",onClick:i,"aria-label":"Dismiss",className:"icon-hit",children:t.jsx(U,{className:"h-4 w-4","aria-hidden":!0})})]})]})},F=({title:s,children:i})=>t.jsxs("section",{className:"space-y-2",children:[t.jsx("h2",{className:"px-1 pt-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:s}),t.jsx("div",{className:"flex flex-col gap-2",children:i})]}),ie=()=>{const s=E(),{data:i,isLoading:a,isError:u,error:c}=K(),l=z(),[d,p]=B.useState(new Set),r=B.useMemo(()=>(i?.notifications??[]).filter(m=>!d.has(m.id)),[i?.notifications,d]),n=i?.peopleYouDontFollowBack??[],w=r.filter(e=>T(e.createdAt,30)),y=r.filter(e=>!T(e.createdAt,30)),g=e=>{p(m=>new Set(m).add(e))},_=e=>{e.linkTo&&s(e.linkTo)},j=e=>{l.mutate({targetUserId:e.actor.id,currentlyFollowing:!!e.isFollowingBack})};return t.jsxs("div",{className:"flex flex-1 flex-col gap-3 bg-background pb-3 text-foreground",children:[t.jsx(L,{title:"Activity"}),t.jsxs("div",{className:"flex flex-1 flex-col gap-2.5 px-[var(--page-pad-x)]",children:[t.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive flex w-full min-h-11 items-center justify-between gap-3 px-[var(--row-pad-x)] py-3 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background",onClick:()=>s("/activity/requests"),children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"h-11 w-11 rounded-full bg-muted"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold",children:"Follow requests"}),t.jsx("div",{className:"text-xs text-muted-foreground",children:n.length?`${n[0]?.displayName||n[0]?.username||"Someone"}${n.length>1?` + ${n.length-1} others`:""}`:"No requests"})]})]}),t.jsx(O,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0})]}),a?t.jsx("div",{className:"px-3 py-6 text-sm text-muted-foreground",children:"Loading…"}):u?t.jsx("div",{className:"px-3 py-6 text-sm text-red-600",children:c?.message||"Failed to load notifications."}):r.length===0&&n.length===0?t.jsx("div",{className:"px-3 py-10 text-center text-sm text-muted-foreground",children:"No notifications yet."}):t.jsxs(t.Fragment,{children:[w.length?t.jsx(F,{title:"Last 30 days",children:w.map(e=>{const m=e.kind==="follow"&&e.canFollowBack,b=e.isFollowingBack?"Following":"Follow back";return t.jsx(I,{item:e,onDismiss:()=>g(e.id),onOpen:()=>_(e),onFollowBack:m?()=>j(e):void 0,followBackState:m?{label:l.isPending&&l.variables?.targetUserId===e.actor.id?"…":b,disabled:l.isPending}:void 0},e.id)})}):null,y.length?t.jsx(F,{title:"Older",children:y.map(e=>{const m=e.kind==="follow"&&e.canFollowBack,b=e.isFollowingBack?"Following":"Follow back";return t.jsx(I,{item:e,onDismiss:()=>g(e.id),onOpen:()=>_(e),onFollowBack:m?()=>j(e):void 0,followBackState:m?{label:l.isPending&&l.variables?.targetUserId===e.actor.id?"…":b,disabled:l.isPending}:void 0},e.id)})}):null,n.length?t.jsx(F,{title:"People you don't follow back",children:n.slice(0,10).map(e=>{const m=`dont-follow-back:${e.id}`;return d.has(m)?null:t.jsxs("div",{className:V("flex items-center gap-3 row-pad"),children:[t.jsxs("button",{type:"button",className:"flex min-w-0 flex-1 items-center gap-3 text-left",onClick:()=>e.username&&s(`/u/${e.username}`),children:[t.jsx(S,{actor:e}),t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 truncate text-sm font-semibold",children:[t.jsx("span",{className:"truncate",children:e.displayName||e.username||"User"}),e.isVerified?t.jsx(M,{isVerified:e.isVerified??null,type:e.verifiedType??null,label:e.verifiedLabel??null,verifiedAt:e.verifiedAt??null,org:e.verifiedByOrg??null}):null]}),t.jsxs("div",{className:"truncate text-xs text-muted-foreground",children:["Followed by"," ",e.username?`@${e.username.replace(/^@/,"")}`:"someone"]})]})]}),t.jsx(N,{size:"sm",className:"h-9 rounded-full px-4",onClick:()=>l.mutate({targetUserId:e.id,currentlyFollowing:!1}),disabled:l.isPending,children:"Follow back"}),t.jsx(N,{type:"button",variant:"ghost",size:"icon",onClick:()=>g(m),"aria-label":"Dismiss",className:"icon-hit",children:t.jsx(U,{className:"h-4 w-4","aria-hidden":!0})})]},e.id)})}):null]})]})]})};export{ie as default};
