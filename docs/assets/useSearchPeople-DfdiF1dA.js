import{b as L,c as S,am as U,s as b,d as C}from"./index-BhYCkKJ1.js";const n=o=>{if(o?.aborted)throw o.reason??new DOMException("Aborted","AbortError")},N=o=>{const t=o.trim().replace(/^@+/,""),s=t.toLowerCase(),{user:u}=L();return S({queryKey:["search","people",{query:t,userId:u?.id??null}],enabled:t.length>=2,placeholderData:U,staleTime:1e3*60*15,gcTime:1e3*60*30,refetchOnWindowFocus:!1,retry:1,queryFn:async({signal:r})=>{n(r);const w=t.replace(/%/g,"\\%").replace(/_/g,"\\_");let d=b.from("profiles_public").select("id, username, display_name, avatar_url, bio, is_verified, verified_type, verified_label, verified_at, verified_by_org").or(`username.ilike.%${w}%,display_name.ilike.%${w}%`).limit(20);r&&(d=d.abortSignal(r));const f=await d;if(n(r),f.error)throw new Error(f.error.message);const c=f.data??[],h=c.map(e=>e.id);let m=new Map;if(h.length){let e=b.from("user_stats").select("user_id, followers_count, following_count").in("user_id",h);r&&(e=e.abortSignal(r));const l=await e;n(r),l.error?console.warn("[useSearchPeople] Failed to load user_stats",l.error.message):m=new Map((l.data??[]).map(a=>[a.user_id,{followersCount:a.followers_count??0,followingCount:a.following_count??0}]))}if(!u?.id)return Promise.all(c.map(async e=>{const l=m.get(e.id);return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:await C(e.avatar_url),bio:e.bio,isVerified:e.is_verified??null,verifiedType:e.verified_type??null,verifiedLabel:e.verified_label??null,verifiedAt:e.verified_at??null,verifiedByOrg:e.verified_by_org??null,followersCount:l?.followersCount??null,followingCount:l?.followingCount??null,isFollowing:!1,matchPercent:null}}));let p=b.from("follows").select("followed_id").eq("follower_id",u.id);r&&(p=p.abortSignal(r));const _=await p;n(r),_.error&&console.warn("[useSearchPeople] Failed to load follows for current user",_.error.message);const A=new Set((_.data??[]).map(e=>e.followed_id)),P=c.map(e=>{const l=m.get(e.id),a=e.username??"",v=e.display_name??"",y=a.toLowerCase(),g=v.toLowerCase();let i=0;y===s?i+=100:y.startsWith(s)?i+=80:g.startsWith(s)?i+=60:y.includes(s)?i+=40:g.includes(s)&&(i+=30);const B=Math.min(15,Math.floor((l?.followersCount??0)/500));return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:e.avatar_url,bio:e.bio,isVerified:e.is_verified??null,verifiedType:e.verified_type??null,verifiedLabel:e.verified_label??null,verifiedAt:e.verified_at??null,verifiedByOrg:e.verified_by_org??null,followersCount:l?.followersCount??null,followingCount:l?.followingCount??null,isFollowing:A.has(e.id),matchPercent:null,relevance:i+B}}).sort((e,l)=>{if(l.relevance!==e.relevance)return l.relevance-e.relevance;const a=(e.displayName??e.username??"").toLowerCase(),v=(l.displayName??l.username??"").toLowerCase();return a.localeCompare(v)}).map(({relevance:e,...l})=>l);return Promise.all(P.map(async e=>({...e,avatarUrl:await C(e.avatarUrl)})))}})};export{N as u};
