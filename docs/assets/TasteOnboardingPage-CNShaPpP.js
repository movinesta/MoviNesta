import{u as F,r,h as z,s as T,af as D,j as e,z as q,ag as B,B as m,S as Q,l as R,t as $}from"./index-DuL1-P9A.js";import{I as A}from"./input-BHrL4aNk.js";import{a as G,u as K}from"./useSearchTitles-Du0BJjZ2.js";import{X as V}from"./x-C4D7SPeX.js";import{C as x}from"./circle-check-CUQoVS_m.js";import{P as k}from"./plus-BSK9vxg7.js";function X(l){const n=l.posterUrl??(l.tmdbPosterPath?$(l.tmdbPosterPath,"w342"):null);return{id:l.mediaItemId,title:l.title??"Untitled",posterUrl:n}}function Y(l){return{id:l.id,title:l.title,posterUrl:l.posterUrl??null}}const C=5,se=()=>{const l=F(),n=r.useMemo(()=>z(),[]),[h,P]=r.useState(""),g=G(h,250),[I,U]=r.useState([]),[M,p]=r.useState(!0),[b,f]=r.useState(null),[d,j]=r.useState({}),i=Object.keys(d).length,[c,N]=r.useState(!1),[v,w]=r.useState(null),o=K({query:g,filters:{type:"all"}}),y=r.useMemo(()=>(o.data?.pages??[]).flatMap(t=>t.results??[]),[o.data]),S=r.useCallback(s=>{j(t=>{const a={...t};return a[s.id]?(delete a[s.id],a):{...a,[s.id]:s}})},[]),O=r.useCallback(s=>{j(t=>{const a={...t};return delete a[s],a})},[]),u=r.useCallback(async()=>{try{await T.auth.updateUser({data:{onboarded:!0}})}catch{}l("/swipe",{replace:!0})},[l]),E=r.useCallback(async()=>{w(null),N(!0);try{const s=Object.keys(d),t=await D({sessionId:n,mediaItemIds:s},{timeoutMs:45e3});if(!t.ok)throw new Error(t.message??"Onboarding failed");await u()}catch(s){console.error(s),w(s?.message??"Something went wrong")}finally{N(!1)}},[u,d,n]);return r.useEffect(()=>{let s=!1;return(async()=>{p(!0),f(null);try{const a=await R({sessionId:n,mode:"trending",limit:24,seed:`onb:${new Date().toISOString().slice(0,10)}`},{timeoutMs:3e4});if(s)return;const L=a.cards??[];U(L.map(X))}catch(a){console.error(a),s||f("Couldn’t load suggestions. You can still search below.")}finally{s||p(!1)}})(),()=>{s=!0}},[n]),c?e.jsx(q,{}):e.jsxs("div",{className:"mx-auto flex min-h-screen w-full max-w-5xl flex-col gap-6 px-4 py-10",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Pick a few titles you like"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Choose at least ",C,". This helps MoviNesta personalize your “For you” deck immediately."]})]}),v&&e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:v}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Selected:"}),i===0?e.jsx("span",{className:"text-sm",children:"None yet"}):Object.values(d).slice(0,12).map(s=>e.jsx(B,{onClick:()=>O(s.id),children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3.5 w-3.5"}),s.title]})},s.id)),i>12&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",i-12," more"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(m,{onClick:E,disabled:i<C||c,className:"rounded-2xl",children:[e.jsx(x,{className:"mr-2 h-4 w-4"}),"Continue"]}),e.jsx(m,{variant:"ghost",onClick:u,className:"rounded-2xl",disabled:c,children:"Skip for now"})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-base font-semibold",children:"Popular picks"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Tap to ",i?"toggle":"select"]})]}),M?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:"Loading suggestions…"}):b?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:b}):e.jsx("div",{className:"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-6",children:I.map(s=>{const t=!!d[s.id];return e.jsxs("button",{type:"button",onClick:()=>S(s),className:"group relative overflow-hidden rounded-2xl border border-border bg-card/60 text-left",children:[s.posterUrl?e.jsx("img",{src:s.posterUrl,alt:s.title,className:"h-44 w-full object-cover transition-transform group-hover:scale-[1.02]",loading:"lazy"}):e.jsx("div",{className:"flex h-44 w-full items-center justify-center text-xs text-muted-foreground",children:"No poster"}),e.jsx("div",{className:"p-2",children:e.jsx("div",{className:"line-clamp-2 text-xs font-medium",children:s.title})}),e.jsx("div",{className:"absolute right-2 top-2 rounded-full bg-background/80 p-1 shadow",children:t?e.jsx(x,{className:"h-4 w-4"}):e.jsx(k,{className:"h-4 w-4"})})]},s.id)})})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsx("h2",{className:"text-base font-semibold",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(A,{value:h,onChange:s=>P(s.target.value),placeholder:"Search movies and series…",className:"pl-9"})]}),o.isLoading?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:"Searching…"}):g.trim().length>0&&y.length===0?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:"No results."}):e.jsxs("div",{className:"space-y-2",children:[y.slice(0,20).map(s=>{const t=Y(s),a=!!d[t.id];return e.jsxs("button",{type:"button",onClick:()=>S(t),className:"flex w-full items-center gap-3 rounded-2xl border border-border bg-card/40 p-2 text-left hover:bg-card/60",children:[t.posterUrl?e.jsx("img",{src:t.posterUrl,alt:t.title,className:"h-16 w-12 rounded-xl object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-16 w-12 items-center justify-center rounded-xl bg-background/60 text-xs text-muted-foreground",children:"—"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"truncate text-sm font-medium",children:t.title}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.type??"title"," ",typeof s.year=="number"?`• ${s.year}`:""]})]}),e.jsx("div",{className:"rounded-full bg-background/80 p-1 shadow",children:a?e.jsx(x,{className:"h-4 w-4"}):e.jsx(k,{className:"h-4 w-4"})})]},s.id)}),o.hasNextPage&&e.jsx("div",{className:"pt-2",children:e.jsx(m,{variant:"ghost",className:"rounded-2xl",disabled:o.isFetchingNextPage,onClick:()=>o.fetchNextPage(),children:o.isFetchingNextPage?"Loading…":"Load more"})})]})]})]})};export{se as default};
