import{b as A,c as B,s as h}from"./index-CuXsBKB-.js";const i=a=>{if(a?.aborted)throw a.reason??new DOMException("Aborted","AbortError")},M=a=>{const n=a.trim().replace(/^@+/,""),t=n.toLowerCase(),{user:u}=A();return B({queryKey:["search","people",{query:n,userId:u?.id??null}],enabled:n.length>0,staleTime:1e3*60*15,gcTime:1e3*60*30,queryFn:async({signal:r})=>{i(r);const C=n.replace(/%/g,"\\%").replace(/_/g,"\\_");let c=h.from("profiles_public").select("id, username, display_name, avatar_url, bio").or(`username.ilike.%${C}%,display_name.ilike.%${C}%`).limit(20);r&&(c=c.abortSignal(r));const d=await c;if(i(r),d.error)throw new Error(d.error.message);const m=d.data??[],b=m.map(e=>e.id);let f=new Map;if(b.length){let e=h.from("user_stats").select("user_id, followers_count, following_count").in("user_id",b);r&&(e=e.abortSignal(r));const o=await e;i(r),o.error?console.warn("[useSearchPeople] Failed to load user_stats",o.error.message):f=new Map((o.data??[]).map(l=>[l.user_id,{followersCount:l.followers_count??0,followingCount:l.following_count??0}]))}if(!u?.id)return m.map(e=>{const o=f.get(e.id);return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:e.avatar_url,bio:e.bio,followersCount:o?.followersCount??null,followingCount:o?.followingCount??null,isFollowing:!1,matchPercent:null}});let p=h.from("follows").select("followed_id").eq("follower_id",u.id);r&&(p=p.abortSignal(r));const w=await p;i(r),w.error&&console.warn("[useSearchPeople] Failed to load follows for current user",w.error.message);const v=new Set((w.data??[]).map(e=>e.followed_id));return m.map(e=>{const o=f.get(e.id),l=e.username??"",_=e.display_name??"",y=l.toLowerCase(),g=_.toLowerCase();let s=0;y===t?s+=100:y.startsWith(t)?s+=80:g.startsWith(t)?s+=60:y.includes(t)?s+=40:g.includes(t)&&(s+=30);const S=Math.min(15,Math.floor((o?.followersCount??0)/500));return{id:e.id,username:e.username,displayName:e.display_name,avatarUrl:e.avatar_url,bio:e.bio,followersCount:o?.followersCount??null,followingCount:o?.followingCount??null,isFollowing:v.has(e.id),matchPercent:null,relevance:s+S}}).sort((e,o)=>{if(o.relevance!==e.relevance)return o.relevance-e.relevance;const l=(e.displayName??e.username??"").toLowerCase(),_=(o.displayName??o.username??"").toLowerCase();return l.localeCompare(_)}).map(({relevance:e,...o})=>o)}})};export{M as u};
