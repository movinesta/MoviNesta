import{b as M,e as C,s as v,v as P,u as R,R as F,j as e,I as q,B as U}from"./index-yaS868vE.js";import{T as E}from"./TopBar-DVbOlr27.js";import{u as L}from"./useToggleFollow-18dQkAwo.js";import{r as Y}from"./resolveAvatarUrl-Bv46IzST.js";import{C as z}from"./chevron-right-CGJTX8kZ.js";import{X as S}from"./x-DNY9LJhZ.js";import"./useMutation-WGdhQwN_.js";const B=o=>{if(!o)return null;const n=o.trim();return n?n.startsWith("@")?n:`@${n}`:null},O=(o,n=80)=>{const a=o.trim().replace(/\s+/g," ");return a.length<=n?a:`${a.slice(0,n-1)}…`};async function W(o){if(!o.length)return new Map;const{data:n,error:a}=await v.from("profiles_public").select("id, username, display_name, avatar_url").in("id",o);if(a)throw new Error(a.message);const u=n??[],c=new Map(u.map(i=>[i.id,i])),l=await Promise.all(o.map(async i=>{const r=c.get(i),p=await Y(r?.avatar_url??null);return[i,p]})),d=new Map(l),w=new Map;return o.forEach(i=>{const r=c.get(i);w.set(i,{id:i,username:r?.username??null,displayName:r?.display_name??null,avatarUrl:d.get(i)??null})}),w}async function H(o){const n=Array.from(new Set(o)).filter(Boolean);if(!n.length)return new Map;const{data:a,error:u}=await v.from("media_items").select(`id,
       kind,
       tmdb_title,
       tmdb_name,
       tmdb_original_title,
       tmdb_original_name,
       tmdb_release_date,
       tmdb_first_air_date,
       tmdb_poster_path,
       tmdb_backdrop_path,
       tmdb_original_language,
       omdb_title,
       omdb_year,
       omdb_language,
       omdb_imdb_id,
       omdb_imdb_rating,
       omdb_rating_rotten_tomatoes,
       omdb_poster,
       omdb_rated,
       tmdb_id`).in("id",n);if(u)return console.warn("[useActivityNotifications] Failed to load media_items",u.message),new Map;const c=new Map;return a?.forEach(l=>{const d=P(l);c.set(l.id,d.posterUrl??d.backdropUrl??null)}),c}function K(){const{user:o}=M(),n=o?.id??null;return C({queryKey:["activity","notifications",n],enabled:!!n,staleTime:1e3*30,queryFn:async()=>{if(!n)return{notifications:[],peopleYouDontFollowBack:[]};const{data:a,error:u}=await v.from("follows").select("follower_id, created_at").eq("followed_id",n).order("created_at",{ascending:!1}).limit(80);if(u)throw new Error(u.message);const c=a??[],l=Array.from(new Set(c.map(s=>s.follower_id).filter(Boolean)));let d=new Set;if(l.length){const{data:s,error:m}=await v.from("follows").select("followed_id").eq("follower_id",n).in("followed_id",l);m||(d=new Set((s??[]).map(h=>h.followed_id)))}const{data:w,error:i}=await v.from("comments").select("id, user_id, body, created_at, review_id, reviews!inner(user_id, title_id)").eq("reviews.user_id",n).order("created_at",{ascending:!1}).limit(80);i&&console.warn("[useActivityNotifications] Failed to load comments",i.message);const r=w??[],p=Array.from(new Set(r.map(s=>s.user_id).filter(Boolean))),y=Array.from(new Set([...l,...p])),x=await W(y),_=r.map(s=>s.reviews?.title_id).filter(s=>typeof s=="string"&&s.length>0),j=await H(_),t=c.map(s=>{const m=x.get(s.follower_id);if(!m)return null;const h=B(m.username),N=m.displayName||h||"Someone",g=d.has(m.id);return{id:`follow:${s.follower_id}:${s.created_at}`,kind:"follow",createdAt:s.created_at,actor:m,text:`${N} started following you.`,linkTo:m.username?`/u/${m.username}`:void 0,canFollowBack:!0,isFollowingBack:g}}).filter(s=>!!s),f=r.map(s=>{const m=x.get(s.user_id);if(!m)return null;const h=B(m.username),N=m.displayName||h||"Someone",g=s.reviews?.title_id??null,D=g?j.get(g)??null:null;return{id:`comment:${s.id}`,kind:s.review_id?"comment":"reply",createdAt:s.created_at,actor:m,text:`${N} commented: “${O(s.body)}”`,thumbnailUrl:D,linkTo:g?`/title/${g}`:void 0}}).filter(s=>!!s),b=[...t,...f].sort((s,m)=>s.createdAt<m.createdAt?1:-1),$=l.filter(s=>!d.has(s)).map(s=>x.get(s)).filter(s=>!!s);return{notifications:b,peopleYouDontFollowBack:$}}})}const Q=o=>{const n=new Date(o),a=Date.now()-n.getTime(),u=Math.floor(a/1e3),c=[[60,"second"],[60,"minute"],[24,"hour"],[7,"day"],[4,"week"],[12,"month"]];let l=u,d="second";for(const[i,r]of c){if(Math.abs(l)<i){d=r;break}l=Math.floor(l/i),d=r}return new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}).format(-l,d)},A=(o,n)=>{const a=new Date(o);return Date.now()-a.getTime()<=n*24*60*60*1e3},T=({actor:o})=>{const n=(o.displayName||o.username||"?").replace(/^@/,"").trim().slice(0,2).toUpperCase();return o.avatarUrl?e.jsx("img",{src:o.avatarUrl,alt:"",className:"h-11 w-11 rounded-full object-cover"}):e.jsx("div",{className:"flex h-11 w-11 items-center justify-center rounded-full bg-muted text-xs font-semibold text-muted-foreground",children:n||"?"})},I=({item:o,onDismiss:n,onOpen:a,onFollowBack:u,followBackState:c})=>{const l=Q(o.createdAt),d=o.actor.displayName||o.actor.username||"Someone";return e.jsxs("div",{className:"flex items-center gap-3 px-3 py-3",children:[e.jsx("button",{type:"button",onClick:a,className:"flex items-center gap-3 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",children:e.jsx(T,{actor:o.actor})}),e.jsx("button",{type:"button",onClick:a,className:"min-w-0 flex-1 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",children:e.jsxs("p",{className:"text-sm text-foreground",children:[e.jsx("span",{className:"font-semibold",children:d})," ",e.jsx("span",{className:"text-muted-foreground",children:o.text.replace(d,"").trim()})," ",e.jsx("span",{className:"text-xs text-muted-foreground",children:l})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[o.thumbnailUrl?e.jsx("button",{type:"button",onClick:a,className:"h-12 w-12 overflow-hidden rounded-lg bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30","aria-label":"Open",children:e.jsx("img",{src:o.thumbnailUrl,alt:"",className:"h-full w-full object-cover"})}):null,u&&c?e.jsx(U,{size:"sm",className:"h-9 rounded-full px-4",onClick:u,disabled:c.disabled,children:c.label}):null,e.jsx("button",{type:"button",onClick:n,className:"inline-flex h-8 w-8 items-center justify-center rounded-full text-muted-foreground hover:bg-muted hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30","aria-label":"Dismiss",children:e.jsx(S,{className:"h-4 w-4","aria-hidden":!0})})]})]})},k=({title:o,children:n})=>e.jsxs("section",{className:"border-b border-border",children:[e.jsx("h2",{className:"px-3 pb-1 pt-4 text-sm font-semibold text-foreground",children:o}),n]}),oe=()=>{const o=R(),{data:n,isLoading:a,isError:u,error:c}=K(),l=L(),[d,w]=F.useState(new Set),i=F.useMemo(()=>(n?.notifications??[]).filter(f=>!d.has(f.id)),[n?.notifications,d]),r=n?.peopleYouDontFollowBack??[],p=i.filter(t=>A(t.createdAt,30)),y=i.filter(t=>!A(t.createdAt,30)),x=t=>{w(f=>new Set(f).add(t))},_=t=>{t.linkTo&&o(t.linkTo)},j=t=>{l.mutate({targetUserId:t.actor.id,currentlyFollowing:!!t.isFollowingBack})};return e.jsxs("div",{className:"flex flex-1 flex-col bg-background pb-4 text-foreground",children:[e.jsx(E,{title:"Activity"}),e.jsxs("div",{className:"flex flex-1 flex-col",children:[e.jsxs("button",{type:"button",className:"flex w-full items-center justify-between gap-3 border-b border-border px-3 py-4 text-left",onClick:()=>o("/activity/requests"),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-full bg-muted"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"Follow requests"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:r.length?`${r[0]?.displayName||r[0]?.username||"Someone"}${r.length>1?` + ${r.length-1} others`:""}`:"No requests"})]})]}),e.jsx(z,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0})]}),a?e.jsx("div",{className:"px-3 py-6 text-sm text-muted-foreground",children:"Loading…"}):u?e.jsx("div",{className:"px-3 py-6 text-sm text-red-600",children:c?.message||"Failed to load notifications."}):i.length===0&&r.length===0?e.jsx("div",{className:"px-3 py-10 text-center text-sm text-muted-foreground",children:"No notifications yet."}):e.jsxs(e.Fragment,{children:[p.length?e.jsx(k,{title:"Last 30 days",children:p.map(t=>{const f=t.kind==="follow"&&t.canFollowBack,b=t.isFollowingBack?"Following":"Follow back";return e.jsx(I,{item:t,onDismiss:()=>x(t.id),onOpen:()=>_(t),onFollowBack:f?()=>j(t):void 0,followBackState:f?{label:l.isPending&&l.variables?.targetUserId===t.actor.id?"…":b,disabled:l.isPending}:void 0},t.id)})}):null,y.length?e.jsx(k,{title:"Older",children:y.map(t=>{const f=t.kind==="follow"&&t.canFollowBack,b=t.isFollowingBack?"Following":"Follow back";return e.jsx(I,{item:t,onDismiss:()=>x(t.id),onOpen:()=>_(t),onFollowBack:f?()=>j(t):void 0,followBackState:f?{label:l.isPending&&l.variables?.targetUserId===t.actor.id?"…":b,disabled:l.isPending}:void 0},t.id)})}):null,r.length?e.jsx(k,{title:"People you don't follow back",children:r.slice(0,10).map(t=>{const f=`dont-follow-back:${t.id}`;return d.has(f)?null:e.jsxs("div",{className:q("flex items-center gap-3 px-3 py-3"),children:[e.jsxs("button",{type:"button",className:"flex min-w-0 flex-1 items-center gap-3 text-left",onClick:()=>t.username&&o(`/u/${t.username}`),children:[e.jsx(T,{actor:t}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold",children:t.displayName||t.username||"User"}),e.jsxs("div",{className:"truncate text-xs text-muted-foreground",children:["Followed by ",t.username?`@${t.username.replace(/^@/,"")}`:"someone"]})]})]}),e.jsx(U,{size:"sm",className:"h-9 rounded-full px-4",onClick:()=>l.mutate({targetUserId:t.id,currentlyFollowing:!1}),disabled:l.isPending,children:"Follow back"}),e.jsx("button",{type:"button",onClick:()=>x(f),className:"inline-flex h-8 w-8 items-center justify-center rounded-full text-muted-foreground hover:bg-muted hover:text-foreground","aria-label":"Dismiss",children:e.jsx(S,{className:"h-4 w-4","aria-hidden":!0})})]},t.id)})}):null]})]})]})};export{oe as default};
