import{c as D,e as G,b as V,f as se,g as H,s as g,h as Ct,u as St,r as u,j as e,L as Rt,H as It,A as Et,U as Mt,I as Tt,i as Q,R as At,X as Re}from"./index-CPLjPhHk.js";import{u as Dt,p as Ge}from"./useConversations-DR_mx0e7.js";import{S as Ve}from"./send-DdqRVZRp.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=D("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=D("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=D("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=D("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=D("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=D("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=D("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=D("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=D("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]),Bt=r=>{var v,h;const{user:s}=G(),o=(s==null?void 0:s.id)??null,n=V(),l=["block-status",o,r],m=se({queryKey:l,enabled:!!(o&&r&&o!==r),staleTime:3e4,queryFn:async()=>{if(!o||!r||o===r)return{youBlocked:!1,blockedYou:!1};const{data:b,error:C}=await g.from("blocked_users").select("blocker_id, blocked_id").or(`and(blocker_id.eq.${o},blocked_id.eq.${r}),and(blocker_id.eq.${r},blocked_id.eq.${o})`);if(C)throw console.error("[useBlockStatus] Failed to load block status",C),new Error(C.message);const M=b??[],L=M.some(S=>S.blocker_id===o&&S.blocked_id===r),re=M.some(S=>S.blocker_id===r&&S.blocked_id===o);return{youBlocked:L,blockedYou:re}}}),c=H({mutationFn:async()=>{if(!o||!r)throw new Error("Missing user ids for block operation.");const{error:b}=await g.from("blocked_users").upsert({blocker_id:o,blocked_id:r},{onConflict:"blocker_id,blocked_id"});if(b)throw console.error("[useBlockStatus] Failed to block user",b),new Error(b.message)},onSuccess:()=>{n.invalidateQueries({queryKey:l})}}),i=H({mutationFn:async()=>{if(!o||!r)throw new Error("Missing user ids for unblock operation.");const{error:b}=await g.from("blocked_users").delete().eq("blocker_id",o).eq("blocked_id",r);if(b)throw console.error("[useBlockStatus] Failed to unblock user",b),new Error(b.message)},onSuccess:()=>{n.invalidateQueries({queryKey:l})}}),x=((v=m.data)==null?void 0:v.youBlocked)??!1,y=((h=m.data)==null?void 0:h.blockedYou)??!1,j=x||y,k=c.isPending||i.isPending;return{youBlocked:x,blockedYou:y,isBlocked:j,isLoading:m.isLoading||k,isError:m.isError,error:m.error??null,block:c,unblock:i}},Ot=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ™","ðŸ”¥","ðŸ˜"],Ie=r=>{if(!r)return{};try{const s=JSON.parse(r);if(s&&typeof s=="object")return{editedAt:typeof s.editedAt=="string"?s.editedAt:void 0,deletedAt:typeof s.deletedAt=="string"?s.deletedAt:void 0,deleted:s.deleted===!0}}catch{}return{}},de=r=>{const s=new Date(r);return Number.isNaN(s.getTime())?"":s.toLocaleTimeString(void 0,{hour:"numeric",minute:"2-digit",hour12:!0})},Ut=r=>se({queryKey:["conversation",r,"messages"],enabled:!!r,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:r?6e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!r)return[];const{data:s,error:o}=await g.from("messages").select("id, conversation_id, sender_id, body, attachment_url, created_at").eq("conversation_id",r).order("created_at",{ascending:!0});if(o)throw console.error("[ConversationPage] Failed to load messages",o),new Error(o.message);return(s??[]).map(n=>({id:n.id,conversationId:n.conversation_id,senderId:n.sender_id,body:n.body??null,attachmentUrl:n.attachment_url??null,createdAt:n.created_at}))}}),Qt=r=>se({queryKey:["conversation",r,"readReceipts"],enabled:!!r,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:r?12e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!r)return[];const{data:s,error:o}=await g.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",r);if(o)throw console.error("[ConversationPage] Failed to load read receipts",o),new Error(o.message);return(s??[]).map(n=>({userId:n.user_id,lastReadAt:n.last_read_at??null,lastReadMessageId:n.last_read_message_id??null}))}}),Kt=r=>se({queryKey:["conversation",r,"reactions"],enabled:!!r,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:r?15e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!r)return[];const{data:s,error:o}=await g.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",r).order("created_at",{ascending:!0});if(o)throw console.error("[ConversationPage] Failed to load reactions",o),new Error(o.message);return(s??[]).map(n=>({id:n.id,conversationId:n.conversation_id,messageId:n.message_id,userId:n.user_id,emoji:n.emoji,createdAt:n.created_at}))}}),Yt=r=>se({queryKey:["conversation",r,"deliveryReceipts"],enabled:!!r,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:r?15e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!r)return[];const{data:s,error:o}=await g.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",r).order("created_at",{ascending:!0});if(o)throw console.error("[ConversationPage] Failed to load delivery receipts",o),new Error(o.message);return(s??[]).map(n=>({id:n.id,conversationId:n.conversation_id,messageId:n.message_id,userId:n.user_id,deliveredAt:n.delivered_at??n.created_at}))}}),zt=r=>{const{user:s}=G(),o=(s==null?void 0:s.id)??null,n=V();return H({mutationFn:async({text:l,attachmentPath:m})=>{if(!r)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to send messages.");const c=l.trim(),i=m&&c?{type:"text+image",text:c}:m?{type:"image",text:""}:{type:"text",text:c},{data:x,error:y}=await g.from("messages").insert({conversation_id:r,sender_id:o,body:JSON.stringify(i),attachment_url:m??null}).select("id, conversation_id, sender_id, body, attachment_url, created_at").single();if(y)throw console.error("[ConversationPage] Failed to send message",y),new Error(y.message);const j={id:x.id,conversationId:x.conversation_id,senderId:x.sender_id,body:x.body??null,attachmentUrl:x.attachment_url??null,createdAt:x.created_at};try{await g.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",r)}catch(k){console.error("[ConversationPage] Failed to update conversation timestamp",k)}return j},onMutate:async({text:l,attachmentPath:m})=>{if(!r||!o)return{previousMessages:void 0,tempId:null};const c=`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,i=new Date().toISOString(),x={id:c,conversationId:r,senderId:o,body:JSON.stringify({type:"text",text:l.trim()}),attachmentUrl:m??null,createdAt:i};await n.cancelQueries({queryKey:["conversation",r,"messages"]});const y=n.getQueryData(["conversation",r,"messages"]);return n.setQueryData(["conversation",r,"messages"],j=>{const v=[...j??[],x];return v.sort((h,b)=>new Date(h.createdAt).getTime()-new Date(b.createdAt).getTime()),v}),{previousMessages:y,tempId:c}},onError:(l,m,c)=>{console.error("[ConversationPage] sendMessage error",l),c!=null&&c.previousMessages&&r&&n.setQueryData(["conversation",r,"messages"],c.previousMessages)},onSuccess:(l,m,c)=>{if(!r)return;const i=c==null?void 0:c.tempId;n.setQueryData(["conversation",r,"messages"],x=>{const y=x??[],j=i?y.filter(h=>h.id!==i):y.filter(h=>h.id!==l.id),k=j.findIndex(h=>h.id===l.id);if(k>=0){const h=[...j];return h[k]=l,h}const v=[...j,l];return v.sort((h,b)=>new Date(h.createdAt).getTime()-new Date(b.createdAt).getTime()),v}),n.invalidateQueries({queryKey:["conversations"]})}})},Ht=r=>{const{user:s}=G(),o=(s==null?void 0:s.id)??null,n=V();return H({mutationFn:async({messageId:l,emoji:m})=>{if(!r)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to react to messages.");const{error:c}=await g.from("message_reactions").insert({conversation_id:r,message_id:l,user_id:o,emoji:m});if(c){if(c.code==="23505"){const{error:i}=await g.from("message_reactions").delete().eq("conversation_id",r).eq("message_id",l).eq("user_id",o).eq("emoji",m);if(i)throw console.error("[ConversationPage] Failed to remove reaction",i),i;return}throw console.error("[ConversationPage] Failed to toggle reaction",c),c}},onMutate:async({messageId:l,emoji:m})=>{if(!r||!o)return{previousReactions:void 0};const c=["conversation",r,"reactions"];await n.cancelQueries({queryKey:c});const i=n.getQueryData(c);return n.setQueryData(c,x=>{const y=x??[],j=y.findIndex(v=>v.messageId===l&&v.userId===o&&v.emoji===m);if(j>=0){const v=[...y];return v.splice(j,1),v}const k={id:`temp-${Date.now()}`,conversationId:r,messageId:l,userId:o,emoji:m,createdAt:new Date().toISOString()};return[...y,k]}),{previousReactions:i}},onError:(l,m,c)=>{if(!r)return;const i=["conversation",r,"reactions"];c!=null&&c.previousReactions?n.setQueryData(i,c.previousReactions):n.invalidateQueries({queryKey:i})},onSuccess:()=>{r&&n.invalidateQueries({queryKey:["conversation",r,"reactions"]})}})},Gt=r=>{const{user:s}=G(),o=(s==null?void 0:s.id)??null,n=V();return H({mutationFn:async({messageId:l,text:m})=>{if(!r)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to edit messages.");const i={type:"text",text:m.trim(),editedAt:new Date().toISOString()},{data:x,error:y}=await g.from("messages").update({body:JSON.stringify(i)}).eq("id",l).eq("sender_id",o).select("id, conversation_id, sender_id, body, attachment_url, created_at").single();if(y)throw console.error("[ConversationPage] Failed to edit message",y),new Error(y.message);return{id:x.id,conversationId:x.conversation_id,senderId:x.sender_id,body:x.body??null,attachmentUrl:x.attachment_url??null,createdAt:x.created_at}},onSuccess:l=>{if(!r)return;const m=["conversation",r,"messages"];n.setQueryData(m,c=>c?c.map(i=>i.id===l.id?l:i):[l])}})},Vt=r=>{const{user:s}=G(),o=(s==null?void 0:s.id)??null,n=V();return H({mutationFn:async({messageId:l})=>{if(!r)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to delete messages.");const c={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},{data:i,error:x}=await g.from("messages").update({body:JSON.stringify(c),attachment_url:null}).eq("id",l).eq("sender_id",o).select("id, conversation_id, sender_id, body, attachment_url, created_at").single();if(x)throw console.error("[ConversationPage] Failed to delete message",x),new Error(x.message);return{id:i.id,conversationId:i.conversation_id,senderId:i.sender_id,body:i.body??null,attachmentUrl:i.attachment_url??null,createdAt:i.created_at}},onSuccess:l=>{if(!r)return;const m=["conversation",r,"messages"];n.setQueryData(m,c=>c?c.map(i=>i.id===l.id?l:i):[l]),n.invalidateQueries({queryKey:["conversations"]})}})},Wt=({path:r})=>{const[s,o]=u.useState(null),[n,l]=u.useState(!1);return u.useEffect(()=>{let m=!1;return(async()=>{const{data:i,error:x}=await g.storage.from("chat-media").createSignedUrl(r,3600);if(!m){if(x||!(i!=null&&i.signedUrl)){console.error("[ChatImage] createSignedUrl error",x),l(!0);return}o(i.signedUrl)}})(),()=>{m=!0}},[r]),n?e.jsx("div",{className:"mt-1 text-[11px] text-mn-text-muted",children:"Image unavailable."}):s?e.jsx("div",{className:"mt-1 overflow-hidden rounded-xl border border-mn-border-subtle/70 bg-mn-bg/80",children:e.jsx("img",{src:s,alt:"Attachment",className:"max-h-64 w-full object-cover",loading:"lazy"})}):e.jsx("div",{className:"mt-1 h-32 w-40 animate-pulse rounded-xl bg-mn-border-subtle/40"})},nn=()=>{const{conversationId:r}=Ct(),s=r??null,o=St(),{user:n}=G(),l=V(),{data:m,isLoading:c}=Dt(),{data:i,isLoading:x,isError:y,error:j}=Ut(s),k=zt(s),[v,h]=u.useState(""),[b,C]=u.useState(null),[M,L]=u.useState(null),re=u.useRef(null),S=u.useRef(null),[ae,ie]=u.useState(!1),ce=u.useRef(null),ue=u.useRef(null),[tt,Me]=u.useState(!1),[oe,Te]=u.useState(null),[T,Ae]=u.useState(null),[me,De]=u.useState(!1),fe=u.useRef(null);u.useEffect(()=>()=>{T&&URL.revokeObjectURL(T)},[T]);const p=u.useMemo(()=>!s||!m?null:m.find(t=>t.id===s)??null,[s,m]),xe=u.useMemo(()=>{const t=new Map;if(!p)return t;for(const a of p.participants)t.set(a.id,a);return t},[p]),F=(p==null?void 0:p.isGroup)??!1,R=u.useMemo(()=>{if(!p)return null;const t=p.participants.filter(a=>!a.isSelf);return t.length>0?t[0]:p.participants.length===1?p.participants[0]:null},[p]),{youBlocked:qe,blockedYou:q,isBlocked:$,isLoading:nt,block:ge,unblock:he}=Bt(F?null:(R==null?void 0:R.id)??null),Pe=((i==null?void 0:i.length)??0)>0,Le=c||x||nt,be=(n==null?void 0:n.id)??null,st=u.useMemo(()=>{if(!i||!be)return null;for(let t=i.length-1;t>=0;t-=1){const a=i[t];if(a.senderId===be&&!Ie(a.body).deleted)return a.id}return null},[i,be]),[K,pe]=u.useState([]),Y=u.useRef(new Map),ye=u.useRef(null),W=u.useRef({conversationId:null,messageId:null,userId:null}),B=u.useRef({isTyping:!1,timeoutId:null}),{data:rt}=Qt(s),{data:ve}=Kt(s),{data:at}=Yt(s),Fe=Ht(s),we=Gt(s),je=Vt(s),P=u.useRef(null),le=u.useRef(!1),[Ne,z]=u.useState(null),[it,ot]=u.useState({}),[_e,J]=u.useState(null),[X,Z]=u.useState(null),[$e,ee]=u.useState(null),lt=u.useMemo(()=>{const t=new Map;if(!ve)return t;for(const a of ve){const d=t.get(a.messageId)??[];let f=d.find(w=>w.emoji===a.emoji);f||(f={emoji:a.emoji,count:0,reactedBySelf:!1},d.push(f),t.set(a.messageId,d)),f.count+=1,n!=null&&n.id&&a.userId===n.id&&(f.reactedBySelf=!0)}return t},[ve,n==null?void 0:n.id]);u.useEffect(()=>{var t;!i||i.length===0||(t=re.current)==null||t.scrollIntoView({behavior:"smooth"})},[i==null?void 0:i.length]),u.useEffect(()=>{W.current={conversationId:null,messageId:null,userId:null}},[s,n==null?void 0:n.id]),u.useEffect(()=>()=>{P.current!=null&&window.clearTimeout(P.current)},[]),u.useEffect(()=>{if(!s||!(n!=null&&n.id))return;const t=g.channel(`supabase_realtime_typing:conversation:${s}`,{config:{broadcast:{self:!1}}});return ye.current=t,t.on("broadcast",{event:"typing"},({payload:a})=>{const d=a;if(!d||d.userId===n.id)return;const f=xe.get(d.userId),w=(f==null?void 0:f.displayName)??"Someone",N=d.userId,A=Y.current.get(N);if(A!=null&&window.clearTimeout(A),d.isTyping){pe(_=>_.includes(w)?_:[..._,w]);const I=window.setTimeout(()=>{Y.current.delete(N),pe(_=>_.filter(ne=>ne!==w))},4e3);Y.current.set(N,I)}else Y.current.delete(N),pe(I=>I.filter(_=>_!==w))}).subscribe(a=>{console.log("[ConversationPage] Typing channel status",a)}),()=>{Y.current.forEach(a=>window.clearTimeout(a)),Y.current.clear(),t&&g.removeChannel(t),ye.current=null}},[s,n==null?void 0:n.id,xe]),u.useEffect(()=>{if(!s)return;const t=g.channel(`supabase_realtime_messages_publication:conversation:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{console.log("[ConversationPage] Realtime message payload",a);const d=a.new;if(n!=null&&n.id&&d.sender_id===n.id)return;const f={id:d.id,conversationId:d.conversation_id,senderId:d.sender_id,body:d.body,attachmentUrl:d.attachment_url,createdAt:d.created_at};l.setQueryData(["conversation",s,"messages"],w=>{const N=w??[];if(N.some(_=>_.id===f.id))return N;const I=[...N,f];return I.sort((_,ne)=>new Date(_.createdAt).getTime()-new Date(ne.createdAt).getTime()),I}),l.invalidateQueries({queryKey:["conversations"]}),n!=null&&n.id&&d.sender_id!==n.id&&g.from("message_delivery_receipts").insert({conversation_id:d.conversation_id,message_id:d.id,user_id:n.id}).then(({error:w})=>{w&&console.error("[ConversationPage] Failed to insert delivery receipt",w)}).catch(w=>{console.error("[ConversationPage] Unexpected error inserting delivery receipt",w)})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{const d=a.new,f={id:d.id,conversationId:d.conversation_id,senderId:d.sender_id,body:d.body,attachmentUrl:d.attachment_url,createdAt:d.created_at};l.setQueryData(["conversation",s,"messages"],w=>{const N=w??[],A=N.findIndex(_=>_.id===f.id);if(A===-1)return N;const I=[...N];return I[A]=f,I})});return t.subscribe(a=>{console.log("[ConversationPage] Realtime channel status (messages)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for messages",a)}),()=>{g.removeChannel(t)}},[s,l,n==null?void 0:n.id]),u.useEffect(()=>{if(!s||!i||i.length===0||!(n!=null&&n.id))return;const t=i[i.length-1];W.current.conversationId===s&&W.current.messageId===t.id&&W.current.userId===n.id||g.from("message_read_receipts").upsert({conversation_id:s,user_id:n.id,last_read_message_id:t.id,last_read_at:new Date().toISOString()},{onConflict:"conversation_id,user_id"}).then(()=>{W.current={conversationId:s,messageId:t.id,userId:n.id},l.invalidateQueries({queryKey:["conversations"]})}).catch(a=>{console.error("[ConversationPage] Failed to update read receipt",a)})},[s,i,n==null?void 0:n.id,l]),u.useEffect(()=>{if(!s)return;const t=g.channel(`supabase_realtime_read_receipts:conversation:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},()=>{l.invalidateQueries({queryKey:["conversation",s,"readReceipts"]})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},()=>{l.invalidateQueries({queryKey:["conversation",s,"readReceipts"]})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (read receipts)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for read receipts",a)});return()=>{g.removeChannel(t)}},[s,l]),u.useEffect(()=>{if(!s)return;const t=g.channel(`supabase_realtime_message_reactions:conversation:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},()=>{l.invalidateQueries({queryKey:["conversation",s,"reactions"]})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (reactions)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for reactions",a)});return()=>{g.removeChannel(t)}},[s,l]),u.useEffect(()=>{if(!s)return;const t=g.channel(`supabase_realtime_message_delivery_receipts:conversation:${s}`).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},()=>{l.invalidateQueries({queryKey:["conversation",s,"deliveryReceipts"]})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (delivery receipts)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for delivery receipts",a)});return()=>{g.removeChannel(t)}},[s,l]),u.useEffect(()=>{if(!ae)return;const t=a=>{const d=a.target;ue.current&&!ue.current.contains(d)&&ce.current&&!ce.current.contains(d)&&ie(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[ae]);const te=()=>{const t=S.current;if(!t)return;t.style.height="auto";const a=Math.min(140,t.scrollHeight);t.style.height=`${a}px`,t.style.overflowY=t.scrollHeight>a?"auto":"hidden"};u.useEffect(()=>{te()},[v]);const ke=t=>{const a=ye.current;if(!a||!s||!n)return;const f=t.trim().length>0,w=B.current.isTyping;f&&!w&&(B.current.isTyping=!0,a.send({type:"broadcast",event:"typing",payload:{userId:n.id,isTyping:!0}})),B.current.timeoutId!=null&&window.clearTimeout(B.current.timeoutId),f?B.current.timeoutId=window.setTimeout(()=>{B.current.isTyping=!1,a.send({type:"broadcast",event:"typing",payload:{userId:n.id,isTyping:!1}})},3e3):!f&&w&&(B.current.isTyping=!1,a.send({type:"broadcast",event:"typing",payload:{userId:n.id,isTyping:!1}}))},dt=t=>{const a=t.target.value;h(a),te(),ae&&ie(!1),ke(a)},ct=t=>{t&&h(a=>{const d=`${a}${t}`;return te(),ke(d),d})},Be=t=>{k.mutate({text:t,attachmentPath:null},{onError:a=>{console.error("[ConversationPage] sendMessage mutate error",a),C("Couldn't send. Please try again."),h(t),te(),L(t)},onSuccess:()=>{C(null),L(null)}})},ut=t=>{if(t.preventDefault(),$||q)return;const a=v.trim();a&&(h(""),te(),C(null),L(null),ke(""),Be(a))},mt=()=>{M&&(C(null),Be(M))},ft=()=>{var t;!s||!(n!=null&&n.id)||$||q||(t=fe.current)==null||t.click()},xt=async t=>{var f;const a=(f=t.target.files)==null?void 0:f[0];if(t.target.value="",!a||!s||!(n!=null&&n.id)||$||q)return;const d=URL.createObjectURL(a);T&&URL.revokeObjectURL(T),Te(a),Ae(d),Me(!0)},Oe=()=>{T&&URL.revokeObjectURL(T),Ae(null),Te(null),Me(!1)},gt=async()=>{if(!(!oe||!s||!(n!=null&&n.id))&&!($||q)){De(!0);try{const t=oe.name.split(".").pop()??"jpg",a=`${s}/${n.id}/${Date.now()}.${t}`,{error:d}=await g.storage.from("chat-media").upload(a,oe,{cacheControl:"3600",upsert:!1});if(d){console.error("[ConversationPage] image upload error",d);return}k.mutate({text:"",attachmentPath:a}),Oe()}catch(t){console.error("[ConversationPage] handleSendSelectedImage failed",t)}finally{De(!1)}}},Ce=t=>{$||q||Ie(t.body).deleted||(z(t.id),S.current&&S.current.blur())},ht=t=>{P.current!=null&&window.clearTimeout(P.current),le.current=!1,P.current=window.setTimeout(()=>{le.current=!0,Ce(t)},500)},Ue=()=>{P.current!=null&&(window.clearTimeout(P.current),P.current=null)};return s?e.jsxs("div",{className:"relative flex min-h-screen w-full flex-col items-stretch bg-mn-bg",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-10 top-4 h-32 rounded-full bg-gradient-to-r from-fuchsia-500/15 via-mn-primary/10 to-blue-500/15 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 flex-col items-stretch rounded-none border border-mn-border-subtle/70 bg-mn-bg shadow-xl shadow-mn-primary/5 backdrop-blur sm:rounded-3xl",children:[e.jsxs(It,{className:"min-h-[3.5rem] flex-shrink-0 py-3",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>o("/messages"),className:"inline-flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-primary shadow-mn-soft transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:[e.jsx(Et,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Back to messages"})]}),e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("div",{className:"relative flex h-11 w-11 flex-shrink-0 items-center justify-center overflow-hidden rounded-full bg-mn-bg-elevated ring-2 ring-mn-border-subtle",children:[e.jsx("div",{className:"absolute inset-0 rounded-full bg-gradient-to-br from-fuchsia-500/25 via-mn-primary/20 to-blue-500/25","aria-hidden":"true"}),e.jsx("div",{className:"relative flex h-9 w-9 items-center justify-center overflow-hidden rounded-full bg-mn-bg ring-1 ring-white/30",children:!F&&R?R.avatarUrl?e.jsx("img",{src:R.avatarUrl,alt:R.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-[13px] font-semibold text-mn-text-primary",children:(R.displayName??"U").slice(0,2).toUpperCase()}):e.jsx(Mt,{className:"h-4 w-4 text-mn-text-secondary","aria-hidden":"true"})})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h1",{className:"truncate text-[15px] font-heading font-semibold text-mn-text-primary",children:(p==null?void 0:p.title)??(R==null?void 0:R.displayName)??"Conversation"}),e.jsx("p",{className:"truncate text-[11px] text-mn-text-secondary",children:p?p.lastMessageAtLabel?`Active ${p.lastMessageAtLabel}`:p.subtitle??(F?`${p.participants.length} participants`:"Active now"):c?"Loadingâ€¦":"Details unavailable"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-mn-text-secondary",children:[p&&p.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Audio call",children:e.jsx(Lt,{className:"h-4 w-4","aria-hidden":"true"})}),p&&p.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Video call",children:e.jsx($t,{className:"h-4 w-4","aria-hidden":"true"})}),p&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Conversation info",children:e.jsx(Tt,{className:"h-4 w-4","aria-hidden":"true"})}),!F&&R&&e.jsxs("button",{type:"button",disabled:ge.isPending||he.isPending,onClick:()=>{qe?he.mutate():ge.mutate()},className:"ml-1 hidden items-center gap-1 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 px-3 py-1.5 text-[11px] font-semibold text-mn-text-primary ring-1 ring-mn-border-subtle/70 transition hover:-translate-y-0.5 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg disabled:opacity-60 sm:inline-flex",children:[(ge.isPending||he.isPending)&&e.jsx(Q,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:qe?"Unblock":"Block"})]})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col bg-gradient-to-b from-mn-bg via-mn-bg to-mn-bg",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-8 top-4 h-20 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"relative flex flex-1 flex-col overflow-y-auto px-4 py-4 text-sm",children:[Le&&!Pe&&e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-mn-border-subtle bg-mn-bg/80 px-3 py-1.5 text-[12px] text-mn-text-secondary",children:[e.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]})}),y&&e.jsxs("div",{className:"mb-3 rounded-md border border-mn-border-subtle bg-mn-bg/90 px-3 py-2 text-[12px] text-mn-error",children:[e.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),j instanceof Error&&e.jsx("p",{className:"mt-1 text-[11px] text-mn-text-secondary",children:j.message})]}),!Le&&!y&&!Pe&&e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsxs("div",{className:"text-center text-[12px] text-mn-text-secondary",children:[e.jsx("p",{className:"font-medium",children:F?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:F?"Be the first to start the conversation.":"Say hi to start the conversation."})]})}),i==null?void 0:i.map((t,a)=>{if(it[t.id])return null;const d=xe.get(t.senderId),f=(d==null?void 0:d.isSelf)??((n==null?void 0:n.id)!=null&&t.senderId===n.id),w=a>0?(i==null?void 0:i[a-1])??null:null,N=a<((i==null?void 0:i.length)??0)-1?(i==null?void 0:i[a+1])??null:null,A=w!=null&&w.senderId===t.senderId,I=N!=null&&N.senderId===t.senderId,_=A&&et(w.createdAt,t.createdAt),ne=I&&et(t.createdAt,N.createdAt),bt=!(A&&_),pt=!(I&&ne),Qe=a===0||w!=null&&!Ee(new Date(w.createdAt),new Date(t.createdAt)),yt=a===0||Qe?"mt-0":bt?"mt-3":"mt-1.5",vt=f?"bg-mn-primary/90 text-white shadow-md shadow-mn-primary/20":"bg-mn-bg-elevated text-mn-text-primary border border-mn-border-subtle/80 shadow-mn-soft",Se=Ie(t.body),O=Se.deleted===!0,Ke=Se.editedAt,Ye=Se.deletedAt,wt=O?"bg-mn-bg-elevated/80 text-mn-text-muted border border-dashed border-mn-border-subtle/80":vt,jt=f?"rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl rounded-br-2xl":"rounded-tr-3xl rounded-tl-3xl rounded-br-3xl rounded-bl-2xl",Nt=(d==null?void 0:d.displayName)??(f?"You":"Someone"),ze=O?"This message was deleted":Ge(t.body),_t=!f&&pt,He=lt.get(t.id)??[],U=Xt(t,p??null,at,rt,(n==null?void 0:n.id)??null),kt=f&&st===t.id;return e.jsxs(At.Fragment,{children:[Qe&&e.jsx("div",{className:"my-4 flex items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-3 text-[11px] text-mn-text-muted",children:[e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"}),e.jsx("span",{className:"rounded-full bg-mn-bg px-3 py-0.5 text-[11px] font-medium text-mn-text-secondary shadow-mn-soft/60 ring-1 ring-mn-border-subtle/70",children:Jt(t.createdAt)}),e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"})]})}),e.jsxs("div",{className:`flex w-full flex-col gap-0.5 ${yt}`,children:[e.jsxs("div",{className:`flex w-full items-end gap-2 ${f?"justify-end":"justify-start"}`,children:[!f&&e.jsx(e.Fragment,{children:_t?e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0 overflow-hidden rounded-full bg-mn-bg/80 ring-1 ring-mn-border-subtle",children:d!=null&&d.avatarUrl?e.jsx("img",{src:d.avatarUrl,alt:d.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] font-medium text-mn-text-secondary",children:Nt.slice(0,2).toUpperCase()})}):e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0"})}),e.jsx("div",{className:`inline-flex max-w-[80%] px-4 py-2.5 text-[13px] ${jt} ${wt} select-none transition-transform duration-150 ease-out`,onClick:()=>{if(le.current){le.current=!1;return}Ne===t.id?z(null):Ce(t)},onContextMenu:E=>{E.preventDefault(),Ne===t.id?z(null):Ce(t)},onTouchStart:()=>ht(t),onTouchEnd:Ue,onTouchCancel:Ue,children:e.jsxs("div",{className:"flex flex-col",children:[ze&&e.jsx("p",{className:"whitespace-pre-wrap break-all text-[13px] leading-snug",children:ze}),!O&&t.attachmentUrl&&e.jsx(Wt,{path:t.attachmentUrl})]})})]}),He.length>0&&e.jsx("div",{className:`mt-0.5 flex w-full ${f?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsx("div",{className:"inline-flex flex-wrap items-center gap-1 rounded-full bg-mn-bg-elevated/80 px-1.5 py-0.5 text-[11px] text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/70",children:He.map(E=>e.jsxs("button",{type:"button",onClick:()=>Fe.mutate({messageId:t.id,emoji:E.emoji}),className:`inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 transition transform hover:bg-mn-bg hover:scale-110 active:scale-90 ${E.reactedBySelf?"bg-mn-primary/5 ring-1 ring-mn-primary/40":""}`,children:[e.jsx("span",{className:"text-[17px]",children:E.emoji}),E.count>1&&e.jsx("span",{className:"text-[10px] text-mn-text-secondary",children:E.count})]},E.emoji))})}),Ne===t.id&&!O&&e.jsx("div",{className:`mt-1 flex w-full ${f?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsxs("div",{className:"inline-flex flex-col items-stretch gap-1 rounded-2xl bg-mn-bg-elevated/95 px-2.5 py-1.5 text-[11px] text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/70 select-none",children:[e.jsx("div",{className:"flex items-center justify-center gap-1",children:Ot.map(E=>e.jsx("button",{type:"button",onClick:()=>{Fe.mutate({messageId:t.id,emoji:E}),z(null)},className:"flex h-7 w-7 items-center justify-center rounded-full transition transform hover:bg-mn-bg hover:-translate-y-0.5 hover:scale-110 active:scale-90",children:e.jsx("span",{className:"text-[17px]",children:E})},E))}),f&&e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>{Z({messageId:t.id,text:Ge(t.body)??""}),ee(null),z(null),S.current&&S.current.blur()},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] text-mn-text-secondary hover:bg-mn-bg",children:[e.jsx(Pt,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Edit"})]}),e.jsxs("button",{type:"button",onClick:()=>{J({messageId:t.id}),z(null)},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] text-mn-error hover:bg-mn-bg",children:[e.jsx(Ze,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Delete"})]})]})]})}),e.jsx("div",{className:`flex w-full ${f?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:"mt-0.5 flex flex-wrap items-center gap-1 text-[10px] text-mn-text-muted",children:[e.jsx("span",{children:de(t.createdAt)}),Ke&&!O&&e.jsxs("span",{children:["Â· edited ",de(Ke)]}),O&&Ye&&e.jsxs("span",{children:["Â· deleted ",de(Ye)]}),f&&kt&&U&&!O&&e.jsxs("span",{className:"inline-flex items-center gap-0.5",children:[U.status==="sending"&&e.jsx(Q,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),U.status==="sent"&&e.jsx(qt,{className:"h-3 w-3","aria-hidden":"true"}),U.status==="delivered"&&e.jsx(Je,{className:"h-3 w-3","aria-hidden":"true"}),U.status==="seen"&&e.jsxs(e.Fragment,{children:[e.jsx(Je,{className:"h-3 w-3 text-mn-primary","aria-hidden":"true"}),U.seenAt&&e.jsx("span",{children:de(U.seenAt)})]})]})]})})]})]},t.id)}),K.length>0&&e.jsxs("div",{className:"mt-1 flex items-center justify-start gap-2 text-[11px] text-mn-text-muted",children:[e.jsx("span",{children:F?K.length===1?`${K[0]} is typingâ€¦`:K.length===2?`${K[0]} and ${K[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"})]})]}),e.jsx("div",{ref:re})]}),ae&&e.jsx("div",{ref:ue,className:"absolute bottom-[4.25rem] left-4 z-30 rounded-2xl border border-mn-border-subtle/60 bg-mn-bg-elevated/95 p-2 shadow-mn-card",children:e.jsx("div",{className:"flex max-w-[260px] flex-wrap gap-1.5",children:["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ”¥","â­","âœ¨","ðŸ‘€","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"].map(t=>e.jsx("button",{type:"button",onClick:()=>{ct(t),ie(!1)},className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-mn-bg text-lg transition hover:bg-mn-bg/70",children:e.jsx("span",{children:t})},t))})})]}),!$&&!q&&e.jsxs("form",{onSubmit:ut,className:"sticky bottom-0 z-20 flex-shrink-0 space-y-2 border-t border-mn-border-subtle/70 bg-mn-bg/95 px-4 py-3 backdrop-blur",children:[b&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-mn-border-subtle/70 bg-mn-bg px-3 py-2 text-[11px] text-mn-error",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),M&&e.jsx("button",{type:"button",onClick:mt,className:"inline-flex items-center gap-1 rounded-full bg-mn-primary/10 px-2 py-1 text-[11px] font-semibold text-mn-primary ring-1 ring-mn-primary/40 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:e.jsx("span",{children:"Retry"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",ref:ce,onClick:()=>ie(t=>!t),className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Add emoji",children:e.jsx(Ft,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:ft,className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Send photo",children:e.jsx(We,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:fe,accept:"image/*",className:"hidden",onChange:xt}),e.jsx("div",{className:"flex min-h-[44px] max-h-[160px] flex-1 items-center rounded-full bg-mn-bg px-4 py-2.5 text-[13px] text-mn-text-primary shadow-inner ring-1 ring-mn-border-subtle/70 focus-within:outline-none focus-within:ring-0 focus-within:shadow-none",children:e.jsx("textarea",{id:"conversation-message",value:v,ref:S,onChange:dt,onKeyDown:t=>{var a;t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),v.trim()&&((a=t.currentTarget.form)==null||a.requestSubmit()))},placeholder:"Messageâ€¦",rows:1,className:"max-h-[160px] flex-1 resize-none bg-transparent text-[13px] text-mn-text-primary outline-none placeholder:text-mn-text-muted focus:border-transparent focus:outline-none focus:ring-0 focus:shadow-none"})}),e.jsx("button",{type:"submit",onMouseDown:t=>t.preventDefault(),onTouchStart:t=>t.preventDefault(),disabled:!v.trim(),className:"inline-flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-r from-fuchsia-500 via-mn-primary to-blue-500 text-white shadow-lg shadow-mn-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:e.jsx(Ve,{className:"h-4 w-4","aria-hidden":"true"})})]})]}),q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),$&&!q&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),X&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"w-[min(480px,calc(100%-2.5rem))] rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-mn-text-primary",children:"Edit message"}),e.jsx("button",{type:"button",onClick:()=>{Z(null),ee(null)},className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close edit message",children:e.jsx(Re,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("div",{className:"mt-3 rounded-2xl bg-mn-bg px-3 py-2 ring-1 ring-mn-border-subtle/70",children:e.jsx("textarea",{value:X.text,onChange:t=>Z(a=>a&&{...a,text:t.target.value}),rows:3,className:"w-full resize-none border-0 bg-transparent text-[13px] text-mn-text-primary outline-none focus:outline-none focus:ring-0"})}),$e&&e.jsx("p",{className:"mt-2 text-[11px] text-mn-error",children:$e}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2 text-[13px]",children:[e.jsx("button",{type:"button",onClick:()=>{Z(null),ee(null)},className:"rounded-full px-3 py-1.5 text-mn-text-secondary hover:bg-mn-bg",children:"Cancel"}),e.jsxs("button",{type:"button",disabled:!X.text.trim()||we.isPending,onClick:()=>{const t=X.text.trim();t&&(ee(null),we.mutate({messageId:X.messageId,text:t},{onSuccess:()=>{Z(null)},onError:()=>{ee("Couldn't save changes. Please try again.")}}))},className:"inline-flex items-center gap-1 rounded-full bg-mn-primary px-3 py-1.5 text-white shadow-mn-soft disabled:cursor-not-allowed disabled:opacity-60",children:[we.isPending&&e.jsx(Q,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),_e&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"w-[min(420px,calc(100%-2.5rem))] rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-mn-error/10 text-mn-error",children:e.jsx(Ze,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("h2",{className:"text-[15px] font-semibold text-mn-text-primary",children:"Delete message"})]}),e.jsx("button",{type:"button",onClick:()=>J(null),className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close delete dialog",children:e.jsx(Re,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("p",{className:"mt-3 text-[12px] text-mn-text-secondary",children:"Choose whether to remove this message only from your chat or from the conversation for everyone."}),e.jsxs("div",{className:"mt-5 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{ot(t=>({...t,[_e.messageId]:!0})),J(null)},className:"flex-1 rounded-full bg-mn-bg px-3 py-2 text-[13px] font-semibold text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/80 transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated",children:"Delete for me"}),e.jsxs("button",{type:"button",disabled:je.isPending,onClick:()=>{je.mutate({messageId:_e.messageId},{onSettled:()=>{J(null)}})},className:"flex-1 inline-flex items-center justify-center gap-1 rounded-full bg-mn-error px-3 py-2 text-[13px] font-semibold text-white shadow-mn-soft transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",children:[je.isPending&&e.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]}),e.jsx("button",{type:"button",onClick:()=>J(null),className:"self-center text-[12px] text-mn-text-secondary hover:text-mn-text-primary",children:"Cancel"})]})]})}),tt&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-[min(520px,calc(100%-2rem))] rounded-3xl border border-mn-border-subtle/70 bg-mn-bg/95 p-5 shadow-2xl",children:[e.jsx("button",{type:"button",onClick:Oe,className:"absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close gallery picker",children:e.jsx(Re,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"flex items-start gap-3 pr-10",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 text-mn-text-primary ring-1 ring-mn-border-subtle",children:e.jsx(We,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-mn-text-primary",children:"Send from your gallery"}),e.jsx("p",{className:"text-[12px] text-mn-text-secondary",children:"Pick a recent photo to drop into the chatâ€”just like Instagram DMs."})]})]}),e.jsxs("div",{className:"mt-4 rounded-2xl border border-dashed border-mn-border-subtle/80 bg-mn-bg/80 p-4",children:[T?e.jsx("div",{className:"overflow-hidden rounded-xl border border-mn-border-subtle/70 bg-mn-bg-elevated/80",children:e.jsx("img",{src:T,alt:"Selected",className:"max-h-[320px] w-full object-cover"})}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-10 text-center text-mn-text-muted",children:[e.jsx(Xe,{className:"h-8 w-8","aria-hidden":"true"}),e.jsx("p",{className:"text-[13px] text-mn-text-secondary",children:"Choose a photo from your camera roll."})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=fe.current)==null?void 0:t.click()},className:"inline-flex items-center gap-2 rounded-full bg-mn-bg-elevated/80 px-4 py-2 text-[13px] font-semibold text-mn-text-primary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:[e.jsx(Xe,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:"Choose another photo"})]}),e.jsxs("button",{type:"button",onClick:gt,disabled:!oe||me,className:"inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-fuchsia-500 via-mn-primary to-blue-500 px-4 py-2 text-[13px] font-semibold text-white Ø§Ù„ÙƒØ±Ø©shadow-lg shadow-mn-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:[me?e.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(Ve,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:me?"Sendingâ€¦":"Send photo"})]})]})]})]})})]}):e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-mn-card border border-mn-border-subtle bg-mn-bg-elevated/80 px-5 py-6 text-center text-sm text-mn-text-primary shadow-mn-card",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-mn-text-secondary",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Rt,{to:"/messages",className:"inline-flex items-center justify-center rounded-full border border-mn-border-subtle bg-mn-bg px-3 py-1.5 text-[12px] font-medium text-mn-text-primary shadow-mn-soft transition hover:border-mn-primary/70 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:"Back to messages"})})]})})},Ee=(r,s)=>r.getFullYear()===s.getFullYear()&&r.getMonth()===s.getMonth()&&r.getDate()===s.getDate(),Jt=r=>{const s=new Date(r);if(Number.isNaN(s.getTime()))return"";const o=new Date,n=new Date;return n.setDate(o.getDate()-1),Ee(s,o)?"Today":Ee(s,n)?"Yesterday":s.toLocaleDateString(void 0,{day:"numeric",month:"short",year:"numeric"})},et=(r,s,o=180*1e3)=>{const n=new Date(r),l=new Date(s);return Number.isNaN(n.getTime())||Number.isNaN(l.getTime())?!1:l.getTime()-n.getTime()<=o},Xt=(r,s,o,n,l)=>{if(!s||!l||r.senderId!==l)return null;if(r.id.startsWith("temp-"))return{status:"sending"};const m=s.participants.filter(b=>!b.isSelf);if(m.length===0)return null;const c=m.map(b=>b.id),i=new Date(r.createdAt).getTime(),j=(o??[]).filter(b=>b.messageId===r.id&&c.includes(b.userId)).length,k=n??[];let v=0,h=null;for(const b of m){const C=k.find(L=>L.userId===b.id);if(!C||!C.lastReadAt)continue;const M=new Date(C.lastReadAt).getTime();Number.isNaN(M)||M>=i&&(v+=1,(h===null||M>h)&&(h=M))}return v===m.length&&m.length>0?{status:"seen",seenAt:h!=null?new Date(h).toISOString():null}:j>0?{status:"delivered"}:{status:"sent"}};export{nn as default};
