import{c as de,s as P,r as i,b as q,G as Xt,H as ue,k as fe,l as Ie,I as ze,J as Zt,K as es,N as ts,O as ss,R as se,j as a,D as ns,x as Q,B,w as rs,u as as,n as os,L as is}from"./index-C0YC7Lqk.js";import{c as me,m as ge,a as ls,M as Ee,s as cs,i as We,b as Ge,d as Je,e as Ve,f as us,g as ds,h as fs,n as ms,j as gs,k as Ye,r as Xe,l as ps,o as Ze,p as hs,C as xs,q as ys,P as bs,t as vs,v as ws,S as Rs,T as et,D as tt,w as st,x as nt,y as rt,z as at,A as ot,B as Ms,u as Ss,E as Cs,F as Ns,G as js,H as Is}from"./dialog-YBnO-OY2.js";import{u as _e}from"./useMutation-B6WiSsoN.js";import{Y as Es}from"./index-B38AejhK.js";import{B as _s}from"./bell-DNaUqZ7Z.js";import{C as Ts}from"./circle-alert-LlY99HjW.js";import"./index-2QA0ZcLJ.js";import"./users-CdKu7Qpk.js";import"./format-DWLSBLoY.js";const ks=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Ds=de("arrow-down",ks);const Ls=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],As=de("camera",Ls);const Ps=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Fs=de("send",Ps);const Bs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Us=de("smile",Bs),je=new Map,Os=e=>{const t=je.get(e);if(t)return t;const s=P.channel(`conversation-db-${e}`),n={conversationId:e,channel:s,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageInsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageUpdateListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionDeleteListeners)l(o)}),s.subscribe(r=>{const o=r;n.lastStatus=o;for(const l of n.statusListeners)l(o)}),je.set(e,n),n},qs=(e,t)=>{const s=Os(e);s.refCount+=1;const n=[];return t.onStatus&&(s.statusListeners.add(t.onStatus),n.push(()=>s.statusListeners.delete(t.onStatus)),s.lastStatus&&t.onStatus(s.lastStatus)),t.onMessageInsert&&(s.messageInsertListeners.add(t.onMessageInsert),n.push(()=>s.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(s.messageUpdateListeners.add(t.onMessageUpdate),n.push(()=>s.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(s.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),n.push(()=>s.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(s.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),n.push(()=>s.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(s.reactionUpsertListeners.add(t.onReactionUpsert),n.push(()=>s.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(s.reactionDeleteListeners.add(t.onReactionDelete),n.push(()=>s.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const r of n)r();if(s.refCount-=1,s.refCount<=0){try{P.removeChannel(s.channel)}catch{}je.delete(e)}}},pe=(e,t,s)=>{i.useEffect(()=>{if(e)return qs(e,t())},[e,t,...s])},$s=2e3,Hs=15e3,Ks=e=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:e?$s:!1,refetchIntervalInBackground:!1}),zs=["CHANNEL_ERROR","TIMED_OUT","CLOSED","UNSUBSCRIBED"],Qs=e=>zs.includes(e),Ws=3e3,Gs=e=>{const[t,s]=i.useState(!1),n=i.useRef(null),[r,o]=i.useState(e);e!==r&&(o(e),s(!1),n.current&&(clearTimeout(n.current),n.current=null));const l=i.useCallback(g=>{if(Qs(g)){if(n.current)return;n.current=window.setTimeout(()=>{n.current=null,s(!0)},Ws);return}n.current&&(clearTimeout(n.current),n.current=null),s(!1)},[]);return{pollWhenRealtimeDown:t,onStatus:l}},he=e=>{const{pollWhenRealtimeDown:t,onStatus:s}=Gs(e);return{pollWhenRealtimeDown:t,onRealtimeStatus:s,refetchOptions:Ks(t)}},Js=e=>typeof e=="object"&&e!==null,it=e=>e.new,Vs=e=>e.old,Y=(e,t)=>{if(!Js(e))return null;const s=e[t];return typeof s=="string"?s:null},lt=(e,t)=>Y(e,"conversation_id")===t,ct=40,ce=1e5,Ys=e=>{const t=e.createdAt,s=e.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${s})`},Xs=e=>{const t=cs((e??[]).map(ge)),s=(e??[]).length>=ct,n=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:s,cursor:n}},Zs=(e,t)=>{const s=q(),n=me(e),[r,o]=i.useState(ce),{pollWhenRealtimeDown:l,onRealtimeStatus:g,refetchOptions:c}=he(e),f=i.useRef(t);i.useEffect(()=>{f.current=t},[t]);const y=i.useRef({pages:0,total:0}),p=Xt({queryKey:n,enabled:!!e,initialPageParam:null,...c,staleTime:Hs,queryFn:async({pageParam:x})=>{if(!e)return{items:[],hasMore:!1,cursor:null};let m=P.from("messages").select(Ee).eq("conversation_id",e).order("created_at",{ascending:!1}).order("id",{ascending:!1});x&&(m=m.or(Ys(x)));const{data:v,error:M}=await m.limit(ct);if(M)throw console.error(`[useConversationMessages] Failed to load ${x?"older messages":"messages"}`,M),new Error(M.message);return Xs(v??[])},getNextPageParam:()=>{},getPreviousPageParam:x=>{if(x.hasMore)return x.cursor??void 0}});i.useEffect(()=>{const x=p.data?.pages??[],m=x.reduce((E,k)=>E+k.items.length,0),v=y.current;if(x.length===0){y.current={pages:0,total:0},o(ce);return}if(v.pages===0){y.current={pages:x.length,total:m},o(ce);return}const M=m-v.total,N=x.length-v.pages;M>0&&N>0&&o(E=>Math.max(0,E-M)),y.current={pages:x.length,total:m}},[p.data?.pages]);const b=i.useCallback(()=>{if(!e)return{};const x=(m,v)=>{const M=it(m);if(!lt(M,e)||!Y(M,"id"))return;const E=M,k=ge(E);s.setQueryData(n,w=>ls(w,E)),v==="insert"?f.current?.onInsert?.(k):f.current?.onUpdate?.(k)};return{onStatus:g,onMessageInsert:m=>{x(m,"insert")},onMessageUpdate:m=>{x(m,"update")}}},[e,g,s,n]);pe(e,b,[]),i.useEffect(()=>{o(ce),y.current={pages:0,total:0}},[e]);const u=i.useMemo(()=>(p.data?.pages??[]).flatMap(m=>m.items),[p.data?.pages]),d=i.useCallback(async()=>{e&&p.hasPreviousPage&&await p.fetchPreviousPage()},[e,p]);return i.useMemo(()=>({data:u,isLoading:p.isLoading,isFetching:p.isFetching,isError:p.isError,error:p.error,refetch:p.refetch,loadOlder:d,hasMore:!!p.hasPreviousPage,isLoadingOlder:p.isFetchingPreviousPage,firstItemIndex:r,queryKey:n,pollWhenRealtimeDown:l}),[u,p.isLoading,p.isFetching,p.isError,p.error,p.refetch,d,p.hasPreviousPage,p.isFetchingPreviousPage,r,n,l])};function en(e){const{conversation:t,deliveryReceipts:s,readReceipts:n,currentUserId:r,failedMessages:o,onlyMessageIds:l,messageCreatedAtMsById:g}=e;if(!t||!r)return()=>null;const c=t.participants.filter(u=>!u.isSelf);if(c.length===0)return()=>null;const f=new Set(c.map(u=>u.id)),y=u=>{if(!u)return null;const d=g?.get(u);return d??null},p=new Map;for(const u of n??[]){let d=null;if(u.lastReadMessageId){const m=y(u.lastReadMessageId);m!=null&&(d=m)}if(d==null&&u.lastReadAt){const m=new Date(u.lastReadAt).getTime();Number.isNaN(m)||(d=m)}if(d==null)continue;const x=p.get(u.userId);(x==null||d>x)&&p.set(u.userId,d)}const b=new Map;for(const u of s??[]){if(!f.has(u.userId)||l&&!l.has(u.messageId))continue;let d=b.get(u.messageId);d||(d=new Set,b.set(u.messageId,d)),d.add(u.userId)}return u=>{if(u.senderId!==r)return null;if(o[u.id])return{status:"failed"};if(We(u.id))return{status:"sending"};const d=(()=>{const M=new Date(u.createdAt??"").getTime();return Number.isNaN(M)?0:M})();let x=0,m=null;for(const M of c){const N=p.get(M.id);N!=null&&N>=d&&(x+=1,(m===null||N>m)&&(m=N))}return x===c.length&&c.length>0?{status:"seen",seenAt:m!=null?new Date(m).toISOString():null}:(b.get(u.id)?.size??0)===c.length&&c.length>0?{status:"delivered"}:{status:"sent"}}}function tn(e){const{messages:t,conversation:s,currentUserId:n,participantsById:r,reactionsByMessageId:o,hiddenMessageIds:l,deliveryReceipts:g,readReceipts:c,failedMessages:f,lastOwnMessageId:y}=e,p=i.useMemo(()=>{if(!t)return[];const u=new Set;y&&u.add(y);for(const m of Object.keys(f))u.add(m);const d=new Map;for(const m of t){const v=new Date(m.createdAt??"").getTime();Number.isNaN(v)||d.set(m.id,v)}const x=en({conversation:s??null,deliveryReceipts:g,readReceipts:c,currentUserId:n,failedMessages:f,onlyMessageIds:u,messageCreatedAtMsById:d});return t.map(m=>{const v=ue(m.body),M=r.get(m.senderId)??null,N=M?.isSelf??(n!=null&&m.senderId===n),E=N&&u.has(m.id)?x(m):null,k=!!E&&N&&!v.deleted&&(E.status==="failed"||y===m.id);return{message:m,meta:v,sender:M,isSelf:N,deliveryStatus:E,showDeliveryStatus:k,reactions:o.get(m.id)??[]}})},[s,n,g,f,y,t,r,o,c]),b=i.useMemo(()=>p.filter(({message:u})=>!l[u.id]),[p,l]);return{uiMessages:p,visibleMessages:b}}function sn(e){const{messages:t,currentUserId:s,hiddenMessageIds:n}=e;return i.useMemo(()=>{if(!t||!s)return null;for(let r=t.length-1;r>=0;r-=1){const o=t[r];if(!(n[o.id]||o.senderId!==s||ue(o.body).deleted))return o.id}return null},[n,t,s])}const nn=async e=>{const{data:t,error:s}=await P.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",e).order("last_read_at",{ascending:!1}).returns();if(s)throw console.error("[useConversationReadReceipts] Failed to load",s),new Error(s.message);return(t??[]).map(Je)},rn=async(e,t)=>{if(t.length===0)return[];const s=P.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",e).in("message_id",t),{data:n,error:r}=await s.order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationDeliveryReceipts] Failed to load",r),new Error(r.message);return(n??[]).map(Ve)},an=async e=>{const{data:t,error:s}=await P.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",e).order("created_at",{ascending:!0}).returns();if(s)throw console.error("[useConversationReactions] Failed to load reactions",s),new Error(s.message);return(t??[]).map(Ge)},on=(e,t)=>{const s=new Map,n=new Map;for(const o of e){let l=s.get(o.messageId);l||(l=new Map,s.set(o.messageId,l),n.set(o.messageId,[]));let g=l.get(o.emoji);g||(g={emoji:o.emoji,count:0,reactedBySelf:!1},l.set(o.emoji,g),n.get(o.messageId).push(o.emoji)),g.count+=1,t&&o.userId===t&&(g.reactedBySelf=!0)}const r=new Map;for(const[o,l]of s.entries()){const g=n.get(o)??[];r.set(o,g.map(c=>l.get(c)).filter(Boolean))}return r},ln=(e,t,s)=>{const n=e??[],r=s.key(t),o=[...n],l=o.findIndex(g=>s.key(g)===r);return l>=0?o[l]=t:o.push(t),s.sort&&o.sort(s.sort),o},cn=(e,t,s)=>{const n=e??[];return n.length===0?[]:n.filter(r=>s.key(r)!==t)},Te=e=>t=>{const s=it(t);if(!lt(s,e.conversationId)||e.extraGuard&&!e.extraGuard(s)||!(e.getRequiredId?e.getRequiredId(s):Y(s,"id")))return;const r=s,o=e.mapRow(r);e.queryClient.setQueryData(e.queryKey,l=>ln(l,o,{key:e.key,sort:e.sort}))},un=e=>t=>{const s=Vs(t),n=e.getRowId?e.getRowId(s):Y(s,"id");if(!n){e.invalidateWhenMissingId!==!1&&e.queryClient.invalidateQueries({queryKey:e.queryKey});return}e.queryClient.setQueryData(e.queryKey,r=>cn(r,n,{key:e.key}))},dn=e=>{const{user:t}=fe(),s=t?.id??null,n=q(),r=us(e),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:g}=he(e),c=Ie({queryKey:r,enabled:!!e,...g,queryFn:()=>e?an(e):Promise.resolve([])}),f=i.useCallback(()=>{if(!e)return{};const b=Te({conversationId:e,queryClient:n,queryKey:r,mapRow:Ge,key:d=>d.id,sort:(d,x)=>{const m=ze(d.createdAt),v=ze(x.createdAt);return m!==v?m-v:d.id.localeCompare(x.id)}}),u=un({queryClient:n,queryKey:r,key:d=>d.id});return{onStatus:l,onReactionUpsert:b,onReactionDelete:u}},[e,l,n,r]);pe(e,f,[]);const y=_e({mutationFn:async({messageId:b,emoji:u})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to react to messages.");const{error:d}=await P.from("message_reactions").insert({conversation_id:e,message_id:b,user_id:s,emoji:u});if(d){if(d?.code==="23505"){const{error:x}=await P.from("message_reactions").delete().eq("message_id",b).eq("user_id",s).eq("emoji",u);if(x)throw console.error("[useConversationReactions] Failed to remove reaction",x),x;return}throw console.error("[useConversationReactions] Failed to toggle reaction",d),d}},onMutate:async({messageId:b,emoji:u})=>{if(!e||!s)return{previousReactions:void 0};await n.cancelQueries({queryKey:r});const d=n.getQueryData(r);return n.setQueryData(r,x=>{const m=x??[],v=m.findIndex(N=>N.messageId===b&&N.userId===s&&N.emoji===u);if(v>=0){const N=[...m];return N.splice(v,1),N}const M={id:ds(),conversationId:e,messageId:b,userId:s,emoji:u,createdAt:new Date().toISOString()};return[...m,M]}),{previousReactions:d}},onError:(b,u,d)=>{e&&(d?.previousReactions?n.setQueryData(r,d.previousReactions):n.invalidateQueries({queryKey:r}))},onSuccess:()=>{e&&n.invalidateQueries({queryKey:r})}}),p=i.useMemo(()=>{const b=c.data??[];return on(b,s)},[c.data,s]);return{reactions:c.data??[],reactionsByMessageId:p,isLoadingReactions:c.isLoading,toggleReaction:y,pollWhenRealtimeDown:o,queryKey:r}},fn=e=>{const t=q(),s=fs(e),{pollWhenRealtimeDown:n,onRealtimeStatus:r,refetchOptions:o}=he(e),l=Ie({queryKey:s,enabled:!!e,...o,queryFn:async()=>e?nn(e):[]}),g=i.useCallback(()=>{if(!e)return{};const c=Te({conversationId:e,queryClient:t,queryKey:s,mapRow:Je,key:f=>f.userId,getRequiredId:f=>Y(f,"user_id"),sort:(f,y)=>{const p=!f.lastReadAt,b=!y.lastReadAt;if(p&&b)return 0;if(p)return 1;if(b)return-1;const u=new Date(f.lastReadAt).getTime(),d=new Date(y.lastReadAt).getTime();return Number.isNaN(u)&&Number.isNaN(d)?0:Number.isNaN(u)?1:Number.isNaN(d)?-1:d-u}});return{onStatus:r,onReadReceiptUpsert:c}},[e,r,t,s]);return pe(e,g,[]),i.useMemo(()=>({...l,pollWhenRealtimeDown:n,queryKey:s}),[l,n,s])},mn=(e,t)=>{const s=q(),n=i.useMemo(()=>ms(t,{excludeTemp:!0,sort:!0}),[t]),r=gs(e,n),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:g}=he(e),c=Ie({queryKey:r,enabled:!!(e&&n.length>0),...g,queryFn:async()=>e?n.length===0?[]:rn(e,n):[]}),f=i.useCallback(()=>{if(!e)return{};if(n.length===0)return{};const p=new Set(n),b=Te({conversationId:e,queryClient:s,queryKey:r,mapRow:Ve,key:u=>u.id,extraGuard:u=>{const d=Y(u,"message_id");return!!(d&&p.has(d))},sort:(u,d)=>{const x=new Date(u.deliveredAt??"").getTime(),m=new Date(d.deliveredAt??"").getTime(),v=Number.isNaN(x)?0:x,M=Number.isNaN(m)?0:m;return v-M}});return{onStatus:l,onDeliveryReceiptUpsert:b}},[e,n,l,s,r]),y=e&&n.length>0?e:null;return pe(y,f,[]),i.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},gn=3e3,pn=2e3,hn=5e3,xn=e=>{const{conversationId:t,userId:s,displayName:n}=e,[r,o]=i.useState({}),l=i.useRef(null),g=i.useRef(new Map),c=i.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),f=i.useCallback(async u=>{if(!t||!s||!n)return;const d=l.current;d&&await d.send({type:"broadcast",event:"typing",payload:{userId:s,displayName:n,isTyping:u}})},[t,s,n]),y=i.useCallback(async()=>{c.current.timeoutId!=null&&(window.clearTimeout(c.current.timeoutId),c.current.timeoutId=null),c.current.isTyping&&(c.current.isTyping=!1,c.current.lastSentAtMs=0,await f(!1))},[f]),p=i.useCallback(u=>{if(!t||!s||!n||!l.current)return;const x=c.current.isTyping;if(u){const m=Date.now();x?m-c.current.lastSentAtMs>pn&&(c.current.lastSentAtMs=m,f(!0)):(c.current.isTyping=!0,c.current.lastSentAtMs=m,f(!0)),c.current.timeoutId!=null&&window.clearTimeout(c.current.timeoutId),c.current.timeoutId=window.setTimeout(()=>{c.current.isTyping=!1,c.current.lastSentAtMs=0,c.current.timeoutId=null,f(!1)},gn);return}x&&y()},[f,t,n,y,s]);return i.useEffect(()=>{if(!t)return;const u=P.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});l.current=u,u.on("broadcast",{event:"typing"},({payload:m})=>{const v=m;if(!v?.userId||s&&v.userId===s)return;o(N=>{const E={...N};return v.isTyping&&v.displayName?E[v.userId]=v.displayName:delete E[v.userId],E});const M=g.current.get(v.userId);if(M!=null&&window.clearTimeout(M),v.isTyping){const N=window.setTimeout(()=>{o(E=>{const k={...E};return delete k[v.userId],k}),g.current.delete(v.userId)},hn);g.current.set(v.userId,N)}else g.current.delete(v.userId)}).subscribe();const d=()=>{document.visibilityState==="hidden"&&y()},x=()=>{y()};return document.addEventListener("visibilitychange",d),window.addEventListener("beforeunload",x),window.addEventListener("pagehide",x),window.addEventListener("blur",x),()=>{document.removeEventListener("visibilitychange",d),window.removeEventListener("beforeunload",x),window.removeEventListener("pagehide",x),window.removeEventListener("blur",x),g.current.forEach(m=>window.clearTimeout(m)),g.current.clear(),y(),l.current&&(P.removeChannel(l.current),l.current=null)}},[t,y,s]),{remoteTypingUsers:i.useMemo(()=>Object.values(r),[r]),noteLocalInputActivity:p,stopTyping:y}},yn=e=>{const{conversationId:t,storageKeyPrefix:s="messages:draft:",hydrate:n,debounceMs:r=250}=e,[o,l]=i.useState("");return i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.localStorage.getItem(c);f!=null&&f!==o&&(l(f),n?.(f))},[t]),i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.setTimeout(()=>{o.trim().length===0?window.localStorage.removeItem(c):window.localStorage.setItem(c,o)},r);return()=>window.clearTimeout(f)},[t,r,o,s]),{draft:o,setDraft:l,clearDraft:()=>l("")}};function bn({showComposer:e,initialHeaderHeight:t=72,initialComposerHeight:s=160}){const n=i.useRef(null),[r,o]=i.useState(t),[l,g]=i.useState(s),[c,f]=i.useState(!0),[y,p]=i.useState(!1),b=i.useCallback(u=>g(Math.max(u,r)),[r]);return i.useEffect(()=>{const u=n.current;if(!u)return;const d=()=>o(Math.max(u.getBoundingClientRect().height,0));if(d(),typeof ResizeObserver>"u")return;const x=new ResizeObserver(d);return x.observe(u),()=>x.disconnect()},[]),i.useEffect(()=>{g(u=>Math.max(u,r))},[r]),i.useEffect(()=>{e||g(0)},[e]),{headerRef:n,headerHeight:r,composerHeight:l,isAtBottom:c,setIsAtBottom:f,handleComposerHeightChange:b,showEmojiPicker:y,setShowEmojiPicker:p}}const vn=({conversationId:e,currentUserId:t,showComposer:s,isBlocked:n,blockedYou:r,composerTextareaRef:o})=>{const[l,g]=i.useState(null),[c,f]=i.useState({}),[y,p]=i.useState(null),[b,u]=i.useState(null),[d,x]=i.useState(null),m=i.useRef(null),v=i.useRef(null);i.useEffect(()=>{if(!e||!t){f({});return}if(typeof window>"u")return;const I=`messages:hidden:${t}:${e}`;try{const D=window.localStorage.getItem(I);if(!D){f({});return}const F=JSON.parse(D);if(Array.isArray(F)){const T={};for(const j of F)typeof j=="string"&&j&&(T[j]=!0);f(T);return}if(F&&typeof F=="object"){const T={};for(const[j,L]of Object.entries(F))L&&(T[j]=!0);f(T);return}f({})}catch{f({})}},[e,t]),i.useEffect(()=>{if(!e||!t||typeof window>"u")return;const I=`messages:hidden:${t}:${e}`;try{const D=Object.keys(c).filter(F=>c[F]);window.localStorage.setItem(I,JSON.stringify(D))}catch{}},[e,t,c]);const M=i.useCallback(()=>{g(null)},[]),N=i.useCallback(I=>{n||r||ue(I.body).deleted||(g(I.id),o.current?.blur())},[r,o,n]),E=i.useCallback((I,D)=>{n||r||ue(I.body).deleted||(D&&(v.current=D),u({messageId:I.id,text:Zt(I.body)??"",body:I.body??null,attachmentUrl:I.attachmentUrl??null}),x(null),M(),o.current?.blur())},[r,M,o,n]),k=i.useCallback(I=>{u(D=>D&&{...D,text:I})},[]),w=i.useCallback(()=>{u(null),x(null),v.current?.focus()},[]);i.useEffect(()=>{b&&queueMicrotask(()=>{m.current?.focus()})},[b]);const R=i.useCallback(I=>{n||r||(M(),p({messageId:I.id,attachmentUrl:I.attachmentUrl??null}),o.current?.blur())},[r,M,o,n]),S=i.useCallback(()=>{p(null)},[]),_=i.useCallback(I=>{f(D=>({...D,[I]:!0}))},[]);return i.useEffect(()=>{l===null&&s&&(b||y||queueMicrotask(()=>o.current?.focus()))},[l,y,b,s,o]),{activeActionMessageId:l,openMessageActions:N,closeMessageActions:M,hiddenMessageIds:c,hideMessageForMe:_,deleteDialog:y,openDeleteDialog:R,closeDeleteDialog:S,editingMessage:b,openEditDialog:E,updateEditingText:k,closeEditDialog:w,editTextareaRef:m,editError:d,setEditError:x}},ut=e=>e.code==="42P10"||/no unique or exclusion constraint matching the ON CONFLICT specification/i.test(e.message??""),dt=e=>e.code==="23505"||/duplicate key value violates unique constraint/i.test(e.message??"");let Ce=null,Ne=null;const wn=async e=>{if(Ce!==!1){const{error:s}=await P.from("message_delivery_receipts").upsert(e,{onConflict:"conversation_id,message_id,user_id"});if(!s){Ce=!0;return}if(ut(s))Ce=!1;else{console.error("[writeDeliveryReceipt] Failed to write delivery receipt",s);return}}const{error:t}=await P.from("message_delivery_receipts").insert(e);t&&!dt(t)&&console.error("[writeDeliveryReceipt] Failed to insert delivery receipt",t)},Rn=async e=>{if(Ne!==!1){const{error:s}=await P.from("message_read_receipts").upsert(e,{onConflict:"conversation_id,user_id"});if(!s){Ne=!0;return}if(ut(s))Ne=!1;else{console.error("[writeReadReceipt] Failed to write read receipt",s);return}}const{error:t}=await P.from("message_read_receipts").insert(e);t&&!dt(t)&&console.error("[writeReadReceipt] Failed to insert read receipt",t)},Qe=3e3;function Mn(e){const{conversationId:t,userId:s,isAtBottom:n,messages:r}=e,o=q(),l=i.useRef({conversationId:null,messageId:null,userId:null}),g=i.useRef({lastSentAt:0,timeoutId:null,pending:null});i.useEffect(()=>{l.current={conversationId:null,messageId:null,userId:null};const c=g.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null,c.pending=null,c.lastSentAt=0},[t,s]),i.useEffect(()=>()=>{const c=g.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null},[]),i.useEffect(()=>{if(!t||!r||r.length===0||!s||!n)return;const c=r[r.length-1];if(We(c.id)||l.current.conversationId===t&&l.current.messageId===c.id&&l.current.userId===s)return;const f=g.current,y=Date.now(),p=f.lastSentAt?y-f.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{Ye(o,t,d=>d.hasUnread?{...d,hasUnread:!1}:d)},u=d=>{f.lastSentAt=Date.now();const x=new Date().toISOString();Rn({conversation_id:t,user_id:s,last_read_message_id:d,last_read_at:x}).then(()=>{l.current={conversationId:t,messageId:d,userId:s},b()}).catch(m=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",m)})};if(p<Qe){f.pending={conversationId:t,userId:s,messageId:c.id},f.timeoutId==null&&(f.timeoutId=window.setTimeout(()=>{const d=g.current.pending;g.current.pending=null,g.current.timeoutId=null,d&&(l.current.conversationId===d.conversationId&&l.current.messageId===d.messageId&&l.current.userId===d.userId||d.conversationId!==t||d.userId!==s||u(d.messageId))},Math.max(Qe-p,0)));return}f.timeoutId!=null&&(window.clearTimeout(f.timeoutId),f.timeoutId=null,f.pending=null),u(c.id)},[t,r,s,o,n])}const Sn=e=>{const{user:t}=fe(),s=t?.id??null,n=q();return _e({mutationFn:async({messageId:r,text:o,currentBody:l,attachmentUrl:g})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to edit messages.");if(g)throw new Error("Cannot edit messages with attachments.");const c=es(l,o),{data:f,error:y}=await P.from("messages").update({body:c}).eq("id",r).eq("conversation_id",e).eq("user_id",s).select(Ee).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return ge(f)},onSuccess:r=>{if(!e)return;const o=me(e);n.setQueryData(o,l=>Xe(l,r))}})},Cn=e=>{const{user:t}=fe(),s=t?.id??null,n=q();return _e({mutationFn:async({messageId:r,attachmentUrl:o})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to delete messages.");const g={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},c=JSON.stringify(g),{data:f,error:y}=await P.from("messages").update({body:c,attachment_url:null}).eq("id",r).eq("conversation_id",e).eq("user_id",s).select(Ee).single();if(y)throw console.error("[useDeleteMessage] Failed to delete message",y),new Error(y.message);if(o)try{await Ze(o)}catch(b){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",b)}return ge(f)},onSuccess:r=>{if(!e)return;const o=me(e);n.setQueryData(o,l=>Xe(l,r)),n.invalidateQueries({queryKey:ps})}})};function Nn(e){const{conversationId:t,setDraft:s,messages:n}=e,r=q(),[o,l]=i.useState(null),[g,c]=i.useState(null),[f,y]=i.useState(null),[p,b]=i.useState({}),u=i.useRef({});i.useEffect(()=>{u.current=p},[p]);const[d,x]=i.useState(t);t!==d&&(x(t),l(null),c(null),y(null),b({}),u.current={}),i.useEffect(()=>()=>{const w=Object.values(u.current),R=Array.from(new Set(w.map(S=>S.attachmentPath).filter(S=>typeof S=="string"&&S.length>0&&!hs(S))));R.length!==0&&P.storage.from(xs).remove(R).then(({error:S})=>{S&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",S)}).catch(S=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",S)})},[t]),i.useEffect(()=>{n&&b(w=>{const R=new Set(n.map(I=>I.id));let S=!1;const _={...w};for(const I of Object.keys(_))R.has(I)||(delete _[I],S=!0);return S?_:w})},[n]);const m=i.useCallback(()=>{l(null),c(null),y(null)},[]),v=i.useCallback((w,R)=>{l("Couldn't send. Please try again."),R.text.trim()&&s(R.text),c(R),y(w),b(S=>({...S,[w]:R}))},[s]),M=i.useCallback(w=>{w&&(b(R=>{if(!(w in R))return R;const S={...R};return delete S[w],S}),w===f&&m())},[m,f]),N=i.useCallback(()=>{if(!g)return null;const w=f;return w&&b(R=>{if(!(w in R))return R;const S={...R};return delete S[w],S}),m(),{payload:g,tempId:w}},[m,g,f]),E=i.useCallback(w=>{const R=p[w];return R?(b(S=>{if(!(w in S))return S;const _={...S};return delete _[w],_}),w===f?m():l(null),R):null},[m,p,f]),k=i.useCallback(async w=>{if(!t)return;const R=p[w];if(!R)return;const S=me(t);if(r.setQueryData(S,_=>ys(_,w)),b(_=>{if(!(w in _))return _;const I={..._};return delete I[w],I}),w===f&&m(),R.attachmentPath)try{await Ze(R.attachmentPath)}catch(_){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",_)}},[m,t,p,f,r]);return{sendError:o,setSendError:l,lastFailedPayload:g,lastFailedTempId:f,failedMessages:p,clearBannerState:m,onSendFailed:v,onSendRecovered:M,consumeLastFailedForRetry:N,consumeFailedMessageForRetry:E,discardFailedMessage:k}}const jn=({currentUserId:e})=>{const t=q();return i.useCallback(s=>{Ye(t,s.conversationId,n=>{const r=!!(e&&s.senderId===e);return{...n,lastMessagePreview:ss(s.body)??n.lastMessagePreview,lastMessageAt:s.createdAt??n.lastMessageAt,lastMessageAtLabel:ts(s.createdAt??null),hasUnread:!r,lastMessageIsFromSelf:r,lastMessageSeenByOthers:r?!1:n.lastMessageSeenByOthers}},{moveToTop:!0}),e&&s.senderId!==e&&wn({conversation_id:s.conversationId,message_id:s.id,user_id:e})},[e,t])},In=({conversationId:e,userId:t,conversation:s,readReceipts:n,visibleMessages:r})=>{const[o,l]=i.useState(void 0),[g,c]=i.useState(void 0);return i.useEffect(()=>{l(void 0),c(void 0)},[e,t]),i.useEffect(()=>{if(!e||!t||o!==void 0)return;const y=(n??[]).find(p=>p.userId===t)??null;l(y?.lastReadMessageId??null)},[e,o,n,t]),i.useEffect(()=>{!e||!t||g===void 0&&s&&c(!!s.hasUnread)},[s,e,g,t]),{firstUnreadIndex:i.useMemo(()=>{if(g===void 0||!g||r.length===0||o===void 0)return null;if(o===null)return 0;const y=r.findIndex(b=>b.message.id===o);if(y<0)return 0;const p=y+1;return p>=r.length?null:p},[g,o,r])}};function En({items:e=[],itemContent:t,isLoading:s,loadingContent:n,errorContent:r,emptyContent:o,footer:l,bottomPadding:g,followOutput:c=!1,onAtBottomChange:f,computeItemKey:y,firstItemIndex:p,onStartReached:b,header:u,ariaLabel:d,autoScrollOnNewLastItem:x,autoScrollBehavior:m,autoScrollEnabled:v=!0,virtuosoRef:M}){const N=M??se.useRef(null),E=Math.max(0,p??0),k=se.useRef(null);return se.useEffect(()=>{if(!x||!v||!e||e.length===0)return;const w=e.length-1,R=e[w],S=y?y(w,R):w,_=k.current;k.current=S,!(_==null||_===S)&&requestAnimationFrame(()=>{N.current?.scrollToIndex({index:E+w,align:"end",behavior:m??"smooth"})})},[m,x,v,E,y,e]),s?a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:n}):r?a.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:r}):e?.length??0?a.jsx("div",{className:"relative flex min-h-0 flex-1 overflow-hidden",role:"log","aria-live":"polite","aria-relevant":"additions text","aria-label":d??"Messages",children:a.jsx(Es,{ref:N,data:e??[],style:{height:"100%",width:"100%"},className:"px-4 pt-6",alignToBottom:!0,followOutput:c,atBottomStateChange:f,startReached:b,increaseViewportBy:400,firstItemIndex:E,computeItemKey:y?(w,R)=>y(w-E,R):void 0,itemContent:(w,R)=>t(w-E,R),components:{Header:()=>u?a.jsx("div",{className:"pt-2",children:u}):null,Footer:()=>a.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",style:{paddingBottom:g??"10rem"},children:l})}})}):a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:o})}const _n=({show:e,pendingCount:t,onClick:s,shortcutHint:n})=>{if(!e)return null;const r=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(Ds,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Jump to latest"}),t>0&&a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},Tn=({show:e,unreadCount:t,onClick:s,shortcutHint:n})=>{if(!e||t<=0)return null;const r=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(_s,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Unread"}),a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},kn=({children:e,className:t,onHeightChange:s,minHeight:n,style:r,...o})=>{const l=se.useRef(null);return se.useEffect(()=>{if(!s||!l.current)return;const g=l.current,c=()=>s(g.getBoundingClientRect().height);c();const f=new ResizeObserver(c);return f.observe(g),()=>f.disconnect()},[s]),a.jsx("div",{ref:l,className:"pointer-events-none fixed inset-x-0 bottom-0 z-40 w-full",children:a.jsx("div",{className:"w-full",children:a.jsx("form",{...o,className:ns("pointer-events-auto flex w-full flex-col gap-2 rounded-3xl border border-border/60 bg-card/85 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.16)] backdrop-blur-xl supports-[backdrop-filter]:bg-card/65","ring-1 ring-black/5",t),style:{minHeight:n,...r},children:e})})})},Dn=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Ln=({show:e,headerHeight:t,onHeightChange:s,typingUsers:n,isGroupConversation:r,draft:o,setDraft:l,textareaRef:g,noteLocalInputActivity:c,stopTyping:f,onSendText:y,isUploadingImage:p,cancelImageUpload:b,sendError:u,canRetrySend:d,onRetrySend:x,uploadError:m,clearUploadError:v,showEmojiPicker:M,setShowEmojiPicker:N,openCameraPicker:E,fileInputRef:k,onImageSelected:w,isSending:R,disableSend:S})=>{const _=i.useCallback(j=>{const L=j.target.value;l(L),M&&N(!1),c(L.trim().length>0);const U=j.target;U.style.height="auto";const $=Math.min(U.scrollHeight,140);U.style.height=`${$}px`},[c,l,N,M]),I=i.useCallback(j=>{j&&(l(L=>{const U=`${L}${j}`;return c(U.trim().length>0),U}),queueMicrotask(()=>{const L=g.current;L&&(L.style.height="auto",L.style.height=`${Math.min(L.scrollHeight,140)}px`)}))},[c,l,g]),D=i.useCallback(j=>{if(j.preventDefault(),S)return;const L=o.trim();L&&(l(""),f(),y(L))},[S,o,y,l,f]);if(!e)return null;const F=S||!o.trim()||R||p,T=p||R||S;return a.jsxs(kn,{onSubmit:D,className:"space-y-3",onHeightChange:s,minHeight:t,children:[n.length>0&&a.jsxs("div",{className:"flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[a.jsx("span",{children:r?n.length===1?`${n[0]} is typingâ€¦`:n.length===2?`${n[0]} and ${n[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),a.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}),p&&a.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs",children:[a.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Uploading imageâ€¦"})]}),a.jsx(B,{type:"button",size:"sm",variant:"outline",onClick:b,children:"Cancel"})]}),u&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Q,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),d&&a.jsx(B,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Retry"})]}),m&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ts,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:m})]}),a.jsx(B,{type:"button",size:"sm",variant:"ghost",onClick:v,children:"Dismiss"})]}),a.jsxs("div",{className:"flex w-full items-center gap-2",children:[a.jsxs(bs,{open:M,onOpenChange:N,children:[a.jsx(vs,{asChild:!0,children:a.jsx(B,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",children:a.jsx(Us,{className:"h-4 w-4","aria-hidden":"true"})})}),a.jsx(ws,{side:"top",align:"start",className:"rounded-2xl border border-border/70 bg-popover/95 p-3 shadow-2xl backdrop-blur",children:a.jsx(Rs,{className:"max-h-64",children:a.jsx("div",{className:"grid grid-cols-9 gap-2",children:Dn.map(j=>a.jsx(B,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted",onClick:()=>{I(j),N(!1)},children:a.jsx("span",{children:j})},j))})})})]}),a.jsx(B,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",onClick:E,"aria-label":"Send photo",disabled:T,"aria-busy":p,children:a.jsx(As,{className:"h-4 w-4","aria-hidden":"true"})}),a.jsx("input",{type:"file",ref:k,accept:"image/*",className:"hidden",onChange:w}),a.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-input/70 bg-muted/40 px-3 py-2 shadow-inner",children:a.jsx(et,{id:"conversation-message",value:o,ref:g,rows:1,autoComplete:"off",onChange:_,onBlur:f,onKeyDown:j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),o.trim()&&j.currentTarget.form?.requestSubmit())},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),a.jsx(B,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full touch-manipulation shadow-sm",onMouseDown:j=>j.preventDefault(),disabled:F,"aria-label":"Send message","aria-busy":R||p,children:R||p?a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):a.jsx(Fs,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},An=({open:e,editingMessage:t,onOpenChange:s,onCancel:n,onTextChange:r,onSave:o,textareaRef:l,error:g,isSaving:c})=>a.jsx(tt,{open:e,onOpenChange:s,children:a.jsxs(st,{children:[a.jsxs(nt,{children:[a.jsx(rt,{children:"Edit message"}),a.jsx(at,{children:"Update your message for everyone in the conversation."})]}),t&&a.jsx(et,{ref:l,value:t.text,onChange:f=>r(f.target.value),rows:3,className:"min-h-[120px]"}),g&&a.jsx("p",{className:"text-xs text-destructive",children:g}),a.jsxs(ot,{className:"gap-2",children:[a.jsx(B,{type:"button",variant:"ghost",onClick:n,children:"Cancel"}),a.jsxs(B,{type:"button",disabled:!t?.text.trim()||c,onClick:o,children:[c&&a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Save"})]})]})]})}),Pn=({open:e,deleteDialog:t,onOpenChange:s,onHideForMe:n,onDeleteForEveryone:r,isDeleting:o})=>a.jsx(tt,{open:e,onOpenChange:s,children:a.jsxs(st,{children:[a.jsxs(nt,{className:"gap-1",children:[a.jsxs(rt,{className:"flex items-center gap-2 text-base",children:[a.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:a.jsx(Ms,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),a.jsx(at,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),a.jsxs(ot,{className:"gap-2",children:[a.jsx(B,{type:"button",variant:"outline",className:"flex-1",onClick:n,disabled:!t,children:"Hide for me"}),a.jsxs(B,{type:"button",variant:"destructive",className:"flex-1",disabled:o||!t,onClick:r,children:[o&&a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Delete for everyone"})]})]})]})});function Fn(){const[e,t]=i.useState(!1);return i.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const s=window.matchMedia("(prefers-reduced-motion: reduce)"),n=()=>{t(s.matches)};return n(),typeof s.addEventListener=="function"?(s.addEventListener("change",n),()=>s.removeEventListener("change",n)):(s.addListener(n),()=>s.removeListener(n))},[]),e}const Wn=()=>{const{conversationId:e}=rs(),t=e??null,s=i.useRef(null),n=as(),{user:r}=fe(),{data:o,isLoading:l}=os(),g=jn({currentUserId:r?.id??null}),{data:c,isLoading:f,isError:y,error:p,loadOlder:b,hasMore:u,isLoadingOlder:d,firstItemIndex:x,pollWhenRealtimeDown:m}=Zs(t,{onInsert:g}),v=i.useRef(null);i.useEffect(()=>{if(!t||!c||c.length===0)return;const h=v.current;let C=0;if(h){const O=c.findIndex(ie=>ie.id===h);C=O>=0?O+1:0}for(let O=C;O<c.length;O++)g(c[O]);v.current=c[c.length-1].id},[t,c,g]);const{draft:M,setDraft:N}=yn({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const h=X.current;h&&(h.style.height="auto",h.style.height=`${Math.min(h.scrollHeight,140)}px`)})}}),{sendError:E,lastFailedPayload:k,failedMessages:w,clearBannerState:R,onSendFailed:S,onSendRecovered:_,consumeLastFailedForRetry:I,consumeFailedMessageForRetry:D,discardFailedMessage:F}=Nn({conversationId:t,setDraft:h=>N(h),messages:c}),T=i.useMemo(()=>!t||!o?null:o.find(h=>h.id===t)??null,[t,o]),j=T?.isGroup??!1,L=i.useMemo(()=>{if(!T)return null;const h=T.participants.filter(C=>!C.isSelf);return h.length>0?h[0]:T.participants.length===1?T.participants[0]:null},[T]),U=Ss(t,{onFailed:S,onRecovered:_,otherUserId:j?null:L?.id??null}),$=i.useCallback((h,C)=>{R(),U.mutate({text:h.text,attachmentPath:h.attachmentPath,clientId:h.clientId,tempId:C?.tempId},{onSuccess:()=>{R()}})},[R,U]),X=i.useRef(null),ft=i.useMemo(()=>{const h=new Map;if(!T)return h;for(const C of T.participants)h.set(C.id,C);return h},[T]),{youBlocked:ke,blockedYou:H,isBlocked:Z,block:De,unblock:Le}=Cs(j?null:L?.id??null),ne=r?.id??null,{fileInputRef:mt,isUploadingImage:gt,uploadError:pt,cancelImageUpload:ht,clearUploadError:xt,handleImageSelected:yt,openFilePicker:bt}=Ns({conversationId:t,userId:ne,isBlocked:Z,blockedYou:H,attemptSend:$}),re=!Z&&!H,{headerRef:vt,headerHeight:Ae,composerHeight:wt,isAtBottom:W,setIsAtBottom:Rt,handleComposerHeightChange:Mt,showEmojiPicker:St,setShowEmojiPicker:xe}=bn({showComposer:re}),Ct=re?`calc(${Math.max(wt,0)}px + 20px)`:"2.5rem",Nt=i.useMemo(()=>T?.participants.find(h=>h.isSelf)?.displayName??"You",[T]),{remoteTypingUsers:jt,noteLocalInputActivity:It,stopTyping:Et}=xn({conversationId:t,userId:r?.id??null,displayName:Nt}),{data:Pe}=fn(t);Mn({conversationId:t,userId:r?.id??null,isAtBottom:W,messages:c});const{reactionsByMessageId:_t,toggleReaction:Fe}=dn(t),Tt=i.useCallback((h,C)=>{Fe.mutate({messageId:h,emoji:C})},[Fe]),K=i.useRef(null),ye=i.useRef(!1),ae=i.useRef(null),[Be,oe]=i.useState(0),V=Fn(),{activeActionMessageId:kt,openMessageActions:Ue,closeMessageActions:be,hiddenMessageIds:Oe,hideMessageForMe:Dt,deleteDialog:G,openDeleteDialog:Lt,closeDeleteDialog:ve,editingMessage:J,openEditDialog:At,updateEditingText:Pt,closeEditDialog:we,editTextareaRef:Ft,editError:Bt,setEditError:qe}=vn({conversationId:t,currentUserId:ne,showComposer:re,isBlocked:Z,blockedYou:H,composerTextareaRef:X}),Re=sn({messages:c,currentUserId:ne,hiddenMessageIds:Oe}),{data:Ut}=mn(t,Re?[Re]:[]),$e=Sn(t),He=Cn(t),{visibleMessages:A}=tn({messages:c,conversation:T,currentUserId:ne,participantsById:ft,reactionsByMessageId:_t,hiddenMessageIds:Oe,deliveryReceipts:Ut??[],readReceipts:Pe??[],failedMessages:w,lastOwnMessageId:Re}),{firstUnreadIndex:z}=In({conversationId:t,userId:r?.id??null,conversation:T,readReceipts:Pe,visibleMessages:A}),Ot=i.useMemo(()=>z==null?0:A.slice(z).filter(h=>!h.isSelf&&!h.meta.deleted).length,[z,A]),Ke=A.length>0;i.useEffect(()=>{const h=A.length?A[A.length-1]?.message.id??null:null;if(W){ae.current=h,oe(0);return}if(!h)return;const C=ae.current;if(C===h)return;const O=C?A.findIndex(te=>te.message.id===C):-1,le=A.slice(Math.max(0,O+1)).filter(te=>!te.isSelf).length;le<=0||oe(le)},[W,A]),i.useEffect(()=>()=>{K.current!=null&&window.clearTimeout(K.current)},[]),i.useEffect(()=>{const h=C=>{C.key==="Escape"&&(be(),xe(!1))};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[be,xe]);const qt=i.useCallback(h=>{h.trim()&&(R(),$({text:h.trim(),attachmentPath:null}))},[$,R]),$t=()=>{const h=I();h&&$(h.payload,{tempId:h.tempId??void 0})},Ht=h=>{K.current!=null&&window.clearTimeout(K.current),ye.current=!1,K.current=window.setTimeout(()=>{ye.current=!0,Ue(h)},500)},Kt=()=>{K.current!=null&&(window.clearTimeout(K.current),K.current=null)};if(!t)return a.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:a.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[a.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),a.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),a.jsx("p",{className:"mt-4",children:a.jsx(is,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})});const zt=i.useCallback(h=>{const C=D(h.id);C&&$(C,{tempId:h.id})},[$,D]),Qt=i.useCallback(h=>{F(h.id)},[F]),ee=V?"auto":"smooth",Me=i.useCallback(()=>{const h=A.length-1;if(h<0)return;const C=A[h]?.message.id??null;C&&(ae.current=C),oe(0),s.current?.scrollToIndex({index:x+h,align:"end",behavior:ee}),window.setTimeout(()=>{X.current?.focus()},V?0:200)},[x,ee,V,A]),Se=i.useCallback(()=>{z!=null&&(s.current?.scrollToIndex({index:x+z,align:"start",behavior:ee}),window.setTimeout(()=>{X.current?.focus()},V?0:150))},[x,z,ee,V]);return i.useEffect(()=>{ae.current=null,oe(0)},[t]),i.useEffect(()=>{const h=C=>{if(C.key==="End"||C.key==="ArrowDown"&&(C.metaKey||C.ctrlKey)||C.key==="End"&&(C.metaKey||C.ctrlKey)){C.preventDefault(),Me();return}C.key.toLowerCase()==="u"&&C.altKey&&(C.preventDefault(),Se())};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[Me,Se]),a.jsxs("div",{className:"conversation-page relative flex min-h-screen w-full flex-col items-stretch bg-background",style:{paddingTop:Ae},children:[a.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[a.jsx(js,{ref:vt,conversation:T,isLoading:l,isGroupConversation:j,otherParticipant:L??void 0,onBack:()=>n("/messages"),onToggleBlock:!j&&L?()=>{ke?Le.mutate():H||De.mutate()}:void 0,blockPending:De.isPending||Le.isPending,youBlocked:ke,blockedYou:H}),a.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[a.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[m&&a.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:a.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),a.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),a.jsx(En,{items:A,isLoading:f&&!Ke,loadingContent:a.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:y?a.jsxs("div",{className:"mb-3 rounded-md border border-border bg-background/90 px-3 py-2 text-[12px] text-destructive",children:[a.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),p instanceof Error&&a.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:p.message})]}):void 0,emptyContent:Ke?void 0:a.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[a.jsx("p",{className:"font-medium",children:j?"No messages in this group yet.":"No messages yet."}),a.jsx("p",{className:"mt-1",children:j?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:a.jsx("div",{className:"h-1","aria-hidden":!0}),header:u?a.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:d?a.jsxs("span",{className:"inline-flex items-center gap-2",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):a.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Ct,followOutput:W?V?!0:"smooth":!1,autoScrollOnNewLastItem:!0,autoScrollBehavior:ee,autoScrollEnabled:W,onAtBottomChange:Rt,onStartReached:()=>{u&&!d&&b()},firstItemIndex:x,virtuosoRef:s,computeItemKey:(h,C)=>C.message.id,itemContent:(h,C)=>{const{message:O,meta:ie,sender:le,isSelf:te,deliveryStatus:Wt,reactions:Gt,showDeliveryStatus:Jt}=C,Vt=h>0?A[h-1]?.message??null:null,Yt=h<A.length-1?A[h+1]?.message??null:null;return a.jsx(Is,{message:O,meta:ie,sender:le,isSelf:te,deliveryStatus:Wt,showDeliveryStatus:Jt,reactions:Gt,index:h,previousMessage:Vt,nextMessage:Yt,firstUnreadIndex:z,activeActionMessageId:kt,longPressTriggeredRef:ye,onOpenMessageActions:Ue,onCloseMessageActions:be,onOpenEditDialog:At,onOpenDeleteDialog:Lt,onToggleReaction:Tt,onRetryMessage:zt,onDiscardFailedMessage:Qt,onBubbleTouchStart:Ht,onBubbleTouchEndOrCancel:Kt})}}),a.jsx(Tn,{show:z!=null&&!W,unreadCount:Ot,onClick:Se,shortcutHint:"Alt+U"}),a.jsx(_n,{show:!W&&Be>0,pendingCount:Be,onClick:Me,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),a.jsx(Ln,{show:re,headerHeight:Ae,onHeightChange:Mt,typingUsers:jt,isGroupConversation:j,draft:M,setDraft:N,textareaRef:X,noteLocalInputActivity:It,stopTyping:Et,onSendText:qt,isUploadingImage:gt,cancelImageUpload:ht,sendError:!!E,canRetrySend:!!k,onRetrySend:$t,uploadError:pt,clearUploadError:xt,showEmojiPicker:St,setShowEmojiPicker:xe,openCameraPicker:bt,fileInputRef:mt,onImageSelected:yt,isSending:U.isPending,disableSend:!!(Z||H)}),H&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Z&&!H&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),a.jsx(An,{open:!!J,editingMessage:J,onOpenChange:h=>{h||we()},onCancel:we,onTextChange:Pt,textareaRef:Ft,error:Bt,isSaving:$e.isPending,onSave:()=>{if(!J)return;const h=J.text.trim();h&&(qe(null),$e.mutate({messageId:J.messageId,text:h,currentBody:J.body,attachmentUrl:J.attachmentUrl},{onSuccess:()=>{we()},onError:()=>{qe("Couldn't save changes. Please try again.")}}))}}),a.jsx(Pn,{open:!!G,deleteDialog:G,onOpenChange:h=>{h||ve()},onHideForMe:()=>{G&&(Dt(G.messageId),ve())},onDeleteForEveryone:()=>{G&&He.mutate({messageId:G.messageId,attachmentUrl:G.attachmentUrl},{onSettled:()=>{ve()}})},isDeleting:He.isPending})]})};export{Wn as default,Ss as useSendMessage};
