import{k as C,E as U,s as F,w as E,u as S,x as k,R as P,j as e,L as $,B as q}from"./index-DyWq_Gt8.js";import{Y as M}from"./index-LadubUCe.js";import{T as _}from"./TopBar-Cwkp26YK.js";import{S as R}from"./SearchField-BEqT9uiz.js";import{u as T}from"./useToggleFollow-Pw2Jw-KI.js";import{r as z}from"./resolveAvatarUrl-DOhTufni.js";import{U as A,a as I}from"./user-plus-BpI8utoY.js";const B=25,Q=t=>{if(!t)return null;const o=t.trim();return o?o.startsWith("@")?o:`@${o}`:null};function Y(t,o){const{user:n}=C(),u=n?.id??null;return U({queryKey:["connections",t??null,o,u],enabled:!!t,initialPageParam:0,getNextPageParam:l=>l.nextOffset,queryFn:async({pageParam:l})=>{const r=typeof l=="number"?l:0;if(!t)return{items:[]};const w=F.from("follows").select("follower_id, followed_id, created_at").order("created_at",{ascending:!1}),{data:i,error:d}=await(o==="followers"?w.eq("followed_id",t):w.eq("follower_id",t)).range(r,r+B-1);if(d)throw new Error(d.message);const h=i??[],c=h.map(s=>o==="followers"?s.follower_id:s.followed_id);if(c.length===0)return{items:[]};const{data:p,error:m}=await F.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",c);if(m)throw new Error(m.message);const y=p??[],f=new Map(y.map(s=>[s.id,s])),j=await Promise.all(c.map(s=>z(typeof f.get(s)?.avatar_url=="string"?f.get(s).avatar_url:null)));let v=new Set;if(u){const{data:s,error:N}=await F.from("follows").select("followed_id").eq("follower_id",u).in("followed_id",c);N||(v=new Set((s??[]).map(g=>g.followed_id)))}const b=c.map((s,N)=>{const g=f.get(s);return{id:s,username:g?.username??null,displayName:g?.display_name??null,avatarUrl:j[N]??null,bio:g?.bio??null,isFollowing:v.has(s)}}),a=h.length===B?r+B:void 0;return{items:b,nextOffset:a}}})}const L=Q,H=(t,o)=>{const n=(t??o??"?").replace(/^@/,"").trim();return n?n[0]?.toUpperCase():"?"};function O({person:t,viewerId:o,onToggleFollow:n,isToggling:u}){const l=t.displayName??t.username??"Unknown user",r=L(t.username),x=!!(o&&o===t.id);return e.jsxs("div",{className:"flex items-center justify-between gap-3 px-3 py-2",children:[e.jsxs($,{to:t.username?`/u/${t.username}`:`/u/${t.id}`,className:"flex min-w-0 flex-1 items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-card/80 text-[14px] font-semibold text-foreground",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:l,className:"h-full w-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("span",{children:H(t.displayName,t.username)})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:l}),x&&e.jsx("span",{className:"rounded-full border border-border bg-card px-2 py-0.5 text-[10px] text-muted-foreground",children:"You"})]}),r&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:r}),t.bio&&e.jsx("p",{className:"mt-0.5 line-clamp-2 text-xs text-muted-foreground",children:t.bio})]})]}),!x&&e.jsx(q,{type:"button",size:"sm",variant:t.isFollowing?"outline":"default",className:"h-8 rounded-full px-3 text-xs",onClick:()=>n(t.id,t.isFollowing),disabled:u,children:u?e.jsx("span",{children:"…"}):t.isFollowing?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Following"})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Follow"})]})})]})}const X=({mode:t})=>{const{username:o}=E(),n=S(),{user:u}=C(),l=T(),{data:r,isLoading:x,isError:w}=k(o??""),i=Y(r?.id??null,t),[d,h]=P.useState(""),c=P.useMemo(()=>(i.data?.pages??[]).flatMap(a=>a.items),[i.data?.pages]),p=P.useMemo(()=>{const a=d.trim().toLowerCase();return a?c.filter(s=>[s.displayName,s.username,L(s.username),s.bio].filter(Boolean).join(" ").toLowerCase().includes(a)):c},[c,d]),m=t==="followers"?"Followers":"Following",y=r?.username?`@${r.username}`:void 0,f=(a,s)=>{l.mutate({targetUserId:a,currentlyFollowing:s})},j=l.isPending?l.variables?.targetUserId:null,v=!!(i.hasNextPage&&!i.isFetchingNextPage),b=()=>{v&&(d.trim()||i.fetchNextPage())};return x?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(_,{title:m,subtitle:"Loading…",onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"Loading connections…"})]}):w||!r?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(_,{title:m,subtitle:"Profile not found",onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"We couldn't load this profile."})]}):e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(_,{title:m,subtitle:y,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3",children:e.jsx(R,{placeholder:`Search ${m.toLowerCase()}…`,value:d,onChange:a=>h(a.target.value)})}),e.jsx("div",{className:"flex-1 px-2",children:e.jsx("div",{className:"overflow-hidden rounded-2xl border border-border bg-card/80",children:i.isLoading?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:"Loading…"}):p.length===0?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:d.trim()?`No ${m.toLowerCase()} match “${d.trim()}”.`:t==="followers"?"No followers yet.":"Not following anyone yet."}):e.jsx(M,{style:{height:"100%"},data:p,endReached:b,itemContent:(a,s)=>e.jsx(O,{person:s,viewerId:u?.id??null,isToggling:!!(j&&j===s.id),onToggleFollow:f}),components:{Footer:()=>i.isFetchingNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Loading more…"}):i.hasNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Scroll for more"}):e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"End"})}})})})]})};export{X as C};
