import{c as re,s as B,r as i,d as q,A as ss,N as fe,b as me,e as _e,O as Qe,P as ns,Q as rs,T as as,U as os,R as ne,j as a,I as is,C as z,B as F,w as ls,u as cs,g as us,L as ds}from"./index-C9fHGWeV.js";import{c as ge,m as pe,a as fs,M as ke,s as ms,i as Ge,b as Je,d as Ve,e as Ye,f as gs,g as ps,h as hs,n as xs,j as ys,k as Xe,r as Ze,l as bs,o as et,p as vs,C as ws,q as Rs,P as Ms,t as Ss,v as Cs,S as Ns,T as tt,w as js,u as Is,x as Es,y as _s,z as ks}from"./scroll-area-CnoFzb4R.js";import{u as Te}from"./useMutation-Cbgapksf.js";import{Y as Ts}from"./index-34PO3Gzh.js";import{B as Ds}from"./bell-Dnpsnjr3.js";import{C as Ls}from"./circle-alert-C2ornUjM.js";import{D as st,a as nt,b as rt,c as at,d as ot,e as it}from"./dialog-DjKMkZCg.js";import{T as As}from"./TopBar-C-VicUv8.js";import"./format-DMUSBM01.js";import"./index-DDwuZX7F.js";import"./index-B5ogGJIu.js";import"./index-DBHTwg8d.js";const Bs=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Ps=re("arrow-down",Bs);const Fs=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],Us=re("camera",Fs);const Os=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],qs=re("send",Os);const $s=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Hs=re("shield-x",$s);const Ks=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],zs=re("smile",Ks),Ee=new Map,Qs=e=>{const t=Ee.get(e);if(t)return t;const s=B.channel(`conversation-db-${e}`),n={conversationId:e,channel:s,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageInsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageUpdateListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionDeleteListeners)l(o)}),s.subscribe(r=>{const o=r;n.lastStatus=o;for(const l of n.statusListeners)l(o)}),Ee.set(e,n),n},Ws=(e,t)=>{const s=Qs(e);s.refCount+=1;const n=[];return t.onStatus&&(s.statusListeners.add(t.onStatus),n.push(()=>s.statusListeners.delete(t.onStatus)),s.lastStatus&&t.onStatus(s.lastStatus)),t.onMessageInsert&&(s.messageInsertListeners.add(t.onMessageInsert),n.push(()=>s.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(s.messageUpdateListeners.add(t.onMessageUpdate),n.push(()=>s.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(s.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),n.push(()=>s.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(s.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),n.push(()=>s.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(s.reactionUpsertListeners.add(t.onReactionUpsert),n.push(()=>s.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(s.reactionDeleteListeners.add(t.onReactionDelete),n.push(()=>s.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const r of n)r();if(s.refCount-=1,s.refCount<=0){try{B.removeChannel(s.channel)}catch{}Ee.delete(e)}}},he=(e,t,s)=>{i.useEffect(()=>{if(e)return Ws(e,t())},[e,t,...s])},Gs=2e3,Js=15e3,Vs=e=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:e?Gs:!1,refetchIntervalInBackground:!1}),Ys=["CHANNEL_ERROR","TIMED_OUT","CLOSED","UNSUBSCRIBED"],Xs=e=>Ys.includes(e),Zs=3e3,en=e=>{const[t,s]=i.useState(!1),n=i.useRef(null),[r,o]=i.useState(e);e!==r&&(o(e),s(!1),n.current&&(clearTimeout(n.current),n.current=null));const l=i.useCallback(g=>{if(Xs(g)){if(n.current)return;n.current=window.setTimeout(()=>{n.current=null,s(!0)},Zs);return}n.current&&(clearTimeout(n.current),n.current=null),s(!1)},[]);return{pollWhenRealtimeDown:t,onStatus:l}},xe=e=>{const{pollWhenRealtimeDown:t,onStatus:s}=en(e);return{pollWhenRealtimeDown:t,onRealtimeStatus:s,refetchOptions:Vs(t)}},tn=e=>typeof e=="object"&&e!==null,lt=e=>e.new,sn=e=>e.old,Y=(e,t)=>{if(!tn(e))return null;const s=e[t];return typeof s=="string"?s:null},ct=(e,t)=>Y(e,"conversation_id")===t,ut=40,de=1e5,nn=e=>{const t=e.createdAt,s=e.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${s})`},rn=e=>{const t=ms((e??[]).map(pe)),s=(e??[]).length>=ut,n=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:s,cursor:n}},an=(e,t)=>{const s=q(),n=ge(e),[r,o]=i.useState(de),{pollWhenRealtimeDown:l,onRealtimeStatus:g,refetchOptions:c}=xe(e),f=i.useRef(t);i.useEffect(()=>{f.current=t},[t]);const y=i.useRef({pages:0,total:0}),p=ss({queryKey:n,enabled:!!e,initialPageParam:null,...c,staleTime:Js,queryFn:async({pageParam:x})=>{if(!e)return{items:[],hasMore:!1,cursor:null};let m=B.from("messages").select(ke).eq("conversation_id",e).order("created_at",{ascending:!1}).order("id",{ascending:!1});x&&(m=m.or(nn(x)));const{data:v,error:M}=await m.limit(ut);if(M)throw console.error(`[useConversationMessages] Failed to load ${x?"older messages":"messages"}`,M),new Error(M.message);return rn(v??[])},getNextPageParam:()=>{},getPreviousPageParam:x=>{if(x.hasMore)return x.cursor??void 0}});i.useEffect(()=>{const x=p.data?.pages??[],m=x.reduce((E,T)=>E+T.items.length,0),v=y.current;if(x.length===0){y.current={pages:0,total:0},o(de);return}if(v.pages===0){y.current={pages:x.length,total:m},o(de);return}const M=m-v.total,N=x.length-v.pages;M>0&&N>0&&o(E=>Math.max(0,E-M)),y.current={pages:x.length,total:m}},[p.data?.pages]);const b=i.useCallback(()=>{if(!e)return{};const x=(m,v)=>{const M=lt(m);if(!ct(M,e)||!Y(M,"id"))return;const E=M,T=pe(E);s.setQueryData(n,w=>fs(w,E)),v==="insert"?f.current?.onInsert?.(T):f.current?.onUpdate?.(T)};return{onStatus:g,onMessageInsert:m=>{x(m,"insert")},onMessageUpdate:m=>{x(m,"update")}}},[e,g,s,n]);he(e,b,[]),i.useEffect(()=>{o(de),y.current={pages:0,total:0}},[e]);const u=i.useMemo(()=>(p.data?.pages??[]).flatMap(m=>m.items),[p.data?.pages]),d=i.useCallback(async()=>{e&&p.hasPreviousPage&&await p.fetchPreviousPage()},[e,p]);return i.useMemo(()=>({data:u,isLoading:p.isLoading,isFetching:p.isFetching,isError:p.isError,error:p.error,refetch:p.refetch,loadOlder:d,hasMore:!!p.hasPreviousPage,isLoadingOlder:p.isFetchingPreviousPage,firstItemIndex:r,queryKey:n,pollWhenRealtimeDown:l}),[u,p.isLoading,p.isFetching,p.isError,p.error,p.refetch,d,p.hasPreviousPage,p.isFetchingPreviousPage,r,n,l])};function on(e){const{conversation:t,deliveryReceipts:s,readReceipts:n,currentUserId:r,failedMessages:o,onlyMessageIds:l,messageCreatedAtMsById:g}=e;if(!t||!r)return()=>null;const c=t.participants.filter(u=>!u.isSelf);if(c.length===0)return()=>null;const f=new Set(c.map(u=>u.id)),y=u=>{if(!u)return null;const d=g?.get(u);return d??null},p=new Map;for(const u of n??[]){let d=null;if(u.lastReadMessageId){const m=y(u.lastReadMessageId);m!=null&&(d=m)}if(d==null&&u.lastReadAt){const m=new Date(u.lastReadAt).getTime();Number.isNaN(m)||(d=m)}if(d==null)continue;const x=p.get(u.userId);(x==null||d>x)&&p.set(u.userId,d)}const b=new Map;for(const u of s??[]){if(!f.has(u.userId)||l&&!l.has(u.messageId))continue;let d=b.get(u.messageId);d||(d=new Set,b.set(u.messageId,d)),d.add(u.userId)}return u=>{if(u.senderId!==r)return null;if(o[u.id])return{status:"failed"};if(Ge(u.id))return{status:"sending"};const d=(()=>{const M=new Date(u.createdAt??"").getTime();return Number.isNaN(M)?0:M})();let x=0,m=null;for(const M of c){const N=p.get(M.id);N!=null&&N>=d&&(x+=1,(m===null||N>m)&&(m=N))}return x===c.length&&c.length>0?{status:"seen",seenAt:m!=null?new Date(m).toISOString():null}:(b.get(u.id)?.size??0)===c.length&&c.length>0?{status:"delivered"}:{status:"sent"}}}function ln(e){const{messages:t,conversation:s,currentUserId:n,participantsById:r,reactionsByMessageId:o,hiddenMessageIds:l,deliveryReceipts:g,readReceipts:c,failedMessages:f,lastOwnMessageId:y}=e,p=i.useMemo(()=>{if(!t)return[];const u=new Set;y&&u.add(y);for(const m of Object.keys(f))u.add(m);const d=new Map;for(const m of t){const v=new Date(m.createdAt??"").getTime();Number.isNaN(v)||d.set(m.id,v)}const x=on({conversation:s??null,deliveryReceipts:g,readReceipts:c,currentUserId:n,failedMessages:f,onlyMessageIds:u,messageCreatedAtMsById:d});return t.map(m=>{const v=fe(m.body),M=r.get(m.senderId)??null,N=M?.isSelf??(n!=null&&m.senderId===n),E=N&&u.has(m.id)?x(m):null,T=!!E&&N&&!v.deleted&&(E.status==="failed"||y===m.id);return{message:m,meta:v,sender:M,isSelf:N,deliveryStatus:E,showDeliveryStatus:T,reactions:o.get(m.id)??[]}})},[s,n,g,f,y,t,r,o,c]),b=i.useMemo(()=>p.filter(({message:u})=>!l[u.id]),[p,l]);return{uiMessages:p,visibleMessages:b}}function cn(e){const{messages:t,currentUserId:s,hiddenMessageIds:n}=e;return i.useMemo(()=>{if(!t||!s)return null;for(let r=t.length-1;r>=0;r-=1){const o=t[r];if(!(n[o.id]||o.senderId!==s||fe(o.body).deleted))return o.id}return null},[n,t,s])}const un=async e=>{const{data:t,error:s}=await B.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",e).order("last_read_at",{ascending:!1}).returns();if(s)throw console.error("[useConversationReadReceipts] Failed to load",s),new Error(s.message);return(t??[]).map(Ve)},dn=async(e,t)=>{if(t.length===0)return[];const s=B.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",e).in("message_id",t),{data:n,error:r}=await s.order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationDeliveryReceipts] Failed to load",r),new Error(r.message);return(n??[]).map(Ye)},fn=async e=>{const{data:t,error:s}=await B.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",e).order("created_at",{ascending:!0}).returns();if(s)throw console.error("[useConversationReactions] Failed to load reactions",s),new Error(s.message);return(t??[]).map(Je)},mn=(e,t)=>{const s=new Map,n=new Map;for(const o of e){let l=s.get(o.messageId);l||(l=new Map,s.set(o.messageId,l),n.set(o.messageId,[]));let g=l.get(o.emoji);g||(g={emoji:o.emoji,count:0,reactedBySelf:!1},l.set(o.emoji,g),n.get(o.messageId).push(o.emoji)),g.count+=1,t&&o.userId===t&&(g.reactedBySelf=!0)}const r=new Map;for(const[o,l]of s.entries()){const g=n.get(o)??[];r.set(o,g.map(c=>l.get(c)).filter(Boolean))}return r},gn=(e,t,s)=>{const n=e??[],r=s.key(t),o=[...n],l=o.findIndex(g=>s.key(g)===r);return l>=0?o[l]=t:o.push(t),s.sort&&o.sort(s.sort),o},pn=(e,t,s)=>{const n=e??[];return n.length===0?[]:n.filter(r=>s.key(r)!==t)},De=e=>t=>{const s=lt(t);if(!ct(s,e.conversationId)||e.extraGuard&&!e.extraGuard(s)||!(e.getRequiredId?e.getRequiredId(s):Y(s,"id")))return;const r=s,o=e.mapRow(r);e.queryClient.setQueryData(e.queryKey,l=>gn(l,o,{key:e.key,sort:e.sort}))},hn=e=>t=>{const s=sn(t),n=e.getRowId?e.getRowId(s):Y(s,"id");if(!n){e.invalidateWhenMissingId!==!1&&e.queryClient.invalidateQueries({queryKey:e.queryKey});return}e.queryClient.setQueryData(e.queryKey,r=>pn(r,n,{key:e.key}))},xn=e=>{const{user:t}=me(),s=t?.id??null,n=q(),r=gs(e),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:g}=xe(e),c=_e({queryKey:r,enabled:!!e,...g,queryFn:()=>e?fn(e):Promise.resolve([])}),f=i.useCallback(()=>{if(!e)return{};const b=De({conversationId:e,queryClient:n,queryKey:r,mapRow:Je,key:d=>d.id,sort:(d,x)=>{const m=Qe(d.createdAt),v=Qe(x.createdAt);return m!==v?m-v:d.id.localeCompare(x.id)}}),u=hn({queryClient:n,queryKey:r,key:d=>d.id});return{onStatus:l,onReactionUpsert:b,onReactionDelete:u}},[e,l,n,r]);he(e,f,[]);const y=Te({mutationFn:async({messageId:b,emoji:u})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to react to messages.");const{error:d}=await B.from("message_reactions").insert({conversation_id:e,message_id:b,user_id:s,emoji:u});if(d){if(d?.code==="23505"){const{error:x}=await B.from("message_reactions").delete().eq("message_id",b).eq("user_id",s).eq("emoji",u);if(x)throw console.error("[useConversationReactions] Failed to remove reaction",x),x;return}throw console.error("[useConversationReactions] Failed to toggle reaction",d),d}},onMutate:async({messageId:b,emoji:u})=>{if(!e||!s)return{previousReactions:void 0};await n.cancelQueries({queryKey:r});const d=n.getQueryData(r);return n.setQueryData(r,x=>{const m=x??[],v=m.findIndex(N=>N.messageId===b&&N.userId===s&&N.emoji===u);if(v>=0){const N=[...m];return N.splice(v,1),N}const M={id:ps(),conversationId:e,messageId:b,userId:s,emoji:u,createdAt:new Date().toISOString()};return[...m,M]}),{previousReactions:d}},onError:(b,u,d)=>{e&&(d?.previousReactions?n.setQueryData(r,d.previousReactions):n.invalidateQueries({queryKey:r}))},onSuccess:()=>{e&&n.invalidateQueries({queryKey:r})}}),p=i.useMemo(()=>{const b=c.data??[];return mn(b,s)},[c.data,s]);return{reactions:c.data??[],reactionsByMessageId:p,isLoadingReactions:c.isLoading,toggleReaction:y,pollWhenRealtimeDown:o,queryKey:r}},yn=e=>{const t=q(),s=hs(e),{pollWhenRealtimeDown:n,onRealtimeStatus:r,refetchOptions:o}=xe(e),l=_e({queryKey:s,enabled:!!e,...o,queryFn:async()=>e?un(e):[]}),g=i.useCallback(()=>{if(!e)return{};const c=De({conversationId:e,queryClient:t,queryKey:s,mapRow:Ve,key:f=>f.userId,getRequiredId:f=>Y(f,"user_id"),sort:(f,y)=>{const p=!f.lastReadAt,b=!y.lastReadAt;if(p&&b)return 0;if(p)return 1;if(b)return-1;const u=new Date(f.lastReadAt).getTime(),d=new Date(y.lastReadAt).getTime();return Number.isNaN(u)&&Number.isNaN(d)?0:Number.isNaN(u)?1:Number.isNaN(d)?-1:d-u}});return{onStatus:r,onReadReceiptUpsert:c}},[e,r,t,s]);return he(e,g,[]),i.useMemo(()=>({...l,pollWhenRealtimeDown:n,queryKey:s}),[l,n,s])},bn=(e,t)=>{const s=q(),n=i.useMemo(()=>xs(t,{excludeTemp:!0,sort:!0}),[t]),r=ys(e,n),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:g}=xe(e),c=_e({queryKey:r,enabled:!!(e&&n.length>0),...g,queryFn:async()=>e?n.length===0?[]:dn(e,n):[]}),f=i.useCallback(()=>{if(!e)return{};if(n.length===0)return{};const p=new Set(n),b=De({conversationId:e,queryClient:s,queryKey:r,mapRow:Ye,key:u=>u.id,extraGuard:u=>{const d=Y(u,"message_id");return!!(d&&p.has(d))},sort:(u,d)=>{const x=new Date(u.deliveredAt??"").getTime(),m=new Date(d.deliveredAt??"").getTime(),v=Number.isNaN(x)?0:x,M=Number.isNaN(m)?0:m;return v-M}});return{onStatus:l,onDeliveryReceiptUpsert:b}},[e,n,l,s,r]),y=e&&n.length>0?e:null;return he(y,f,[]),i.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},vn=3e3,wn=2e3,Rn=5e3,Mn=e=>{const{conversationId:t,userId:s,displayName:n}=e,[r,o]=i.useState({}),l=i.useRef(null),g=i.useRef(new Map),c=i.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),f=i.useCallback(async u=>{if(!t||!s||!n)return;const d=l.current;d&&await d.send({type:"broadcast",event:"typing",payload:{userId:s,displayName:n,isTyping:u}})},[t,s,n]),y=i.useCallback(async()=>{c.current.timeoutId!=null&&(window.clearTimeout(c.current.timeoutId),c.current.timeoutId=null),c.current.isTyping&&(c.current.isTyping=!1,c.current.lastSentAtMs=0,await f(!1))},[f]),p=i.useCallback(u=>{if(!t||!s||!n||!l.current)return;const x=c.current.isTyping;if(u){const m=Date.now();x?m-c.current.lastSentAtMs>wn&&(c.current.lastSentAtMs=m,f(!0)):(c.current.isTyping=!0,c.current.lastSentAtMs=m,f(!0)),c.current.timeoutId!=null&&window.clearTimeout(c.current.timeoutId),c.current.timeoutId=window.setTimeout(()=>{c.current.isTyping=!1,c.current.lastSentAtMs=0,c.current.timeoutId=null,f(!1)},vn);return}x&&y()},[f,t,n,y,s]);return i.useEffect(()=>{if(!t)return;const u=B.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});l.current=u,u.on("broadcast",{event:"typing"},({payload:m})=>{const v=m;if(!v?.userId||s&&v.userId===s)return;o(N=>{const E={...N};return v.isTyping&&v.displayName?E[v.userId]=v.displayName:delete E[v.userId],E});const M=g.current.get(v.userId);if(M!=null&&window.clearTimeout(M),v.isTyping){const N=window.setTimeout(()=>{o(E=>{const T={...E};return delete T[v.userId],T}),g.current.delete(v.userId)},Rn);g.current.set(v.userId,N)}else g.current.delete(v.userId)}).subscribe();const d=()=>{document.visibilityState==="hidden"&&y()},x=()=>{y()};return document.addEventListener("visibilitychange",d),window.addEventListener("beforeunload",x),window.addEventListener("pagehide",x),window.addEventListener("blur",x),()=>{document.removeEventListener("visibilitychange",d),window.removeEventListener("beforeunload",x),window.removeEventListener("pagehide",x),window.removeEventListener("blur",x),g.current.forEach(m=>window.clearTimeout(m)),g.current.clear(),y(),l.current&&(B.removeChannel(l.current),l.current=null)}},[t,y,s]),{remoteTypingUsers:i.useMemo(()=>Object.values(r),[r]),noteLocalInputActivity:p,stopTyping:y}},Sn=e=>{const{conversationId:t,storageKeyPrefix:s="messages:draft:",hydrate:n,debounceMs:r=250}=e,[o,l]=i.useState("");return i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.localStorage.getItem(c);f!=null&&f!==o&&(l(f),n?.(f))},[t]),i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.setTimeout(()=>{o.trim().length===0?window.localStorage.removeItem(c):window.localStorage.setItem(c,o)},r);return()=>window.clearTimeout(f)},[t,r,o,s]),{draft:o,setDraft:l,clearDraft:()=>l("")}};function Cn({showComposer:e,initialHeaderHeight:t=72,initialComposerHeight:s=160}){const n=i.useRef(null),[r,o]=i.useState(t),[l,g]=i.useState(s),[c,f]=i.useState(!0),[y,p]=i.useState(!1),b=i.useCallback(u=>g(Math.max(u,r)),[r]);return i.useEffect(()=>{const u=n.current;if(!u)return;const d=()=>o(Math.max(u.getBoundingClientRect().height,0));if(d(),typeof ResizeObserver>"u")return;const x=new ResizeObserver(d);return x.observe(u),()=>x.disconnect()},[]),i.useEffect(()=>{g(u=>Math.max(u,r))},[r]),i.useEffect(()=>{e||g(0)},[e]),{headerRef:n,headerHeight:r,composerHeight:l,isAtBottom:c,setIsAtBottom:f,handleComposerHeightChange:b,showEmojiPicker:y,setShowEmojiPicker:p}}const Nn=({conversationId:e,currentUserId:t,showComposer:s,isBlocked:n,blockedYou:r,composerTextareaRef:o})=>{const[l,g]=i.useState(null),[c,f]=i.useState({}),[y,p]=i.useState(null),[b,u]=i.useState(null),[d,x]=i.useState(null),m=i.useRef(null),v=i.useRef(null);i.useEffect(()=>{if(!e||!t){f({});return}if(typeof window>"u")return;const j=`messages:hidden:${t}:${e}`;try{const L=window.localStorage.getItem(j);if(!L){f({});return}const P=JSON.parse(L);if(Array.isArray(P)){const k={};for(const I of P)typeof I=="string"&&I&&(k[I]=!0);f(k);return}if(P&&typeof P=="object"){const k={};for(const[I,D]of Object.entries(P))D&&(k[I]=!0);f(k);return}f({})}catch{f({})}},[e,t]),i.useEffect(()=>{if(!e||!t||typeof window>"u")return;const j=`messages:hidden:${t}:${e}`;try{const L=Object.keys(c).filter(P=>c[P]);window.localStorage.setItem(j,JSON.stringify(L))}catch{}},[e,t,c]);const M=i.useCallback(()=>{g(null)},[]),N=i.useCallback(j=>{n||r||fe(j.body).deleted||(g(j.id),o.current?.blur())},[r,o,n]),E=i.useCallback((j,L)=>{n||r||fe(j.body).deleted||(L&&(v.current=L),u({messageId:j.id,text:ns(j.body)??"",body:j.body??null,attachmentUrl:j.attachmentUrl??null}),x(null),M(),o.current?.blur())},[r,M,o,n]),T=i.useCallback(j=>{u(L=>L&&{...L,text:j})},[]),w=i.useCallback(()=>{u(null),x(null),v.current?.focus()},[]);i.useEffect(()=>{b&&queueMicrotask(()=>{m.current?.focus()})},[b]);const R=i.useCallback(j=>{n||r||(M(),p({messageId:j.id,attachmentUrl:j.attachmentUrl??null}),o.current?.blur())},[r,M,o,n]),S=i.useCallback(()=>{p(null)},[]),_=i.useCallback(j=>{f(L=>({...L,[j]:!0}))},[]);return i.useEffect(()=>{l===null&&s&&(b||y||queueMicrotask(()=>o.current?.focus()))},[l,y,b,s,o]),{activeActionMessageId:l,openMessageActions:N,closeMessageActions:M,hiddenMessageIds:c,hideMessageForMe:_,deleteDialog:y,openDeleteDialog:R,closeDeleteDialog:S,editingMessage:b,openEditDialog:E,updateEditingText:T,closeEditDialog:w,editTextareaRef:m,editError:d,setEditError:x}},dt=e=>e.code==="42P10"||/no unique or exclusion constraint matching the ON CONFLICT specification/i.test(e.message??""),ft=e=>e.code==="23505"||/duplicate key value violates unique constraint/i.test(e.message??"");let je=null,Ie=null;const jn=async e=>{if(je!==!1){const{error:s}=await B.from("message_delivery_receipts").upsert(e,{onConflict:"conversation_id,message_id,user_id"});if(!s){je=!0;return}if(dt(s))je=!1;else{console.error("[writeDeliveryReceipt] Failed to write delivery receipt",s);return}}const{error:t}=await B.from("message_delivery_receipts").insert(e);t&&!ft(t)&&console.error("[writeDeliveryReceipt] Failed to insert delivery receipt",t)},In=async e=>{if(Ie!==!1){const{error:s}=await B.from("message_read_receipts").upsert(e,{onConflict:"conversation_id,user_id"});if(!s){Ie=!0;return}if(dt(s))Ie=!1;else{console.error("[writeReadReceipt] Failed to write read receipt",s);return}}const{error:t}=await B.from("message_read_receipts").insert(e);t&&!ft(t)&&console.error("[writeReadReceipt] Failed to insert read receipt",t)},We=3e3;function En(e){const{conversationId:t,userId:s,isAtBottom:n,messages:r}=e,o=q(),l=i.useRef({conversationId:null,messageId:null,userId:null}),g=i.useRef({lastSentAt:0,timeoutId:null,pending:null});i.useEffect(()=>{l.current={conversationId:null,messageId:null,userId:null};const c=g.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null,c.pending=null,c.lastSentAt=0},[t,s]),i.useEffect(()=>()=>{const c=g.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null},[]),i.useEffect(()=>{if(!t||!r||r.length===0||!s||!n)return;const c=r[r.length-1];if(Ge(c.id)||l.current.conversationId===t&&l.current.messageId===c.id&&l.current.userId===s)return;const f=g.current,y=Date.now(),p=f.lastSentAt?y-f.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{Xe(o,t,d=>d.hasUnread?{...d,hasUnread:!1}:d)},u=d=>{f.lastSentAt=Date.now();const x=new Date().toISOString();In({conversation_id:t,user_id:s,last_read_message_id:d,last_read_at:x}).then(()=>{l.current={conversationId:t,messageId:d,userId:s},b()}).catch(m=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",m)})};if(p<We){f.pending={conversationId:t,userId:s,messageId:c.id},f.timeoutId==null&&(f.timeoutId=window.setTimeout(()=>{const d=g.current.pending;g.current.pending=null,g.current.timeoutId=null,d&&(l.current.conversationId===d.conversationId&&l.current.messageId===d.messageId&&l.current.userId===d.userId||d.conversationId!==t||d.userId!==s||u(d.messageId))},Math.max(We-p,0)));return}f.timeoutId!=null&&(window.clearTimeout(f.timeoutId),f.timeoutId=null,f.pending=null),u(c.id)},[t,r,s,o,n])}const _n=e=>{const{user:t}=me(),s=t?.id??null,n=q();return Te({mutationFn:async({messageId:r,text:o,currentBody:l,attachmentUrl:g})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to edit messages.");if(g)throw new Error("Cannot edit messages with attachments.");const c=rs(l,o),{data:f,error:y}=await B.from("messages").update({body:c}).eq("id",r).eq("conversation_id",e).eq("user_id",s).select(ke).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return pe(f)},onSuccess:r=>{if(!e)return;const o=ge(e);n.setQueryData(o,l=>Ze(l,r))}})},kn=e=>{const{user:t}=me(),s=t?.id??null,n=q();return Te({mutationFn:async({messageId:r,attachmentUrl:o})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to delete messages.");const g={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},c=JSON.stringify(g),{data:f,error:y}=await B.from("messages").update({body:c,attachment_url:null}).eq("id",r).eq("conversation_id",e).eq("user_id",s).select(ke).single();if(y)throw console.error("[useDeleteMessage] Failed to delete message",y),new Error(y.message);if(o)try{await et(o)}catch(b){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",b)}return pe(f)},onSuccess:r=>{if(!e)return;const o=ge(e);n.setQueryData(o,l=>Ze(l,r)),n.invalidateQueries({queryKey:bs})}})};function Tn(e){const{conversationId:t,setDraft:s,messages:n}=e,r=q(),[o,l]=i.useState(null),[g,c]=i.useState(null),[f,y]=i.useState(null),[p,b]=i.useState({}),u=i.useRef({});i.useEffect(()=>{u.current=p},[p]);const[d,x]=i.useState(t);t!==d&&(x(t),l(null),c(null),y(null),b({}),u.current={}),i.useEffect(()=>()=>{const w=Object.values(u.current),R=Array.from(new Set(w.map(S=>S.attachmentPath).filter(S=>typeof S=="string"&&S.length>0&&!vs(S))));R.length!==0&&B.storage.from(ws).remove(R).then(({error:S})=>{S&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",S)}).catch(S=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",S)})},[t]),i.useEffect(()=>{n&&b(w=>{const R=new Set(n.map(j=>j.id));let S=!1;const _={...w};for(const j of Object.keys(_))R.has(j)||(delete _[j],S=!0);return S?_:w})},[n]);const m=i.useCallback(()=>{l(null),c(null),y(null)},[]),v=i.useCallback((w,R)=>{l("Couldn't send. Please try again."),R.text.trim()&&s(R.text),c(R),y(w),b(S=>({...S,[w]:R}))},[s]),M=i.useCallback(w=>{w&&(b(R=>{if(!(w in R))return R;const S={...R};return delete S[w],S}),w===f&&m())},[m,f]),N=i.useCallback(()=>{if(!g)return null;const w=f;return w&&b(R=>{if(!(w in R))return R;const S={...R};return delete S[w],S}),m(),{payload:g,tempId:w}},[m,g,f]),E=i.useCallback(w=>{const R=p[w];return R?(b(S=>{if(!(w in S))return S;const _={...S};return delete _[w],_}),w===f?m():l(null),R):null},[m,p,f]),T=i.useCallback(async w=>{if(!t)return;const R=p[w];if(!R)return;const S=ge(t);if(r.setQueryData(S,_=>Rs(_,w)),b(_=>{if(!(w in _))return _;const j={..._};return delete j[w],j}),w===f&&m(),R.attachmentPath)try{await et(R.attachmentPath)}catch(_){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",_)}},[m,t,p,f,r]);return{sendError:o,setSendError:l,lastFailedPayload:g,lastFailedTempId:f,failedMessages:p,clearBannerState:m,onSendFailed:v,onSendRecovered:M,consumeLastFailedForRetry:N,consumeFailedMessageForRetry:E,discardFailedMessage:T}}const Dn=({currentUserId:e})=>{const t=q();return i.useCallback(s=>{Xe(t,s.conversationId,n=>{const r=!!(e&&s.senderId===e);return{...n,lastMessagePreview:os(s.body)??n.lastMessagePreview,lastMessageAt:s.createdAt??n.lastMessageAt,lastMessageAtLabel:as(s.createdAt??null),hasUnread:!r,lastMessageIsFromSelf:r,lastMessageSeenByOthers:r?!1:n.lastMessageSeenByOthers}},{moveToTop:!0}),e&&s.senderId!==e&&jn({conversation_id:s.conversationId,message_id:s.id,user_id:e})},[e,t])},Ln=({conversationId:e,userId:t,conversation:s,readReceipts:n,visibleMessages:r})=>{const[o,l]=i.useState(void 0),[g,c]=i.useState(void 0);return i.useEffect(()=>{l(void 0),c(void 0)},[e,t]),i.useEffect(()=>{if(!e||!t||o!==void 0)return;const y=(n??[]).find(p=>p.userId===t)??null;l(y?.lastReadMessageId??null)},[e,o,n,t]),i.useEffect(()=>{!e||!t||g===void 0&&s&&c(!!s.hasUnread)},[s,e,g,t]),{firstUnreadIndex:i.useMemo(()=>{if(g===void 0||!g||r.length===0||o===void 0)return null;if(o===null)return 0;const y=r.findIndex(b=>b.message.id===o);if(y<0)return 0;const p=y+1;return p>=r.length?null:p},[g,o,r])}};function An({items:e=[],itemContent:t,isLoading:s,loadingContent:n,errorContent:r,emptyContent:o,footer:l,bottomPadding:g,followOutput:c=!1,onAtBottomChange:f,computeItemKey:y,firstItemIndex:p,onStartReached:b,header:u,ariaLabel:d,autoScrollOnNewLastItem:x,autoScrollBehavior:m,autoScrollEnabled:v=!0,virtuosoRef:M}){const N=M??ne.useRef(null),E=Math.max(0,p??0),T=ne.useRef(null);return ne.useEffect(()=>{if(!x||!v||!e||e.length===0)return;const w=e.length-1,R=e[w],S=y?y(w,R):w,_=T.current;T.current=S,!(_==null||_===S)&&requestAnimationFrame(()=>{N.current?.scrollToIndex({index:E+w,align:"end",behavior:m??"smooth"})})},[m,x,v,E,y,e]),s?a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:n}):r?a.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:r}):e?.length??0?a.jsx("div",{className:"relative flex min-h-0 flex-1 overflow-hidden",role:"log","aria-live":"polite","aria-relevant":"additions text","aria-label":d??"Messages",children:a.jsx(Ts,{ref:N,data:e??[],style:{height:"100%",width:"100%"},className:"px-4 pt-6",alignToBottom:!0,followOutput:c,atBottomStateChange:f,startReached:b,increaseViewportBy:400,firstItemIndex:E,computeItemKey:y?(w,R)=>y(w-E,R):void 0,itemContent:(w,R)=>t(w-E,R),components:{Header:()=>u?a.jsx("div",{className:"pt-2",children:u}):null,Footer:()=>a.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",style:{paddingBottom:g??"10rem"},children:l})}})}):a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:o})}const Bn=({show:e,pendingCount:t,onClick:s,shortcutHint:n})=>{if(!e)return null;const r=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(Ps,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Jump to latest"}),t>0&&a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},Pn=({show:e,unreadCount:t,onClick:s,shortcutHint:n})=>{if(!e||t<=0)return null;const r=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(Ds,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Unread"}),a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},Fn=({children:e,className:t,onHeightChange:s,minHeight:n,style:r,...o})=>{const l=ne.useRef(null);return ne.useEffect(()=>{if(!s||!l.current)return;const g=l.current,c=()=>s(g.getBoundingClientRect().height);c();const f=new ResizeObserver(c);return f.observe(g),()=>f.disconnect()},[s]),a.jsx("div",{ref:l,className:"pointer-events-none fixed inset-x-0 bottom-0 z-40 w-full",children:a.jsx("div",{className:"w-full",children:a.jsx("form",{...o,className:is("pointer-events-auto flex w-full flex-col gap-2 rounded-3xl border border-border/60 bg-card/85 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.16)] backdrop-blur-xl supports-[backdrop-filter]:bg-card/65","ring-1 ring-black/5",t),style:{minHeight:n,...r},children:e})})})},Un=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],On=({show:e,headerHeight:t,onHeightChange:s,typingUsers:n,isGroupConversation:r,draft:o,setDraft:l,textareaRef:g,noteLocalInputActivity:c,stopTyping:f,onSendText:y,isUploadingImage:p,cancelImageUpload:b,sendError:u,canRetrySend:d,onRetrySend:x,uploadError:m,clearUploadError:v,showEmojiPicker:M,setShowEmojiPicker:N,openCameraPicker:E,fileInputRef:T,onImageSelected:w,isSending:R,disableSend:S})=>{const _=i.useCallback(I=>{const D=I.target.value;l(D),M&&N(!1),c(D.trim().length>0);const $=I.target;$.style.height="auto";const X=Math.min($.scrollHeight,140);$.style.height=`${X}px`},[c,l,N,M]),j=i.useCallback(I=>{I&&(l(D=>{const $=`${D}${I}`;return c($.trim().length>0),$}),queueMicrotask(()=>{const D=g.current;D&&(D.style.height="auto",D.style.height=`${Math.min(D.scrollHeight,140)}px`)}))},[c,l,g]),L=i.useCallback(I=>{if(I.preventDefault(),S)return;const D=o.trim();D&&(l(""),f(),y(D))},[S,o,y,l,f]);if(!e)return null;const P=S||!o.trim()||R||p,k=p||R||S;return a.jsxs(Fn,{onSubmit:L,className:"space-y-3",onHeightChange:s,minHeight:t,children:[n.length>0&&a.jsxs("div",{className:"flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[a.jsx("span",{children:r?n.length===1?`${n[0]} is typingâ€¦`:n.length===2?`${n[0]} and ${n[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),a.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}),p&&a.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs",children:[a.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[a.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Uploading imageâ€¦"})]}),a.jsx(F,{type:"button",size:"sm",variant:"outline",onClick:b,children:"Cancel"})]}),u&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(z,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),d&&a.jsx(F,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Retry"})]}),m&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ls,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:m})]}),a.jsx(F,{type:"button",size:"sm",variant:"ghost",onClick:v,children:"Dismiss"})]}),a.jsxs("div",{className:"flex w-full items-center gap-2",children:[a.jsxs(Ms,{open:M,onOpenChange:N,children:[a.jsx(Ss,{asChild:!0,children:a.jsx(F,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",children:a.jsx(zs,{className:"h-4 w-4","aria-hidden":"true"})})}),a.jsx(Cs,{side:"top",align:"start",className:"rounded-2xl border border-border/70 bg-popover/95 p-3 shadow-2xl backdrop-blur",children:a.jsx(Ns,{className:"max-h-64",children:a.jsx("div",{className:"grid grid-cols-9 gap-2",children:Un.map(I=>a.jsx(F,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted",onClick:()=>{j(I),N(!1)},children:a.jsx("span",{children:I})},I))})})})]}),a.jsx(F,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",onClick:E,"aria-label":"Send photo",disabled:k,"aria-busy":p,children:a.jsx(Us,{className:"h-4 w-4","aria-hidden":"true"})}),a.jsx("input",{type:"file",ref:T,accept:"image/*",className:"hidden",onChange:w}),a.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-input/70 bg-muted/40 px-3 py-2 shadow-inner",children:a.jsx(tt,{id:"conversation-message",value:o,ref:g,rows:1,autoComplete:"off",onChange:_,onBlur:f,onKeyDown:I=>{I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),o.trim()&&I.currentTarget.form?.requestSubmit())},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),a.jsx(F,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full touch-manipulation shadow-sm",onMouseDown:I=>I.preventDefault(),disabled:P,"aria-label":"Send message","aria-busy":R||p,children:R||p?a.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):a.jsx(qs,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},qn=({open:e,editingMessage:t,onOpenChange:s,onCancel:n,onTextChange:r,onSave:o,textareaRef:l,error:g,isSaving:c})=>a.jsx(st,{open:e,onOpenChange:s,children:a.jsxs(nt,{children:[a.jsxs(rt,{children:[a.jsx(at,{children:"Edit message"}),a.jsx(ot,{children:"Update your message for everyone in the conversation."})]}),t&&a.jsx(tt,{ref:l,value:t.text,onChange:f=>r(f.target.value),rows:3,className:"min-h-[120px]"}),g&&a.jsx("p",{className:"text-xs text-destructive",children:g}),a.jsxs(it,{className:"gap-2",children:[a.jsx(F,{type:"button",variant:"ghost",onClick:n,children:"Cancel"}),a.jsxs(F,{type:"button",disabled:!t?.text.trim()||c,onClick:o,children:[c&&a.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Save"})]})]})]})}),$n=({open:e,deleteDialog:t,onOpenChange:s,onHideForMe:n,onDeleteForEveryone:r,isDeleting:o})=>a.jsx(st,{open:e,onOpenChange:s,children:a.jsxs(nt,{children:[a.jsxs(rt,{className:"gap-1",children:[a.jsxs(at,{className:"flex items-center gap-2 text-base",children:[a.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:a.jsx(js,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),a.jsx(ot,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),a.jsxs(it,{className:"gap-2",children:[a.jsx(F,{type:"button",variant:"outline",className:"flex-1",onClick:n,disabled:!t,children:"Hide for me"}),a.jsxs(F,{type:"button",variant:"destructive",className:"flex-1",disabled:o||!t,onClick:r,children:[o&&a.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Delete for everyone"})]})]})]})});function Hn(){const[e,t]=i.useState(!1);return i.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const s=window.matchMedia("(prefers-reduced-motion: reduce)"),n=()=>{t(s.matches)};return n(),typeof s.addEventListener=="function"?(s.addEventListener("change",n),()=>s.removeEventListener("change",n)):(s.addListener(n),()=>s.removeListener(n))},[]),e}const sr=()=>{const{conversationId:e}=ls(),t=e??null,s=i.useRef(null),n=cs(),{user:r}=me(),{data:o,isLoading:l}=us(),g=Dn({currentUserId:r?.id??null}),{data:c,isLoading:f,isError:y,error:p,loadOlder:b,hasMore:u,isLoadingOlder:d,firstItemIndex:x,pollWhenRealtimeDown:m}=an(t,{onInsert:g}),v=i.useRef(null);i.useEffect(()=>{if(!t||!c||c.length===0)return;const h=v.current;let C=0;if(h){const U=c.findIndex(ce=>ce.id===h);C=U>=0?U+1:0}for(let U=C;U<c.length;U++)g(c[U]);v.current=c[c.length-1].id},[t,c,g]);const{draft:M,setDraft:N}=Sn({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const h=Z.current;h&&(h.style.height="auto",h.style.height=`${Math.min(h.scrollHeight,140)}px`)})}}),{sendError:E,lastFailedPayload:T,failedMessages:w,clearBannerState:R,onSendFailed:S,onSendRecovered:_,consumeLastFailedForRetry:j,consumeFailedMessageForRetry:L,discardFailedMessage:P}=Tn({conversationId:t,setDraft:h=>N(h),messages:c}),k=i.useMemo(()=>!t||!o?null:o.find(h=>h.id===t)??null,[t,o]),I=k?.isGroup??!1,D=i.useMemo(()=>{if(!k)return null;const h=k.participants.filter(C=>!C.isSelf);return h.length>0?h[0]:k.participants.length===1?k.participants[0]:null},[k]),$=k?.title??D?.displayName??D?.username??"Conversation",X=Is(t,{onFailed:S,onRecovered:_,otherUserId:I?null:D?.id??null}),J=i.useCallback((h,C)=>{R(),X.mutate({text:h.text,attachmentPath:h.attachmentPath,clientId:h.clientId,tempId:C?.tempId},{onSuccess:()=>{R()}})},[R,X]),Z=i.useRef(null),mt=i.useMemo(()=>{const h=new Map;if(!k)return h;for(const C of k.participants)h.set(C.id,C);return h},[k]),{youBlocked:ye,blockedYou:O,isBlocked:ee,block:Le,unblock:Ae}=Es(I?null:D?.id??null),ae=r?.id??null,{fileInputRef:gt,isUploadingImage:pt,uploadError:ht,cancelImageUpload:xt,clearUploadError:yt,handleImageSelected:bt,openFilePicker:vt}=_s({conversationId:t,userId:ae,isBlocked:ee,blockedYou:O,attemptSend:J}),oe=!ee&&!O,wt=!!D&&!I,Rt=Le.isPending||Ae.isPending,Be=wt?{icon:Hs,label:ye?"Unblock":O?"Blocked":"Block",onClick:()=>{ye?Ae.mutate():O||Le.mutate()},disabled:Rt||l||O&&!ye}:null,{headerRef:Mt,headerHeight:St,composerHeight:Ct,isAtBottom:Q,setIsAtBottom:Nt,handleComposerHeightChange:jt,showEmojiPicker:It,setShowEmojiPicker:be}=Cn({showComposer:oe}),Et=oe?`calc(${Math.max(Ct,0)}px + 20px)`:"2.5rem",_t=i.useMemo(()=>k?.participants.find(h=>h.isSelf)?.displayName??"You",[k]),{remoteTypingUsers:kt,noteLocalInputActivity:Tt,stopTyping:Dt}=Mn({conversationId:t,userId:r?.id??null,displayName:_t}),{data:Pe}=yn(t);En({conversationId:t,userId:r?.id??null,isAtBottom:Q,messages:c});const{reactionsByMessageId:Lt,toggleReaction:Fe}=xn(t),At=i.useCallback((h,C)=>{Fe.mutate({messageId:h,emoji:C})},[Fe]),H=i.useRef(null),ve=i.useRef(!1),ie=i.useRef(null),[Ue,le]=i.useState(0),V=Hn(),{activeActionMessageId:Bt,openMessageActions:Oe,closeMessageActions:we,hiddenMessageIds:qe,hideMessageForMe:Pt,deleteDialog:W,openDeleteDialog:Ft,closeDeleteDialog:Re,editingMessage:G,openEditDialog:Ut,updateEditingText:Ot,closeEditDialog:Me,editTextareaRef:qt,editError:$t,setEditError:$e}=Nn({conversationId:t,currentUserId:ae,showComposer:oe,isBlocked:ee,blockedYou:O,composerTextareaRef:Z}),Se=cn({messages:c,currentUserId:ae,hiddenMessageIds:qe}),{data:Ht}=bn(t,Se?[Se]:[]),He=_n(t),Ke=kn(t),{visibleMessages:A}=ln({messages:c,conversation:k,currentUserId:ae,participantsById:mt,reactionsByMessageId:Lt,hiddenMessageIds:qe,deliveryReceipts:Ht??[],readReceipts:Pe??[],failedMessages:w,lastOwnMessageId:Se}),{firstUnreadIndex:K}=Ln({conversationId:t,userId:r?.id??null,conversation:k,readReceipts:Pe,visibleMessages:A}),Kt=i.useMemo(()=>K==null?0:A.slice(K).filter(h=>!h.isSelf&&!h.meta.deleted).length,[K,A]),ze=A.length>0;i.useEffect(()=>{const h=A.length?A[A.length-1]?.message.id??null:null;if(Q){ie.current=h,le(0);return}if(!h)return;const C=ie.current;if(C===h)return;const U=C?A.findIndex(se=>se.message.id===C):-1,ue=A.slice(Math.max(0,U+1)).filter(se=>!se.isSelf).length;ue<=0||le(ue)},[Q,A]),i.useEffect(()=>()=>{H.current!=null&&window.clearTimeout(H.current)},[]),i.useEffect(()=>{const h=C=>{C.key==="Escape"&&(we(),be(!1))};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[we,be]);const zt=i.useCallback(h=>{h.trim()&&(R(),J({text:h.trim(),attachmentPath:null}))},[J,R]),Qt=()=>{const h=j();h&&J(h.payload,{tempId:h.tempId??void 0})},Wt=h=>{H.current!=null&&window.clearTimeout(H.current),ve.current=!1,H.current=window.setTimeout(()=>{ve.current=!0,Oe(h)},500)},Gt=()=>{H.current!=null&&(window.clearTimeout(H.current),H.current=null)};if(!t)return a.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:a.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[a.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),a.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),a.jsx("p",{className:"mt-4",children:a.jsx(ds,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})});const Jt=i.useCallback(h=>{const C=L(h.id);C&&J(C,{tempId:h.id})},[J,L]),Vt=i.useCallback(h=>{P(h.id)},[P]),te=V?"auto":"smooth",Ce=i.useCallback(()=>{const h=A.length-1;if(h<0)return;const C=A[h]?.message.id??null;C&&(ie.current=C),le(0),s.current?.scrollToIndex({index:x+h,align:"end",behavior:te}),window.setTimeout(()=>{Z.current?.focus()},V?0:200)},[x,te,V,A]),Ne=i.useCallback(()=>{K!=null&&(s.current?.scrollToIndex({index:x+K,align:"start",behavior:te}),window.setTimeout(()=>{Z.current?.focus()},V?0:150))},[x,K,te,V]);return i.useEffect(()=>{ie.current=null,le(0)},[t]),i.useEffect(()=>{const h=C=>{if(C.key==="End"||C.key==="ArrowDown"&&(C.metaKey||C.ctrlKey)||C.key==="End"&&(C.metaKey||C.ctrlKey)){C.preventDefault(),Ce();return}C.key.toLowerCase()==="u"&&C.altKey&&(C.preventDefault(),Ne())};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[Ce,Ne]),a.jsxs("div",{className:"conversation-page relative flex min-h-screen w-full flex-col items-stretch bg-background",children:[a.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[a.jsx(As,{ref:Mt,title:$,actions:Be?[Be]:void 0,onBack:()=>n(-1),canGoBack:!0}),a.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[a.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[m&&a.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:a.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[a.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),a.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),a.jsx(An,{items:A,isLoading:f&&!ze,loadingContent:a.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[a.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:y?a.jsxs("div",{className:"mb-3 rounded-md border border-border bg-background/90 px-3 py-2 text-[12px] text-destructive",children:[a.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),p instanceof Error&&a.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:p.message})]}):void 0,emptyContent:ze?void 0:a.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[a.jsx("p",{className:"font-medium",children:I?"No messages in this group yet.":"No messages yet."}),a.jsx("p",{className:"mt-1",children:I?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:a.jsx("div",{className:"h-1","aria-hidden":!0}),header:u?a.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:d?a.jsxs("span",{className:"inline-flex items-center gap-2",children:[a.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):a.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Et,followOutput:Q?V?!0:"smooth":!1,autoScrollOnNewLastItem:!0,autoScrollBehavior:te,autoScrollEnabled:Q,onAtBottomChange:Nt,onStartReached:()=>{u&&!d&&b()},firstItemIndex:x,virtuosoRef:s,computeItemKey:(h,C)=>C.message.id,itemContent:(h,C)=>{const{message:U,meta:ce,sender:ue,isSelf:se,deliveryStatus:Yt,reactions:Xt,showDeliveryStatus:Zt}=C,es=h>0?A[h-1]?.message??null:null,ts=h<A.length-1?A[h+1]?.message??null:null;return a.jsx(ks,{message:U,meta:ce,sender:ue,isSelf:se,deliveryStatus:Yt,showDeliveryStatus:Zt,reactions:Xt,index:h,previousMessage:es,nextMessage:ts,firstUnreadIndex:K,activeActionMessageId:Bt,longPressTriggeredRef:ve,onOpenMessageActions:Oe,onCloseMessageActions:we,onOpenEditDialog:Ut,onOpenDeleteDialog:Ft,onToggleReaction:At,onRetryMessage:Jt,onDiscardFailedMessage:Vt,onBubbleTouchStart:Wt,onBubbleTouchEndOrCancel:Gt})}}),a.jsx(Pn,{show:K!=null&&!Q,unreadCount:Kt,onClick:Ne,shortcutHint:"Alt+U"}),a.jsx(Bn,{show:!Q&&Ue>0,pendingCount:Ue,onClick:Ce,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),a.jsx(On,{show:oe,headerHeight:St,onHeightChange:jt,typingUsers:kt,isGroupConversation:I,draft:M,setDraft:N,textareaRef:Z,noteLocalInputActivity:Tt,stopTyping:Dt,onSendText:zt,isUploadingImage:pt,cancelImageUpload:xt,sendError:!!E,canRetrySend:!!T,onRetrySend:Qt,uploadError:ht,clearUploadError:yt,showEmojiPicker:It,setShowEmojiPicker:be,openCameraPicker:vt,fileInputRef:gt,onImageSelected:bt,isSending:X.isPending,disableSend:!!(ee||O)}),O&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You can't send messages because this user has blocked you."})}),ee&&!O&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),a.jsx(qn,{open:!!G,editingMessage:G,onOpenChange:h=>{h||Me()},onCancel:Me,onTextChange:Ot,textareaRef:qt,error:$t,isSaving:He.isPending,onSave:()=>{if(!G)return;const h=G.text.trim();h&&($e(null),He.mutate({messageId:G.messageId,text:h,currentBody:G.body,attachmentUrl:G.attachmentUrl},{onSuccess:()=>{Me()},onError:()=>{$e("Couldn't save changes. Please try again.")}}))}}),a.jsx($n,{open:!!W,deleteDialog:W,onOpenChange:h=>{h||Re()},onHideForMe:()=>{W&&(Pt(W.messageId),Re())},onDeleteForEveryone:()=>{W&&Ke.mutate({messageId:W.messageId,attachmentUrl:W.attachmentUrl},{onSettled:()=>{Re()}})},isDeleting:Ke.isPending})]})};export{sr as default,Is as useSendMessage};
