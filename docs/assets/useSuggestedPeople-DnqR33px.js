import{b as L,e as $,c as k,s as d,d as X}from"./index-CfTfJYoU.js";const Y="moviNesta.suggestedPeople.dismissed.v1",M=s=>`${Y}:${s}`,N=s=>{try{const a=localStorage.getItem(M(s));if(!a)return[];const i=JSON.parse(a);return Array.isArray(i)?i.filter(_=>typeof _=="string"):[]}catch{return[]}},j=(s,a)=>{const i=new Set(N(s));i.add(a);try{localStorage.setItem(M(s),JSON.stringify(Array.from(i)))}catch{}},V=()=>{const{user:s}=L(),a=s?.id??"__anon__",i=$();return{...k({queryKey:["suggested-people",a],enabled:!0,staleTime:1e3*60*5,gcTime:1e3*60*30,queryFn:async()=>{const r=s?.id??null,R=new Set(N(a)),{data:U,error:y}=r?await d.from("follows").select("followed_id").eq("follower_id",r):{data:[],error:null};y&&console.warn("[useSuggestedPeople] Failed to load follows",y.message);const h=new Set((U??[]).map(e=>e.followed_id)),C=new Set([...r?[r]:[],...R,...h]),{data:v,error:P}=r?await d.from("ratings").select("title_id, rating").eq("user_id",r).order("rating",{ascending:!1}).limit(40):{data:[],error:null};P&&console.warn("[useSuggestedPeople] Failed to load viewer ratings",P.message);const S=v?v.filter(e=>typeof e.title_id=="string"&&typeof e.rating=="number").slice(0,30):[],p=Array.from(new Set(S.map(e=>e.title_id))),T=new Map(S.map(e=>[e.title_id,e.rating??0])),{data:D,error:E}=await d.from("user_stats").select("user_id, followers_count, following_count").order("followers_count",{ascending:!1}).limit(60);E&&console.warn("[useSuggestedPeople] Failed to load user_stats",E.message);const A=(D??[]).filter(e=>!C.has(e.user_id)),m=A.map(e=>e.user_id).slice(0,40);if(!m.length)return[];const{data:B,error:F}=await d.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",m).limit(40);if(F)throw new Error(F.message);const x=new Map(A.map(e=>[e.user_id,{followersCount:e.followers_count??0,followingCount:e.following_count??0}])),f=new Map;if(p.length>=5){const{data:e,error:t}=await d.from("ratings").select("user_id, title_id, rating").in("user_id",m).in("title_id",p).limit(2e3);if(t)console.warn("[useSuggestedPeople] Failed to load candidate ratings",t.message);else{const n=e??[],l=new Map;n.forEach(o=>{if(!o?.user_id)return;const c=l.get(o.user_id)??[];c.push(o),l.set(o.user_id,c)}),m.forEach(o=>{const I=(l.get(o)??[]).filter(u=>T.has(u.title_id)),g=I.length;if(!g){f.set(o,{commonTitlesCount:0,matchPercent:0,score:0});return}let b=0,w=0;I.forEach(u=>{const q=T.get(u.title_id);typeof q!="number"||typeof u.rating!="number"||(b+=Math.abs(q-u.rating),w+=1)});const O=w?b/w:0,Q=g*10-O*2,J=Math.round(g/Math.max(1,p.length)*100);f.set(o,{commonTitlesCount:g,matchPercent:J,score:Q})})}}const K=(B??[]).map(e=>{const t=x.get(e.id),n=f.get(e.id);return{id:e.id,username:e.username??null,displayName:e.display_name??null,avatarPathOrUrl:typeof e.avatar_url=="string"?e.avatar_url:null,bio:e.bio??null,followersCount:t?.followersCount??0,followingCount:t?.followingCount??0,isFollowing:h.has(e.id),commonTitlesCount:n?.commonTitlesCount,matchPercent:n?.matchPercent,_score:n?.score??0}}).filter(e=>!C.has(e.id));return(await Promise.all(K.map(async e=>{const t=await X(e.avatarPathOrUrl);return{id:e.id,username:e.username,displayName:e.displayName,avatarUrl:t,bio:e.bio,followersCount:e.followersCount,followingCount:e.followingCount,isFollowing:e.isFollowing,commonTitlesCount:e.commonTitlesCount,matchPercent:e.matchPercent}}))).map(e=>({person:e,score:f.get(e.id)?.score??0})).sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;const n=e.person.commonTitlesCount??0,l=t.person.commonTitlesCount??0;if(l!==n)return l-n;if(t.person.followersCount!==e.person.followersCount)return t.person.followersCount-e.person.followersCount;const o=(e.person.displayName??e.person.username??"").toLowerCase(),c=(t.person.displayName??t.person.username??"").toLowerCase();return o.localeCompare(c)}).map(e=>e.person).slice(0,15)}}),dismissPerson:r=>{s?.id&&(j(s.id,r),i.invalidateQueries({queryKey:["suggested-people",s.id]}))}}};export{V as u};
