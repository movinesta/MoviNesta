import{u as te,I as se,G as ae,R as h,c as Y,a7 as re,j as e,B as D,i as ie,L as ne,D as le,e as oe,b as ce,w as de,q as Z,h as me,s as C,aF as ue,x as xe}from"./index-DB3o-sVP.js";import{R as W,S as L}from"./skeleton-DEVl_Kwm.js";import{M as R}from"./material-icon-D1bYoeH7.js";import{D as he,a as pe,b as fe,c as ge}from"./dialog-Di7vpqlv.js";import{I as be}from"./input-DCjUL-Bj.js";import{T as we}from"./textarea-B_kLlkh4.js";function z(s){try{return Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1}).format(s)}catch{return String(s)}}function ve(...s){return s.map(i=>typeof i=="string"?i.trim():"").find(i=>!!i)||"Reviews"}function _e(s){const r=new Date(s),i=Date.now(),l=Math.max(0,i-r.getTime()),a=Math.floor(l/6e4);if(a<1)return"Just now";if(a<60)return`${a}m ago`;const d=Math.floor(a/60);if(d<24)return`${d}h ago`;const m=Math.floor(d/24);if(m<7)return`${m}d ago`;const g=Math.floor(m/7);if(g<5)return`${g}w ago`;const u=Math.floor(m/30);return u<12?`${u}mo ago`:`${Math.floor(m/365)}y ago`}function je(){return e.jsx("div",{className:"-mx-4 h-px bg-white/5"})}function J({children:s,label:r,onClick:i}){return e.jsx("button",{type:"button","aria-label":r,onClick:i,className:"flex size-11 items-center justify-center rounded-full border border-white/10 bg-white/10 text-white backdrop-blur-md transition hover:bg-white/20 active:scale-[0.98]",children:s})}function ye({summary:s}){const r=[{star:5,count:s.stars_5},{star:4,count:s.stars_4},{star:3,count:s.stars_3},{star:2,count:s.stars_2},{star:1,count:s.stars_1}],i=r.reduce((l,a)=>l+a.count,0);return e.jsx("div",{className:"grid grid-cols-[12px_1fr_38px] items-center gap-x-3 gap-y-2",children:r.map(l=>{const a=i?Math.round(l.count/i*100):0;return e.jsxs(h.Fragment,{children:[e.jsx("p",{className:"text-xs font-medium text-white",children:l.star}),e.jsx("div",{className:"flex h-1.5 flex-1 overflow-hidden rounded-full bg-[#3d3349]",children:e.jsx("div",{className:"rounded-full bg-primary",style:{width:`${a}%`,opacity:.2+l.star/5*.8}})}),e.jsxs("p",{className:"text-right text-xs text-white/50",children:[a,"%"]})]},l.star)})})}function Ne({review:s,profile:r,reactions:i}){const l=(r?.display_name??r?.username??"?").split(/\s+/g).slice(0,2).map(w=>w.slice(0,1).toUpperCase()).join("").slice(0,2),a=s.rating==null?null:le(s.rating),[d,m]=h.useState(!1),u=!!!s.spoiler||d;return e.jsxs("div",{className:"rounded-2xl bg-[#302839] p-4",children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[r?.avatar_url?e.jsx("img",{src:r.avatar_url,alt:r.display_name??r.username??"User",className:"size-10 rounded-full object-cover"}):e.jsx("div",{className:"flex size-10 items-center justify-center rounded-full bg-primary/20 font-bold text-primary",children:l}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold text-white",children:r?.display_name??r?.username??"User"}),e.jsx("p",{className:"text-xs text-white/40",children:_e(s.created_at)})]})]}),a!=null?e.jsxs("div",{className:"flex items-center gap-1 rounded-lg bg-[#211a29] px-2 py-1",children:[e.jsx(R,{name:"star",className:"text-sm text-yellow-500",filled:!0}),e.jsx("span",{className:"text-xs font-bold text-white",children:a.toFixed(1)})]}):null]}),s.headline?e.jsx("p",{className:"mb-2 text-sm font-semibold text-white",children:s.headline}):null,s.body?e.jsx("div",{className:"text-sm leading-relaxed text-white/75",children:u?e.jsx("p",{children:s.body}):e.jsxs("div",{className:"rounded-xl border border-white/10 bg-[#211a29] p-3",children:[e.jsx("p",{className:"text-white/80",children:"Spoiler warning"}),e.jsxs("button",{type:"button",className:"mt-2 inline-flex items-center gap-2 text-sm font-semibold text-primary",onClick:()=>m(!0),children:["View spoiler",e.jsx(R,{name:"chevron_right",className:"text-base"})]})]})}):null,e.jsxs("div",{className:"mt-4 flex items-center gap-4 text-xs text-white/55",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 transition-colors hover:text-primary",children:[e.jsx(R,{name:"thumb_up",className:"text-base"}),e.jsx("span",{children:i.up?z(i.up):"0"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 transition-colors hover:text-red-400",children:[e.jsx(R,{name:"thumb_down",className:"text-base"}),e.jsx("span",{children:i.down?z(i.down):"0"})]}),e.jsx("button",{type:"button",className:"ml-auto rounded-full bg-white/10 px-4 py-1.5 text-xs font-semibold text-white/80 hover:bg-white/20",children:"Reply"})]})]})}function Se({open:s,onOpenChange:r,titleName:i,titleId:l,contentType:a}){const d=oe(),{user:m}=ce(),[g,u]=h.useState(4),[w,B]=h.useState(""),[P,p]=h.useState(""),[E,I]=h.useState(!1),[F,M]=h.useState(null);h.useEffect(()=>{s||(M(null),B(""),p(""),I(!1),u(4))},[s]);const T=de({mutationFn:async()=>{if(!m)throw new Error("SIGN_IN_REQUIRED");const c=ue(g);if(c==null)throw new Error("INVALID_RATING");const v=me(),_=[];_.push(Promise.resolve(C.from("reviews").insert({user_id:m.id,title_id:l,content_type:a,rating:c,headline:w.trim()||null,body:P.trim()||null,spoiler:E})).then(({error:x})=>{if(x)throw x})),_.push(Promise.resolve(C.from("ratings").upsert({user_id:m.id,title_id:l,content_type:a,rating:c},{onConflict:"user_id,title_id"})).then(({error:x})=>{if(x)throw x})),_.push(xe({sessionId:v,deckId:null,position:null,mediaItemId:l,eventType:"rating",rating0_10:c,source:"title_reviews",payload:{action:"rate_and_review",origin:"title_reviews"}})),await Promise.allSettled(_)},onSuccess:async()=>{M(null),r(!1),await d.invalidateQueries({queryKey:["title","reviews",l]}),await d.invalidateQueries({queryKey:["title","rating-summary",l]}),d.invalidateQueries({queryKey:Z.titleDetail(l)})},onError:c=>{if(c?.message==="SIGN_IN_REQUIRED"){M("Sign in to rate and review.");return}M(c?.message??"Failed to submit review.")}});return e.jsx(he,{open:s,onOpenChange:r,children:e.jsxs(pe,{className:"max-w-lg border-white/10 bg-[#211a29] text-white",children:[e.jsxs(fe,{children:[e.jsx(ge,{children:"Rate & Review"}),e.jsx("p",{className:"mt-1 text-sm text-white/60",children:i})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold",children:"Your rating"}),e.jsxs("p",{className:"text-sm font-bold text-white",children:[g.toFixed(1),"/5"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx(W,{rating:g,size:20})}),e.jsx("input",{className:"mt-3 w-full",type:"range",min:0,max:5,step:.5,value:g,onChange:c=>u(Number(c.target.value))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold",children:"Headline"}),e.jsx(be,{value:w,onChange:c=>B(c.target.value),placeholder:"Add a short headline",className:"border-white/10 bg-white/5 text-white placeholder:text-white/40"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold",children:"Review"}),e.jsx(we,{value:P,onChange:c=>p(c.target.value),placeholder:"Share your thoughts",className:"min-h-[120px] border-white/10 bg-white/5 text-white placeholder:text-white/40"})]}),e.jsxs("label",{className:"flex items-center justify-between rounded-xl border border-white/10 bg-white/5 px-4 py-3",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Contains spoilers"}),e.jsx("input",{type:"checkbox",checked:E,onChange:c=>I(c.target.checked),className:"size-5 accent-primary"})]}),F?e.jsx("p",{className:"text-sm text-destructive",children:F}):null,e.jsxs("div",{className:"flex gap-3",children:[e.jsx(D,{variant:"secondary",className:"flex-1 border-white/10 bg-white/10 text-white hover:bg-white/15",onClick:()=>r(!1),disabled:T.isPending,children:"Cancel"}),e.jsx(D,{className:"flex-1",onClick:()=>T.mutate(),disabled:T.isPending,children:T.isPending?"Savingâ€¦":"Post"})]})]})]})})}function Fe(){const s=te(),r=se(),[i,l]=ae(),a=String(r.titleId??""),d=/^[0-9a-fA-F-]{36}$/.test(a),[m,g]=h.useState("recent"),[u,w]=h.useState(!1),[B,P]=h.useState(!1);h.useEffect(()=>{if(i.get("compose")==="1"){P(!0);const t=new URLSearchParams(i);t.delete("compose"),l(t,{replace:!0})}},[i,l]);const p=Y({queryKey:Z.titleDetail(d?a:null),enabled:d,staleTime:1e3*60,queryFn:async()=>{const{data:t,error:o}=await C.from("media_items").select("id,kind,tmdb_title,tmdb_name,omdb_title,tmdb_release_date,tmdb_first_air_date,tmdb_genres,omdb_genre").eq("id",a).maybeSingle();if(o&&o.code!=="PGRST116")throw o;return t??null}}),E=(()=>{const t=p.data?.kind;return t==="anime"?"anime":t==="movie"?"movie":"series"})(),I=ve(p.data?.tmdb_title,p.data?.tmdb_name,p.data?.omdb_title),F=(()=>{const t=p.data?.tmdb_release_date??p.data?.tmdb_first_air_date??null;if(!t)return null;const o=Number(String(t).slice(0,4));return Number.isNaN(o)?null:o})(),M=(()=>{const t=p.data?.tmdb_genres??[];if(Array.isArray(t)){const n=t.find(f=>f?.name);if(n?.name)return n.name}const o=p.data?.omdb_genre??null;return o?String(o).split(",")[0]?.trim()??null:null})(),c=[F?String(F):null,M].filter(Boolean).join(" â€¢ "),v=Y({queryKey:["title","rating-summary",d?a:null],enabled:d,staleTime:1e3*60,queryFn:async()=>{const{data:t,error:o}=await C.rpc("get_title_rating_summary_v1",{p_title_id:a});if(o)return console.warn("[TitleReviewsPageV2] rating summary RPC error",o.message),null;const n=Array.isArray(t)?t[0]:t;return n?{title_id:String(n.title_id??a),reviews_count:Number(n.reviews_count??0),ratings_count:Number(n.ratings_count??0),average_rating_0_10:n.average_rating_0_10==null?null:Number(n.average_rating_0_10),average_rating_0_5:n.average_rating_0_5==null?null:Number(n.average_rating_0_5),stars_5:Number(n.stars_5??0),stars_4:Number(n.stars_4??0),stars_3:Number(n.stars_3??0),stars_2:Number(n.stars_2??0),stars_1:Number(n.stars_1??0)}:null}}),_=10,x=re({queryKey:["title","reviews",a,m],enabled:d,initialPageParam:0,getNextPageParam:t=>t?.nextFrom??void 0,queryFn:async({pageParam:t})=>{const o=Number(t??0),n=o+_-1;let f=C.from("reviews").select("id,user_id,title_id,rating,headline,body,spoiler,created_at",{count:"exact"}).eq("title_id",a);m==="recent"?f=f.order("created_at",{ascending:!1}):m==="top"?f=f.order("rating",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}):f=f.order("rating",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1});const{data:q,error:y,count:N}=await f.range(o,n);if(y)throw y;const b=q??[],H=Array.from(new Set(b.map(S=>S.user_id))),V=b.map(S=>S.id),O=new Map;if(H.length){const{data:S,error:$}=await C.from("profiles_public").select("id,username,display_name,avatar_url").in("id",H);if(!$)for(const k of S??[])O.set(k.id,k)}const Q=new Map;if(V.length){const{data:S,error:$}=await C.from("review_reactions").select("review_id,emoji").in("review_id",V);if(!$)for(const k of S??[]){const G=Q.get(k.review_id)??{up:0,down:0};k.emoji==="ðŸ‘"&&(G.up+=1),k.emoji==="ðŸ‘Ž"&&(G.down+=1),Q.set(k.review_id,G)}}return{rows:b,profilesById:O,reactionsByReview:Q,totalCount:Number(N??0),nextFrom:b.length===_?n+1:null}}}),j=h.useMemo(()=>{const t=x.data?.pages??[],o=[],n=new Map,f=new Map;let q=0;for(const y of t){for(const N of y.rows)o.push(N);for(const[N,b]of y.profilesById.entries())n.set(N,b);for(const[N,b]of y.reactionsByReview.entries())f.set(N,b);q=Math.max(q,Number(y.totalCount??0))}return{reviews:o,profiles:n,reactions:f,totalCount:q}},[x.data]),U=h.useMemo(()=>u?j.reviews:j.reviews.filter(t=>!t.spoiler),[j.reviews,u]),A=v.data?.average_rating_0_5??null,X=A==null?"â€“":A.toFixed(1),K=v.data?.ratings_count??j.totalCount,ee=async()=>{const t=typeof window<"u"?window.location.href:"";try{navigator.share?await navigator.share({title:I,url:t}):navigator.clipboard&&(await navigator.clipboard.writeText(t),alert("Link copied"))}catch{}};return d?e.jsxs("div",{className:"relative min-h-[calc(100dvh-(5.5rem+env(safe-area-inset-bottom)))] bg-[#1a1322] pb-24",children:[e.jsxs("div",{className:"sticky top-0 z-30 -mx-4 flex items-center justify-between bg-[#1a1322]/80 px-4 pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)] backdrop-blur relative",children:[e.jsx(J,{label:"Back",onClick:()=>s(-1),children:e.jsx(R,{name:"arrow_back"})}),e.jsxs("div",{className:"absolute left-1/2 w-[60%] -translate-x-1/2 text-center",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-white",children:p.isLoading?"":I}),e.jsx("p",{className:"truncate text-xs text-white/50",children:c||"Ratings & reviews"})]}),e.jsx(J,{label:"More",onClick:ee,children:e.jsx(R,{name:"more_vert"})})]}),e.jsxs("div",{className:"px-4 pt-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-6",children:[e.jsxs("div",{className:"flex min-w-[100px] flex-col items-center justify-center gap-1",children:[e.jsx("p",{className:"text-5xl font-black leading-none tracking-tight text-white",children:X}),e.jsx("div",{className:"mt-1",children:A!=null?e.jsx(W,{rating:A,size:14}):e.jsx(L,{className:"h-4 w-24"})}),e.jsx("p",{className:"mt-2 text-xs text-white/50",children:v.isLoading?"Loadingâ€¦":K?`${z(K)} verified ratings`:"No ratings yet"})]}),e.jsx("div",{className:"min-w-[200px] flex-1",children:v.data?e.jsx(ye,{summary:v.data}):e.jsx(L,{className:"h-24 w-full"})})]}),e.jsx("div",{className:"mt-6 overflow-x-auto pb-2",children:e.jsxs("div",{className:"flex gap-2 pr-2",children:[[{k:"recent",label:"Most Recent"},{k:"top",label:"Highest Rated"},{k:"critical",label:"Critical"}].map(t=>e.jsx("button",{type:"button",onClick:()=>g(t.k),className:"flex h-9 shrink-0 items-center justify-center rounded-full border px-4 text-xs font-semibold transition "+(m===t.k?"border-primary bg-primary text-white":"border-white/10 bg-white/10 text-white/70 hover:bg-white/20"),children:t.label},t.k)),e.jsxs("button",{type:"button",onClick:()=>w(t=>!t),className:ie("flex h-9 shrink-0 items-center gap-1.5 rounded-full border px-4 text-xs font-semibold transition",u?"border-primary bg-primary text-white":"border-white/10 bg-white/10 text-white/70 hover:bg-white/20"),"aria-pressed":u,children:["Spoilers",e.jsx(R,{name:u?"visibility":"visibility_off",className:"text-base"})]})]})}),e.jsx("div",{className:"my-6",children:e.jsx(je,{})}),e.jsxs("div",{className:"space-y-4",children:[x.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-28 w-full rounded-2xl"}),e.jsx(L,{className:"h-28 w-full rounded-2xl"})]}):null,U.map(t=>e.jsx(Ne,{review:t,profile:j.profiles.get(t.user_id)??null,reactions:j.reactions.get(t.id)??{up:0,down:0}},t.id)),!x.isLoading&&U.length===0?e.jsx("div",{className:"rounded-2xl bg-[#302839] p-4 text-sm text-white/60",children:j.reviews.length>0&&!u?"No spoiler-free reviews yet. Toggle spoilers to view all reviews.":"No reviews yet. Be the first to share your thoughts."}):null,x.hasNextPage?e.jsx(D,{variant:"secondary",className:"w-full rounded-full border-white/10 bg-white/10 text-white hover:bg-white/15",onClick:()=>x.fetchNextPage(),disabled:x.isFetchingNextPage,children:x.isFetchingNextPage?"Loadingâ€¦":"Load more"}):null]})]}),e.jsx("div",{className:"fixed inset-x-0 bottom-[calc(5.5rem+env(safe-area-inset-bottom))] z-40 px-4",children:e.jsx(D,{className:"h-14 w-full rounded-full",onClick:()=>P(!0),children:"Rate & Review"})}),e.jsx(Se,{open:B,onOpenChange:P,titleName:I,titleId:a,contentType:E}),e.jsx("div",{className:"sr-only",children:e.jsx(ne,{to:`/title/${a}`,children:"Back to title"})})]}):e.jsxs("div",{className:"px-4 py-10 text-center text-white/70",children:["This title link is invalid.",e.jsx("div",{className:"mt-4",children:e.jsx(D,{onClick:()=>s(-1),children:"Go back"})})]})}export{Fe as default};
