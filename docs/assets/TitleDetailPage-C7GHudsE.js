import{j as e,m as ie,u as oe,R as Q,h as H,g as de,z as Z,t as D,L as $,d as me,s as I}from"./index-D8UbFo8l.js";import{a as ce,c as xe,d as ue,b as pe}from"./diaryStatus-CEaO_AiJ.js";import{P as R}from"./PageChrome-BL71Rgrf.js";import{T as L}from"./TopBar-ClKHHvFp.js";import"./brand-DTIDtbc4.js";const J=({value:n,max:c=5,disabled:d,onChange:g,size:f="sm"})=>{const t=n??0,y=f==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-[11px] transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-[13px] transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:c}).map((A,a)=>{const m=a+1,h=t>=m;return e.jsx("button",{type:"button",onClick:()=>{if(!g||d)return;g(t===m?null:m)},disabled:d,className:`${y} ${h?"border-mn-primary/80 bg-mn-primary/90 text-mn-bg":"border-mn-border-subtle/70 bg-mn-bg-elevated/60 text-mn-text-muted hover:border-mn-primary/70 hover:text-mn-primary/90"}`,"aria-label":`Rate ${m} star${m===1?"":"s"}`,children:"★"},m)})})},be=({imdb_rating:n,rt_tomato_pct:c,metascore:d})=>{if(!(typeof n=="number"&&n>0||typeof c=="number"&&c>0||typeof d=="number"&&d>0))return null;const f=typeof n=="number"&&!Number.isNaN(n)&&n>0,t=typeof c=="number"&&!Number.isNaN(c)&&c>0,y=typeof d=="number"&&!Number.isNaN(d)&&d>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-[11px] text-mn-text-muted",children:[f&&e.jsxs("span",{className:"inline-flex items-center rounded-full border border-mn-border-subtle px-2 py-0.5",children:[e.jsx("span",{className:"mr-1 font-semibold",children:"IMDb Rating"}),n.toFixed(1)]}),t&&e.jsxs("span",{className:"inline-flex items-center rounded-full border border-mn-border-subtle px-2 py-0.5",children:[e.jsx("span",{className:"mr-1 font-semibold",children:"Tomatometer"}),c,"%"]}),y&&e.jsxs("span",{className:"inline-flex items-center rounded-full border border-mn-border-subtle px-2 py-0.5",children:[e.jsx("span",{className:"mr-1 font-semibold",children:"MC"}),d]})]})},je=()=>{const{titleId:n}=ie(),c=oe(),[d,g]=Q.useState(null),f=async s=>{if(!(a!=null&&a.id)){alert("You need to be signed in to start a conversation.");return}if(a.id!==s){g(s);try{const r=await me("create-direct-conversation",{targetUserId:s},{timeoutMs:25e3});if(!(r!=null&&r.ok)||!r.conversationId){const o=r==null?void 0:r.errorCode;let p=(r==null?void 0:r.error)??"Failed to get conversation id. Please try again.";o==="UNAUTHORIZED"?p="You need to be signed in to start a conversation.":o==="BAD_REQUEST_SELF_TARGET"?p="You can't start a conversation with yourself.":o==="SERVER_MISCONFIGURED"&&(p="Messaging is temporarily unavailable due to a server issue. Please try again later.");const N=new Error(p);throw N.code=o,N}c(`/messages/${r.conversationId}`)}catch(r){console.error("[TitleDetailPage] Failed to start conversation",r);const o=r instanceof Error?r.message:"Something went wrong while starting the conversation. Please try again.";alert(o)}finally{g(null)}}},{data:t,isLoading:y,isError:A}=H({queryKey:Z.titleDetail(n),enabled:!!n,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!n)return null;const{data:s,error:r}=await I.from("titles").select(`
          title_id,
          content_type,
          primary_title,
          original_title,
          sort_title,
          release_year,
          release_date,
          runtime_minutes,
          tmdb_runtime,
          tmdb_episode_run_time,
          plot,
          tmdb_overview,
          tagline,
          omdb_director,
          omdb_actors,
          genres,
          tmdb_genre_names,
          language,
          omdb_language,
          tmdb_original_language,
          country,
          omdb_country,
          imdb_rating,
          imdb_votes,
          metascore,
          rt_tomato_pct,
          poster_url,
          tmdb_poster_path,
          backdrop_url,
          tmdb_backdrop_path,
          youtube_trailer_url,
          youtube_trailer_video_id,
          youtube_trailer_title
        `).eq("title_id",n).maybeSingle();if(r)throw r;return s}}),{user:a}=de(),{updateStatus:m,updateRating:h}=ce(),{data:U}=xe(n),l=U??{status:null,rating:null},{data:S,isLoading:X}=H({queryKey:Z.friendsTitleReactions((a==null?void 0:a.id)??null,n),enabled:!!(a!=null&&a.id&&n),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!(a!=null&&a.id)||!n)return[];const s=a.id,{data:r,error:o}=await I.from("follows").select("followed_user_id").eq("follower_user_id",s).limit(80);if(o)throw o;const p=(r??[]).map(i=>i.followed_user_id).filter(Boolean);if(!p.length)return[];const{data:N,error:K}=await I.from("ratings").select("user_id, rating, created_at").eq("title_id",n).in("user_id",p).order("rating",{ascending:!1}).limit(40);if(K)throw K;const V=(N??[]).map(i=>i.user_id);if(!V.length)return[];const{data:ae,error:G}=await I.from("profiles").select("id, display_name, username, avatar_url").in("id",V);if(G)throw G;const ne=new Map((ae??[]).map(i=>[i.id,{displayName:i.display_name??null,username:i.username??null,avatarUrl:i.avatar_url??null}])),le=(N??[]).map(i=>{const b=i.user_id,x=ne.get(b);return{userId:b,displayName:(x==null?void 0:x.displayName)??null,username:(x==null?void 0:x.username)??null,avatarUrl:(x==null?void 0:x.avatarUrl)??null,rating:i.rating??null,createdAt:i.created_at??null}}),M=new Map;for(const i of le){const b=M.get(i.userId);(!b||(i.rating??0)>(b.rating??0))&&M.set(i.userId,i)}return Array.from(M.values()).sort((i,b)=>(b.rating??0)-(i.rating??0))}}),_=t?t.poster_url??D(t.tmdb_poster_path,"w500"):null,w=t?t.backdrop_url??D(t.tmdb_backdrop_path,"w1280")??D(t.tmdb_backdrop_path,"w780"):null;if(Q.useEffect(()=>{const s=[_,w].filter(r=>!!r);s.length!==0&&s.forEach(r=>{const o=new Image;o.src=r})},[_,w]),!n)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(L,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(R,{children:e.jsxs("p",{className:"text-sm text-mn-text-secondary",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(y)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(L,{title:"Loading title"}),e.jsx(R,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-mn-bg-elevated/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-mn-bg-elevated/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-mn-bg-elevated/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-mn-bg-elevated/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-mn-bg-elevated/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-mn-bg-elevated/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-mn-bg-elevated/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-mn-bg-elevated/40"})]})]})]})})]});if(A||!t)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(L,{title:"Title not found"}),e.jsxs(R,{children:[e.jsx("p",{className:"text-sm text-mn-text-secondary",children:"We couldn't find that title."}),e.jsx($,{to:"/search",className:"mt-3 inline-block text-sm text-mn-primary underline",children:"Back to search"})]})]});const T=t.primary_title??t.original_title??"Untitled",E=t.release_year??(t.release_date?new Date(t.release_date).getFullYear():null),v=t.runtime_minutes??t.tmdb_runtime??(Array.isArray(t.tmdb_episode_run_time)&&t.tmdb_episode_run_time.length>0?t.tmdb_episode_run_time[0]:null),q=typeof v=="number"&&v>0?`${Math.floor(v/60)}h ${v%60?`${v%60}m`:""}`.trim():null,k=t.content_type==="movie"?"Movie":t.content_type==="series"?"TV Series":t.content_type??null,B=t.language??t.omdb_language??t.tmdb_original_language??null,Y=t.country??t.omdb_country??null,C=t.genres&&t.genres.length>0&&t.genres||t.tmdb_genre_names&&t.tmdb_genre_names.length>0&&t.tmdb_genre_names||[],j=t.plot??t.tmdb_overview??null,u=[];E&&u.push(String(E)),k&&u.push(k),q&&u.push(q),Y&&u.push(Y),B&&u.push(B);const ee=t.imdb_rating,te=t.metascore,se=t.rt_tomato_pct,O=t.content_type==="movie"||t.content_type==="series"?t.content_type:null,z=()=>a?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),P=s=>{!z()||m.isPending||m.mutate({titleId:t.title_id,status:s,type:O})},W=s=>{!z()||h.isPending||h.mutate({titleId:t.title_id,rating:s,type:O})},re=u.length>0?u.join(" · "):"Title details",F=s=>(l==null?void 0:l.status)===s;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-mn-border-subtle bg-mn-bg-elevated/80 shadow-mn-soft",children:[e.jsxs("div",{className:"absolute inset-0",children:[w?e.jsx("img",{src:w,alt:T,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-mn-bg via-mn-bg/70 to-mn-bg-elevated"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-mn-bg via-mn-bg/80 to-mn-bg/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:_?e.jsx("img",{src:_,alt:T,className:"aspect-[2/3] w-full rounded-mn-card object-cover shadow-mn-card",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-mn-card border border-dashed border-mn-border-subtle bg-mn-bg/70 text-xs text-mn-text-muted",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] uppercase tracking-[0.12em] text-mn-text-muted",children:k??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-mn-text-primary sm:text-3xl",children:T}),e.jsx("p",{className:"text-[12.5px] text-mn-text-secondary",children:re})]}),j&&e.jsx("p",{className:"max-w-3xl text-[13px] leading-relaxed text-mn-text-secondary sm:text-[14px]",children:j}),e.jsx(be,{imdb_rating:ee,rt_tomato_pct:se,metascore:te}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>P("want_to_watch"),disabled:m.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("want_to_watch")?"border-mn-primary bg-mn-primary/10 text-mn-primary":"border-mn-border-subtle bg-mn-bg text-mn-text-primary hover:border-mn-primary/60 hover:text-mn-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>P("watching"),disabled:m.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("watching")?"border-mn-primary bg-mn-primary/10 text-mn-primary":"border-mn-border-subtle bg-mn-bg text-mn-text-primary hover:border-mn-primary/60 hover:text-mn-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>P("watched"),disabled:m.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("watched")?"border-mn-primary bg-mn-primary/10 text-mn-primary":"border-mn-border-subtle bg-mn-bg text-mn-text-primary hover:border-mn-primary/60 hover:text-mn-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-mn-text-secondary",children:[e.jsx("span",{className:"font-semibold text-mn-text-primary",children:"Your rating"}),e.jsx(J,{value:(l==null?void 0:l.rating)??null,disabled:h.isPending,onChange:W}),(l==null?void 0:l.rating)!=null&&e.jsxs("span",{className:"text-[11px] text-mn-text-muted",children:[l.rating,"/10"]})]}),!a&&e.jsxs("p",{className:"text-[11.5px] text-mn-text-muted",children:[e.jsx($,{to:"/auth",className:"font-medium text-mn-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsx(R,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-mn-border-subtle bg-mn-bg/80 px-3 py-3 text-[12px] text-mn-text-secondary",children:[t.tagline&&e.jsx("p",{className:"text-[13px] font-medium text-mn-text-primary",children:t.tagline}),j&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-mn-text-secondary",children:j}),!t.tagline&&!j&&e.jsx("p",{className:"text-[12px] text-mn-text-muted",children:"We don't have a plot summary for this title yet."}),C&&C.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:C.slice(0,6).map(s=>e.jsx("span",{className:"rounded-full border border-mn-border-subtle px-2 py-[2px] text-[11px] text-mn-text-muted",children:s},s))}),(t.omdb_director||t.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-mn-text-muted",children:[t.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-mn-text-primary",children:"Director:"})," ",t.omdb_director]}),t.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-mn-text-primary",children:"Cast:"})," ",t.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated/80 px-3 py-3 text-[12px] text-mn-text-secondary",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-mn-text-primary",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-mn-text-muted",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),a&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-[11px]",children:[e.jsx("span",{className:pe(l==null?void 0:l.status),children:ue(l==null?void 0:l.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-mn-text-secondary",children:[e.jsx("span",{className:"font-medium text-mn-text-primary",children:"Rating"}),e.jsx(J,{value:(l==null?void 0:l.rating)??null,disabled:h.isPending,onChange:W})]})]})]}),!a&&e.jsx("p",{className:"mt-2 text-[11px] text-mn-text-muted",children:"Sign in to see your diary status and ratings for this title."})]}),a&&!X&&S&&S.length>0&&e.jsxs("div",{className:"rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated/80 px-3 py-3 text-[12px] text-mn-text-secondary",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-mn-text-primary",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-mn-text-muted",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:S.slice(0,4).map(s=>{var o;const r=s.displayName??(s.username?`@${s.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-mn-border-subtle/60 bg-mn-bg/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-mn-bg-elevated text-[11px] font-semibold text-mn-text-primary",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:r??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(o=(r??"?")[0])==null?void 0:o.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-mn-text-primary",children:r}),s.rating!=null&&e.jsxs("span",{className:"text-[11px] text-mn-text-muted",children:["Rated ",s.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx($,{to:s.username?`/u/${s.username}`:`/u/${s.userId}`,className:"text-[11px] font-medium text-mn-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>f(s.userId),disabled:d===s.userId,className:"text-[11px] font-medium text-mn-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:d===s.userId?"Starting…":"Message"})]})]},s.userId)})})]})]})})})]})};export{je as default};
