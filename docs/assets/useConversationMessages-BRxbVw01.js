import{C as A,s as S,r as u,e as D,a5 as C,ar as O}from"./index-DHFRnTo7.js";import{d as y,p as q,M as $,s as F}from"./scroll-area-WFgP_c77.js";const N=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],se=A("send",N),b=new Map,I=e=>{const t=b.get(e);if(t)return t;const s=S.channel(`conversation-db-${e}`),n={conversationId:e,channel:s,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.messageInsertListeners)o(r)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.messageUpdateListeners)o(r)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.readReceiptUpsertListeners)o(r)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.readReceiptUpsertListeners)o(r)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.deliveryReceiptUpsertListeners)o(r)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.deliveryReceiptUpsertListeners)o(r)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.reactionUpsertListeners)o(r)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.reactionUpsertListeners)o(r)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const r=a;for(const o of n.reactionDeleteListeners)o(r)}),s.subscribe(a=>{const r=a;n.lastStatus=r;for(const o of n.statusListeners)o(r)}),b.set(e,n),n},k=(e,t)=>{const s=I(e);s.refCount+=1;const n=[];return t.onStatus&&(s.statusListeners.add(t.onStatus),n.push(()=>s.statusListeners.delete(t.onStatus)),s.lastStatus&&t.onStatus(s.lastStatus)),t.onMessageInsert&&(s.messageInsertListeners.add(t.onMessageInsert),n.push(()=>s.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(s.messageUpdateListeners.add(t.onMessageUpdate),n.push(()=>s.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(s.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),n.push(()=>s.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(s.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),n.push(()=>s.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(s.reactionUpsertListeners.add(t.onReactionUpsert),n.push(()=>s.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(s.reactionDeleteListeners.add(t.onReactionDelete),n.push(()=>s.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const a of n)a();if(s.refCount-=1,s.refCount<=0){try{S.removeChannel(s.channel)}catch{}b.delete(e)}}},x=(e,t,s)=>{u.useEffect(()=>{if(e)return k(e,t())},[e,t,...s])},W=15e3,B=2e3,Q=15e3,j=e=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:e?B:W,refetchIntervalInBackground:!1}),V=new Set(["SUBSCRIBED"]),G=e=>!V.has(e),K=e=>{const[t,s]=u.useState(!1),n=u.useRef(e);u.useEffect(()=>{Object.is(n.current,e)||(n.current=e,s(!1))},[e]);const a=u.useCallback(r=>{const o=G(r);s(f=>f===o?f:o)},[]);return{pollWhenRealtimeDown:t,onStatus:a}},z=e=>{const{pollWhenRealtimeDown:t,onStatus:s}=K(e);return{pollWhenRealtimeDown:t,onRealtimeStatus:s,refetchOptions:j(t)}},H=e=>typeof e=="object"&&e!==null,X=e=>e.new,ne=e=>e.old,M=(e,t)=>{if(!H(e))return null;const s=e[t];return typeof s=="string"?s:null},Z=(e,t)=>M(e,"conversation_id")===t,v=40,_=1e5,J=e=>{const t=e.createdAt,s=e.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${s})`},Y=e=>{const t=F((e??[]).map(y)),s=(e??[]).length>=v,n=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:s,cursor:n}},re=(e,t)=>{const s=D(),n=O(e),[a,r]=u.useState(_),{pollWhenRealtimeDown:o,onRealtimeStatus:f,refetchOptions:w}=z(e),h=u.useRef(t);u.useEffect(()=>{h.current=t},[t]);const m=u.useRef({pages:0,total:0}),i=C({queryKey:n,enabled:!!e,initialPageParam:null,...w,staleTime:Q,queryFn:async({pageParam:c})=>{if(!e)return{items:[],hasMore:!1,cursor:null};let l=S.from("messages").select($).eq("conversation_id",e).order("created_at",{ascending:!1}).order("id",{ascending:!1});c&&(l=l.or(J(c)));const{data:g,error:p}=await l.limit(v);if(p)throw console.error(`[useConversationMessages] Failed to load ${c?"older messages":"messages"}`,p),new Error(p.message);return Y(g??[])},getNextPageParam:()=>{},getPreviousPageParam:c=>{if(c.hasMore)return c.cursor??void 0}});u.useEffect(()=>{const c=i.data?.pages??[],l=c.reduce((d,R)=>d+R.items.length,0),g=m.current;if(c.length===0){m.current={pages:0,total:0},r(_);return}if(g.pages===0){m.current={pages:c.length,total:l},r(_);return}const p=l-g.total,L=c.length-g.pages;p>0&&L>0&&r(d=>Math.max(0,d-p)),m.current={pages:c.length,total:l}},[i.data?.pages]);const P=u.useCallback(()=>{if(!e)return{};const c=(l,g)=>{const p=X(l);if(!Z(p,e)||!M(p,"id"))return;const d=p,R=y(d);s.setQueryData(n,T=>q(T,d,{allowAppend:g==="insert"})),g==="insert"?h.current?.onInsert?.(R):h.current?.onUpdate?.(R)};return{onStatus:f,onMessageInsert:l=>{c(l,"insert")},onMessageUpdate:l=>{c(l,"update")}}},[e,f,s,n]);x(e,P,[]),u.useEffect(()=>{r(_),m.current={pages:0,total:0}},[e]);const U=u.useMemo(()=>(i.data?.pages??[]).flatMap(l=>l.items),[i.data?.pages]),E=u.useCallback(async()=>{e&&i.hasPreviousPage&&await i.fetchPreviousPage()},[e,i]);return u.useMemo(()=>({data:U,dataUpdatedAt:i.dataUpdatedAt,isLoading:i.isLoading,isFetching:i.isFetching,isError:i.isError,error:i.error,refetch:i.refetch,loadOlder:E,hasMore:!!i.hasPreviousPage,isLoadingOlder:i.isFetchingPreviousPage,firstItemIndex:a,queryKey:n,pollWhenRealtimeDown:o}),[U,i.dataUpdatedAt,i.isLoading,i.isFetching,i.isError,i.error,i.refetch,E,i.hasPreviousPage,i.isFetchingPreviousPage,a,n,o])};export{se as S,M as a,ne as b,x as c,re as d,X as g,Z as h,z as u};
