import{u as F,r as a,h as z,s as T,af as D,j as e,z as q,ag as B,B as m,S as Q,l as R,t as $}from"./index-BhQyicj1.js";import{I as A}from"./input-C2o7XlDz.js";import{a as G,u as K}from"./useSearchTitles-Cf06ZDQ_.js";import{X as V}from"./x-mv29V4jj.js";import{C as x}from"./circle-check-DS0vQD7-.js";import{P as k}from"./plus-DLHoHRQq.js";function X(l){const n=l.posterUrl??(l.tmdbPosterPath?$(l.tmdbPosterPath,"w342"):null);return{id:l.mediaItemId,title:l.title??"Untitled",posterUrl:n}}function Y(l){return{id:l.id,title:l.title,posterUrl:l.posterUrl??null}}const C=5,se=()=>{const l=F(),n=a.useMemo(()=>z(),[]),[p,P]=a.useState(""),h=G(p,250),[I,U]=a.useState([]),[M,g]=a.useState(!0),[f,b]=a.useState(null),[c,j]=a.useState({}),i=Object.keys(c).length,[d,N]=a.useState(!1),[y,v]=a.useState(null),o=K({query:h,filters:{type:"all"}}),w=a.useMemo(()=>(o.data?.pages??[]).flatMap(t=>t.results??[]),[o.data]),S=a.useCallback(s=>{j(t=>{const r={...t};return r[s.id]?(delete r[s.id],r):{...r,[s.id]:s}})},[]),O=a.useCallback(s=>{j(t=>{const r={...t};return delete r[s],r})},[]),u=a.useCallback(async()=>{try{await T.auth.updateUser({data:{onboarded:!0}})}catch{}l("/swipe",{replace:!0})},[l]),E=a.useCallback(async()=>{v(null),N(!0);try{const s=Object.keys(c),t=await D({sessionId:n,mediaItemIds:s},{timeoutMs:45e3});if(!t.ok)throw new Error(t.message??"Onboarding failed");await u()}catch(s){console.error(s),v(s?.message??"Something went wrong")}finally{N(!1)}},[u,c,n]);return a.useEffect(()=>{let s=!1;return(async()=>{g(!0),b(null);try{const r=await R({sessionId:n,mode:"trending",limit:24,seed:`onb:${new Date().toISOString().slice(0,10)}`},{timeoutMs:3e4});if(s)return;const L=r.cards??[];U(L.map(X))}catch(r){console.error(r),s||b("Couldn’t load suggestions. You can still search below.")}finally{s||g(!1)}})(),()=>{s=!0}},[n]),d?e.jsx(q,{}):e.jsxs("div",{className:"mx-auto flex min-h-screen w-full max-w-5xl flex-col gap-6 px-4 py-10",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"type-heading text-foreground",children:"Pick a few titles you like"}),e.jsxs("p",{className:"type-body text-muted-foreground",children:["Choose at least ",C,". This helps MoviNesta personalize your “For you” deck immediately."]})]}),y&&e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:y}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"type-caption text-muted-foreground",children:"Selected:"}),i===0?e.jsx("span",{className:"type-caption text-foreground",children:"None yet"}):Object.values(c).slice(0,12).map(s=>e.jsx(B,{onClick:()=>O(s.id),children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3.5 w-3.5"}),s.title]})},s.id)),i>12&&e.jsxs("span",{className:"type-caption text-muted-foreground",children:["+",i-12," more"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(m,{onClick:E,disabled:i<C||d,className:"rounded-2xl",children:[e.jsx(x,{className:"mr-2 h-4 w-4"}),"Continue"]}),e.jsx(m,{variant:"ghost",onClick:u,className:"rounded-2xl",disabled:d,children:"Skip for now"})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"type-subheading text-foreground",children:"Popular picks"}),e.jsxs("span",{className:"type-caption text-muted-foreground",children:["Tap to ",i?"toggle":"select"]})]}),M?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"Loading suggestions…"})}):f?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-sm text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:f})}):e.jsx("div",{className:"grid grid-cols-2 gap-3",children:I.map(s=>{const t=!!c[s.id];return e.jsxs("button",{type:"button",onClick:()=>S(s),className:"group relative overflow-hidden rounded-2xl border border-border bg-card/60 text-left",children:[s.posterUrl?e.jsx("img",{src:s.posterUrl,alt:s.title,className:"h-44 w-full object-cover transition-transform group-hover:scale-[1.02]",loading:"lazy"}):e.jsx("div",{className:"flex h-44 w-full items-center justify-center text-xs text-muted-foreground",children:"No poster"}),e.jsx("div",{className:"p-2",children:e.jsx("div",{className:"line-clamp-2 type-caption font-medium text-foreground",children:s.title})}),e.jsx("div",{className:"absolute right-2 top-2 grid h-9 w-9 place-items-center rounded-full bg-background/80 shadow",children:t?e.jsx(x,{className:"h-4 w-4"}):e.jsx(k,{className:"h-4 w-4"})})]},s.id)})})]}),e.jsxs("section",{className:"space-y-3",children:[e.jsx("h2",{className:"type-subheading text-foreground",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(A,{value:p,onChange:s=>P(s.target.value),placeholder:"Search movies and series…",className:"pl-9"})]}),o.isLoading?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"Searching…"})}):h.trim().length>0&&w.length===0?e.jsx("div",{className:"rounded-2xl border border-border bg-card/50 p-4 text-muted-foreground",children:e.jsx("span",{className:"type-caption",children:"No results."})}):e.jsxs("div",{className:"space-y-2",children:[w.slice(0,20).map(s=>{const t=Y(s),r=!!c[t.id];return e.jsxs("button",{type:"button",onClick:()=>S(t),className:"soft-row-card soft-row-card-interactive flex w-full items-center gap-3 row-pad text-left",children:[t.posterUrl?e.jsx("img",{src:t.posterUrl,alt:t.title,className:"h-16 w-12 rounded-xl object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-16 w-12 items-center justify-center rounded-xl bg-background/60 text-xs text-muted-foreground",children:"—"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"truncate type-label text-foreground",children:t.title}),e.jsxs("div",{className:"type-caption text-muted-foreground",children:[s.type??"title"," ",typeof s.year=="number"?`• ${s.year}`:""]})]}),e.jsx("div",{className:"grid h-9 w-9 place-items-center rounded-full bg-background/80 shadow",children:r?e.jsx(x,{className:"h-4 w-4"}):e.jsx(k,{className:"h-4 w-4"})})]},s.id)}),o.hasNextPage&&e.jsx("div",{className:"pt-2",children:e.jsx(m,{variant:"ghost",className:"rounded-2xl",disabled:o.isFetchingNextPage,onClick:()=>o.fetchNextPage(),children:o.isFetchingNextPage?"Loading…":"Load more"})})]})]})]})};export{se as default};
