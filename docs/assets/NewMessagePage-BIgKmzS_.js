import{u as I,b as E,r,j as e,ap as c,n as F}from"./index-BhYCkKJ1.js";import{M as n}from"./material-icon-DzJ3uwwf.js";import{u as R}from"./useSearchPeople-DfdiF1dA.js";import{u as A}from"./useSuggestedPeople-AvbYDKYw.js";const D=()=>{const h=I(),{user:i}=E(),[f,k]=r.useState(""),[s,C]=r.useState([]),[g,p]=r.useState(!1),b=r.useRef(null),v=f.trim(),l=v.replace(/^@+/,""),{data:d=[],isLoading:P,isError:U}=A(),{data:m=[],isLoading:N,isFetching:M}=R(v),o=r.useMemo(()=>d.slice(0,5).map(t=>({id:t.id,displayName:t.displayName??t.username??"Unknown",subtitle:t.bio,avatarUrl:t.avatarUrl,matchLabel:typeof t.matchPercent=="number"&&t.matchPercent>0?`${t.matchPercent}% Match`:"Available"})),[d]),y=r.useMemo(()=>new Set(o.map(t=>t.id)),[o]),j=r.useMemo(()=>(l?m.map(a=>({id:a.id,displayName:a.displayName??a.username??"Unknown",subtitle:a.username?`@${a.username}`:null,avatarUrl:a.avatarUrl,matchLabel:typeof a.matchPercent=="number"&&a.matchPercent>0?`${a.matchPercent}% Match`:null})):d.map(a=>({id:a.id,displayName:a.displayName??a.username??"Unknown",subtitle:a.username?`@${a.username}`:null,avatarUrl:a.avatarUrl,matchLabel:typeof a.matchPercent=="number"&&a.matchPercent>0?`${a.matchPercent}% Match`:"Available"}))).filter(a=>!y.has(a.id)),[l,m,y,d]),w=t=>{C(a=>a.includes(t)?[]:[t])};r.useEffect(()=>{const t=window.setTimeout(()=>b.current?.focus(),50);return()=>window.clearTimeout(t)},[]);const u=r.useMemo(()=>i?.id?s.length===0?"Select 1 person to start chatting.":s.length>1?"Group chats are coming soon — select only 1 person.":s[0]===i.id?"You can't start a conversation with yourself.":null:"Sign in to start a conversation.",[s,i?.id]),x=!!i?.id&&s.length===1&&s[0]!==i?.id&&!g,S=async()=>{if(!i?.id){c.error("You need to be signed in to start a conversation.");return}if(s.length===0){c.show("Pick someone to start a chat.");return}if(s.length>1){c.show("Group chats are coming soon. Please select one person for now.");return}const t=s[0];if(i.id===t){c.show("You can't start a conversation with yourself.");return}p(!0);try{const a=await F("create-direct-conversation",{targetUserId:t},{timeoutMs:25e3});if(!a?.ok||!a.conversationId){const $=a?.error??"Failed to start the conversation.";throw new Error($)}h(`/messages/${a.conversationId}`)}catch(a){console.error("[NewMessagePage] Failed to start conversation",a),c.error(a instanceof Error?a.message:"Something went wrong while starting the conversation.")}finally{p(!1)}},L=l.length>=2&&!N&&m.length===0;return e.jsx("div",{className:"min-h-screen bg-background text-foreground",children:e.jsxs("div",{className:"mx-auto flex min-h-screen w-full max-w-md flex-col border-x border-border shadow-2xl shadow-black/10",children:[e.jsxs("div",{className:"sticky top-0 z-50 flex items-center justify-between border-b border-border bg-background/90 px-[var(--page-pad-x)] py-[var(--page-pad-y)] backdrop-blur-md",children:[e.jsx("button",{type:"button",onClick:()=>h(-1),className:"flex h-11 w-11 items-center justify-center rounded-full text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close",children:e.jsx(n,{name:"close",className:"text-[24px]"})}),e.jsx("h2",{className:"flex-1 text-center text-lg font-bold",children:"New Message"}),e.jsx("button",{type:"button",onClick:S,className:"flex min-h-11 items-center justify-center rounded-full bg-primary/10 px-4 py-2 text-sm font-bold text-primary transition-colors hover:bg-primary/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-70",disabled:!x,"aria-disabled":!x,children:g?"Starting":"Chat"})]}),e.jsxs("div",{className:"bg-background page-pad py-[var(--page-pad-y)]",children:[e.jsx("label",{htmlFor:"new-message-search",className:"flex h-12 w-full flex-col","aria-label":"Search contacts",children:e.jsxs("div",{className:"flex h-full flex-1 items-stretch rounded-xl border border-input bg-card shadow-sm",children:[e.jsx("div",{className:"flex items-center justify-center rounded-l-xl px-4 text-muted-foreground",children:e.jsx(n,{name:"search",className:"text-[24px]"})}),e.jsx("input",{id:"new-message-search",ref:b,className:"h-full w-full rounded-xl rounded-l-none border-none bg-transparent px-4 pl-2 text-base text-foreground placeholder:text-muted-foreground focus:outline-none",placeholder:"Search friends or username",value:f,onChange:t=>k(t.target.value),onKeyDown:t=>{t.key==="Enter"&&x&&(t.preventDefault(),S())}})]})}),u&&e.jsx("p",{className:"mt-2 text-xs font-medium text-muted-foreground",children:u}),!u&&s.length===1&&e.jsxs("p",{className:"mt-2 text-xs font-medium text-muted-foreground",children:["Ready to chat — press ",e.jsx("span",{className:"font-semibold text-foreground",children:"Chat"})]})]}),e.jsx("div",{className:"page-pad pt-4",children:e.jsxs("button",{type:"button",disabled:!0,className:"soft-row-card flex w-full items-center justify-between gap-4 row-pad min-h-11 text-left disabled:cursor-not-allowed disabled:opacity-60","aria-label":"Create a new group (coming soon)",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary shadow-sm",children:e.jsx(n,{name:"group_add",className:"text-[24px]"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-base font-medium",children:"Create a new group"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start a watch party"}),e.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground",children:"Coming soon"})]})]}),e.jsx(n,{name:"chevron_right",className:"text-[24px] text-muted-foreground"})]})}),e.jsx("div",{className:"page-pad pb-2 pt-4",children:e.jsx("h3",{className:"text-sm font-bold uppercase tracking-wider text-muted-foreground",children:"Suggested"})}),e.jsx("div",{className:"flex flex-col",children:P?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"Loading suggestions…"}):U?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"Couldn't load suggestions."}):o.length===0?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"No suggestions yet."}):e.jsx("div",{className:"page-pad flex flex-col gap-2",children:o.map(t=>{const a=`new-message-suggested-${t.id}`;return e.jsxs("label",{htmlFor:a,"aria-label":`Select ${t.displayName}`,className:"soft-row-card soft-row-card-interactive flex cursor-pointer items-center justify-between gap-4 row-pad min-h-11",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-4 overflow-hidden",children:[e.jsx("div",{className:"relative",children:e.jsx("div",{className:"h-12 w-12 overflow-hidden rounded-full bg-muted shadow-sm",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:t.displayName,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground",children:t.displayName.slice(0,1).toUpperCase()})})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-base font-medium",children:t.displayName}),t.matchLabel&&e.jsx("span",{className:"text-sm font-semibold text-primary",children:t.matchLabel})]}),t.subtitle&&e.jsx("p",{className:"mt-1 truncate text-sm text-muted-foreground",children:t.subtitle})]})]}),e.jsx("div",{className:"pl-4",children:e.jsxs("div",{className:"relative flex h-7 w-7 items-center justify-center",children:[e.jsx("input",{id:a,type:"checkbox",checked:s.includes(t.id),onChange:()=>w(t.id),className:"h-6 w-6 cursor-pointer appearance-none rounded-full border-2 border-border bg-transparent checked:border-primary checked:bg-primary"}),e.jsx(n,{name:"check",className:`absolute text-[16px] text-primary-foreground transition-opacity ${s.includes(t.id)?"opacity-100":"opacity-0"}`})]})})]},t.id)})})}),e.jsx("div",{className:"page-pad pb-2 pt-6",children:e.jsx("h3",{className:"text-sm font-bold uppercase tracking-wider text-muted-foreground",children:l?"Search results":"All Contacts"})}),e.jsx("div",{className:"flex flex-col pb-20",children:l&&l.length<2?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"Type at least 2 characters to search."}):l&&(N||M)?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"Searching…"}):L?e.jsxs("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:["No results for"," ",e.jsx("span",{className:"font-semibold text-foreground",children:l})]}):j.length===0?e.jsx("div",{className:"page-pad py-4 text-sm text-muted-foreground",children:"No contacts found."}):e.jsx("div",{className:"page-pad flex flex-col gap-2",children:j.map(t=>{const a=`new-message-contact-${t.id}`;return e.jsxs("label",{htmlFor:a,"aria-label":`Select ${t.displayName}`,className:"soft-row-card soft-row-card-interactive flex cursor-pointer items-center justify-between gap-4 row-pad min-h-11",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-4 overflow-hidden",children:[e.jsx("div",{className:"h-12 w-12 overflow-hidden rounded-full bg-muted shadow-sm",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:t.displayName,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground",children:t.displayName.slice(0,1).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-base font-medium",children:t.displayName}),t.matchLabel&&e.jsx("span",{className:"text-sm font-semibold text-primary",children:t.matchLabel})]}),t.subtitle&&e.jsx("p",{className:"mt-1 truncate text-sm text-muted-foreground",children:t.subtitle})]})]}),e.jsx("div",{className:"pl-4",children:e.jsxs("div",{className:"relative flex h-7 w-7 items-center justify-center",children:[e.jsx("input",{id:a,type:"checkbox",checked:s.includes(t.id),onChange:()=>w(t.id),className:"h-6 w-6 cursor-pointer appearance-none rounded-full border-2 border-border bg-transparent checked:border-primary checked:bg-primary"}),e.jsx(n,{name:"check",className:`absolute text-[16px] text-primary-foreground transition-opacity ${s.includes(t.id)?"opacity-100":"opacity-0"}`})]})})]},t.id)})})})]})})};export{D as default};
