import{u as oe,J as de,e as ce,b as ue,R as N,c as q,x as te,h as $,G as R,t as B,j as e,B as me,L as ae,F as fe,q as v,s as j,D as xe}from"./index-n01z0Q-I.js";import{S as y,R as re}from"./skeleton-BoUU6iSb.js";import{M as h}from"./material-icon-ik9c9RPC.js";import{V as be}from"./VerifiedBadge-BK7Fjn_d.js";import{b as he,u as ge}from"./useDiaryLibrary-CAOnuwIC.js";import{i as pe}from"./catalogSync-i5cCA8pA.js";const ie=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/,A=t=>typeof t!="string"?!1:ie.test(t),ye=t=>{if(!t||ie.test(t)||!t.startsWith("tmdb-")&&!t.startsWith("tv-"))return null;const a=Number(t.replace(/^tmdb-/,"").replace(/^tv-/,""));return Number.isFinite(a)?{tmdbId:a,contentType:t.startsWith("tv-")?"series":"movie"}:null},_e=async(t,a)=>{if(!t)return null;if(A(t))return t;const i=ye(t);if(!i)return null;const n=await a(i);return n?.ok&&A(n.media_item_id)?n.media_item_id:null};function ve(t){try{return Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1}).format(t)}catch{return String(t)}}function je(t){if(!t||t<=0)return null;const a=Math.floor(t/60),i=t%60;return a<=0?`${i}m`:i<=0?`${a}h`:`${a}h ${i}m`}function we(t){const a=t.tmdb_release_date??t.tmdb_first_air_date;if(a){const i=String(a),n=Number(i.slice(0,4));if(!Number.isNaN(n))return n}if(t.omdb_year){const i=Number(String(t.omdb_year).slice(0,4));if(!Number.isNaN(i))return i}return null}function Ne(t){return[t.tmdb_title,t.tmdb_name,t.omdb_title].map(n=>typeof n=="string"?n.trim():"").find(n=>!!n)||"Untitled"}function ke(t){return t.tmdb_overview??t.omdb_plot??null}function Se(t){return t.kind==="movie"?"movie":t.kind==="series"?"series":t.kind==="anime"?"anime":t.kind==="episode"?"episode":"other"}function Te(t,a){const i=[];if(Array.isArray(t))for(const n of t){const d=n?.name;typeof d=="string"&&d.trim()&&i.push(d.trim())}if(!i.length&&a)for(const n of String(a).split(",").map(d=>d.trim()).filter(Boolean))i.push(n);return Array.from(new Set(i))}function Ie(t){const a=t?.videos?.results;if(!Array.isArray(a))return null;const i=a,n=u=>i.find(m=>u(m)&&m.site==="YouTube"&&typeof m.key=="string"),d=n(u=>u.type==="Trailer")||n(u=>u.type==="Teaser")||n(()=>!0);return d?.key?`https://www.youtube.com/watch?v=${encodeURIComponent(d.key)}`:null}function Fe(t){const a=t?.credits?.cast;return Array.isArray(a)?a.filter(i=>i&&typeof i=="object").slice(0,24).map(i=>({id:i.id,name:i.name,character:i.character,profile_path:i.profile_path})):[]}function qe(t){const a=t.trim().split(/\s+/g);return a.length<=1?t:`${a[0]} ${a[1].slice(0,1)}.`}function Re(t){const a=new Date(t),i=Date.now(),n=Math.max(0,i-a.getTime()),d=Math.floor(n/6e4);if(d<1)return"Just now";if(d<60)return`${d}m ago`;const u=Math.floor(d/60);if(u<24)return`${u}h ago`;const m=Math.floor(u/24);if(m<7)return`${m}d ago`;const s=Math.floor(m/7);if(s<5)return`${s}w ago`;const g=Math.floor(m/30);return g<12?`${g}mo ago`:`${Math.floor(m/365)}y ago`}function Ae({review:t,profile:a}){const[i,n]=N.useState(!1),d=(a?.display_name??a?.username??"?").split(/\s+/g).slice(0,2).map(g=>g.slice(0,1).toUpperCase()).join("").slice(0,2),u=t.rating==null?null:xe(t.rating),s=!!!t.spoiler||i;return e.jsxs("div",{className:"rounded-2xl border border-border bg-card/70 card-pad transition-colors hover:bg-card/90",children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[a?.avatar_url?e.jsx("img",{src:a.avatar_url,alt:a.display_name??a.username??"User",className:"size-10 rounded-full object-cover"}):e.jsx("div",{className:"flex size-10 items-center justify-center rounded-full bg-primary/20 font-bold text-primary",children:d}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:a?.display_name??a?.username??"User"}),a?.is_verified?e.jsx(be,{isVerified:a?.is_verified??null,type:a.verified_type??null,label:a.verified_label??null,verifiedAt:a.verified_at??null,org:a.verified_by_org??null}):null]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Re(t.created_at)})]})]}),u!=null?e.jsxs("div",{className:"flex items-center gap-1 rounded-lg border border-border/60 bg-background/60 px-2 py-1",children:[e.jsx(h,{name:"star",className:"text-sm text-yellow-500",filled:!0}),e.jsx("span",{className:"text-xs font-semibold text-foreground",children:u.toFixed(1)})]}):null]}),t.headline?e.jsx("p",{className:"mb-2 text-sm font-semibold text-foreground",children:t.headline}):null,t.body?s?e.jsx("p",{className:"text-sm leading-relaxed text-muted-foreground",children:t.body}):e.jsxs("div",{className:"rounded-xl border border-border bg-muted/40 p-3 text-sm text-muted-foreground",children:[e.jsx("p",{children:"Spoiler warning"}),e.jsxs("button",{type:"button",className:"mt-2 inline-flex items-center gap-2 text-sm font-semibold text-primary",onClick:()=>n(!0),"aria-expanded":i,children:["View spoiler",e.jsx(h,{name:"chevron_right",className:"text-base"})]})]}):null]})}function se(){return e.jsx("div",{className:"full-bleed h-px bg-border/60"})}function D({children:t,label:a,onClick:i,isActive:n,disabled:d}){return e.jsx("button",{type:"button","aria-label":a,disabled:d,onClick:i,className:"flex size-11 items-center justify-center rounded-full border border-white/10 bg-white/10 text-white backdrop-blur-md transition "+(d?"opacity-60":"hover:bg-white/20 active:scale-[0.98]")+(n?" ring-2 ring-primary/70":""),children:t})}function ze(){const t=oe(),a=de(),i=ce(),{user:n}=ue(),d=String(a.titleId??""),[u,m]=N.useState(null);N.useEffect(()=>{let r=!1;return(async()=>{if(!d){m(null);return}if(A(d)){m(d);return}let l=null;try{l=await _e(d,async b=>{const f=await fe("catalog-sync",b);return pe(f)?f:null})}catch(b){console.warn("[TitleDetailPageV2] catalog-sync failed",b)}r||(m(l),l&&t(`/title/${l}`,{replace:!0}))})(),()=>{r=!0}},[t,d]);const s=u??(A(d)?d:null),g=q({queryKey:v.titleDetail(s),enabled:!!s,staleTime:1e3*60,queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await j.from("media_items").select(["id","kind","tmdb_title","tmdb_name","tmdb_release_date","tmdb_first_air_date","tmdb_runtime","tmdb_poster_path","tmdb_backdrop_path","tmdb_genres","tmdb_tagline","tmdb_overview","tmdb_raw","omdb_title","omdb_year","omdb_rated","omdb_runtime","omdb_plot","omdb_genre"].join(",")).eq("id",s).maybeSingle();if(o&&o.code!=="PGRST116")throw o;return r??null}}),x=q({queryKey:["title","rating-summary",s],enabled:!!s,staleTime:1e3*60,queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await j.rpc("get_title_rating_summary_v1",{p_title_id:s});if(o)return console.warn("[TitleDetailPageV2] rating summary RPC error",o.message),null;const l=Array.isArray(r)?r[0]:r;return l?{title_id:String(l.title_id??s),reviews_count:Number(l.reviews_count??0),ratings_count:Number(l.ratings_count??0),average_rating_0_10:l.average_rating_0_10==null?null:Number(l.average_rating_0_10),average_rating_0_5:l.average_rating_0_5==null?null:Number(l.average_rating_0_5),stars_5:Number(l.stars_5??0),stars_4:Number(l.stars_4??0),stars_3:Number(l.stars_3??0),stars_2:Number(l.stars_2??0),stars_1:Number(l.stars_1??0)}:null}}),w=q({queryKey:["title","reviews-preview",s],enabled:!!s,staleTime:1e3*30,queryFn:async()=>{if(!s)return{reviews:[],profilesById:new Map};const{data:r,error:o}=await j.from("reviews").select("id,user_id,title_id,rating,headline,body,spoiler,created_at").eq("title_id",s).order("created_at",{ascending:!1}).limit(2);if(o)throw o;const l=r??[],b=Array.from(new Set(l.map(p=>p.user_id).filter(Boolean))),f=new Map;if(b.length){const{data:p,error:Z}=await j.from("profiles_public").select("id,username,display_name,avatar_url,is_verified,verified_type,verified_label,verified_at,verified_by_org").in("id",b);if(Z)console.warn("[TitleDetailPageV2] profile lookup failed",Z.message);else for(const ee of p??[])f.set(ee.id,ee)}return{reviews:l,profilesById:f}}}),L=he(s),ne=ge(),k=L.data?.status??null,C=L.data?.rating??null,_=q({queryKey:["media_feedback",n?.id,s],enabled:!!(n?.id&&s),staleTime:1e3*15,queryFn:async()=>{if(!n?.id||!s)return null;const{data:r,error:o}=await j.from("media_feedback").select("last_action").eq("user_id",n.id).eq("media_item_id",s).maybeSingle();if(o&&o.code!=="PGRST116")throw o;return r??null}}).data?.last_action==="like",P=te({mutationFn:async()=>{if(!s)return;if(!n?.id){alert("Sign in to like this title.");return}await i.cancelQueries({queryKey:["media_feedback",n?.id,s]}),i.setQueryData(["media_feedback",n?.id,s],o=>({...o??{},last_action:_?"skip":"like"}));const r=$();await R({sessionId:r,deckId:null,position:null,mediaItemId:s,eventType:_?"skip":"like",source:"title",payload:{action:_?"unlike":"like",origin:"title_detail"}})},onSettled:()=>{i.invalidateQueries({queryKey:["media_feedback",n?.id,s]})}}),Q=te({mutationFn:async()=>{if(!n?.id||!s){n?.id||alert("Sign in to add this title to your watchlist.");return}const r=g.data;if(!r)return;const o=Se(r),l=k!=="want_to_watch";i.setQueryData(v.titleDiary(n.id,s),p=>({...p??{},status:l?"want_to_watch":null}));const b=$(),f=[];f.push(R({sessionId:b,deckId:null,position:null,mediaItemId:s,eventType:"watchlist",inWatchlist:l,source:"title",payload:{action:l?"watchlist_add":"watchlist_remove",origin:"title_detail"}})),l?f.push(ne.updateStatus.mutateAsync({titleId:s,status:"want_to_watch",type:o})):f.push(Promise.resolve(j.from("library_entries").delete().eq("user_id",n.id).eq("title_id",s)).then(({error:p})=>{if(p)throw p})),await Promise.allSettled(f)},onSettled:()=>{n?.id&&(i.invalidateQueries({queryKey:v.titleDiary(n.id,s??void 0)}),i.invalidateQueries({queryKey:v.diaryLibrary(n.id)}),i.invalidateQueries({queryKey:v.diaryStats(n.id)}),i.invalidateQueries({queryKey:v.homeFeed(n.id)}))}}),le=async()=>{if(typeof window>"u")return;const r=window.location.href,o=V||"MoviNesta";try{navigator.share?await navigator.share({title:o,url:r}):navigator.clipboard&&await navigator.clipboard.writeText(r)}catch{}};N.useEffect(()=>{if(!s)return;const r=$();return R({sessionId:r,deckId:null,position:null,mediaItemId:s,eventType:"detail_open",source:"title",payload:{origin:"title_detail"}}).catch(()=>null),()=>{R({sessionId:r,deckId:null,position:null,mediaItemId:s,eventType:"detail_close",source:"title",payload:{origin:"title_detail"}}).catch(()=>null)}},[s]);const c=g.data,z=B(c?.tmdb_backdrop_path??null,"w1280")??null,U=B(c?.tmdb_poster_path??null,"w500")??null,M=c?we(c):null,S=c?je(c.tmdb_runtime??null):null,T=c?.omdb_rated??null,V=c?Ne(c):"",K=c?.tmdb_tagline??null,E=c?ke(c):null,W=c?Te(c.tmdb_genres,c.omdb_genre):[],Y=Ie(c?.tmdb_raw)??null,G=Fe(c?.tmdb_raw),J=x.data?.average_rating_0_5??null,I=J==null?null:Math.max(0,Math.min(5,J)),O=x.data?.ratings_count??0,H=(I==null?null:I.toFixed(1))??"–",F=x.data?[{star:5,count:x.data.stars_5},{star:4,count:x.data.stars_4},{star:3,count:x.data.stars_3},{star:2,count:x.data.stars_2},{star:1,count:x.data.stars_1}]:null,X=F?F.reduce((r,o)=>r+o.count,0):0;return e.jsxs("div",{className:"relative flex min-h-[calc(100dvh-(5.5rem+env(safe-area-inset-bottom)))] flex-col overflow-hidden",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[-1rem] h-[65vh]",children:[e.jsx("div",{className:"h-full w-full bg-cover bg-center bg-no-repeat",style:{backgroundImage:z?`url(${z})`:U?`url(${U})`:void 0}}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/40 via-black/10 to-background"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/60 to-transparent"})]}),e.jsxs("div",{className:"fixed top-0 z-30 full-bleed flex w-full items-center justify-between bg-gradient-to-b from-black/60 to-transparent px-[var(--page-pad-x)] pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)]",children:[e.jsx(D,{label:"Back",onClick:()=>t(-1),children:e.jsx(h,{name:"arrow_back"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{label:_?"Liked":"Like",isActive:_,disabled:!s||P.isPending,onClick:()=>P.mutate(),children:e.jsx(h,{name:"favorite",filled:_})}),e.jsx(D,{label:"More",onClick:()=>{},disabled:!0,children:e.jsx(h,{name:"more_vert"})})]})]}),e.jsxs("main",{className:"relative z-10 mt-[45vh] px-0 pb-20",children:[e.jsxs("div",{className:"flex flex-col items-center px-[var(--page-pad-x)] text-center",children:[e.jsxs("div",{className:"mb-4 relative group",children:[e.jsx("div",{className:"absolute -inset-1 rounded-full bg-primary blur opacity-40 transition duration-200 group-hover:opacity-60"}),e.jsx("div",{className:"relative flex size-16 items-center justify-center rounded-full border-2 border-primary bg-black/35",children:x.isLoading?e.jsx(y,{className:"h-6 w-10 rounded"}):e.jsx("span",{className:"text-lg font-semibold text-foreground",children:H})})]}),e.jsx("h1",{className:"mb-2 text-balance text-4xl font-bold leading-tight tracking-tight text-white",children:g.isLoading?e.jsx(y,{className:"h-10 w-64"}):V}),K?e.jsx("p",{className:"mb-3 text-sm text-white/75",children:K}):null,e.jsxs("div",{className:"mb-6 flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-sm font-medium text-white/70",children:[M!=null&&e.jsx("span",{children:M}),M!=null&&(S||T)&&e.jsx("span",{className:"size-1 rounded-full bg-white/30"}),S&&e.jsx("span",{children:S}),S&&T&&e.jsx("span",{className:"size-1 rounded-full bg-white/30"}),T&&e.jsx("span",{children:T})]}),W.length?e.jsx("div",{className:"mb-8 flex flex-wrap justify-center gap-2",children:W.slice(0,3).map(r=>e.jsx("div",{className:"flex h-8 items-center justify-center rounded-full border border-white/5 bg-white/10 px-3 backdrop-blur-sm",children:e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-white",children:r})},r))}):null,e.jsxs("div",{className:"w-full max-w-sm",children:[e.jsxs("div",{className:"flex gap-3",children:[Y?e.jsxs("a",{href:Y,target:"_blank",rel:"noreferrer",className:"flex h-14 flex-1 items-center justify-center gap-2 rounded-full bg-primary text-base font-bold text-white shadow-lg shadow-primary/25 transition-all hover:bg-primary/90 active:scale-[0.98]",children:[e.jsx(h,{name:"play_circle"}),"Play Trailer"]}):e.jsx(me,{variant:"secondary",className:"h-14 flex-1 rounded-full bg-white/10 text-white hover:bg-white/15",disabled:!0,children:"Trailer unavailable"}),e.jsx("button",{type:"button","aria-label":k==="want_to_watch"?"Remove from watchlist":"Add to watchlist",onClick:()=>Q.mutate(),disabled:!s||!c||Q.isPending,className:"flex size-14 items-center justify-center rounded-full border border-white/10 bg-black/30 text-white backdrop-blur-sm transition-all hover:bg-black/40 active:scale-[0.98] "+(k==="want_to_watch"?" ring-2 ring-primary/70":""),children:e.jsx(h,{name:"bookmark_add",filled:k==="want_to_watch"})}),e.jsx("button",{type:"button","aria-label":"Share",onClick:le,className:"flex size-14 items-center justify-center rounded-full border border-white/10 bg-black/30 text-white backdrop-blur-sm transition-all hover:bg-black/40 active:scale-[0.98]",children:e.jsx(h,{name:"ios_share"})})]}),C!=null?e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-2 text-xs text-white/70",children:[e.jsx("span",{children:"Your rating"}),e.jsx(re,{rating:C,size:12}),e.jsxs("span",{className:"font-semibold text-white",children:[C.toFixed(1),"/5"]})]}):null]})]}),E?e.jsxs("section",{className:"px-[var(--page-pad-x)] pt-8",children:[e.jsx("h3",{className:"mb-3 px-1 text-lg font-bold text-white",children:"Storyline"}),e.jsx("p",{className:"px-1 text-base leading-relaxed text-white/75",children:E})]}):null,e.jsx("div",{className:"my-8",children:e.jsx(se,{})}),G.length?e.jsxs("section",{className:"px-[var(--page-pad-x)]",children:[e.jsxs("div",{className:"mb-4 flex items-end justify-between px-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Cast & Crew"}),e.jsx("button",{type:"button",className:"text-sm font-semibold text-primary",onClick:()=>{document.getElementById("mn-cast-scroll")?.scrollIntoView({behavior:"smooth",block:"nearest"})},children:"See all"})]}),e.jsx("div",{id:"mn-cast-scroll",className:"full-bleed flex snap-x gap-3 overflow-x-auto px-[var(--page-pad-x)] pb-3 [scrollbar-width:none] [&::-webkit-scrollbar]:hidden",children:G.slice(0,12).map((r,o)=>{const l=typeof r.name=="string"?r.name:"",b=typeof r.character=="string"?r.character:"",f=B(r.profile_path??null,"w185");return e.jsxs("div",{className:"flex shrink-0 snap-start flex-col items-center gap-2",children:[e.jsx("div",{className:"size-20 overflow-hidden rounded-full bg-muted/60",children:f?e.jsx("img",{src:f,alt:l,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-muted-foreground",children:e.jsx(h,{name:"person"})})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-foreground",children:l?qe(l):""}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:b})]})]},`${r.id??o}`)})})]}):null,e.jsx("div",{className:"my-8",children:e.jsx(se,{})}),e.jsxs("section",{className:"full-bleed mt-2 rounded-t-3xl border-t border-border/60 bg-background px-[var(--page-pad-x)] py-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Ratings & Reviews"}),s?e.jsx(ae,{to:`/title/${s}/reviews`,className:"text-sm font-semibold text-primary",children:"See all"}):null]}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-6",children:[e.jsxs("div",{className:"flex flex-col justify-center gap-1",children:[e.jsx("p",{className:"text-5xl font-black leading-none tracking-tight text-foreground",children:H}),e.jsx("div",{className:"mt-1",children:I!=null?e.jsx(re,{rating:I,size:14}):e.jsx("div",{className:"h-4 w-24"})}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:x.isLoading?"Loading…":O?`${ve(O)} verified ratings`:"No ratings yet"})]}),e.jsx("div",{className:"min-w-[220px] flex-1",children:F?e.jsx("div",{className:"grid grid-cols-[12px_1fr_38px] items-center gap-x-3 gap-y-2",children:F.map(r=>{const o=X?Math.round(r.count/X*100):0;return e.jsxs(N.Fragment,{children:[e.jsx("p",{className:"text-xs font-medium text-foreground",children:r.star}),e.jsx("div",{className:"flex h-1.5 flex-1 overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"rounded-full bg-primary",style:{width:`${o}%`,opacity:.2+r.star/5*.8}})}),e.jsxs("p",{className:"text-right text-xs text-muted-foreground",children:[o,"%"]})]},r.star)})}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(y,{className:"h-2 w-full"}),e.jsx(y,{className:"h-2 w-5/6"}),e.jsx(y,{className:"h-2 w-4/6"})]})})]}),e.jsxs("div",{className:"mt-8 flex flex-col gap-4",children:[w.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"h-24 w-full rounded-2xl"}),e.jsx(y,{className:"h-24 w-full rounded-2xl"})]}):w.data?.reviews?.map(r=>e.jsx(Ae,{review:r,profile:w.data?.profilesById.get(r.user_id)??null},r.id)),!w.isLoading&&(w.data?.reviews?.length??0)===0?e.jsx("div",{className:"rounded-2xl border border-border bg-card/70 card-pad text-sm text-muted-foreground",children:"No reviews yet. Be the first to rate and review this title."}):null]}),s?e.jsx("div",{className:"mt-6",children:e.jsxs(ae,{to:`/title/${s}/reviews`,className:"inline-flex items-center gap-2 text-sm font-semibold text-primary",children:["View all reviews",e.jsx(h,{name:"chevron_right",className:"text-base"})]})}):null]})]}),e.jsx("div",{className:"pointer-events-none fixed bottom-0 left-0 h-12 w-full bg-gradient-to-t from-background to-transparent"})]})}export{ze as default};
