import{A as re,s as A,r as i,e as q,K as rs,U as me,V as fe,b as ge,c as _e,W as as,X as Ge,Y as os,Z as is,o as ls,_ as We,n as cs,$ as ds,a0 as us,a1 as fs,a2 as ms,a3 as gs,R as ne,j as n,i as ps,N as z,B as U,G as hs,u as xs,z as ys,L as bs}from"./index-CuXsBKB-.js";import{m as pe,a as vs,M as Te,s as ws,i as Je,b as Ye,c as Xe,d as Ze,e as Rs,n as Ms,f as et,r as tt,g as st,h as js,C as Ss,j as Ns,P as Cs,k as Is,l as Es,S as ks,T as _s,u as Ts,o as Ds,p as Ls,q as As}from"./scroll-area-r9AxqKKe.js";import{u as De}from"./useMutation-BhCO-uzT.js";import{Y as Bs}from"./index-CWZRzMY7.js";import{B as Fs}from"./bell-_rM7l6aO.js";import{T as nt}from"./textarea-DKilsuq-.js";import{C as Us}from"./circle-alert-DXzvu6sN.js";import{D as rt,a as at,b as ot,c as it,d as lt,e as ct}from"./dialog-KsRlRjfX.js";import{M as Ce}from"./material-icon-sbzzvxfS.js";import"./format-BXv9LLlt.js";import"./index-C7UQl0qe.js";import"./index-BxBFM2Tt.js";import"./index-Bj6QaD0p.js";const Ps=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Os=re("arrow-down",Ps);const qs=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],$s=re("camera",qs);const Hs=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ks=re("send",Hs);const zs=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Qs=re("shield-x",zs);const Gs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Ws=re("smile",Gs),ke=new Map,Vs=e=>{const t=ke.get(e);if(t)return t;const s=A.channel(`conversation-db-${e}`),r={conversationId:e,channel:s,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.messageInsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.messageUpdateListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},a=>{const o=a;for(const l of r.reactionDeleteListeners)l(o)}),s.subscribe(a=>{const o=a;r.lastStatus=o;for(const l of r.statusListeners)l(o)}),ke.set(e,r),r},Js=(e,t)=>{const s=Vs(e);s.refCount+=1;const r=[];return t.onStatus&&(s.statusListeners.add(t.onStatus),r.push(()=>s.statusListeners.delete(t.onStatus)),s.lastStatus&&t.onStatus(s.lastStatus)),t.onMessageInsert&&(s.messageInsertListeners.add(t.onMessageInsert),r.push(()=>s.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(s.messageUpdateListeners.add(t.onMessageUpdate),r.push(()=>s.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(s.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),r.push(()=>s.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(s.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),r.push(()=>s.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(s.reactionUpsertListeners.add(t.onReactionUpsert),r.push(()=>s.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(s.reactionDeleteListeners.add(t.onReactionDelete),r.push(()=>s.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const a of r)a();if(s.refCount-=1,s.refCount<=0){try{A.removeChannel(s.channel)}catch{}ke.delete(e)}}},he=(e,t,s)=>{i.useEffect(()=>{if(e)return Js(e,t())},[e,t,...s])},Ys=2e3,Xs=15e3,Zs=e=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:e?Ys:!1,refetchIntervalInBackground:!1}),en=new Set(["SUBSCRIBED"]),tn=e=>!en.has(e),sn=e=>{const[t,s]=i.useState(!1),r=i.useRef(e);i.useEffect(()=>{Object.is(r.current,e)||(r.current=e,s(!1))},[e]);const a=i.useCallback(o=>{const l=tn(o);s(f=>f===l?f:l)},[]);return{pollWhenRealtimeDown:t,onStatus:a}},xe=e=>{const{pollWhenRealtimeDown:t,onStatus:s}=sn(e);return{pollWhenRealtimeDown:t,onRealtimeStatus:s,refetchOptions:Zs(t)}},nn=e=>typeof e=="object"&&e!==null,dt=e=>e.new,rn=e=>e.old,Y=(e,t)=>{if(!nn(e))return null;const s=e[t];return typeof s=="string"?s:null},ut=(e,t)=>Y(e,"conversation_id")===t,ft=40,ue=1e5,an=e=>{const t=e.createdAt,s=e.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${s})`},on=e=>{const t=ws((e??[]).map(pe)),s=(e??[]).length>=ft,r=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:s,cursor:r}},ln=(e,t)=>{const s=q(),r=me(e),[a,o]=i.useState(ue),{pollWhenRealtimeDown:l,onRealtimeStatus:f,refetchOptions:c}=xe(e),m=i.useRef(t);i.useEffect(()=>{m.current=t},[t]);const y=i.useRef({pages:0,total:0}),h=rs({queryKey:r,enabled:!!e,initialPageParam:null,...c,staleTime:Xs,queryFn:async({pageParam:g})=>{if(!e)return{items:[],hasMore:!1,cursor:null};let p=A.from("messages").select(Te).eq("conversation_id",e).order("created_at",{ascending:!1}).order("id",{ascending:!1});g&&(p=p.or(an(g)));const{data:w,error:M}=await p.limit(ft);if(M)throw console.error(`[useConversationMessages] Failed to load ${g?"older messages":"messages"}`,M),new Error(M.message);return on(w??[])},getNextPageParam:()=>{},getPreviousPageParam:g=>{if(g.hasMore)return g.cursor??void 0}});i.useEffect(()=>{const g=h.data?.pages??[],p=g.reduce((E,v)=>E+v.items.length,0),w=y.current;if(g.length===0){y.current={pages:0,total:0},o(ue);return}if(w.pages===0){y.current={pages:g.length,total:p},o(ue);return}const M=p-w.total,N=g.length-w.pages;M>0&&N>0&&o(E=>Math.max(0,E-M)),y.current={pages:g.length,total:p}},[h.data?.pages]);const b=i.useCallback(()=>{if(!e)return{};const g=(p,w)=>{const M=dt(p);if(!ut(M,e)||!Y(M,"id"))return;const E=M,v=pe(E);s.setQueryData(r,C=>vs(C,E)),w==="insert"?m.current?.onInsert?.(v):m.current?.onUpdate?.(v)};return{onStatus:f,onMessageInsert:p=>{g(p,"insert")},onMessageUpdate:p=>{g(p,"update")}}},[e,f,s,r]);he(e,b,[]),i.useEffect(()=>{o(ue),y.current={pages:0,total:0}},[e]);const d=i.useMemo(()=>(h.data?.pages??[]).flatMap(p=>p.items),[h.data?.pages]),u=i.useCallback(async()=>{e&&h.hasPreviousPage&&await h.fetchPreviousPage()},[e,h]);return i.useMemo(()=>({data:d,isLoading:h.isLoading,isFetching:h.isFetching,isError:h.isError,error:h.error,refetch:h.refetch,loadOlder:u,hasMore:!!h.hasPreviousPage,isLoadingOlder:h.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:l}),[d,h.isLoading,h.isFetching,h.isError,h.error,h.refetch,u,h.hasPreviousPage,h.isFetchingPreviousPage,a,r,l])};function cn(e){const{conversation:t,deliveryReceipts:s,readReceipts:r,currentUserId:a,failedMessages:o,onlyMessageIds:l,messageCreatedAtMsById:f}=e;if(!t||!a)return()=>null;const c=t.participants.filter(d=>!d.isSelf);if(c.length===0)return()=>null;const m=new Set(c.map(d=>d.id)),y=d=>{if(!d)return null;const u=f?.get(d);return u??null},h=new Map;for(const d of r??[]){let u=null;if(d.lastReadMessageId){const p=y(d.lastReadMessageId);p!=null&&(u=p)}if(u==null&&d.lastReadAt){const p=new Date(d.lastReadAt).getTime();Number.isNaN(p)||(u=p)}if(u==null)continue;const g=h.get(d.userId);(g==null||u>g)&&h.set(d.userId,u)}const b=new Map;for(const d of s??[]){if(!m.has(d.userId)||l&&!l.has(d.messageId))continue;let u=b.get(d.messageId);u||(u=new Set,b.set(d.messageId,u)),u.add(d.userId)}return d=>{if(d.senderId!==a)return null;if(o[d.id])return{status:"failed"};if(Je(d.id))return{status:"sending"};const u=(()=>{const M=new Date(d.createdAt??"").getTime();return Number.isNaN(M)?0:M})();let g=0,p=null;for(const M of c){const N=h.get(M.id);N!=null&&N>=u&&(g+=1,(p===null||N>p)&&(p=N))}return g===c.length&&c.length>0?{status:"seen",seenAt:p!=null?new Date(p).toISOString():null}:(b.get(d.id)?.size??0)===c.length&&c.length>0?{status:"delivered"}:{status:"sent"}}}function dn(e){const{messages:t,conversation:s,currentUserId:r,participantsById:a,reactionsByMessageId:o,hiddenMessageIds:l,deliveryReceipts:f,readReceipts:c,failedMessages:m,lastOwnMessageId:y}=e,h=i.useMemo(()=>{if(!t)return[];const d=new Set;y&&d.add(y);for(const p of Object.keys(m))d.add(p);const u=new Map;for(const p of t){const w=new Date(p.createdAt??"").getTime();Number.isNaN(w)||u.set(p.id,w)}const g=cn({conversation:s??null,deliveryReceipts:f,readReceipts:c,currentUserId:r,failedMessages:m,onlyMessageIds:d,messageCreatedAtMsById:u});return t.map(p=>{const w=fe(p.body),M=a.get(p.senderId)??null,N=M?.isSelf??(r!=null&&p.senderId===r),E=N&&d.has(p.id)?g(p):null,v=!!E&&N&&!w.deleted&&(E.status==="failed"||y===p.id);return{message:p,meta:w,sender:M,isSelf:N,deliveryStatus:E,showDeliveryStatus:v,reactions:o.get(p.id)??[]}})},[s,r,f,m,y,t,a,o,c]),b=i.useMemo(()=>h.filter(({message:d})=>!l[d.id]),[h,l]);return{uiMessages:h,visibleMessages:b}}function un(e){const{messages:t,currentUserId:s,hiddenMessageIds:r}=e;return i.useMemo(()=>{if(!t||!s)return null;for(let a=t.length-1;a>=0;a-=1){const o=t[a];if(!(r[o.id]||o.senderId!==s||fe(o.body).deleted))return o.id}return null},[r,t,s])}const fn=async e=>{const{data:t,error:s}=await A.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",e).order("last_read_at",{ascending:!1}).returns();if(s)throw console.error("[useConversationReadReceipts] Failed to load",s),new Error(s.message);return(t??[]).map(Xe)},mn=async(e,t)=>{if(t.length===0)return[];const s=A.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",e).in("message_id",t),{data:r,error:a}=await s.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(r??[]).map(Ze)},gn=async e=>{const{data:t,error:s}=await A.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",e).order("created_at",{ascending:!0}).returns();if(s)throw console.error("[useConversationReactions] Failed to load reactions",s),new Error(s.message);return(t??[]).map(Ye)},pn=(e,t)=>{const s=new Map,r=new Map;for(const o of e){let l=s.get(o.messageId);l||(l=new Map,s.set(o.messageId,l),r.set(o.messageId,[]));let f=l.get(o.emoji);f||(f={emoji:o.emoji,count:0,reactedBySelf:!1},l.set(o.emoji,f),r.get(o.messageId).push(o.emoji)),f.count+=1,t&&o.userId===t&&(f.reactedBySelf=!0)}const a=new Map;for(const[o,l]of s.entries()){const f=r.get(o)??[];a.set(o,f.map(c=>l.get(c)).filter(Boolean))}return a},hn=(e,t,s)=>{const r=e??[],a=s.key(t),o=[...r],l=o.findIndex(f=>s.key(f)===a);return l>=0?o[l]=t:o.push(t),s.sort&&o.sort(s.sort),o},xn=(e,t,s)=>{const r=e??[];return r.length===0?[]:r.filter(a=>s.key(a)!==t)},Le=e=>t=>{const s=dt(t);if(!ut(s,e.conversationId)||e.extraGuard&&!e.extraGuard(s)||!(e.getRequiredId?e.getRequiredId(s):Y(s,"id")))return;const a=s,o=e.mapRow(a);e.queryClient.setQueryData(e.queryKey,l=>hn(l,o,{key:e.key,sort:e.sort}))},yn=e=>t=>{const s=rn(t),r=e.getRowId?e.getRowId(s):Y(s,"id");if(!r){e.invalidateWhenMissingId!==!1&&e.queryClient.invalidateQueries({queryKey:e.queryKey});return}e.queryClient.setQueryData(e.queryKey,a=>xn(a,r,{key:e.key}))},bn=e=>{const{user:t}=ge(),s=t?.id??null,r=q(),a=as(e),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:f}=xe(e),c=_e({queryKey:a,enabled:!!e,...f,queryFn:()=>e?gn(e):Promise.resolve([])}),m=i.useCallback(()=>{if(!e)return{};const b=Le({conversationId:e,queryClient:r,queryKey:a,mapRow:Ye,key:u=>u.id,sort:(u,g)=>{const p=Ge(u.createdAt),w=Ge(g.createdAt);return p!==w?p-w:u.id.localeCompare(g.id)}}),d=yn({queryClient:r,queryKey:a,key:u=>u.id});return{onStatus:l,onReactionUpsert:b,onReactionDelete:d}},[e,l,r,a]);he(e,m,[]);const y=De({mutationFn:async({messageId:b,emoji:d})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to react to messages.");const{error:u}=await A.from("message_reactions").insert({conversation_id:e,message_id:b,user_id:s,emoji:d});if(u){if(u?.code==="23505"){const{error:g}=await A.from("message_reactions").delete().eq("message_id",b).eq("user_id",s).eq("emoji",d);if(g)throw console.error("[useConversationReactions] Failed to remove reaction",g),g;return}throw console.error("[useConversationReactions] Failed to toggle reaction",u),u}},onMutate:async({messageId:b,emoji:d})=>{if(!e||!s)return{previousReactions:void 0};await r.cancelQueries({queryKey:a});const u=r.getQueryData(a);return r.setQueryData(a,g=>{const p=g??[],w=p.findIndex(N=>N.messageId===b&&N.userId===s&&N.emoji===d);if(w>=0){const N=[...p];return N.splice(w,1),N}const M={id:Rs(),conversationId:e,messageId:b,userId:s,emoji:d,createdAt:new Date().toISOString()};return[...p,M]}),{previousReactions:u}},onError:(b,d,u)=>{e&&(u?.previousReactions?r.setQueryData(a,u.previousReactions):r.invalidateQueries({queryKey:a}))},onSuccess:()=>{e&&r.invalidateQueries({queryKey:a})}}),h=i.useMemo(()=>{const b=c.data??[];return pn(b,s)},[c.data,s]);return{reactions:c.data??[],reactionsByMessageId:h,isLoadingReactions:c.isLoading,toggleReaction:y,pollWhenRealtimeDown:o,queryKey:a}},vn=e=>{const t=q(),s=os(e),{pollWhenRealtimeDown:r,onRealtimeStatus:a,refetchOptions:o}=xe(e),l=_e({queryKey:s,enabled:!!e,...o,queryFn:async()=>e?fn(e):[]}),f=i.useCallback(()=>{if(!e)return{};const c=Le({conversationId:e,queryClient:t,queryKey:s,mapRow:Xe,key:m=>m.userId,getRequiredId:m=>Y(m,"user_id"),sort:(m,y)=>{const h=!m.lastReadAt,b=!y.lastReadAt;if(h&&b)return 0;if(h)return 1;if(b)return-1;const d=new Date(m.lastReadAt).getTime(),u=new Date(y.lastReadAt).getTime();return Number.isNaN(d)&&Number.isNaN(u)?0:Number.isNaN(d)?1:Number.isNaN(u)?-1:u-d}});return{onStatus:a,onReadReceiptUpsert:c}},[e,a,t,s]);return he(e,f,[]),i.useMemo(()=>({...l,pollWhenRealtimeDown:r,queryKey:s}),[l,r,s])},wn=(e,t)=>{const s=q(),r=i.useMemo(()=>Ms(t,{excludeTemp:!0,sort:!0}),[t]),a=is(e,r),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:f}=xe(e),c=_e({queryKey:a,enabled:!!(e&&r.length>0),...f,queryFn:async()=>e?r.length===0?[]:mn(e,r):[]}),m=i.useCallback(()=>{if(!e)return{};if(r.length===0)return{};const h=new Set(r),b=Le({conversationId:e,queryClient:s,queryKey:a,mapRow:Ze,key:d=>d.id,extraGuard:d=>{const u=Y(d,"message_id");return!!(u&&h.has(u))},sort:(d,u)=>{const g=new Date(d.deliveredAt??"").getTime(),p=new Date(u.deliveredAt??"").getTime(),w=Number.isNaN(g)?0:g,M=Number.isNaN(p)?0:p;return w-M}});return{onStatus:l,onDeliveryReceiptUpsert:b}},[e,r,l,s,a]),y=e&&r.length>0?e:null;return he(y,m,[]),i.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:a}),[c,o,a])},Rn=3e3,Mn=2e3,jn=5e3,Sn=e=>{const{conversationId:t,userId:s,displayName:r}=e,[a,o]=i.useState({}),l=i.useRef(null),f=i.useRef(new Map),c=i.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),m=i.useCallback(async d=>{if(!t||!s||!r)return;const u=l.current;u&&await u.send({type:"broadcast",event:"typing",payload:{userId:s,displayName:r,isTyping:d}})},[t,s,r]),y=i.useCallback(async()=>{c.current.timeoutId!=null&&(window.clearTimeout(c.current.timeoutId),c.current.timeoutId=null),c.current.isTyping&&(c.current.isTyping=!1,c.current.lastSentAtMs=0,await m(!1))},[m]),h=i.useCallback(d=>{if(!t||!s||!r||!l.current)return;const g=c.current.isTyping;if(d){const p=Date.now();g?p-c.current.lastSentAtMs>Mn&&(c.current.lastSentAtMs=p,m(!0)):(c.current.isTyping=!0,c.current.lastSentAtMs=p,m(!0)),c.current.timeoutId!=null&&window.clearTimeout(c.current.timeoutId),c.current.timeoutId=window.setTimeout(()=>{c.current.isTyping=!1,c.current.lastSentAtMs=0,c.current.timeoutId=null,m(!1)},Rn);return}g&&y()},[m,t,r,y,s]);return i.useEffect(()=>{if(!t)return;const d=A.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});l.current=d,d.on("broadcast",{event:"typing"},({payload:p})=>{const w=p;if(!w?.userId||s&&w.userId===s)return;o(N=>{const E={...N};return w.isTyping&&w.displayName?E[w.userId]=w.displayName:delete E[w.userId],E});const M=f.current.get(w.userId);if(M!=null&&window.clearTimeout(M),w.isTyping){const N=window.setTimeout(()=>{o(E=>{const v={...E};return delete v[w.userId],v}),f.current.delete(w.userId)},jn);f.current.set(w.userId,N)}else f.current.delete(w.userId)}).subscribe();const u=()=>{document.visibilityState==="hidden"&&y()},g=()=>{y()};return document.addEventListener("visibilitychange",u),window.addEventListener("beforeunload",g),window.addEventListener("pagehide",g),window.addEventListener("blur",g),()=>{document.removeEventListener("visibilitychange",u),window.removeEventListener("beforeunload",g),window.removeEventListener("pagehide",g),window.removeEventListener("blur",g),f.current.forEach(p=>window.clearTimeout(p)),f.current.clear(),y(),l.current&&(A.removeChannel(l.current),l.current=null)}},[t,y,s]),{remoteTypingUsers:i.useMemo(()=>Object.values(a),[a]),noteLocalInputActivity:h,stopTyping:y}},Nn=e=>{const{conversationId:t,storageKeyPrefix:s="messages:draft:",hydrate:r,debounceMs:a=250}=e,o=i.useMemo(()=>t?`${s}${t}`:null,[t,s]),[l,f]=i.useState("");return i.useEffect(()=>{if(!o){f(""),r?.("");return}const y=ls(o)??"";f(y),r?.(y)},[o,r]),i.useEffect(()=>{if(!o)return;const m=window.setTimeout(()=>{l.trim().length===0?We(o):cs(o,l)},a);return()=>window.clearTimeout(m)},[o,a,l]),{draft:l,setDraft:f,clearDraft:()=>{o&&We(o),f(""),r?.("")}}};function Cn({showComposer:e,initialHeaderHeight:t=72,initialComposerHeight:s=160}){const r=i.useRef(null),[a,o]=i.useState(t),[l,f]=i.useState(s),[c,m]=i.useState(!0),[y,h]=i.useState(!1),b=i.useCallback(d=>f(Math.max(d,a)),[a]);return i.useEffect(()=>{const d=r.current;if(!d)return;const u=()=>o(Math.max(d.getBoundingClientRect().height,0));if(u(),typeof ResizeObserver>"u")return;const g=new ResizeObserver(u);return g.observe(d),()=>g.disconnect()},[]),i.useEffect(()=>{f(d=>Math.max(d,a))},[a]),i.useEffect(()=>{e||f(0)},[e]),{headerRef:r,headerHeight:a,composerHeight:l,isAtBottom:c,setIsAtBottom:m,handleComposerHeightChange:b,showEmojiPicker:y,setShowEmojiPicker:h}}const In=({conversationId:e,currentUserId:t,showComposer:s,isBlocked:r,blockedYou:a,composerTextareaRef:o})=>{const[l,f]=i.useState(null),[c,m]=i.useState({}),[y,h]=i.useState(null),[b,d]=i.useState(null),[u,g]=i.useState(null),p=i.useRef(null),w=i.useRef(null);i.useEffect(()=>{if(!e||!t){m({});return}if(typeof window>"u")return;const k=`messages:hidden:${t}:${e}`;try{const D=window.localStorage.getItem(k);if(!D){m({});return}const F=JSON.parse(D);if(Array.isArray(F)){const T={};for(const S of F)typeof S=="string"&&S&&(T[S]=!0);m(T);return}if(F&&typeof F=="object"){const T={};for(const[S,_]of Object.entries(F))_&&(T[S]=!0);m(T);return}m({})}catch{m({})}},[e,t]),i.useEffect(()=>{if(!e||!t||typeof window>"u")return;const k=`messages:hidden:${t}:${e}`;try{const D=Object.keys(c).filter(F=>c[F]);window.localStorage.setItem(k,JSON.stringify(D))}catch{}},[e,t,c]);const M=i.useCallback(()=>{f(null)},[]),N=i.useCallback(k=>{r||a||fe(k.body).deleted||(f(k.id),o.current?.blur())},[a,o,r]),E=i.useCallback((k,D)=>{r||a||fe(k.body).deleted||(D&&(w.current=D),d({messageId:k.id,text:ds(k.body)??"",body:k.body??null,attachmentUrl:k.attachmentUrl??null}),g(null),M(),o.current?.blur())},[a,M,o,r]),v=i.useCallback(k=>{d(D=>D&&{...D,text:k})},[]),C=i.useCallback(()=>{d(null),g(null),w.current?.focus()},[]);i.useEffect(()=>{b&&queueMicrotask(()=>{p.current?.focus()})},[b]);const R=i.useCallback(k=>{r||a||(M(),h({messageId:k.id,attachmentUrl:k.attachmentUrl??null}),o.current?.blur())},[a,M,o,r]),I=i.useCallback(()=>{h(null)},[]),B=i.useCallback(k=>{m(D=>({...D,[k]:!0}))},[]);return i.useEffect(()=>{l===null&&s&&(b||y||queueMicrotask(()=>o.current?.focus()))},[l,y,b,s,o]),{activeActionMessageId:l,openMessageActions:N,closeMessageActions:M,hiddenMessageIds:c,hideMessageForMe:B,deleteDialog:y,openDeleteDialog:R,closeDeleteDialog:I,editingMessage:b,openEditDialog:E,updateEditingText:v,closeEditDialog:C,editTextareaRef:p,editError:u,setEditError:g}},mt=e=>e.code==="42P10"||/no unique or exclusion constraint matching the ON CONFLICT specification/i.test(e.message??""),gt=e=>e.code==="23505"||/duplicate key value violates unique constraint/i.test(e.message??"");let Ie=null,Ee=null;const En=async e=>{if(Ie!==!1){const{error:s}=await A.from("message_delivery_receipts").upsert(e,{onConflict:"conversation_id,message_id,user_id"});if(!s){Ie=!0;return}if(mt(s))Ie=!1;else{console.error("[writeDeliveryReceipt] Failed to write delivery receipt",s);return}}const{error:t}=await A.from("message_delivery_receipts").insert(e);t&&!gt(t)&&console.error("[writeDeliveryReceipt] Failed to insert delivery receipt",t)},kn=async e=>{if(Ee!==!1){const{error:s}=await A.from("message_read_receipts").upsert(e,{onConflict:"conversation_id,user_id"});if(!s){Ee=!0;return}if(mt(s))Ee=!1;else{console.error("[writeReadReceipt] Failed to write read receipt",s);return}}const{error:t}=await A.from("message_read_receipts").insert(e);t&&!gt(t)&&console.error("[writeReadReceipt] Failed to insert read receipt",t)},Ve=3e3;function _n(e){const{conversationId:t,userId:s,isAtBottom:r,messages:a}=e,o=q(),l=i.useRef({conversationId:null,messageId:null,userId:null}),f=i.useRef({lastSentAt:0,timeoutId:null,pending:null});i.useEffect(()=>{l.current={conversationId:null,messageId:null,userId:null};const c=f.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null,c.pending=null,c.lastSentAt=0},[t,s]),i.useEffect(()=>()=>{const c=f.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null},[]),i.useEffect(()=>{if(!t||!a||a.length===0||!s||!r)return;const c=a[a.length-1];if(Je(c.id)||l.current.conversationId===t&&l.current.messageId===c.id&&l.current.userId===s)return;const m=f.current,y=Date.now(),h=m.lastSentAt?y-m.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{et(o,s,t,u=>u.hasUnread?{...u,hasUnread:!1}:u)},d=u=>{m.lastSentAt=Date.now();const g=new Date().toISOString();kn({conversation_id:t,user_id:s,last_read_message_id:u,last_read_at:g}).then(()=>{l.current={conversationId:t,messageId:u,userId:s},b()}).catch(p=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",p)})};if(h<Ve){m.pending={conversationId:t,userId:s,messageId:c.id},m.timeoutId==null&&(m.timeoutId=window.setTimeout(()=>{const u=f.current.pending;f.current.pending=null,f.current.timeoutId=null,u&&(l.current.conversationId===u.conversationId&&l.current.messageId===u.messageId&&l.current.userId===u.userId||u.conversationId!==t||u.userId!==s||d(u.messageId))},Math.max(Ve-h,0)));return}m.timeoutId!=null&&(window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null),d(c.id)},[t,a,s,o,r])}const Tn=e=>{const{user:t}=ge(),s=t?.id??null,r=q();return De({mutationFn:async({messageId:a,text:o,currentBody:l,attachmentUrl:f})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to edit messages.");if(f)throw new Error("Cannot edit messages with attachments.");const c=us(l,o),{data:m,error:y}=await A.from("messages").update({body:c}).eq("id",a).eq("conversation_id",e).eq("user_id",s).select(Te).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return pe(m)},onSuccess:a=>{if(!e)return;const o=me(e);r.setQueryData(o,l=>tt(l,a))}})},Dn=e=>{const{user:t}=ge(),s=t?.id??null,r=q();return De({mutationFn:async({messageId:a,attachmentUrl:o})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to delete messages.");const f={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},c=JSON.stringify(f),{data:m,error:y}=await A.from("messages").update({body:c,attachment_url:null}).eq("id",a).eq("conversation_id",e).eq("user_id",s).select(Te).single();if(y)throw console.error("[useDeleteMessage] Failed to delete message",y),new Error(y.message);if(o)try{await st(o)}catch(b){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",b)}return pe(m)},onSuccess:a=>{if(!e)return;const o=me(e);r.setQueryData(o,l=>tt(l,a)),r.invalidateQueries({queryKey:fs(s)})}})};function Ln(e){const{conversationId:t,setDraft:s,messages:r}=e,a=q(),[o,l]=i.useState(null),[f,c]=i.useState(null),[m,y]=i.useState(null),[h,b]=i.useState({}),d=i.useRef({});i.useEffect(()=>{d.current=h},[h]);const u=i.useRef(t);i.useEffect(()=>{t!==u.current&&(u.current=t,l(null),c(null),y(null),b({}),d.current={})},[t]),i.useEffect(()=>()=>{const v=Object.values(d.current),C=Array.from(new Set(v.map(R=>R.attachmentPath).filter(R=>typeof R=="string"&&R.length>0&&!js(R))));C.length!==0&&A.storage.from(Ss).remove(C).then(({error:R})=>{R&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)}).catch(R=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)})},[t]),i.useEffect(()=>{r&&b(v=>{const C=new Set(r.map(B=>B.id));let R=!1;const I={...v};for(const B of Object.keys(I))C.has(B)||(delete I[B],R=!0);return R?I:v})},[r]);const g=i.useCallback(()=>{l(null),c(null),y(null)},[]),p=i.useCallback((v,C)=>{l("Couldn't send. Please try again."),C.text.trim()&&s(C.text),c(C),y(v),b(R=>({...R,[v]:C}))},[s]),w=i.useCallback(v=>{v&&(b(C=>{if(!(v in C))return C;const R={...C};return delete R[v],R}),v===m&&g())},[g,m]),M=i.useCallback(()=>{if(!f)return null;const v=m;return v&&b(C=>{if(!(v in C))return C;const R={...C};return delete R[v],R}),g(),{payload:f,tempId:v}},[g,f,m]),N=i.useCallback(v=>{const C=h[v];return C?(b(R=>{if(!(v in R))return R;const I={...R};return delete I[v],I}),v===m?g():l(null),C):null},[g,h,m]),E=i.useCallback(async v=>{if(!t)return;const C=h[v];if(!C)return;const R=me(t);if(a.setQueryData(R,I=>Ns(I,v)),b(I=>{if(!(v in I))return I;const B={...I};return delete B[v],B}),v===m&&g(),C.attachmentPath)try{await st(C.attachmentPath)}catch(I){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",I)}},[g,t,h,m,a]);return{sendError:o,setSendError:l,lastFailedPayload:f,lastFailedTempId:m,failedMessages:h,clearBannerState:g,onSendFailed:p,onSendRecovered:w,consumeLastFailedForRetry:M,consumeFailedMessageForRetry:N,discardFailedMessage:E}}const An=({currentUserId:e})=>{const t=q();return i.useCallback(s=>{et(t,e,s.conversationId,r=>{const a=!!(e&&s.senderId===e);return{...r,lastMessagePreview:gs(s.body)??r.lastMessagePreview,lastMessageAt:s.createdAt??r.lastMessageAt,lastMessageAtLabel:ms(s.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:r.lastMessageSeenByOthers}},{moveToTop:!0}),e&&s.senderId!==e&&En({conversation_id:s.conversationId,message_id:s.id,user_id:e})},[e,t])},Bn=({conversationId:e,userId:t,conversation:s,readReceipts:r,visibleMessages:a})=>{const[o,l]=i.useState(void 0),[f,c]=i.useState(void 0);return i.useEffect(()=>{l(void 0),c(void 0)},[e,t]),i.useEffect(()=>{if(!e||!t||o!==void 0)return;const y=(r??[]).find(h=>h.userId===t)??null;l(y?.lastReadMessageId??null)},[e,o,r,t]),i.useEffect(()=>{!e||!t||f===void 0&&s&&c(!!s.hasUnread)},[s,e,f,t]),{firstUnreadIndex:i.useMemo(()=>{if(f===void 0||!f||a.length===0||o===void 0)return null;if(o===null)return 0;const y=a.findIndex(b=>b.message.id===o);if(y<0)return 0;const h=y+1;return h>=a.length?null:h},[f,o,a])}};function Fn({items:e=[],itemContent:t,isLoading:s,loadingContent:r,errorContent:a,emptyContent:o,footer:l,bottomPadding:f,followOutput:c=!1,onAtBottomChange:m,computeItemKey:y,firstItemIndex:h,onStartReached:b,header:d,ariaLabel:u,autoScrollOnNewLastItem:g,autoScrollBehavior:p,autoScrollEnabled:w=!0,virtuosoRef:M}){const N=ne.useRef(null),E=M??N,v=Math.max(0,h??0),C=ne.useRef(null);return ne.useEffect(()=>{if(!g||!w||!e||e.length===0)return;const R=e.length-1,I=e[R],B=y?y(R,I):R,k=C.current;C.current=B,!(k==null||k===B)&&requestAnimationFrame(()=>{E.current?.scrollToIndex({index:v+R,align:"end",behavior:p??"smooth"})})},[p,g,w,v,y,e]),s?n.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:r}):a?n.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:a}):e?.length??0?n.jsx("div",{className:"relative flex min-h-0 flex-1 overflow-hidden",role:"log","aria-live":"polite","aria-relevant":"additions text","aria-label":u??"Messages",children:n.jsx(Bs,{ref:E,data:e??[],style:{height:"100%",width:"100%"},className:"scrollbar-hide px-4 pt-4",alignToBottom:!0,followOutput:c,atBottomStateChange:m,startReached:b,increaseViewportBy:400,firstItemIndex:v,computeItemKey:y?(R,I)=>y(R-v,I):void 0,itemContent:(R,I)=>t(R-v,I),components:{Header:()=>d?n.jsx("div",{className:"pt-2",children:d}):null,Footer:()=>n.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",style:{paddingBottom:f??"10rem"},children:l})}})}):n.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:o})}const Un=({show:e,pendingCount:t,onClick:s,shortcutHint:r})=>{if(!e)return null;const a=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return n.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[n.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),n.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":a,title:r?`${a} (${r})`:a,children:[n.jsx(Os,{className:"h-4 w-4","aria-hidden":!0}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{children:"Jump to latest"}),t>0&&n.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},Pn=({show:e,unreadCount:t,onClick:s,shortcutHint:r})=>{if(!e||t<=0)return null;const a=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return n.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[n.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),n.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":a,title:r?`${a} (${r})`:a,children:[n.jsx(Fs,{className:"h-4 w-4","aria-hidden":!0}),n.jsxs("span",{className:"flex items-center gap-1",children:[n.jsx("span",{children:"Unread"}),n.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},On=({children:e,className:t,onHeightChange:s,minHeight:r,style:a,...o})=>{const l=ne.useRef(null);return ne.useEffect(()=>{if(!s||!l.current)return;const f=l.current,c=()=>s(f.getBoundingClientRect().height);c();const m=new ResizeObserver(c);return m.observe(f),()=>m.disconnect()},[s]),n.jsx("div",{ref:l,className:"pointer-events-none fixed inset-x-0 bottom-0 z-40 w-full",children:n.jsx("div",{className:"w-full",children:n.jsx("form",{...o,className:ps("pointer-events-auto flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",t),style:{minHeight:r,...a},children:e})})})},qn=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],$n=[{emoji:"ðŸ¿",label:"Popcorn"},{emoji:"â­",label:"Rate"},{emoji:"ðŸŽ¬",label:"Slate"},{emoji:"ðŸ‘",label:"Like"}],Hn=({show:e,headerHeight:t,onHeightChange:s,typingUsers:r,isGroupConversation:a,draft:o,setDraft:l,textareaRef:f,noteLocalInputActivity:c,stopTyping:m,onSendText:y,isUploadingImage:h,cancelImageUpload:b,sendError:d,canRetrySend:u,onRetrySend:g,uploadError:p,clearUploadError:w,showEmojiPicker:M,setShowEmojiPicker:N,openCameraPicker:E,fileInputRef:v,onImageSelected:C,isSending:R,disableSend:I})=>{const B=i.useCallback(S=>{const _=S.target.value;l(_),M&&N(!1),c(_.trim().length>0);const O=S.target;O.style.height="auto";const X=Math.min(O.scrollHeight,140);O.style.height=`${X}px`},[c,l,N,M]),k=i.useCallback(S=>{S&&(l(_=>{const O=`${_}${S}`;return c(O.trim().length>0),O}),queueMicrotask(()=>{const _=f.current;_&&(_.style.height="auto",_.style.height=`${Math.min(_.scrollHeight,140)}px`)}))},[c,l,f]),D=i.useCallback(S=>{if(S.preventDefault(),I)return;const _=o.trim();_&&(l(""),m(),y(_))},[I,o,y,l,m]);if(!e)return null;const F=I||!o.trim()||R||h,T=h||R||I;return n.jsxs(On,{onSubmit:D,className:"space-y-3",onHeightChange:s,minHeight:t,children:[n.jsxs("div",{className:"flex items-center gap-3 overflow-x-auto px-1 pb-1 text-xs text-muted-foreground",children:[n.jsx("span",{className:"shrink-0 font-semibold uppercase tracking-wide",children:"React:"}),$n.map(S=>n.jsxs("button",{type:"button",onClick:()=>k(S.emoji),className:"flex shrink-0 items-center gap-1.5 rounded-full border border-border/60 bg-background/60 px-3 py-1.5 text-xs font-medium text-muted-foreground transition-all hover:border-primary/50 hover:bg-muted/60 hover:text-foreground",children:[n.jsx("span",{className:"text-base",children:S.emoji}),n.jsx("span",{children:S.label})]},S.label))]}),r.length>0&&n.jsxs("div",{className:"flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[n.jsx("span",{children:a?r.length===1?`${r[0]} is typingâ€¦`:r.length===2?`${r[0]} and ${r[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),n.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[n.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),n.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),n.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}),h&&n.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[n.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[n.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),n.jsx("p",{className:"font-semibold text-foreground",children:"Uploading imageâ€¦"})]}),n.jsx(U,{type:"button",size:"sm",variant:"outline",onClick:b,children:"Cancel"})]}),d&&n.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(z,{className:"h-3.5 w-3.5","aria-hidden":"true"}),n.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),u&&n.jsx(U,{type:"button",size:"sm",variant:"outline",onClick:g,children:"Retry"})]}),p&&n.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Us,{className:"h-3.5 w-3.5","aria-hidden":"true"}),n.jsx("p",{className:"font-semibold",children:p})]}),n.jsx(U,{type:"button",size:"sm",variant:"ghost",onClick:w,children:"Dismiss"})]}),n.jsxs("div",{className:"flex w-full items-center gap-2",children:[n.jsxs(Cs,{open:M,onOpenChange:N,children:[n.jsx(Is,{asChild:!0,children:n.jsx(U,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:n.jsx(Ws,{className:"h-4 w-4","aria-hidden":"true"})})}),n.jsx(Es,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:n.jsx(ks,{className:"max-h-64",children:n.jsx("div",{className:"grid grid-cols-9 gap-2",children:qn.map(S=>n.jsx(U,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{k(S),N(!1)},children:n.jsx("span",{children:S})},S))})})})]}),n.jsx(U,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:E,"aria-label":"Send photo",disabled:T,"aria-busy":h,children:n.jsx($s,{className:"h-4 w-4","aria-hidden":"true"})}),n.jsx("input",{type:"file",ref:v,accept:"image/*",className:"hidden",onChange:C}),n.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:n.jsx(nt,{id:"conversation-message",value:o,ref:f,rows:1,autoComplete:"off",onChange:B,onBlur:m,onKeyDown:S=>{S.key==="Enter"&&!S.shiftKey&&(S.preventDefault(),o.trim()&&S.currentTarget.form?.requestSubmit())},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),n.jsx(U,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:S=>S.preventDefault(),disabled:F,"aria-label":"Send message","aria-busy":R||h,children:R||h?n.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):n.jsx(Ks,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},Kn=({open:e,editingMessage:t,onOpenChange:s,onCancel:r,onTextChange:a,onSave:o,textareaRef:l,error:f,isSaving:c})=>n.jsx(rt,{open:e,onOpenChange:s,children:n.jsxs(at,{children:[n.jsxs(ot,{children:[n.jsx(it,{children:"Edit message"}),n.jsx(lt,{children:"Update your message for everyone in the conversation."})]}),t&&n.jsx(nt,{ref:l,value:t.text,onChange:m=>a(m.target.value),rows:3,className:"min-h-[120px]"}),f&&n.jsx("p",{className:"text-xs text-destructive",children:f}),n.jsxs(ct,{className:"gap-2",children:[n.jsx(U,{type:"button",variant:"ghost",onClick:r,children:"Cancel"}),n.jsxs(U,{type:"button",disabled:!t?.text.trim()||c,onClick:o,children:[c&&n.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),n.jsx("span",{children:"Save"})]})]})]})}),zn=({open:e,deleteDialog:t,onOpenChange:s,onHideForMe:r,onDeleteForEveryone:a,isDeleting:o})=>n.jsx(rt,{open:e,onOpenChange:s,children:n.jsxs(at,{children:[n.jsxs(ot,{className:"gap-1",children:[n.jsxs(it,{className:"flex items-center gap-2 text-base",children:[n.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:n.jsx(_s,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),n.jsx(lt,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),n.jsxs(ct,{className:"gap-2",children:[n.jsx(U,{type:"button",variant:"outline",className:"flex-1",onClick:r,disabled:!t,children:"Hide for me"}),n.jsxs(U,{type:"button",variant:"destructive",className:"flex-1",disabled:o||!t,onClick:a,children:[o&&n.jsx(z,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),n.jsx("span",{children:"Delete for everyone"})]})]})]})});function Qn(){const[e,t]=i.useState(!1);return i.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const s=window.matchMedia("(prefers-reduced-motion: reduce)"),r=()=>{t(s.matches)};return r(),typeof s.addEventListener=="function"?(s.addEventListener("change",r),()=>s.removeEventListener("change",r)):(s.addListener(r),()=>s.removeListener(r))},[]),e}const or=()=>{const{conversationId:e}=hs(),t=e??null,s=i.useRef(null),r=xs(),{user:a}=ge(),{data:o,isLoading:l}=ys(),f=An({currentUserId:a?.id??null}),{data:c,isLoading:m,isError:y,error:h,loadOlder:b,hasMore:d,isLoadingOlder:u,firstItemIndex:g,pollWhenRealtimeDown:p}=ln(t,{onInsert:f}),w=i.useRef(null);i.useEffect(()=>{if(!t||!c||c.length===0)return;const x=w.current;let j=0;if(x){const P=c.findIndex(ce=>ce.id===x);j=P>=0?P+1:0}for(let P=j;P<c.length;P++)f(c[P]);w.current=c[c.length-1].id},[t,c,f]);const{draft:M,setDraft:N}=Nn({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const x=Z.current;x&&(x.style.height="auto",x.style.height=`${Math.min(x.scrollHeight,140)}px`)})}}),{sendError:E,lastFailedPayload:v,failedMessages:C,clearBannerState:R,onSendFailed:I,onSendRecovered:B,consumeLastFailedForRetry:k,consumeFailedMessageForRetry:D,discardFailedMessage:F}=Ln({conversationId:t,setDraft:x=>N(x),messages:c}),T=i.useMemo(()=>!t||!o?null:o.find(x=>x.id===t)??null,[t,o]),S=T?.isGroup??!1,_=i.useMemo(()=>{if(!T)return null;const x=T.participants.filter(j=>!j.isSelf);return x.length>0?x[0]:T.participants.length===1?T.participants[0]:null},[T]),O=T?.title??_?.displayName??_?.username??"Conversation",X=Ts(t,{onFailed:I,onRecovered:B,otherUserId:S?null:_?.id??null}),V=i.useCallback((x,j)=>{R(),X.mutate({text:x.text,attachmentPath:x.attachmentPath,clientId:x.clientId,tempId:j?.tempId},{onSuccess:()=>{R()}})},[R,X]),Z=i.useRef(null),pt=i.useMemo(()=>{const x=new Map;if(!T)return x;for(const j of T.participants)x.set(j.id,j);return x},[T]),{youBlocked:Ae,blockedYou:$,isBlocked:ee,block:Be,unblock:Fe}=Ds(S?null:_?.id??null),ae=a?.id??null,{fileInputRef:ht,isUploadingImage:xt,uploadError:yt,cancelImageUpload:bt,clearUploadError:vt,handleImageSelected:wt,openFilePicker:Rt}=Ls({conversationId:t,userId:ae,isBlocked:ee,blockedYou:$,attemptSend:V}),oe=!ee&&!$,Mt=!!_&&!S;Be.isPending||Fe.isPending;const ye=Mt?{label:Ae?"Unblock":$?"Blocked":"Block",onClick:()=>{Ae?Fe.mutate():$||Be.mutate()}}:null,{headerRef:jt,headerHeight:St,composerHeight:Nt,isAtBottom:Q,setIsAtBottom:Ct,handleComposerHeightChange:It,showEmojiPicker:Et,setShowEmojiPicker:be}=Cn({showComposer:oe}),kt=oe?`calc(${Math.max(Nt,0)}px + 20px)`:"2.5rem",_t=i.useMemo(()=>T?.participants.find(x=>x.isSelf)?.displayName??"You",[T]),{remoteTypingUsers:Tt,noteLocalInputActivity:Dt,stopTyping:Lt}=Sn({conversationId:t,userId:a?.id??null,displayName:_t}),{data:Ue}=vn(t);_n({conversationId:t,userId:a?.id??null,isAtBottom:Q,messages:c});const{reactionsByMessageId:At,toggleReaction:Pe}=bn(t),Bt=i.useCallback((x,j)=>{Pe.mutate({messageId:x,emoji:j})},[Pe]),H=i.useRef(null),ve=i.useRef(!1),ie=i.useRef(null),[Oe,le]=i.useState(0),J=Qn(),{activeActionMessageId:Ft,openMessageActions:qe,closeMessageActions:we,hiddenMessageIds:$e,hideMessageForMe:Ut,deleteDialog:G,openDeleteDialog:Pt,closeDeleteDialog:Re,editingMessage:W,openEditDialog:Ot,updateEditingText:qt,closeEditDialog:Me,editTextareaRef:$t,editError:Ht,setEditError:He}=In({conversationId:t,currentUserId:ae,showComposer:oe,isBlocked:ee,blockedYou:$,composerTextareaRef:Z}),je=un({messages:c,currentUserId:ae,hiddenMessageIds:$e}),{data:Kt}=wn(t,je?[je]:[]),Ke=Tn(t),ze=Dn(t),{visibleMessages:L}=dn({messages:c,conversation:T,currentUserId:ae,participantsById:pt,reactionsByMessageId:At,hiddenMessageIds:$e,deliveryReceipts:Kt??[],readReceipts:Ue??[],failedMessages:C,lastOwnMessageId:je}),{firstUnreadIndex:K}=Bn({conversationId:t,userId:a?.id??null,conversation:T,readReceipts:Ue,visibleMessages:L}),zt=i.useMemo(()=>K==null?0:L.slice(K).filter(x=>!x.isSelf&&!x.meta.deleted).length,[K,L]),Qe=L.length>0;i.useEffect(()=>{const x=L.length?L[L.length-1]?.message.id??null:null;if(Q){ie.current=x,le(0);return}if(!x)return;const j=ie.current;if(j===x)return;const P=j?L.findIndex(se=>se.message.id===j):-1,de=L.slice(Math.max(0,P+1)).filter(se=>!se.isSelf).length;de<=0||le(de)},[Q,L]),i.useEffect(()=>()=>{H.current!=null&&window.clearTimeout(H.current)},[]),i.useEffect(()=>{const x=j=>{j.key==="Escape"&&(we(),be(!1))};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[we,be]);const Qt=i.useCallback(x=>{x.trim()&&(R(),V({text:x.trim(),attachmentPath:null}))},[V,R]),Gt=()=>{const x=k();x&&V(x.payload,{tempId:x.tempId??void 0})},Wt=x=>{H.current!=null&&window.clearTimeout(H.current),ve.current=!1,H.current=window.setTimeout(()=>{ve.current=!0,qe(x)},500)},Vt=()=>{H.current!=null&&(window.clearTimeout(H.current),H.current=null)},Jt=i.useCallback(x=>{const j=D(x.id);j&&V(j,{tempId:x.id})},[V,D]),Yt=i.useCallback(x=>{F(x.id)},[F]),te=J?"auto":"smooth",Se=i.useCallback(()=>{const x=L.length-1;if(x<0)return;const j=L[x]?.message.id??null;j&&(ie.current=j),le(0),s.current?.scrollToIndex({index:g+x,align:"end",behavior:te}),window.setTimeout(()=>{Z.current?.focus()},J?0:200)},[g,te,J,L]),Ne=i.useCallback(()=>{K!=null&&(s.current?.scrollToIndex({index:g+K,align:"start",behavior:te}),window.setTimeout(()=>{Z.current?.focus()},J?0:150))},[g,K,te,J]);if(i.useEffect(()=>{ie.current=null,le(0)},[t]),i.useEffect(()=>{const x=j=>{if(j.key==="End"||j.key==="ArrowDown"&&(j.metaKey||j.ctrlKey)||j.key==="End"&&(j.metaKey||j.ctrlKey)){j.preventDefault(),Se();return}j.key.toLowerCase()==="u"&&j.altKey&&(j.preventDefault(),Ne())};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[Se,Ne]),!t)return n.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:n.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[n.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),n.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),n.jsx("p",{className:"mt-4",children:n.jsx(bs,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})});const Xt=T?.subtitle||(S?"Group chat":"Active now");return n.jsxs("div",{className:"conversation-page relative flex min-h-screen w-full flex-col items-stretch bg-background text-foreground",children:[n.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[n.jsxs("header",{ref:jt,className:"sticky top-0 z-20 flex items-center justify-between border-b border-border bg-background/80 px-4 py-3 backdrop-blur-md",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("button",{type:"button",onClick:()=>r(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:n.jsx(Ce,{name:"arrow_back"})}),n.jsxs("div",{className:"relative",children:[n.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:_?.avatarUrl?n.jsx("img",{src:_.avatarUrl,alt:_.displayName??"Conversation",className:"h-full w-full object-cover"}):n.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(_?.displayName??O).slice(0,2).toUpperCase()})}),!S&&n.jsx("span",{className:"absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background bg-green-500"})]}),n.jsxs("div",{className:"flex flex-col",children:[n.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:O}),n.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:Xt})]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",children:n.jsx(Ce,{name:"videocam"})}),n.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",children:n.jsx(Ce,{name:"info"})}),ye?n.jsx("button",{type:"button",onClick:ye.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":ye.label,children:n.jsx(Qs,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),n.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[n.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[p&&n.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:n.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[n.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),n.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),n.jsx(Fn,{items:L,isLoading:m&&!Qe,loadingContent:n.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[n.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),n.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:y?n.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[n.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),h instanceof Error&&n.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:h.message})]}):void 0,emptyContent:Qe?void 0:n.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[n.jsx("p",{className:"font-medium text-foreground",children:S?"No messages in this group yet.":"No messages yet."}),n.jsx("p",{className:"mt-1",children:S?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:n.jsx("div",{className:"h-1","aria-hidden":!0}),header:d?n.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:u?n.jsxs("span",{className:"inline-flex items-center gap-2",children:[n.jsx(z,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):n.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:kt,followOutput:Q?J?!0:"smooth":!1,autoScrollOnNewLastItem:!0,autoScrollBehavior:te,autoScrollEnabled:Q,onAtBottomChange:Ct,onStartReached:()=>{d&&!u&&b()},firstItemIndex:g,virtuosoRef:s,computeItemKey:(x,j)=>j.message.id,itemContent:(x,j)=>{const{message:P,meta:ce,sender:de,isSelf:se,deliveryStatus:Zt,reactions:es,showDeliveryStatus:ts}=j,ss=x>0?L[x-1]?.message??null:null,ns=x<L.length-1?L[x+1]?.message??null:null;return n.jsx(As,{message:P,meta:ce,sender:de,isSelf:se,deliveryStatus:Zt,showDeliveryStatus:ts,reactions:es,index:x,previousMessage:ss,nextMessage:ns,firstUnreadIndex:K,activeActionMessageId:Ft,longPressTriggeredRef:ve,onOpenMessageActions:qe,onCloseMessageActions:we,onOpenEditDialog:Ot,onOpenDeleteDialog:Pt,onToggleReaction:Bt,onRetryMessage:Jt,onDiscardFailedMessage:Yt,onBubbleTouchStart:Wt,onBubbleTouchEndOrCancel:Vt})}}),n.jsx(Pn,{show:K!=null&&!Q,unreadCount:zt,onClick:Ne,shortcutHint:"Alt+U"}),n.jsx(Un,{show:!Q&&Oe>0,pendingCount:Oe,onClick:Se,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),n.jsx(Hn,{show:oe,headerHeight:St,onHeightChange:It,typingUsers:Tt,isGroupConversation:S,draft:M,setDraft:N,textareaRef:Z,noteLocalInputActivity:Dt,stopTyping:Lt,onSendText:Qt,isUploadingImage:xt,cancelImageUpload:bt,sendError:!!E,canRetrySend:!!v,onRetrySend:Gt,uploadError:yt,clearUploadError:vt,showEmojiPicker:Et,setShowEmojiPicker:be,openCameraPicker:Rt,fileInputRef:ht,onImageSelected:wt,isSending:X.isPending,disableSend:!!(ee||$)}),$&&n.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:n.jsx("p",{children:"You can't send messages because this user has blocked you."})}),ee&&!$&&n.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:n.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),n.jsx(Kn,{open:!!W,editingMessage:W,onOpenChange:x=>{x||Me()},onCancel:Me,onTextChange:qt,textareaRef:$t,error:Ht,isSaving:Ke.isPending,onSave:()=>{if(!W)return;const x=W.text.trim();x&&(He(null),Ke.mutate({messageId:W.messageId,text:x,currentBody:W.body,attachmentUrl:W.attachmentUrl},{onSuccess:()=>{Me()},onError:()=>{He("Couldn't save changes. Please try again.")}}))}}),n.jsx(zn,{open:!!G,deleteDialog:G,onOpenChange:x=>{x||Re()},onHideForMe:()=>{G&&(Ut(G.messageId),Re())},onDeleteForEveryone:()=>{G&&ze.mutate({messageId:G.messageId,attachmentUrl:G.attachmentUrl},{onSettled:()=>{Re()}})},isDeleting:ze.isPending})]})};export{or as default,Ts as useSendMessage};
