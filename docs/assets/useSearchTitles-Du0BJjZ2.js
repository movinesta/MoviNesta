import{r as F,ah as k,t as E,F as N,s as R,m as D,a7 as q,ai as L}from"./index-DuL1-P9A.js";const J=(e,t)=>{const[n,o]=F.useState(e);return F.useEffect(()=>{const a=window.setTimeout(()=>{o(e)},t);return()=>{window.clearTimeout(a)}},[e,t]),n},x=e=>{if(e?.aborted)throw e.reason??new DOMException("Aborted","AbortError")};async function B(e,t){const n=e.map(async o=>{if(o.imdbId||!o.tmdbId)return o;x(t);try{const a=await k(`/${o.type==="tv"?"tv":"movie"}/${o.tmdbId}/external_ids`,{},t);return x(t),{...o,imdbId:a?.imdb_id??null}}catch(a){return console.warn("[externalMovieSearch] Failed to fetch external ids for",o.tmdbId,a),o}});return Promise.all(n)}async function C(e,t=1,n){const o=e.trim();if(!o)return{results:[],hasMore:!1};x(n);const a=await k("/search/multi",{query:o,include_adult:!1,page:t},n);x(n);const i=Array.isArray(a?.results)?a.results:[];if(!i.length)return{results:[],hasMore:!1};const r=typeof a?.total_pages=="number"?a.total_pages:1,l=i.filter(d=>!!(d&&typeof d.id=="number"&&(d.media_type==="movie"||d.media_type==="tv"))).slice(0,20).map(d=>{const m=d.media_type==="tv"?"tv":"movie",y=d.release_date??d.first_air_date??null,b=y?Number(String(y).slice(0,4)):null;return{tmdbId:Number(d.id),imdbId:d.imdb_id??null,title:d.title??d.name??"Untitled",year:Number.isNaN(b)?null:b,type:m,posterUrl:E(d.poster_path??null)}});return{results:await B(l,n),hasMore:t<r}}const M=e=>{if(e?.aborted)throw e.reason??new DOMException("Aborted","AbortError")},S=e=>{const t=D(e);return{id:t.id,title:t.title,year:t.year,type:t.type,source:"library",posterUrl:t.posterUrl??t.backdropUrl,originalLanguage:t.originalLanguage,ageRating:t.ageRating,imdbRating:t.imdbRating,rtTomatoMeter:t.rtTomatoMeter,imdbId:t.imdbId,tmdbId:t.tmdbId}},v=20,U=5,Q=async()=>{try{const{data:e}=await R.auth.getSession();return!!e?.session?.access_token}catch{return!1}},W=async(e,t,n,o)=>{M(o);try{const c=await N("media-search",{query:e.trim(),page:n,limit:v,filters:t??{}},{signal:o,timeoutMs:2e4});if(c?.ok&&Array.isArray(c.results))return M(o),{results:c.results.map(S),hasMore:!!c.hasMore}}catch(c){console.warn("[search.service] media-search Edge Function failed, falling back",c)}const a=`
    id,
    kind,
    tmdb_id,
    tmdb_title,
    tmdb_name,
    tmdb_original_title,
    tmdb_original_name,
    tmdb_release_date,
    tmdb_first_air_date,
    tmdb_poster_path,
    tmdb_backdrop_path,
    tmdb_original_language,
    tmdb_genre_ids,
    omdb_title,
    omdb_year,
    omdb_language,
    omdb_imdb_id,
    omdb_imdb_rating,
    omdb_rating_rotten_tomatoes,
    omdb_poster,
    omdb_rated
  `,i=(n-1)*v;let r=R.from("media_items").select(a,{count:"exact"});r=r.range(i,i+v-1),o&&(r=r.abortSignal(o)),e&&(r=r.textSearch("search_vector",e.trim(),{config:"english",type:"websearch"})),t?.type&&t.type!=="all"&&(r=r.eq("kind",t.type==="series"?"series":t.type)),t?.genreIds?.length&&(r=r.overlaps("tmdb_genre_ids",t.genreIds));const l=typeof t?.minYear=="number",u=typeof t?.maxYear=="number";if(l||u){const c=l?`${t.minYear}-01-01`:null,_=u?`${t.maxYear}-12-31`:null,I=[];for(const s of["tmdb_release_date","tmdb_first_air_date"])c&&_?I.push(`and(${s}.gte.${c},${s}.lte.${_})`):c?I.push(`${s}.gte.${c}`):_&&I.push(`${s}.lte.${_}`);I.length&&(r=r.or(I.join(",")))}t?.originalLanguage&&(r=r.eq("tmdb_original_language",t.originalLanguage)),r=r.order("tmdb_release_date",{ascending:!1,nullsFirst:!1}).order("tmdb_first_air_date",{ascending:!1,nullsFirst:!1}).order("tmdb_title",{ascending:!0,nullsFirst:!0});const{data:d,error:m,count:y}=await r;if(m)throw new Error(m.message);M(o);const b=d??[],g=typeof y=="number"?y:void 0,h=g?i+b.length<g:b.length===v;return{results:b.map(S),hasMore:h}},K=async e=>{const{query:t,filters:n,page:o=1,signal:a}=e,i=t.trim(),r=n?.type&&n.type!=="all"||typeof n?.minYear=="number"||typeof n?.maxYear=="number"||!!n?.originalLanguage||!!n?.genreIds?.length;M(a);let l=[],u=!1;try{const{results:s,hasMore:f}=await W(i,n,o,a);l=s,u=f}catch(s){console.warn("[search.service] Supabase search failed, falling back to TMDb",s)}if((!n?.type||n.type==="all")&&(l=l.filter(s=>s.type==null||s.type==="movie"||s.type==="series")),!i)return r?{results:l,hasMore:u}:{results:[],hasMore:!1};const{results:m,hasMore:y}=await C(i,o,a);if(M(a),!m.length&&l.length>0)return{results:l,hasMore:u};const b=new Set,g=new Set;for(const s of l)s.tmdbId&&b.add(s.tmdbId),s.imdbId&&g.add(s.imdbId);const h=m.filter(s=>!(s.tmdbId&&b.has(s.tmdbId)||s.imdbId&&g.has(s.imdbId))),c=new Map;if(h.length&&await Q()){const s=h.filter(f=>f.tmdbId).slice(0,U).map(f=>({tmdbId:f.tmdbId??null,imdbId:f.imdbId??null,contentType:f.type==="tv"?"series":"movie"}));if(s.length)try{const f=await N("catalog-sync-batch",{items:s,options:{syncOmdb:!0,forceRefresh:!1}},{signal:a,timeoutMs:2e4});f?.ok&&Array.isArray(f.results)&&f.results.forEach(p=>{if(!p?.mediaItemId||!p.tmdbId||!p.contentType)return;const w=`${p.contentType}:${p.tmdbId}`;c.set(w,p.mediaItemId)})}catch(f){console.warn("[search.service] catalog-sync-batch failed",f)}}const _=await Promise.all(h.map(async s=>{M(a);const f=s.type==="tv"?"series":"movie",p=s.tmdbId?`${f}:${s.tmdbId}`:null,w=p&&c.get(p)?c.get(p):s.tmdbId?`${s.type==="tv"?"tv":"tmdb"}-${s.tmdbId}`:`tmdb-${Math.random()}`,P=!w.startsWith("tmdb-")&&!w.startsWith("tv-");return s.tmdbId&&b.add(s.tmdbId),s.imdbId&&g.add(s.imdbId),{id:w,title:s.title,year:s.year??null,type:f,source:P?"external-synced":"external-only",posterUrl:s.posterUrl,originalLanguage:null,ageRating:null,imdbRating:null,rtTomatoMeter:null,imdbId:s.imdbId??null,tmdbId:s.tmdbId}}));return{results:[...l,..._.filter(s=>!!s)],hasMore:u||y}},O=e=>{if(!e)return null;const t=e.trim().toLowerCase();return t==="relevance"||t==="newest"||t==="rating"?t:null},z=e=>e.trim().length>0?"relevance":"newest",Y=e=>e.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(),H=e=>{const t=e.match(/\b(19\d{2}|20\d{2})\b/);if(!t)return null;const n=Number(t[1]);return Number.isFinite(n)?n:null},$=(e,t)=>{const n=Y(e);if(!n)return 0;const o=Y(t.title??"");if(!o)return 0;let a=0;o===n?a+=1e3:o.startsWith(n)?a+=850:o.includes(` ${n} `)?a+=780:o.includes(n)&&(a+=650);const i=n.split(" ").filter(l=>l.length>=2);if(i.length){const l=new Set(o.split(" "));let u=0;for(const d of i)if(l.has(d))u+=1;else for(const m of l)if(m.startsWith(d)){u+=1;break}a+=u*35}const r=H(e);if(r&&t.year){const l=Math.abs(t.year-r);l===0?a+=90:l<=1&&(a+=40)}return t.source==="library"?a+=60:t.source==="external-synced"&&(a+=25),a},T=e=>typeof e.imdbRating=="number"&&Number.isFinite(e.imdbRating)?e.imdbRating:typeof e.rtTomatoMeter=="number"&&Number.isFinite(e.rtTomatoMeter)?e.rtTomatoMeter/10:null,Z=e=>{const{items:t,query:n,sortKey:o}=e,a=[...t];return o==="newest"?(a.sort((i,r)=>{const l=i.year??-1,u=r.year??-1;return u!==l?u-l:i.title.localeCompare(r.title)}),a):o==="rating"?(a.sort((i,r)=>{const l=T(i)??-1,u=T(r)??-1;if(u!==l)return u-l;const d=i.year??-1,m=r.year??-1;return m!==d?m-d:i.title.localeCompare(r.title)}),a):(a.sort((i,r)=>{const l=$(n,i),u=$(n,r);if(u!==l)return u-l;const d=T(i)??-1,m=T(r)??-1;if(m!==d)return m-d;const y=i.year??-1,b=r.year??-1;return b!==y?b-y:i.title.localeCompare(r.title)}),a)},G=["all","movie","series"],X=e=>{const t=e.get("tab");return t==="people"?"people":t==="titles"?"titles":"all"},ee=(e,t="")=>O(e.get("sort"))??z(t),A=e=>{if(typeof e!="number")return;const t=new Date().getFullYear();return Math.min(Math.max(e,1900),t)},te=e=>{const t=e.get("type"),n=G.includes(t)?t:"all",o=()=>{const d=[],m=e.get("genre");m&&d.push(m);const y=e.getAll("genres");y?.length&&d.push(...y);const b=d.flatMap(c=>c.split(",")).map(c=>Number(c.trim())).filter(c=>Number.isFinite(c)&&c>0).map(c=>Math.floor(c));if(!b.length)return;const g=new Set,h=[];for(const c of b)g.has(c)||(g.add(c),h.push(c));return h},a=d=>{if(!d)return;const m=Number(d);return Number.isFinite(m)?m:void 0},i=A(a(e.get("minYear"))),r=A(a(e.get("maxYear"))),l=e.get("lang")||void 0,u=o();return i&&r&&i>r?{type:n,minYear:r,maxYear:i,originalLanguage:l,genreIds:u}:{type:n,minYear:i,maxYear:r,originalLanguage:l,genreIds:u}},V=e=>e?!!(e.type&&e.type!=="all"||typeof e.minYear=="number"||typeof e.maxYear=="number"||e.originalLanguage||e.genreIds?.length):!1,re=e=>{const{query:t,filters:n}=e,o=t.trim(),a=V(n);return q({queryKey:["search","titles",{query:o,filters:n}],enabled:o.length>=2||a,placeholderData:L,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,initialPageParam:1,getNextPageParam:(i,r)=>i.hasMore?r.length+1:void 0,queryFn:({signal:i,pageParam:r})=>K({query:o,filters:n,page:r??1,signal:i})})};export{J as a,te as b,ee as c,z as d,A as e,V as h,X as p,Z as s,re as u};
