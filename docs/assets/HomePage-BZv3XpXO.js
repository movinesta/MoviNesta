import{u as me,j as e,B as Te,b as Ie,c as I,s as y,d as Fe,m as $e,e as Be,f as qe,g as Re,R as c,p as T,h as Ee,t as Z,q as we,i as ye,k as Ke,l as He}from"./index-CuXsBKB-.js";import{u as We}from"./useDocumentTitle-6Zer_u-F.js";import{D as Oe,a as ze,b as Ge,c as Ye}from"./dialog-KsRlRjfX.js";import{P as Qe}from"./plus-B-cDPHxD.js";import{S as Ve}from"./star-UbXg7u6d.js";import{B as Je}from"./bookmark-plus-CHsiQ36F.js";import{S as Xe}from"./sparkles-Bgk21F6p.js";import{M as j}from"./material-icon-sbzzvxfS.js";import{D as Ze,a as et,b as tt,c as st,d as je,e as rt,f as Q,g as Ne}from"./dropdown-menu-Cjv24tkg.js";import{u as at,a as nt}from"./useDiaryLibrary-BD8Z1ct7.js";import"./index-C7UQl0qe.js";import"./index-BxBFM2Tt.js";import"./index-Bj6QaD0p.js";import"./useMutation-BhCO-uzT.js";const V=({icon:t,title:r,description:l,onClick:a})=>e.jsxs("button",{type:"button",onClick:a,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-3 text-left hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",children:[e.jsx("span",{className:"inline-flex h-10 w-10 items-center justify-center rounded-full bg-muted/80",children:t}),e.jsxs("span",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"block truncate text-sm font-semibold text-foreground",children:r}),e.jsx("span",{className:"block truncate text-xs text-muted-foreground",children:l})]})]}),it=({open:t,onOpenChange:r})=>{const l=me(),a=()=>r(!1),i=d=>{a(),l(d)};return e.jsx(Oe,{open:t,onOpenChange:r,children:e.jsxs(ze,{className:"left-0 right-0 top-auto bottom-0 w-full max-w-none translate-x-0 translate-y-0 rounded-t-3xl rounded-b-none border border-border bg-card p-4",children:[e.jsx("div",{className:"mx-auto mb-2 h-1.5 w-12 rounded-full bg-muted","aria-hidden":!0}),e.jsx(Ge,{className:"pb-1",children:e.jsx(Ye,{className:"text-center text-base text-foreground",children:"Create"})}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx(V,{icon:e.jsx(Qe,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Log a movie",description:"Pick a title and add it to your diary",onClick:()=>i("/search")}),e.jsx(V,{icon:e.jsx(Ve,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Write a review",description:"Find a title and leave your thoughts",onClick:()=>i("/search")}),e.jsx(V,{icon:e.jsx(Je,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Create a highlight",description:"Make a new list (Top movies, etc.)",onClick:()=>i("/me?createHighlight=1")}),e.jsx(V,{icon:e.jsx(Xe,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Discover",description:"Explore trending picks",onClick:()=>i("/search")})]}),e.jsx("div",{className:"pt-2",children:e.jsx(Te,{type:"button",variant:"ghost",className:"w-full rounded-2xl border border-border bg-muted/60 text-foreground hover:bg-muted",onClick:a,children:"Cancel"})})]})})},lt=t=>t.length?t.find(l=>/top\s+movies/i.test(l.name))??t[0]:null,ot=()=>{const{user:t}=Ie();return I({queryKey:["home","stories",t?.id??null],enabled:!!t?.id,staleTime:1e3*30,queryFn:async()=>{if(!t?.id)return[];const{data:r,error:l}=await y.from("follows").select("followed_id").eq("follower_id",t.id).limit(40);if(l)throw new Error(l.message);const a=(r??[]).map(o=>o.followed_id).filter(o=>!!o),i=Array.from(new Set([t.id,...a])).slice(0,41),{data:d,error:h}=await y.from("profiles_public").select("id, username, display_name, avatar_url").in("id",i);if(h)throw new Error(h.message);const p=d??[],F=new Map(p.map(o=>[o.id,o])),$=await Promise.all(i.map(async o=>{const m=F.get(o),u=await Fe(m?.avatar_url??null);return[o,u]})),B=new Map($),{data:M,error:q}=await y.from("lists").select("id, user_id, name, is_public, updated_at, created_at").in("user_id",i).order("updated_at",{ascending:!1}).order("created_at",{ascending:!1}).limit(240);if(q)throw new Error(q.message);const D=M??[],g=new Map;for(const o of D){const m=g.get(o.user_id)??[];m.push(o),g.set(o.user_id,m)}const S=new Map;for(const o of i){const m=g.get(o)??[],u=o===t.id?m:m.filter(R=>R.is_public),b=lt(u);b&&S.set(o,b)}const N=Array.from(new Set(Array.from(S.values()).map(o=>o.id))),k=new Map;if(N.length){const{data:o,error:m}=await y.from("list_items").select("list_id, title_id, position, created_at").in("list_id",N).order("position",{ascending:!0}).order("created_at",{ascending:!0}).limit(400);m&&console.warn("[useHomeStories] Failed to load list_items",m.message);for(const u of o??[])!u?.list_id||!u?.title_id||k.has(u.list_id)||k.set(u.list_id,u.title_id)}const U=Array.from(new Set(Array.from(k.values()))),A=new Map;if(U.length){const{data:o,error:m}=await y.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",U);if(m)console.warn("[useHomeStories] Failed to load media_items",m.message);else for(const u of o??[]){const b=$e(u);A.set(u.id,b.posterUrl??b.backdropUrl??null)}}return[t.id,...i.filter(o=>o!==t.id)].map(o=>{const m=F.get(o),u=S.get(o),b=u?k.get(u.id)??null:null;return{userId:o,username:m?.username??null,displayName:m?.display_name??null,avatarUrl:B.get(o)??null,listId:u?.id??null,listName:u?.name??null,coverPosterUrl:b?A.get(b)??null:null}}).filter(o=>!!(o.username||o.displayName))}})};function dt(t){const r=t?.releaseYear?String(t.releaseYear):null,a=(Array.isArray(t?.genres)?t?.genres:[])[0]??null;return a&&r?`${a} • ${r}`:a||r||(t?.kind?t.kind:"Title")}function ct(t){const r=typeof t?.imdbRating=="number"?t.imdbRating:null,l=typeof t?.rtTomatoMeter=="number"?t.rtTomatoMeter:null,a=r!=null?r/2:null,i=l!=null?l/20:null,d=a??i;return d==null?void 0:Math.max(0,Math.min(5,d)).toFixed(1)}function oe(t){const r=(t?.mediaItemId??"").toString(),l=(t?.title??"").toString().trim();if(!r||!l)return null;const a=t?.kind==="movie"||t?.kind==="series"||t?.kind==="anime"?t.kind:null,i=(t?.posterUrl&&t.posterUrl.trim()?t.posterUrl:null)??(t?.tmdbPosterPath?Z(t.tmdbPosterPath,"w500"):null);return{id:r,title:l,subtitle:dt(t),rating:ct(t),imageUrl:i,kind:a}}function ke(t){const r=[];t.year&&r.push(String(t.year)),t.type&&t.type!=="other"&&t.type!=="episode"&&r.push(t.type==="series"?"Series":t.type==="anime"?"Anime":"Movie");const l=r.join(" • ")||"In your diary";return{id:t.titleId,title:t.title,subtitle:l,rating:t.rating??void 0,imageUrl:t.posterUrl??null,kind:t.type??null}}async function de(t){const{sessionId:r,mode:l,limit:a}=t,i=Ke(r,l,null);return He({sessionId:r,mode:l,limit:a,seed:i})}function ut(t=new Date){const r=t.getHours();return r>=5&&r<12?"Good Morning":r>=12&&r<18?"Good Afternoon":"Good Evening"}function ce(t,r){const l=(t||r||"").replace(/^@/,"").trim();if(!l)return"?";const a=l.split(/\s+/);return a.length===1?a[0].slice(0,2).toUpperCase():(a[0][0]+a[1][0]).toUpperCase()}const ue=({icon:t,label:r,onClick:l,showDot:a,badgeCount:i})=>{const d=typeof i=="number"&&i>0?i:0,h=d>9?"9+":String(d);return e.jsxs("button",{type:"button",onClick:l,className:"relative inline-flex h-10 w-10 items-center justify-center rounded-full text-foreground transition-colors hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":r,children:[e.jsx(j,{name:t,className:"text-[22px]",ariaLabel:r}),d?e.jsx("span",{className:"absolute -right-0.5 -top-0.5 inline-flex min-w-[18px] items-center justify-center rounded-full bg-primary px-1.5 py-0.5 text-[10px] font-bold leading-none text-primary-foreground shadow","aria-label":`${d} new items`,children:h}):a?e.jsx("span",{className:"absolute right-2.5 top-2.5 h-2 w-2 rounded-full bg-primary"}):null]})},J=({title:t,actionLabel:r="See All",onAction:l})=>e.jsxs("div",{className:"flex items-center justify-between px-4 pb-3",children:[e.jsx("h2",{className:"text-xl font-bold tracking-tight text-foreground",children:t}),l?e.jsx("button",{type:"button",onClick:l,className:"text-sm font-semibold text-primary transition-colors hover:text-primary/80",children:r}):null]}),X=({item:t,onClick:r,menu:l})=>{const a=i=>{r&&(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),r())};return e.jsx("div",{className:"group flex flex-col gap-1 text-left",children:e.jsxs("div",{role:"button",tabIndex:0,onClick:r,onKeyDown:a,"aria-label":t.title,className:"outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:[e.jsxs("div",{className:"relative aspect-[2/3] w-full overflow-hidden rounded-xl bg-muted shadow",children:[t.imageUrl?e.jsx("img",{src:t.imageUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-muted to-muted/40"}),e.jsx("div",{className:"absolute inset-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100 bg-gradient-to-t from-black/60 via-black/10 to-transparent"}),t.rating?e.jsxs("div",{className:"absolute left-2 top-2 inline-flex items-center gap-1 rounded-full bg-black/55 px-1.5 py-1 text-[10px] font-bold text-yellow-400",children:[e.jsx(j,{name:"star",filled:!0,className:"text-[14px]",ariaLabel:"Rating"}),e.jsx("span",{children:t.rating})]}):null,l?e.jsx("div",{className:"absolute right-2 top-2 z-20",onClick:i=>i.stopPropagation(),children:l}):null]}),e.jsxs("div",{className:"min-w-0 pt-1",children:[e.jsx("h4",{className:"truncate text-sm font-bold text-foreground",children:t.title}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:t.subtitle})]})]})})},_e=({item:t,onClick:r,menu:l})=>{const a=i=>{r&&(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),r())};return e.jsx("div",{className:"group w-full text-left",children:e.jsx("div",{role:"button",tabIndex:0,onClick:r,onKeyDown:a,"aria-label":t.title,className:"outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:e.jsxs("div",{className:"relative aspect-[2/3] w-full overflow-hidden rounded-3xl bg-muted shadow-lg",children:[t.imageUrl?e.jsx("img",{src:t.imageUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-muted to-muted/40"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent opacity-80"}),t.rating?e.jsxs("div",{className:"absolute left-4 top-4 inline-flex items-center gap-1 rounded-full bg-black/55 px-2 py-1 text-xs font-bold text-yellow-400",children:[e.jsx(j,{name:"star",filled:!0,className:"text-[16px]",ariaLabel:"Rating"}),e.jsx("span",{children:t.rating})]}):null,l?e.jsx("div",{className:"absolute right-4 top-4 z-20",onClick:i=>i.stopPropagation(),children:l}):null,e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white drop-shadow",children:t.title}),e.jsx("p",{className:"mt-1 text-sm text-white/80",children:t.subtitle})]})]})})})},mt=({item:t,currentStatus:r,onSetStatus:l,onOpenDetails:a,onRateAndReview:i})=>e.jsxs(Ze,{children:[e.jsx(et,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-black/45 text-white backdrop-blur transition hover:bg-black/55 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60","aria-label":"More actions",children:e.jsx(j,{name:"more_vert",className:"text-[20px]",ariaLabel:"More"})})}),e.jsxs(tt,{align:"end",sideOffset:8,className:"w-56",children:[e.jsx(st,{className:"truncate",children:t.title}),e.jsx(je,{}),e.jsxs(rt,{value:r??"none",onValueChange:d=>{d!=="none"&&l(d)},children:[e.jsx(Q,{value:"want_to_watch",children:"Watchlist"}),e.jsx(Q,{value:"watching",children:"Watching"}),e.jsx(Q,{value:"watched",children:"Watched"}),e.jsx(Q,{value:"dropped",children:"Dropped"})]}),e.jsx(je,{}),e.jsx(Ne,{onSelect:d=>{d.preventDefault(),i()},children:"Rate & review"}),e.jsx(Ne,{onSelect:d=>{d.preventDefault(),a()},children:"Open details"})]})]}),xt=t=>{switch(t.kind){case"friend-rating":return"rated";case"friend-review":return"reviewed";case"friend-watched":return"watched";case"watchlist-add":return"added to watchlist";case"watchlist-remove":return"removed from watchlist";case"recommendation":return"recommended";default:return""}},pt=({item:t})=>{const r=me(),l=t.title.posterUrl??null,a=t.kind==="friend-review"||t.kind==="friend-rating"||t.kind==="friend-watched"?t.reviewSnippet:null,i=t.kind==="watchlist-add"?t.note:null,d=t.kind==="recommendation"?t.reason:null,h=()=>r(`/title/${t.title.id}`),p=()=>r(`/title/${t.title.id}/reviews`);return e.jsxs("div",{className:"flex gap-4 rounded-3xl border border-border/40 bg-card/70 p-4 shadow-sm",children:[e.jsx("div",{className:"h-10 w-10 shrink-0 overflow-hidden rounded-full bg-muted ring-1 ring-border/40",children:t.user.avatarUrl?e.jsx("img",{src:t.user.avatarUrl,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("div",{className:"grid h-full w-full place-items-center text-[10px] font-semibold text-muted-foreground",children:t.user.displayName.slice(0,2).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-sm font-bold text-foreground",children:t.user.displayName}),e.jsxs("p",{className:"mt-0.5 text-xs text-muted-foreground",children:[xt(t)," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.title.name})]})]}),e.jsx("p",{className:"shrink-0 text-xs text-muted-foreground",children:t.relativeTime})]}),a?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:a}):null,i?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:i}):null,d?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:d}):null,e.jsxs("button",{type:"button",onClick:h,className:"mt-3 flex w-full items-center gap-3 rounded-2xl border border-border/30 bg-background/40 p-2 text-left transition hover:bg-background/60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40","aria-label":`Open ${t.title.name}`,children:[e.jsx("div",{className:"h-14 w-10 shrink-0 overflow-hidden rounded-lg bg-muted",children:l?e.jsx("img",{src:l,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-primary/40 via-background/20 to-primary/60"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-xs font-bold text-foreground",children:t.title.name}),e.jsx("p",{className:"mt-0.5 text-[11px] text-muted-foreground",children:t.title.mediaType??"title"}),(t.kind==="friend-rating"||t.kind==="friend-review"||t.kind==="friend-watched")&&typeof t.rating=="number"?e.jsxs("div",{className:"mt-1 inline-flex items-center gap-1 text-[11px] font-semibold text-yellow-400",children:[e.jsx(j,{name:"star",filled:!0,className:"text-[14px]",ariaLabel:"Rating"}),e.jsxs("span",{children:[t.rating,"/5"]})]}):null]})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:h,className:"inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-xs font-bold text-primary-foreground transition hover:bg-primary/90",children:"Open"}),e.jsx("button",{type:"button",onClick:p,className:"inline-flex items-center justify-center rounded-full bg-white/5 px-4 py-2 text-xs font-bold text-foreground ring-1 ring-border/50 transition hover:bg-white/10",children:"Reviews"})]})]})]})},ft=()=>e.jsx("div",{className:"space-y-3",children:[0,1].map(t=>e.jsx("div",{className:"rounded-3xl border border-border/40 bg-card/60 p-4 shadow-sm",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-10 w-10 animate-pulse rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-3 w-40 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"h-3 w-56 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"h-14 w-full animate-pulse rounded-2xl bg-muted"})]})]})},`friends-activity-skeleton-${t}`))}),Dt=()=>{We("Home");const t=me(),r=Be(),{user:l}=Ie(),a=l?.id??null,{data:i}=qe(),{data:d,isLoading:h}=ot(),{items:p,isLoading:F,error:$,hasMore:B,isLoadingMore:M,loadMore:q}=Re(),{updateStatus:D}=at(),{entries:g,isLoading:S}=nt({status:"all",type:"all"}),N=c.useMemo(()=>new Map(g.map(s=>[s.titleId,s.status])),[g]),k=c.useMemo(()=>new Map(g.map(s=>[s.titleId,s.type??null])),[g]),U=c.useMemo(()=>g.filter(s=>s.status==="watching").slice(0,12).map(ke),[g]),A=c.useMemo(()=>g.filter(s=>s.status==="want_to_watch").slice(0,12).map(ke),[g]),ee="home:lastSeenActivityAt",[o,m]=c.useState(()=>{try{return localStorage.getItem(ee)}catch{return null}}),u=c.useMemo(()=>{if(!p.length)return 0;if(!o)return p.length;const s=new Date(o).getTime();return Number.isNaN(s)?p.length:p.filter(n=>new Date(n.createdAt).getTime()>s).length},[p,o]),b=c.useCallback(s=>{switch(s){case"want_to_watch":return"Watchlist";case"watching":return"Watching";case"watched":return"Watched";case"dropped":return"Dropped";default:return"Saved"}},[]),R=c.useCallback(async(s,n)=>{if(!a){T({title:"Sign in required",description:"Create an account to save titles.",variant:"info"});return}const x=s.kind??k.get(s.id)??null;if(!x){T({title:"Couldn't save",description:"This title is missing a content type.",variant:"error"});return}const P=N.get(s.id)??null;try{await D.mutateAsync({titleId:s.id,status:n,type:x,title:s.title,posterUrl:s.imageUrl??null}),T({title:"Saved",description:P?`Moved to ${b(n)}.`:`Added to ${b(n)}.`,variant:"success",action:P?{label:"Undo",onClick:()=>D.mutate({titleId:s.id,status:P,type:x,title:s.title,posterUrl:s.imageUrl??null})}:void 0})}catch(le){T({title:"Update failed",description:le?.message??"Please try again.",variant:"error"})}},[N,b,k,D,a]),_=c.useCallback(s=>s?.id?e.jsx(mt,{item:s,currentStatus:N.get(s.id)??null,onSetStatus:n=>R(s,n),onOpenDetails:()=>t(`/title/${s.id}`),onRateAndReview:()=>t(`/title/${s.id}/reviews?compose=1`)}):null,[t,R,N]),te=c.useMemo(()=>Ee(),[]),{data:xe,isLoading:Se,error:Ce}=I({queryKey:["home-v2","deck","combined",a],enabled:!!a,queryFn:()=>de({sessionId:te,mode:"combined",limit:14}),staleTime:6e4}),{data:E,isLoading:se,error:K}=I({queryKey:["home-v2","deck","trending",a],enabled:!!a,queryFn:()=>de({sessionId:te,mode:"trending",limit:14}),staleTime:6e4}),{data:H,isLoading:re,error:W}=I({queryKey:["home-v2","deck","for_you",a],enabled:!!a,queryFn:()=>de({sessionId:te,mode:"for_you",limit:14}),staleTime:6e4}),w=c.useMemo(()=>xe?.cards?.[0]??H?.cards?.[0]??E?.cards?.[0]??null,[xe?.cards,H?.cards,E?.cards]),f=c.useMemo(()=>oe(w),[w]),v=f?.id??null,{data:C}=I({queryKey:["home-v2","hero-details",v],enabled:!!v,queryFn:async()=>{const{data:s,error:n}=await y.from("media_items").select("id, tmdb_overview, omdb_plot, tmdb_backdrop_path, tmdb_poster_path, tmdb_title, tmdb_name, omdb_title").eq("id",v).maybeSingle();if(n)throw n;return s??null},staleTime:5*6e4}),pe=c.useMemo(()=>(C?.tmdb_overview||C?.omdb_plot||"").trim()||null,[C?.tmdb_overview,C?.omdb_plot]),ae=c.useMemo(()=>{const s=Z(C?.tmdb_backdrop_path??null,"w1280"),n=w?.tmdbBackdropPath?Z(w.tmdbBackdropPath,"w1280"):null,x=w?.tmdbPosterPath?Z(w.tmdbPosterPath,"w780"):null;return s??n??x??f?.imageUrl??null},[C?.tmdb_backdrop_path,w,f?.imageUrl]),{data:Me}=I({queryKey:["home-v2","recent-watched",a],enabled:!!a,queryFn:async()=>{const{data:s,error:n}=await y.from("library_entries").select("title_id, updated_at").eq("user_id",a).eq("status","watched").order("updated_at",{ascending:!1}).limit(1);if(n)throw n;return s?.[0]?.title_id??null},staleTime:6e4}),L=Me??v,{data:O}=I({queryKey:["home-v2","seed-item",L],enabled:!!L,queryFn:async()=>{const{data:s,error:n}=await y.from("media_items").select("id, tmdb_title, tmdb_name, omdb_title").eq("id",L).maybeSingle();if(n)throw n;return s??null},staleTime:5*6e4}),fe=c.useMemo(()=>[O?.tmdb_title,O?.tmdb_name,O?.omdb_title,f?.title].map(n=>typeof n=="string"?n.trim():"").find(n=>!!n)??null,[O,f?.title]),z=c.useMemo(()=>{const s=new Set;return v&&s.add(v),(E?.cards??[]).filter(n=>n?.mediaItemId&&!s.has(n.mediaItemId)).map(oe).filter(Boolean)},[E?.cards,v]),G=z[0]??null,De=z.slice(1,7),ge=c.useMemo(()=>{const s=new Set;v&&s.add(v);const n=(H?.cards??[]).filter(x=>x?.mediaItemId&&!s.has(x.mediaItemId)).map(oe).filter(Boolean);return n.length?n:z},[H?.cards,z,v]),Y=ge[0]??null,Ue=ge.slice(1,7),[Ae,be]=c.useState(!1),he=i?.displayName||i?.username||(i?"You":""),Le=c.useMemo(()=>ut(),[]),ve=c.useMemo(()=>{const s=d??[],n=l?.id??null;return n?s.filter(x=>x.userId!==n):s},[l?.id,d]),Pe=c.useCallback(()=>{a&&(T({title:"Refreshing…",description:"Updating your Home feed.",variant:"info",durationMs:1200}),r.invalidateQueries({queryKey:["home-v2"]}),r.invalidateQueries({queryKey:["home","stories",a]}),r.invalidateQueries({queryKey:we.homeFeed(a)}),r.invalidateQueries({queryKey:we.diaryLibrary(a)}))},[r,a]),[ne,ie]=c.useState(3);return c.useEffect(()=>{ie(3)},[a]),e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx("header",{className:"sticky top-0 z-30 -mx-4 -mt-4 border-b border-border bg-background/85 backdrop-blur",children:e.jsxs("div",{className:"mx-auto flex w-full max-w-5xl items-center justify-between px-4 py-3 sm:px-5",children:[e.jsxs("button",{type:"button",onClick:()=>t("/me"),className:"flex items-center gap-3 rounded-2xl p-1 pr-2 transition-colors hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Open profile",children:[e.jsx("span",{className:"relative inline-flex h-10 w-10 overflow-hidden rounded-full ring-2 ring-primary/20",children:i?.avatarUrl?e.jsx("img",{src:i.avatarUrl,alt:he||"Profile",className:"h-full w-full object-cover"}):e.jsx("span",{className:"grid h-full w-full place-items-center bg-muted text-[10px] font-semibold text-foreground",children:ce(i?.displayName,i?.username)})}),e.jsxs("span",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:Le}),e.jsx("span",{className:"text-lg font-bold leading-none tracking-tight text-foreground",children:he||""})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{icon:"search",label:"Search",onClick:()=>t("/search")}),e.jsx(ue,{icon:"refresh",label:"Refresh",onClick:Pe}),e.jsx(ue,{icon:"notifications",label:"Notifications",onClick:()=>{const s=new Date().toISOString();try{localStorage.setItem(ee,s)}catch{}m(s),t("/activity")},badgeCount:u})]})]})}),e.jsxs("section",{children:[e.jsx("div",{className:"px-4 pb-2",children:e.jsx("h3",{className:"text-xs font-bold tracking-wider text-muted-foreground/80",children:"HAPPENING NOW"})}),e.jsxs("div",{className:"no-scrollbar flex w-full gap-4 overflow-x-auto px-4 py-1",children:[e.jsxs("button",{type:"button",onClick:()=>t("/me?createHighlight=1"),className:"flex min-w-[72px] flex-col items-center gap-2","aria-label":"Add new highlight",children:[e.jsx("span",{className:"grid h-16 w-16 place-items-center rounded-full border-2 border-dashed border-muted-foreground/50",children:e.jsx(j,{name:"add",className:"text-[22px] text-muted-foreground"})}),e.jsx("span",{className:"w-[72px] truncate text-center text-xs font-medium text-muted-foreground",children:"Add New"})]}),h?Array.from({length:5}).map((s,n)=>e.jsxs("div",{className:"flex min-w-[72px] flex-col items-center gap-2",children:[e.jsx("div",{className:"h-16 w-16 animate-pulse rounded-full bg-muted"}),e.jsx("div",{className:"h-3 w-16 animate-pulse rounded bg-muted"})]},`story-skel-${n}`)):ve.length?ve.map(s=>{const n=s.displayName||s.username||"Someone",x=s.listName||"",P=s.listId?`/lists/${s.listId}`:s.username?`/u/${s.username}`:"/me",le=x?`${n} • ${x}`:n;return e.jsxs("button",{type:"button",onClick:()=>t(P),className:"flex w-[92px] shrink-0 flex-col items-center gap-2","aria-label":le,children:[e.jsx("span",{className:"rounded-full bg-gradient-to-tr from-primary to-fuchsia-400 p-[2px]",children:e.jsxs("span",{className:"relative inline-flex h-[68px] w-[68px] items-center justify-center overflow-hidden rounded-full border-2 border-background bg-muted",children:[s.coverPosterUrl?e.jsx("img",{src:s.coverPosterUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover"}):s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover"}):e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:ce(s.displayName,s.username)}),e.jsx("span",{className:"absolute inset-0 bg-gradient-to-t from-black/55 via-black/10 to-transparent"}),e.jsx("span",{className:"absolute bottom-0 right-0 inline-flex h-8 w-8 overflow-hidden rounded-full border-2 border-background bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("span",{className:"grid h-full w-full place-items-center text-[10px] font-semibold text-muted-foreground",children:ce(s.displayName,s.username)})})]})}),e.jsxs("span",{className:"w-[92px]",children:[e.jsx("span",{className:"block truncate text-center text-xs font-semibold text-foreground",children:n}),x?e.jsx("span",{className:"block truncate text-center text-[10px] text-muted-foreground",children:x}):null]})]},`${s.userId}:${s.listId??"none"}`)}):e.jsx("div",{className:"flex items-center text-xs text-muted-foreground",children:"Follow people to see highlights."})]})]}),e.jsx("section",{className:"px-4",children:e.jsxs("div",{className:"group relative overflow-hidden rounded-3xl bg-card shadow-lg",children:[e.jsx("div",{className:"absolute inset-0 bg-cover bg-center",style:ae?{backgroundImage:`url(${ae})`}:void 0,"aria-hidden":!0}),ae?null:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/35 via-background/30 to-primary/55"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/35 to-transparent"}),e.jsxs("div",{className:"relative z-10 flex min-h-[420px] flex-col justify-end p-5",children:[e.jsxs("div",{className:"mb-2 inline-flex items-center gap-2",children:[e.jsx("span",{className:"rounded-full bg-white/15 px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider text-white backdrop-blur",children:"Top Pick"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:Ce||W||K?"Couldn't load recommendations":w?.why??"Recommended for you"})]}),e.jsx("h2",{className:"mb-2 text-3xl font-bold leading-tight tracking-tight text-white",children:a&&!f?.title&&(Se||re||se)?e.jsx("span",{className:"block h-10 w-2/3 animate-pulse rounded bg-white/15"}):f?.title?f.title:a?"":"Sign in to get recommendations"}),pe?e.jsx("p",{className:"mb-4 line-clamp-2 text-sm text-white/80",children:pe}):null,e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>{f?.id?t(`/title/${f.id}`):t("/search")},className:ye("flex h-12 flex-1 items-center justify-center gap-2 rounded-full bg-primary text-base font-bold text-primary-foreground shadow-lg","transition-all hover:bg-primary/90 active:scale-[0.98]"),disabled:!f?.id,children:[e.jsx(j,{name:"play_arrow",filled:!0,className:"text-[20px]",ariaLabel:"Play"}),"View"]}),e.jsxs("button",{type:"button",onClick:()=>be(!0),className:ye("flex h-12 w-32 items-center justify-center gap-1 rounded-full bg-white/10 text-white shadow-lg backdrop-blur","transition-colors hover:bg-white/20"),children:[e.jsx(j,{name:"add",className:"text-[22px]",ariaLabel:"Add"}),e.jsx("span",{className:"text-sm font-bold",children:"Add"})]}),f?.id?e.jsx("div",{className:"shrink-0",children:_(f)}):null]})]})]})}),a?e.jsxs("section",{className:"mt-6",children:[e.jsx(J,{title:"Continue Watching",actionLabel:"Diary",onAction:()=>t("/diary")}),e.jsx("div",{className:"no-scrollbar flex gap-4 overflow-x-auto px-4 pb-1",children:S?Array.from({length:8}).map((s,n)=>e.jsxs("div",{className:"w-32 shrink-0",children:[e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"}),e.jsx("div",{className:"mt-2 h-3 w-3/4 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-1/2 animate-pulse rounded bg-muted"})]},`cw-skel-${n}`)):U.length?U.map(s=>e.jsx("div",{className:"w-32 shrink-0",children:e.jsx(X,{item:s,onClick:()=>t(`/title/${s.id}`),menu:_(s)})},`cw-${s.id}`)):e.jsxs("div",{className:"w-full rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:["Mark a show or movie as ",e.jsx("span",{className:"font-semibold",children:"Watching"})," to see it here."]})})]}):null,a?e.jsxs("section",{className:"mt-6",children:[e.jsx(J,{title:"Up Next",actionLabel:"Watchlist",onAction:()=>t("/diary")}),e.jsx("div",{className:"no-scrollbar flex gap-4 overflow-x-auto px-4 pb-1",children:S?Array.from({length:8}).map((s,n)=>e.jsxs("div",{className:"w-32 shrink-0",children:[e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"}),e.jsx("div",{className:"mt-2 h-3 w-3/4 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-1/2 animate-pulse rounded bg-muted"})]},`upnext-skel-${n}`)):A.length?A.map(s=>e.jsx("div",{className:"w-32 shrink-0",children:e.jsx(X,{item:s,onClick:()=>t(`/title/${s.id}`),menu:_(s)})},`upnext-${s.id}`)):e.jsxs("div",{className:"w-full rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:["Add titles to your ",e.jsx("span",{className:"font-semibold",children:"Watchlist"})," to build your queue."]})})]}):null,e.jsxs("section",{children:[e.jsx(J,{title:"Trending Now",onAction:()=>t("/search")}),e.jsx("div",{className:"px-4",children:K?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:K?.message?String(K.message):"Couldn't load trending titles."}):se?e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-3xl bg-muted"}):G?e.jsx(_e,{item:G,onClick:()=>t(`/title/${G.id}`),menu:_(G)}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"No trending titles yet."})}),e.jsx("div",{className:"grid grid-cols-2 gap-x-4 gap-y-6 px-4 pt-6 sm:grid-cols-3",children:se?Array.from({length:6}).map((s,n)=>e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"},`trending-skel-${n}`)):De.map(s=>e.jsx(X,{item:s,onClick:()=>t(`/title/${s.id}`),menu:_(s)},s.id))})]}),e.jsxs("section",{className:"px-4",children:[e.jsx("h2",{className:"pb-2 text-xl font-bold tracking-tight text-foreground",children:"Friends' Activity"}),$?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:$}):null,F?e.jsx(ft,{}):p.length?e.jsxs("div",{className:"space-y-3",children:[p.slice(0,ne).map(s=>e.jsx(pt,{item:s},s.id)),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[p.length>ne||B?e.jsx("button",{type:"button",onClick:()=>{const s=ne+3;if(s<=p.length){ie(s);return}B&&!M&&(q(),ie(s))},className:"inline-flex items-center justify-center rounded-full bg-white/5 px-4 py-2 text-xs font-bold text-foreground ring-1 ring-border/50 transition hover:bg-white/10 disabled:opacity-60",disabled:M,children:M?"Loading…":"Load more"}):null,e.jsx("button",{type:"button",onClick:()=>t("/activity"),className:"inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-xs font-bold text-primary-foreground transition hover:bg-primary/90",children:"See all"})]})]}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"Your friends’ activity will show up here once they start rating, reviewing, or marking titles watched."}),"      "]}),e.jsxs("section",{children:[e.jsx(J,{title:fe?`Because you watched ${fe}`:"More for you",onAction:()=>{t(L?`/title/${L}`:"/search")}}),e.jsx("div",{className:"px-4",children:W?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:W?.message?String(W.message):"Couldn't load recommendations."}):re?e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-3xl bg-muted"}):Y?e.jsx(_e,{item:Y,onClick:()=>t(`/title/${Y.id}`),menu:_(Y)}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"No recommendations yet."})}),e.jsx("div",{className:"grid grid-cols-2 gap-x-4 gap-y-6 px-4 pt-6 pb-2 sm:grid-cols-3",children:re?Array.from({length:6}).map((s,n)=>e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"},`because-skel-${n}`)):Ue.map(s=>e.jsx(X,{item:s,onClick:()=>t(`/title/${s.id}`),menu:_(s)},s.id))})]}),e.jsx(it,{open:Ae,onOpenChange:be})]})};export{Dt as default};
