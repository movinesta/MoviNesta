import{c as ue,s as A,r as i,b as O,p as Xt,D as de,h as fe,i as Ie,E as ze,G as Zt,H as es,I as ts,J as ss,R as se,j as a,m as ns,z as Q,B as F,y as rs,u as as,l as os,L as is}from"./index-DwnuloBv.js";import{c as me,M as Ee,m as ge,a as ls,s as cs,i as We,b as Ge,d as Je,e as Ve,f as ds,g as us,h as fs,n as ms,j as gs,k as Ye,r as Xe,l as ps,o as Ze,p as hs,C as xs,q as ys,P as bs,t as vs,v as ws,S as Ms,T as et,D as tt,w as st,x as nt,y as rt,z as at,A as ot,B as Rs,u as Ss,E as Cs,F as Ns,G as js,H as Is}from"./dialog-CKUJMV_w.js";import{u as _e}from"./useMutation-DKHT9dyE.js";import{Y as Es}from"./index-CMqS6xLq.js";import{B as _s}from"./bell-cNPGPXYN.js";import{C as Ts}from"./circle-alert-BYMzNc5s.js";import"./index-DNaqzluz.js";import"./users-DG0f3SAW.js";import"./format-DWLSBLoY.js";const ks=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Ds=ue("arrow-down",ks);const Ls=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],As=ue("camera",Ls);const Ps=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Fs=ue("send",Ps);const Bs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Us=ue("smile",Bs),je=new Map,Os=e=>{const t=je.get(e);if(t)return t;const s=A.channel(`conversation-db-${e}`),n={conversationId:e,channel:s,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return s.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageInsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.messageUpdateListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.readReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.deliveryReceiptUpsertListeners)l(o)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionUpsertListeners)l(o)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${e}`},r=>{const o=r;for(const l of n.reactionDeleteListeners)l(o)}),s.subscribe(r=>{const o=r;n.lastStatus=o;for(const l of n.statusListeners)l(o)}),je.set(e,n),n},qs=(e,t)=>{const s=Os(e);s.refCount+=1;const n=[];return t.onStatus&&(s.statusListeners.add(t.onStatus),n.push(()=>s.statusListeners.delete(t.onStatus)),s.lastStatus&&t.onStatus(s.lastStatus)),t.onMessageInsert&&(s.messageInsertListeners.add(t.onMessageInsert),n.push(()=>s.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(s.messageUpdateListeners.add(t.onMessageUpdate),n.push(()=>s.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(s.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),n.push(()=>s.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(s.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),n.push(()=>s.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(s.reactionUpsertListeners.add(t.onReactionUpsert),n.push(()=>s.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(s.reactionDeleteListeners.add(t.onReactionDelete),n.push(()=>s.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const r of n)r();if(s.refCount-=1,s.refCount<=0){try{A.removeChannel(s.channel)}catch{}je.delete(e)}}},pe=(e,t,s)=>{i.useEffect(()=>{if(e)return qs(e,t())},[e,t,...s])},$s=8e3,Hs=2e3,Ks=15e3,zs=e=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:e?Hs:$s,refetchIntervalInBackground:!!e}),Qs=["CHANNEL_ERROR","TIMED_OUT","CLOSED","UNSUBSCRIBED"],Ws=e=>Qs.includes(e)||e!=="SUBSCRIBED",Gs=e=>{const[t,s]=i.useState(!1);i.useEffect(()=>{s(!1)},[e]);const n=i.useCallback(r=>{s(o=>{const l=Ws(r);return o===l?o:l})},[]);return{pollWhenRealtimeDown:t,onStatus:n}},he=e=>{const{pollWhenRealtimeDown:t,onStatus:s}=Gs(e);return{pollWhenRealtimeDown:t,onRealtimeStatus:s,refetchOptions:zs(t)}},Js=e=>typeof e=="object"&&e!==null,it=e=>e.new,Vs=e=>e.old,Y=(e,t)=>{if(!Js(e))return null;const s=e[t];return typeof s=="string"?s:null},lt=(e,t)=>Y(e,"conversation_id")===t,ct=40,ce=1e5,Ys=e=>{const t=e.createdAt,s=e.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${s})`},Xs=e=>{const t=cs((e??[]).map(ge)),s=(e??[]).length>=ct,n=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:s,cursor:n}},Zs=(e,t)=>{const s=O(),n=me(e),[r,o]=i.useState(ce),{pollWhenRealtimeDown:l,onRealtimeStatus:m,refetchOptions:c}=he(e),f=i.useRef(t);i.useEffect(()=>{f.current=t},[t]);const y=i.useRef({pages:0,total:0}),p=Xt({queryKey:n,enabled:!!e,initialPageParam:null,...c,staleTime:Ks,refetchPage:(x,g,w)=>g===w.length-1,queryFn:async({pageParam:x})=>{if(!e)return{items:[],hasMore:!1,cursor:null};let g=A.from("messages").select(Ee).eq("conversation_id",e).order("created_at",{ascending:!1}).order("id",{ascending:!1});x&&(g=g.or(Ys(x)));const{data:w,error:S}=await g.limit(ct);if(S)throw console.error(`[useConversationMessages] Failed to load ${x?"older messages":"messages"}`,S),new Error(S.message);return Xs(w??[])},getNextPageParam:()=>{},getPreviousPageParam:x=>{if(x.hasMore)return x.cursor??void 0}});i.useEffect(()=>{const x=p.data?.pages??[],g=x.reduce((b,R)=>b+R.items.length,0),w=y.current;if(x.length===0){y.current={pages:0,total:0},o(ce);return}if(w.pages===0){y.current={pages:x.length,total:g},o(ce);return}const S=g-w.total,N=x.length-w.pages;S>0&&N>0&&o(b=>Math.max(0,b-S)),y.current={pages:x.length,total:g}},[p.data?.pages]);const v=i.useCallback(()=>{if(!e)return{};const x=(g,w)=>{const S=it(g);if(!lt(S,e)||!Y(S,"id"))return;const b=S,R=ge(b);s.setQueryData(n,M=>ls(M,b)),w==="insert"?f.current?.onInsert?.(R):f.current?.onUpdate?.(R)};return{onStatus:m,onMessageInsert:g=>{x(g,"insert")},onMessageUpdate:g=>{x(g,"update")}}},[e,m,s,n]);pe(e,v,[]),i.useEffect(()=>{o(ce),y.current={pages:0,total:0}},[e]);const u=i.useMemo(()=>(p.data?.pages??[]).flatMap(g=>g.items),[p.data?.pages]),d=i.useCallback(async()=>{e&&p.hasPreviousPage&&await p.fetchPreviousPage()},[e,p]);return i.useMemo(()=>({data:u,isLoading:p.isLoading,isFetching:p.isFetching,isError:p.isError,error:p.error,refetch:p.refetch,loadOlder:d,hasMore:!!p.hasPreviousPage,isLoadingOlder:p.isFetchingPreviousPage,firstItemIndex:r,queryKey:n,pollWhenRealtimeDown:l}),[u,p.isLoading,p.isFetching,p.isError,p.error,p.refetch,d,p.hasPreviousPage,p.isFetchingPreviousPage,r,n,l])};function en(e){const{conversation:t,deliveryReceipts:s,readReceipts:n,currentUserId:r,failedMessages:o,onlyMessageIds:l,messageCreatedAtMsById:m}=e;if(!t||!r)return()=>null;const c=t.participants.filter(u=>!u.isSelf);if(c.length===0)return()=>null;const f=new Set(c.map(u=>u.id)),y=u=>{if(!u)return null;const d=m?.get(u);return d??null},p=new Map;for(const u of n??[]){let d=null;if(u.lastReadMessageId){const g=y(u.lastReadMessageId);g!=null&&(d=g)}if(d==null&&u.lastReadAt){const g=new Date(u.lastReadAt).getTime();Number.isNaN(g)||(d=g)}if(d==null)continue;const x=p.get(u.userId);(x==null||d>x)&&p.set(u.userId,d)}const v=new Map;for(const u of s??[]){if(!f.has(u.userId)||l&&!l.has(u.messageId))continue;let d=v.get(u.messageId);d||(d=new Set,v.set(u.messageId,d)),d.add(u.userId)}return u=>{if(u.senderId!==r)return null;if(o[u.id])return{status:"failed"};if(We(u.id))return{status:"sending"};const d=(()=>{const S=new Date(u.createdAt??"").getTime();return Number.isNaN(S)?0:S})();let x=0,g=null;for(const S of c){const N=p.get(S.id);N!=null&&N>=d&&(x+=1,(g===null||N>g)&&(g=N))}return x===c.length&&c.length>0?{status:"seen",seenAt:g!=null?new Date(g).toISOString():null}:(v.get(u.id)?.size??0)===c.length&&c.length>0?{status:"delivered"}:{status:"sent"}}}function tn(e){const{messages:t,conversation:s,currentUserId:n,participantsById:r,reactionsByMessageId:o,hiddenMessageIds:l,deliveryReceipts:m,readReceipts:c,failedMessages:f,lastOwnMessageId:y}=e,p=i.useMemo(()=>{if(!t)return[];const u=new Set;y&&u.add(y);for(const g of Object.keys(f))u.add(g);const d=new Map;for(const g of t){const w=new Date(g.createdAt??"").getTime();Number.isNaN(w)||d.set(g.id,w)}const x=en({conversation:s??null,deliveryReceipts:m,readReceipts:c,currentUserId:n,failedMessages:f,onlyMessageIds:u,messageCreatedAtMsById:d});return t.map(g=>{const w=de(g.body),S=r.get(g.senderId)??null,N=S?.isSelf??(n!=null&&g.senderId===n),b=N&&u.has(g.id)?x(g):null,R=!!b&&N&&!w.deleted&&(b.status==="failed"||y===g.id);return{message:g,meta:w,sender:S,isSelf:N,deliveryStatus:b,showDeliveryStatus:R,reactions:o.get(g.id)??[]}})},[s,n,m,f,y,t,r,o,c]),v=i.useMemo(()=>p.filter(({message:u})=>!l[u.id]),[p,l]);return{uiMessages:p,visibleMessages:v}}function sn(e){const{messages:t,currentUserId:s,hiddenMessageIds:n}=e;return i.useMemo(()=>{if(!t||!s)return null;for(let r=t.length-1;r>=0;r-=1){const o=t[r];if(!(n[o.id]||o.senderId!==s||de(o.body).deleted))return o.id}return null},[n,t,s])}const nn=async e=>{const{data:t,error:s}=await A.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",e).order("last_read_at",{ascending:!1}).returns();if(s)throw console.error("[useConversationReadReceipts] Failed to load",s),new Error(s.message);return(t??[]).map(Je)},rn=async(e,t)=>{if(t.length===0)return[];const s=A.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",e).in("message_id",t),{data:n,error:r}=await s.order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationDeliveryReceipts] Failed to load",r),new Error(r.message);return(n??[]).map(Ve)},an=async e=>{const{data:t,error:s}=await A.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",e).order("created_at",{ascending:!0}).returns();if(s)throw console.error("[useConversationReactions] Failed to load reactions",s),new Error(s.message);return(t??[]).map(Ge)},on=(e,t)=>{const s=new Map,n=new Map;for(const o of e){let l=s.get(o.messageId);l||(l=new Map,s.set(o.messageId,l),n.set(o.messageId,[]));let m=l.get(o.emoji);m||(m={emoji:o.emoji,count:0,reactedBySelf:!1},l.set(o.emoji,m),n.get(o.messageId).push(o.emoji)),m.count+=1,t&&o.userId===t&&(m.reactedBySelf=!0)}const r=new Map;for(const[o,l]of s.entries()){const m=n.get(o)??[];r.set(o,m.map(c=>l.get(c)).filter(Boolean))}return r},ln=(e,t,s)=>{const n=e??[],r=s.key(t),o=[...n],l=o.findIndex(m=>s.key(m)===r);return l>=0?o[l]=t:o.push(t),s.sort&&o.sort(s.sort),o},cn=(e,t,s)=>{const n=e??[];return n.length===0?[]:n.filter(r=>s.key(r)!==t)},Te=e=>t=>{const s=it(t);if(!lt(s,e.conversationId)||e.extraGuard&&!e.extraGuard(s)||!(e.getRequiredId?e.getRequiredId(s):Y(s,"id")))return;const r=s,o=e.mapRow(r);e.queryClient.setQueryData(e.queryKey,l=>ln(l,o,{key:e.key,sort:e.sort}))},dn=e=>t=>{const s=Vs(t),n=e.getRowId?e.getRowId(s):Y(s,"id");if(!n){e.invalidateWhenMissingId!==!1&&e.queryClient.invalidateQueries({queryKey:e.queryKey});return}e.queryClient.setQueryData(e.queryKey,r=>cn(r,n,{key:e.key}))},un=e=>{const{user:t}=fe(),s=t?.id??null,n=O(),r=ds(e),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:m}=he(e),c=Ie({queryKey:r,enabled:!!e,...m,queryFn:()=>e?an(e):Promise.resolve([])}),f=i.useCallback(()=>{if(!e)return{};const v=Te({conversationId:e,queryClient:n,queryKey:r,mapRow:Ge,key:d=>d.id,sort:(d,x)=>{const g=ze(d.createdAt),w=ze(x.createdAt);return g!==w?g-w:d.id.localeCompare(x.id)}}),u=dn({queryClient:n,queryKey:r,key:d=>d.id});return{onStatus:l,onReactionUpsert:v,onReactionDelete:u}},[e,l,n,r]);pe(e,f,[]);const y=_e({mutationFn:async({messageId:v,emoji:u})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to react to messages.");const{error:d}=await A.from("message_reactions").insert({conversation_id:e,message_id:v,user_id:s,emoji:u});if(d){if(d?.code==="23505"){const{error:x}=await A.from("message_reactions").delete().eq("conversation_id",e).eq("message_id",v).eq("user_id",s).eq("emoji",u);if(x)throw console.error("[useConversationReactions] Failed to remove reaction",x),x;return}throw console.error("[useConversationReactions] Failed to toggle reaction",d),d}},onMutate:async({messageId:v,emoji:u})=>{if(!e||!s)return{previousReactions:void 0};await n.cancelQueries({queryKey:r});const d=n.getQueryData(r);return n.setQueryData(r,x=>{const g=x??[],w=g.findIndex(N=>N.messageId===v&&N.userId===s&&N.emoji===u);if(w>=0){const N=[...g];return N.splice(w,1),N}const S={id:us(),conversationId:e,messageId:v,userId:s,emoji:u,createdAt:new Date().toISOString()};return[...g,S]}),{previousReactions:d}},onError:(v,u,d)=>{e&&(d?.previousReactions?n.setQueryData(r,d.previousReactions):n.invalidateQueries({queryKey:r}))},onSuccess:()=>{e&&n.invalidateQueries({queryKey:r})}}),p=i.useMemo(()=>{const v=c.data??[];return on(v,s)},[c.data,s]);return{reactions:c.data??[],reactionsByMessageId:p,isLoadingReactions:c.isLoading,toggleReaction:y,pollWhenRealtimeDown:o,queryKey:r}},fn=e=>{const t=O(),s=fs(e),{pollWhenRealtimeDown:n,onRealtimeStatus:r,refetchOptions:o}=he(e),l=Ie({queryKey:s,enabled:!!e,...o,queryFn:async()=>e?nn(e):[]}),m=i.useCallback(()=>{if(!e)return{};const c=Te({conversationId:e,queryClient:t,queryKey:s,mapRow:Je,key:f=>f.userId,getRequiredId:f=>Y(f,"user_id"),sort:(f,y)=>{const p=!f.lastReadAt,v=!y.lastReadAt;if(p&&v)return 0;if(p)return 1;if(v)return-1;const u=new Date(f.lastReadAt).getTime(),d=new Date(y.lastReadAt).getTime();return Number.isNaN(u)&&Number.isNaN(d)?0:Number.isNaN(u)?1:Number.isNaN(d)?-1:d-u}});return{onStatus:r,onReadReceiptUpsert:c}},[e,r,t,s]);return pe(e,m,[]),i.useMemo(()=>({...l,pollWhenRealtimeDown:n,queryKey:s}),[l,n,s])},mn=(e,t)=>{const s=O(),n=i.useMemo(()=>ms(t,{excludeTemp:!0,sort:!0}),[t]),r=gs(e,n),{pollWhenRealtimeDown:o,onRealtimeStatus:l,refetchOptions:m}=he(e),c=Ie({queryKey:r,enabled:!!(e&&n.length>0),...m,queryFn:async()=>e?n.length===0?[]:rn(e,n):[]}),f=i.useCallback(()=>{if(!e)return{};if(n.length===0)return{};const p=new Set(n),v=Te({conversationId:e,queryClient:s,queryKey:r,mapRow:Ve,key:u=>u.id,extraGuard:u=>{const d=Y(u,"message_id");return!!(d&&p.has(d))},sort:(u,d)=>{const x=new Date(u.deliveredAt??"").getTime(),g=new Date(d.deliveredAt??"").getTime(),w=Number.isNaN(x)?0:x,S=Number.isNaN(g)?0:g;return w-S}});return{onStatus:l,onDeliveryReceiptUpsert:v}},[e,n,l,s,r]),y=e&&n.length>0?e:null;return pe(y,f,[]),i.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},gn=3e3,pn=2e3,hn=5e3,xn=e=>{const{conversationId:t,userId:s,displayName:n}=e,[r,o]=i.useState({}),l=i.useRef(null),m=i.useRef(new Map),c=i.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),f=i.useCallback(async u=>{if(!t||!s||!n)return;const d=l.current;d&&await d.send({type:"broadcast",event:"typing",payload:{userId:s,displayName:n,isTyping:u}})},[t,s,n]),y=i.useCallback(async()=>{c.current.timeoutId!=null&&(window.clearTimeout(c.current.timeoutId),c.current.timeoutId=null),c.current.isTyping&&(c.current.isTyping=!1,c.current.lastSentAtMs=0,await f(!1))},[f]),p=i.useCallback(u=>{if(!t||!s||!n||!l.current)return;const x=c.current.isTyping;if(u){const g=Date.now();x?g-c.current.lastSentAtMs>pn&&(c.current.lastSentAtMs=g,f(!0)):(c.current.isTyping=!0,c.current.lastSentAtMs=g,f(!0)),c.current.timeoutId!=null&&window.clearTimeout(c.current.timeoutId),c.current.timeoutId=window.setTimeout(()=>{c.current.isTyping=!1,c.current.lastSentAtMs=0,c.current.timeoutId=null,f(!1)},gn);return}x&&y()},[f,t,n,y,s]);return i.useEffect(()=>{if(!t)return;const u=A.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});l.current=u,u.on("broadcast",{event:"typing"},({payload:g})=>{const w=g;if(!w?.userId||s&&w.userId===s)return;o(N=>{const b={...N};return w.isTyping&&w.displayName?b[w.userId]=w.displayName:delete b[w.userId],b});const S=m.current.get(w.userId);if(S!=null&&window.clearTimeout(S),w.isTyping){const N=window.setTimeout(()=>{o(b=>{const R={...b};return delete R[w.userId],R}),m.current.delete(w.userId)},hn);m.current.set(w.userId,N)}else m.current.delete(w.userId)}).subscribe();const d=()=>{document.visibilityState==="hidden"&&y()},x=()=>{y()};return document.addEventListener("visibilitychange",d),window.addEventListener("beforeunload",x),window.addEventListener("pagehide",x),window.addEventListener("blur",x),()=>{document.removeEventListener("visibilitychange",d),window.removeEventListener("beforeunload",x),window.removeEventListener("pagehide",x),window.removeEventListener("blur",x),m.current.forEach(g=>window.clearTimeout(g)),m.current.clear(),y(),l.current&&(A.removeChannel(l.current),l.current=null)}},[t,y,s]),{remoteTypingUsers:i.useMemo(()=>Object.values(r),[r]),noteLocalInputActivity:p,stopTyping:y}},yn=e=>{const{conversationId:t,storageKeyPrefix:s="messages:draft:",hydrate:n,debounceMs:r=250}=e,[o,l]=i.useState("");return i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.localStorage.getItem(c);f!=null&&f!==o&&(l(f),n?.(f))},[t]),i.useEffect(()=>{if(!t)return;const c=`${s}${t}`,f=window.setTimeout(()=>{o.trim().length===0?window.localStorage.removeItem(c):window.localStorage.setItem(c,o)},r);return()=>window.clearTimeout(f)},[t,r,o,s]),{draft:o,setDraft:l,clearDraft:()=>l("")}};function bn({showComposer:e,initialHeaderHeight:t=72,initialComposerHeight:s=160}){const n=i.useRef(null),[r,o]=i.useState(t),[l,m]=i.useState(s),[c,f]=i.useState(!0),[y,p]=i.useState(!1),v=i.useCallback(u=>m(Math.max(u,r)),[r]);return i.useEffect(()=>{const u=n.current;if(!u)return;const d=()=>o(Math.max(u.getBoundingClientRect().height,0));if(d(),typeof ResizeObserver>"u")return;const x=new ResizeObserver(d);return x.observe(u),()=>x.disconnect()},[]),i.useEffect(()=>{m(u=>Math.max(u,r))},[r]),i.useEffect(()=>{e||m(0)},[e]),{headerRef:n,headerHeight:r,composerHeight:l,isAtBottom:c,setIsAtBottom:f,handleComposerHeightChange:v,showEmojiPicker:y,setShowEmojiPicker:p}}const vn=({conversationId:e,currentUserId:t,showComposer:s,isBlocked:n,blockedYou:r,composerTextareaRef:o})=>{const[l,m]=i.useState(null),[c,f]=i.useState({}),[y,p]=i.useState(null),[v,u]=i.useState(null),[d,x]=i.useState(null),g=i.useRef(null),w=i.useRef(null);i.useEffect(()=>{if(!e||!t){f({});return}if(typeof window>"u")return;const E=`messages:hidden:${t}:${e}`;try{const k=window.localStorage.getItem(E);if(!k){f({});return}const P=JSON.parse(k);if(Array.isArray(P)){const _={};for(const j of P)typeof j=="string"&&j&&(_[j]=!0);f(_);return}if(P&&typeof P=="object"){const _={};for(const[j,D]of Object.entries(P))D&&(_[j]=!0);f(_);return}f({})}catch{f({})}},[e,t]),i.useEffect(()=>{if(!e||!t||typeof window>"u")return;const E=`messages:hidden:${t}:${e}`;try{const k=Object.keys(c).filter(P=>c[P]);window.localStorage.setItem(E,JSON.stringify(k))}catch{}},[e,t,c]);const S=i.useCallback(()=>{m(null)},[]),N=i.useCallback(E=>{n||r||de(E.body).deleted||(m(E.id),o.current?.blur())},[r,o,n]),b=i.useCallback((E,k)=>{n||r||de(E.body).deleted||(k&&(w.current=k),u({messageId:E.id,text:Zt(E.body)??"",body:E.body??null,attachmentUrl:E.attachmentUrl??null}),x(null),S(),o.current?.blur())},[r,S,o,n]),R=i.useCallback(E=>{u(k=>k&&{...k,text:E})},[]),M=i.useCallback(()=>{u(null),x(null),w.current?.focus()},[]);i.useEffect(()=>{v&&queueMicrotask(()=>{g.current?.focus()})},[v]);const I=i.useCallback(E=>{n||r||(S(),p({messageId:E.id,attachmentUrl:E.attachmentUrl??null}),o.current?.blur())},[r,S,o,n]),T=i.useCallback(()=>{p(null)},[]),q=i.useCallback(E=>{f(k=>({...k,[E]:!0}))},[]);return i.useEffect(()=>{l===null&&s&&(v||y||queueMicrotask(()=>o.current?.focus()))},[l,y,v,s,o]),{activeActionMessageId:l,openMessageActions:N,closeMessageActions:S,hiddenMessageIds:c,hideMessageForMe:q,deleteDialog:y,openDeleteDialog:I,closeDeleteDialog:T,editingMessage:v,openEditDialog:b,updateEditingText:R,closeEditDialog:M,editTextareaRef:g,editError:d,setEditError:x}},dt=e=>e.code==="42P10"||/no unique or exclusion constraint matching the ON CONFLICT specification/i.test(e.message??""),ut=e=>e.code==="23505"||/duplicate key value violates unique constraint/i.test(e.message??"");let Ce=null,Ne=null;const wn=async e=>{if(Ce!==!1){const{error:s}=await A.from("message_delivery_receipts").upsert(e,{onConflict:"conversation_id,message_id,user_id"});if(!s){Ce=!0;return}if(dt(s))Ce=!1;else{console.error("[writeDeliveryReceipt] Failed to write delivery receipt",s);return}}const{error:t}=await A.from("message_delivery_receipts").insert(e);t&&!ut(t)&&console.error("[writeDeliveryReceipt] Failed to insert delivery receipt",t)},Mn=async e=>{if(Ne!==!1){const{error:s}=await A.from("message_read_receipts").upsert(e,{onConflict:"conversation_id,user_id"});if(!s){Ne=!0;return}if(dt(s))Ne=!1;else{console.error("[writeReadReceipt] Failed to write read receipt",s);return}}const{error:t}=await A.from("message_read_receipts").insert(e);t&&!ut(t)&&console.error("[writeReadReceipt] Failed to insert read receipt",t)},Qe=3e3;function Rn(e){const{conversationId:t,userId:s,isAtBottom:n,messages:r}=e,o=O(),l=i.useRef({conversationId:null,messageId:null,userId:null}),m=i.useRef({lastSentAt:0,timeoutId:null,pending:null});i.useEffect(()=>{l.current={conversationId:null,messageId:null,userId:null};const c=m.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null,c.pending=null,c.lastSentAt=0},[t,s]),i.useEffect(()=>()=>{const c=m.current;c.timeoutId!=null&&window.clearTimeout(c.timeoutId),c.timeoutId=null},[]),i.useEffect(()=>{if(!t||!r||r.length===0||!s||!n)return;const c=r[r.length-1];if(We(c.id)||l.current.conversationId===t&&l.current.messageId===c.id&&l.current.userId===s)return;const f=m.current,y=Date.now(),p=f.lastSentAt?y-f.lastSentAt:Number.POSITIVE_INFINITY,v=()=>{Ye(o,t,d=>d.hasUnread?{...d,hasUnread:!1}:d)},u=d=>{f.lastSentAt=Date.now();const x=new Date().toISOString();Mn({conversation_id:t,user_id:s,last_read_message_id:d,last_read_at:x}).then(()=>{l.current={conversationId:t,messageId:d,userId:s},v()}).catch(g=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",g)})};if(p<Qe){f.pending={conversationId:t,userId:s,messageId:c.id},f.timeoutId==null&&(f.timeoutId=window.setTimeout(()=>{const d=m.current.pending;m.current.pending=null,m.current.timeoutId=null,d&&(l.current.conversationId===d.conversationId&&l.current.messageId===d.messageId&&l.current.userId===d.userId||d.conversationId!==t||d.userId!==s||u(d.messageId))},Math.max(Qe-p,0)));return}f.timeoutId!=null&&(window.clearTimeout(f.timeoutId),f.timeoutId=null,f.pending=null),u(c.id)},[t,r,s,o,n])}const Sn=e=>{const{user:t}=fe(),s=t?.id??null,n=O();return _e({mutationFn:async({messageId:r,text:o,currentBody:l,attachmentUrl:m})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to edit messages.");if(m)throw new Error("Cannot edit messages with attachments.");const c=es(l,o),{data:f,error:y}=await A.from("messages").update({body:c}).eq("id",r).eq("user_id",s).select(Ee).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return ge(f)},onSuccess:r=>{if(!e)return;const o=me(e);n.setQueryData(o,l=>Xe(l,r))}})},Cn=e=>{const{user:t}=fe(),s=t?.id??null,n=O();return _e({mutationFn:async({messageId:r,attachmentUrl:o})=>{if(!e)throw new Error("Missing conversation id.");if(!s)throw new Error("You must be signed in to delete messages.");const m={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},c=JSON.stringify(m),{data:f,error:y}=await A.from("messages").update({body:c,attachment_url:null}).eq("id",r).eq("user_id",s).select(Ee).single();if(y)throw console.error("[useDeleteMessage] Failed to delete message",y),new Error(y.message);if(o)try{await Ze(o)}catch(v){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",v)}return ge(f)},onSuccess:r=>{if(!e)return;const o=me(e);n.setQueryData(o,l=>Xe(l,r)),n.invalidateQueries({queryKey:ps})}})};function Nn(e){const{conversationId:t,setDraft:s,messages:n}=e,r=O(),[o,l]=i.useState(null),[m,c]=i.useState(null),[f,y]=i.useState(null),[p,v]=i.useState({}),u=i.useRef({});i.useEffect(()=>{u.current=p},[p]),i.useEffect(()=>{l(null),c(null),y(null),v({}),u.current={}},[t]),i.useEffect(()=>()=>{const b=Object.values(u.current),R=Array.from(new Set(b.map(M=>M.attachmentPath).filter(M=>typeof M=="string"&&M.length>0&&!hs(M))));R.length!==0&&A.storage.from(xs).remove(R).then(({error:M})=>{M&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",M)}).catch(M=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",M)})},[t]),i.useEffect(()=>{n&&v(b=>{const R=new Set(n.map(T=>T.id));let M=!1;const I={...b};for(const T of Object.keys(I))R.has(T)||(delete I[T],M=!0);return M?I:b})},[n]);const d=i.useCallback(()=>{l(null),c(null),y(null)},[]),x=i.useCallback((b,R)=>{l("Couldn't send. Please try again."),R.text.trim()&&s(R.text),c(R),y(b),v(M=>({...M,[b]:R}))},[s]),g=i.useCallback(b=>{b&&(v(R=>{if(!(b in R))return R;const M={...R};return delete M[b],M}),b===f&&d())},[d,f]),w=i.useCallback(()=>{if(!m)return null;const b=f;return b&&v(R=>{if(!(b in R))return R;const M={...R};return delete M[b],M}),d(),{payload:m,tempId:b}},[d,m,f]),S=i.useCallback(b=>{const R=p[b];return R?(v(M=>{if(!(b in M))return M;const I={...M};return delete I[b],I}),b===f?d():l(null),R):null},[d,p,f]),N=i.useCallback(async b=>{if(!t)return;const R=p[b];if(!R)return;const M=me(t);if(r.setQueryData(M,I=>ys(I,b)),v(I=>{if(!(b in I))return I;const T={...I};return delete T[b],T}),b===f&&d(),R.attachmentPath)try{await Ze(R.attachmentPath)}catch(I){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",I)}},[d,t,p,f,r]);return{sendError:o,setSendError:l,lastFailedPayload:m,lastFailedTempId:f,failedMessages:p,clearBannerState:d,onSendFailed:x,onSendRecovered:g,consumeLastFailedForRetry:w,consumeFailedMessageForRetry:S,discardFailedMessage:N}}const jn=({currentUserId:e})=>{const t=O();return i.useCallback(s=>{Ye(t,s.conversationId,n=>{const r=!!(e&&s.senderId===e);return{...n,lastMessagePreview:ss(s.body)??n.lastMessagePreview,lastMessageAt:s.createdAt??n.lastMessageAt,lastMessageAtLabel:ts(s.createdAt??null),hasUnread:!r,lastMessageIsFromSelf:r,lastMessageSeenByOthers:r?!1:n.lastMessageSeenByOthers}},{moveToTop:!0}),e&&s.senderId!==e&&wn({conversation_id:s.conversationId,message_id:s.id,user_id:e})},[e,t])},In=({conversationId:e,userId:t,conversation:s,readReceipts:n,visibleMessages:r})=>{const[o,l]=i.useState(void 0),[m,c]=i.useState(void 0);return i.useEffect(()=>{l(void 0),c(void 0)},[e,t]),i.useEffect(()=>{if(!e||!t||o!==void 0)return;const y=(n??[]).find(p=>p.userId===t)??null;l(y?.lastReadMessageId??null)},[e,o,n,t]),i.useEffect(()=>{!e||!t||m===void 0&&s&&c(!!s.hasUnread)},[s,e,m,t]),{firstUnreadIndex:i.useMemo(()=>{if(m===void 0||!m||r.length===0||o===void 0)return null;if(o===null)return 0;const y=r.findIndex(v=>v.message.id===o);if(y<0)return 0;const p=y+1;return p>=r.length?null:p},[m,o,r])}};function En({items:e=[],itemContent:t,isLoading:s,loadingContent:n,errorContent:r,emptyContent:o,footer:l,bottomPadding:m,followOutput:c=!1,onAtBottomChange:f,computeItemKey:y,firstItemIndex:p,onStartReached:v,header:u,ariaLabel:d,autoScrollOnNewLastItem:x,autoScrollBehavior:g,autoScrollEnabled:w=!0,virtuosoRef:S}){const N=S??se.useRef(null),b=Math.max(0,p??0),R=se.useRef(null);return se.useEffect(()=>{if(!x||!w||!e||e.length===0)return;const M=e.length-1,I=e[M],T=y?y(M,I):M,q=R.current;R.current=T,!(q==null||q===T)&&requestAnimationFrame(()=>{N.current?.scrollToIndex({index:b+M,align:"end",behavior:g??"smooth"})})},[g,x,w,b,y,e]),s?a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:n}):r?a.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:r}):e?.length??0?a.jsx("div",{className:"relative flex min-h-0 flex-1 overflow-hidden",role:"log","aria-live":"polite","aria-relevant":"additions text","aria-label":d??"Messages",children:a.jsx(Es,{ref:N,data:e??[],style:{height:"100%",width:"100%"},className:"px-4 pt-6",alignToBottom:!0,followOutput:c,atBottomStateChange:f,startReached:v,increaseViewportBy:400,firstItemIndex:b,computeItemKey:y?(M,I)=>y(M-b,I):void 0,itemContent:(M,I)=>t(M-b,I),components:{Header:()=>u?a.jsx("div",{className:"pt-2",children:u}):null,Footer:()=>a.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",style:{paddingBottom:m??"10rem"},children:l})}})}):a.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:o})}const _n=({show:e,pendingCount:t,onClick:s,shortcutHint:n})=>{if(!e)return null;const r=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(Ds,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Jump to latest"}),t>0&&a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},Tn=({show:e,unreadCount:t,onClick:s,shortcutHint:n})=>{if(!e||t<=0)return null;const r=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return a.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[a.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),a.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:s,"aria-label":r,title:n?`${r} (${n})`:r,children:[a.jsx(_s,{className:"h-4 w-4","aria-hidden":!0}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{children:"Unread"}),a.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},kn=({children:e,className:t,onHeightChange:s,minHeight:n,style:r,...o})=>{const l=se.useRef(null);return se.useEffect(()=>{if(!s||!l.current)return;const m=l.current,c=()=>s(m.getBoundingClientRect().height);c();const f=new ResizeObserver(c);return f.observe(m),()=>f.disconnect()},[s]),a.jsx("div",{ref:l,className:"pointer-events-none fixed inset-x-0 bottom-0 z-40 w-full",children:a.jsx("div",{className:"w-full",children:a.jsx("form",{...o,className:ns("pointer-events-auto flex w-full flex-col gap-2 rounded-3xl border border-border/60 bg-card/85 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.16)] backdrop-blur-xl supports-[backdrop-filter]:bg-card/65","ring-1 ring-black/5",t),style:{minHeight:n,...r},children:e})})})},Dn=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Ln=({show:e,headerHeight:t,onHeightChange:s,typingUsers:n,isGroupConversation:r,draft:o,setDraft:l,textareaRef:m,noteLocalInputActivity:c,stopTyping:f,onSendText:y,isUploadingImage:p,cancelImageUpload:v,sendError:u,canRetrySend:d,onRetrySend:x,uploadError:g,clearUploadError:w,showEmojiPicker:S,setShowEmojiPicker:N,openCameraPicker:b,fileInputRef:R,onImageSelected:M,isSending:I,disableSend:T})=>{const q=i.useCallback(j=>{const D=j.target.value;l(D),S&&N(!1),c(D.trim().length>0);const B=j.target;B.style.height="auto";const $=Math.min(B.scrollHeight,140);B.style.height=`${$}px`},[c,l,N,S]),E=i.useCallback(j=>{j&&(l(D=>{const B=`${D}${j}`;return c(B.trim().length>0),B}),queueMicrotask(()=>{const D=m.current;D&&(D.style.height="auto",D.style.height=`${Math.min(D.scrollHeight,140)}px`)}))},[c,l,m]),k=i.useCallback(j=>{if(j.preventDefault(),T)return;const D=o.trim();D&&(l(""),f(),y(D))},[T,o,y,l,f]);if(!e)return null;const P=T||!o.trim()||I||p,_=p||I||T;return a.jsxs(kn,{onSubmit:k,className:"space-y-3",onHeightChange:s,minHeight:t,children:[n.length>0&&a.jsxs("div",{className:"flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[a.jsx("span",{children:r?n.length===1?`${n[0]} is typingâ€¦`:n.length===2?`${n[0]} and ${n[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),a.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),a.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}),p&&a.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs",children:[a.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Uploading imageâ€¦"})]}),a.jsx(F,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Cancel"})]}),u&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Q,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),d&&a.jsx(F,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Retry"})]}),g&&a.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ts,{className:"h-3.5 w-3.5","aria-hidden":"true"}),a.jsx("p",{className:"font-semibold",children:g})]}),a.jsx(F,{type:"button",size:"sm",variant:"ghost",onClick:w,children:"Dismiss"})]}),a.jsxs("div",{className:"flex w-full items-center gap-2",children:[a.jsxs(bs,{open:S,onOpenChange:N,children:[a.jsx(vs,{asChild:!0,children:a.jsx(F,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",children:a.jsx(Us,{className:"h-4 w-4","aria-hidden":"true"})})}),a.jsx(ws,{side:"top",align:"start",className:"rounded-2xl border border-border/70 bg-popover/95 p-3 shadow-2xl backdrop-blur",children:a.jsx(Ms,{className:"max-h-64",children:a.jsx("div",{className:"grid grid-cols-9 gap-2",children:Dn.map(j=>a.jsx(F,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted",onClick:()=>{E(j),N(!1)},children:a.jsx("span",{children:j})},j))})})})]}),a.jsx(F,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted",onClick:b,"aria-label":"Send photo",disabled:_,"aria-busy":p,children:a.jsx(As,{className:"h-4 w-4","aria-hidden":"true"})}),a.jsx("input",{type:"file",ref:R,accept:"image/*",className:"hidden",onChange:M}),a.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-input/70 bg-muted/40 px-3 py-2 shadow-inner",children:a.jsx(et,{id:"conversation-message",value:o,ref:m,rows:1,autoComplete:"off",onChange:q,onBlur:f,onKeyDown:j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),o.trim()&&j.currentTarget.form?.requestSubmit())},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),a.jsx(F,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full shadow-sm",onMouseDown:j=>j.preventDefault(),onTouchStart:j=>j.preventDefault(),disabled:P,"aria-label":"Send message","aria-busy":I||p,children:I||p?a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):a.jsx(Fs,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},An=({open:e,editingMessage:t,onOpenChange:s,onCancel:n,onTextChange:r,onSave:o,textareaRef:l,error:m,isSaving:c})=>a.jsx(tt,{open:e,onOpenChange:s,children:a.jsxs(st,{children:[a.jsxs(nt,{children:[a.jsx(rt,{children:"Edit message"}),a.jsx(at,{children:"Update your message for everyone in the conversation."})]}),t&&a.jsx(et,{ref:l,value:t.text,onChange:f=>r(f.target.value),rows:3,className:"min-h-[120px]"}),m&&a.jsx("p",{className:"text-xs text-destructive",children:m}),a.jsxs(ot,{className:"gap-2",children:[a.jsx(F,{type:"button",variant:"ghost",onClick:n,children:"Cancel"}),a.jsxs(F,{type:"button",disabled:!t?.text.trim()||c,onClick:o,children:[c&&a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Save"})]})]})]})}),Pn=({open:e,deleteDialog:t,onOpenChange:s,onHideForMe:n,onDeleteForEveryone:r,isDeleting:o})=>a.jsx(tt,{open:e,onOpenChange:s,children:a.jsxs(st,{children:[a.jsxs(nt,{className:"gap-1",children:[a.jsxs(rt,{className:"flex items-center gap-2 text-base",children:[a.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:a.jsx(Rs,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),a.jsx(at,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),a.jsxs(ot,{className:"gap-2",children:[a.jsx(F,{type:"button",variant:"outline",className:"flex-1",onClick:n,disabled:!t,children:"Hide for me"}),a.jsxs(F,{type:"button",variant:"destructive",className:"flex-1",disabled:o||!t,onClick:r,children:[o&&a.jsx(Q,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Delete for everyone"})]})]})]})});function Fn(){const[e,t]=i.useState(!1);return i.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const s=window.matchMedia("(prefers-reduced-motion: reduce)"),n=()=>{t(s.matches)};return n(),typeof s.addEventListener=="function"?(s.addEventListener("change",n),()=>s.removeEventListener("change",n)):(s.addListener(n),()=>s.removeListener(n))},[]),e}const Wn=()=>{const{conversationId:e}=rs(),t=e??null,s=i.useRef(null),n=as(),{user:r}=fe(),{data:o,isLoading:l}=os(),m=jn({currentUserId:r?.id??null}),{data:c,isLoading:f,isError:y,error:p,loadOlder:v,hasMore:u,isLoadingOlder:d,firstItemIndex:x,pollWhenRealtimeDown:g}=Zs(t,{onInsert:m}),w=i.useRef(null);i.useEffect(()=>{if(!t||!c||c.length===0)return;const h=w.current;let C=0;if(h){const U=c.findIndex(ie=>ie.id===h);C=U>=0?U+1:0}for(let U=C;U<c.length;U++)m(c[U]);w.current=c[c.length-1].id},[t,c,m]);const{draft:S,setDraft:N}=yn({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const h=X.current;h&&(h.style.height="auto",h.style.height=`${Math.min(h.scrollHeight,140)}px`)})}}),{sendError:b,lastFailedPayload:R,failedMessages:M,clearBannerState:I,onSendFailed:T,onSendRecovered:q,consumeLastFailedForRetry:E,consumeFailedMessageForRetry:k,discardFailedMessage:P}=Nn({conversationId:t,setDraft:h=>N(h),messages:c}),_=i.useMemo(()=>!t||!o?null:o.find(h=>h.id===t)??null,[t,o]),j=_?.isGroup??!1,D=i.useMemo(()=>{if(!_)return null;const h=_.participants.filter(C=>!C.isSelf);return h.length>0?h[0]:_.participants.length===1?_.participants[0]:null},[_]),B=Ss(t,{onFailed:T,onRecovered:q,otherUserId:j?null:D?.id??null}),$=i.useCallback((h,C)=>{I(),B.mutate({text:h.text,attachmentPath:h.attachmentPath,clientId:h.clientId,tempId:C?.tempId},{onSuccess:()=>{I()}})},[I,B]),X=i.useRef(null),ft=i.useMemo(()=>{const h=new Map;if(!_)return h;for(const C of _.participants)h.set(C.id,C);return h},[_]),{youBlocked:ke,blockedYou:H,isBlocked:Z,block:De,unblock:Le}=Cs(j?null:D?.id??null),ne=r?.id??null,{fileInputRef:mt,isUploadingImage:gt,uploadError:pt,cancelImageUpload:ht,clearUploadError:xt,handleImageSelected:yt,openFilePicker:bt}=Ns({conversationId:t,userId:ne,isBlocked:Z,blockedYou:H,attemptSend:$}),re=!Z&&!H,{headerRef:vt,headerHeight:Ae,composerHeight:wt,isAtBottom:W,setIsAtBottom:Mt,handleComposerHeightChange:Rt,showEmojiPicker:St,setShowEmojiPicker:xe}=bn({showComposer:re}),Ct=re?`calc(${Math.max(wt,0)}px + 20px)`:"2.5rem",Nt=i.useMemo(()=>_?.participants.find(h=>h.isSelf)?.displayName??"You",[_]),{remoteTypingUsers:jt,noteLocalInputActivity:It,stopTyping:Et}=xn({conversationId:t,userId:r?.id??null,displayName:Nt}),{data:Pe}=fn(t);Rn({conversationId:t,userId:r?.id??null,isAtBottom:W,messages:c});const{reactionsByMessageId:_t,toggleReaction:Fe}=un(t),Tt=i.useCallback((h,C)=>{Fe.mutate({messageId:h,emoji:C})},[Fe]),K=i.useRef(null),ye=i.useRef(!1),ae=i.useRef(null),[Be,oe]=i.useState(0),V=Fn(),{activeActionMessageId:kt,openMessageActions:Ue,closeMessageActions:be,hiddenMessageIds:Oe,hideMessageForMe:Dt,deleteDialog:G,openDeleteDialog:Lt,closeDeleteDialog:ve,editingMessage:J,openEditDialog:At,updateEditingText:Pt,closeEditDialog:we,editTextareaRef:Ft,editError:Bt,setEditError:qe}=vn({conversationId:t,currentUserId:ne,showComposer:re,isBlocked:Z,blockedYou:H,composerTextareaRef:X}),Me=sn({messages:c,currentUserId:ne,hiddenMessageIds:Oe}),{data:Ut}=mn(t,Me?[Me]:[]),$e=Sn(t),He=Cn(t),{visibleMessages:L}=tn({messages:c,conversation:_,currentUserId:ne,participantsById:ft,reactionsByMessageId:_t,hiddenMessageIds:Oe,deliveryReceipts:Ut,readReceipts:Pe,failedMessages:M,lastOwnMessageId:Me}),{firstUnreadIndex:z}=In({conversationId:t,userId:r?.id??null,conversation:_,readReceipts:Pe,visibleMessages:L}),Ot=i.useMemo(()=>z==null?0:L.slice(z).filter(h=>!h.isSelf&&!h.meta.deleted).length,[z,L]),Ke=L.length>0;i.useEffect(()=>{const h=L.length?L[L.length-1]?.message.id??null:null;if(W){ae.current=h,oe(0);return}if(!h)return;const C=ae.current;if(C===h)return;const U=C?L.findIndex(te=>te.message.id===C):-1,le=L.slice(Math.max(0,U+1)).filter(te=>!te.isSelf).length;le<=0||oe(le)},[W,L]),i.useEffect(()=>()=>{K.current!=null&&window.clearTimeout(K.current)},[]),i.useEffect(()=>{const h=C=>{C.key==="Escape"&&(be(),xe(!1))};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[be,xe]);const qt=i.useCallback(h=>{h.trim()&&(I(),$({text:h.trim(),attachmentPath:null}))},[$,I]),$t=()=>{const h=E();h&&$(h.payload,{tempId:h.tempId??void 0})},Ht=h=>{K.current!=null&&window.clearTimeout(K.current),ye.current=!1,K.current=window.setTimeout(()=>{ye.current=!0,Ue(h)},500)},Kt=()=>{K.current!=null&&(window.clearTimeout(K.current),K.current=null)};if(!t)return a.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:a.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[a.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),a.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),a.jsx("p",{className:"mt-4",children:a.jsx(is,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})});const zt=i.useCallback(h=>{const C=k(h.id);C&&$(C,{tempId:h.id})},[$,k]),Qt=i.useCallback(h=>{P(h.id)},[P]),ee=V?"auto":"smooth",Re=i.useCallback(()=>{const h=L.length-1;if(h<0)return;const C=L[h]?.message.id??null;C&&(ae.current=C),oe(0),s.current?.scrollToIndex({index:x+h,align:"end",behavior:ee}),window.setTimeout(()=>{X.current?.focus()},V?0:200)},[x,ee,V,L]),Se=i.useCallback(()=>{z!=null&&(s.current?.scrollToIndex({index:x+z,align:"start",behavior:ee}),window.setTimeout(()=>{X.current?.focus()},V?0:150))},[x,z,ee,V]);return i.useEffect(()=>{ae.current=null,oe(0)},[t]),i.useEffect(()=>{const h=C=>{if(C.key==="End"||C.key==="ArrowDown"&&(C.metaKey||C.ctrlKey)||C.key==="End"&&(C.metaKey||C.ctrlKey)){C.preventDefault(),Re();return}C.key.toLowerCase()==="u"&&C.altKey&&(C.preventDefault(),Se())};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[Re,Se]),a.jsxs("div",{className:"conversation-page relative flex min-h-screen w-full flex-col items-stretch bg-background",style:{paddingTop:Ae},children:[a.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[a.jsx(js,{ref:vt,conversation:_,isLoading:l,isGroupConversation:j,otherParticipant:D??void 0,onBack:()=>n("/messages"),onToggleBlock:!j&&D?()=>{ke?Le.mutate():H||De.mutate()}:void 0,blockPending:De.isPending||Le.isPending,youBlocked:ke,blockedYou:H}),a.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[a.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[g&&a.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:a.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),a.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),a.jsx(En,{items:L,isLoading:f&&!Ke,loadingContent:a.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),a.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:y?a.jsxs("div",{className:"mb-3 rounded-md border border-border bg-background/90 px-3 py-2 text-[12px] text-destructive",children:[a.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),p instanceof Error&&a.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:p.message})]}):void 0,emptyContent:Ke?void 0:a.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[a.jsx("p",{className:"font-medium",children:j?"No messages in this group yet.":"No messages yet."}),a.jsx("p",{className:"mt-1",children:j?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:a.jsx("div",{className:"h-1","aria-hidden":!0}),header:u?a.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:d?a.jsxs("span",{className:"inline-flex items-center gap-2",children:[a.jsx(Q,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):a.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Ct,followOutput:W?V?!0:"smooth":!1,autoScrollOnNewLastItem:!0,autoScrollBehavior:ee,autoScrollEnabled:W,onAtBottomChange:Mt,onStartReached:()=>{u&&!d&&v()},firstItemIndex:x,virtuosoRef:s,computeItemKey:(h,C)=>C.message.id,itemContent:(h,C)=>{const{message:U,meta:ie,sender:le,isSelf:te,deliveryStatus:Wt,reactions:Gt,showDeliveryStatus:Jt}=C,Vt=h>0?L[h-1]?.message??null:null,Yt=h<L.length-1?L[h+1]?.message??null:null;return a.jsx(Is,{message:U,meta:ie,sender:le,isSelf:te,deliveryStatus:Wt,showDeliveryStatus:Jt,reactions:Gt,index:h,previousMessage:Vt,nextMessage:Yt,firstUnreadIndex:z,activeActionMessageId:kt,longPressTriggeredRef:ye,onOpenMessageActions:Ue,onCloseMessageActions:be,onOpenEditDialog:At,onOpenDeleteDialog:Lt,onToggleReaction:Tt,onRetryMessage:zt,onDiscardFailedMessage:Qt,onBubbleTouchStart:Ht,onBubbleTouchEndOrCancel:Kt})}}),a.jsx(Tn,{show:z!=null&&!W,unreadCount:Ot,onClick:Se,shortcutHint:"Alt+U"}),a.jsx(_n,{show:!W&&Be>0,pendingCount:Be,onClick:Re,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),a.jsx(Ln,{show:re,headerHeight:Ae,onHeightChange:Rt,typingUsers:jt,isGroupConversation:j,draft:S,setDraft:N,textareaRef:X,noteLocalInputActivity:It,stopTyping:Et,onSendText:qt,isUploadingImage:gt,cancelImageUpload:ht,sendError:b,canRetrySend:!!R,onRetrySend:$t,uploadError:pt,clearUploadError:xt,showEmojiPicker:St,setShowEmojiPicker:xe,openCameraPicker:bt,fileInputRef:mt,onImageSelected:yt,isSending:B.isPending,disableSend:!!(Z||H)}),H&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Z&&!H&&a.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:a.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),a.jsx(An,{open:!!J,editingMessage:J,onOpenChange:h=>{h||we()},onCancel:we,onTextChange:Pt,textareaRef:Ft,error:Bt,isSaving:$e.isPending,onSave:()=>{if(!J)return;const h=J.text.trim();h&&(qe(null),$e.mutate({messageId:J.messageId,text:h,currentBody:J.body,attachmentUrl:J.attachmentUrl},{onSuccess:()=>{we()},onError:()=>{qe("Couldn't save changes. Please try again.")}}))}}),a.jsx(Pn,{open:!!G,deleteDialog:G,onOpenChange:h=>{h||ve()},onHideForMe:()=>{G&&(Dt(G.messageId),ve())},onDeleteForEveryone:()=>{G&&He.mutate({messageId:G.messageId,attachmentUrl:G.attachmentUrl},{onSettled:()=>{ve()}})},isDeleting:He.isPending})]})};export{Wn as default,Ss as useSendMessage};
