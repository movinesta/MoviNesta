import{c as q,d as J,v as K,e as re,w as W,s as y,r as c,R as Kt,j as e,o as Yt,u as zt,g as Ht,z as De,L as Gt,A as it,p as se}from"./index-DlWPTL3h.js";import{f as Wt,b as Jt}from"./format-DWLSBLoY.js";import{Y as Vt}from"./index-Buf02Y5d.js";import{C as lt}from"./circle-alert-CZzjJqJG.js";import{X as Me}from"./x-Dzle6gFP.js";const Xt=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],dt=q("camera",Xt);const Zt=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],es=q("check-check",Zt);const ts=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],ss=q("check",ts);const rs=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ct=q("image",rs);const ns=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],as=q("pen-line",ns);const os=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],ut=q("send",os);const is=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],ls=q("smile",is);const ds=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],mt=q("trash-2",ds);async function ht(t,r,l){const{data:a,error:o}=await t.from("blocked_users").select("blocker_id, blocked_id").or(`and(blocker_id.eq.${r},blocked_id.eq.${l}),and(blocker_id.eq.${l},blocked_id.eq.${r})`);if(o)throw o;const u=a??[],f=u.some(m=>m.blocker_id===r&&m.blocked_id===l),d=u.some(m=>m.blocker_id===l&&m.blocked_id===r);return{youBlocked:f,blockedYou:d}}const cs=t=>{const{user:r}=J(),l=r?.id??null,a=K(),o=["block-status",l,t],u=re({queryKey:o,enabled:!!(l&&t&&l!==t),staleTime:3e4,queryFn:async()=>{if(!l||!t||l===t)return{youBlocked:!1,blockedYou:!1};try{return await ht(y,l,t)}catch(g){console.error("[useBlockStatus] Failed to load block status",g);const N=g;throw new Error(N.message??"Failed to load block status")}}}),f=W({mutationFn:async()=>{if(!l||!t)throw new Error("Missing user ids for block operation.");const{error:g}=await y.from("blocked_users").upsert({blocker_id:l,blocked_id:t},{onConflict:"blocker_id,blocked_id"});if(g)throw console.error("[useBlockStatus] Failed to block user",g),new Error(g.message)},onSuccess:()=>{a.invalidateQueries({queryKey:o})}}),d=W({mutationFn:async()=>{if(!l||!t)throw new Error("Missing user ids for unblock operation.");const{error:g}=await y.from("blocked_users").delete().eq("blocker_id",l).eq("blocked_id",t);if(g)throw console.error("[useBlockStatus] Failed to unblock user",g),new Error(g.message)},onSuccess:()=>{a.invalidateQueries({queryKey:o})}}),m=u.data?.youBlocked??!1,x=u.data?.blockedYou??!1,h=m||x,p=f.isPending||d.isPending;return{youBlocked:m,blockedYou:x,isBlocked:h,isLoading:u.isLoading||p,isError:u.isError,error:u.error??null,block:f,unblock:d}},us=({isSelf:t,isDeleted:r})=>({bubbleColors:r?"bg-card/80 text-muted-foreground border border-dashed border-border":t?"bg-primary/90 text-white shadow-md shadow-primary/20":"bg-card text-foreground border border-border shadow-md",bubbleShape:t?"rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl rounded-br-2xl":"rounded-tr-3xl rounded-tl-3xl rounded-br-3xl rounded-bl-2xl"}),ft=t=>{const r=new Date(t);return Number.isNaN(r.getTime())?"":Jt(r,{hour:"numeric",minute:"2-digit",hour12:!0})},Te=(t,r)=>t.getFullYear()===r.getFullYear()&&t.getMonth()===r.getMonth()&&t.getDate()===r.getDate(),ms=t=>{const r=new Date(t);if(Number.isNaN(r.getTime()))return"";const l=new Date,a=new Date;return a.setDate(l.getDate()-1),Te(r,l)?"Today":Te(r,a)?"Yesterday":Wt(r,{day:"numeric",month:"short",year:"numeric"})},gt=(t,r,l=180*1e3)=>{const a=new Date(t),o=new Date(r);return Number.isNaN(a.getTime())||Number.isNaN(o.getTime())?!1:o.getTime()-a.getTime()<=l},xt=t=>({id:t.id,conversationId:t.conversation_id,senderId:t.user_id,body:t.body??null,attachmentUrl:t.attachment_url??null,createdAt:t.created_at??new Date().toISOString()}),fs="id, conversation_id, user_id, body, attachment_url, created_at",gs=(t,r)=>{const l=Array.isArray(r)?r:[r],a=new Map;for(const o of t??[])a.set(o.id,o);for(const o of l)a.set(o.id,xt(o));return Array.from(a.values()).sort((o,u)=>new Date(o.createdAt??"").getTime()-new Date(u.createdAt??"").getTime())},hs=t=>{const r=K(),l=re({queryKey:["conversation",t,"messages"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,staleTime:15e3,queryFn:async()=>{if(!t)return[];const{data:a,error:o}=await y.from("messages").select(fs).eq("conversation_id",t).order("created_at",{ascending:!0});if(o)throw console.error("[useConversationMessages] Failed to load messages",o),new Error(o.message);return(a??[]).map(xt)}});return c.useEffect(()=>{if(!t)return;const a=y.channel(`conversation-messages-${t}`),o=u=>{const f=u.new;!f||!f.id||f.conversation_id!==t||r.setQueryData(["conversation",t,"messages"],d=>gs(d,f))};return a.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},o).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},o).subscribe(),()=>{y.removeChannel(a)}},[t,r]),l},xs=t=>["conversation",t,"reactions"],bs=t=>({id:t.id,conversationId:t.conversation_id,messageId:t.message_id,userId:t.user_id,emoji:t.emoji,createdAt:t.created_at}),ps=async t=>{const{data:r,error:l}=await y.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(l)throw console.error("[useConversationReactions] Failed to load reactions",l),new Error(l.message);return(r??[]).map(bs)},ys=t=>{const{user:r}=J(),l=r?.id??null,a=K(),o=xs(t),u=re({queryKey:o,enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:()=>t?ps(t):Promise.resolve([])}),f=W({mutationFn:async({messageId:m,emoji:x})=>{if(!t)throw new Error("Missing conversation id.");if(!l)throw new Error("You must be signed in to react to messages.");const{error:h}=await y.from("message_reactions").insert({conversation_id:t,message_id:m,user_id:l,emoji:x});if(h){if(h?.code==="23505"){const{error:p}=await y.from("message_reactions").delete().eq("conversation_id",t).eq("message_id",m).eq("user_id",l).eq("emoji",x);if(p)throw console.error("[useConversationReactions] Failed to remove reaction",p),p;return}throw console.error("[useConversationReactions] Failed to toggle reaction",h),h}},onMutate:async({messageId:m,emoji:x})=>{if(!t||!l)return{previousReactions:void 0};await a.cancelQueries({queryKey:o});const h=a.getQueryData(o);return a.setQueryData(o,p=>{const g=p??[],N=g.findIndex(_=>_.messageId===m&&_.userId===l&&_.emoji===x);if(N>=0){const _=[...g];return _.splice(N,1),_}const w={id:`temp-${Date.now()}`,conversationId:t,messageId:m,userId:l,emoji:x,createdAt:new Date().toISOString()};return[...g,w]}),{previousReactions:h}},onError:(m,x,h)=>{t&&(h?.previousReactions?a.setQueryData(o,h.previousReactions):a.invalidateQueries({queryKey:o}))},onSuccess:()=>{t&&a.invalidateQueries({queryKey:o})}}),d=c.useMemo(()=>{const m=new Map,x=u.data??[];for(const h of x){const p=m.get(h.messageId)??[];let g=p.find(N=>N.emoji===h.emoji);g?(g.count+=1,g.reactedBySelf=g.reactedBySelf||(l?h.userId===l:!1)):(g={count:1,emoji:h.emoji,reactedBySelf:!!(l&&h.userId===l)},p.push(g)),m.set(h.messageId,p)}return m},[u.data,l]);return{reactions:u.data??[],reactionsByMessageId:d,isLoadingReactions:u.isLoading,toggleReaction:f,queryKey:o}},vs=()=>null;function ws({items:t,itemContent:r,isLoading:l,loadingContent:a,errorContent:o,emptyContent:u,footer:f,followOutput:d=!1,onAtBottomChange:m,computeItemKey:x}){const h=Kt.useRef(null);return l?e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:a}):o?e.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:o}):t.length?e.jsx("div",{className:"relative flex flex-1",children:e.jsx(Vt,{ref:h,data:t,style:{height:"100%",width:"100%"},className:"px-4 py-4",alignToBottom:!0,followOutput:d,atBottomStateChange:m,increaseViewportBy:400,computeItemKey:x,itemContent:(p,g)=>r(p,g),components:f?{Footer:()=>e.jsx("div",{className:"px-1 pb-2 pt-1 text-xs text-muted-foreground",children:f})}:void 0})}):e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:u})}const js=({isSelf:t,isDeleted:r,children:l,className:a="",...o})=>{const{bubbleColors:u,bubbleShape:f}=us({isSelf:t,isDeleted:r});return e.jsx("button",{type:"button",className:`inline-flex max-w-[80%] px-4 py-2.5 text-sm ${f} ${u} select-none transition-transform duration-150 ease-out ${a}`,...o,children:e.jsx("div",{className:"flex flex-col",children:l})})},_s=({children:t,...r})=>e.jsx("form",{...r,className:`border-t border-border bg-background/90 px-4 py-3 backdrop-blur ${r.className??""}`,children:t}),ks=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ™","ðŸ”¥","ðŸ˜"],Ie="chat-media",Ns=(t,r,l)=>{const a=l.split(".").pop()??"jpg",o=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():Date.now();return`message_attachments/${t}/${r}/${Date.now()}-${o}.${a}`},Cs=t=>re({queryKey:["conversation",t,"readReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?12e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:r,error:l}=await y.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1});if(l)throw console.error("[ConversationPage] Failed to load read receipts",l),new Error(l.message);return(r??[]).map(a=>({userId:a.user_id,lastReadAt:a.last_read_at??null,lastReadMessageId:a.last_read_message_id??null}))}}),Ss=t=>re({queryKey:["conversation",t,"deliveryReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:r,error:l}=await y.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).order("created_at",{ascending:!0});if(l)throw console.error("[ConversationPage] Failed to load delivery receipts",l),new Error(l.message);return(r??[]).map(a=>({id:a.id,conversationId:a.conversation_id,messageId:a.message_id,userId:a.user_id,deliveredAt:a.delivered_at??a.created_at}))}}),Rs=(t,r)=>{const{user:l}=J(),a=l?.id??null,o=K();return W({mutationFn:async({text:u,attachmentPath:f})=>{if(!t)throw new Error("Missing conversation id.");if(!a)throw new Error("You must be signed in to send messages.");if(r?.otherUserId){const g=await ht(y,a,r.otherUserId);if(g.youBlocked)throw new Error("You have blocked this user. Unblock them to send messages.");if(g.blockedYou)throw new Error("You cannot send messages because this user blocked you.")}const d=u.trim(),m=f&&d?{type:"text+image",text:d}:f?{type:"image",text:""}:{type:"text",text:d},{data:x,error:h}=await y.from("messages").insert({conversation_id:t,user_id:a,body:JSON.stringify(m),attachment_url:f??null}).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(h)throw console.error("[ConversationPage] Failed to send message",h),new Error(h.message);const p={id:x.id,conversationId:x.conversation_id,senderId:x.user_id,body:x.body??null,attachmentUrl:x.attachment_url??null,createdAt:x.created_at};try{await y.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",t)}catch(g){console.error("[ConversationPage] Failed to update conversation timestamp",g)}return p},onMutate:async({text:u,attachmentPath:f})=>{if(!t||!a)return{previousMessages:void 0,tempId:null};const d=`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,m=new Date().toISOString(),x={id:d,conversationId:t,senderId:a,body:JSON.stringify({type:"text",text:u.trim()}),attachmentUrl:f??null,createdAt:m};await o.cancelQueries({queryKey:["conversation",t,"messages"]});const h=o.getQueryData(["conversation",t,"messages"]);return o.setQueryData(["conversation",t,"messages"],p=>{const N=[...p??[],x];return N.sort((w,_)=>new Date(w.createdAt).getTime()-new Date(_.createdAt).getTime()),N}),{previousMessages:h,tempId:d,optimistic:x,payload:{text:u.trim(),attachmentPath:f??null}}},onError:(u,f,d)=>{if(console.error("[ConversationPage] sendMessage error",u),t){const{previousMessages:m,optimistic:x,payload:h,tempId:p}=d??{},g=m??o.getQueryData(["conversation",t,"messages"])??[],N=x?[...g,x]:[...g];N.sort((w,_)=>new Date(w.createdAt).getTime()-new Date(_.createdAt).getTime()),o.setQueryData(["conversation",t,"messages"],N),p&&h&&r?.onFailed&&r.onFailed(p,h)}},onSuccess:(u,f,d)=>{if(!t)return;const m=d?.tempId;o.setQueryData(["conversation",t,"messages"],x=>{const h=x??[],p=m?h.filter(w=>w.id!==m):h.filter(w=>w.id!==u.id),g=p.findIndex(w=>w.id===u.id);if(g>=0){const w=[...p];return w[g]=u,w}const N=[...p,u];return N.sort((w,_)=>new Date(w.createdAt).getTime()-new Date(_.createdAt).getTime()),N}),o.invalidateQueries({queryKey:["conversations"]}),r?.onRecovered&&r.onRecovered(d?.tempId??null)}})},Es=t=>{const{user:r}=J(),l=r?.id??null,a=K();return W({mutationFn:async({messageId:o,text:u})=>{if(!t)throw new Error("Missing conversation id.");if(!l)throw new Error("You must be signed in to edit messages.");const d={type:"text",text:u.trim(),editedAt:new Date().toISOString()},{data:m,error:x}=await y.from("messages").update({body:JSON.stringify(d)}).eq("id",o).eq("user_id",l).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(x)throw console.error("[ConversationPage] Failed to edit message",x),new Error(x.message);return{id:m.id,conversationId:m.conversation_id,senderId:m.user_id,body:m.body??null,attachmentUrl:m.attachment_url??null,createdAt:m.created_at}},onSuccess:o=>{if(!t)return;const u=["conversation",t,"messages"];a.setQueryData(u,f=>f?f.map(d=>d.id===o.id?o:d):[o])}})},Ds=t=>{const{user:r}=J(),l=r?.id??null,a=K();return W({mutationFn:async({messageId:o})=>{if(!t)throw new Error("Missing conversation id.");if(!l)throw new Error("You must be signed in to delete messages.");const f={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},{data:d,error:m}=await y.from("messages").update({body:JSON.stringify(f),attachment_url:null}).eq("id",o).eq("user_id",l).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(m)throw console.error("[ConversationPage] Failed to delete message",m),new Error(m.message);return{id:d.id,conversationId:d.conversation_id,senderId:d.user_id,body:d.body??null,attachmentUrl:d.attachment_url??null,createdAt:d.created_at}},onSuccess:o=>{if(!t)return;const u=["conversation",t,"messages"];a.setQueryData(u,f=>f?f.map(d=>d.id===o.id?o:d):[o]),a.invalidateQueries({queryKey:["conversations"]})}})},Ms=({path:t})=>{const[r,l]=c.useState(null),[a,o]=c.useState(!1);return c.useEffect(()=>{let u=!1;return(async()=>{const{data:d,error:m}=await y.storage.from(Ie).createSignedUrl(t,3600);if(!u){if(m||!d?.signedUrl){console.error("[ChatImage] createSignedUrl error",m),o(!0);return}l(d.signedUrl)}})(),()=>{u=!0}},[t]),a?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"Image unavailable."}):r?e.jsx("div",{className:"mt-1 overflow-hidden rounded-xl border border-border bg-background/80",children:e.jsx("img",{src:r,alt:"Attachment",className:"max-h-64 w-full object-cover",loading:"lazy"})}):e.jsx("div",{className:"mt-1 h-32 w-40 animate-pulse rounded-xl bg-border/40"})},Bs=()=>{const{conversationId:t}=Yt(),r=t??null,l=zt(),{user:a}=J(),o=K(),{data:u,isLoading:f}=Ht(),{data:d,isLoading:m,isError:x,error:h}=hs(r),[p,g]=c.useState(""),[N,w]=c.useState(null),[_,E]=c.useState(null),[I,$]=c.useState(null),[me,fe]=c.useState({}),bt=(s,n)=>{w("Couldn't send. Please try again."),g(n.text),G(),$(n),fe(i=>({...i,[s]:n}))},pt=s=>{s&&fe(n=>{if(!(s in n))return n;const i={...n};return delete i[s],i})},S=c.useMemo(()=>!r||!u?null:u.find(s=>s.id===r)??null,[r,u]),B=S?.isGroup??!1,ne=c.useMemo(()=>{if(!S)return null;const s=S.participants.filter(n=>!n.isSelf);return s.length>0?s[0]:S.participants.length===1?S.participants[0]:null},[S]),yt=Rs(r,{onFailed:bt,onRecovered:pt,otherUserId:B?null:ne?.id??null}),[vt,wt]=c.useState(!0),Y=c.useRef(null),[ae,oe]=c.useState(!1),ge=c.useRef(null),he=c.useRef(null),[jt,Ae]=c.useState(!1),[ie,Pe]=c.useState(null),[M,qe]=c.useState(null),[xe,$e]=c.useState(!1),be=c.useRef(null);c.useEffect(()=>()=>{M&&URL.revokeObjectURL(M)},[M]),c.useEffect(()=>{d&&fe(s=>{const n=new Set(d.map(b=>b.id));let i=!1;const j={...s};for(const b of Object.keys(j))n.has(b)||(delete j[b],i=!0);return i?j:s})},[d]);const le=c.useMemo(()=>{const s=new Map;if(!S)return s;for(const n of S.participants)s.set(n.id,n);return s},[S]),{youBlocked:Be,blockedYou:A,isBlocked:F,isLoading:_t,block:Fe,unblock:Le}=cs(B?null:ne?.id??null),kt=(d?.length??0)>0,Nt=f||m||_t,L=a?.id??null,Ue=c.useMemo(()=>{if(!d||!L)return null;for(let s=d.length-1;s>=0;s-=1){const n=d[s];if(n.senderId===L&&!De(n.body).deleted)return n.id}return null},[d,L]),[z,pe]=c.useState([]),H=c.useRef(new Map),ye=c.useRef(null),V=c.useRef({conversationId:null,messageId:null,userId:null}),U=c.useRef({isTyping:!1,timeoutId:null}),{data:Oe}=Cs(r),{reactionsByMessageId:Qe,toggleReaction:Ke,queryKey:ve}=ys(r),{data:Ye}=Ss(r),we=Es(r),je=Ds(r),P=c.useRef(null),de=c.useRef(!1),[ze,X]=c.useState(null),[He,Ct]=c.useState({}),[_e,Z]=c.useState(null),[O,ke]=c.useState(null),Ge=c.useRef(null),We=c.useRef(null),Ne=c.useRef(null),[Je,ce]=c.useState(null),ee=c.useCallback(()=>{ke(null),ce(null),Ne.current&&Ne.current.focus()},[]);c.useEffect(()=>{if(!O)return;const s=Ge.current,n=s?.querySelectorAll("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])"),i=j=>{if(!s)return;if(j.key==="Escape"){j.preventDefault(),ee();return}if(j.key!=="Tab"||!n||n.length===0)return;const b=n[0],v=n[n.length-1];j.shiftKey?document.activeElement===b&&(j.preventDefault(),v.focus()):document.activeElement===v&&(j.preventDefault(),b.focus())};return s?.addEventListener("keydown",i),queueMicrotask(()=>{We.current?.focus()}),()=>s?.removeEventListener("keydown",i)},[O,ee]);const Ve=c.useMemo(()=>d?d.map(s=>{const n=De(s.body),i=le.get(s.senderId)??null,j=i?.isSelf??(L!=null&&s.senderId===L),b=Ts(s,S??null,Ye,Oe,L,me),v=!!b&&j&&!n.deleted&&(b.status==="failed"||Ue===s.id);return{message:s,meta:n,sender:i,isSelf:j,deliveryStatus:b,showDeliveryStatus:v,reactions:Qe.get(s.id)??[]}}):[],[S,L,Ye,me,Ue,d,le,Qe,Oe]),te=c.useMemo(()=>Ve.filter(({message:s})=>!He[s.id]),[Ve,He]),St=te.length>0;c.useEffect(()=>{V.current={conversationId:null,messageId:null,userId:null}},[r,a?.id]),c.useEffect(()=>()=>{P.current!=null&&window.clearTimeout(P.current)},[]),c.useEffect(()=>{if(!r||!a?.id)return;const s=y.channel(`supabase_realtime_typing:conversation:${r}`,{config:{broadcast:{self:!1}}});return ye.current=s,s.on("broadcast",{event:"typing"},({payload:n})=>{const i=n;if(!i||i.userId===a.id)return;const b=le.get(i.userId)?.displayName??"Someone",v=i.userId,D=H.current.get(v);if(D!=null&&window.clearTimeout(D),i.isTyping){pe(C=>C.includes(b)?C:[...C,b]);const R=window.setTimeout(()=>{H.current.delete(v),pe(C=>C.filter(T=>T!==b))},4e3);H.current.set(v,R)}else H.current.delete(v),pe(R=>R.filter(C=>C!==b))}).subscribe(n=>{console.log("[ConversationPage] Typing channel status",n)}),()=>{H.current.forEach(n=>window.clearTimeout(n)),H.current.clear(),s&&y.removeChannel(s),ye.current=null}},[r,a?.id,le]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_messages_publication:conversation:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${r}`},n=>{console.log("[ConversationPage] Realtime message payload",n);const i=n.new;if(a?.id&&i.user_id===a.id)return;const j={id:i.id,conversationId:i.conversation_id,senderId:i.user_id,body:i.body,attachmentUrl:i.attachment_url,createdAt:i.created_at};o.setQueryData(["conversation",r,"messages"],b=>{const v=b??[];if(v.some(C=>C.id===j.id))return v;const R=[...v,j];return R.sort((C,T)=>new Date(C.createdAt).getTime()-new Date(T.createdAt).getTime()),R}),o.invalidateQueries({queryKey:["conversations"]}),a?.id&&i.user_id!==a.id&&y.from("message_delivery_receipts").insert({conversation_id:i.conversation_id,message_id:i.id,user_id:a.id}).then(({error:b})=>{b&&console.error("[ConversationPage] Failed to insert delivery receipt",b)},b=>{console.error("[ConversationPage] Unexpected error inserting delivery receipt",b)})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${r}`},n=>{const i=n.new,j={id:i.id,conversationId:i.conversation_id,senderId:i.user_id,body:i.body,attachmentUrl:i.attachment_url,createdAt:i.created_at};o.setQueryData(["conversation",r,"messages"],b=>{const v=b??[],D=v.findIndex(C=>C.id===j.id);if(D===-1)return v;const R=[...v];return R[D]=j,R})});return s.subscribe(n=>{console.log("[ConversationPage] Realtime channel status (messages)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for messages",n)}),()=>{y.removeChannel(s)}},[r,o,a?.id]),c.useEffect(()=>{if(!r||!d||d.length===0||!a?.id)return;const s=d[d.length-1];V.current.conversationId===r&&V.current.messageId===s.id&&V.current.userId===a.id||y.from("message_read_receipts").upsert({conversation_id:r,user_id:a.id,last_read_message_id:s.id,last_read_at:new Date().toISOString()},{onConflict:"conversation_id,user_id"}).then(()=>{V.current={conversationId:r,messageId:s.id,userId:a.id},o.invalidateQueries({queryKey:["conversations"]})},n=>{console.error("[ConversationPage] Failed to update read receipt",n)})},[r,d,a?.id,o]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_read_receipts:conversation:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${r}`},()=>{o.invalidateQueries({queryKey:["conversation",r,"readReceipts"]})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${r}`},()=>{o.invalidateQueries({queryKey:["conversation",r,"readReceipts"]})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (read receipts)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for read receipts",n)});return()=>{y.removeChannel(s)}},[r,o]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_message_reactions:conversation:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${r}`},()=>{ve&&o.invalidateQueries({queryKey:ve})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (reactions)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for reactions",n)});return()=>{y.removeChannel(s)}},[r,o,ve]),c.useEffect(()=>{if(!r)return;const s=y.channel(`supabase_realtime_message_delivery_receipts:conversation:${r}`).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${r}`},()=>{o.invalidateQueries({queryKey:["conversation",r,"deliveryReceipts"]})}).subscribe(n=>{console.log("[ConversationPage] Realtime channel status (delivery receipts)",n),n==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for delivery receipts",n)});return()=>{y.removeChannel(s)}},[r,o]),c.useEffect(()=>{if(!ae)return;const s=n=>{const i=n.target;he.current&&!he.current.contains(i)&&ge.current&&!ge.current.contains(i)&&oe(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[ae]);const G=()=>{const s=Y.current;if(!s)return;s.style.height="auto";const n=Math.min(140,s.scrollHeight);s.style.height=`${n}px`,s.style.overflowY=s.scrollHeight>n?"auto":"hidden"};c.useEffect(()=>{G()},[p]);const Ce=s=>{const n=ye.current;if(!n||!r||!a)return;const j=s.trim().length>0,b=U.current.isTyping;j&&!b&&(U.current.isTyping=!0,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!0}})),U.current.timeoutId!=null&&window.clearTimeout(U.current.timeoutId),j?U.current.timeoutId=window.setTimeout(()=>{U.current.isTyping=!1,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!1}})},3e3):!j&&b&&(U.current.isTyping=!1,n.send({type:"broadcast",event:"typing",payload:{userId:a.id,isTyping:!1}}))},Rt=s=>{const n=s.target.value;g(n),G(),ae&&oe(!1),Ce(n)},Et=s=>{s&&g(n=>{const i=`${n}${s}`;return G(),Ce(i),i})},Se=s=>{yt.mutate({text:s.text,attachmentPath:s.attachmentPath},{onError:n=>{console.error("[ConversationPage] sendMessage mutate error",n),w("Couldn't send. Please try again."),g(s.text),G(),$(s)},onSuccess:()=>{w(null),$(null)}})},Dt=s=>{if(s.preventDefault(),F||A)return;const n=p.trim();n&&(g(""),G(),w(null),$(null),Ce(""),Se({text:n,attachmentPath:null}))},Mt=()=>{I&&(w(null),Se(I))},Tt=()=>{!r||!a?.id||F||A||be.current?.click()},It=async s=>{const n=s.target.files?.[0];if(s.target.value="",!n||!r||!a?.id||F||A)return;const i=URL.createObjectURL(n);M&&URL.revokeObjectURL(M),Pe(n),qe(i),Ae(!0)},Xe=()=>{M&&URL.revokeObjectURL(M),qe(null),Pe(null),Ae(!1),E(null)},At=async()=>{if(!(!ie||!r||!a?.id)&&!(F||A)){E(null),$e(!0);try{const s=Ns(r,a.id,ie.name),{error:n}=await y.storage.from(Ie).upload(s,ie,{cacheControl:"3600",upsert:!1});if(n){console.error("[ConversationPage] image upload error",n),E("Upload failed. Please try another image.");return}const{error:i}=await y.storage.from(Ie).createSignedUrl(s,3600);if(i){console.error("[ConversationPage] signed URL generation failed",i),E("Could not generate a secure download link.");return}Se({text:"",attachmentPath:s}),Xe()}catch(s){console.error("[ConversationPage] handleSendSelectedImage failed",s),E("Something went wrong while sending your image.")}finally{$e(!1)}}},Ze=s=>{F||A||De(s.body).deleted||(X(s.id),Y.current&&Y.current.blur())},Pt=s=>{P.current!=null&&window.clearTimeout(P.current),de.current=!1,P.current=window.setTimeout(()=>{de.current=!0,Ze(s)},500)},et=()=>{P.current!=null&&(window.clearTimeout(P.current),P.current=null)};if(!r)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-5 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Gt,{to:"/messages",className:"inline-flex items-center justify-center rounded-full border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground shadow-md transition hover:border-primary/70 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:"Back to messages"})})]})});const qt=s=>{const n=me[s.id];n&&(g(n.text),$(n))};return e.jsxs("div",{className:"relative flex min-h-screen w-full flex-col items-stretch bg-background",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-10 top-4 h-32 rounded-full bg-gradient-to-r from-fuchsia-500/15 via-primary/10 to-blue-500/15 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 flex-col items-stretch rounded-none border border-border bg-background shadow-xl shadow-primary/5 backdrop-blur sm:rounded-3xl",children:[e.jsx(vs,{conversation:S,isLoading:f,isGroupConversation:B,otherParticipant:ne??void 0,onBack:()=>l("/messages"),onToggleBlock:!B&&ne?()=>{Be?Le.mutate():Fe.mutate()}:void 0,blockPending:Fe.isPending||Le.isPending,youBlocked:Be}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col bg-gradient-to-b from-background via-background to-background",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-8 top-4 h-20 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-primary/10 to-blue-500/10 blur-3xl","aria-hidden":"true"}),e.jsx(ws,{items:te,isLoading:Nt&&!kt,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(se,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:x?e.jsxs("div",{className:"mb-3 rounded-md border border-border bg-background/90 px-3 py-2 text-[12px] text-destructive",children:[e.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),h instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:h.message})]}):void 0,emptyContent:St?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium",children:B?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:B?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:z.length>0?e.jsxs("div",{className:"mt-1 flex items-center justify-start gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:B?z.length===1?`${z[0]} is typingâ€¦`:z.length===2?`${z[0]} and ${z[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-muted"})]})]}):e.jsx("div",{className:"h-1","aria-hidden":!0}),followOutput:vt?"smooth":!1,onAtBottomChange:wt,computeItemKey:(s,n)=>n.message.id,itemContent:(s,n)=>{const{message:i,meta:j,sender:b,isSelf:v,deliveryStatus:D,reactions:R,showDeliveryStatus:C}=n,T=s>0?te[s-1]?.message??null:null,Re=s<te.length-1?te[s+1]?.message??null:null,tt=T!=null&&T.senderId===i.senderId,st=Re!=null&&Re.senderId===i.senderId,$t=tt&&gt(T.createdAt,i.createdAt),Bt=st&&gt(i.createdAt,Re.createdAt),Ft=!(tt&&$t),Lt=!(st&&Bt),rt=s===0||T!=null&&!Te(new Date(T.createdAt),new Date(i.createdAt)),Ut=s===0||rt?"mt-0":Ft?"mt-3":"mt-1.5",Q=j.deleted===!0,nt=j.editedAt,at=j.deletedAt,ot=b?.displayName??(v?"You":"Someone"),ue=Q?"This message was deleted":it(i.body),Ot=(()=>{const k=v?"You":ot;return Q?`${k} deleted a message`:ue?`${k} said: ${ue}`:i.attachmentUrl?`${k} sent an attachment`:`${k} sent a message`})(),Qt=!v&&Lt,Ee=()=>{if(de.current){de.current=!1;return}ze===i.id?X(null):Ze(i)};return e.jsxs("div",{className:"px-0",children:[rt&&e.jsx("div",{className:"my-4 flex items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-border to-transparent","aria-hidden":"true"}),e.jsx("span",{className:"rounded-full bg-background px-3 py-0.5 text-xs font-medium text-muted-foreground shadow-md/60 ring-1 ring-border/70",children:ms(i.createdAt)}),e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-border to-transparent","aria-hidden":"true"})]})}),e.jsxs("div",{className:`flex w-full flex-col gap-0.5 ${Ut}`,children:[e.jsxs("div",{className:`flex w-full items-end gap-2 ${v?"justify-end":"justify-start"}`,children:[!v&&e.jsx(e.Fragment,{children:Qt?e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0 overflow-hidden rounded-full bg-background/80 ring-1 ring-border",children:b?.avatarUrl?e.jsx("img",{src:b.avatarUrl,alt:b.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-medium text-muted-foreground",children:ot.slice(0,2).toUpperCase()})}):e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0"})}),e.jsxs(js,{isSelf:v,isDeleted:Q,onClick:Ee,onContextMenu:k=>{k.preventDefault(),Ee()},onKeyDown:k=>{(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),Ee())},onTouchStart:()=>Pt(i),onTouchEnd:et,onTouchCancel:et,"aria-label":Ot,children:[ue&&e.jsx("p",{className:"whitespace-pre-wrap break-all text-sm leading-snug",children:ue}),!Q&&i.attachmentUrl&&e.jsx(Ms,{path:i.attachmentUrl})]})]}),R.length>0&&e.jsx("div",{className:`mt-0.5 flex w-full ${v?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsx("div",{className:"inline-flex flex-wrap items-center gap-1 rounded-full bg-card/80 px-1.5 py-0.5 text-xs text-foreground shadow-md ring-1 ring-border/70",children:R.map(k=>e.jsxs("button",{type:"button",onClick:()=>Ke.mutate({messageId:i.id,emoji:k.emoji}),className:`inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 transition transform hover:bg-background hover:scale-110 active:scale-90 ${k.reactedBySelf?"bg-primary/5 ring-1 ring-primary/40":""}`,children:[e.jsx("span",{className:"text-[17px]",children:k.emoji}),k.count>1&&e.jsx("span",{className:"text-xs text-muted-foreground",children:k.count})]},k.emoji))})}),ze===i.id&&!Q&&e.jsx("div",{className:`mt-1 flex w-full ${v?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsxs("div",{className:"inline-flex flex-col items-stretch gap-1 rounded-2xl bg-card/95 px-2.5 py-1.5 text-xs text-foreground shadow-md ring-1 ring-border/70 select-none",children:[e.jsx("div",{className:"flex items-center justify-center gap-1",children:ks.map(k=>e.jsx("button",{type:"button",onClick:()=>{Ke.mutate({messageId:i.id,emoji:k}),X(null)},className:"flex h-7 w-7 items-center justify-center rounded-full transition transform hover:bg-background hover:-translate-y-0.5 hover:scale-110 active:scale-90",children:e.jsx("span",{className:"text-[17px]",children:k})},k))}),v&&e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("button",{type:"button",onClick:k=>{Ne.current=k.currentTarget,ke({messageId:i.id,text:it(i.body)??""}),ce(null),X(null),Y.current&&Y.current.blur()},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs text-muted-foreground hover:bg-background",children:[e.jsx(as,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Edit"})]}),e.jsxs("button",{type:"button",onClick:()=>{X(null),Z({messageId:i.id})},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs text-destructive hover:bg-destructive/10",children:[e.jsx(mt,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Delete"})]})]})]})}),C&&D&&e.jsx("div",{className:`flex items-center gap-1 text-xs text-muted-foreground ${v?"justify-end pr-1":"justify-start pl-7"}`,children:D.status==="failed"?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:"h-3 w-3 text-destructive","aria-hidden":!0}),e.jsx("span",{children:"Failed to send."}),e.jsx("button",{type:"button",className:"text-destructive underline",onClick:()=>qt(i),children:"Retry"})]}):D.status==="delivered"?e.jsxs(e.Fragment,{children:[e.jsx(ss,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Delivered"})]}):e.jsxs(e.Fragment,{children:[e.jsx(es,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Seen"})]})}),Q&&at&&e.jsxs("p",{className:`text-xs text-muted-foreground ${v?"text-right pr-1":"text-left pl-7"}`,children:["Deleted ",ft(at)]}),!Q&&nt&&e.jsxs("p",{className:`text-xs text-muted-foreground ${v?"text-right pr-1":"text-left pl-7"}`,children:["Edited ",ft(nt)]})]})]},i.id)}}),ae&&e.jsx("div",{ref:he,className:"absolute bottom-[4.25rem] left-4 z-30 rounded-2xl border border-border bg-card/95 p-2 shadow-lg",children:e.jsx("div",{className:"flex max-w-[260px] flex-wrap gap-1.5",children:["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ”¥","â­","âœ¨","ðŸ‘€","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"].map(s=>e.jsx("button",{type:"button",onClick:()=>{Et(s),oe(!1)},className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-background text-lg transition hover:bg-background/70",children:e.jsx("span",{children:s})},s))})})]}),!F&&!A&&e.jsxs(_s,{onSubmit:Dt,className:"sticky bottom-0 z-20 flex-shrink-0 space-y-2",children:[N&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),I&&e.jsx("button",{type:"button",onClick:Mt,className:"inline-flex items-center gap-1 rounded-full bg-primary/10 px-2 py-1 text-xs font-semibold text-primary ring-1 ring-primary/40 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:e.jsx("span",{children:"Retry"})})]}),_&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:_})]}),e.jsx("button",{type:"button",onClick:()=>E(null),className:"inline-flex items-center gap-1 rounded-full bg-card/80 px-2 py-1 text-xs font-semibold text-muted-foreground ring-1 ring-border/70 transition hover:-translate-y-0.5 hover:text-foreground",children:e.jsx("span",{children:"Dismiss"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",ref:ge,onClick:()=>oe(s=>!s),className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Add emoji",children:e.jsx(ls,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:Tt,className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Send photo",children:e.jsx(dt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:be,accept:"image/*",className:"hidden",onChange:It}),e.jsx("div",{className:"flex min-h-[44px] max-h-[160px] flex-1 items-center rounded-full bg-background px-4 py-2.5 text-sm text-foreground shadow-inner ring-1 ring-border/70 focus-within:outline-none focus-within:ring-0 focus-within:shadow-none",children:e.jsx("textarea",{id:"conversation-message",value:p,ref:Y,onChange:Rt,onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),p.trim()&&s.currentTarget.form?.requestSubmit())},placeholder:"Messageâ€¦",rows:1,className:"max-h-[160px] flex-1 resize-none bg-transparent text-sm text-foreground outline-none placeholder:text-muted-foreground focus:border-transparent focus:outline-none focus:ring-0 focus:shadow-none"})}),e.jsx("button",{type:"submit",onMouseDown:s=>s.preventDefault(),onTouchStart:s=>s.preventDefault(),disabled:!p.trim(),className:"inline-flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-r from-fuchsia-500 via-primary to-blue-500 text-white shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"})})]})]}),A&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),F&&!A&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),O&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{ref:Ge,role:"dialog","aria-modal":"true","aria-labelledby":"edit-message-title",className:"w-[min(480px,calc(100%-2.5rem))] rounded-2xl border border-border bg-card p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{id:"edit-message-title",className:"text-[15px] font-semibold text-foreground",children:"Edit message"}),e.jsx("button",{type:"button",onClick:ee,className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-background text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-card focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close edit message",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("div",{className:"mt-3 rounded-2xl bg-background px-3 py-2 ring-1 ring-border/70",children:e.jsx("textarea",{ref:We,value:O.text,onChange:s=>ke(n=>n&&{...n,text:s.target.value}),rows:3,className:"w-full resize-none border-0 bg-transparent text-sm text-foreground outline-none focus:outline-none focus:ring-0"})}),Je&&e.jsx("p",{className:"mt-2 text-xs text-destructive",children:Je}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2 text-sm",children:[e.jsx(Button,{type:"button",variant:"ghost",size:"sm",onClick:ee,children:"Cancel"}),e.jsxs(Button,{type:"button",size:"sm",disabled:!O.text.trim()||we.isPending,onClick:()=>{const s=O.text.trim();s&&(ce(null),we.mutate({messageId:O.messageId,text:s},{onSuccess:()=>{ee()},onError:()=>{ce("Couldn't save changes. Please try again.")}}))},children:[we.isPending&&e.jsx(se,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),_e&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"w-[min(420px,calc(100%-2.5rem))] rounded-2xl border border-border bg-card p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-destructive/10 text-destructive",children:e.jsx(mt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("h2",{className:"text-[15px] font-semibold text-foreground",children:"Delete message"})]}),e.jsx("button",{type:"button",onClick:()=>Z(null),className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-background text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-card focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close delete dialog",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("p",{className:"mt-3 text-[12px] text-muted-foreground",children:"Choose whether to remove this message only from your chat or from the conversation for everyone."}),e.jsxs("div",{className:"mt-5 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{Ct(s=>({...s,[_e.messageId]:!0})),Z(null)},className:"flex-1 rounded-full bg-background px-3 py-2 text-sm font-semibold text-foreground shadow-md ring-1 ring-border/80 transition hover:-translate-y-0.5 hover:bg-card",children:"Delete for me"}),e.jsxs("button",{type:"button",disabled:je.isPending,onClick:()=>{je.mutate({messageId:_e.messageId},{onSettled:()=>{Z(null)}})},className:"flex-1 inline-flex items-center justify-center gap-1 rounded-full bg-destructive px-3 py-2 text-sm font-semibold text-white shadow-md transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",children:[je.isPending&&e.jsx(se,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]}),e.jsx("button",{type:"button",onClick:()=>Z(null),className:"self-center text-[12px] text-muted-foreground hover:text-foreground",children:"Cancel"})]})]})}),jt&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-[min(520px,calc(100%-2rem))] rounded-3xl border border-border bg-background/95 p-5 shadow-2xl",children:[e.jsx("button",{type:"button",onClick:Xe,className:"absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full bg-card/80 text-muted-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Close gallery picker",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"flex items-start gap-3 pr-10",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-fuchsia-500/10 via-primary/10 to-blue-500/10 text-foreground ring-1 ring-border",children:e.jsx(dt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-foreground",children:"Send from your gallery"}),e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"Pick a recent photo to drop into the chatâ€”just like Instagram DMs."})]})]}),e.jsxs("div",{className:"mt-4 rounded-2xl border border-dashed border-border bg-background/80 p-4",children:[M?e.jsx("div",{className:"overflow-hidden rounded-xl border border-border bg-card/80",children:e.jsx("img",{src:M,alt:"Selected",className:"max-h-[320px] w-full object-cover"})}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-10 text-center text-muted-foreground",children:[e.jsx(ct,{className:"h-8 w-8","aria-hidden":"true"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a photo from your camera roll."})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>be.current?.click(),className:"inline-flex items-center gap-2 rounded-full bg-card/80 px-4 py-2 text-sm font-semibold text-foreground shadow-md transition hover:-translate-y-0.5 hover:bg-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:[e.jsx(ct,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:"Choose another photo"})]}),e.jsxs("button",{type:"button",onClick:At,disabled:!ie||xe,className:"inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-fuchsia-500 via-primary to-blue-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:[xe?e.jsx(se,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:xe?"Sendingâ€¦":"Send photo"})]})]})]})]})})]})},Ts=(t,r,l,a,o,u)=>{if(!r||!o||t.senderId!==o)return null;if(u[t.id])return{status:"failed"};if(t.id.startsWith("temp-"))return{status:"sending"};const f=r.participants.filter(_=>!_.isSelf);if(f.length===0)return null;const d=f.map(_=>_.id),m=new Date(t.createdAt).getTime(),p=(l??[]).filter(_=>_.messageId===t.id&&d.includes(_.userId)).length,g=a??[];let N=0,w=null;for(const _ of f){const E=g.find($=>$.userId===_.id);if(!E||!E.lastReadAt)continue;const I=new Date(E.lastReadAt).getTime();Number.isNaN(I)||I>=m&&(N+=1,(w===null||I>w)&&(w=I))}return N===f.length&&f.length>0?{status:"seen",seenAt:w!=null?new Date(w).toISOString():null}:p>0?{status:"delivered"}:{status:"sent"}};export{Ms as ChatImage,Bs as default,Rs as useSendMessage};
