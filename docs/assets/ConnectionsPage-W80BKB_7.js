import{b as C,A as L,s as F,w as E,u as S,x as k,R as _,j as e,L as q,B as M}from"./index-yaS868vE.js";import{Y as R}from"./index-3WBCh0tp.js";import{T as P}from"./TopBar-DVbOlr27.js";import{S as $}from"./SearchField-6So5ppG5.js";import{u as T}from"./useToggleFollow-18dQkAwo.js";import{r as A}from"./resolveAvatarUrl-Bv46IzST.js";import{U as z,a as I}from"./user-plus-Rsyw3nCt.js";const B=25,Q=t=>{if(!t)return null;const s=t.trim();return s?s.startsWith("@")?s:`@${s}`:null};function Y(t,s){const{user:n}=C(),m=n?.id??null;return L({queryKey:["connections",t??null,s,m],enabled:!!t,initialPageParam:0,getNextPageParam:l=>l.nextOffset,queryFn:async({pageParam:l})=>{const d=typeof l=="number"?l:0;if(!t)return{items:[]};const h=F.from("follows").select("follower_id, followed_id, created_at").order("created_at",{ascending:!1}),{data:i,error:c}=await(s==="followers"?h.eq("followed_id",t):h.eq("follower_id",t)).range(d,d+B-1);if(c)throw new Error(c.message);const p=i??[],u=p.map(o=>s==="followers"?o.follower_id:o.followed_id);if(u.length===0)return{items:[]};const{data:j,error:x}=await F.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",u);if(x)throw new Error(x.message);const v=j??[],f=new Map(v.map(o=>[o.id,o])),y=await Promise.all(u.map(o=>A(typeof f.get(o)?.avatar_url=="string"?f.get(o).avatar_url:null)));let N=new Set;if(m){const{data:o,error:b}=await F.from("follows").select("followed_id").eq("follower_id",m).in("followed_id",u);b||(N=new Set((o??[]).map(w=>w.followed_id)))}const r=u.map((o,b)=>{const w=f.get(o);return{id:o,username:w?.username??null,displayName:w?.display_name??null,avatarUrl:y[b]??null,bio:w?.bio??null,isFollowing:N.has(o)}}),a=p.length===B?d+B:void 0;return{items:r,nextOffset:a}}})}const U=Q,H=(t,s)=>{const n=(t??s??"?").replace(/^@/,"").trim();return n?n[0]?.toUpperCase():"?"};function O({person:t,viewerId:s,onToggleFollow:n,isToggling:m}){const l=t.displayName??t.username??"Unknown user",d=U(t.username),g=!!(s&&s===t.id);return e.jsxs("div",{className:"flex items-center justify-between gap-3 px-3 py-2",children:[e.jsxs(q,{to:t.username?`/u/${t.username}`:`/u/${t.id}`,className:"flex min-w-0 flex-1 items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center overflow-hidden rounded-full bg-card/80 text-[14px] font-semibold text-foreground",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:l,className:"h-full w-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("span",{children:H(t.displayName,t.username)})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:l}),g&&e.jsx("span",{className:"rounded-full border border-border bg-card px-2 py-0.5 text-[10px] text-muted-foreground",children:"You"})]}),d&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:d}),t.bio&&e.jsx("p",{className:"mt-0.5 line-clamp-2 text-xs text-muted-foreground",children:t.bio})]})]}),!g&&e.jsx(M,{type:"button",size:"sm",variant:t.isFollowing?"outline":"default",className:"h-8 rounded-full px-3 text-xs",onClick:()=>n(t.id,t.isFollowing),disabled:m,children:m?e.jsx("span",{children:"…"}):t.isFollowing?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Following"})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{children:"Follow"})]})})]})}const X=({mode:t})=>{const{username:s}=E(),n=S(),{user:m}=C(),l=T(),{data:d,isLoading:g,isError:h}=k(s??""),i=Y(d?.id??null,t),[c,p]=_.useState(""),u=_.useMemo(()=>(i.data?.pages??[]).flatMap(r=>r.items),[i.data?.pages]),j=_.useMemo(()=>{const r=c.trim().toLowerCase();return r?u.filter(a=>[a.displayName,a.username,U(a.username),a.bio].filter(Boolean).join(" ").toLowerCase().includes(r)):u},[u,c]),x=t==="followers"?"Followers":"Following",v=(r,a)=>{l.mutate({targetUserId:r,currentlyFollowing:a})},f=l.isPending?l.variables?.targetUserId:null,y=!!(i.hasNextPage&&!i.isFetchingNextPage),N=()=>{y&&(c.trim()||i.fetchNextPage())};return g?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:x,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"Loading connections…"})]}):h||!d?e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:x,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3 text-xs text-muted-foreground",children:"We couldn't load this profile."})]}):e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-4",children:[e.jsx(P,{title:x,onBack:()=>n(-1)}),e.jsx("div",{className:"px-3",children:e.jsx($,{placeholder:`Search ${x.toLowerCase()}…`,value:c,onChange:r=>p(r.target.value)})}),e.jsx("div",{className:"flex-1 px-2",children:e.jsx("div",{className:"overflow-hidden rounded-2xl border border-border bg-card/80",children:i.isLoading?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:"Loading…"}):j.length===0?e.jsx("div",{className:"p-4 text-xs text-muted-foreground",children:c.trim()?`No ${x.toLowerCase()} match “${c.trim()}”.`:t==="followers"?"No followers yet.":"Not following anyone yet."}):e.jsx(R,{style:{height:"100%"},data:j,endReached:N,itemContent:(r,a)=>e.jsx(O,{person:a,viewerId:m?.id??null,isToggling:!!(f&&f===a.id),onToggleFollow:v}),components:{Footer:()=>i.isFetchingNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Loading more…"}):i.hasNextPage?e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"Scroll for more"}):e.jsx("div",{className:"p-4 text-center text-xs text-muted-foreground",children:"End"})}})})})]})};export{X as C};
