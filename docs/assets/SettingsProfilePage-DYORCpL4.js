import{C as q,r as x,j as e,e as _,c as R,w as S,F,E as w,B as y,s as k,b as U,f as A,z as T}from"./index-Bghr9v56.js";import{P as V}from"./PageChrome-DLAycf-7.js";import{T as B}from"./TopBar-BdBDCFfr.js";import{I as L}from"./input-DfCZuzqY.js";import{T as E}from"./textarea-BORwdyZC.js";import{B as O,V as P}from"./VerifiedBadge-Dw8xsn8W.js";import{C}from"./circle-alert-D1byO0Jr.js";import{E as z}from"./external-link-Bu_iGdda.js";import{U as $}from"./user-CR5PAUDg.js";import{C as D}from"./circle-check-DV_fQF9J.js";import"./arrow-left-BRyec24i.js";const Y=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],G=q("shield-check",Y),I=({label:r="Avatar",description:s,initialUrl:f=null,disabled:d=!1,onFileChange:u,fallbackIcon:a,className:p})=>{const[h,n]=x.useState(f),l=x.useRef(null),i=x.useRef(null);x.useEffect(()=>{n(f)},[f]),x.useEffect(()=>()=>{i.current&&URL.revokeObjectURL(i.current)},[]);const g=()=>{d||l.current?.click()},o=c=>{const t=c.target.files?.[0]??null;if(!t){u?.(null);return}i.current&&(URL.revokeObjectURL(i.current),i.current=null);const m=URL.createObjectURL(t);i.current=m,n(m),u?.(t)},b="pt-1"+(p?` ${p}`:"");return e.jsxs("div",{className:b,children:[r&&e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:r}),e.jsxs("div",{className:"mt-2 flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:g,disabled:d,className:"relative inline-flex h-12 w-12 items-center justify-center overflow-hidden rounded-full border border-dashed border-border bg-card/80 text-xs font-medium text-muted-foreground hover:border-primary hover:bg-primary/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-60","aria-label":"Upload avatar",children:h?e.jsx("img",{src:h,alt:"Avatar preview",className:"h-full w-full object-cover"}):e.jsx("span",{className:"select-none text-lg",children:a??"ðŸ“½ï¸"})}),s&&e.jsx("div",{className:"text-xs text-left text-muted-foreground",children:s})]}),e.jsx("input",{ref:l,type:"file",accept:"image/*",className:"hidden",onChange:o})]})},K=[{key:"identity",label:"Identity",hint:"For a real person/brand account where you can prove ownership."},{key:"official",label:"Official",hint:"For notable public figures, studios, festivals, or official pages."},{key:"trusted_verifier",label:"Verified by org",hint:"For accounts verified by a trusted organization (e.g., university, studio)."}];function M(r){return r.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).slice(0,8)}function Q(r){return r?r==="rejected"||r==="revoked"?"Rejected":r==="needs_more_info"?"Needs more info":r.charAt(0).toUpperCase()+r.slice(1):""}const W=({userId:r,profile:s})=>{const f=_(),[d,u]=x.useState("identity"),[a,p]=x.useState(""),[h,n]=x.useState(""),l=x.useMemo(()=>M(a),[a]),{data:i,isLoading:g}=R({queryKey:["verification","latest_request",r],enabled:!!r&&!s.isVerified,queryFn:async()=>{const{data:t,error:m}=await k.from("verification_requests").select("*").eq("user_id",r).order("submitted_at",{ascending:!1}).limit(1).maybeSingle();if(m)throw m;return t??null}}),o=S({mutationFn:async()=>{const t={badge_type:d,evidence:l.length?{links:l}:null,notes:h.trim()||null};return await F("request-verification",t)},onSuccess:()=>{n(""),p(""),f.invalidateQueries({queryKey:["verification","latest_request",r]})}}),b=(()=>{if(s.isVerified)return e.jsxs("div",{className:"mt-3 flex items-start justify-between gap-3 rounded-xl border border-emerald-500/20 bg-emerald-500/5 px-3 py-2",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(O,{className:"mt-0.5 h-4 w-4 text-emerald-400","aria-hidden":"true"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Your account is verified"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.verifiedLabel??"Verified",s.verifiedByOrg?` Â· ${s.verifiedByOrg}`:"",s.verifiedAt?` Â· ${new Date(s.verifiedAt).toLocaleDateString()}`:""]})]})]}),e.jsx("div",{className:"shrink-0",children:e.jsx(P,{isVerified:!0,type:s.verifiedType??"identity",label:s.verifiedLabel,verifiedAt:s.verifiedAt,org:s.verifiedByOrg})})]});if(g)return e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(w,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Checking verification statusâ€¦"]});if(!i)return null;const t=i.status,m=Q(t),v=i.submitted_at?new Date(i.submitted_at).toLocaleDateString():null,j=t==="pending"?"bg-muted/70":t==="needs_more_info"?"bg-amber-500/10":"bg-destructive/10",N=t==="pending"?"text-muted-foreground":t==="needs_more_info"?"text-amber-500":"text-destructive";return e.jsx("div",{className:`mt-3 rounded-xl border border-border/60 ${j} px-3 py-2`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(C,{className:`mt-0.5 h-4 w-4 ${N}`,"aria-hidden":"true"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-semibold text-foreground",children:["Verification request: ",m]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[v?`Submitted on ${v}.`:""," ",t==="pending"?"Our team will review it.":t==="needs_more_info"?"Please update your evidence and resubmit.":t==="rejected"||t==="revoked"?"You can submit a new request with stronger evidence.":""]}),i.reviewer_note&&t==="needs_more_info"&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Requested:"})," ",i.reviewer_note]}),i.reviewer_note&&(t==="rejected"||t==="revoked")&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Reason:"})," ",i.reviewer_note]})]})]})})})(),c=!s.isVerified&&i?.status!=="pending";return e.jsxs("div",{className:"space-y-3 rounded-2xl border border-border/60 bg-card/80 p-[var(--card-pad)] shadow-sm",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-border/50",children:e.jsx(G,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"text-sm font-heading font-semibold text-foreground",children:"Verification"}),s.isVerified&&e.jsx(P,{isVerified:!0,type:s.verifiedType??"identity",label:s.verifiedLabel,verifiedAt:s.verifiedAt,org:s.verifiedByOrg})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Verified accounts help reduce impersonation. The badge popover explains what your badge means."})]})]}),b,!s.isVerified&&e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Request a verification badge"}),e.jsx("div",{className:"grid grid-cols-3 gap-2 text-[12px]",children:K.map(t=>{const m=d===t.key;return e.jsxs("button",{type:"button",disabled:!c,onClick:()=>u(t.key),className:`flex flex-col items-start justify-center gap-0.5 rounded-2xl border px-3 py-2 text-left transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background ${m?"border-primary bg-primary/15 text-primary":"border-border bg-background text-muted-foreground hover:bg-card"} ${c?"":"opacity-60 cursor-not-allowed"}`,children:[e.jsx("span",{className:"text-xs font-semibold leading-none",children:t.label}),e.jsx("span",{className:"text-[11px] leading-snug opacity-90",children:t.hint})]},t.key)})})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block type-overline text-muted-foreground",htmlFor:"verification-evidence",children:"Evidence links"}),e.jsx(E,{id:"verification-evidence",value:a,onChange:t=>p(t.target.value),rows:4,className:"text-sm resize-none",placeholder:`Paste 1â€“8 links (one per line).
Example: IMDb page, official website, social profile.`,disabled:!c}),l.length>0&&e.jsxs("div",{className:"mt-1 space-y-1",children:[l.slice(0,3).map(t=>e.jsxs("a",{href:t,target:"_blank",rel:"noreferrer",className:"inline-flex items-center gap-1 text-xs text-primary hover:underline",children:[e.jsx(z,{className:"h-3 w-3","aria-hidden":"true"}),e.jsx("span",{className:"truncate max-w-[320px]",children:t})]},t)),l.length>3&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["+",l.length-3," more"]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block type-overline text-muted-foreground",htmlFor:"verification-notes",children:"Notes (optional)"}),e.jsx(L,{id:"verification-notes",value:h,onChange:t=>n(t.target.value),className:"text-sm",placeholder:"Anything that helps the reviewer (e.g., official email, role, context)",disabled:!c})]}),o.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-destructive",children:[e.jsx(C,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:o.error?.message??"Couldnâ€™t submit request."})]}),o.isSuccess&&!o.isError&&e.jsx("div",{className:"text-xs text-emerald-400",children:"Request submitted. Weâ€™ll review it soon."}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-1",children:[e.jsx(y,{type:"button",variant:"outline",size:"sm",disabled:o.isPending||!c,onClick:()=>{p(""),n("")},children:"Clear"}),e.jsx(y,{type:"button",size:"sm",disabled:o.isPending||!c||l.length===0&&!h.trim(),onClick:()=>o.mutate(),children:o.isPending?e.jsx(w,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}):"Submit request"})]}),!c&&i?.status==="pending"&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"You already have a pending request. You can submit again after itâ€™s reviewed."})]})]})},J=({initialProfile:r,user:s})=>{const f=_(),[d,u]=x.useState({displayName:r.displayName,bio:r.bio,avatarFile:null}),a=S({mutationFn:async({displayName:n,bio:l,avatarFile:i})=>{let g=r.avatarUrl;if(i){const c=(i.name.split(".").pop()??"").trim().toLowerCase();if(!new Set(["jpg","jpeg","png","webp"]).has(c))throw new Error("Please upload a JPG, PNG, or WebP image.");const m={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"},v=`${s.id}/${Date.now()}.${c}`,{error:j,data:N}=await k.storage.from("avatars").upload(v,i,{cacheControl:"3600",upsert:!0,contentType:m[c]??"application/octet-stream"});if(j)throw j;g=N?.path??v}const{error:o}=await k.from("profiles").update({display_name:n.trim(),bio:l.trim(),avatar_url:g??""}).eq("id",s.id);if(o)throw o},onSuccess:()=>{f.invalidateQueries({queryKey:["profile"]}),u(n=>({...n,avatarFile:null}))}}),p=n=>l=>{u(i=>({...i,[n]:l.target.value}))},h=async n=>{n.preventDefault(),!a.isPending&&await a.mutateAsync({displayName:d.displayName,bio:d.bio,avatarFile:d.avatarFile})};return e.jsxs("form",{onSubmit:h,className:"space-y-3",children:[e.jsxs("div",{className:"mb-2 flex items-start gap-3",children:[e.jsx("span",{className:"inline-flex h-7 w-7 items-center justify-center rounded-full bg-border/50",children:e.jsx($,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("h2",{className:"text-sm font-heading font-semibold text-foreground",children:"Public profile"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your profile is shown on your diary, reviews, and social features."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(I,{initialUrl:r.avatarUrl,description:"Upload a square image (PNG/JPG) to use across the app.",disabled:a.isPending,onFileChange:n=>u(l=>({...l,avatarFile:n}))}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"displayName",className:"block type-overline text-muted-foreground",children:"Display name"}),e.jsx(L,{id:"displayName",type:"text",value:d.displayName,onChange:p("displayName"),maxLength:80,className:"text-sm",placeholder:"How should we show your name?"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This is the name other people see on your profile and activity."})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"bio",className:"block type-overline text-muted-foreground",children:"Bio"}),e.jsx(E,{id:"bio",value:d.bio,onChange:p("bio"),rows:4,maxLength:280,className:"text-sm resize-none",placeholder:"Tell people a bit about your taste in movies."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can use multiple lines. Keep it short and cinematic."})]})]}),(a.isError||a.isSuccess)&&e.jsxs("div",{className:"pt-1 text-xs",children:[a.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-destructive",children:[e.jsx(C,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:a.error?.message??"Couldnâ€™t save changes."})]}),a.isSuccess&&!a.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-emerald-400",children:[e.jsx(D,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:"Profile updated."})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{u({displayName:r.displayName,bio:r.bio,avatarFile:null}),a.reset()},children:"Reset"}),e.jsx(y,{type:"submit",size:"sm",disabled:a.isPending,children:a.isPending?e.jsx(w,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}):e.jsx("span",{children:"Save changes"})})]})]})},oe=()=>{const{user:r}=U(),{data:s,isLoading:f,isError:d,error:u}=A();if(!r)return e.jsx("div",{className:"flex flex-1 flex-col items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"You're signed out"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to edit your profile settings."})]})});if(f)return e.jsx(T,{message:"Loading your profileâ€¦"});if(d||!s)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Profile unavailable"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"We couldn't load your profile right now."}),u?.message&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Details:"})," ",u.message]})]})});const a={displayName:s.displayName??"",bio:s.bio??"",avatarUrl:s.avatarUrl??null};return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-2 pt-1",children:[e.jsx(B,{title:"Profile"}),e.jsx("section",{className:"pb-2",children:e.jsxs(V,{children:[e.jsx(J,{initialProfile:a,user:r},s?.displayName+(s?.bio??"")+(s?.avatarUrl??"")),e.jsx("div",{className:"mt-4",children:e.jsx(W,{userId:r.id,profile:{isVerified:!!s.isVerified,verifiedType:s.verifiedType??null,verifiedLabel:s.verifiedLabel??null,verifiedAt:s.verifiedAt??null,verifiedByOrg:s.verifiedByOrg??null}})})]})})]})};export{oe as default};
