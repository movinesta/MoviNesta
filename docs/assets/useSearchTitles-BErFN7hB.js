import{c as E,r as I,j as S,D as R,E as x,t as k,s as M,o as A,y as N,G as $}from"./index-C0YC7Lqk.js";const D=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],j=E("x",D),F=I.forwardRef(({className:s,type:e,...n},r)=>S.jsx("input",{type:e,className:R("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:r,...n}));F.displayName="Input";const H=(s,e)=>{const[n,r]=I.useState(s);return I.useEffect(()=>{const d=window.setTimeout(()=>{r(s)},e);return()=>{window.clearTimeout(d)}},[s,e]),n},y=s=>{if(s?.aborted)throw s.reason??new DOMException("Aborted","AbortError")};async function q(s,e){const n=s.map(async r=>{if(r.imdbId||!r.tmdbId)return r;y(e);try{const d=await x(`/${r.type==="tv"?"tv":"movie"}/${r.tmdbId}/external_ids`,{},e);return y(e),{...r,imdbId:d?.imdb_id??null}}catch(d){return console.warn("[externalMovieSearch] Failed to fetch external ids for",r.tmdbId,d),r}});return Promise.all(n)}async function L(s,e=1,n){const r=s.trim();if(!r)return{results:[],hasMore:!1};y(n);const d=await x("/search/multi",{query:r,include_adult:!1,page:e},n);y(n);const c=Array.isArray(d?.results)?d.results:[];if(!c.length)return{results:[],hasMore:!1};const a=typeof d?.total_pages=="number"?d.total_pages:1,_=c.filter(o=>!!(o&&typeof o.id=="number"&&(o.media_type==="movie"||o.media_type==="tv"))).slice(0,20).map(o=>{const m=o.media_type==="tv"?"tv":"movie",u=o.release_date??o.first_air_date??null,b=u?Number(String(u).slice(0,4)):null;return{tmdbId:Number(o.id),imdbId:o.imdb_id??null,title:o.title??o.name??"Untitled",year:Number.isNaN(b)?null:b,type:m,posterUrl:k(o.poster_path??null)}});return{results:await q(_,n),hasMore:e<a}}const h=s=>{if(s?.aborted)throw s.reason??new DOMException("Aborted","AbortError")},w=s=>{const e=N(s);return{id:e.id,title:e.title,year:e.year,type:e.type,source:"library",posterUrl:e.posterUrl??e.backdropUrl,originalLanguage:e.originalLanguage,ageRating:e.ageRating,imdbRating:e.imdbRating,rtTomatoMeter:e.rtTomatoMeter,imdbId:e.imdbId,tmdbId:e.tmdbId}},g=20,P=5,U=async(s,e,n,r)=>{h(r);try{const i=await A("media-search",{query:s.trim(),page:n,limit:g,filters:e??{}},{signal:r,timeoutMs:2e4});if(i?.ok&&Array.isArray(i.results))return h(r),{results:i.results.map(w),hasMore:!!i.hasMore}}catch(i){console.warn("[search.service] media-search Edge Function failed, falling back",i)}const d=`
    id,
    kind,
    tmdb_id,
    tmdb_title,
    tmdb_name,
    tmdb_original_title,
    tmdb_original_name,
    tmdb_release_date,
    tmdb_first_air_date,
    tmdb_poster_path,
    tmdb_backdrop_path,
    tmdb_original_language,
    tmdb_genre_ids,
    omdb_title,
    omdb_year,
    omdb_language,
    omdb_imdb_id,
    omdb_imdb_rating,
    omdb_rating_rotten_tomatoes,
    omdb_poster,
    omdb_rated
  `,c=(n-1)*g;let a=M.from("media_items").select(d,{count:"exact"});if(a=a.range(c,c+g-1),r&&(a=a.abortSignal(r)),s&&(a=a.textSearch("search_vector",s.trim(),{config:"english",type:"websearch"})),e?.type&&e.type!=="all"&&(a=a.eq("kind",e.type==="series"?"series":e.type)),e?.genreIds?.length&&(a=a.overlaps("tmdb_genre_ids",e.genreIds)),typeof e?.minYear=="number"){const i=`${e.minYear}-01-01`;a=a.or(`tmdb_release_date.gte.${i},tmdb_first_air_date.gte.${i}`)}if(typeof e?.maxYear=="number"){const i=`${e.maxYear}-12-31`;a=a.or(`tmdb_release_date.lte.${i},tmdb_first_air_date.lte.${i}`)}e?.originalLanguage&&(a=a.eq("tmdb_original_language",e.originalLanguage)),a=a.order("tmdb_release_date",{ascending:!1,nullsFirst:!1}).order("tmdb_first_air_date",{ascending:!1,nullsFirst:!1}).order("tmdb_title",{ascending:!0,nullsFirst:!0});const{data:_,error:f,count:o}=await a;if(f)throw new Error(f.message);h(r);const m=_??[],u=typeof o=="number"?o:void 0,b=u?c+m.length<u:m.length===g;return{results:m.map(w),hasMore:b}},Y=async s=>{const{query:e,filters:n,page:r=1,signal:d}=s,c=e.trim();h(d);let a=[],_=!1;try{const{results:t,hasMore:p}=await U(c,n,r,d);a=t,_=p}catch(t){console.warn("[search.service] Supabase search failed, falling back to TMDb",t)}const{results:f,hasMore:o}=await L(c,r,d);if(h(d),!f.length&&a.length>0)return{results:a,hasMore:_};const m=new Set,u=new Set;for(const t of a)t.tmdbId&&m.add(t.tmdbId),t.imdbId&&u.add(t.imdbId);const b=f.filter(t=>!(t.tmdbId&&m.has(t.tmdbId)||t.imdbId&&u.has(t.imdbId))),i=new Map;if(b.length)try{const{data:t,error:p}=await M.from("media_items").upsert(b.slice(0,P).map(l=>({tmdb_id:l.tmdbId,omdb_imdb_id:l.imdbId??null,kind:l.type==="tv"?"series":"movie",tmdb_title:l.title,tmdb_release_date:l.year?`${l.year}-01-01`:null})),{onConflict:"kind,tmdb_id"}).select("id, tmdb_id");p&&console.error("[search.service] Failed to upsert media_items. This might be due to missing RLS permissions or schema mismatch.",p),(t??[]).forEach(l=>{l.tmdb_id!=null&&l.id&&i.set(Number(l.tmdb_id),l.id)})}catch(t){console.warn("[search.service] media_items upsert failed",t)}const v=await Promise.all(b.map(async t=>{h(d);const p=t.type==="tv"?"series":"movie",l=t.tmdbId&&i.get(t.tmdbId)?i.get(t.tmdbId):`tmdb-${t.tmdbId??Math.random()}`,T=!l.startsWith("tmdb-");return t.tmdbId&&m.add(t.tmdbId),t.imdbId&&u.add(t.imdbId),{id:l,title:t.title,year:t.year??null,type:p,source:T?"external-synced":"external-only",posterUrl:t.posterUrl,originalLanguage:null,ageRating:null,imdbRating:null,rtTomatoMeter:null,imdbId:t.imdbId??null,tmdbId:t.tmdbId}}));return{results:[...a,...v.filter(t=>!!t)],hasMore:_||o}},O=s=>{const{query:e,filters:n}=s,r=e.trim();return $({queryKey:["search","titles",{query:r,filters:n}],enabled:r.length>0,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,initialPageParam:1,getNextPageParam:(d,c)=>d.hasMore?c.length+1:void 0,queryFn:({signal:d,pageParam:c})=>Y({query:r,filters:n,page:c??1,signal:d})})};export{F as I,j as X,H as a,O as u};
