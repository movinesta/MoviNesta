import{b as V,e as J,c as $,s as c,d as k}from"./index-BhQyicj1.js";const X="moviNesta.suggestedPeople.dismissed.v1",B=s=>`${X}:${s}`,M=s=>{try{const n=localStorage.getItem(B(s));if(!n)return[];const a=JSON.parse(n);return Array.isArray(a)?a.filter(y=>typeof y=="string"):[]}catch{return[]}},Y=(s,n)=>{const a=new Set(M(s));a.add(n);try{localStorage.setItem(B(s),JSON.stringify(Array.from(a)))}catch{}},H=()=>{const{user:s}=V(),n=s?.id??"__anon__",a=J();return{...$({queryKey:["suggested-people",n],enabled:!0,staleTime:1e3*60*5,gcTime:1e3*60*30,queryFn:async()=>{const r=s?.id??null,N=new Set(M(n)),{data:R,error:w}=r?await c.from("follows").select("followed_id").eq("follower_id",r):{data:[],error:null};w&&console.warn("[useSuggestedPeople] Failed to load follows",w.message);const v=new Set((R??[]).map(e=>e.followed_id)),h=new Set([...r?[r]:[],...N,...v]),{data:C,error:P}=r?await c.from("ratings").select("title_id, rating").eq("user_id",r).order("rating",{ascending:!1}).limit(40):{data:[],error:null};P&&console.warn("[useSuggestedPeople] Failed to load viewer ratings",P.message);const S=C?C.filter(e=>typeof e.title_id=="string"&&typeof e.rating=="number").slice(0,30):[],p=Array.from(new Set(S.map(e=>e.title_id))),T=new Map(S.map(e=>[e.title_id,e.rating??0])),{data:U,error:b}=await c.from("user_stats").select("user_id, followers_count, following_count").order("followers_count",{ascending:!1}).limit(60);b&&console.warn("[useSuggestedPeople] Failed to load user_stats",b.message);const A=(U??[]).filter(e=>!h.has(e.user_id)),f=A.map(e=>e.user_id).slice(0,40);if(!f.length)return[];const{data:O,error:E}=await c.from("profiles_public").select("id, username, display_name, avatar_url, bio, is_verified, verified_type, verified_label, verified_at, verified_by_org").in("id",f).limit(40);if(E)throw new Error(E.message);const D=new Map(A.map(e=>[e.user_id,{followersCount:e.followers_count??0,followingCount:e.following_count??0}])),m=new Map;if(p.length>=5){const{data:e,error:t}=await c.from("ratings").select("user_id, title_id, rating").in("user_id",f).in("title_id",p).limit(2e3);if(t)console.warn("[useSuggestedPeople] Failed to load candidate ratings",t.message);else{const o=e??[],l=new Map;o.forEach(i=>{if(!i?.user_id)return;const d=l.get(i.user_id)??[];d.push(i),l.set(i.user_id,d)}),f.forEach(i=>{const F=(l.get(i)??[]).filter(u=>T.has(u.title_id)),g=F.length;if(!g){m.set(i,{commonTitlesCount:0,matchPercent:0,score:0});return}let I=0,_=0;F.forEach(u=>{const q=T.get(u.title_id);typeof q!="number"||typeof u.rating!="number"||(I+=Math.abs(q-u.rating),_+=1)});const x=_?I/_:0,K=g*10-x*2,Q=Math.round(g/Math.max(1,p.length)*100);m.set(i,{commonTitlesCount:g,matchPercent:Q,score:K})})}}const L=(O??[]).map(e=>{const t=D.get(e.id),o=m.get(e.id);return{id:e.id,username:e.username??null,displayName:e.display_name??null,avatarPathOrUrl:typeof e.avatar_url=="string"?e.avatar_url:null,bio:e.bio??null,followersCount:t?.followersCount??0,followingCount:t?.followingCount??0,isFollowing:v.has(e.id),commonTitlesCount:o?.commonTitlesCount,matchPercent:o?.matchPercent,isVerified:e.is_verified??null,verifiedType:e.verified_type??null,verifiedLabel:e.verified_label??null,verifiedAt:e.verified_at??null,verifiedByOrg:e.verified_by_org??null,_score:o?.score??0}}).filter(e=>!h.has(e.id));return(await Promise.all(L.map(async e=>{const t=await k(e.avatarPathOrUrl);return{id:e.id,username:e.username,displayName:e.displayName,avatarUrl:t,bio:e.bio,followersCount:e.followersCount,followingCount:e.followingCount,isFollowing:e.isFollowing,commonTitlesCount:e.commonTitlesCount,matchPercent:e.matchPercent,isVerified:e.isVerified??null,verifiedType:e.verifiedType??null,verifiedLabel:e.verifiedLabel??null,verifiedAt:e.verifiedAt??null,verifiedByOrg:e.verifiedByOrg??null}}))).map(e=>({person:e,score:m.get(e.id)?.score??0})).sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;const o=e.person.commonTitlesCount??0,l=t.person.commonTitlesCount??0;if(l!==o)return l-o;if(t.person.followersCount!==e.person.followersCount)return t.person.followersCount-e.person.followersCount;const i=(e.person.displayName??e.person.username??"").toLowerCase(),d=(t.person.displayName??t.person.username??"").toLowerCase();return i.localeCompare(d)}).map(e=>e.person).slice(0,15)}}),dismissPerson:r=>{s?.id&&(Y(s.id,r),a.invalidateQueries({queryKey:["suggested-people",s.id]}))}}};export{H as u};
