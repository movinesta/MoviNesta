import{j as e,y as ue,u as xe,R as F,g as pe,i as D,h as ge,q as U,t as ee,L as $,v as fe,s as k,f as he}from"./index-BJNwabbL.js";import{a as be,c as ye,d as je,b as ve}from"./diaryStatus-d6O9GDSI.js";import{P as N}from"./PageChrome-DjRybs36.js";import{C as A}from"./Chip-CNb4YVPA.js";import{T as q}from"./TopBar-Cwkp26YK.js";import"./useMutation-CiYMdxMt.js";const te=({value:a,max:o=5,disabled:l,onChange:g,size:h="sm"})=>{const f=a??0,t=h==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-xs transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-sm transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:o}).map((B,I)=>{const i=I+1,c=f>=i;return e.jsx("button",{type:"button",onClick:()=>{if(!g||l)return;g(f===i?null:i)},disabled:l,className:`${t} ${c?"border-primary/80 bg-primary/90 text-primary-foreground":"border-border bg-card/60 text-muted-foreground hover:border-primary/70 hover:text-primary/90"}`,"aria-label":`Rate ${i} star${i===1?"":"s"}`,children:"★"},i)})})},Ne=({imdb_rating:a,rt_tomato_pct:o,metascore:l})=>{if(!(typeof a=="number"&&a>0||typeof o=="number"&&o>0||typeof l=="number"&&l>0))return null;const h=typeof a=="number"&&!Number.isNaN(a)&&a>0,f=typeof o=="number"&&!Number.isNaN(o)&&o>0,t=typeof l=="number"&&!Number.isNaN(l)&&l>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-muted-foreground",children:[h&&e.jsxs(A,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"IMDb"}),e.jsx("span",{children:a.toFixed(1)})]}),f&&e.jsxs(A,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"Tomatometer"}),e.jsxs("span",{children:[o,"%"]})]}),t&&e.jsxs(A,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"MC"}),e.jsx("span",{children:l})]})]})},Pe=()=>{const{titleId:a}=ue(),o=xe(),[l,g]=F.useState(null),h=F.useMemo(()=>pe(),[]),f=async r=>{if(!i?.id){alert("You need to be signed in to start a conversation.");return}if(i.id!==r){g(r);try{const s=await fe("create-direct-conversation",{targetUserId:r},{timeoutMs:25e3});if(!s?.ok||!s.conversationId){const d=s?.errorCode;let x=s?.error??"Failed to get conversation id. Please try again.";d==="UNAUTHORIZED"?x="You need to be signed in to start a conversation.":d==="BAD_REQUEST_SELF_TARGET"?x="You can't start a conversation with yourself.":d==="SERVER_MISCONFIGURED"&&(x="Messaging is temporarily unavailable due to a server issue. Please try again later.");const v=new Error(x);throw v.code=d,v}o(`/messages/${s.conversationId}`)}catch(s){console.error("[TitleDetailPage] Failed to start conversation",s);const d=s instanceof Error?s.message:"Something went wrong while starting the conversation. Please try again.";alert(d)}finally{g(null)}}},{data:t,isLoading:B,isError:I}=D({queryKey:U.titleDetail(a),enabled:!!a,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!a)return null;const{data:r,error:s}=await k.from("titles").select(`
          title_id,
          content_type,
          primary_title,
          original_title,
          sort_title,
          release_year,
          release_date,
          runtime_minutes,
          tmdb_runtime,
          tmdb_episode_run_time,
          plot,
          tmdb_overview,
          tagline,
          omdb_director,
          omdb_actors,
          genres,
          tmdb_genre_names,
          language,
          omdb_language,
          tmdb_original_language,
          country,
          omdb_country,
          imdb_rating,
          imdb_votes,
          metascore,
          rt_tomato_pct,
          poster_url,
          tmdb_poster_path,
          backdrop_url
        `).eq("title_id",a).maybeSingle();if(s)throw s;return r}}),{user:i}=ge(),{updateStatus:c,updateRating:b}=be(),{data:re}=ye(a),m=re??{status:null,rating:null},{data:S,isLoading:se}=D({queryKey:U.friendsTitleReactions(i?.id??null,a),enabled:!!(i?.id&&a),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!i?.id||!a)return[];const r=i.id,{data:s,error:d}=await k.from("follows").select("followed_id").eq("follower_id",r).limit(80);if(d)throw d;const x=(s??[]).map(n=>n.followed_id).filter(Boolean);if(!x.length)return[];const{data:v,error:Z}=await k.from("ratings").select("user_id, rating, created_at").eq("title_id",a).in("user_id",x).order("rating",{ascending:!1}).limit(40);if(Z)throw Z;const J=(v??[]).map(n=>n.user_id);if(!J.length)return[];const{data:de,error:X}=await k.from("profiles").select("id, display_name, username, avatar_url").in("id",J);if(X)throw X;const ce=new Map((de??[]).map(n=>[n.id,{displayName:n.display_name??null,username:n.username??null,avatarUrl:n.avatar_url??null}])),me=(v??[]).map(n=>{const p=n.user_id,M=ce.get(p);return{userId:p,displayName:M?.displayName??null,username:M?.username??null,avatarUrl:M?.avatarUrl??null,rating:n.rating??null,createdAt:n.created_at??null}}),L=new Map;for(const n of me){const p=L.get(n.userId);(!p||(n.rating??0)>(p.rating??0))&&L.set(n.userId,n)}return Array.from(L.values()).sort((n,p)=>(p.rating??0)-(n.rating??0))}}),{data:ae,isLoading:Y}=D({queryKey:U.moreLikeThis(a),enabled:!!a,staleTime:1e3*60*10,gcTime:1e3*60*60,queryFn:async()=>{if(!a)return[];try{const{cards:r}=await he({sessionId:h,mode:"combined",limit:18,seed:a},{timeoutMs:2e4});return(r??[]).map(s=>({id:String(s.mediaItemId),title:(s.title??"Untitled").trim()||"Untitled",year:s.releaseYear??null,tmdbPosterPath:s.tmdbPosterPath??null,posterUrl:s.posterUrl??null,source:null})).filter(s=>!!(s.id&&s.title))}catch(r){return console.warn("[TitleDetailPage] more-like-this failed",r),[]}}}),w=t?t.poster_url??ee(t.tmdb_poster_path,"w500"):null,_=t?t.backdrop_url:null;if(F.useEffect(()=>{const r=[w,_].filter(s=>!!s);r.length!==0&&r.forEach(s=>{const d=new Image;d.src=s})},[w,_]),!a)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(q,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(N,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(B)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(q,{title:"Loading title"}),e.jsx(N,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-card/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-card/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-card/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-card/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-card/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-card/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-card/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-card/40"})]})]})]})})]});if(I||!t)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(q,{title:"Title not found"}),e.jsxs(N,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"We couldn't find that title."}),e.jsx($,{to:"/search",className:"mt-3 inline-block text-sm text-primary underline",children:"Back to search"})]})]});const T=t.primary_title??t.original_title??"Untitled",O=t.release_year??(t.release_date?new Date(t.release_date).getFullYear():null),y=t.runtime_minutes??t.tmdb_runtime??(Array.isArray(t.tmdb_episode_run_time)&&t.tmdb_episode_run_time.length>0?t.tmdb_episode_run_time[0]:null),z=typeof y=="number"&&y>0?`${Math.floor(y/60)}h ${y%60?`${y%60}m`:""}`.trim():null,P=t.content_type==="movie"?"Movie":t.content_type==="series"?"TV Series":t.content_type??null,K=t.language??t.omdb_language??t.tmdb_original_language??null,W=t.country??t.omdb_country??null,C=t.genres&&t.genres.length>0&&t.genres||t.tmdb_genre_names&&t.tmdb_genre_names.length>0&&t.tmdb_genre_names||[],j=t.plot??t.tmdb_overview??null,V=ae??[],u=[];O&&u.push(String(O)),P&&u.push(P),z&&u.push(z),W&&u.push(W),K&&u.push(K);const ne=t.imdb_rating,ie=t.metascore,le=t.rt_tomato_pct,G=t.content_type==="movie"||t.content_type==="series"?t.content_type:null,Q=()=>i?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),R=r=>{!Q()||c.isPending||c.mutate({titleId:t.title_id,status:r,type:G})},H=r=>{!Q()||b.isPending||b.mutate({titleId:t.title_id,rating:r,type:G})},oe=u.length>0?u.join(" · "):"Title details",E=r=>m?.status===r;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-border bg-card/80 shadow-md",children:[e.jsxs("div",{className:"absolute inset-0",children:[_?e.jsx("img",{src:_,alt:T,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-background via-background/70 to-card"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-background via-background/80 to-background/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:w?e.jsx("img",{src:w,alt:T,className:"aspect-[2/3] w-full rounded-2xl object-cover shadow-lg",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-2xl border border-dashed border-border bg-background/70 text-xs text-muted-foreground",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.12em] text-muted-foreground",children:P??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground sm:text-3xl",children:T}),e.jsx("p",{className:"text-[12.5px] text-muted-foreground",children:oe})]}),j&&e.jsx("p",{className:"max-w-3xl text-sm leading-relaxed text-muted-foreground sm:text-[14px]",children:j}),e.jsx(Ne,{imdb_rating:ne,rt_tomato_pct:le,metascore:ie}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>R("want_to_watch"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("want_to_watch")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>R("watching"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("watching")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>R("watched"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${E("watched")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-muted-foreground",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Your rating"}),e.jsx(te,{value:m?.rating??null,disabled:b.isPending,onChange:H}),m?.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[m.rating,"/10"]})]}),!i&&e.jsxs("p",{className:"text-[11.5px] text-muted-foreground",children:[e.jsx($,{to:"/auth",className:"font-medium text-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsxs(N,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"More like this"}),Y&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loading…"})]}),Y?e.jsx("div",{className:"mt-3 flex gap-2 overflow-x-auto pb-1",children:Array.from({length:6}).map((r,s)=>e.jsx("div",{className:"h-40 w-28 flex-shrink-0 animate-pulse rounded-xl border border-border bg-card/70"},s))}):V.length>0?e.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2",children:V.map(r=>{const s=r.posterUrl??(r.tmdbPosterPath?ee(r.tmdbPosterPath,"w342"):null);return e.jsxs("button",{type:"button",onClick:()=>o(`/title/${r.id}`),className:"flex w-28 flex-shrink-0 flex-col gap-1 text-left",children:[e.jsx("div",{className:"aspect-[2/3] w-28 overflow-hidden rounded-xl border border-border bg-card/80",children:s?e.jsx("img",{src:s,alt:r.title,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] text-muted-foreground",children:"No poster"})}),e.jsx("span",{className:"line-clamp-2 text-[12px] text-foreground",children:r.title}),r.year&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:r.year})]},r.id)})}):e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"No similar titles yet."})]}),e.jsx(N,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-background/80 px-3 py-3 text-[12px] text-muted-foreground",children:[t.tagline&&e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.tagline}),j&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-muted-foreground",children:j}),!t.tagline&&!j&&e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"We don't have a plot summary for this title yet."}),C&&C.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:C.slice(0,6).map(r=>e.jsx("span",{className:"rounded-full border border-border px-2 py-[2px] text-xs text-muted-foreground",children:r},r))}),(t.omdb_director||t.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-muted-foreground",children:[t.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Director:"})," ",t.omdb_director]}),t.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Cast:"})," ",t.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),i&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs",children:[e.jsx("span",{className:ve(m?.status),children:je(m?.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Rating"}),e.jsx(te,{value:m?.rating??null,disabled:b.isPending,onChange:H})]})]})]}),!i&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to see your diary status and ratings for this title."})]}),i&&!se&&S&&S.length>0&&e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:S.slice(0,4).map(r=>{const s=r.displayName??(r.username?`@${r.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-card text-xs font-semibold text-foreground",children:r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:s??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(s??"?")[0]?.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-foreground",children:s}),r.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Rated ",r.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx($,{to:r.username?`/u/${r.username}`:`/u/${r.userId}`,className:"text-xs font-medium text-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>f(r.userId),disabled:l===r.userId,className:"text-xs font-medium text-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:l===r.userId?"Starting…":"Message"})]})]},r.userId)})})]})]})})})]})};export{Pe as default};
