import{D as Ge,s as ae,r as n,ar as Me,e as we,a9 as Sr,as as vt,b as zt,at as Cr,c as Ht,y as Ns,au as Gs,av as kr,aw as Ir,al as Ms,v as Er,ax as Ys,o as Tr,ay as on,az as Ar,aA as ln,ao as vs,P as cn,aB as Lr,R as Z,j as e,i as Rs,B as $,F as Ve,aC as Xs,aD as Zs,aE as en,u as un,ap as X,aF as dn,ak as Dr,aG as _r,aH as Ur,K as Or,C as Fr,aq as tn,O as qr,n as Br,L as Pr}from"./index-BhYCkKJ1.js";import{m as Kt,a as fn,b as $r,M as Ss,s as zr,i as mn,c as gn,d as pn,e as hn,f as Hr,n as Kr,r as xn,g as yn,h as Qr,C as Jr,j as Wr,k as Vr,F as wt,S as Gr,T as Yr,l as sn,u as Xr,o as Zr,p as ea,q as ta,t as sa,v as na}from"./scroll-area-BOIyfGIP.js";import{u as _e}from"./conversationsCache-BwsAQT1F.js";import{w as ra,a as aa,B as ia,u as oa,M as la}from"./useAssistantCache-vISaEJCQ.js";import{B as ca}from"./bell-p7JEW6s7.js";import{T as bn}from"./textarea-x-0MfePo.js";import{D as Qt,a as Jt,b as Cs,c as Wt,f as ua,d as wn,e as vn}from"./dialog-DKXGxth9.js";import{E as da}from"./ellipsis-qoQNJLa2.js";import{X as xs}from"./x-7msmISva.js";import{C as nn}from"./circle-alert-BzPyYlSk.js";import{M as re}from"./material-icon-DzJ3uwwf.js";import{C as fa}from"./copy-BS5PHfYr.js";import{U as ma}from"./user-DFAZFA4c.js";import{u as ga}from"./useUserLastActive-B3ynIkGR.js";import"./format-BXv9LLlt.js";import"./external-link-D4YkaPzQ.js";import"./plus-C69Lhyvl.js";import"./index-D2Ybm6Xt.js";import"./clock-D5sp4i7x.js";const pa=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ha=Ge("arrow-down",pa);const xa=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],ys=Ge("camera",xa);const ya=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],ba=Ge("paperclip",ya);const wa=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],va=Ge("send",wa);const ja=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],jn=Ge("shield-x",ja);const Na=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Ma=Ge("smile",Na);const Ra=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],bs=Ge("volume-2",Ra),js=new Map,Sa=s=>{const t=js.get(s);if(t)return t;const r=ae.channel(`conversation-db-${s}`),o={conversationId:s,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT")for(const c of o.messageInsertListeners)c(l);else if(l.eventType==="UPDATE")for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},i=>{const l=i;if(l.eventType==="INSERT"||l.eventType==="UPDATE")for(const c of o.reactionUpsertListeners)c(l);else if(l.eventType==="DELETE")for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(i=>{const l=i;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),js.set(s,o),o},Ca=(s,t)=>{const r=Sa(s);r.refCount+=1;const o=[];return t.onStatus&&(r.statusListeners.add(t.onStatus),o.push(()=>r.statusListeners.delete(t.onStatus)),r.lastStatus&&t.onStatus(r.lastStatus)),t.onMessageInsert&&(r.messageInsertListeners.add(t.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(r.messageUpdateListeners.add(t.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(r.reactionUpsertListeners.add(t.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(r.reactionDeleteListeners.add(t.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const i of o)i();if(r.refCount-=1,r.refCount<=0){try{ae.removeChannel(r.channel)}catch{}js.delete(s)}}},Vt=(s,t,r)=>{n.useEffect(()=>{if(s)return Ca(s,t())},[s,t,...r])},ka=5e3,Ia=1500,Ea=5e3,Ta=s=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:s?Ia:ka,refetchIntervalInBackground:!1}),Aa=new Set(["SUBSCRIBED"]),La=s=>!Aa.has(s),Da=s=>{const[t,r]=n.useState(!1),o=n.useRef(s);n.useEffect(()=>{Object.is(o.current,s)||(o.current=s,r(!1))},[s]);const i=n.useCallback(l=>{const c=La(l);r(y=>y===c?y:c)},[]);return{pollWhenRealtimeDown:t,onStatus:i}},Gt=s=>{const{pollWhenRealtimeDown:t,onStatus:r}=Da(s);return{pollWhenRealtimeDown:t,onRealtimeStatus:r,refetchOptions:Ta(t)}},_a=s=>typeof s=="object"&&s!==null,Nn=s=>s.new,Ua=s=>s.old,nt=(s,t)=>{if(!_a(s))return null;const r=s[t];return typeof r=="string"?r:null},Mn=(s,t)=>nt(s,"conversation_id")===t,Rn=40,$t=1e5,Oa=s=>`"${s.replace(/"/g,'\\"')}"`,Fa=s=>{const t=Oa(s.createdAt),r=s.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${r})`},qa=s=>{const t=zr((s??[]).map(Kt)),r=(s??[]).length>=Rn,o=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:r,cursor:o}},Ba=(s,t)=>{const r=n.useMemo(()=>Me(s),[s]),o=we(),[i,l]=n.useState($t),{pollWhenRealtimeDown:c,onRealtimeStatus:y,refetchOptions:m}=Gt(s),g=n.useRef(t);n.useEffect(()=>{g.current=t},[t]);const h=n.useRef({pages:0,total:0}),d=Sr({queryKey:r,enabled:!!s,initialPageParam:null,...m,staleTime:Ea,queryFn:async({pageParam:w})=>{if(!s)return{items:[],hasMore:!1,cursor:null};let j=ae.from("messages").select(Ss).eq("conversation_id",s).order("created_at",{ascending:!1}).order("id",{ascending:!1});w&&(j=j.or(Fa(w)));const{data:v,error:I}=await j.limit(Rn);if(I)throw console.error(`[useConversationMessages] Failed to load ${w?"older messages":"messages"}`,I),new Error(I.message);return qa(v??[])},getNextPageParam:()=>{},getPreviousPageParam:w=>{if(w.hasMore)return w.cursor??void 0},structuralSharing:(w,j)=>$r(w,j)});n.useEffect(()=>{const w=d.data?.pages??[],j=w.reduce((T,S)=>T+S.items.length,0),v=h.current;if(w.length===0){h.current={pages:0,total:0},l($t);return}if(v.pages===0){h.current={pages:w.length,total:j},l($t);return}const I=j-v.total,M=w.length-v.pages;I>0&&M>0&&l(T=>Math.max(0,T-I)),h.current={pages:w.length,total:j}},[d.data?.pages]);const b=n.useCallback(()=>{if(!s)return{};const w=(j,v)=>{const I=Nn(j);if(!Mn(I,s)||!nt(I,"id"))return;const T=I,S=Kt(T);o.setQueryData(r,N=>fn(N,T,{allowAppend:v==="insert"})),v==="insert"?g.current?.onInsert?.(S):g.current?.onUpdate?.(S)};return{onStatus:y,onMessageInsert:j=>{w(j,"insert")},onMessageUpdate:j=>{w(j,"update")}}},[s,y,o,r]);Vt(s,b,[]),n.useEffect(()=>{l($t),h.current={pages:0,total:0}},[s]);const p=n.useMemo(()=>(d.data?.pages??[]).flatMap(j=>j.items),[d.data?.pages]),f=n.useCallback(async()=>{s&&d.hasPreviousPage&&await d.fetchPreviousPage()},[s,d]);return n.useMemo(()=>({data:p,dataUpdatedAt:d.dataUpdatedAt,isLoading:d.isLoading,isFetching:d.isFetching,isError:d.isError,error:d.error,refetch:d.refetch,loadOlder:f,hasMore:!!d.hasPreviousPage,isLoadingOlder:d.isFetchingPreviousPage,firstItemIndex:i,queryKey:r,pollWhenRealtimeDown:c}),[p,d.dataUpdatedAt,d.isLoading,d.isFetching,d.isError,d.error,d.refetch,f,d.hasPreviousPage,d.isFetchingPreviousPage,i,r,c])};function Pa(s){const{conversation:t,deliveryReceipts:r,readReceipts:o,currentUserId:i,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:y}=s;if(!t||!i)return()=>null;const m=t.participants.filter(p=>!p.isSelf);if(m.length===0)return()=>null;const g=new Set(m.map(p=>p.id)),h=p=>{if(!p)return null;const f=y?.get(p);return f??null},d=new Map;for(const p of o??[]){let f=null;if(p.lastReadMessageId){const v=h(p.lastReadMessageId);v!=null&&(f=v),v==null&&(f=null)}else if(p.lastReadAt){const v=new Date(p.lastReadAt).getTime();Number.isNaN(v)||(f=v)}if(f==null)continue;const w=(()=>{if(!p.lastReadAt)return null;const v=new Date(p.lastReadAt).getTime();return Number.isNaN(v)?null:v})(),j=d.get(p.userId);if(!j||f>j.upToMs){d.set(p.userId,{upToMs:f,readAtMs:w});continue}f===j.upToMs&&w!=null&&(j.readAtMs==null||w>j.readAtMs)&&d.set(p.userId,{upToMs:f,readAtMs:w})}const b=new Map;for(const p of r??[]){if(!g.has(p.userId)||c&&!c.has(p.messageId))continue;let f=b.get(p.messageId);f||(f=new Set,b.set(p.messageId,f)),f.add(p.userId)}return p=>{if(p.senderId!==i)return null;if(l[p.id])return{status:"failed"};if(mn(p.id))return{status:"sending"};const f=(()=>{const I=new Date(p.createdAt??"").getTime();return Number.isNaN(I)?0:I})();let w=0,j=null;for(const I of m){const M=d.get(I.id);if(M&&M.upToMs>=f){w+=1;const T=M.readAtMs??M.upToMs;(j===null||T>j)&&(j=T)}}return w===m.length&&m.length>0?{status:"seen",seenAt:j!=null?new Date(j).toISOString():null}:(b.get(p.id)?.size??0)===m.length&&m.length>0?{status:"delivered"}:{status:"sent"}}}function $a(s){const{messages:t,conversation:r,currentUserId:o,participantsById:i,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:y,readReceipts:m,failedMessages:g,lastOwnMessageId:h}=s,d=n.useMemo(()=>{if(!t)return[];const p=new Set;h&&p.add(h);for(const j of Object.keys(g))p.add(j);const f=new Map;for(const j of t){const v=new Date(j.createdAt??"").getTime();Number.isNaN(v)||f.set(j.id,v)}const w=Pa({conversation:r??null,deliveryReceipts:y,readReceipts:m,currentUserId:o,failedMessages:g,onlyMessageIds:p,messageCreatedAtMsById:f});return t.map(j=>{const v=vt(j.body),I=i.get(j.senderId)??null,M=I?.isSelf??(o!=null&&j.senderId===o),T=M&&p.has(j.id)?w(j):null,S=!!T&&M&&!v.deleted&&(T.status==="failed"||h===j.id);return{message:j,meta:v,sender:I,isSelf:M,deliveryStatus:T,showDeliveryStatus:S,reactions:l.get(j.id)??[]}})},[r,o,y,g,h,t,i,l,m]),b=n.useMemo(()=>d.filter(({message:p})=>!c[p.id]),[d,c]);return{uiMessages:d,visibleMessages:b}}function za(s){const{messages:t,currentUserId:r,hiddenMessageIds:o}=s;return n.useMemo(()=>{if(!t||!r)return null;for(let i=t.length-1;i>=0;i-=1){const l=t[i];if(!(o[l.id]||l.senderId!==r||vt(l.body).deleted))return l.id}return null},[o,t,r])}const Ha=async s=>{const{data:t,error:r}=await ae.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",s).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(t??[]).map(pn)},Ka=async(s,t)=>{if(t.length===0)return[];const r=ae.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",s).in("message_id",t),{data:o,error:i}=await r.order("created_at",{ascending:!0}).returns();if(i)throw console.error("[useConversationDeliveryReceipts] Failed to load",i),new Error(i.message);return(o??[]).map(hn)},Qa=async s=>{const{data:t,error:r}=await ae.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",s).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(t??[]).map(gn)},Ja=(s,t)=>{const r=new Map,o=new Map;for(const l of s){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let y=c.get(l.emoji);y||(y={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,y),o.get(l.messageId).push(l.emoji)),y.count+=1,t&&l.userId===t&&(y.reactedBySelf=!0)}const i=new Map;for(const[l,c]of r.entries()){const y=o.get(l)??[];i.set(l,y.map(m=>c.get(m)).filter(Boolean))}return i},Wa=(s,t,r)=>{const o=s??[],i=r.key(t),l=[...o],c=l.findIndex(y=>r.key(y)===i);return c>=0?l[c]=t:l.push(t),r.sort&&l.sort(r.sort),l},Va=(s,t,r)=>{const o=s??[];return o.length===0?[]:o.filter(i=>r.key(i)!==t)},ks=s=>t=>{const r=Nn(t);if(!Mn(r,s.conversationId)||s.extraGuard&&!s.extraGuard(r)||!(s.getRequiredId?s.getRequiredId(r):nt(r,"id")))return;const i=r,l=s.mapRow(i);s.queryClient.setQueryData(s.queryKey,c=>Wa(c,l,{key:s.key,sort:s.sort}))},Ga=s=>t=>{const r=Ua(t),o=s.getRowId?s.getRowId(r):nt(r,"id");if(!o){s.invalidateWhenMissingId!==!1&&s.queryClient.invalidateQueries({queryKey:s.queryKey});return}s.queryClient.setQueryData(s.queryKey,i=>Va(i,o,{key:s.key}))},Ya=s=>{const{user:t}=zt(),r=t?.id??null,o=we(),i=n.useMemo(()=>Cr(s),[s]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Gt(s),m=Ht({queryKey:i,enabled:!!s,...y,queryFn:()=>s?Qa(s):Promise.resolve([])}),g=n.useCallback(()=>{if(!s)return{};const b=ks({conversationId:s,queryClient:o,queryKey:i,mapRow:gn,key:f=>f.id,sort:(f,w)=>{const j=Gs(f.createdAt),v=Gs(w.createdAt);return j!==v?j-v:f.id.localeCompare(w.id)}}),p=Ga({queryClient:o,queryKey:i,key:f=>f.id});return{onStatus:c,onReactionUpsert:b,onReactionDelete:p}},[s,c,o,i]);Vt(s,g,[]);const h=Ns({mutationFn:async({messageId:b,emoji:p})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:f}=await ae.from("message_reactions").insert({conversation_id:s,message_id:b,user_id:r,emoji:p});if(f){if(f?.code==="23505"){const{error:w}=await ae.from("message_reactions").delete().eq("message_id",b).eq("user_id",r).eq("emoji",p);if(w)throw console.error("[useConversationReactions] Failed to remove reaction",w),w;return}throw console.error("[useConversationReactions] Failed to toggle reaction",f),f}},onMutate:async({messageId:b,emoji:p})=>{if(!s||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:i});const f=o.getQueryData(i);return o.setQueryData(i,w=>{const j=w??[],v=j.findIndex(M=>M.messageId===b&&M.userId===r&&M.emoji===p);if(v>=0){const M=[...j];return M.splice(v,1),M}const I={id:Hr(),conversationId:s,messageId:b,userId:r,emoji:p,createdAt:new Date().toISOString()};return[...j,I]}),{previousReactions:f}},onError:(b,p,f)=>{s&&(f?.previousReactions?o.setQueryData(i,f.previousReactions):o.invalidateQueries({queryKey:i}))},onSuccess:()=>{s&&o.invalidateQueries({queryKey:i})}}),d=n.useMemo(()=>{const b=m.data??[];return Ja(b,r)},[m.data,r]);return{reactions:m.data??[],reactionsByMessageId:d,isLoadingReactions:m.isLoading,toggleReaction:h,pollWhenRealtimeDown:l,queryKey:i}},Xa=s=>{const t=we(),r=n.useMemo(()=>kr(s),[s]),{pollWhenRealtimeDown:o,onRealtimeStatus:i,refetchOptions:l}=Gt(s),c=Ht({queryKey:r,enabled:!!s,...l,queryFn:async()=>s?Ha(s):[]}),y=n.useCallback(()=>{if(!s)return{};const m=ks({conversationId:s,queryClient:t,queryKey:r,mapRow:pn,key:g=>g.userId,getRequiredId:g=>nt(g,"user_id"),sort:(g,h)=>{const d=!g.lastReadAt,b=!h.lastReadAt;if(d&&b)return 0;if(d)return 1;if(b)return-1;const p=new Date(g.lastReadAt).getTime(),f=new Date(h.lastReadAt).getTime();return Number.isNaN(p)&&Number.isNaN(f)?0:Number.isNaN(p)?1:Number.isNaN(f)?-1:f-p}});return{onStatus:i,onReadReceiptUpsert:m}},[s,i,t,r]);return Vt(s,y,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},Za=(s,t)=>{const r=we(),o=n.useMemo(()=>Kr(t,{excludeTemp:!0,sort:!0}),[t]),i=n.useMemo(()=>Ir(s,o),[s,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Gt(s),m=Ht({queryKey:i,enabled:!!(s&&o.length>0),...y,queryFn:async()=>s?o.length===0?[]:Ka(s,o):[]}),g=n.useCallback(()=>{if(!s)return{};if(o.length===0)return{};const d=new Set(o),b=ks({conversationId:s,queryClient:r,queryKey:i,mapRow:hn,key:p=>p.id,extraGuard:p=>{const f=nt(p,"message_id");return!!(f&&d.has(f))},sort:(p,f)=>{const w=new Date(p.deliveredAt??"").getTime(),j=new Date(f.deliveredAt??"").getTime(),v=Number.isNaN(w)?0:w,I=Number.isNaN(j)?0:j;return v-I}});return{onStatus:c,onDeliveryReceiptUpsert:b}},[s,o,c,r,i]),h=s&&o.length>0?s:null;return Vt(h,g,[]),n.useMemo(()=>({...m,pollWhenRealtimeDown:l,queryKey:i}),[m,l,i])},ei=s=>{const{conversationId:t,userId:r,displayName:o}=s,{getNumber:i}=Ms(),l=i("ux.typing.inactivity_ms",3e3),c=i("ux.typing.heartbeat_ms",2e3),y=i("ux.typing.remote_ttl_ms",5e3),[m,g]=n.useState({}),h=n.useRef(null),d=n.useRef(new Map),b=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),p=n.useCallback(async I=>{if(!t||!r||!o)return;const M=h.current;M&&await M.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:I}})},[t,r,o]),f=n.useCallback(async()=>{b.current.timeoutId!=null&&(window.clearTimeout(b.current.timeoutId),b.current.timeoutId=null),b.current.isTyping&&(b.current.isTyping=!1,b.current.lastSentAtMs=0,await p(!1))},[p]),w=n.useCallback(I=>{if(!t||!r||!o||!h.current)return;const T=b.current.isTyping;if(I){const S=Date.now();T?S-b.current.lastSentAtMs>c&&(b.current.lastSentAtMs=S,p(!0)):(b.current.isTyping=!0,b.current.lastSentAtMs=S,p(!0)),b.current.timeoutId!=null&&window.clearTimeout(b.current.timeoutId),b.current.timeoutId=window.setTimeout(()=>{b.current.isTyping=!1,b.current.lastSentAtMs=0,b.current.timeoutId=null,p(!1)},l);return}T&&f()},[p,t,o,f,c,l,r]),j=n.useCallback(()=>{g({}),d.current.forEach(I=>window.clearTimeout(I)),d.current.clear()},[]);return n.useEffect(()=>{if(!t)return;j();const I=ae.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});h.current=I,I.on("broadcast",{event:"typing"},({payload:S})=>{const N=S;if(!N?.userId||r&&N.userId===r)return;g(E=>{const F={...E};return N.isTyping&&N.displayName?F[N.userId]=N.displayName:delete F[N.userId],F});const R=d.current.get(N.userId);if(R!=null&&window.clearTimeout(R),N.isTyping){const E=window.setTimeout(()=>{g(F=>{const A={...F};return delete A[N.userId],A}),d.current.delete(N.userId)},y);d.current.set(N.userId,E)}else d.current.delete(N.userId)}).subscribe();const M=()=>{document.visibilityState==="hidden"&&f()},T=()=>{f()};return document.addEventListener("visibilitychange",M),window.addEventListener("beforeunload",T),window.addEventListener("pagehide",T),window.addEventListener("blur",T),()=>{document.removeEventListener("visibilitychange",M),window.removeEventListener("beforeunload",T),window.removeEventListener("pagehide",T),window.removeEventListener("blur",T),j(),f(),h.current&&(ae.removeChannel(h.current),h.current=null)}},[t,f,r,j]),{remoteTypingUsers:n.useMemo(()=>Object.entries(m).map(([I,M])=>({userId:I,displayName:M})),[m]),noteLocalInputActivity:w,stopTyping:f}},ti=s=>{const{conversationId:t,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:i=250}=s,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>t?`${r}${t}`:null,[t,r]),[y,m]=n.useState("");return n.useEffect(()=>{if(!c){m(""),l.current?.("");return}const d=Er(c)??"";m(d),l.current?.(d)},[c]),n.useEffect(()=>{if(!c)return;const h=window.setTimeout(()=>{y.trim().length===0?Ys(c):Tr(c,y)},i);return()=>window.clearTimeout(h)},[c,i,y]),{draft:y,setDraft:m,clearDraft:()=>{c&&Ys(c),m(""),l.current?.("")}}};function si({showComposer:s,initialHeaderHeight:t=72,initialComposerHeight:r=160}){const o=n.useRef(null),[i,l]=n.useState(t),[c,y]=n.useState(r),[m,g]=n.useState(null),[h,d]=n.useState(!1),b=n.useCallback(p=>y(Math.max(p,i)),[i]);return n.useEffect(()=>{const p=o.current;if(!p)return;const f=()=>l(Math.max(p.getBoundingClientRect().height,0));if(f(),typeof ResizeObserver>"u")return;const w=new ResizeObserver(f);return w.observe(p),()=>w.disconnect()},[]),n.useEffect(()=>{y(p=>Math.max(p,i))},[i]),n.useEffect(()=>{s||y(0)},[s]),{headerRef:o,headerHeight:i,composerHeight:c,isAtBottom:m,setIsAtBottom:g,handleComposerHeightChange:b,showEmojiPicker:h,setShowEmojiPicker:d}}const ni=({conversationId:s,currentUserId:t,showComposer:r,isBlocked:o,blockedYou:i,composerTextareaRef:l})=>{const[c,y]=n.useState(null),[m,g]=n.useState({}),[h,d]=n.useState(null),[b,p]=n.useState(null),[f,w]=n.useState(null),j=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{if(!s||!t){g({});return}if(typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=window.localStorage.getItem(A);if(!U){g({});return}const z=JSON.parse(U);if(Array.isArray(z)){const H={};for(const ce of z)typeof ce=="string"&&ce&&(H[ce]=!0);g(H);return}if(z&&typeof z=="object"){const H={};for(const[ce,ve]of Object.entries(z))ve&&(H[ce]=!0);g(H);return}g({})}catch{g({})}},[s,t]),n.useEffect(()=>{if(!s||!t||typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=Object.keys(m).filter(z=>m[z]);window.localStorage.setItem(A,JSON.stringify(U))}catch{}},[s,t,m]);const I=n.useCallback(()=>{y(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const A=z=>{const H=z.target;if(!(H instanceof Element)){y(null);return}H.closest(`[data-message-action-scope="${c}"]`)||y(null)},U=z=>{z.key==="Escape"&&y(null)};return document.addEventListener("pointerdown",A,!0),document.addEventListener("keydown",U),()=>{document.removeEventListener("pointerdown",A,!0),document.removeEventListener("keydown",U)}},[c]);const M=n.useCallback(A=>{o||i||vt(A.body).deleted||(y(A.id),l.current?.blur())},[i,l,o]),T=n.useCallback((A,U)=>{o||i||vt(A.body).deleted||(U&&(v.current=U),p({messageId:A.id,text:on(A.body)??"",body:A.body??null,attachmentUrl:A.attachmentUrl??null}),w(null),I(),l.current?.blur())},[i,I,l,o]),S=n.useCallback(A=>{p(U=>U&&{...U,text:A})},[]),N=n.useCallback(()=>{p(null),w(null),v.current?.focus()},[]);n.useEffect(()=>{b&&queueMicrotask(()=>{j.current?.focus()})},[b]);const R=n.useCallback(A=>{o||i||(I(),d({messageId:A.id,attachmentUrl:A.attachmentUrl??null}),l.current?.blur())},[i,I,l,o]),E=n.useCallback(()=>{d(null)},[]),F=n.useCallback(A=>{g(U=>({...U,[A]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(b||h||queueMicrotask(()=>l.current?.focus()))},[c,h,b,r,l]),{activeActionMessageId:c,openMessageActions:M,closeMessageActions:I,hiddenMessageIds:m,hideMessageForMe:F,deleteDialog:h,openDeleteDialog:R,closeDeleteDialog:E,editingMessage:b,openEditDialog:T,updateEditingText:S,closeEditDialog:N,editTextareaRef:j,editError:f,setEditError:w}},rn=3e3;function ri(s){const{conversationId:t,userId:r,isAtBottom:o,messages:i}=s,l=we(),c=n.useRef({conversationId:null,messageId:null,userId:null}),y=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null,m.lastSentAt=0},[t,r]),n.useEffect(()=>()=>{const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null},[]),n.useEffect(()=>{if(!t||!i||i.length===0||!r||!o)return;const m=i[i.length-1];if(mn(m.id)||c.current.conversationId===t&&c.current.messageId===m.id&&c.current.userId===r)return;const g=y.current,h=Date.now(),d=g.lastSentAt?h-g.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{_e(l,r,t,f=>f.hasUnread?{...f,hasUnread:!1}:f)},p=f=>{g.lastSentAt=Date.now();const w=new Date().toISOString();ra({conversation_id:t,user_id:r,last_read_message_id:f,last_read_at:w}).then(()=>{c.current={conversationId:t,messageId:f,userId:r},b()}).catch(j=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",j)})};if(d<rn){g.pending={conversationId:t,userId:r,messageId:m.id},g.timeoutId==null&&(g.timeoutId=window.setTimeout(()=>{const f=y.current.pending;y.current.pending=null,y.current.timeoutId=null,f&&(c.current.conversationId===f.conversationId&&c.current.messageId===f.messageId&&c.current.userId===f.userId||f.conversationId!==t||f.userId!==r||p(f.messageId))},Math.max(rn-d,0)));return}g.timeoutId!=null&&(window.clearTimeout(g.timeoutId),g.timeoutId=null,g.pending=null),p(m.id)},[t,i,r,l,o])}const ai=new Set(["text","image","text+image","system"]),ii=s=>{const{user:t}=zt(),r=t?.id??null,o=we();return Ns({mutationFn:async({messageId:i,text:l,currentBody:c,attachmentUrl:y})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(y)throw new Error("Cannot edit messages with attachments.");const m=Ar(c,l),g=ln(m),h=ai.has(g.type)?g.type:"text",{data:d,error:b}=await ae.from("messages").update({body:m,message_type:h,text:g.text.trim()?g.text:null,client_id:g.clientId??null,meta:g.meta??null}).eq("id",i).eq("conversation_id",s).eq("user_id",r).select(Ss).single();if(b)throw console.error("[useEditMessage] Failed to edit message",b),new Error(b.message);return Kt(d)},onSuccess:i=>{if(!s)return;const l=Me(s);o.setQueryData(l,c=>xn(c,i))}})},oi=s=>{const{user:t}=zt(),r=t?.id??null,o=we();return Ns({mutationFn:async({messageId:i,attachmentUrl:l})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const y={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},m=JSON.stringify(y),g=ln(m),{data:h,error:d}=await ae.from("messages").update({body:m,message_type:"system",text:g.text.trim()?g.text:null,client_id:g.clientId??null,meta:g.meta??null,attachment_url:null}).eq("id",i).eq("conversation_id",s).eq("user_id",r).select(Ss).single();if(d)throw console.error("[useDeleteMessage] Failed to delete message",d),new Error(d.message);if(l)try{await yn(l)}catch(p){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",p)}return Kt(h)},onSuccess:i=>{if(!s)return;const l=Me(s);o.setQueryData(l,c=>xn(c,i)),o.invalidateQueries({queryKey:vs(r)})}})};function li(s){const{conversationId:t,setDraft:r,messages:o}=s,i=we(),[l,c]=n.useState(null),[y,m]=n.useState(null),[g,h]=n.useState(null),[d,b]=n.useState({}),p=n.useRef({});n.useEffect(()=>{p.current=d},[d]);const f=n.useRef(t);n.useEffect(()=>{t!==f.current&&(f.current=t,c(null),m(null),h(null),b({}),p.current={})},[t]),n.useEffect(()=>()=>{const S=Object.values(p.current),N=Array.from(new Set(S.map(R=>R.attachmentPath).filter(R=>typeof R=="string"&&R.length>0&&!Qr(R))));N.length!==0&&ae.storage.from(Jr).remove(N).then(({error:R})=>{R&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)}).catch(R=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)})},[t]),n.useEffect(()=>{o&&b(S=>{const N=new Set(o.map(F=>F.id));let R=!1;const E={...S};for(const F of Object.keys(E))N.has(F)||(delete E[F],R=!0);return R?E:S})},[o]);const w=n.useCallback(()=>{c(null),m(null),h(null)},[]),j=n.useCallback((S,N,R)=>{c(R.message||"Couldn't send. Please try again."),N.text.trim()&&r(N.text),m(N),h(S),b(E=>({...E,[S]:N}))},[r]),v=n.useCallback(S=>{S&&(b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),S===g&&w())},[w,g]),I=n.useCallback(()=>{if(!y)return null;const S=g;return S&&b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),w(),{payload:y,tempId:S}},[w,y,g]),M=n.useCallback(S=>{const N=d[S];return N?(b(R=>{if(!(S in R))return R;const E={...R};return delete E[S],E}),S===g?w():c(null),N):null},[w,d,g]),T=n.useCallback(async S=>{if(!t)return;const N=d[S];if(!N)return;const R=Me(t);if(i.setQueryData(R,E=>Wr(E,S)),b(E=>{if(!(S in E))return E;const F={...E};return delete F[S],F}),S===g&&w(),N.attachmentPath)try{await yn(N.attachmentPath)}catch(E){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",E)}},[w,t,d,g,i]);return{sendError:l,setSendError:c,lastFailedPayload:y,lastFailedTempId:g,failedMessages:d,clearBannerState:w,onSendFailed:j,onSendRecovered:v,consumeLastFailedForRetry:I,consumeFailedMessageForRetry:M,discardFailedMessage:T}}const ci=({currentUserId:s})=>{const t=we();return n.useCallback(r=>{_e(t,s,r.conversationId,o=>{const i=!!(s&&r.senderId===s);return{...o,lastMessagePreview:Lr(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:cn(r.createdAt??null),hasUnread:!i,lastMessageIsFromSelf:i,lastMessageSeenByOthers:i?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),s&&r.senderId!==s&&aa({conversation_id:r.conversationId,message_id:r.id,user_id:s})},[s,t])},ui=({conversationId:s,userId:t,conversation:r,readReceipts:o,visibleMessages:i})=>{const[l,c]=n.useState(void 0),[y,m]=n.useState(void 0);return n.useEffect(()=>{c(void 0),m(void 0)},[s,t]),n.useEffect(()=>{if(!s||!t||l!==void 0)return;const h=(o??[]).find(d=>d.userId===t)??null;c(h?.lastReadMessageId??null)},[s,l,o,t]),n.useEffect(()=>{!s||!t||y===void 0&&r&&m(!!r.hasUnread)},[r,s,y,t]),{firstUnreadIndex:n.useMemo(()=>{if(y===void 0||!y||i.length===0||l===void 0)return null;if(l===null)return 0;const h=i.findIndex(b=>b.message.id===l);if(h<0)return 0;const d=h+1;return d>=i.length?null:d},[y,l,i]),lastReadMessageId:l,hasUnread:y??!1,isReady:y!==void 0&&l!==void 0}};function di(s){const{items:t=[],itemContent:r,isLoading:o,loadingContent:i,errorContent:l,emptyContent:c,header:y,footer:m,bottomPadding:g,scrollerRef:h,followOutput:d,onAtBottomChange:b,atBottomThreshold:p=80,onStartReached:f,computeItemKey:w,ariaLabel:j="Messages"}=s,v=Z.useRef(null),I=Z.useRef(!0),M=Z.useRef(null),T=Z.useRef(!1),S=Z.useCallback(R=>{v.current=R,h&&(typeof h=="function"?h(R):h.current=R)},[h]),N=Z.useCallback(R=>R.scrollHeight-R.scrollTop-R.clientHeight<=p,[p]);return Z.useLayoutEffect(()=>{const R=v.current;if(!R)return;const E=A=>{I.current=A,M.current!==A&&(M.current=A,b?.(A))},F=()=>{const A=N(R);E(A),f&&(R.scrollTop<=24?T.current||(T.current=!0,f()):R.scrollTop>=80&&(T.current=!1))};return F(),R.addEventListener("scroll",F,{passive:!0}),()=>R.removeEventListener("scroll",F)},[N,b,f]),Z.useEffect(()=>{const R=v.current;if(!R)return;const E=I.current,F=typeof d=="function"?d(E):d??!1;F&&E&&requestAnimationFrame(()=>{R.scrollTo({top:R.scrollHeight,behavior:F==="smooth"?"smooth":"auto"})})},[t.length]),o?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:i}):l?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):t.length?e.jsx("div",{className:"h-full w-full",children:e.jsx("div",{ref:S,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":j,style:{paddingBottom:g??void 0},children:e.jsxs("div",{className:"page-pad pt-3",children:[y,e.jsx("div",{className:"space-y-0",children:t.map((R,E)=>e.jsx(Z.Fragment,{children:r(E,R)},w?w(E,R):E))}),m]})})}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const fi=({show:s,pendingCount:t,onClick:r,shortcutHint:o})=>{if(!s)return null;const i=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":i,title:o?`${i} (${o})`:i,children:[e.jsx(ha,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Jump to latest"}),t>0&&e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},mi=({show:s,unreadCount:t,onClick:r,shortcutHint:o})=>{if(!s||t<=0)return null;const i=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":i,title:o?`${i} (${o})`:i,children:[e.jsx(ca,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Unread"}),e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})};function gi(s){const t=s.trim().split(/\s+/).filter(Boolean);return t.length===0?"?":t.length===1?t[0].slice(0,2).toUpperCase():`${t[0][0]??""}${t[1][0]??""}`.toUpperCase()}function ws({delayMs:s}){return e.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${s}ms`},"aria-hidden":"true"})}function pi({users:s,className:t}){if(!s.length)return null;const r=s.slice(0,3),o=Math.max(0,s.length-r.length);return e.jsxs("div",{className:Rs("mt-1 flex w-full items-end gap-2 justify-start",t),role:"status","aria-live":"polite","aria-label":s.length===1?`${s[0].displayName} is typing`:"People are typing",children:[e.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(i=>e.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:i.displayName,children:i.avatarUrl?e.jsx("img",{src:i.avatarUrl,alt:i.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:gi(i.displayName)})},i.id)),o>0&&e.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),e.jsx(Vr,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ws,{delayMs:0}),e.jsx(ws,{delayMs:120}),e.jsx(ws,{delayMs:240})]})})]})}const hi=({children:s,className:t,onHeightChange:r,minHeight:o,style:i,...l})=>{const c=Z.useRef(null),[y,m]=Z.useState(0);return Z.useEffect(()=>{if(!r||!c.current)return;const g=c.current,h=()=>r(g.getBoundingClientRect().height);h();const d=new ResizeObserver(h);return d.observe(g),()=>d.disconnect()},[r]),Z.useLayoutEffect(()=>{if(typeof window>"u")return;const g=window.visualViewport;if(!g){m(0);return}const h=()=>{const d=Math.max(0,window.innerHeight-g.height-g.offsetTop);m(d)};return h(),g.addEventListener("resize",h),g.addEventListener("scroll",h),window.addEventListener("orientationchange",h),()=>{g.removeEventListener("resize",h),g.removeEventListener("scroll",h),window.removeEventListener("orientationchange",h)}},[]),e.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",style:{transform:`translateY(-${y}px)`},children:e.jsx("div",{className:"w-full",children:e.jsx("form",{...l,className:Rs("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-2.5 md:p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",t),style:{minHeight:o,...i},children:s})})})},xi=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Sn="movinesta_recent_files_v1",Is=6,yi=s=>{if(!Number.isFinite(s)||s<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,o=s;for(;o>=1024&&r<t.length-1;)o/=1024,r+=1;const i=r==0||r==1?0:1;return`${o.toFixed(i)} ${t[r]}`},bi=(s,t)=>{const r=(s.split(".").pop()??"").toUpperCase();return r||(t?.startsWith("image/")?"IMG":t?.startsWith("audio/")?"AUDIO":"FILE")},wi=s=>s?.startsWith("image/")?"image":s?.startsWith("audio/")?"audio":"file",vi=()=>{try{const s=localStorage.getItem(Sn);if(!s)return[];const t=JSON.parse(s);return Array.isArray(t)?t.filter(r=>r&&typeof r=="object").map(r=>({id:String(r?.id??""),name:String(r?.name??"File"),size:Number(r?.size??0),sizeLabel:String(r?.sizeLabel??"0 B"),badge:String(r?.badge??"FILE"),mime:String(r?.mime??""),kind:["image","audio","file"].includes(r?.kind)?r.kind:"file",lastUsed:Number(r?.lastUsed??0)})).filter(r=>r.id&&r.name).slice(0,Is):[]}catch{return[]}},ji=s=>{try{const t=s.map(r=>{const{previewUrl:o,...i}=r;return i});localStorage.setItem(Sn,JSON.stringify(t.slice(0,Is)))}catch{}},Ni=({show:s,headerHeight:t,onHeightChange:r,draft:o,setDraft:i,textareaRef:l,noteLocalInputActivity:c,stopTyping:y,onSendText:m,onRequestScrollToBottom:g,isUploadingAttachment:h,pendingAttachment:d,clearPendingAttachment:b,cancelAttachmentUpload:p,sendError:f,sendErrorMessage:w,canRetrySend:j,onRetrySend:v,uploadError:I,clearUploadError:M,showEmojiPicker:T,setShowEmojiPicker:S,openCameraPicker:N,onImageSelected:R,openAttachmentPicker:E,imageInputRef:F,attachmentInputRef:A,onAttachmentSelected:U,onAttachmentFile:z,disableSend:H})=>{const{getNumber:ce}=Ms(),ve=Math.max(1,Math.floor(ce("ux.messages.max_message_chars",2e3))),pe=Math.max(60,Math.floor(ce("ux.messages.composer_max_height_px",140))),[jt,Ye]=n.useState(!1),[Xe,de]=n.useState(!1),[Re,rt]=n.useState(!1),[Ue,Nt]=n.useState([]),he=n.useRef(new Set),at=n.useRef(null),[Oe,Yt]=n.useState({canScrollLeft:!1,canScrollRight:!1,pages:1,active:0});n.useEffect(()=>{typeof window>"u"||Nt(vi())},[]),n.useEffect(()=>()=>{for(const x of he.current)try{URL.revokeObjectURL(x)}catch{}he.current.clear()},[]);const je=n.useCallback(x=>{if(!x)return;const k=x.type??"",O=wi(k),G=bi(x.name,k),J=O==="image"?URL.createObjectURL(x):void 0;J&&he.current.add(J);const se=`${x.name}:${x.size}:${x.lastModified}:${k}`,ie={id:se,name:x.name,size:x.size,sizeLabel:yi(x.size),badge:G,mime:k,kind:O,lastUsed:Date.now(),previewUrl:J};Nt(oe=>{const fe=oe.filter(ue=>ue.id!==se),me=[ie,...fe].slice(0,Is),Ze=new Set(me.map(ue=>ue.id));for(const ue of oe)if(ue.previewUrl&&!Ze.has(ue.id)){try{URL.revokeObjectURL(ue.previewUrl)}catch{}he.current.delete(ue.previewUrl)}return ji(me),me})},[]),Se=n.useCallback(()=>{const x=at.current;if(!x)return;const k=Math.max(0,x.scrollWidth-x.clientWidth),O=x.scrollLeft,G=O>1,J=O<k-1,se=k>0?Math.ceil(x.scrollWidth/Math.max(1,x.clientWidth)):1,ie=Math.min(5,Math.max(1,se)),oe=k>0?O/k:0,fe=ie>1?Math.round(oe*(ie-1)):0;Yt({canScrollLeft:G,canScrollRight:J,pages:ie,active:fe})},[]);n.useEffect(()=>{if(!Xe||Re)return;const x=at.current;if(!x)return;let k=0;const O=()=>{k||(k=window.requestAnimationFrame(()=>{k=0,Se()}))};return Se(),x.addEventListener("scroll",O,{passive:!0}),window.addEventListener("resize",Se),()=>{x.removeEventListener("scroll",O),window.removeEventListener("resize",Se),k&&window.cancelAnimationFrame(k)}},[Ue.length,Re,Xe,Se]);const Q=n.useCallback(x=>{const k=x.target.value,O=k.length>ve?k.slice(0,ve):k;i(O),T&&S(!1),c(O.trim().length>0);const G=x.target;G.style.height="auto";const J=Math.min(G.scrollHeight,pe);G.style.height=`${J}px`},[pe,ve,c,i,S,T]),Mt=n.useCallback(x=>{x&&(i(k=>{const O=`${k}${x}`;return c(O.trim().length>0),O}),queueMicrotask(()=>{const k=l.current;k&&(k.style.height="auto",k.style.height=`${Math.min(k.scrollHeight,pe)}px`)}))},[pe,c,i,l]),q=n.useCallback(x=>{if(x.preventDefault(),H||h)return;const k=o.trim();k&&(i(""),y(),m(k))},[H,o,h,m,i,y]),Ce=H||!o.trim()||h,Rt=n.useCallback(x=>{const k=x.target.files?.[0];k&&je(k),R(x)},[R,je]),Fe=n.useCallback(x=>{const k=x.target.files?.[0];k&&je(k),U(x)},[U,je]),ee=h||H,Ne=h||H,xe=n.useMemo(()=>[{key:"photo",label:"Photo",icon:e.jsx(ys,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!1),N()},disabled:ee},{key:"file",label:"File",icon:e.jsx(wt,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!1),E()},disabled:Ne},{key:"more",label:"More",icon:e.jsx(da,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!0)},disabled:Ne}],[Ne,ee,E,N]),qe=d?h?"Uploadingâ€¦":I?"Upload failed":"Ready":null;return s?e.jsxs(hi,{onSubmit:q,className:"space-y-2",onHeightChange:r,minHeight:t,onDragOver:x=>{!z||H||(x.preventDefault(),x.dataTransfer.dropEffect="copy",x.currentTarget.dataset.dragging="true")},onDragLeave:x=>{x.currentTarget.dataset.dragging="false"},onDrop:x=>{if(!z||H||h)return;x.preventDefault(),x.currentTarget.dataset.dragging="false";const k=x.dataTransfer.files;if(!k||k.length===0)return;const O=Array.from(k)[0];O&&(je(O),z(O))},children:[d&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-start justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex min-w-0 items-start gap-3",children:[d.kind==="image"&&d.previewUrl?e.jsx("img",{src:d.previewUrl,alt:"",className:"h-12 w-12 rounded-lg object-cover"}):d.kind==="audio"&&d.previewUrl?e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(bs,{className:"h-5 w-5","aria-hidden":"true"})}):e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(wt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col gap-0.5",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("p",{className:"min-w-0 truncate text-[13px] font-semibold text-foreground",children:d.name}),qe?e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:qe}):null]}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:d.sizeLabel}),d.kind==="audio"&&d.previewUrl?e.jsx("audio",{controls:!0,src:d.previewUrl,className:"mt-2 w-52",children:e.jsx("track",{kind:"captions",srcLang:"en",label:"Captions"})}):null]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:h?p:b,"aria-label":h?"Cancel upload":"Remove attachment",children:e.jsx(xs,{className:"h-4 w-4","aria-hidden":"true"})})]}),h&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-center justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Uploading attachmentâ€¦"}),e.jsx("div",{className:"mt-1 h-1.5 w-40 overflow-hidden rounded-full bg-muted/70","aria-hidden":"true",children:e.jsx("div",{className:"h-full w-1/2 animate-pulse rounded-full bg-primary/60"})})]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:p,"aria-label":"Cancel upload",children:e.jsx(xs,{className:"h-4 w-4","aria-hidden":"true"})})]}),f&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nn,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:w??"Couldn't send. Please try again."})]}),j&&e.jsx($,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Retry"})]}),I&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nn,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:I})]}),e.jsx($,{type:"button",size:"sm",variant:"ghost",onClick:M,children:"Dismiss"})]}),e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs(Xs,{open:T,onOpenChange:S,children:[e.jsx(Zs,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"icon-hit bg-muted/60 shadow-sm",children:e.jsx(Ma,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(en,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:e.jsx(Gr,{className:"max-h-64",children:e.jsx("div",{className:"grid grid-cols-9 gap-2",children:xi.map(x=>e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit rounded-xl text-lg",onClick:()=>{Mt(x),S(!1)},children:e.jsx("span",{children:x})},x))})})})]}),e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm",onClick:N,"aria-label":"Send photo",disabled:ee,"aria-busy":h,children:e.jsx(ys,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:F,accept:"image/*",className:"hidden",onChange:Rt}),e.jsxs(Xs,{open:jt,onOpenChange:Ye,children:[e.jsx(Zs,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm","aria-label":"Add attachment",disabled:Ne,"aria-busy":h,children:e.jsx(ba,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(en,{side:"top",align:"center",className:"soft-popover w-auto p-2",children:e.jsx("div",{className:"flex items-center gap-2",children:xe.map(x=>e.jsxs($,{type:"button",variant:"ghost",size:"icon",className:"h-12 w-12 flex-col gap-1 rounded-2xl text-muted-foreground hover:bg-muted/60 hover:text-foreground",onClick:x.onClick,disabled:x.disabled,"aria-label":x.label,children:[x.icon,e.jsx("span",{className:"text-[10px] font-medium leading-none",children:x.label})]},x.key))})})]}),e.jsx(Qt,{open:Xe,onOpenChange:x=>{de(x),x||rt(!1)},children:e.jsxs(Jt,{className:"fixed left-1/2 bottom-4 top-auto -translate-x-1/2 translate-y-0 w-[calc(100%-2rem)] max-w-lg rounded-3xl border border-border/70 bg-card p-4 shadow-2xl",children:[e.jsx("div",{className:"mx-auto mb-2 h-1 w-10 rounded-full bg-muted/70","aria-hidden":"true"}),e.jsxs(Cs,{className:"flex-row items-center justify-between space-y-0",children:[e.jsx(Wt,{className:"text-base",children:"Attach"}),e.jsx(ua,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit","aria-label":"Close",children:e.jsx(xs,{className:"h-4 w-4","aria-hidden":"true"})})})]}),e.jsxs("div",{className:"mt-3 grid gap-2",children:[e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),N()},disabled:ee,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(ys,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Photo"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Choose an image"})]})]})}),e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),E()},disabled:Ne,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(wt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"File"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"PDF, docs, audio, more"})]})]})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Recent files"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>rt(x=>!x),"aria-pressed":Re,children:Re?"Hide":"See all"}),e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>{de(!1),E()},disabled:Ne,children:"Browse"})]})]}),Re?e.jsx("div",{className:"mt-2 grid gap-2",children:Ue.length===0?e.jsxs("div",{className:"soft-row-card px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:"No recent files yet"}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:"Attach something and it will appear here."})]}):Ue.map(x=>e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),x.kind==="image"?N():E()},disabled:Ne,"aria-label":`Attach ${x.name}`,title:x.name,children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:x.kind==="image"&&x.previewUrl?e.jsx("img",{src:x.previewUrl,alt:"",className:"h-full w-full object-cover"}):x.kind==="audio"?e.jsx(bs,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(wt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col text-left",children:[e.jsx("span",{className:"min-w-0 truncate text-sm font-semibold",children:x.name}),e.jsxs("span",{className:"mt-0.5 text-xs text-muted-foreground",children:[x.badge," â€¢ ",x.sizeLabel]})]})]}),e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:"Recent"})]},x.id))}):e.jsxs("div",{className:"relative mt-2",children:[e.jsx("div",{ref:at,className:"-mx-1 flex gap-2 overflow-x-auto px-1 pb-1",role:"list","aria-label":"Recent files",children:Ue.length===0?e.jsx("div",{className:"soft-row-card flex w-[260px] shrink-0 items-center justify-between gap-3 px-3 py-2",children:e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[13px] font-semibold text-foreground",children:"No recent files yet"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Attach something to see it here."})]})}):Ue.map(x=>e.jsx("div",{role:"listitem",children:e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive flex w-[220px] shrink-0 items-center gap-3 px-3 py-2 text-left disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),x.kind==="image"?N():E()},disabled:Ne,"aria-label":`Attach ${x.name}`,title:x.name,children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:x.kind==="image"&&x.previewUrl?e.jsx("img",{src:x.previewUrl,alt:"",className:"h-full w-full object-cover"}):x.kind==="audio"?e.jsx(bs,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(wt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsx("span",{className:"min-w-0 truncate text-[13px] font-semibold",children:x.name})}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2",children:[e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:x.badge}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:x.sizeLabel})]})]})]})},x.id))}),Oe.canScrollLeft?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 w-6 bg-gradient-to-r from-card to-transparent","aria-hidden":"true"}):null,Oe.canScrollRight?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 w-6 bg-gradient-to-l from-card to-transparent","aria-hidden":"true"}):null,Oe.pages>1?e.jsx("div",{className:"mt-2 flex items-center justify-center gap-1","aria-hidden":"true",children:Array.from({length:Oe.pages}).map((x,k)=>e.jsx("span",{className:k===Oe.active?"h-1.5 w-4 rounded-full bg-foreground/70 motion-safe:transition-all":"h-1.5 w-1.5 rounded-full bg-muted-foreground/30 motion-safe:transition-all"},k))}):null]})]})]})}),e.jsx("input",{type:"file",ref:A,accept:"image/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain,text/csv,application/rtf",className:"hidden",onChange:Fe}),e.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border/70 bg-background/80 px-3 py-2 shadow-inner transition-shadow focus-within:ring-2 focus-within:ring-primary/25 focus-within:ring-offset-2 focus-within:ring-offset-background",children:e.jsx(bn,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:Q,onBlur:y,onPaste:x=>{if(!z||H||h)return;const k=x.clipboardData?.items;if(!k)return;const O=Array.from(k).find(J=>J.type.startsWith("image/"));if(!O)return;const G=O.getAsFile();G&&(x.preventDefault(),g?.(),je(G),z(G))},onKeyDown:x=>{if(!(x.isComposing||x.nativeEvent?.isComposing)&&x.key==="Enter"&&!x.shiftKey){if(H||Ce||!o.trim())return;x.preventDefault(),g?.(),x.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-[14px] leading-5 md:text-sm md:leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),e.jsx($,{type:"submit",variant:"default",size:"icon",className:"h-11 w-11 rounded-full bg-primary text-primary-foreground shadow-sm hover:bg-primary/90",onMouseDown:x=>x.preventDefault(),disabled:Ce,"aria-label":"Send message","aria-busy":h,children:h?e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(va,{className:"h-4 w-4","aria-hidden":"true"})})]})]}):null},Mi=({open:s,editingMessage:t,onOpenChange:r,onCancel:o,onTextChange:i,onSave:l,textareaRef:c,error:y,isSaving:m})=>e.jsx(Qt,{open:s,onOpenChange:r,children:e.jsxs(Jt,{children:[e.jsxs(Cs,{children:[e.jsx(Wt,{children:"Edit message"}),e.jsx(wn,{children:"Update your message for everyone in the conversation."})]}),t&&e.jsx(bn,{ref:c,value:t.text,onChange:g=>i(g.target.value),rows:3,className:"min-h-[120px]"}),y&&e.jsx("p",{className:"text-xs text-destructive",children:y}),e.jsxs(vn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),e.jsxs($,{type:"button",disabled:!t?.text.trim()||m,onClick:l,children:[m&&e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),Ri=({open:s,deleteDialog:t,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:i,isDeleting:l})=>e.jsx(Qt,{open:s,onOpenChange:r,children:e.jsxs(Jt,{children:[e.jsxs(Cs,{className:"gap-1",children:[e.jsxs(Wt,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:e.jsx(Yr,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),e.jsx(wn,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),e.jsxs(vn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!t,children:"Hide for me"}),e.jsxs($,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!t,onClick:i,children:[l&&e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]})]})}),Si=({participant:s,onClick:t})=>{const r=(s.displayName??s.username??"?").slice(0,1).toUpperCase();return e.jsxs("button",{type:"button",onClick:t,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!t,children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:s.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.displayName}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:s.username?`@${s.username}`:s.isSelf?"You":""})]}),t?e.jsx(re,{name:"chevron_right",className:"text-muted-foreground"}):null]})},Ci=({open:s,onOpenChange:t,conversation:r,currentUserId:o,conversationId:i,isMuted:l,onToggleMute:c,otherParticipant:y,isGroupConversation:m,youBlocked:g,blockedYou:h,blockPending:d,onBlockToggle:b})=>{const p=un(),f=n.useMemo(()=>r?.participants??[],[r?.participants]),w=!m&&!!y?.username&&!y?.isSelf,[j,v]=n.useState(null);n.useEffect(()=>{const S=r?.mutedUntil;if(!l||!S){v(null);return}const N=Date.parse(S);if(!Number.isFinite(N)||N<=Date.now()){v(null);return}try{v(new Date(N).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{v(null)}},[r?.mutedUntil,l]);const I=async()=>{const S=`${window.location.origin}/messages/${i}`;await sn(S)?X.show("Conversation link copied."):X.error("Couldn't copy to clipboard.")},M=async()=>{await sn(i)?X.show("Conversation ID copied."):X.error("Couldn't copy to clipboard.")},T=S=>{if(!S.username){X.show("This profile can't be opened yet.");return}t(!1),p(`/u/${S.username}`)};return e.jsx(Qt,{open:s,onOpenChange:t,children:e.jsxs(Jt,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none card-pad",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Wt,{className:"text-base",children:"Conversation info"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:m?`${f.length} participants`:y?.username?`@${y.username}`:"Direct message"})]}),e.jsx("button",{type:"button",onClick:()=>t(!1),className:"icon-hit","aria-label":"Close",children:e.jsx(re,{name:"close"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:I,children:[e.jsx(fa,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:M,children:[e.jsx(re,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),t(!1)},children:[e.jsx(ia,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),j?e.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",j]}):null]}),!m&&e.jsxs("div",{className:"mt-2 grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!w||!y||T(y)},disabled:!w,children:[e.jsx(ma,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:b,disabled:d||h&&!g,children:[e.jsx(jn,{className:"h-4 w-4","aria-hidden":!0}),g?"Unblock":h?"Blocked":"Block"]}),(h||g)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:h&&!g?"This user has blocked you.":g?"You blocked this user.":null})]}),m&&e.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),e.jsx("div",{className:"grid gap-1",children:f.map(S=>e.jsx(Si,{participant:S,onClick:S.username&&S.id!==o?()=>T(S):void 0},S.id))})]})]})})};function ki(){const[s,t]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{t(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),s}const Ii=2;function Ei(s){const{items:t,onJumpToItemIndex:r,minQueryLen:o=Ii}=s,[i,l]=n.useState(!1),[c,y]=n.useState(""),[m,g]=n.useState(0),h=c.trim().toLowerCase(),d=h.length>=o,b=n.useMemo(()=>{if(!d)return[];const N=[];for(let R=0;R<t.length;R++){const E=t[R];if(E.meta.deleted)continue;const F=on(E.message.body);F&&F.toLowerCase().includes(h)&&N.push(R)}return N},[t,h,d]),p=n.useMemo(()=>{const N=new Set;for(const R of b){const E=t[R]?.message.id;E&&N.add(E)}return N},[t,b]),f=b.length;n.useEffect(()=>{g(0)},[h]),n.useEffect(()=>{f!==0&&(m<0&&g(0),m>f-1&&g(f-1))},[m,f]);const w=n.useCallback(N=>{if(f===0)return;const R=(N%f+f)%f;g(R);const E=b[R];typeof E=="number"&&r?.(E)},[f,b,r]),j=n.useCallback(()=>{w(m+1)},[m,w]),v=n.useCallback(()=>{w(m-1)},[m,w]),I=n.useCallback(()=>{w(0)},[w]),M=n.useCallback(()=>{y(""),g(0)},[]),T=n.useCallback(()=>{l(!1),y(""),g(0)},[]),S=n.useMemo(()=>{if(f===0)return null;const N=b[m];return t[N]?.message.id??null},[m,t,f,b]);return{query:c,setQuery:y,isOpen:i,setIsOpen:l,matchCount:f,activeMatchNumber:f===0?0:m+1,activeMatchIndex:f===0?-1:m,activeMessageId:S,isMatch:N=>p.has(N),jumpNext:j,jumpPrev:v,jumpToFirst:I,clear:M,close:T}}function Ti(s,t,r,o){if(!r||typeof r!="object"||typeof r.id!="string")return!0;const i=o?.allowAppend??!0,l=o?.forceFailOnce??!1,c=o?.isMountedRef,y=o?.schedule??((d,b)=>{if(!(typeof window>"u"||typeof window.setTimeout!="function"))return window.setTimeout(d,b)});let m=!1;const g=()=>{try{return s.setQueryData(t,d=>{if(l&&!m)throw m=!0,new Error("forced cache updater failure");return fn(d,r,{allowAppend:i})}),!0}catch{return!1}};if(g())return!0;try{s.invalidateQueries?.({queryKey:t})}catch{}const h=[120,400,900];for(const d of h)y(()=>{c&&!c.current||g()},d);return!1}function Ai(s,t){return Ht({queryKey:dn(s),enabled:!!s&&t,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await ae.rpc("assistant_reply_status_v1",{p_conversation_id:s});if(o){const i=(o.message??"").toLowerCase();if(i.includes("does not exist")||i.includes("function")||i.includes("schema"))return null;throw new Error(o.message)}return r??null}})}function Li(){try{return crypto.randomUUID()}catch{return`req_${Date.now()}_${Math.floor(Math.random()*1e9)}`}}function Di(){return"https://strhxqxvsrecfilfojtc.supabase.co".replace(/\/+$/,"")}function _i(){return"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0cmh4cXh2c3JlY2ZpbGZvanRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTUyNDAsImV4cCI6MjA3OTE3MTI0MH0.DZE2vpUTEqAAIMzT5GUxeV99d98RjDcG-a5IhUtasrI"}async function an(s,t){return await fetch(s,t)}async function Ui(s,t){const r=t?.method,o=Li(),i=`${Di()}/functions/v1/${s}`,l=_i(),c=t?.timeoutMs??Dr("ops.frontend.function_timeout_ms",2e4),y=new AbortController,m=setTimeout(()=>y.abort(new DOMException("Timeout","TimeoutError")),c),g=()=>y.abort(t?.signal?.reason??new DOMException("Aborted","AbortError"));t?.signal?.addEventListener("abort",g);let h=await _r({requireAuth:t?.requireAuth});if(t?.requireAuth&&!h)throw new Error("AUTH_REQUIRED");const d={apikey:l,"x-request-id":o,...t?.accept?{Accept:t.accept}:{},...t?.headers??{}},b=()=>{const p={...d,...h?{Authorization:`Bearer ${h}`}:{}};let f;return t?.body!==void 0&&(typeof t.body=="string"||t.body instanceof Blob||t.body instanceof FormData||t.body instanceof ArrayBuffer?f=t.body:(p["Content-Type"]=p["Content-Type"]??"application/json",f=JSON.stringify(t.body))),{method:r,headers:p,body:f,signal:y.signal}};try{let p=await an(i,b());if((t?.retryAuthOnce??!0)&&(p.status===401||p.status===403)&&h){const w=await Ur().catch(()=>null);w&&w!==h&&(h=w,p=await an(i,b()))}return p}finally{clearTimeout(m),t?.signal?.removeEventListener("abort",g)}}const no=()=>{const{conversationId:s}=Or(),t=s??null,r=un(),{user:o}=zt(),i=we(),l=n.useRef(!0);n.useEffect(()=>(l.current=!0,()=>{l.current=!1}),[]);const c=n.useRef(!1);n.useEffect(()=>{},[]);const y=n.useCallback((a,u)=>{if(!t)return!0;const C=Me(t),L=c.current;return L&&(c.current=!1),Ti(i,C,a,{allowAppend:u?.allowAppend??!0,forceFailOnce:L,isMountedRef:l})},[t,i]),{getString:m,getNumber:g}=Ms(),h=n.useMemo(()=>m("ux.assistant.username","movinesta").toLowerCase(),[m]),d=n.useMemo(()=>m("ux.presence.label_online","Online"),[m]),b=n.useMemo(()=>m("ux.presence.label_active_recently","Active recently"),[m]),p=n.useMemo(()=>m("ux.presence.label_active_prefix","Active"),[m]),f=n.useMemo(()=>{const a=g("ux.messages.search.min_query_chars",2),u=Number.isFinite(a)?Math.trunc(a):2;return Math.max(1,Math.min(10,u))},[g]),{data:w,isLoading:j}=Fr(),v=o?.id??null,I=oa(),M=n.useMemo(()=>!t||!w?null:w.find(a=>a.id===t)??null,[t,w]),T=M?.isMuted??!1,[S,N]=n.useState(!1),R=n.useCallback(()=>{if(!t)return;if(!v){X.error("Please sign in to manage messages.");return}const a=M?.isMuted??!1,u=M?.mutedUntil??null,C=M?.isHidden??!1;_e(i,v,t,L=>({...L,isMuted:!1,mutedUntil:null})),X.show("Unmuted notifications."),tn(v,t,{muted:!1,hidden:C,mutedUntil:null}).then(({ok:L})=>{L||(_e(i,v,t,_=>({..._,isMuted:a,mutedUntil:u})),X.error("Couldn't update preferences."))}).catch(L=>{console.warn("[ConversationPage] Failed to save conversation prefs (unmute)",L),_e(i,v,t,_=>({..._,isMuted:a,mutedUntil:u})),X.error("Couldn't update preferences.")})},[t,v,M,i]),E=n.useCallback(a=>{if(!t)return;if(!v){X.error("Please sign in to manage messages.");return}const u=M?.isMuted??!1,C=M?.mutedUntil??null,L=M?.isHidden??!1;let _=!1,P=null;a.kind==="indefinite"?(_=!0,P=null):(_=!1,P=new Date(Date.now()+a.minutes*6e4).toISOString()),_e(i,v,t,K=>({...K,isMuted:!0,mutedUntil:P})),X.show(`Muted notifications for ${a.label}.`),tn(v,t,{muted:_,hidden:L,mutedUntil:P}).then(({ok:K})=>{K||(_e(i,v,t,W=>({...W,isMuted:u,mutedUntil:C})),X.error("Couldn't update preferences."))}).catch(K=>{console.warn("[ConversationPage] Failed to save conversation prefs (mute preset)",K),_e(i,v,t,W=>({...W,isMuted:u,mutedUntil:C})),X.error("Couldn't update preferences.")})},[t,v,M,i]),F=n.useCallback(()=>{if(T){R();return}N(!0)},[T,R]),A=ci({currentUserId:o?.id??null}),{data:U,isLoading:z,isError:H,error:ce,loadOlder:ve,hasMore:pe,isLoadingOlder:jt,pollWhenRealtimeDown:Ye}=Ba(t,{onInsert:A}),Xe=n.useRef(new Set);n.useEffect(()=>{if(!t||!U||U.length===0)return;const a=Xe.current,u=new Set(U.map(C=>C.id));for(const C of U)a.has(C.id)||A(C);Xe.current=u},[t,U,A]);const{draft:de,setDraft:Re}=ti({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const a=ot.current;a&&(a.style.height="auto",a.style.height=`${Math.min(a.scrollHeight,140)}px`)})}}),{sendError:rt,lastFailedPayload:Ue,failedMessages:Nt,clearBannerState:he,onSendFailed:at,onSendRecovered:Oe,consumeLastFailedForRetry:Yt,consumeFailedMessageForRetry:je,discardFailedMessage:Se}=li({conversationId:t,setDraft:a=>Re(a),messages:U}),Q=M?.isGroup??!1,{getStatus:Mt}=qr(),q=n.useMemo(()=>{if(!M)return null;const a=M.participants.filter(u=>!u.isSelf);return a.length>0?a[0]:M.participants.length===1?M.participants[0]:null},[M]),Ce=n.useMemo(()=>Q||!q?.id?null:Mt(q.id),[Mt,Q,q?.id]),Rt=ga(Q?null:q?.id??null),Fe=n.useMemo(()=>{const a=Rt.data??null,u=cn(a);return u?u==="Just now"?"now":u:null},[Rt.data]),ee=n.useMemo(()=>{if(I?.conversationId&&t===I.conversationId)return!0;const a=q;return a?a.username?.toLowerCase()===h:!1},[I?.conversationId,t,q,h]),xe=Ai(t,ee).data??null,[qe,x]=n.useState(!1),[k,O]=n.useState(null),G=n.useRef(null),J=n.useRef(""),se=n.useRef(null),[ie,oe]=n.useState(null),fe=Z.useRef({inFlight:!1,queuedMessageId:null}),me=n.useRef(null),Ze=n.useRef(null);n.useEffect(()=>()=>{G.current&&(G.current.abort(),G.current=null),me.current&&(window.clearTimeout(me.current),me.current=null),Ze.current=null},[]);const[ue,St]=n.useState(null),Ct=n.useCallback(async a=>{if(!(!t||!v)){if(fe.current.inFlight){fe.current.queuedMessageId=a;return}fe.current.inFlight=!0,fe.current.queuedMessageId=null,x(!0),St(null);try{const u=async P=>{const K=await P.text();if(!K)return{message:`Assistant failed (${P.status})`,code:null};try{const W=JSON.parse(K);return{message:W?.message??W?.error??W?.details??K,code:W?.code??W?.errorCode??W?.error_code??null}}catch{return{message:K,code:null}}},C=(P,K)=>{if(P===415)return!0;const W=`${K.code??""} ${K.message??""}`.toLowerCase();return W.includes("stream")&&W.includes("support")},L=async P=>{const K={"Content-Type":"application/json"},W=new AbortController;P&&(G.current=W);const be=await Ui("assistant-chat-reply",{method:"POST",accept:P?"text/event-stream":"application/json",headers:K,body:{conversationId:t,userMessageId:a,stream:P},signal:W.signal});if(!be.ok){const V=await u(be);if(P&&C(be.status,V))return{fallback:!0};throw new Error(V.message??`Assistant failed (${be.status})`)}const gs=be.headers.get("Content-Type")??"";if(!P||!gs.includes("text/event-stream")||!be.body){O(null),oe(null);let V=null;try{V=await be.json()}catch{V=null}if(V&&V.ok===!1)throw new Error(V.message??V.error??"Assistant failed");try{const We=V?.messageRow;if(!y(We,{allowAppend:!0})&&(typeof V?.messageId=="string"?V.messageId:null)){const ge=Me(t);i.invalidateQueries({queryKey:ge})}}catch{}return{fallback:!1}}O(""),J.current="",oe(null);const ps=be.body.getReader(),hs=new TextDecoder;let De="",st="message",Bt=[];const Mr=(V,We)=>{if(V==="delta")try{const Y=JSON.parse(We),te=typeof Y?.text=="string"?Y.text:"";te&&(J.current+=te,se.current===null&&(se.current=requestAnimationFrame(()=>{const ge=J.current;J.current="",se.current=null,ge&&O(Pt=>`${Pt??""}${ge}`)})))}catch{}if(V==="done"){if(se.current!==null&&(cancelAnimationFrame(se.current),se.current=null),J.current){const Y=J.current;J.current="",O(te=>`${te??""}${Y}`)}try{const Y=JSON.parse(We),te=Array.isArray(Y?.citations)?Y.citations.slice(0,8):null,ge=Y?.messageRow,Pt=typeof ge?.id=="string"?ge.id:typeof Y?.messageId=="string"?Y.messageId:null;if((Pt||te)&&oe({messageId:Pt,citations:te||null}),ge&&typeof ge=="object"&&typeof ge.id=="string"){if(y(ge,{allowAppend:!0})){O(null);return}try{const Rr=Me(t);i.invalidateQueries({queryKey:Rr})}catch{}}}catch{oe(null)}}if(V==="error")try{const Y=JSON.parse(We);throw new Error(Y?.message??"Assistant failed")}catch{throw new Error("Assistant failed")}};for(;;){const{value:V,done:We}=await ps.read();if(We)break;De+=hs.decode(V,{stream:!0});let Y;for(;(Y=De.indexOf(`
`))>=0;){const te=De.slice(0,Y).replace(/\r$/,"");if(De=De.slice(Y+1),!te.trim()){Bt.length&&(Mr(st,Bt.join(`
`)),Bt=[],st="message");continue}if(te.startsWith("event:")){st=te.slice(6).trim();continue}te.startsWith("data:")&&Bt.push(te.slice(5).trimStart())}}return{fallback:!1}};(await L(!0)).fallback&&(O(null),oe(null),await L(!1))}catch(u){se.current!==null&&(cancelAnimationFrame(se.current),se.current=null),J.current="",O(null),oe(null),St({userMessageId:a,error:u?.message||"Assistant failed"})}finally{x(!1),G.current=null,i.invalidateQueries({queryKey:Me(t)}),i.invalidateQueries({queryKey:vs(v)}),i.invalidateQueries({queryKey:dn(t)}),fe.current.inFlight=!1;const u=fe.current.queuedMessageId;fe.current.queuedMessageId=null,u&&u!==a&&Ct(u)}}},[t,v,i]),Es=n.useCallback(a=>{!t||!v||ee&&(Ze.current=a,me.current&&window.clearTimeout(me.current),me.current=window.setTimeout(()=>{const u=Ze.current;Ze.current=null,me.current=null,u&&Ct(u)},600))},[t,v,ee,Ct]),Cn=n.useCallback(async(a,u)=>{if(t)try{const C=await Br("assistant-message-action",{conversationId:t,messageId:a,actionId:u},{requireAuth:!0});if(!C?.ok)throw new Error(C?.error||"Action failed");const L=C?.toast;L&&X.success(L);const _=C?.navigateTo;_&&r(_)}catch(C){const L=C instanceof Error?C.message:String(C);X.error(L||"Action failed")}finally{t&&i.invalidateQueries({queryKey:Me(t)}),v&&i.invalidateQueries({queryKey:vs(v)})}},[t,v,r,i]),it=M?.title??q?.displayName??q?.username??"Conversation",Ts=Xr(t,{onFailed:at,onRecovered:Oe,otherUserId:Q?null:q?.id??null}),et=n.useCallback((a,u)=>{he(),Ts.mutate({text:a.text,attachmentPath:a.attachmentPath,attachmentKind:a.attachmentKind??null,clientId:a.clientId,tempId:u?.tempId},{onSuccess:async C=>{he(),ee&&t&&v&&(a.text.trim().length>0||a.attachmentPath)&&Es(C.id)}})},[he,t,v,ee,Es,Ts]),ot=n.useRef(null),Xt=n.useRef(null),Be=n.useRef(!1),kn=n.useMemo(()=>{const a=new Map;if(!M)return a;for(const u of M.participants)a.set(u.id,u);return a},[M]),{youBlocked:lt,blockedYou:le,isBlocked:Pe,block:kt,unblock:It}=Zr(Q?null:q?.id??null),{imageInputRef:In,attachmentInputRef:En,isUploadingAttachment:Tn,pendingAttachment:An,uploadError:Ln,clearPendingAttachment:Dn,cancelAttachmentUpload:_n,clearUploadError:Un,handleImageSelected:On,handleAttachmentSelected:Fn,sendAttachmentFile:qn,openImagePicker:Bn,openAttachmentPicker:Pn}=ea({conversationId:t,userId:v,isBlocked:Pe,blockedYou:le,attemptSend:et}),ct=!Pe&&!le,Zt=!!q&&!Q,$n=kt.isPending||It.isPending,[zn,As]=n.useState(!1),Hn=n.useCallback(()=>{if(Zt){if(lt){It.mutate();return}le||kt.mutate()}},[kt,le,Zt,It,lt]),es=Zt?{label:lt?"Unblock":le?"Blocked":"Block",onClick:()=>{lt?It.mutate():le||kt.mutate()}}:null,{headerRef:Kn,headerHeight:Qn,composerHeight:Jn,isAtBottom:$e,setIsAtBottom:ke,handleComposerHeightChange:Ls,showEmojiPicker:Wn,setShowEmojiPicker:Et}=si({showComposer:ct}),[Vn,Tt]=n.useState(!1),[Ds,_s]=n.useState(0);n.useEffect(()=>{if(typeof window>"u")return;const a=window.visualViewport;if(!a){_s(0);return}const u=()=>{const C=Math.max(0,window.innerHeight-a.height-a.offsetTop);_s(C)};return u(),a.addEventListener("resize",u),a.addEventListener("scroll",u),window.addEventListener("orientationchange",u),()=>{a.removeEventListener("resize",u),a.removeEventListener("scroll",u),window.removeEventListener("orientationchange",u)}},[]);const Us=ct?Math.max(Jn,0)+24+Ds:40+Ds,Gn=`${Us}px`,Os=Math.max(80,Us+32),Yn=n.useMemo(()=>M?.participants.find(a=>a.isSelf)?.displayName??"You",[M]),{remoteTypingUsers:Ie,noteLocalInputActivity:Xn,stopTyping:Zn}=ei({conversationId:t,userId:o?.id??null,displayName:Yn}),{data:Fs}=Xa(t);ri({conversationId:t,userId:o?.id??null,isAtBottom:$e===!0&&Vn,messages:U});const{reactionsByMessageId:er,toggleReaction:qs}=Ya(t),tr=n.useCallback((a,u)=>{qs.mutate({messageId:a,emoji:u})},[qs]),Ee=n.useRef(null),ts=n.useRef(!1),ze=n.useRef(null),ut=n.useRef(null),At=n.useRef(!1),tt=n.useRef(!1),dt=n.useRef(!1),[Bs,He]=n.useState(0),ft=n.useRef(null),[Te,sr]=n.useState(null),Ps=n.useRef(new Map),nr=n.useCallback(a=>{ft.current=a,sr(a)},[]),mt=n.useRef(!1),[$s,Lt]=n.useState(!0),ss=n.useRef(!0),gt=ki();n.useEffect(()=>{ss.current=$s},[$s]);const{activeActionMessageId:rr,openMessageActions:zs,closeMessageActions:Dt,hiddenMessageIds:Hs,hideMessageForMe:ar,deleteDialog:Ke,openDeleteDialog:ir,closeDeleteDialog:ns,editingMessage:Qe,openEditDialog:or,updateEditingText:lr,closeEditDialog:rs,editTextareaRef:cr,editError:ur,setEditError:Ks}=ni({conversationId:t,currentUserId:v,showComposer:ct,isBlocked:Pe,blockedYou:le,composerTextareaRef:ot}),_t=za({messages:U,currentUserId:v,hiddenMessageIds:Hs}),dr=n.useMemo(()=>_t?[_t]:[],[_t]),{data:fr}=Za(t,dr),Qs=ii(t),Js=oi(t),{visibleMessages:D}=$a({messages:U,conversation:M,currentUserId:v,participantsById:kn,reactionsByMessageId:er,hiddenMessageIds:Hs,deliveryReceipts:fr??[],readReceipts:Fs??[],failedMessages:Nt,lastOwnMessageId:_t});n.useEffect(()=>{const a=ie?.messageId??null;if(!a)return;if((U??[]).some(L=>String(L?.id??"")===String(a))){O(null),oe(null);return}const C=window.setTimeout(()=>{O(null),oe(null)},8e3);return()=>window.clearTimeout(C)},[ie?.messageId,U]);const as=n.useMemo(()=>{if(!k||!t||!q?.id)return null;const a={id:`assistant_stream_${t}`,conversationId:t,senderId:q.id,createdAt:new Date().toISOString(),body:{type:"text",text:k},attachmentUrl:null,text:k},u=Array.isArray(ie?.citations)?ie?.citations:null;return u&&u.length&&(a.meta={ai:{ui:{citations:u}}}),{message:a,meta:{...vt(a.body),streaming:!0},sender:q,isSelf:!1,deliveryStatus:null,showDeliveryStatus:!1,reactions:[]}},[k,ie,t,q]),{firstUnreadIndex:pt,lastReadMessageId:Ae,hasUnread:ht,isReady:is}=ui({conversationId:t,userId:o?.id??null,conversation:M,readReceipts:Fs,visibleMessages:D}),Ws=n.useMemo(()=>{if(!is||!ht)return 0;let a=pt;if(a==null&&typeof Ae=="string"&&Ae){const u=D.findIndex(C=>C.message.id===Ae);a=u>=0?u+1:null}return a==null?0:D.slice(a).filter(u=>!u.isSelf&&!u.meta.deleted).length},[pt,ht,Ae,is,D]),Ut=D.length>0,xt=n.useRef(D),Vs=n.useRef(pe),Je=n.useRef(null),os=n.useRef(!1),ls=n.useRef(!1),cs=n.useRef(!1),Ot=n.useMemo(()=>{if(!as)return D;const a=ie?.messageId??null;return a&&D.some(u=>u.message.id===a)?D:[...D,as]},[ie?.messageId,as,D]),ye=gt?"auto":"smooth",ne=n.useCallback(a=>{const u=ft.current;u&&(mt.current=!0,requestAnimationFrame(()=>{u.scrollTo({top:u.scrollHeight,behavior:a??ye}),requestAnimationFrame(()=>{mt.current=!1})}))},[ye]),us=n.useCallback(()=>{At.current=!0,Lt(!0),ke(!0),Tt(!0),ne("auto")},[ne,ke]),yt=n.useCallback((a,u)=>{const C=Ps.current.get(a);return C?(mt.current=!0,requestAnimationFrame(()=>{C.scrollIntoView({block:u?.align??"end",behavior:u?.behavior??ye}),requestAnimationFrame(()=>{mt.current=!1})}),!0):!1},[ye]);n.useEffect(()=>{xt.current=D},[D]),n.useEffect(()=>{Vs.current=pe},[pe]);const Ft=n.useRef(null),mr=n.useCallback(()=>{const a=ft.current;a&&(Ft.current={active:!0,prevScrollHeight:a.scrollHeight,prevScrollTop:a.scrollTop,prevCount:xt.current.length})},[]);Z.useLayoutEffect(()=>{const a=Ft.current,u=ft.current;if(!a?.active||!u||D.length<=a.prevCount)return;const L=u.scrollHeight-a.prevScrollHeight;u.scrollTop=a.prevScrollTop+L,Ft.current=null},[D.length]),n.useEffect(()=>{tt.current=!1,ze.current=null,He(0)},[t]),n.useEffect(()=>{if(tt.current||!Ut||!ft.current)return;const a=D.length-1;a<0||(tt.current=!0,requestAnimationFrame(()=>{ne("auto"),Tt(!0),ke(!0),Lt(!0),ze.current=D[a]?.message.id??null,He(0)}))},[t,Ut,ne,Te,ke,D]),n.useEffect(()=>{const a=ut.current;if(!a)return;if(!D.some(L=>L.message.id===a)){ut.current=null;return}yt(a,{align:"end",behavior:"auto"})&&(ut.current=null)},[yt,D]);const qt=D.length>0?D[D.length-1].message.id:null;n.useEffect(()=>{qt&&At.current&&(At.current=!1,ne("auto"))},[qt,ne]),n.useEffect(()=>{qt&&tt.current&&ss.current&&(Ft.current?.active||ut.current||ne(ye))},[qt,ye,ne]),n.useEffect(()=>{const a=k!==null;a&&!ls.current&&(os.current=ss.current),!a&&ls.current&&(os.current=!1),ls.current=a},[k]),Z.useLayoutEffect(()=>{if(!k||!os.current)return;cs.current=!0;const a=()=>{cs.current&&(ne("auto"),Je.current=requestAnimationFrame(a))};return Je.current!==null&&cancelAnimationFrame(Je.current),Je.current=requestAnimationFrame(a),()=>{cs.current=!1,Je.current!==null&&(cancelAnimationFrame(Je.current),Je.current=null)}},[k,ne]),n.useEffect(()=>{if(!Te)return;const a=()=>{const L=Te.scrollHeight-Te.scrollTop-Te.clientHeight<=Os;Lt(_=>_===L?_:L),ke(_=>_===L?_:L),Tt(!0)};a();const u=()=>{a(),mt.current||(tt.current=!0,dt.current=!1)};return Te.addEventListener("scroll",u,{passive:!0}),()=>Te.removeEventListener("scroll",u)},[Te,Os,ke]),n.useEffect(()=>{const a=D.length?D[D.length-1]?.message.id??null:null;if($e===!0){ze.current=a,He(0);return}if(!a)return;const u=ze.current;if(u===a)return;const C=u?D.findIndex(P=>P.message.id===u):-1;if(u&&C<0){ze.current=a,He(0);return}const _=D.slice(Math.max(0,C+1)).filter(P=>!P.isSelf).length;_<=0||He(_)},[$e,D]),n.useEffect(()=>()=>{Ee.current!=null&&window.clearTimeout(Ee.current)},[]);const gr=()=>{const a=Yt();a&&et(a.payload,{tempId:a.tempId??void 0})},pr=a=>{Ee.current!=null&&window.clearTimeout(Ee.current),ts.current=!1,Ee.current=window.setTimeout(()=>{ts.current=!0,zs(a)},500)},hr=()=>{Ee.current!=null&&(window.clearTimeout(Ee.current),Ee.current=null)},xr=n.useCallback(a=>{const u=je(a.id);u&&et(u,{tempId:a.id})},[et,je]),yr=n.useCallback(a=>{Se(a.id)},[Se]),br=n.useCallback(a=>{if(a<0)return;const u=xt.current[a]?.message.id??null;u&&yt(u,{align:"center"})},[yt]),B=Ei({items:D,onJumpToItemIndex:a=>{Be.current=!0,br(a)},minQueryLen:f}),Le=B.query.trim().length>=f;n.useEffect(()=>{B.close()},[t,B.close]);const ds=()=>{Dt(),Et(!1),B.setIsOpen(!0),queueMicrotask(()=>Xt.current?.focus())},bt=()=>{B.close()};n.useEffect(()=>{const a=u=>{if(u.key==="Escape"){if(B.isOpen){u.preventDefault(),bt();return}Dt(),Et(!1)}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[Dt,bt,B.isOpen,Et]),n.useEffect(()=>{Be.current=!1},[B.query]);const fs=n.useCallback(a=>{const u=D.length-1;if(u<0)return;const C=D[u]?.message.id??null;C&&(ze.current=C),He(0),ne(a??ye),window.setTimeout(()=>{ot.current?.focus()},gt?0:200)},[ye,gt,D,ne]),wr=n.useCallback(a=>{Ls(a),$e===!0&&ne("auto")},[Ls,$e,ne]),ms=n.useCallback(async a=>{if(ht&&!dt.current){dt.current=!0;try{let u=pt;if(u==null&&typeof Ae=="string"&&Ae){let L=0;for(;Vs.current&&L<8;){const _=xt.current.findIndex(P=>P.message.id===Ae);if(_>=0){u=_+1;break}await ve(),L+=1}}if(u==null)return;const C=xt.current[u]?.message.id??null;C&&yt(C,{align:"start",behavior:a??ye}),window.setTimeout(()=>{ot.current?.focus()},gt?0:150)}finally{dt.current=!1}}},[pt,ht,is,Ae,ve,gt,ye]),vr=n.useCallback(a=>{if(!a.trim())return;he(),tt.current=!0,dt.current=!1,At.current=!0;const u=ta(),C=sa();Lt(!0),ke(!0),Tt(!0),ut.current=u,et({text:a.trim(),attachmentPath:null,clientId:C},{tempId:u})},[et,he,ke]);n.useEffect(()=>{ze.current=null,He(0)},[t]),n.useEffect(()=>{const a=u=>{if(u.key.toLowerCase()==="f"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),ds();return}if(u.key==="End"||u.key==="ArrowDown"&&(u.metaKey||u.ctrlKey)||u.key==="End"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),fs();return}u.key.toLowerCase()==="u"&&u.altKey&&(u.preventDefault(),ms())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[fs,ms,ds]);const jr=n.useMemo(()=>{if(le)return"You are blocked";if(Pe)return"You blocked them";if(ee){if(k!==null)return"Streamingâ€¦";if(qe||xe?.is_typing||xe?.is_queued)return"Typingâ€¦"}if(Ie.length>0)return Q?Ie.length===1?`${Ie[0].displayName??"Someone"} typingâ€¦`:`${Ie.length} typingâ€¦`:"Typingâ€¦";if(!Q&&Ce){if(Ce==="online")return d;if(Ce==="away")return b}return!Q&&Fe?Fe==="now"?d:`${p} ${Fe}`:M?.subtitle||(Q?"Group chat":"Direct message")},[le,Pe,ee,qe,xe?.is_typing,xe?.is_queued,k,Q,Ce,Fe,M?.subtitle,Ie,d,b,p]),Nr=n.useMemo(()=>{const a=M?.participants??[],u=new Map(a.map(_=>[_.id,_])),C=[];for(const _ of Ie){const P=u.get(_.userId),K=P?.displayName??_.displayName??"Someone";C.push({id:_.userId,displayName:K,avatarUrl:P?.avatarUrl??null})}return ee&&q?.id&&(qe||xe?.is_typing||xe?.is_queued)&&k===null&&(C.some(P=>P.id===q.id)||C.unshift({id:q.id,displayName:q.displayName??q.username??it??"Assistant",avatarUrl:q.avatarUrl??null})),C},[qe,k,xe?.is_typing,xe?.is_queued,M?.participants,it,ee,q,Ie]);return t?e.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background",children:[e.jsxs("div",{ref:Kn,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[e.jsxs("header",{className:"flex items-center justify-between page-pad py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>r(-1),className:"icon-hit","aria-label":"Go back",children:e.jsx(re,{name:"arrow_back"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:q?.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:q.displayName??"Conversation",className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(q?.displayName??it).slice(0,2).toUpperCase()})}),!Q&&(Ce==="online"||Fe==="now")&&e.jsx("span",{className:Rs("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:it}),e.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:jr})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Search in conversation",onClick:()=>{B.isOpen?bt():ds()},children:e.jsx(re,{name:"search"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Video call",onClick:()=>X.show("Video calls are coming soon."),children:e.jsx(re,{name:"videocam"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Conversation info",onClick:()=>As(!0),children:e.jsx(re,{name:"info"})}),es?e.jsx("button",{type:"button",onClick:es.onClick,className:"icon-hit","aria-label":es.label,children:e.jsx(jn,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),B.isOpen&&e.jsxs("div",{className:"page-pad pb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:e.jsx(re,{name:"search",className:"text-muted-foreground"})}),e.jsx("input",{ref:Xt,value:B.query,onChange:a=>B.setQuery(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){if(a.preventDefault(),!Le||B.matchCount===0)return;if(a.shiftKey){Be.current=!0,B.jumpPrev();return}if(!Be.current){B.jumpToFirst(),Be.current=!0;return}B.jumpNext()}a.key==="Escape"&&(a.preventDefault(),bt())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background",autoComplete:"off",spellCheck:!1}),B.query.trim()&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 icon-hit","aria-label":"Clear search",onClick:()=>{B.clear(),queueMicrotask(()=>Xt.current?.focus())},children:e.jsx(re,{name:"close"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Previous match",disabled:!Le||B.matchCount===0,onClick:()=>{Be.current=!0,B.jumpPrev()},children:e.jsx(re,{name:"keyboard_arrow_up"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Next match",disabled:!Le||B.matchCount===0,onClick:()=>{Be.current=!0,B.jumpNext()},children:e.jsx(re,{name:"keyboard_arrow_down"})}),e.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:Le?`${B.activeMatchNumber}/${B.matchCount}`:"0/0"}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Close search",onClick:bt,children:e.jsx(re,{name:"close"})})]})]}),Le&&B.matchCount===0&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-muted/10",children:[Ye&&e.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center page-pad",children:e.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/85 px-3 py-1 text-[12px] text-muted-foreground shadow-sm backdrop-blur",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),e.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),e.jsx(di,{items:Ot,isLoading:z&&!Ut,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:H?e.jsxs("div",{className:"mb-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-[12px] text-destructive",children:[e.jsx("p",{className:"font-medium text-foreground",children:"We couldn't load this conversation."}),ce instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:ce.message})]}):void 0,emptyContent:Ut?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:Q?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:Q?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:e.jsxs(e.Fragment,{children:[e.jsx(pi,{users:Nr}),e.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:pe?e.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:jt?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):e.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Gn,scrollerRef:nr,onStartReached:()=>{pe&&!jt&&(mr(),ve())},computeItemKey:(a,u)=>u.message.id,itemContent:(a,u)=>{const{message:C,meta:L,sender:_,isSelf:P,deliveryStatus:K,reactions:W,showDeliveryStatus:be}=u,gs=a>0?Ot[a-1]?.message??null:null,ps=a<Ot.length-1?Ot[a+1]?.message??null:null,hs=De=>{const st=Ps.current;De?st.set(C.id,De):st.delete(C.id)};return e.jsx("div",{ref:hs,"data-message-id":C.id,children:e.jsx(na,{message:C,meta:L,sender:_,isSelf:P,deliveryStatus:K,showDeliveryStatus:be,reactions:W,index:a,previousMessage:gs,nextMessage:ps,firstUnreadIndex:pt,activeActionMessageId:rr,longPressTriggeredRef:ts,onOpenMessageActions:zs,onCloseMessageActions:Dt,onOpenEditDialog:or,onOpenDeleteDialog:ir,onToggleReaction:tr,onRetryMessage:xr,onDiscardFailedMessage:yr,onAssistantAction:Cn,onBubbleTouchStart:pr,onBubbleTouchEndOrCancel:hr,searchQuery:Le?B.query:void 0,isSearchMatch:Le?B.isMatch(C.id):!1,isActiveSearchMatch:Le?B.activeMessageId===C.id:!1})})}}),e.jsx(mi,{show:!!(ht&&Ws>0&&$e!==!0),unreadCount:Ws,onClick:ms,shortcutHint:"Alt+U"}),e.jsx(fi,{show:$e!==!0&&Bs>0,pendingCount:Bs,onClick:fs,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),ue&&ee&&ct&&e.jsx("div",{className:"page-pad pb-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(re,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),e.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:ue.error})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const a=ue.userMessageId;St(null),Ct(a)},children:[e.jsx(re,{name:"refresh",className:"text-base"}),"Retry"]}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>St(null),children:"Dismiss"})]})]})}),e.jsx(Ni,{show:ct,headerHeight:Qn,onHeightChange:wr,typingUsers:Ie,isGroupConversation:Q,draft:de,setDraft:Re,textareaRef:ot,noteLocalInputActivity:Xn,stopTyping:Zn,onSendText:vr,onRequestScrollToBottom:us,isUploadingAttachment:Tn,pendingAttachment:An,clearPendingAttachment:Dn,cancelAttachmentUpload:_n,sendError:!!rt,sendErrorMessage:rt,canRetrySend:!!Ue,onRetrySend:gr,uploadError:Ln,clearUploadError:Un,showEmojiPicker:Wn,setShowEmojiPicker:Et,openCameraPicker:Bn,openAttachmentPicker:Pn,imageInputRef:In,attachmentInputRef:En,onImageSelected:a=>{us(),On(a)},onAttachmentSelected:a=>{us(),Fn(a)},onAttachmentFile:a=>qn(a),disableSend:!!(Pe||le)}),le&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Pe&&!le&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),e.jsx(Mi,{open:!!Qe,editingMessage:Qe,onOpenChange:a=>{a||rs()},onCancel:rs,onTextChange:lr,textareaRef:cr,error:ur,isSaving:Qs.isPending,onSave:()=>{if(!Qe)return;const a=Qe.text.trim();a&&(Ks(null),Qs.mutate({messageId:Qe.messageId,text:a,currentBody:Qe.body,attachmentUrl:Qe.attachmentUrl},{onSuccess:()=>{rs()},onError:()=>{Ks("Couldn't save changes. Please try again.")}}))}}),e.jsx(Ri,{open:!!Ke,deleteDialog:Ke,onOpenChange:a=>{a||ns()},onHideForMe:()=>{Ke&&(ar(Ke.messageId),ns())},onDeleteForEveryone:()=>{Ke&&Js.mutate({messageId:Ke.messageId,attachmentUrl:Ke.attachmentUrl},{onSettled:()=>{ns()}})},isDeleting:Js.isPending}),t&&e.jsx(Ci,{open:zn,onOpenChange:As,conversation:M,currentUserId:v,conversationId:t,isMuted:T,onToggleMute:F,otherParticipant:q,isGroupConversation:Q,youBlocked:lt,blockedYou:le,blockPending:$n,onBlockToggle:Hn}),t&&e.jsx(la,{open:S,onOpenChange:N,conversationTitle:it,onSelect:a=>E(a)})]}):e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center page-pad",children:e.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Pr,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{no as default,Xr as useSendMessage};
