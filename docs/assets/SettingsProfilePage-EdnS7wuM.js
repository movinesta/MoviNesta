import{r as c,j as e,d as U,v as k,w as E,f as L,B as y,p as R,s as j}from"./index-fug2llhW.js";import{P as S}from"./PageChrome-CqQc8kbT.js";import{T as F}from"./TopBar-Cwkp26YK.js";import{a as A}from"./useProfile-npooRKyi.js";import{U as D}from"./user-CvXjFL_D.js";import{C as T}from"./circle-alert-D1FeqQXB.js";import{C as q}from"./circle-check-CHj4IJre.js";const B=({label:a="Avatar",description:r,initialUrl:m=null,disabled:h=!1,onFileChange:x,fallbackIcon:b,className:i})=>{const[o,s]=c.useState(m),p=c.useRef(null),l=c.useRef(null);c.useEffect(()=>{s(m)},[m]),c.useEffect(()=>()=>{l.current&&URL.revokeObjectURL(l.current)},[]);const t=()=>{h||p.current?.click()},n=f=>{const u=f.target.files?.[0]??null;if(!u){x?.(null);return}l.current&&(URL.revokeObjectURL(l.current),l.current=null);const g=URL.createObjectURL(u);l.current=g,s(g),x?.(u)},d="pt-1"+(i?` ${i}`:"");return e.jsxs("div",{className:d,children:[a&&e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:a}),e.jsxs("div",{className:"mt-2 flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:t,disabled:h,className:"relative inline-flex h-12 w-12 items-center justify-center overflow-hidden rounded-full border border-dashed border-border bg-card/80 text-xs font-medium text-muted-foreground hover:border-primary hover:bg-primary/5 focus:outline-none focus:ring-2 focus:ring-primary/40 disabled:cursor-not-allowed disabled:opacity-60","aria-label":"Upload avatar",children:o?e.jsx("img",{src:o,alt:"Avatar preview",className:"h-full w-full object-cover"}):e.jsx("span",{className:"select-none text-lg",children:b??"ðŸ“½ï¸"})}),r&&e.jsx("div",{className:"text-xs text-left text-muted-foreground",children:r})]}),e.jsx("input",{ref:p,type:"file",accept:"image/*",className:"hidden",onChange:n})]})},Q=()=>{const{user:a}=U(),{data:r,isLoading:m,isError:h,error:x}=A(),b=k(),[i,o]=c.useState(()=>({displayName:r?.displayName??"",bio:r?.bio??"",avatarFile:null}));c.useEffect(()=>{r&&o(t=>({...t,displayName:r.displayName??"",bio:r.bio??""}))},[r]);const s=E({mutationFn:async({displayName:t,bio:n,avatarFile:d})=>{if(!a)throw new Error("You need to be signed in to update your profile.");let f=r?.avatarUrl??null;if(d){const g=d.name.split(".").pop(),v=`${a.id}/${Date.now()}.${g??"jpg"}`,{error:N,data:w}=await j.storage.from("avatars").upload(v,d,{cacheControl:"3600",upsert:!0});if(N)throw N;const P=w?.path??v,{data:C}=j.storage.from("avatars").getPublicUrl(P);f=C.publicUrl??f}const{error:u}=await j.from("profiles").update({display_name:t.trim()||null,bio:n.trim()||null,avatar_url:f}).eq("id",a.id);if(u)throw u},onSuccess:()=>{b.invalidateQueries({queryKey:["profile"]}),o(t=>({...t,avatarFile:null}))}}),p=t=>n=>{o(d=>({...d,[t]:n.target.value}))},l=async t=>{t.preventDefault(),!(!a||!r||s.isPending)&&await s.mutateAsync({displayName:i.displayName,bio:i.bio,avatarFile:i.avatarFile})};return a?m?e.jsx(L,{message:"Loading your profileâ€¦"}):h||!r?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Profile unavailable"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"We couldn't load your profile right now."}),x?.message&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Details:"})," ",x.message]})]})}):e.jsxs("div",{className:"flex flex-1 flex-col gap-4 pb-2 pt-1",children:[e.jsx(F,{title:"Profile",subtitle:"Tune the essentials that shape how you appear across MoviNesta."}),e.jsx("section",{className:"px-1 pb-24",children:e.jsx(S,{children:e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"mb-2 flex items-start gap-3",children:[e.jsx("span",{className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-border/50",children:e.jsx(D,{className:"h-4 w-4 text-muted-foreground","aria-hidden":"true"})}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("h2",{className:"text-sm font-heading font-semibold text-foreground",children:"Public profile"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your profile is shown on your diary, reviews, and social features."})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(B,{initialUrl:r.avatarUrl,description:"Upload a square image (PNG/JPG) to use across the app.",disabled:s.isPending,onFileChange:t=>o(n=>({...n,avatarFile:t}))}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"displayName",className:"block text-xs font-medium uppercase tracking-[0.16em] text-muted-foreground",children:"Display name"}),e.jsx("input",{id:"displayName",type:"text",value:i.displayName,onChange:p("displayName"),maxLength:80,className:"w-full rounded-md border border-border bg-background px-3 py-2 text-sm text-foreground shadow-sm outline-none ring-0 placeholder:text-muted-foreground focus:border-border focus:ring-2 focus:ring-border/40",placeholder:"How should we show your name?"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This is the name other people see on your profile and activity."})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"bio",className:"block text-xs font-medium uppercase tracking-[0.16em] text-muted-foreground",children:"Bio"}),e.jsx("textarea",{id:"bio",value:i.bio,onChange:p("bio"),rows:4,maxLength:280,className:"w-full resize-none rounded-md border border-border bg-background px-3 py-2 text-sm text-foreground shadow-sm outline-none ring-0 placeholder:text-muted-foreground focus:border-border focus:ring-2 focus:ring-border/40",placeholder:"Tell people a bit about your taste in movies."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can use multiple lines. Keep it short and cinematic."})]})]}),(s.isError||s.isSuccess)&&e.jsxs("div",{className:"pt-1 text-xs",children:[s.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-destructive",children:[e.jsx(T,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:s.error?.message??"Couldnâ€™t save changes."})]}),s.isSuccess&&!s.isError&&e.jsxs("div",{className:"flex items-center gap-1.5 text-emerald-400",children:[e.jsx(q,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("span",{children:"Profile updated."})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(y,{type:"button",variant:"outline",size:"sm",onClick:()=>{r&&(o({displayName:r.displayName??"",bio:r.bio??"",avatarFile:null}),s.reset())},children:"Reset"}),e.jsxs(y,{type:"submit",size:"sm",disabled:s.isPending,children:[s.isPending&&e.jsx(R,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save changes"})]})]})]})})})]}):e.jsx("div",{className:"flex flex-1 flex-col items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-2xl border border-border bg-card/80 px-4 py-6 text-center text-sm text-foreground shadow-lg",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"You're signed out"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to edit your profile settings."})]})})};export{Q as default};
