import{C as ae,r as t,j as e,i as l,u as ie,b as re,s as H,ai as x,B as c,ad as A,S as ne,E as w}from"./index-DHFRnTo7.js";import{I as oe}from"./input-tZpO87qv.js";import{T as le}from"./textarea-xzg6jW3B.js";import{u as ce,T as q,S as U}from"./scroll-area-WFgP_c77.js";import{d as de,S as me}from"./useConversationMessages-BRxbVw01.js";import{S as xe}from"./sparkles-CdMjDCnb.js";import{C as W}from"./copy-jck8F9gH.js";import"./conversationsCache-_zctdFM2.js";import"./format-BXv9LLlt.js";import"./index-DN-awVsS.js";const ue=[["path",{d:"M12 17v5",key:"bb1du9"}],["path",{d:"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z",key:"1nkz8b"}]],O=ae("pin",ue),u=t.forwardRef(({className:r,...a},o)=>e.jsx("div",{ref:o,className:l("rounded-xl border border-border bg-card text-card-foreground shadow-sm",r),...a}));u.displayName="Card";const he=t.forwardRef(({className:r,...a},o)=>e.jsx("div",{ref:o,className:l("flex flex-col space-y-1.5 p-6",r),...a}));he.displayName="CardHeader";const fe=t.forwardRef(({className:r,...a},o)=>e.jsx("h3",{ref:o,className:l("text-lg font-semibold leading-none tracking-tight",r),...a}));fe.displayName="CardTitle";const pe=t.forwardRef(({className:r,...a},o)=>e.jsx("p",{ref:o,className:l("text-sm text-muted-foreground",r),...a}));pe.displayName="CardDescription";const ge=t.forwardRef(({className:r,...a},o)=>e.jsx("div",{ref:o,className:l("p-6 pt-0",r),...a}));ge.displayName="CardContent";const ve=t.forwardRef(({className:r,...a},o)=>e.jsx("div",{ref:o,className:l("flex items-center p-6 pt-0",r),...a}));ve.displayName="CardFooter";const K="movinesta.assistant.pins.v1";function F(){try{return crypto.randomUUID()}catch{return`id_${Date.now()}_${Math.random().toString(16).slice(2)}`}}function G(r){return(r.text??r.body??"").toString()}function je(){try{const r=localStorage.getItem(K);if(!r)return[];const a=JSON.parse(r);return Array.isArray(a)?a.filter(Boolean):[]}catch{return[]}}function Ne(r){try{localStorage.setItem(K,JSON.stringify(r))}catch{}}function Re(){const r=ie(),{user:a}=re(),[o,V]=t.useState(null),[P,p]=t.useState(!0),[d,T]=t.useState("General"),[g,J]=t.useState(""),[v,C]=t.useState(""),[j,N]=t.useState(!1),[k,b]=t.useState(null),[f,S]=t.useState(()=>je()),R=t.useRef(null),M=t.useRef(null),E=t.useRef(!0);t.useEffect(()=>{if(!a)return;let s=!0;return(async()=>{p(!0);const{data:n,error:i}=await H.functions.invoke("assistant-get-conversation");if(!s)return;if(i){console.error("assistant-get-conversation",i),x.error("Assistant",{description:"Couldn't load your assistant chat. Try again."}),p(!1);return}const m=n?.conversationId;if(!m){x.error("Assistant",{description:"Assistant chat couldn't be created (missing conversationId)."}),p(!1);return}V(m),p(!1)})(),()=>{s=!1}},[a]);const{data:I,isLoading:Q,hasNextPage:Y,fetchNextPage:$,isFetchingNextPage:D}=de(o),y=ce(o),h=t.useMemo(()=>{const n=(Array.isArray(I)?I:[]).slice().sort((m,_)=>{const B=new Date(m.createdAt).getTime()-new Date(_.createdAt).getTime();return B!==0?B:String(m.id).localeCompare(String(_.id))});if(!g.trim())return n;const i=g.trim().toLowerCase();return n.filter(m=>G(m).toLowerCase().includes(i))},[I,g]);t.useEffect(()=>{if(!j||!k)return;const s=h.findIndex(i=>(i.clientId??null)===k);if(s<0)return;h.slice(s+1).some(i=>i.senderId!==a?.id)&&(N(!1),b(null))},[j,k,h,a?.id]);const X=t.useCallback(()=>{const s=M.current;if(!s)return;const n=s.scrollHeight-s.scrollTop-s.clientHeight;E.current=n<80},[]);t.useEffect(()=>{E.current&&R.current?.scrollIntoView({block:"end",behavior:"smooth"})},[h.length]),t.useEffect(()=>{Ne(f)},[f]);const Z=t.useMemo(()=>[{label:"Pick a movie tonight",mode:"Recommendations",text:"Recommend 5 movies for tonight based on my mood (ask me 1 question first)."},{label:"Build my watchlist",mode:"Watchlist",text:"Help me build a 10-item watchlist. Ask what genres, pacing, and language I want."},{label:"Explain a film ending",mode:"Explain",text:"Explain the ending of a movie (I'll paste the title and what confused me)."},{label:"Mood-based picks",mode:"Mood",text:"I'm feeling: <replace>. Suggest movies or series that match."}],[]),z=t.useCallback(async()=>{const s=v.trim();if(!s||!o||!a?.id)return;const n=F();N(!0),b(n);try{await y.mutateAsync({text:s,clientId:n}),C("");const{error:i}=await H.functions.invoke("assistant-chat-reply",{body:{conversationId:o,userId:a.id,text:s,clientId:n,surface:"messages",mode:d}});i&&(console.error("assistant-chat-reply",i),x.error("Assistant",{description:"Your message was sent, but the assistant failed to respond."}),N(!1),b(null))}catch(i){console.error(i),x.error("Message failed",{description:i instanceof Error?i.message:"Unknown error"}),N(!1),b(null)}},[v,o,a?.id,y,d]),ee=!!v.trim()&&!y.isPending&&!!o,se=s=>{const n=s.trim();n&&(S(i=>[{id:F(),text:n,createdAt:new Date().toISOString()},...i].slice(0,20)),x.success("Pinned",{description:"Saved to your assistant sidebar (local)."}))},te=s=>{S(n=>n.filter(i=>i.id!==s))},L=async s=>{try{await navigator.clipboard.writeText(s),x.success("Copied",{description:"Copied to clipboard."})}catch{x.error("Copy failed",{description:"Couldn't copy to clipboard."})}};return a?e.jsxs("div",{className:"h-[100svh] w-full overflow-hidden bg-gradient-to-b from-background to-muted/30",children:[e.jsx("div",{className:"sticky top-0 z-20 border-b bg-background/80 backdrop-blur",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-4 py-3 flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-primary/10 border flex items-center justify-center",children:e.jsx(xe,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold leading-tight",children:"AI Assistance"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:P?"Preparing your chat…":j?"Thinking…":"Ready"})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("div",{className:"hidden sm:flex items-center gap-2",children:["General","Recommendations","Watchlist","Explain","Mood"].map(s=>e.jsx(A,{active:d===s,onClick:()=>T(s),className:"cursor-pointer",children:s},s))}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>r("/messages"),children:"Messages"})]})]})}),e.jsxs("div",{className:"mx-auto max-w-6xl h-[calc(100svh-57px)] px-4 py-4 grid grid-cols-1 lg:grid-cols-[320px_1fr_280px] gap-4",children:[e.jsxs("div",{className:"hidden lg:flex flex-col gap-4",children:[e.jsxs(u,{className:"p-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-3",children:"Quick actions"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Z.map(s=>e.jsx(A,{className:"cursor-pointer",onClick:()=>{T(s.mode),C(s.text)},children:s.label},s.label))}),e.jsx("div",{className:"text-xs text-muted-foreground mt-3",children:"Tip: pick a mode, then hit Send."})]}),e.jsxs(u,{className:"p-4 flex-1 min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsxs("div",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(O,{className:"h-4 w-4"}),"Pinned"]}),f.length>0?e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>{S([]),x.success("Cleared",{description:"Pinned items cleared (local)."})},children:e.jsx(q,{className:"h-4 w-4"})}):null]}),e.jsx(U,{className:"h-full",children:e.jsx("div",{className:"space-y-2",children:f.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Pin an assistant reply to keep it here."}):f.map(s=>e.jsxs("div",{className:"group rounded-xl border bg-background/60 p-3",children:[e.jsx("div",{className:"text-sm whitespace-pre-wrap break-words",children:s.text}),e.jsxs("div",{className:"mt-2 flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] text-muted-foreground",children:new Date(s.createdAt).toLocaleString()}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition flex items-center gap-2",children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>L(s.text),children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>te(s.id),children:e.jsx(q,{className:"h-4 w-4"})})]})]})]},s.id))})})]})]}),e.jsxs(u,{className:"min-h-0 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-3 border-b flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ne,{className:"h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"}),e.jsx(oe,{value:g,onChange:s=>J(s.target.value),placeholder:"Search this chat",className:"pl-9"})]}),Y?e.jsx(c,{variant:"outline",size:"sm",onClick:()=>$(),disabled:D,children:D?e.jsx(w,{className:"h-4 w-4 animate-spin"}):"Older"}):null]}),e.jsx("div",{className:"flex-1 min-h-0",onScrollCapture:X,ref:M,children:e.jsx(U,{className:"h-full",children:e.jsxs("div",{className:"p-4 space-y-3",children:[P||Q?e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(w,{className:"h-4 w-4 animate-spin"}),"Loading…"]}):h.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Start a new conversation with the assistant."}):h.map(s=>{const n=s.senderId===a?.id,i=G(s);return e.jsx("div",{className:l("flex",n?"justify-end":"justify-start"),children:e.jsxs("div",{className:l("group max-w-[92%] sm:max-w-[78%] rounded-2xl px-4 py-3 border shadow-sm",n?"bg-primary text-primary-foreground border-primary/20":"bg-background/70 border-border/60"),children:[e.jsx("div",{className:"text-sm whitespace-pre-wrap break-words",children:i}),e.jsxs("div",{className:l("mt-2 flex items-center gap-2",n?"justify-end":"justify-start"),children:[e.jsx("div",{className:l("text-[11px]",n?"text-primary-foreground/70":"text-muted-foreground"),children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),n?null:e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition flex items-center gap-1",children:[e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>L(i),className:"h-7 px-2",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(c,{size:"sm",variant:"ghost",onClick:()=>se(i),className:"h-7 px-2",children:e.jsx(O,{className:"h-4 w-4"})})]})]})]})},s.id)}),j?e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[92%] sm:max-w-[78%] rounded-2xl px-4 py-3 border bg-background/70 text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 animate-spin"}),"Thinking…"]})}):null,e.jsx("div",{ref:R})]})})}),e.jsxs("div",{className:"p-3 border-t bg-background/70",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx(le,{value:v,onChange:s=>C(s.target.value),placeholder:d==="Recommendations"?"Tell me what you feel like watching…":d==="Watchlist"?"What kind of watchlist do you want?":d==="Explain"?"Paste the title + what confused you…":d==="Mood"?"Describe your mood (e.g. cozy, intense, funny)…":"Ask anything…",className:"min-h-[52px] max-h-40",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),z())}}),e.jsx(c,{disabled:!ee,onClick:()=>{z()},className:"h-[52px] rounded-xl",children:y.isPending?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(me,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Enter to send • Shift+Enter for newline"}),e.jsx("div",{className:"sm:hidden flex items-center gap-2",children:e.jsx(A,{active:!0,className:"cursor-default",children:d})})]})]})]}),e.jsxs("div",{className:"hidden lg:flex flex-col gap-4",children:[e.jsxs(u,{className:"p-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"What I can do"}),e.jsxs("ul",{className:"text-sm text-muted-foreground space-y-2 list-disc pl-5",children:[e.jsx("li",{children:"Recommend movies & series (mood, genre, length)"}),e.jsx("li",{children:"Build watchlists and watching plans"}),e.jsx("li",{children:"Explain endings, themes, and characters"}),e.jsx("li",{children:"Suggest similar titles based on one example"})]})]}),e.jsxs(u,{className:"p-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Privacy"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Pinned items are stored only in your browser (localStorage). Messages are stored in your MoviNesta database."})]})]})]})]}):e.jsx("div",{className:"p-6",children:e.jsxs(u,{className:"p-6",children:[e.jsx("div",{className:"font-semibold",children:"Sign in required"}),e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:"Please sign in to use the assistant."}),e.jsx("div",{className:"mt-4",children:e.jsx(c,{onClick:()=>r("/auth/signin"),children:"Go to sign in"})})]})})}export{Re as default};
