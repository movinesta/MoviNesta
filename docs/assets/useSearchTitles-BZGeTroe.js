import{r as F,ah as N,t as L,F as E,s as R,ai as S,m as B,aj as C,a7 as U,ak as Q}from"./index-Bghr9v56.js";const te=(e,t)=>{const[s,o]=F.useState(e);return F.useEffect(()=>{const n=window.setTimeout(()=>{o(e)},t);return()=>{window.clearTimeout(n)}},[e,t]),s},T=e=>{if(e?.aborted)throw e.reason??new DOMException("Aborted","AbortError")};async function W(e,t){const s=e.map(async o=>{if(o.imdbId||!o.tmdbId)return o;T(t);try{const n=await N(`/${o.type==="tv"?"tv":"movie"}/${o.tmdbId}/external_ids`,{},t);return T(t),{...o,imdbId:n?.imdb_id??null}}catch(n){return console.warn("[externalMovieSearch] Failed to fetch external ids for",o.tmdbId,n),o}});return Promise.all(s)}async function z(e,t=1,s){const o=e.trim();if(!o)return{results:[],hasMore:!1};T(s);const n=await N("/search/multi",{query:o,include_adult:!1,page:t},s);T(s);const l=Array.isArray(n?.results)?n.results:[];if(!l.length)return{results:[],hasMore:!1};const c=typeof n?.total_pages=="number"?n.total_pages:1,r=l.filter(i=>!!(i&&typeof i.id=="number"&&(i.media_type==="movie"||i.media_type==="tv"))).slice(0,20).map(i=>{const u=i.media_type==="tv"?"tv":"movie",h=i.release_date??i.first_air_date??null,b=h?Number(String(h).slice(0,4)):null;return{tmdbId:Number(i.id),imdbId:i.imdb_id??null,title:i.title??i.name??"Untitled",year:Number.isNaN(b)?null:b,type:u,posterUrl:L(i.poster_path??null)}});return{results:await W(r,s),hasMore:t<c}}const v=e=>{if(e?.aborted)throw e.reason??new DOMException("Aborted","AbortError")},Y=e=>{const t=B(e);return{id:t.id,title:t.title,year:t.year,type:t.type,source:"library",posterUrl:t.posterUrl??t.backdropUrl,originalLanguage:t.originalLanguage,ageRating:t.ageRating,imdbRating:t.imdbRating,rtTomatoMeter:t.rtTomatoMeter,imdbId:t.imdbId,tmdbId:t.tmdbId}};function $(){const e=S("ux.search.page_size",20);return Math.max(1,Math.floor(e))}function K(){const e=S("ux.search.batch_sync_limit",5);return Math.max(0,Math.floor(e))}function q(){const e=S("ops.search.timeout_ms",2e4);return Math.max(1e3,Math.floor(e))}const O=async()=>{try{const{data:e}=await R.auth.getSession();return!!e?.session?.access_token}catch{return!1}},G=async(e,t,s,o)=>{v(o);try{const g=$(),M=q(),a=await E("media-search",{query:e.trim(),page:s,limit:g,filters:t??{}},{signal:o,timeoutMs:M});if(a?.ok&&Array.isArray(a.results))return v(o),{results:a.results.map(Y),hasMore:!!a.hasMore}}catch(g){console.warn("[search.service] media-search Edge Function failed, falling back",g)}const n=`
    id,
    kind,
    tmdb_id,
    tmdb_title,
    tmdb_name,
    tmdb_original_title,
    tmdb_original_name,
    tmdb_release_date,
    tmdb_first_air_date,
    tmdb_poster_path,
    tmdb_backdrop_path,
    tmdb_original_language,
    tmdb_genre_ids,
    omdb_title,
    omdb_year,
    omdb_language,
    omdb_imdb_id,
    omdb_imdb_rating,
    omdb_rating_rotten_tomatoes,
    omdb_poster,
    omdb_rated
  `,l=$(),c=(s-1)*l;let r=R.from("media_items").select(n,{count:"exact"});r=r.range(c,c+l-1),o&&(r=r.abortSignal(o)),e&&(r=r.textSearch("search_vector",e.trim(),{config:"english",type:"websearch"})),t?.type&&t.type!=="all"&&(r=r.eq("kind",t.type==="series"?"series":t.type)),t?.genreIds?.length&&(r=r.overlaps("tmdb_genre_ids",t.genreIds));const d=typeof t?.minYear=="number",i=typeof t?.maxYear=="number";if(d||i){const g=d?`${t.minYear}-01-01`:null,M=i?`${t.maxYear}-12-31`:null,a=[];for(const y of["tmdb_release_date","tmdb_first_air_date"])g&&M?a.push(`and(${y}.gte.${g},${y}.lte.${M})`):g?a.push(`${y}.gte.${g}`):M&&a.push(`${y}.lte.${M}`);a.length&&(r=r.or(a.join(",")))}t?.originalLanguage&&(r=r.eq("tmdb_original_language",t.originalLanguage)),r=r.order("tmdb_release_date",{ascending:!1,nullsFirst:!1}).order("tmdb_first_air_date",{ascending:!1,nullsFirst:!1}).order("tmdb_title",{ascending:!0,nullsFirst:!0});const{data:u,error:h,count:b}=await r;if(h)throw new Error(h.message);v(o);const p=u??[],_=typeof b=="number"?b:void 0,m=_?c+p.length<_:p.length===l;return{results:p.map(Y),hasMore:m}},H=async e=>{const{query:t,filters:s,page:o=1,signal:n}=e,l=t.trim(),c=s?.type&&s.type!=="all"||typeof s?.minYear=="number"||typeof s?.maxYear=="number"||!!s?.originalLanguage||!!s?.genreIds?.length;v(n);let r=[],d=!1;try{const{results:a,hasMore:y}=await G(l,s,o,n);r=a,d=y}catch(a){console.warn("[search.service] Supabase search failed, falling back to TMDb",a)}if((!s?.type||s.type==="all")&&(r=r.filter(a=>a.type==null||a.type==="movie"||a.type==="series")),!l)return c?{results:r,hasMore:d}:{results:[],hasMore:!1};const{results:u,hasMore:h}=await z(l,o,n);if(v(n),!u.length&&r.length>0)return{results:r,hasMore:d};const b=new Set,p=new Set;for(const a of r)a.tmdbId&&b.add(a.tmdbId),a.imdbId&&p.add(a.imdbId);const _=u.filter(a=>!(a.tmdbId&&b.has(a.tmdbId)||a.imdbId&&p.has(a.imdbId))),m=new Map;if(_.length&&await O()){const a=K(),y=q(),x=_.filter(f=>f.tmdbId).slice(0,a).map(f=>({tmdbId:f.tmdbId??null,imdbId:f.imdbId??null,contentType:f.type==="tv"?"series":"movie"}));if(x.length)try{const f=await E("catalog-sync-batch",{items:x,options:{syncOmdb:!0,forceRefresh:!1}},{signal:n,timeoutMs:y});f?.ok&&Array.isArray(f.results)&&f.results.forEach(I=>{if(!I?.mediaItemId||!I.tmdbId||!I.contentType)return;const D=`${I.contentType}:${I.tmdbId}`;m.set(D,I.mediaItemId)})}catch(f){console.warn("[search.service] catalog-sync-batch failed",f)}}const g=await Promise.all(_.map(async a=>{v(n);const y=a.type==="tv"?"series":"movie",x=a.tmdbId?`${y}:${a.tmdbId}`:null,f=x&&m.get(x)?m.get(x):a.tmdbId?`${a.type==="tv"?"tv":"tmdb"}-${a.tmdbId}`:`tmdb-${Math.random()}`,I=!f.startsWith("tmdb-")&&!f.startsWith("tv-");return a.tmdbId&&b.add(a.tmdbId),a.imdbId&&p.add(a.imdbId),{id:f,title:a.title,year:a.year??null,type:y,source:I?"external-synced":"external-only",posterUrl:a.posterUrl,originalLanguage:null,ageRating:null,imdbRating:null,rtTomatoMeter:null,imdbId:a.imdbId??null,tmdbId:a.tmdbId}}));return{results:[...r,...g.filter(a=>!!a)],hasMore:d||h}},j=e=>{if(!e)return null;const t=e.trim().toLowerCase();return t==="relevance"||t==="newest"||t==="rating"?t:null},V=e=>e.trim().length>0?"relevance":"newest",A=e=>e.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(),Z=e=>{const t=e.match(/\b(19\d{2}|20\d{2})\b/);if(!t)return null;const s=Number(t[1]);return Number.isFinite(s)?s:null},P=(e,t)=>{const s=A(e);if(!s)return 0;const o=A(t.title??"");if(!o)return 0;let n=0;o===s?n+=1e3:o.startsWith(s)?n+=850:o.includes(` ${s} `)?n+=780:o.includes(s)&&(n+=650);const l=s.split(" ").filter(r=>r.length>=2);if(l.length){const r=new Set(o.split(" "));let d=0;for(const i of l)if(r.has(i))d+=1;else for(const u of r)if(u.startsWith(i)){d+=1;break}n+=d*35}const c=Z(e);if(c&&t.year){const r=Math.abs(t.year-c);r===0?n+=90:r<=1&&(n+=40)}return t.source==="library"?n+=60:t.source==="external-synced"&&(n+=25),n},w=e=>typeof e.imdbRating=="number"&&Number.isFinite(e.imdbRating)?e.imdbRating:typeof e.rtTomatoMeter=="number"&&Number.isFinite(e.rtTomatoMeter)?e.rtTomatoMeter/10:null,re=e=>{const{items:t,query:s,sortKey:o}=e,n=[...t];return o==="newest"?(n.sort((l,c)=>{const r=l.year??-1,d=c.year??-1;return d!==r?d-r:l.title.localeCompare(c.title)}),n):o==="rating"?(n.sort((l,c)=>{const r=w(l)??-1,d=w(c)??-1;if(d!==r)return d-r;const i=l.year??-1,u=c.year??-1;return u!==i?u-i:l.title.localeCompare(c.title)}),n):(n.sort((l,c)=>{const r=P(s,l),d=P(s,c);if(d!==r)return d-r;const i=w(l)??-1,u=w(c)??-1;if(u!==i)return u-i;const h=l.year??-1,b=c.year??-1;return b!==h?b-h:l.title.localeCompare(c.title)}),n)},J=["all","movie","series"],ae=e=>{const t=e.get("tab");return t==="people"?"people":t==="titles"?"titles":"all"},se=(e,t="")=>j(e.get("sort"))??V(t),k=e=>{if(typeof e!="number")return;const t=new Date().getFullYear();return Math.min(Math.max(e,1900),t)},ne=e=>{const t=e.get("type"),s=J.includes(t)?t:"all",o=()=>{const i=[],u=e.get("genre");u&&i.push(u);const h=e.getAll("genres");h?.length&&i.push(...h);const b=i.flatMap(m=>m.split(",")).map(m=>Number(m.trim())).filter(m=>Number.isFinite(m)&&m>0).map(m=>Math.floor(m));if(!b.length)return;const p=new Set,_=[];for(const m of b)p.has(m)||(p.add(m),_.push(m));return _},n=i=>{if(!i)return;const u=Number(i);return Number.isFinite(u)?u:void 0},l=k(n(e.get("minYear"))),c=k(n(e.get("maxYear"))),r=e.get("lang")||void 0,d=o();return l&&c&&l>c?{type:s,minYear:c,maxYear:l,originalLanguage:r,genreIds:d}:{type:s,minYear:l,maxYear:c,originalLanguage:r,genreIds:d}},X=e=>e?!!(e.type&&e.type!=="all"||typeof e.minYear=="number"||typeof e.maxYear=="number"||e.originalLanguage||e.genreIds?.length):!1,oe=e=>{const{query:t,filters:s}=e,o=t.trim(),n=X(s),{getNumber:l}=C(),c=l("ux.search.min_query_chars",2),r=l("ux.search.stale_time_ms",1e3*60*30),d=l("ux.search.gc_time_ms",1e3*60*60);return U({queryKey:["search","titles",{query:o,filters:s}],enabled:o.length>=Math.max(1,Math.floor(c))||n,placeholderData:Q,staleTime:Math.max(0,Math.floor(r)),gcTime:Math.max(0,Math.floor(d)),refetchOnWindowFocus:!1,initialPageParam:1,getNextPageParam:(i,u)=>i.hasMore?u.length+1:void 0,queryFn:({signal:i,pageParam:u})=>H({query:o,filters:s,page:u??1,signal:i})})};export{te as a,ne as b,se as c,V as d,k as e,X as h,ae as p,re as s,oe as u};
