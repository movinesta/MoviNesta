const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DyWq_Gt8.js","assets/index-4XrmDv29.css"])))=>i.map(i=>d[i]);
import{j as e,w as ge,u as fe,R as q,g as be,l as O,k as he,q as W,v as ye,L as Y,t as _e,o as ve,s as P,_ as je,f as Ne}from"./index-DyWq_Gt8.js";import{a as we,b as ke}from"./useDiaryLibrary-D8uhQUAT.js";import{d as Ie,a as Te}from"./diaryStatus-BH3whMXG.js";import{P as I}from"./PageChrome-BALDFVvC.js";import{C as z}from"./Chip-bJF3TJYc.js";import{T as K}from"./TopBar-Cwkp26YK.js";import"./useMutation-C5YwRx1y.js";const ne=({value:s,max:d=5,disabled:m,onChange:y,size:j="sm"})=>{const _=s??0,a=j==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-xs transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-sm transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:d}).map((G,R)=>{const l=R+1,p=_>=l;return e.jsx("button",{type:"button",onClick:()=>{if(!y||m)return;y(_===l?null:l)},disabled:m,className:`${a} ${p?"border-primary/80 bg-primary/90 text-primary-foreground":"border-border bg-card/60 text-muted-foreground hover:border-primary/70 hover:text-primary/90"}`,"aria-label":`Rate ${l} star${l===1?"":"s"}`,children:"★"},l)})})},Se=({imdb_rating:s,rt_tomato_pct:d,metascore:m})=>{if(!(typeof s=="number"&&s>0||typeof d=="number"&&d>0||typeof m=="number"&&m>0))return null;const j=typeof s=="number"&&!Number.isNaN(s)&&s>0,_=typeof d=="number"&&!Number.isNaN(d)&&d>0,a=typeof m=="number"&&!Number.isNaN(m)&&m>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-muted-foreground",children:[j&&e.jsxs(z,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"IMDb"}),e.jsx("span",{children:s.toFixed(1)})]}),_&&e.jsxs(z,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"Tomatometer"}),e.jsxs("span",{children:[d,"%"]})]}),a&&e.jsxs(z,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"MC"}),e.jsx("span",{children:m})]})]})},Pe=`
  id,
  kind,
  tmdb_title,
  tmdb_name,
  tmdb_original_title,
  tmdb_original_name,
  tmdb_release_date,
  tmdb_first_air_date,
  tmdb_runtime,
  tmdb_overview,
  tmdb_tagline,
  tmdb_backdrop_path,
  tmdb_poster_path,
  tmdb_original_language,
  tmdb_origin_country,
  tmdb_genres,
  omdb_title,
  omdb_plot,
  omdb_director,
  omdb_actors,
  omdb_language,
  omdb_country,
  omdb_imdb_rating,
  omdb_imdb_votes,
  omdb_metascore,
  omdb_rating_rotten_tomatoes,
  omdb_year,
  omdb_poster,
  omdb_rated,
  omdb_genre
`,Re=s=>{if(!s)return null;const d=String(s).match(/(\d{1,3})/);if(!d)return null;const m=Number(d[1]);return Number.isFinite(m)?m:null},V=s=>{if(s==null)return null;const d=typeof s=="number"?s:Number(s);return Number.isFinite(d)?d:null},Ue=()=>{const{titleId:s}=ge(),d=fe(),[m,y]=q.useState(null),j=q.useMemo(()=>be(),[]),_=async t=>{if(!l?.id){alert("You need to be signed in to start a conversation.");return}if(l.id!==t){y(t);try{const r=await ve("create-direct-conversation",{targetUserId:t},{timeoutMs:25e3});if(!r?.ok||!r.conversationId){const o=r?.code;let c=r?.error??"Failed to get conversation id. Please try again.";o==="UNAUTHORIZED"?c="You need to be signed in to start a conversation.":o==="BAD_REQUEST_SELF_TARGET"?c="You can't start a conversation with yourself.":o==="SERVER_MISCONFIGURED"&&(c="Messaging is temporarily unavailable due to a server issue. Please try again later.");const u=new Error(c);throw u.code=o,u}d(`/messages/${r.conversationId}`)}catch(r){console.error("[TitleDetailPage] Failed to start conversation",r);const o=r instanceof Error?r.message:"Something went wrong while starting the conversation. Please try again.";alert(o)}finally{y(null)}}},{data:a,isLoading:G,isError:R}=O({queryKey:W.titleDetail(s),enabled:!!s,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!s)return null;const{data:t,error:r}=await P.from("media_items").select(Pe).eq("id",s).maybeSingle();if(t)return t;let o=null,c="movie";if(s.startsWith("tmdb-")?(o=Number(s.replace("tmdb-","")),c="movie"):s.startsWith("tv-")?(o=Number(s.replace("tv-","")),c="tv"):isNaN(Number(s))||(o=Number(s)),!o){if(r)throw r;return null}try{const u=await je(()=>import("./index-DyWq_Gt8.js").then(x=>x.ad),__vite__mapDeps([0,1])).then(x=>x.fetchTmdbJson(`/${c}/${o}`,{append_to_response:"credits,videos,external_ids"}));if(!u)return null;const n=u;return{id:s,kind:c==="tv"?"series":"movie",tmdb_id:o,tmdb_title:n.title??n.name,tmdb_original_title:n.original_title??n.original_name,tmdb_overview:n.overview,tmdb_poster_path:n.poster_path,tmdb_backdrop_path:n.backdrop_path,tmdb_release_date:n.release_date??n.first_air_date,tmdb_first_air_date:n.first_air_date,tmdb_vote_average:n.vote_average,tmdb_vote_count:n.vote_count,tmdb_popularity:n.popularity,tmdb_genres:n.genres,tmdb_runtime:n.runtime??(n.episode_run_time?.[0]||null),tmdb_tagline:n.tagline,tmdb_origin_country:n.origin_country,tmdb_original_language:n.original_language,omdb_imdb_id:n.external_ids?.imdb_id??null,omdb_imdb_rating:null,omdb_metascore:null,omdb_rated:null,omdb_rating_rotten_tomatoes:null,omdb_year:(n.release_date??n.first_air_date)?.substring(0,4)??null,omdb_plot:null,omdb_director:n.credits?.crew?.find(x=>x.job==="Director")?.name??null,omdb_actors:n.credits?.cast?.slice(0,4).map(x=>x.name).join(", ")??null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}catch(u){if(console.error("Failed to fetch TMDB fallback",u),r)throw r;return null}}}),{user:l}=he(),{updateStatus:p,updateRating:N}=we(),{data:ie}=ke(s),g=ie??{status:null,rating:null},{data:C,isLoading:le}=O({queryKey:W.friendsTitleReactions(l?.id??null,s),enabled:!!(l?.id&&s),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!l?.id||!s)return[];const t=l.id,{data:r,error:o}=await P.from("follows").select("followed_id").eq("follower_id",t).limit(80);if(o)throw o;const c=(r??[]).map(i=>i.followed_id).filter(Boolean);if(!c.length)return[];const{data:u,error:n}=await P.from("ratings").select("user_id, rating, created_at").eq("title_id",s).in("user_id",c).order("rating",{ascending:!1}).limit(40);if(n)throw n;const U=(u??[]).map(i=>i.user_id);if(!U.length)return[];const{data:x,error:ae}=await P.from("profiles_public").select("id, display_name, username, avatar_url").in("id",U);if(ae)throw ae;const xe=new Map((x??[]).map(i=>[i.id,{displayName:i.display_name??null,username:i.username??null,avatarUrl:i.avatar_url??null}])),pe=(u??[]).map(i=>{const h=i.user_id,B=xe.get(h);return{userId:h,displayName:B?.displayName??null,username:B?.username??null,avatarUrl:B?.avatarUrl??null,rating:i.rating??null,createdAt:i.created_at??null}}),$=new Map;for(const i of pe){const h=$.get(i.userId);(!h||(i.rating??0)>(h.rating??0))&&$.set(i.userId,i)}return Array.from($.values()).sort((i,h)=>(h.rating??0)-(i.rating??0))}}),{data:oe,isLoading:Q}=O({queryKey:W.moreLikeThis(s),enabled:!!s,staleTime:1e3*60*10,gcTime:1e3*60*60,queryFn:async()=>{if(!s)return[];try{const{cards:t}=await Ne({sessionId:j,mode:"combined",limit:18,seed:s},{timeoutMs:2e4});return(t??[]).map(r=>({id:String(r.mediaItemId),title:(r.title??"Untitled").trim()||"Untitled",year:r.releaseYear??null,tmdbPosterPath:r.tmdbPosterPath??null,posterUrl:r.posterUrl??null,source:null})).filter(r=>!!(r.id&&r.title))}catch(t){return console.warn("[TitleDetailPage] more-like-this failed",t),[]}}}),v=a?ye(a):null,E=v?.title??"Untitled",H=v?.year??null,f=v?.type??null,T=v?.posterUrl??null,S=v?.backdropUrl??null,w=V(a?.tmdb_runtime),J=a?.tmdb_genres,M=Array.isArray(J)?J.map(t=>{if(!t||typeof t!="object")return null;const r=t.name;return typeof r=="string"&&r.trim()?r.trim():null}).filter(t=>!!t):typeof a?.omdb_genre=="string"?a.omdb_genre.split(",").map(t=>t.trim()).filter(Boolean):[],Z=v?.originalLanguage??null,X=Array.isArray(a?.tmdb_origin_country)&&a.tmdb_origin_country.length?a.tmdb_origin_country[0]:a?.omdb_country??null,k=a?.omdb_plot??a?.tmdb_overview??null,L=a?.tmdb_tagline??null,de=V(a?.omdb_imdb_rating),me=V(a?.omdb_metascore),ce=Re(a?.omdb_rating_rotten_tomatoes);if(q.useEffect(()=>{const t=[T,S].filter(r=>!!r);t.length!==0&&t.forEach(r=>{const o=new Image;o.src=r})},[T,S]),!s)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(K,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(I,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(G)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(K,{title:"Loading title"}),e.jsx(I,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-card/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-card/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-card/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-card/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-card/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-card/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-card/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-card/40"})]})]})]})})]});if(R||!a)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(K,{title:"Title not found"}),e.jsxs(I,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"We couldn't find that title."}),e.jsx(Y,{to:"/search",className:"mt-3 inline-block text-sm text-primary underline",children:"Back to search"})]})]});const ee=typeof w=="number"&&w>0?`${Math.floor(w/60)}h ${w%60?`${w%60}m`:""}`.trim():null,D=f==="movie"?"Movie":f==="series"?"TV Series":f==="anime"?"Anime":a?.kind??null,te=oe??[],b=[];H&&b.push(String(H)),D&&b.push(D),ee&&b.push(ee),X&&b.push(X),Z&&b.push(Z);const re=()=>l?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),A=t=>{if(!(!re()||p.isPending)){if(!f){alert("We couldn't determine the content type for this title yet.");return}p.mutate({titleId:a.id,status:t,type:f})}},se=t=>{if(!(!re()||N.isPending)){if(!f){alert("We couldn't determine the content type for this title yet.");return}N.mutate({titleId:a.id,rating:t,type:f})}},ue=b.length>0?b.join(" · "):"Title details",F=t=>g?.status===t;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-border bg-card/80 shadow-md",children:[e.jsxs("div",{className:"absolute inset-0",children:[S?e.jsx("img",{src:S,alt:E,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-background via-background/70 to-card"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-background via-background/80 to-background/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:T?e.jsx("img",{src:T,alt:E,className:"aspect-[2/3] w-full rounded-2xl object-cover shadow-lg",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-2xl border border-dashed border-border bg-background/70 text-xs text-muted-foreground",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.12em] text-muted-foreground",children:D??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground sm:text-3xl",children:E}),e.jsx("p",{className:"text-[12.5px] text-muted-foreground",children:ue})]}),k&&e.jsx("p",{className:"max-w-3xl text-sm leading-relaxed text-muted-foreground sm:text-[14px]",children:k}),e.jsx(Se,{imdb_rating:de,rt_tomato_pct:ce,metascore:me}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>A("want_to_watch"),disabled:p.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("want_to_watch")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>A("watching"),disabled:p.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("watching")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>A("watched"),disabled:p.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${F("watched")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-muted-foreground",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Your rating"}),e.jsx(ne,{value:g?.rating??null,disabled:N.isPending,onChange:se}),g?.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[g.rating,"/10"]})]}),!l&&e.jsxs("p",{className:"text-[11.5px] text-muted-foreground",children:[e.jsx(Y,{to:"/auth",className:"font-medium text-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsxs(I,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"More like this"}),Q&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loading…"})]}),Q?e.jsx("div",{className:"mt-3 flex gap-2 overflow-x-auto pb-1",children:Array.from({length:6}).map((t,r)=>e.jsx("div",{className:"h-40 w-28 flex-shrink-0 animate-pulse rounded-xl border border-border bg-card/70"},r))}):te.length>0?e.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2",children:te.map(t=>{const r=t.posterUrl??(t.tmdbPosterPath?_e(t.tmdbPosterPath,"w342"):null);return e.jsxs("button",{type:"button",onClick:()=>d(`/title/${t.id}`),className:"flex w-28 flex-shrink-0 flex-col gap-1 text-left",children:[e.jsx("div",{className:"aspect-[2/3] w-28 overflow-hidden rounded-xl border border-border bg-card/80",children:r?e.jsx("img",{src:r,alt:t.title,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] text-muted-foreground",children:"No poster"})}),e.jsx("span",{className:"line-clamp-2 text-[12px] text-foreground",children:t.title}),t.year&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:t.year})]},t.id)})}):e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"No similar titles yet."})]}),e.jsx(I,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-background/80 px-3 py-3 text-[12px] text-muted-foreground",children:[L&&e.jsx("p",{className:"text-sm font-medium text-foreground",children:L}),k&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-muted-foreground",children:k}),!L&&!k&&e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"We don't have a plot summary for this title yet."}),M&&M.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:M.slice(0,6).map(t=>e.jsx("span",{className:"rounded-full border border-border px-2 py-[2px] text-xs text-muted-foreground",children:t},t))}),(a.omdb_director||a.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-muted-foreground",children:[a.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Director:"})," ",a.omdb_director]}),a.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Cast:"})," ",a.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),l&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs",children:[e.jsx("span",{className:Te(g?.status),children:Ie(g?.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Rating"}),e.jsx(ne,{value:g?.rating??null,disabled:N.isPending,onChange:se})]})]})]}),!l&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to see your diary status and ratings for this title."})]}),l&&!le&&C&&C.length>0&&e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:C.slice(0,4).map(t=>{const r=t.displayName??(t.username?`@${t.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-card text-xs font-semibold text-foreground",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:r??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(r??"?")[0]?.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-foreground",children:r}),t.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Rated ",t.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(Y,{to:t.username?`/u/${t.username}`:`/u/${t.userId}`,className:"text-xs font-medium text-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>_(t.userId),disabled:m===t.userId,className:"text-xs font-medium text-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:m===t.userId?"Starting…":"Message"})]})]},t.userId)})})]})]})})})]})};export{Ue as default};
