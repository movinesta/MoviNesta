import{d as ee,r as a,i as te,k as ne,l as re,m as se,h as _,t as q,q as O,n as ie,j as i,B as ae}from"./index-yaS868vE.js";import{u as oe}from"./useMutation-WGdhQwN_.js";const A="movi_swipe_event_queue_v1";function le(t){if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e.filter(Boolean):[]}catch{return[]}}function T(){return le(typeof localStorage<"u"?localStorage.getItem(A):null)}function ce(t){if(typeof localStorage>"u")return;const e=T();e.push({...t,queuedAt:Date.now()});const n=e.slice(-200);localStorage.setItem(A,JSON.stringify(n))}function ue(t){if(typeof localStorage>"u"||!t.length)return;const e=new Set(t),n=T().filter(l=>!l.clientEventId||!e.has(l.clientEventId));localStorage.setItem(A,JSON.stringify(n))}function de(t){return"combined"}function fe(t){if(!t)return null;const e=t.replace("-","_");return e==="for_you"?"for-you":e==="friends"?"from-friends":e==="trending"?"trending":e==="popular"?"popular":e==="explore"?"explore":e==="combined"?"combined":null}function L(t){return t==="like"?"like":t==="dislike"?"dislike":"skip"}function I(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():ie()}function me(t){const e=typeof t.posterUrl=="string"?t.posterUrl.trim():"",n=(e&&e.toLowerCase()!=="n/a"?e:"")||(t.tmdbPosterPath?q(t.tmdbPosterPath,"w500")??"":"")||(t.tmdbBackdropPath?q(t.tmdbBackdropPath,"w780")??"":"");if(!n)return null;const l=(t.title??"").trim()||"Untitled";return{...t,posterUrl:n,title:l}}function ge(t,e){if(typeof window>"u"||e<=0||navigator.connection?.saveData)return;const b=window.requestIdleCallback??(g=>window.setTimeout(g,300)),x=t.slice(0,e);b(()=>{for(const g of x){if(!g.posterUrl)continue;const h=new Image;h.decoding="async",h.loading="lazy",h.src=g.posterUrl}})}function we(t,e){const n=e?.limit??60,l=e?.prefetchImages??6,b=e?.dwellThresholdMs??1200,x=e?.dwellDebounceMs??8e3,g=e?.invalidateHomeQueries??!1,h=ee();a.useEffect(()=>{let r=!1;const s=async()=>{if(r)return;const u=T();if(!u.length)return;const d=[];for(const p of u)try{(await _(p)).ok&&p.clientEventId&&d.push(p.clientEventId)}catch{break}d.length&&ue(d)};s();const o=()=>void s();return window.addEventListener("online",o),()=>{r=!0,window.removeEventListener("online",o)}},[]);const c=a.useMemo(()=>te(),[]),y=a.useMemo(()=>de(),[t]),R=a.useRef(new Set),v=a.useRef(!1),N=a.useRef(0),P=a.useRef(null),E=a.useRef(new Set),j=a.useRef(new Map),[w,J]=a.useState({status:"idle",cards:[],errorMessage:null}),[C,D]=a.useState(null),m=a.useCallback(r=>{J(s=>typeof r=="function"?r(s):r)},[]),U=a.useCallback(r=>{if(!r.length)return 0;const s=R.current,o=[];for(const u of r){if(s.has(u.id))continue;const d=me(u);s.add(u.id),d&&o.push(d)}return o.length?(m(u=>{const d={...u,status:"ready",cards:[...u.cards,...o],errorMessage:null};return ge(o,l),d}),o.length):0},[l,m]),S=a.useCallback(async(r=n)=>{if(!v.current){v.current=!0,m(s=>({...s,status:s.cards.length?"ready":"loading",errorMessage:null}));try{const s=e?.kindFilter??null,o=e?.seed??ne(c,y,s);P.current!==o&&(P.current=o,N.current=0);const u=3;let d=0,p=0;for(;d<u&&p===0;){const M=`${o}:${N.current}`;N.current+=1;const $=await re({sessionId:c,mode:y,kindFilter:s??void 0,limit:r,seed:M,minImdbRating:e?.minImdbRating??null,genresAny:e?.genresAny??null},{timeoutMs:25e3}),V=$.deckId,B=($.cards??[]).map((k,Z)=>({...k,id:k.mediaItemId,deckId:V,position:Z,source:fe(k.source??t)}));if(!B.length){m(k=>({...k,status:k.cards.length?"ready":"exhausted",errorMessage:null}));return}if(p=U(B),p>0)break;d+=1,console.warn("[useMediaSwipeDeck] filtered out all cards (missing OMDb poster?). Retrying...",{attempt:d,mode:y,kind:t,batchSize:r})}p===0&&m(M=>({...M,status:M.cards.length?"ready":"exhausted",errorMessage:null}))}catch(s){const o=s instanceof Error?s.message:typeof s=="string"?s:"We couldn't load swipe cards.";m(u=>({...u,status:"error",errorMessage:o}))}finally{v.current=!1}}},[U,n,y,e?.kindFilter,e?.minImdbRating,JSON.stringify(e?.genresAny??[]),e?.seed,c,m]);a.useEffect(()=>{R.current=new Set,E.current=new Set,j.current=new Map,v.current=!1,m({status:"loading",cards:[],errorMessage:null}),S(n)},[S,t,n,e?.kindFilter,e?.minImdbRating,JSON.stringify(e?.genresAny??[]),m]);const K=a.useCallback(()=>{e?.seed==null&&se(c,y,e?.kindFilter??null),N.current=0,R.current=new Set,E.current=new Set,j.current=new Map,v.current=!1,m({status:"loading",cards:[],errorMessage:null}),S(n)},[S,n,y,e?.kindFilter,e?.minImdbRating,JSON.stringify(e?.genresAny??[]),e?.seed,c,m]),Q=a.useCallback(r=>{r<=0||m(s=>({...s,cards:s.cards.slice(Math.min(r,s.cards.length))}))},[m]),f=oe({mutationFn:async r=>_(r,{timeoutMs:2e4}),onError:(r,s)=>{const o=r instanceof Error?r.message:typeof r=="string"?r:"We couldn't save that action.";ce(s),D({payload:s,message:o})},onSuccess:()=>{D(null),g&&(h.invalidateQueries({queryKey:O.homeFeed(null)}),h.invalidateQueries({queryKey:O.homeForYou(null)}))}}),W=a.useCallback((r,s)=>{if(!r)return;const o=`${r.deckId}:${r.id}`;E.current.has(o)||(E.current.add(o),f.mutate({sessionId:c,deckId:r.deckId,position:s??r.position,mediaItemId:r.id,eventType:"impression",source:r.source??null,clientEventId:I()}))},[f,c]),z=a.useCallback((r,s,o)=>{if(!r||!Number.isFinite(s)||s<b)return;const u=`${r.deckId}:${r.id}`,d=Date.now(),p=j.current.get(u)??0;d-p<x||(j.current.set(u,d),f.mutate({sessionId:c,deckId:r.deckId,position:o??r.position,mediaItemId:r.id,eventType:"dwell",dwellMs:Math.round(s),source:r.source??null,clientEventId:I()}))},[x,b,f,c]),H=a.useCallback(r=>{const s=r.card;f.mutate({sessionId:c,deckId:s.deckId,position:s.position,mediaItemId:s.id,eventType:L(r.direction),source:s.source??null,clientEventId:I()})},[f,c]),Y=a.useCallback(async r=>{const s=r.card;return f.mutateAsync({sessionId:c,deckId:s.deckId,position:s.position,mediaItemId:s.id,eventType:L(r.direction),source:s.source??null,clientEventId:I()})},[f,c]),G=a.useCallback(r=>{const s={...r,sessionId:r.sessionId??c,clientEventId:r.clientEventId??I()};f.mutate(s)},[f,c]),X=a.useCallback(async r=>{const s={...r,sessionId:r.sessionId??c,clientEventId:r.clientEventId??I()};try{await f.mutateAsync(s)}catch{}},[f,c]);return{sessionId:c,mode:y,cards:w.cards,status:w.status,isLoading:w.status==="loading",isError:w.status==="error",isExhausted:w.status==="exhausted",deckError:w.errorMessage??null,fetchMore:S,refresh:K,trimConsumed:Q,trackImpression:W,trackDwell:z,sendEvent:G,sendEventAsync:X,swipe:H,swipeAsync:Y,swipeSyncError:C?.message??null,retryFailedSwipe:()=>{C&&f.mutate(C.payload)},isRetryingSwipe:f.isPending&&!!C}}function F({name:t,className:e,filled:n,ariaLabel:l}){return i.jsx("span",{className:["material-symbols-rounded",n?"is-filled":"",e??""].filter(Boolean).join(" "),"aria-hidden":l?void 0:!0,"aria-label":l,children:t})}const ke=(t,e,n)=>Math.min(n,Math.max(e,t)),he=t=>{if(!t)return null;const e=t.trim();return!e||e.toUpperCase()==="N/A"?null:e},Ie=t=>{if(!t||t<=0)return null;const e=Math.floor(t/60),n=t%60;return e===0?`${n}m`:n===0?`${e}h`:`${e}h ${n}m`},ve=t=>{const e=he(t);if(!e)return null;const n=e.toLowerCase();return n==="united states"||n==="united states of america"?"US":n==="united kingdom"||n==="great britain"?"UK":n==="canada"?"CA":n==="australia"?"AU":n==="germany"?"DE":n==="france"?"FR":n==="spain"?"ES":n==="italy"?"IT":n==="japan"?"JP":n==="south korea"||n==="republic of korea"?"KR":e.length<=3?e.toUpperCase():e},pe=t=>{if(t==null)return null;if(typeof t=="number")return Number.isNaN(t)?null:t;const e=parseFloat(t);return Number.isNaN(e)?null:e},Se=t=>{const e=pe(t);return e==null?null:Math.round(e).toLocaleString()},Me=t=>{switch(t){case"from-friends":return"Friends’ picks";case"trending":return"Trending now";case"popular":return"Popular";default:return"Matched for you"}},Ne=t=>{if(!t)return;const e=[];t.year&&e.push(String(t.year));const n=[];typeof t.imdbRating=="number"&&!Number.isNaN(t.imdbRating)&&n.push(`IMDb ${t.imdbRating.toFixed(1)}`),typeof t.rtTomatoMeter=="number"&&!Number.isNaN(t.rtTomatoMeter)&&n.push(`${t.rtTomatoMeter}% Rotten Tomatoes`);const l=[...e,...n].filter(Boolean).join(" · ");return l?`${t.title} (${l})`:t.title},Ee=({message:t,onRetry:e,isRetrying:n})=>t?i.jsx("div",{className:"mx-3 mb-3 rounded-md border border-amber-500/60 bg-amber-500/10 px-3 py-2 text-xs text-amber-50",children:i.jsxs("div",{className:"flex items-start gap-2",children:[i.jsx(F,{name:"error",className:"mt-0.5 text-[18px]",ariaLabel:"Error"}),i.jsxs("div",{className:"flex flex-1 flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[i.jsx("p",{className:"leading-snug",children:t}),i.jsxs(ae,{type:"button",variant:"outline",size:"sm",onClick:e,disabled:n,children:[i.jsx(F,{name:"refresh",className:"text-[18px]",ariaLabel:"Retry"}),n?"Retrying…":"Retry"]})]})]})}):null,je=({card:t,metaLine:e,highlightLabel:n})=>i.jsxs("div",{className:"space-y-2 text-left leading-relaxed","aria-label":"Swipe card summary",children:[i.jsx("div",{className:"flex items-start justify-between gap-3",children:i.jsxs("div",{className:"min-w-0 space-y-1",children:[i.jsx("h2",{className:"line-clamp-2 text-2xl font-heading font-semibold text-foreground",children:t.title}),e&&i.jsx("p",{className:"truncate text-xs text-muted-foreground/90",children:e}),n&&i.jsx("p",{className:"text-xs font-medium text-primary/90",children:n})]})}),t.tagline&&!t.tagline.trim().startsWith("Plot")&&i.jsx("p",{className:"line-clamp-2 text-xs text-muted-foreground/90",children:t.tagline})]}),Ce=({title:t})=>i.jsx("div",{className:"flex h-full w-full items-center justify-center bg-gradient-to-br from-background via-card to-background text-center",children:i.jsxs("div",{className:"flex flex-col items-center gap-2 text-muted-foreground",children:[i.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-2xl bg-card/70 shadow-md",children:i.jsx(F,{name:"image_not_supported",className:"text-[24px] text-muted-foreground"})}),i.jsx("span",{className:"text-[12px] font-semibold",children:"Artwork unavailable"}),t&&i.jsxs("span",{className:"max-w-[240px] truncate text-xs text-muted-foreground/80",children:["for ",t]})]})});function xe(t){const e=t.trim().split(/\s+/).filter(Boolean);if(!e.length)return"?";const n=e[0]?.[0]??"?",l=e.length>1?e[e.length-1]?.[0]??"":"";return(n+l).toUpperCase()}function Re({profiles:t,max:e=3,size:n=28}){const l=Array.isArray(t)?t.filter(Boolean):[];if(!l.length)return null;const b=l.slice(0,Math.max(1,e)),x=l.length-b.length;return i.jsx("div",{className:"relative flex items-center",children:i.jsxs("div",{className:"flex -space-x-2",children:[b.map(g=>{const h=(g.display_name??g.username??"").trim(),c=xe(h||"friend");return i.jsx("div",{className:"grid place-items-center overflow-hidden rounded-full border border-background bg-muted text-[11px] font-semibold text-foreground shadow-sm",style:{width:n,height:n},title:h||"Friend","aria-label":h||"Friend",children:g.avatar_url?i.jsx("img",{src:g.avatar_url,alt:h||"Friend avatar",className:"h-full w-full object-cover",loading:"lazy",referrerPolicy:"no-referrer"}):i.jsx("span",{children:c})},g.id)}),x>0&&i.jsxs("div",{className:"grid place-items-center rounded-full border border-background bg-muted text-[11px] font-semibold text-foreground shadow-sm",style:{width:n,height:n},title:`${x} more`,"aria-label":`${x} more`,children:["+",x]})]})})}export{je as C,Re as F,F as M,Ce as P,Ee as S,he as a,ve as b,ke as c,Ne as d,Se as e,Ie as f,Me as g,pe as s,we as u};
