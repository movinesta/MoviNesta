import{u as ne,G as le,e as oe,b as ce,R as N,c as $,h as R,w as C,t as A,j as e,B as de,L as ee,C as me,q as _,s as v,E as ue}from"./index-CuXsBKB-.js";import{u as te}from"./useMutation-BhCO-uzT.js";import{S as y,R as ae}from"./skeleton-nLAVhuWP.js";import{M as p}from"./material-icon-sbzzvxfS.js";import{b as xe,u as he}from"./useDiaryLibrary-BD8Z1ct7.js";function fe(t){try{return Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1}).format(t)}catch{return String(t)}}function pe(t){if(!t||t<=0)return null;const n=Math.floor(t/60),i=t%60;return n<=0?`${i}m`:i<=0?`${n}h`:`${n}h ${i}m`}function be(t){const n=t.tmdb_release_date??t.tmdb_first_air_date;if(n){const i=String(n),r=Number(i.slice(0,4));if(!Number.isNaN(r))return r}if(t.omdb_year){const i=Number(String(t.omdb_year).slice(0,4));if(!Number.isNaN(i))return i}return null}function ge(t){return[t.tmdb_title,t.tmdb_name,t.omdb_title].map(r=>typeof r=="string"?r.trim():"").find(r=>!!r)||"Untitled"}function ye(t){return t.tmdb_overview??t.omdb_plot??null}function we(t){return t.kind==="movie"?"movie":t.kind==="series"?"series":t.kind==="anime"?"anime":t.kind==="episode"?"episode":"other"}function _e(t,n){const i=[];if(Array.isArray(t))for(const r of t){const l=r?.name;typeof l=="string"&&l.trim()&&i.push(l.trim())}if(!i.length&&n)for(const r of String(n).split(",").map(l=>l.trim()).filter(Boolean))i.push(r);return Array.from(new Set(i))}function ve(t){const n=t?.videos?.results;if(!Array.isArray(n))return null;const i=n,r=u=>i.find(m=>u(m)&&m.site==="YouTube"&&typeof m.key=="string"),l=r(u=>u.type==="Trailer")||r(u=>u.type==="Teaser")||r(()=>!0);return l?.key?`https://www.youtube.com/watch?v=${encodeURIComponent(l.key)}`:null}function je(t){const n=t?.credits?.cast;return Array.isArray(n)?n.filter(i=>i&&typeof i=="object").slice(0,24).map(i=>({id:i.id,name:i.name,character:i.character,profile_path:i.profile_path})):[]}function Ne(t){const n=t.trim().split(/\s+/g);return n.length<=1?t:`${n[0]} ${n[1].slice(0,1)}.`}function ke(t){const n=new Date(t),i=Date.now(),r=Math.max(0,i-n.getTime()),l=Math.floor(r/6e4);if(l<1)return"Just now";if(l<60)return`${l}m ago`;const u=Math.floor(l/60);if(u<24)return`${u}h ago`;const m=Math.floor(u/24);if(m<7)return`${m}d ago`;const s=Math.floor(m/7);if(s<5)return`${s}w ago`;const b=Math.floor(m/30);return b<12?`${b}mo ago`:`${Math.floor(m/365)}y ago`}function Se({review:t,profile:n}){const[i,r]=N.useState(!1),l=(n?.display_name??n?.username??"?").split(/\s+/g).slice(0,2).map(b=>b.slice(0,1).toUpperCase()).join("").slice(0,2),u=t.rating==null?null:ue(t.rating),s=!!!t.spoiler||i;return e.jsxs("div",{className:"rounded-2xl bg-[#302839] p-4 transition-colors hover:bg-[#382f42]",children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[n?.avatar_url?e.jsx("img",{src:n.avatar_url,alt:n.display_name??n.username??"User",className:"size-10 rounded-full object-cover"}):e.jsx("div",{className:"flex size-10 items-center justify-center rounded-full bg-primary/20 font-bold text-primary",children:l}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold text-white",children:n?.display_name??n?.username??"User"}),e.jsx("p",{className:"text-xs text-white/40",children:ke(t.created_at)})]})]}),u!=null?e.jsxs("div",{className:"flex items-center gap-1 rounded-lg bg-[#211a29] px-2 py-1",children:[e.jsx(p,{name:"star",className:"text-sm text-yellow-500",filled:!0}),e.jsx("span",{className:"text-xs font-bold text-white",children:u.toFixed(1)})]}):null]}),t.headline?e.jsx("p",{className:"mb-2 text-sm font-semibold text-white",children:t.headline}):null,t.body?s?e.jsx("p",{className:"text-sm leading-relaxed text-white/75",children:t.body}):e.jsxs("div",{className:"rounded-xl border border-white/10 bg-[#211a29] p-3 text-sm text-white/80",children:[e.jsx("p",{children:"Spoiler warning"}),e.jsxs("button",{type:"button",className:"mt-2 inline-flex items-center gap-2 text-sm font-semibold text-primary",onClick:()=>r(!0),"aria-expanded":i,children:["View spoiler",e.jsx(p,{name:"chevron_right",className:"text-base"})]})]}):null]})}function se(){return e.jsx("div",{className:"-mx-4 h-px bg-white/5"})}function B({children:t,label:n,onClick:i,isActive:r,disabled:l}){return e.jsx("button",{type:"button","aria-label":n,disabled:l,onClick:i,className:"flex size-11 items-center justify-center rounded-full border border-white/10 bg-white/10 text-white backdrop-blur-md transition "+(l?"opacity-60":"hover:bg-white/20 active:scale-[0.98]")+(r?" ring-2 ring-primary/70":""),children:t})}function Re(){const t=ne(),n=le(),i=oe(),{user:r}=ce(),l=String(n.titleId??""),[u,m]=N.useState(null);N.useEffect(()=>{let a=!1;return(async()=>{if(!l){m(null);return}if(/^[0-9a-fA-F-]{36}$/.test(l)){m(l);return}if(!l.startsWith("tmdb-")&&!l.startsWith("tv-")){m(null);return}const o=Number(l.replace(/^tmdb-/,"").replace(/^tv-/,"")),g=l.startsWith("tv-")?"series":"movie",x=(await me("catalog-sync",{kind:g,tmdbId:o}))?.data?.id??null;a||(m(x),x&&t(`/title/${x}`,{replace:!0}))})(),()=>{a=!0}},[t,l]);const s=u??(l&&/^[0-9a-fA-F-]{36}$/.test(l)?l:null),b=$({queryKey:_.titleDetail(s),enabled:!!s,staleTime:1e3*60,queryFn:async()=>{if(!s)return null;const{data:a,error:c}=await v.from("media_items").select(["id","kind","tmdb_title","tmdb_name","tmdb_release_date","tmdb_first_air_date","tmdb_runtime","tmdb_poster_path","tmdb_backdrop_path","tmdb_genres","tmdb_tagline","tmdb_overview","tmdb_raw","omdb_title","omdb_year","omdb_rated","omdb_runtime","omdb_plot","omdb_genre"].join(",")).eq("id",s).maybeSingle();if(c&&c.code!=="PGRST116")throw c;return a??null}}),h=$({queryKey:["title","rating-summary",s],enabled:!!s,staleTime:1e3*60,queryFn:async()=>{if(!s)return null;const{data:a,error:c}=await v.rpc("get_title_rating_summary_v1",{p_title_id:s});if(c)return console.warn("[TitleDetailPageV2] rating summary RPC error",c.message),null;const o=Array.isArray(a)?a[0]:a;return o?{title_id:String(o.title_id??s),reviews_count:Number(o.reviews_count??0),ratings_count:Number(o.ratings_count??0),average_rating_0_10:o.average_rating_0_10==null?null:Number(o.average_rating_0_10),average_rating_0_5:o.average_rating_0_5==null?null:Number(o.average_rating_0_5),stars_5:Number(o.stars_5??0),stars_4:Number(o.stars_4??0),stars_3:Number(o.stars_3??0),stars_2:Number(o.stars_2??0),stars_1:Number(o.stars_1??0)}:null}}),j=$({queryKey:["title","reviews-preview",s],enabled:!!s,staleTime:1e3*30,queryFn:async()=>{if(!s)return{reviews:[],profilesById:new Map};const{data:a,error:c}=await v.from("reviews").select("id,user_id,title_id,rating,headline,body,spoiler,created_at").eq("title_id",s).order("created_at",{ascending:!1}).limit(2);if(c)throw c;const o=a??[],g=Array.from(new Set(o.map(x=>x.user_id).filter(Boolean))),f=new Map;if(g.length){const{data:x,error:X}=await v.from("profiles_public").select("id,username,display_name,avatar_url").in("id",g);if(X)console.warn("[TitleDetailPageV2] profile lookup failed",X.message);else for(const Z of x??[])f.set(Z.id,Z)}return{reviews:o,profilesById:f}}}),L=xe(s),ie=he(),k=L.data?.status??null,M=L.data?.rating??null,w=$({queryKey:["media_feedback",r?.id,s],enabled:!!(r?.id&&s),staleTime:1e3*15,queryFn:async()=>{if(!r?.id||!s)return null;const{data:a,error:c}=await v.from("media_feedback").select("last_action").eq("user_id",r.id).eq("media_item_id",s).maybeSingle();if(c&&c.code!=="PGRST116")throw c;return a??null}}).data?.last_action==="like",Q=te({mutationFn:async()=>{if(!s)return;if(!r?.id){alert("Sign in to like this title.");return}await i.cancelQueries({queryKey:["media_feedback",r?.id,s]}),i.setQueryData(["media_feedback",r?.id,s],c=>({...c??{},last_action:w?"skip":"like"}));const a=R();await C({sessionId:a,deckId:null,position:null,mediaItemId:s,eventType:w?"skip":"like",source:"title",payload:{action:w?"unlike":"like",origin:"title_detail"}})},onSettled:()=>{i.invalidateQueries({queryKey:["media_feedback",r?.id,s]})}}),D=te({mutationFn:async()=>{if(!r?.id||!s){r?.id||alert("Sign in to add this title to your watchlist.");return}const a=b.data;if(!a)return;const c=we(a),o=k!=="want_to_watch";i.setQueryData(_.titleDiary(r.id,s),x=>({...x??{},status:o?"want_to_watch":null}));const g=R(),f=[];f.push(C({sessionId:g,deckId:null,position:null,mediaItemId:s,eventType:"watchlist",inWatchlist:o,source:"title",payload:{action:o?"watchlist_add":"watchlist_remove",origin:"title_detail"}})),o?f.push(ie.updateStatus.mutateAsync({titleId:s,status:"want_to_watch",type:c})):f.push(Promise.resolve(v.from("library_entries").delete().eq("user_id",r.id).eq("title_id",s)).then(({error:x})=>{if(x)throw x})),await Promise.allSettled(f)},onSettled:()=>{r?.id&&(i.invalidateQueries({queryKey:_.titleDiary(r.id,s??void 0)}),i.invalidateQueries({queryKey:_.diaryLibrary(r.id)}),i.invalidateQueries({queryKey:_.diaryStats(r.id)}),i.invalidateQueries({queryKey:_.homeFeed(r.id)}))}}),re=async()=>{if(typeof window>"u")return;const a=window.location.href,c=K||"MoviNesta";try{navigator.share?await navigator.share({title:c,url:a}):navigator.clipboard&&await navigator.clipboard.writeText(a)}catch{}};N.useEffect(()=>{if(!s)return;const a=R();return C({sessionId:a,deckId:null,position:null,mediaItemId:s,eventType:"detail_open",source:"title",payload:{origin:"title_detail"}}).catch(()=>null),()=>{C({sessionId:a,deckId:null,position:null,mediaItemId:s,eventType:"detail_close",source:"title",payload:{origin:"title_detail"}}).catch(()=>null)}},[s]);const d=b.data,P=A(d?.tmdb_backdrop_path??null,"w1280")??null,z=A(d?.tmdb_poster_path??null,"w500")??null,F=d?be(d):null,S=d?pe(d.tmdb_runtime??null):null,I=d?.omdb_rated??null,K=d?ge(d):"",U=d?.tmdb_tagline??null,E=d?ye(d):null,V=d?_e(d.tmdb_genres,d.omdb_genre):[],W=ve(d?.tmdb_raw)??null,Y=je(d?.tmdb_raw),G=h.data?.average_rating_0_5??null,T=G==null?null:Math.max(0,Math.min(5,G)),O=h.data?.ratings_count??0,J=(T==null?null:T.toFixed(1))??"–",q=h.data?[{star:5,count:h.data.stars_5},{star:4,count:h.data.stars_4},{star:3,count:h.data.stars_3},{star:2,count:h.data.stars_2},{star:1,count:h.data.stars_1}]:null,H=q?q.reduce((a,c)=>a+c.count,0):0;return e.jsxs("div",{className:"relative flex min-h-[calc(100dvh-(5.5rem+env(safe-area-inset-bottom)))] flex-col overflow-hidden",children:[e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[-1rem] h-[65vh]",children:[e.jsx("div",{className:"h-full w-full bg-cover bg-center bg-no-repeat",style:{backgroundImage:P?`url(${P})`:z?`url(${z})`:void 0}}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/40 via-black/10 to-background"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/60 to-transparent"})]}),e.jsxs("div",{className:"fixed top-0 z-30 -mx-4 flex w-full items-center justify-between bg-gradient-to-b from-black/60 to-transparent px-4 pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)]",children:[e.jsx(B,{label:"Back",onClick:()=>t(-1),children:e.jsx(p,{name:"arrow_back"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{label:w?"Liked":"Like",isActive:w,disabled:!s||Q.isPending,onClick:()=>Q.mutate(),children:e.jsx(p,{name:"favorite",filled:w})}),e.jsx(B,{label:"More",onClick:()=>{},disabled:!0,children:e.jsx(p,{name:"more_vert"})})]})]}),e.jsxs("main",{className:"relative z-10 mt-[45vh] px-0 pb-20",children:[e.jsxs("div",{className:"flex flex-col items-center px-4 text-center",children:[e.jsxs("div",{className:"mb-4 relative group",children:[e.jsx("div",{className:"absolute -inset-1 rounded-full bg-primary blur opacity-40 transition duration-200 group-hover:opacity-60"}),e.jsx("div",{className:"relative flex size-16 items-center justify-center rounded-full border-2 border-primary bg-[#2a1f36]",children:h.isLoading?e.jsx(y,{className:"h-6 w-10 rounded"}):e.jsx("span",{className:"text-lg font-bold text-white",children:J})})]}),e.jsx("h1",{className:"mb-2 text-balance text-4xl font-bold leading-tight tracking-tight text-white",children:b.isLoading?e.jsx(y,{className:"h-10 w-64"}):K}),U?e.jsx("p",{className:"mb-3 text-sm text-white/75",children:U}):null,e.jsxs("div",{className:"mb-6 flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-sm font-medium text-white/70",children:[F!=null&&e.jsx("span",{children:F}),F!=null&&(S||I)&&e.jsx("span",{className:"size-1 rounded-full bg-white/30"}),S&&e.jsx("span",{children:S}),S&&I&&e.jsx("span",{className:"size-1 rounded-full bg-white/30"}),I&&e.jsx("span",{children:I})]}),V.length?e.jsx("div",{className:"mb-8 flex flex-wrap justify-center gap-2",children:V.slice(0,3).map(a=>e.jsx("div",{className:"flex h-8 items-center justify-center rounded-full border border-white/5 bg-white/10 px-4 backdrop-blur-sm",children:e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-white",children:a})},a))}):null,e.jsxs("div",{className:"w-full max-w-sm",children:[e.jsxs("div",{className:"flex gap-3",children:[W?e.jsxs("a",{href:W,target:"_blank",rel:"noreferrer",className:"flex h-14 flex-1 items-center justify-center gap-2 rounded-full bg-primary text-base font-bold text-white shadow-lg shadow-primary/25 transition-all hover:bg-primary/90 active:scale-[0.98]",children:[e.jsx(p,{name:"play_circle"}),"Play Trailer"]}):e.jsx(de,{variant:"secondary",className:"h-14 flex-1 rounded-full bg-white/10 text-white hover:bg-white/15",disabled:!0,children:"Trailer unavailable"}),e.jsx("button",{type:"button","aria-label":k==="want_to_watch"?"Remove from watchlist":"Add to watchlist",onClick:()=>D.mutate(),disabled:!s||!d||D.isPending,className:"flex size-14 items-center justify-center rounded-full bg-[#302839] text-white transition-all hover:bg-[#3d3349] active:scale-[0.98] "+(k==="want_to_watch"?" ring-2 ring-primary/70":""),children:e.jsx(p,{name:"bookmark_add",filled:k==="want_to_watch"})}),e.jsx("button",{type:"button","aria-label":"Share",onClick:re,className:"flex size-14 items-center justify-center rounded-full bg-[#302839] text-white transition-all hover:bg-[#3d3349] active:scale-[0.98]",children:e.jsx(p,{name:"ios_share"})})]}),M!=null?e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-2 text-xs text-white/70",children:[e.jsx("span",{children:"Your rating"}),e.jsx(ae,{rating:M,size:12}),e.jsxs("span",{className:"font-semibold text-white",children:[M.toFixed(1),"/5"]})]}):null]})]}),E?e.jsxs("section",{className:"px-4 pt-8",children:[e.jsx("h3",{className:"mb-3 px-1 text-lg font-bold text-white",children:"Storyline"}),e.jsx("p",{className:"px-1 text-base leading-relaxed text-white/75",children:E})]}):null,e.jsx("div",{className:"my-8",children:e.jsx(se,{})}),Y.length?e.jsxs("section",{className:"px-4",children:[e.jsxs("div",{className:"mb-4 flex items-end justify-between px-1",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Cast & Crew"}),e.jsx("button",{type:"button",className:"text-sm font-semibold text-primary",onClick:()=>{document.getElementById("mn-cast-scroll")?.scrollIntoView({behavior:"smooth",block:"nearest"})},children:"See all"})]}),e.jsx("div",{id:"mn-cast-scroll",className:"-mx-4 flex snap-x gap-4 overflow-x-auto px-4 pb-4 [scrollbar-width:none] [&::-webkit-scrollbar]:hidden",children:Y.slice(0,12).map((a,c)=>{const o=typeof a.name=="string"?a.name:"",g=typeof a.character=="string"?a.character:"",f=A(a.profile_path??null,"w185");return e.jsxs("div",{className:"flex shrink-0 snap-start flex-col items-center gap-2",children:[e.jsx("div",{className:"size-20 overflow-hidden rounded-full bg-white/10",children:f?e.jsx("img",{src:f,alt:o,className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-white/50",children:e.jsx(p,{name:"person"})})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-white",children:o?Ne(o):""}),e.jsx("p",{className:"text-[10px] text-white/45",children:g})]})]},`${a.id??c}`)})})]}):null,e.jsx("div",{className:"my-8",children:e.jsx(se,{})}),e.jsxs("section",{className:"-mx-4 mt-2 rounded-t-3xl bg-[#211a29] px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:"Ratings & Reviews"}),s?e.jsx(ee,{to:`/title/${s}/reviews`,className:"text-sm font-semibold text-primary",children:"See all"}):null]}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-6",children:[e.jsxs("div",{className:"flex flex-col justify-center gap-1",children:[e.jsx("p",{className:"text-5xl font-black leading-none tracking-tight text-white",children:J}),e.jsx("div",{className:"mt-1",children:T!=null?e.jsx(ae,{rating:T,size:14}):e.jsx("div",{className:"h-4 w-24"})}),e.jsx("p",{className:"mt-2 text-xs text-white/50",children:h.isLoading?"Loading…":O?`${fe(O)} verified ratings`:"No ratings yet"})]}),e.jsx("div",{className:"min-w-[220px] flex-1",children:q?e.jsx("div",{className:"grid grid-cols-[12px_1fr_38px] items-center gap-x-3 gap-y-2",children:q.map(a=>{const c=H?Math.round(a.count/H*100):0;return e.jsxs(N.Fragment,{children:[e.jsx("p",{className:"text-xs font-medium text-white",children:a.star}),e.jsx("div",{className:"flex h-1.5 flex-1 overflow-hidden rounded-full bg-[#3d3349]",children:e.jsx("div",{className:"rounded-full bg-primary",style:{width:`${c}%`,opacity:.2+a.star/5*.8}})}),e.jsxs("p",{className:"text-right text-xs text-white/50",children:[c,"%"]})]},a.star)})}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(y,{className:"h-2 w-full"}),e.jsx(y,{className:"h-2 w-5/6"}),e.jsx(y,{className:"h-2 w-4/6"})]})})]}),e.jsxs("div",{className:"mt-8 flex flex-col gap-4",children:[j.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"h-24 w-full rounded-2xl"}),e.jsx(y,{className:"h-24 w-full rounded-2xl"})]}):j.data?.reviews?.map(a=>e.jsx(Se,{review:a,profile:j.data?.profilesById.get(a.user_id)??null},a.id)),!j.isLoading&&(j.data?.reviews?.length??0)===0?e.jsx("div",{className:"rounded-2xl bg-[#302839] p-4 text-sm text-white/60",children:"No reviews yet. Be the first to rate and review this title."}):null]}),s?e.jsx("div",{className:"mt-6",children:e.jsxs(ee,{to:`/title/${s}/reviews`,className:"inline-flex items-center gap-2 text-sm font-semibold text-primary",children:["View all reviews",e.jsx(p,{name:"chevron_right",className:"text-base"})]})}):null]})]}),e.jsx("div",{className:"pointer-events-none fixed bottom-0 left-0 h-12 w-full bg-gradient-to-t from-background to-transparent"})]})}export{Re as default};
