import{C as Ge,s as Y,r as n,ap as Se,e as ve,a7 as Er,aq as Nt,b as Qt,ar as Tr,c as Jt,w as Ms,as as Xs,at as Ar,au as Lr,aj as Rs,o as _r,av as Zs,n as Dr,aw as ln,ax as Ur,ay as cn,am as js,N as un,az as Or,R as G,j as e,i as Ss,B as $,E as Ve,aA as en,aB as tn,aC as sn,u as dn,an as re,aD as fn,I as Fr,A as qr,ao as nn,K as Br,L as Pr}from"./index-BhQyicj1.js";import{m as Wt,a as mn,b as $r,M as Cs,s as zr,i as pn,c as gn,d as hn,e as xn,f as Hr,n as Kr,r as yn,g as bn,h as Qr,C as Jr,j as Wr,k as Vr,F as jt,S as Gr,T as Yr,l as rn,u as Xr,o as Zr,p as ea,q as ta,t as sa,v as na}from"./scroll-area-keIy_duf.js";import{u as st}from"./conversationsCache-D_5D90F9.js";import{w as ra,a as aa,B as ia,u as oa,M as la}from"./useAssistantCache-1GH48NSd.js";import{B as ca}from"./bell-yN921BrN.js";import{T as wn}from"./textarea-CD0PbG86.js";import{D as Vt,a as Gt,b as ks,c as Yt,f as ua,d as vn,e as jn}from"./dialog-CtOddV94.js";import{E as da}from"./ellipsis-D2jDXppt.js";import{X as ys}from"./x-mv29V4jj.js";import{C as an}from"./circle-alert-CS6usyAY.js";import{M as ne}from"./material-icon-s6Itatep.js";import{C as fa}from"./copy-5oWhKRql.js";import{U as ma}from"./user-BafyonI3.js";import{u as pa}from"./useUserLastActive-Bz6NMNMo.js";import"./format-BXv9LLlt.js";import"./external-link-CQrupp72.js";import"./plus-DLHoHRQq.js";import"./index-DvH4qpt5.js";import"./clock-25uToDVi.js";const ga=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],ha=Ge("arrow-down",ga);const xa=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],bs=Ge("camera",xa);const ya=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],ba=Ge("paperclip",ya);const wa=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],va=Ge("send",wa);const ja=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Nn=Ge("shield-x",ja);const Na=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Ma=Ge("smile",Na);const Ra=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],ws=Ge("volume-2",Ra),Ns=new Map,Sa=s=>{const t=Ns.get(s);if(t)return t;const r=Y.channel(`conversation-db-${s}`),o={conversationId:s,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.messageInsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(a=>{const l=a;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),Ns.set(s,o),o},Ca=(s,t)=>{const r=Sa(s);r.refCount+=1;const o=[];return t.onStatus&&(r.statusListeners.add(t.onStatus),o.push(()=>r.statusListeners.delete(t.onStatus)),r.lastStatus&&t.onStatus(r.lastStatus)),t.onMessageInsert&&(r.messageInsertListeners.add(t.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(t.onMessageInsert))),t.onMessageUpdate&&(r.messageUpdateListeners.add(t.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(t.onMessageUpdate))),t.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(t.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(t.onReadReceiptUpsert))),t.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(t.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(t.onDeliveryReceiptUpsert))),t.onReactionUpsert&&(r.reactionUpsertListeners.add(t.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(t.onReactionUpsert))),t.onReactionDelete&&(r.reactionDeleteListeners.add(t.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(t.onReactionDelete))),()=>{for(const a of o)a();if(r.refCount-=1,r.refCount<=0){try{Y.removeChannel(r.channel)}catch{}Ns.delete(s)}}},Xt=(s,t,r)=>{n.useEffect(()=>{if(s)return Ca(s,t())},[s,t,...r])},ka=5e3,Ia=1500,Ea=5e3,Ta=s=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:s?Ia:ka,refetchIntervalInBackground:!1}),Aa=new Set(["SUBSCRIBED"]),La=s=>!Aa.has(s),_a=s=>{const[t,r]=n.useState(!1),o=n.useRef(s);n.useEffect(()=>{Object.is(o.current,s)||(o.current=s,r(!1))},[s]);const a=n.useCallback(l=>{const c=La(l);r(y=>y===c?y:c)},[]);return{pollWhenRealtimeDown:t,onStatus:a}},Zt=s=>{const{pollWhenRealtimeDown:t,onStatus:r}=_a(s);return{pollWhenRealtimeDown:t,onRealtimeStatus:r,refetchOptions:Ta(t)}},Da=s=>typeof s=="object"&&s!==null,Mn=s=>s.new,Ua=s=>s.old,nt=(s,t)=>{if(!Da(s))return null;const r=s[t];return typeof r=="string"?r:null},Rn=(s,t)=>nt(s,"conversation_id")===t,Sn=40,Kt=1e5,Oa=s=>`"${s.replace(/"/g,'\\"')}"`,Fa=s=>{const t=Oa(s.createdAt),r=s.id;return`created_at.lt.${t},and(created_at.eq.${t},id.lt.${r})`},qa=s=>{const t=zr((s??[]).map(Wt)),r=(s??[]).length>=Sn,o=t.length?{createdAt:t[0].createdAt,id:t[0].id}:null;return{items:t,hasMore:r,cursor:o}},Ba=(s,t)=>{const r=n.useMemo(()=>Se(s),[s]),o=ve(),[a,l]=n.useState(Kt),{pollWhenRealtimeDown:c,onRealtimeStatus:y,refetchOptions:m}=Zt(s),p=n.useRef(t);n.useEffect(()=>{p.current=t},[t]);const x=n.useRef({pages:0,total:0}),d=Er({queryKey:r,enabled:!!s,initialPageParam:null,...m,staleTime:Ea,queryFn:async({pageParam:w})=>{if(!s)return{items:[],hasMore:!1,cursor:null};let j=Y.from("messages").select(Cs).eq("conversation_id",s).order("created_at",{ascending:!1}).order("id",{ascending:!1});w&&(j=j.or(Fa(w)));const{data:v,error:I}=await j.limit(Sn);if(I)throw console.error(`[useConversationMessages] Failed to load ${w?"older messages":"messages"}`,I),new Error(I.message);return qa(v??[])},getNextPageParam:()=>{},getPreviousPageParam:w=>{if(w.hasMore)return w.cursor??void 0},structuralSharing:(w,j)=>$r(w,j)});n.useEffect(()=>{const w=d.data?.pages??[],j=w.reduce((T,S)=>T+S.items.length,0),v=x.current;if(w.length===0){x.current={pages:0,total:0},l(Kt);return}if(v.pages===0){x.current={pages:w.length,total:j},l(Kt);return}const I=j-v.total,M=w.length-v.pages;I>0&&M>0&&l(T=>Math.max(0,T-I)),x.current={pages:w.length,total:j}},[d.data?.pages]);const b=n.useCallback(()=>{if(!s)return{};const w=(j,v)=>{const I=Mn(j);if(!Rn(I,s)||!nt(I,"id"))return;const T=I,S=Wt(T);o.setQueryData(r,N=>mn(N,T,{allowAppend:v==="insert"})),v==="insert"?p.current?.onInsert?.(S):p.current?.onUpdate?.(S)};return{onStatus:y,onMessageInsert:j=>{w(j,"insert")},onMessageUpdate:j=>{w(j,"update")}}},[s,y,o,r]);Xt(s,b,[]),n.useEffect(()=>{l(Kt),x.current={pages:0,total:0}},[s]);const h=n.useMemo(()=>(d.data?.pages??[]).flatMap(j=>j.items),[d.data?.pages]),f=n.useCallback(async()=>{s&&d.hasPreviousPage&&await d.fetchPreviousPage()},[s,d]);return n.useMemo(()=>({data:h,dataUpdatedAt:d.dataUpdatedAt,isLoading:d.isLoading,isFetching:d.isFetching,isError:d.isError,error:d.error,refetch:d.refetch,loadOlder:f,hasMore:!!d.hasPreviousPage,isLoadingOlder:d.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:c}),[h,d.dataUpdatedAt,d.isLoading,d.isFetching,d.isError,d.error,d.refetch,f,d.hasPreviousPage,d.isFetchingPreviousPage,a,r,c])};function Pa(s){const{conversation:t,deliveryReceipts:r,readReceipts:o,currentUserId:a,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:y}=s;if(!t||!a)return()=>null;const m=t.participants.filter(h=>!h.isSelf);if(m.length===0)return()=>null;const p=new Set(m.map(h=>h.id)),x=h=>{if(!h)return null;const f=y?.get(h);return f??null},d=new Map;for(const h of o??[]){let f=null;if(h.lastReadMessageId){const v=x(h.lastReadMessageId);v!=null&&(f=v),v==null&&(f=null)}else if(h.lastReadAt){const v=new Date(h.lastReadAt).getTime();Number.isNaN(v)||(f=v)}if(f==null)continue;const w=(()=>{if(!h.lastReadAt)return null;const v=new Date(h.lastReadAt).getTime();return Number.isNaN(v)?null:v})(),j=d.get(h.userId);if(!j||f>j.upToMs){d.set(h.userId,{upToMs:f,readAtMs:w});continue}f===j.upToMs&&w!=null&&(j.readAtMs==null||w>j.readAtMs)&&d.set(h.userId,{upToMs:f,readAtMs:w})}const b=new Map;for(const h of r??[]){if(!p.has(h.userId)||c&&!c.has(h.messageId))continue;let f=b.get(h.messageId);f||(f=new Set,b.set(h.messageId,f)),f.add(h.userId)}return h=>{if(h.senderId!==a)return null;if(l[h.id])return{status:"failed"};if(pn(h.id))return{status:"sending"};const f=(()=>{const I=new Date(h.createdAt??"").getTime();return Number.isNaN(I)?0:I})();let w=0,j=null;for(const I of m){const M=d.get(I.id);if(M&&M.upToMs>=f){w+=1;const T=M.readAtMs??M.upToMs;(j===null||T>j)&&(j=T)}}return w===m.length&&m.length>0?{status:"seen",seenAt:j!=null?new Date(j).toISOString():null}:(b.get(h.id)?.size??0)===m.length&&m.length>0?{status:"delivered"}:{status:"sent"}}}function $a(s){const{messages:t,conversation:r,currentUserId:o,participantsById:a,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:y,readReceipts:m,failedMessages:p,lastOwnMessageId:x}=s,d=n.useMemo(()=>{if(!t)return[];const h=new Set;x&&h.add(x);for(const j of Object.keys(p))h.add(j);const f=new Map;for(const j of t){const v=new Date(j.createdAt??"").getTime();Number.isNaN(v)||f.set(j.id,v)}const w=Pa({conversation:r??null,deliveryReceipts:y,readReceipts:m,currentUserId:o,failedMessages:p,onlyMessageIds:h,messageCreatedAtMsById:f});return t.map(j=>{const v=Nt(j.body),I=a.get(j.senderId)??null,M=I?.isSelf??(o!=null&&j.senderId===o),T=M&&h.has(j.id)?w(j):null,S=!!T&&M&&!v.deleted&&(T.status==="failed"||x===j.id);return{message:j,meta:v,sender:I,isSelf:M,deliveryStatus:T,showDeliveryStatus:S,reactions:l.get(j.id)??[]}})},[r,o,y,p,x,t,a,l,m]),b=n.useMemo(()=>d.filter(({message:h})=>!c[h.id]),[d,c]);return{uiMessages:d,visibleMessages:b}}function za(s){const{messages:t,currentUserId:r,hiddenMessageIds:o}=s;return n.useMemo(()=>{if(!t||!r)return null;for(let a=t.length-1;a>=0;a-=1){const l=t[a];if(!(o[l.id]||l.senderId!==r||Nt(l.body).deleted))return l.id}return null},[o,t,r])}const Ha=async s=>{const{data:t,error:r}=await Y.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",s).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(t??[]).map(hn)},Ka=async(s,t)=>{if(t.length===0)return[];const r=Y.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",s).in("message_id",t),{data:o,error:a}=await r.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(o??[]).map(xn)},Qa=async s=>{const{data:t,error:r}=await Y.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",s).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(t??[]).map(gn)},Ja=(s,t)=>{const r=new Map,o=new Map;for(const l of s){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let y=c.get(l.emoji);y||(y={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,y),o.get(l.messageId).push(l.emoji)),y.count+=1,t&&l.userId===t&&(y.reactedBySelf=!0)}const a=new Map;for(const[l,c]of r.entries()){const y=o.get(l)??[];a.set(l,y.map(m=>c.get(m)).filter(Boolean))}return a},Wa=(s,t,r)=>{const o=s??[],a=r.key(t),l=[...o],c=l.findIndex(y=>r.key(y)===a);return c>=0?l[c]=t:l.push(t),r.sort&&l.sort(r.sort),l},Va=(s,t,r)=>{const o=s??[];return o.length===0?[]:o.filter(a=>r.key(a)!==t)},Is=s=>t=>{const r=Mn(t);if(!Rn(r,s.conversationId)||s.extraGuard&&!s.extraGuard(r)||!(s.getRequiredId?s.getRequiredId(r):nt(r,"id")))return;const a=r,l=s.mapRow(a);s.queryClient.setQueryData(s.queryKey,c=>Wa(c,l,{key:s.key,sort:s.sort}))},Ga=s=>t=>{const r=Ua(t),o=s.getRowId?s.getRowId(r):nt(r,"id");if(!o){s.invalidateWhenMissingId!==!1&&s.queryClient.invalidateQueries({queryKey:s.queryKey});return}s.queryClient.setQueryData(s.queryKey,a=>Va(a,o,{key:s.key}))},Ya=s=>{const{user:t}=Qt(),r=t?.id??null,o=ve(),a=n.useMemo(()=>Tr(s),[s]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Zt(s),m=Jt({queryKey:a,enabled:!!s,...y,queryFn:()=>s?Qa(s):Promise.resolve([])}),p=n.useCallback(()=>{if(!s)return{};const b=Is({conversationId:s,queryClient:o,queryKey:a,mapRow:gn,key:f=>f.id,sort:(f,w)=>{const j=Xs(f.createdAt),v=Xs(w.createdAt);return j!==v?j-v:f.id.localeCompare(w.id)}}),h=Ga({queryClient:o,queryKey:a,key:f=>f.id});return{onStatus:c,onReactionUpsert:b,onReactionDelete:h}},[s,c,o,a]);Xt(s,p,[]);const x=Ms({mutationFn:async({messageId:b,emoji:h})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:f}=await Y.from("message_reactions").insert({conversation_id:s,message_id:b,user_id:r,emoji:h});if(f){if(f?.code==="23505"){const{error:w}=await Y.from("message_reactions").delete().eq("message_id",b).eq("user_id",r).eq("emoji",h);if(w)throw console.error("[useConversationReactions] Failed to remove reaction",w),w;return}throw console.error("[useConversationReactions] Failed to toggle reaction",f),f}},onMutate:async({messageId:b,emoji:h})=>{if(!s||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:a});const f=o.getQueryData(a);return o.setQueryData(a,w=>{const j=w??[],v=j.findIndex(M=>M.messageId===b&&M.userId===r&&M.emoji===h);if(v>=0){const M=[...j];return M.splice(v,1),M}const I={id:Hr(),conversationId:s,messageId:b,userId:r,emoji:h,createdAt:new Date().toISOString()};return[...j,I]}),{previousReactions:f}},onError:(b,h,f)=>{s&&(f?.previousReactions?o.setQueryData(a,f.previousReactions):o.invalidateQueries({queryKey:a}))},onSuccess:()=>{s&&o.invalidateQueries({queryKey:a})}}),d=n.useMemo(()=>{const b=m.data??[];return Ja(b,r)},[m.data,r]);return{reactions:m.data??[],reactionsByMessageId:d,isLoadingReactions:m.isLoading,toggleReaction:x,pollWhenRealtimeDown:l,queryKey:a}},Xa=s=>{const t=ve(),r=n.useMemo(()=>Ar(s),[s]),{pollWhenRealtimeDown:o,onRealtimeStatus:a,refetchOptions:l}=Zt(s),c=Jt({queryKey:r,enabled:!!s,...l,queryFn:async()=>s?Ha(s):[]}),y=n.useCallback(()=>{if(!s)return{};const m=Is({conversationId:s,queryClient:t,queryKey:r,mapRow:hn,key:p=>p.userId,getRequiredId:p=>nt(p,"user_id"),sort:(p,x)=>{const d=!p.lastReadAt,b=!x.lastReadAt;if(d&&b)return 0;if(d)return 1;if(b)return-1;const h=new Date(p.lastReadAt).getTime(),f=new Date(x.lastReadAt).getTime();return Number.isNaN(h)&&Number.isNaN(f)?0:Number.isNaN(h)?1:Number.isNaN(f)?-1:f-h}});return{onStatus:a,onReadReceiptUpsert:m}},[s,a,t,r]);return Xt(s,y,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},Za=(s,t)=>{const r=ve(),o=n.useMemo(()=>Kr(t,{excludeTemp:!0,sort:!0}),[t]),a=n.useMemo(()=>Lr(s,o),[s,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:y}=Zt(s),m=Jt({queryKey:a,enabled:!!(s&&o.length>0),...y,queryFn:async()=>s?o.length===0?[]:Ka(s,o):[]}),p=n.useCallback(()=>{if(!s)return{};if(o.length===0)return{};const d=new Set(o),b=Is({conversationId:s,queryClient:r,queryKey:a,mapRow:xn,key:h=>h.id,extraGuard:h=>{const f=nt(h,"message_id");return!!(f&&d.has(f))},sort:(h,f)=>{const w=new Date(h.deliveredAt??"").getTime(),j=new Date(f.deliveredAt??"").getTime(),v=Number.isNaN(w)?0:w,I=Number.isNaN(j)?0:j;return v-I}});return{onStatus:c,onDeliveryReceiptUpsert:b}},[s,o,c,r,a]),x=s&&o.length>0?s:null;return Xt(x,p,[]),n.useMemo(()=>({...m,pollWhenRealtimeDown:l,queryKey:a}),[m,l,a])},ei=s=>{const{conversationId:t,userId:r,displayName:o}=s,{getNumber:a}=Rs(),l=a("ux.typing.inactivity_ms",3e3),c=a("ux.typing.heartbeat_ms",2e3),y=a("ux.typing.remote_ttl_ms",5e3),[m,p]=n.useState({}),x=n.useRef(null),d=n.useRef(new Map),b=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),h=n.useCallback(async I=>{if(!t||!r||!o)return;const M=x.current;M&&await M.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:I}})},[t,r,o]),f=n.useCallback(async()=>{b.current.timeoutId!=null&&(window.clearTimeout(b.current.timeoutId),b.current.timeoutId=null),b.current.isTyping&&(b.current.isTyping=!1,b.current.lastSentAtMs=0,await h(!1))},[h]),w=n.useCallback(I=>{if(!t||!r||!o||!x.current)return;const T=b.current.isTyping;if(I){const S=Date.now();T?S-b.current.lastSentAtMs>c&&(b.current.lastSentAtMs=S,h(!0)):(b.current.isTyping=!0,b.current.lastSentAtMs=S,h(!0)),b.current.timeoutId!=null&&window.clearTimeout(b.current.timeoutId),b.current.timeoutId=window.setTimeout(()=>{b.current.isTyping=!1,b.current.lastSentAtMs=0,b.current.timeoutId=null,h(!1)},l);return}T&&f()},[h,t,o,f,c,l,r]),j=n.useCallback(()=>{p({}),d.current.forEach(I=>window.clearTimeout(I)),d.current.clear()},[]);return n.useEffect(()=>{if(!t)return;j();const I=Y.channel(`supabase_realtime_typing:conversation:${t}`,{config:{broadcast:{self:!1}}});x.current=I,I.on("broadcast",{event:"typing"},({payload:S})=>{const N=S;if(!N?.userId||r&&N.userId===r)return;p(E=>{const F={...E};return N.isTyping&&N.displayName?F[N.userId]=N.displayName:delete F[N.userId],F});const R=d.current.get(N.userId);if(R!=null&&window.clearTimeout(R),N.isTyping){const E=window.setTimeout(()=>{p(F=>{const A={...F};return delete A[N.userId],A}),d.current.delete(N.userId)},y);d.current.set(N.userId,E)}else d.current.delete(N.userId)}).subscribe();const M=()=>{document.visibilityState==="hidden"&&f()},T=()=>{f()};return document.addEventListener("visibilitychange",M),window.addEventListener("beforeunload",T),window.addEventListener("pagehide",T),window.addEventListener("blur",T),()=>{document.removeEventListener("visibilitychange",M),window.removeEventListener("beforeunload",T),window.removeEventListener("pagehide",T),window.removeEventListener("blur",T),j(),f(),x.current&&(Y.removeChannel(x.current),x.current=null)}},[t,f,r,j]),{remoteTypingUsers:n.useMemo(()=>Object.entries(m).map(([I,M])=>({userId:I,displayName:M})),[m]),noteLocalInputActivity:w,stopTyping:f}},ti=s=>{const{conversationId:t,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:a=250}=s,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>t?`${r}${t}`:null,[t,r]),[y,m]=n.useState("");return n.useEffect(()=>{if(!c){m(""),l.current?.("");return}const d=_r(c)??"";m(d),l.current?.(d)},[c]),n.useEffect(()=>{if(!c)return;const x=window.setTimeout(()=>{y.trim().length===0?Zs(c):Dr(c,y)},a);return()=>window.clearTimeout(x)},[c,a,y]),{draft:y,setDraft:m,clearDraft:()=>{c&&Zs(c),m(""),l.current?.("")}}};function si({showComposer:s,initialHeaderHeight:t=72,initialComposerHeight:r=160}){const o=n.useRef(null),[a,l]=n.useState(t),[c,y]=n.useState(r),[m,p]=n.useState(null),[x,d]=n.useState(!1),b=n.useCallback(h=>y(Math.max(h,a)),[a]);return n.useEffect(()=>{const h=o.current;if(!h)return;const f=()=>l(Math.max(h.getBoundingClientRect().height,0));if(f(),typeof ResizeObserver>"u")return;const w=new ResizeObserver(f);return w.observe(h),()=>w.disconnect()},[]),n.useEffect(()=>{y(h=>Math.max(h,a))},[a]),n.useEffect(()=>{s||y(0)},[s]),{headerRef:o,headerHeight:a,composerHeight:c,isAtBottom:m,setIsAtBottom:p,handleComposerHeightChange:b,showEmojiPicker:x,setShowEmojiPicker:d}}const ni=({conversationId:s,currentUserId:t,showComposer:r,isBlocked:o,blockedYou:a,composerTextareaRef:l})=>{const[c,y]=n.useState(null),[m,p]=n.useState({}),[x,d]=n.useState(null),[b,h]=n.useState(null),[f,w]=n.useState(null),j=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{if(!s||!t){p({});return}if(typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=window.localStorage.getItem(A);if(!U){p({});return}const z=JSON.parse(U);if(Array.isArray(z)){const H={};for(const le of z)typeof le=="string"&&le&&(H[le]=!0);p(H);return}if(z&&typeof z=="object"){const H={};for(const[le,je]of Object.entries(z))je&&(H[le]=!0);p(H);return}p({})}catch{p({})}},[s,t]),n.useEffect(()=>{if(!s||!t||typeof window>"u")return;const A=`messages:hidden:${t}:${s}`;try{const U=Object.keys(m).filter(z=>m[z]);window.localStorage.setItem(A,JSON.stringify(U))}catch{}},[s,t,m]);const I=n.useCallback(()=>{y(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const A=z=>{const H=z.target;if(!(H instanceof Element)){y(null);return}H.closest(`[data-message-action-scope="${c}"]`)||y(null)},U=z=>{z.key==="Escape"&&y(null)};return document.addEventListener("pointerdown",A,!0),document.addEventListener("keydown",U),()=>{document.removeEventListener("pointerdown",A,!0),document.removeEventListener("keydown",U)}},[c]);const M=n.useCallback(A=>{o||a||Nt(A.body).deleted||(y(A.id),l.current?.blur())},[a,l,o]),T=n.useCallback((A,U)=>{o||a||Nt(A.body).deleted||(U&&(v.current=U),h({messageId:A.id,text:ln(A.body)??"",body:A.body??null,attachmentUrl:A.attachmentUrl??null}),w(null),I(),l.current?.blur())},[a,I,l,o]),S=n.useCallback(A=>{h(U=>U&&{...U,text:A})},[]),N=n.useCallback(()=>{h(null),w(null),v.current?.focus()},[]);n.useEffect(()=>{b&&queueMicrotask(()=>{j.current?.focus()})},[b]);const R=n.useCallback(A=>{o||a||(I(),d({messageId:A.id,attachmentUrl:A.attachmentUrl??null}),l.current?.blur())},[a,I,l,o]),E=n.useCallback(()=>{d(null)},[]),F=n.useCallback(A=>{p(U=>({...U,[A]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(b||x||queueMicrotask(()=>l.current?.focus()))},[c,x,b,r,l]),{activeActionMessageId:c,openMessageActions:M,closeMessageActions:I,hiddenMessageIds:m,hideMessageForMe:F,deleteDialog:x,openDeleteDialog:R,closeDeleteDialog:E,editingMessage:b,openEditDialog:T,updateEditingText:S,closeEditDialog:N,editTextareaRef:j,editError:f,setEditError:w}},on=3e3;function ri(s){const{conversationId:t,userId:r,isAtBottom:o,messages:a}=s,l=ve(),c=n.useRef({conversationId:null,messageId:null,userId:null}),y=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null,m.lastSentAt=0},[t,r]),n.useEffect(()=>()=>{const m=y.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null},[]),n.useEffect(()=>{if(!t||!a||a.length===0||!r||!o)return;const m=a[a.length-1];if(pn(m.id)||c.current.conversationId===t&&c.current.messageId===m.id&&c.current.userId===r)return;const p=y.current,x=Date.now(),d=p.lastSentAt?x-p.lastSentAt:Number.POSITIVE_INFINITY,b=()=>{st(l,r,t,f=>f.hasUnread?{...f,hasUnread:!1}:f)},h=f=>{p.lastSentAt=Date.now();const w=new Date().toISOString();ra({conversation_id:t,user_id:r,last_read_message_id:f,last_read_at:w}).then(()=>{c.current={conversationId:t,messageId:f,userId:r},b()}).catch(j=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",j)})};if(d<on){p.pending={conversationId:t,userId:r,messageId:m.id},p.timeoutId==null&&(p.timeoutId=window.setTimeout(()=>{const f=y.current.pending;y.current.pending=null,y.current.timeoutId=null,f&&(c.current.conversationId===f.conversationId&&c.current.messageId===f.messageId&&c.current.userId===f.userId||f.conversationId!==t||f.userId!==r||h(f.messageId))},Math.max(on-d,0)));return}p.timeoutId!=null&&(window.clearTimeout(p.timeoutId),p.timeoutId=null,p.pending=null),h(m.id)},[t,a,r,l,o])}const ai=new Set(["text","image","text+image","system"]),ii=s=>{const{user:t}=Qt(),r=t?.id??null,o=ve();return Ms({mutationFn:async({messageId:a,text:l,currentBody:c,attachmentUrl:y})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(y)throw new Error("Cannot edit messages with attachments.");const m=Ur(c,l),p=cn(m),x=ai.has(p.type)?p.type:"text",{data:d,error:b}=await Y.from("messages").update({body:m,message_type:x,text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null}).eq("id",a).eq("conversation_id",s).eq("user_id",r).select(Cs).single();if(b)throw console.error("[useEditMessage] Failed to edit message",b),new Error(b.message);return Wt(d)},onSuccess:a=>{if(!s)return;const l=Se(s);o.setQueryData(l,c=>yn(c,a))}})},oi=s=>{const{user:t}=Qt(),r=t?.id??null,o=ve();return Ms({mutationFn:async({messageId:a,attachmentUrl:l})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const y={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},m=JSON.stringify(y),p=cn(m),{data:x,error:d}=await Y.from("messages").update({body:m,message_type:"system",text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null,attachment_url:null}).eq("id",a).eq("conversation_id",s).eq("user_id",r).select(Cs).single();if(d)throw console.error("[useDeleteMessage] Failed to delete message",d),new Error(d.message);if(l)try{await bn(l)}catch(h){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",h)}return Wt(x)},onSuccess:a=>{if(!s)return;const l=Se(s);o.setQueryData(l,c=>yn(c,a)),o.invalidateQueries({queryKey:js(r)})}})};function li(s){const{conversationId:t,setDraft:r,messages:o}=s,a=ve(),[l,c]=n.useState(null),[y,m]=n.useState(null),[p,x]=n.useState(null),[d,b]=n.useState({}),h=n.useRef({});n.useEffect(()=>{h.current=d},[d]);const f=n.useRef(t);n.useEffect(()=>{t!==f.current&&(f.current=t,c(null),m(null),x(null),b({}),h.current={})},[t]),n.useEffect(()=>()=>{const S=Object.values(h.current),N=Array.from(new Set(S.map(R=>R.attachmentPath).filter(R=>typeof R=="string"&&R.length>0&&!Qr(R))));N.length!==0&&Y.storage.from(Jr).remove(N).then(({error:R})=>{R&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)}).catch(R=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)})},[t]),n.useEffect(()=>{o&&b(S=>{const N=new Set(o.map(F=>F.id));let R=!1;const E={...S};for(const F of Object.keys(E))N.has(F)||(delete E[F],R=!0);return R?E:S})},[o]);const w=n.useCallback(()=>{c(null),m(null),x(null)},[]),j=n.useCallback((S,N,R)=>{c(R.message||"Couldn't send. Please try again."),N.text.trim()&&r(N.text),m(N),x(S),b(E=>({...E,[S]:N}))},[r]),v=n.useCallback(S=>{S&&(b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),S===p&&w())},[w,p]),I=n.useCallback(()=>{if(!y)return null;const S=p;return S&&b(N=>{if(!(S in N))return N;const R={...N};return delete R[S],R}),w(),{payload:y,tempId:S}},[w,y,p]),M=n.useCallback(S=>{const N=d[S];return N?(b(R=>{if(!(S in R))return R;const E={...R};return delete E[S],E}),S===p?w():c(null),N):null},[w,d,p]),T=n.useCallback(async S=>{if(!t)return;const N=d[S];if(!N)return;const R=Se(t);if(a.setQueryData(R,E=>Wr(E,S)),b(E=>{if(!(S in E))return E;const F={...E};return delete F[S],F}),S===p&&w(),N.attachmentPath)try{await bn(N.attachmentPath)}catch(E){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",E)}},[w,t,d,p,a]);return{sendError:l,setSendError:c,lastFailedPayload:y,lastFailedTempId:p,failedMessages:d,clearBannerState:w,onSendFailed:j,onSendRecovered:v,consumeLastFailedForRetry:I,consumeFailedMessageForRetry:M,discardFailedMessage:T}}const ci=({currentUserId:s})=>{const t=ve();return n.useCallback(r=>{st(t,s,r.conversationId,o=>{const a=!!(s&&r.senderId===s);return{...o,lastMessagePreview:Or(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:un(r.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),s&&r.senderId!==s&&aa({conversation_id:r.conversationId,message_id:r.id,user_id:s})},[s,t])},ui=({conversationId:s,userId:t,conversation:r,readReceipts:o,visibleMessages:a})=>{const[l,c]=n.useState(void 0),[y,m]=n.useState(void 0);return n.useEffect(()=>{c(void 0),m(void 0)},[s,t]),n.useEffect(()=>{if(!s||!t||l!==void 0)return;const x=(o??[]).find(d=>d.userId===t)??null;c(x?.lastReadMessageId??null)},[s,l,o,t]),n.useEffect(()=>{!s||!t||y===void 0&&r&&m(!!r.hasUnread)},[r,s,y,t]),{firstUnreadIndex:n.useMemo(()=>{if(y===void 0||!y||a.length===0||l===void 0)return null;if(l===null)return 0;const x=a.findIndex(b=>b.message.id===l);if(x<0)return 0;const d=x+1;return d>=a.length?null:d},[y,l,a]),lastReadMessageId:l,hasUnread:y??!1,isReady:y!==void 0&&l!==void 0}};function di(s){const{items:t=[],itemContent:r,isLoading:o,loadingContent:a,errorContent:l,emptyContent:c,header:y,footer:m,bottomPadding:p,scrollerRef:x,followOutput:d,onAtBottomChange:b,atBottomThreshold:h=80,onStartReached:f,computeItemKey:w,ariaLabel:j="Messages"}=s,v=G.useRef(null),I=G.useRef(!0),M=G.useRef(null),T=G.useRef(!1),S=G.useCallback(R=>{v.current=R,x&&(typeof x=="function"?x(R):x.current=R)},[x]),N=G.useCallback(R=>R.scrollHeight-R.scrollTop-R.clientHeight<=h,[h]);return G.useLayoutEffect(()=>{const R=v.current;if(!R)return;const E=A=>{I.current=A,M.current!==A&&(M.current=A,b?.(A))},F=()=>{const A=N(R);E(A),f&&(R.scrollTop<=24?T.current||(T.current=!0,f()):R.scrollTop>=80&&(T.current=!1))};return F(),R.addEventListener("scroll",F,{passive:!0}),()=>R.removeEventListener("scroll",F)},[N,b,f]),G.useEffect(()=>{const R=v.current;if(!R)return;const E=I.current,F=typeof d=="function"?d(E):d??!1;F&&E&&requestAnimationFrame(()=>{R.scrollTo({top:R.scrollHeight,behavior:F==="smooth"?"smooth":"auto"})})},[t.length]),o?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:a}):l?e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):t.length?e.jsx("div",{className:"h-full w-full",children:e.jsx("div",{ref:S,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":j,style:{paddingBottom:p??void 0},children:e.jsxs("div",{className:"page-pad pt-3",children:[y,e.jsx("div",{className:"space-y-0",children:t.map((R,E)=>e.jsx(G.Fragment,{children:r(E,R)},w?w(E,R):E))}),m]})})}):e.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const fi=({show:s,pendingCount:t,onClick:r,shortcutHint:o})=>{if(!s)return null;const a=t>1?`Jump to latest message. ${t} new messages`:"Jump to latest message";return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," new message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[e.jsx(ha,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Jump to latest"}),t>0&&e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})},mi=({show:s,unreadCount:t,onClick:r,shortcutHint:o})=>{if(!s||t<=0)return null;const a=t===1?"Jump to the first unread message":`Jump to first unread message. ${t} unread messages`;return e.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[e.jsxs("div",{className:"sr-only","aria-live":"polite",children:[t," unread message",t===1?"":"s","."]}),e.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[e.jsx(ca,{className:"h-4 w-4","aria-hidden":!0}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{children:"Unread"}),e.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:t})]})]})]})};function pi(s){const t=s.trim().split(/\s+/).filter(Boolean);return t.length===0?"?":t.length===1?t[0].slice(0,2).toUpperCase():`${t[0][0]??""}${t[1][0]??""}`.toUpperCase()}function vs({delayMs:s}){return e.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${s}ms`},"aria-hidden":"true"})}function gi({users:s,className:t}){if(!s.length)return null;const r=s.slice(0,3),o=Math.max(0,s.length-r.length);return e.jsxs("div",{className:Ss("mt-1 flex w-full items-end gap-2 justify-start",t),role:"status","aria-live":"polite","aria-label":s.length===1?`${s[0].displayName} is typing`:"People are typing",children:[e.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(a=>e.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:a.displayName,children:a.avatarUrl?e.jsx("img",{src:a.avatarUrl,alt:a.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:pi(a.displayName)})},a.id)),o>0&&e.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),e.jsx(Vr,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(vs,{delayMs:0}),e.jsx(vs,{delayMs:120}),e.jsx(vs,{delayMs:240})]})})]})}const hi=({children:s,className:t,onHeightChange:r,minHeight:o,style:a,...l})=>{const c=G.useRef(null),[y,m]=G.useState(0);return G.useEffect(()=>{if(!r||!c.current)return;const p=c.current,x=()=>r(p.getBoundingClientRect().height);x();const d=new ResizeObserver(x);return d.observe(p),()=>d.disconnect()},[r]),G.useLayoutEffect(()=>{if(typeof window>"u")return;const p=window.visualViewport;if(!p){m(0);return}const x=()=>{const d=Math.max(0,window.innerHeight-p.height-p.offsetTop);m(d)};return x(),p.addEventListener("resize",x),p.addEventListener("scroll",x),window.addEventListener("orientationchange",x),()=>{p.removeEventListener("resize",x),p.removeEventListener("scroll",x),window.removeEventListener("orientationchange",x)}},[]),e.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",style:{transform:`translateY(-${y}px)`},children:e.jsx("div",{className:"w-full",children:e.jsx("form",{...l,className:Ss("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-2.5 md:p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",t),style:{minHeight:o,...a},children:s})})})},xi=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],Cn="movinesta_recent_files_v1",Es=6,yi=s=>{if(!Number.isFinite(s)||s<=0)return"0 B";const t=["B","KB","MB","GB"];let r=0,o=s;for(;o>=1024&&r<t.length-1;)o/=1024,r+=1;const a=r==0||r==1?0:1;return`${o.toFixed(a)} ${t[r]}`},bi=(s,t)=>{const r=(s.split(".").pop()??"").toUpperCase();return r||(t?.startsWith("image/")?"IMG":t?.startsWith("audio/")?"AUDIO":"FILE")},wi=s=>s?.startsWith("image/")?"image":s?.startsWith("audio/")?"audio":"file",vi=()=>{try{const s=localStorage.getItem(Cn);if(!s)return[];const t=JSON.parse(s);return Array.isArray(t)?t.filter(r=>r&&typeof r=="object").map(r=>({id:String(r?.id??""),name:String(r?.name??"File"),size:Number(r?.size??0),sizeLabel:String(r?.sizeLabel??"0 B"),badge:String(r?.badge??"FILE"),mime:String(r?.mime??""),kind:["image","audio","file"].includes(r?.kind)?r.kind:"file",lastUsed:Number(r?.lastUsed??0)})).filter(r=>r.id&&r.name).slice(0,Es):[]}catch{return[]}},ji=s=>{try{const t=s.map(r=>{const{previewUrl:o,...a}=r;return a});localStorage.setItem(Cn,JSON.stringify(t.slice(0,Es)))}catch{}},Ni=({show:s,headerHeight:t,onHeightChange:r,draft:o,setDraft:a,textareaRef:l,noteLocalInputActivity:c,stopTyping:y,onSendText:m,onRequestScrollToBottom:p,isUploadingAttachment:x,pendingAttachment:d,clearPendingAttachment:b,cancelAttachmentUpload:h,sendError:f,sendErrorMessage:w,canRetrySend:j,onRetrySend:v,uploadError:I,clearUploadError:M,showEmojiPicker:T,setShowEmojiPicker:S,openCameraPicker:N,onImageSelected:R,openAttachmentPicker:E,imageInputRef:F,attachmentInputRef:A,onAttachmentSelected:U,onAttachmentFile:z,disableSend:H})=>{const{getNumber:le}=Rs(),je=Math.max(1,Math.floor(le("ux.messages.max_message_chars",2e3))),xe=Math.max(60,Math.floor(le("ux.messages.composer_max_height_px",140))),[Mt,Ye]=n.useState(!1),[Xe,de]=n.useState(!1),[Ce,rt]=n.useState(!1),[Ue,Rt]=n.useState([]),ye=n.useRef(new Set),at=n.useRef(null),[Oe,es]=n.useState({canScrollLeft:!1,canScrollRight:!1,pages:1,active:0});n.useEffect(()=>{typeof window>"u"||Rt(vi())},[]),n.useEffect(()=>()=>{for(const g of ye.current)try{URL.revokeObjectURL(g)}catch{}ye.current.clear()},[]);const Ne=n.useCallback(g=>{if(!g)return;const k=g.type??"",O=wi(k),W=bi(g.name,k),Q=O==="image"?URL.createObjectURL(g):void 0;Q&&ye.current.add(Q);const te=`${g.name}:${g.size}:${g.lastModified}:${k}`,ae={id:te,name:g.name,size:g.size,sizeLabel:yi(g.size),badge:W,mime:k,kind:O,lastUsed:Date.now(),previewUrl:Q};Rt(ie=>{const fe=ie.filter(ce=>ce.id!==te),me=[ae,...fe].slice(0,Es),Ze=new Set(me.map(ce=>ce.id));for(const ce of ie)if(ce.previewUrl&&!Ze.has(ce.id)){try{URL.revokeObjectURL(ce.previewUrl)}catch{}ye.current.delete(ce.previewUrl)}return ji(me),me})},[]),ke=n.useCallback(()=>{const g=at.current;if(!g)return;const k=Math.max(0,g.scrollWidth-g.clientWidth),O=g.scrollLeft,W=O>1,Q=O<k-1,te=k>0?Math.ceil(g.scrollWidth/Math.max(1,g.clientWidth)):1,ae=Math.min(5,Math.max(1,te)),ie=k>0?O/k:0,fe=ae>1?Math.round(ie*(ae-1)):0;es({canScrollLeft:W,canScrollRight:Q,pages:ae,active:fe})},[]);n.useEffect(()=>{if(!Xe||Ce)return;const g=at.current;if(!g)return;let k=0;const O=()=>{k||(k=window.requestAnimationFrame(()=>{k=0,ke()}))};return ke(),g.addEventListener("scroll",O,{passive:!0}),window.addEventListener("resize",ke),()=>{g.removeEventListener("scroll",O),window.removeEventListener("resize",ke),k&&window.cancelAnimationFrame(k)}},[Ue.length,Ce,Xe,ke]);const K=n.useCallback(g=>{const k=g.target.value,O=k.length>je?k.slice(0,je):k;a(O),T&&S(!1),c(O.trim().length>0);const W=g.target;W.style.height="auto";const Q=Math.min(W.scrollHeight,xe);W.style.height=`${Q}px`},[xe,je,c,a,S,T]),St=n.useCallback(g=>{g&&(a(k=>{const O=`${k}${g}`;return c(O.trim().length>0),O}),queueMicrotask(()=>{const k=l.current;k&&(k.style.height="auto",k.style.height=`${Math.min(k.scrollHeight,xe)}px`)}))},[xe,c,a,l]),q=n.useCallback(g=>{if(g.preventDefault(),H||x)return;const k=o.trim();k&&(a(""),y(),m(k))},[H,o,x,m,a,y]),Ie=H||!o.trim()||x,Ct=n.useCallback(g=>{const k=g.target.files?.[0];k&&Ne(k),R(g)},[R,Ne]),Fe=n.useCallback(g=>{const k=g.target.files?.[0];k&&Ne(k),U(g)},[U,Ne]),X=x||H,Me=x||H,be=n.useMemo(()=>[{key:"photo",label:"Photo",icon:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!1),N()},disabled:X},{key:"file",label:"File",icon:e.jsx(jt,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!1),E()},disabled:Me},{key:"more",label:"More",icon:e.jsx(da,{className:"h-4 w-4","aria-hidden":"true"}),onClick:()=>{Ye(!1),de(!0)},disabled:Me}],[Me,X,E,N]),qe=d?x?"Uploadingâ€¦":I?"Upload failed":"Ready":null;return s?e.jsxs(hi,{onSubmit:q,className:"space-y-2",onHeightChange:r,minHeight:t,onDragOver:g=>{!z||H||(g.preventDefault(),g.dataTransfer.dropEffect="copy",g.currentTarget.dataset.dragging="true")},onDragLeave:g=>{g.currentTarget.dataset.dragging="false"},onDrop:g=>{if(!z||H||x)return;g.preventDefault(),g.currentTarget.dataset.dragging="false";const k=g.dataTransfer.files;if(!k||k.length===0)return;const O=Array.from(k)[0];O&&(Ne(O),z(O))},children:[d&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-start justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex min-w-0 items-start gap-3",children:[d.kind==="image"&&d.previewUrl?e.jsx("img",{src:d.previewUrl,alt:"",className:"h-12 w-12 rounded-lg object-cover"}):d.kind==="audio"&&d.previewUrl?e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(ws,{className:"h-5 w-5","aria-hidden":"true"})}):e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col gap-0.5",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("p",{className:"min-w-0 truncate text-[13px] font-semibold text-foreground",children:d.name}),qe?e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:qe}):null]}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:d.sizeLabel}),d.kind==="audio"&&d.previewUrl?e.jsx("audio",{controls:!0,src:d.previewUrl,className:"mt-2 w-52",children:e.jsx("track",{kind:"captions",srcLang:"en",label:"Captions"})}):null]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:x?h:b,"aria-label":x?"Cancel upload":"Remove attachment",children:e.jsx(ys,{className:"h-4 w-4","aria-hidden":"true"})})]}),x&&e.jsxs("div",{role:"status",className:"soft-row-card flex items-center justify-between gap-3 px-3 py-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Uploading attachmentâ€¦"}),e.jsx("div",{className:"mt-1 h-1.5 w-40 overflow-hidden rounded-full bg-muted/70","aria-hidden":"true",children:e.jsx("div",{className:"h-full w-1/2 animate-pulse rounded-full bg-primary/60"})})]})]}),e.jsx($,{type:"button",size:"icon",variant:"ghost",className:"icon-hit",onClick:h,"aria-label":"Cancel upload",children:e.jsx(ys,{className:"h-4 w-4","aria-hidden":"true"})})]}),f&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(an,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:w??"Couldn't send. Please try again."})]}),j&&e.jsx($,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Retry"})]}),I&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-xs text-destructive",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(an,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold text-foreground",children:I})]}),e.jsx($,{type:"button",size:"sm",variant:"ghost",onClick:M,children:"Dismiss"})]}),e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsxs(en,{open:T,onOpenChange:S,children:[e.jsx(tn,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"icon-hit bg-muted/60 shadow-sm",children:e.jsx(Ma,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(sn,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:e.jsx(Gr,{className:"max-h-64",children:e.jsx("div",{className:"grid grid-cols-9 gap-2",children:xi.map(g=>e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit rounded-xl text-lg",onClick:()=>{St(g),S(!1)},children:e.jsx("span",{children:g})},g))})})})]}),e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm",onClick:N,"aria-label":"Send photo",disabled:X,"aria-busy":x,children:e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:F,accept:"image/*",className:"hidden",onChange:Ct}),e.jsxs(en,{open:Mt,onOpenChange:Ye,children:[e.jsx(tn,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit bg-muted/60 shadow-sm","aria-label":"Add attachment",disabled:Me,"aria-busy":x,children:e.jsx(ba,{className:"h-4 w-4","aria-hidden":"true"})})}),e.jsx(sn,{side:"top",align:"center",className:"soft-popover w-auto p-2",children:e.jsx("div",{className:"flex items-center gap-2",children:be.map(g=>e.jsxs($,{type:"button",variant:"ghost",size:"icon",className:"h-12 w-12 flex-col gap-1 rounded-2xl text-muted-foreground hover:bg-muted/60 hover:text-foreground",onClick:g.onClick,disabled:g.disabled,"aria-label":g.label,children:[g.icon,e.jsx("span",{className:"text-[10px] font-medium leading-none",children:g.label})]},g.key))})})]}),e.jsx(Vt,{open:Xe,onOpenChange:g=>{de(g),g||rt(!1)},children:e.jsxs(Gt,{className:"fixed left-1/2 bottom-4 top-auto -translate-x-1/2 translate-y-0 w-[calc(100%-2rem)] max-w-lg rounded-3xl border border-border/70 bg-card p-4 shadow-2xl",children:[e.jsx("div",{className:"mx-auto mb-2 h-1 w-10 rounded-full bg-muted/70","aria-hidden":"true"}),e.jsxs(ks,{className:"flex-row items-center justify-between space-y-0",children:[e.jsx(Yt,{className:"text-base",children:"Attach"}),e.jsx(ua,{asChild:!0,children:e.jsx($,{type:"button",variant:"ghost",size:"icon",className:"icon-hit","aria-label":"Close",children:e.jsx(ys,{className:"h-4 w-4","aria-hidden":"true"})})})]}),e.jsxs("div",{className:"mt-3 grid gap-2",children:[e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),N()},disabled:X,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(bs,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Photo"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Choose an image"})]})]})}),e.jsx("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between",onClick:()=>{de(!1),E()},disabled:Me,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-2xl bg-muted/60 text-foreground",children:e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex flex-col text-left",children:[e.jsx("span",{className:"text-sm font-semibold",children:"File"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"PDF, docs, audio, more"})]})]})})]}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Recent files"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>rt(g=>!g),"aria-pressed":Ce,children:Ce?"Hide":"See all"}),e.jsx($,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>{de(!1),E()},disabled:Me,children:"Browse"})]})]}),Ce?e.jsx("div",{className:"mt-2 grid gap-2",children:Ue.length===0?e.jsxs("div",{className:"soft-row-card px-3 py-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:"No recent files yet"}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:"Attach something and it will appear here."})]}):Ue.map(g=>e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive row-pad flex items-center justify-between disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),g.kind==="image"?N():E()},disabled:Me,"aria-label":`Attach ${g.name}`,title:g.name,children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:g.kind==="image"&&g.previewUrl?e.jsx("img",{src:g.previewUrl,alt:"",className:"h-full w-full object-cover"}):g.kind==="audio"?e.jsx(ws,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"flex min-w-0 flex-col text-left",children:[e.jsx("span",{className:"min-w-0 truncate text-sm font-semibold",children:g.name}),e.jsxs("span",{className:"mt-0.5 text-xs text-muted-foreground",children:[g.badge," â€¢ ",g.sizeLabel]})]})]}),e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:"Recent"})]},g.id))}):e.jsxs("div",{className:"relative mt-2",children:[e.jsx("div",{ref:at,className:"-mx-1 flex gap-2 overflow-x-auto px-1 pb-1",role:"list","aria-label":"Recent files",children:Ue.length===0?e.jsx("div",{className:"soft-row-card flex w-[260px] shrink-0 items-center justify-between gap-3 px-3 py-2",children:e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[13px] font-semibold text-foreground",children:"No recent files yet"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Attach something to see it here."})]})}):Ue.map(g=>e.jsx("div",{role:"listitem",children:e.jsxs("button",{type:"button",className:"soft-row-card soft-row-card-interactive flex w-[220px] shrink-0 items-center gap-3 px-3 py-2 text-left disabled:pointer-events-none disabled:opacity-50",onClick:()=>{de(!1),g.kind==="image"?N():E()},disabled:Me,"aria-label":`Attach ${g.name}`,title:g.name,children:[e.jsx("div",{className:"relative flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-2xl bg-muted/60 text-foreground",children:g.kind==="image"&&g.previewUrl?e.jsx("img",{src:g.previewUrl,alt:"",className:"h-full w-full object-cover"}):g.kind==="audio"?e.jsx(ws,{className:"h-5 w-5","aria-hidden":"true"}):e.jsx(jt,{className:"h-5 w-5","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsx("span",{className:"min-w-0 truncate text-[13px] font-semibold",children:g.name})}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2",children:[e.jsx("span",{className:"shrink-0 rounded-full bg-muted px-2 py-0.5 text-[10px] font-medium text-muted-foreground",children:g.badge}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:g.sizeLabel})]})]})]})},g.id))}),Oe.canScrollLeft?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 w-6 bg-gradient-to-r from-card to-transparent","aria-hidden":"true"}):null,Oe.canScrollRight?e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 w-6 bg-gradient-to-l from-card to-transparent","aria-hidden":"true"}):null,Oe.pages>1?e.jsx("div",{className:"mt-2 flex items-center justify-center gap-1","aria-hidden":"true",children:Array.from({length:Oe.pages}).map((g,k)=>e.jsx("span",{className:k===Oe.active?"h-1.5 w-4 rounded-full bg-foreground/70 motion-safe:transition-all":"h-1.5 w-1.5 rounded-full bg-muted-foreground/30 motion-safe:transition-all"},k))}):null]})]})]})}),e.jsx("input",{type:"file",ref:A,accept:"image/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain,text/csv,application/rtf",className:"hidden",onChange:Fe}),e.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border/70 bg-background/80 px-3 py-2 shadow-inner transition-shadow focus-within:ring-2 focus-within:ring-primary/25 focus-within:ring-offset-2 focus-within:ring-offset-background",children:e.jsx(wn,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:K,onBlur:y,onPaste:g=>{if(!z||H||x)return;const k=g.clipboardData?.items;if(!k)return;const O=Array.from(k).find(Q=>Q.type.startsWith("image/"));if(!O)return;const W=O.getAsFile();W&&(g.preventDefault(),p?.(),Ne(W),z(W))},onKeyDown:g=>{if(g.key==="Enter"&&!g.shiftKey){if(H||Ie||!o.trim())return;g.preventDefault(),p?.(),g.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-[14px] leading-5 md:text-sm md:leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),e.jsx($,{type:"submit",variant:"default",size:"icon",className:"h-11 w-11 rounded-full bg-primary text-primary-foreground shadow-sm hover:bg-primary/90",onMouseDown:g=>g.preventDefault(),disabled:Ie,"aria-label":"Send message","aria-busy":x,children:x?e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(va,{className:"h-4 w-4","aria-hidden":"true"})})]})]}):null},Mi=({open:s,editingMessage:t,onOpenChange:r,onCancel:o,onTextChange:a,onSave:l,textareaRef:c,error:y,isSaving:m})=>e.jsx(Vt,{open:s,onOpenChange:r,children:e.jsxs(Gt,{children:[e.jsxs(ks,{children:[e.jsx(Yt,{children:"Edit message"}),e.jsx(vn,{children:"Update your message for everyone in the conversation."})]}),t&&e.jsx(wn,{ref:c,value:t.text,onChange:p=>a(p.target.value),rows:3,className:"min-h-[120px]"}),y&&e.jsx("p",{className:"text-xs text-destructive",children:y}),e.jsxs(jn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),e.jsxs($,{type:"button",disabled:!t?.text.trim()||m,onClick:l,children:[m&&e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),Ri=({open:s,deleteDialog:t,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:a,isDeleting:l})=>e.jsx(Vt,{open:s,onOpenChange:r,children:e.jsxs(Gt,{children:[e.jsxs(ks,{className:"gap-1",children:[e.jsxs(Yt,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:e.jsx(Yr,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),e.jsx(vn,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),e.jsxs(jn,{className:"gap-2",children:[e.jsx($,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!t,children:"Hide for me"}),e.jsxs($,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!t,onClick:a,children:[l&&e.jsx(Ve,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]})]})}),Si=({participant:s,onClick:t})=>{const r=(s.displayName??s.username??"?").slice(0,1).toUpperCase();return e.jsxs("button",{type:"button",onClick:t,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!t,children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:s.displayName,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.displayName}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:s.username?`@${s.username}`:s.isSelf?"You":""})]}),t?e.jsx(ne,{name:"chevron_right",className:"text-muted-foreground"}):null]})},Ci=({open:s,onOpenChange:t,conversation:r,currentUserId:o,conversationId:a,isMuted:l,onToggleMute:c,otherParticipant:y,isGroupConversation:m,youBlocked:p,blockedYou:x,blockPending:d,onBlockToggle:b})=>{const h=dn(),f=n.useMemo(()=>r?.participants??[],[r?.participants]),w=!m&&!!y?.username&&!y?.isSelf,[j,v]=n.useState(null);n.useEffect(()=>{const S=r?.mutedUntil;if(!l||!S){v(null);return}const N=Date.parse(S);if(!Number.isFinite(N)||N<=Date.now()){v(null);return}try{v(new Date(N).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{v(null)}},[r?.mutedUntil,l]);const I=async()=>{const S=`${window.location.origin}/messages/${a}`;await rn(S)?re.show("Conversation link copied."):re.error("Couldn't copy to clipboard.")},M=async()=>{await rn(a)?re.show("Conversation ID copied."):re.error("Couldn't copy to clipboard.")},T=S=>{if(!S.username){re.show("This profile can't be opened yet.");return}t(!1),h(`/u/${S.username}`)};return e.jsx(Vt,{open:s,onOpenChange:t,children:e.jsxs(Gt,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none card-pad",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Yt,{className:"text-base",children:"Conversation info"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:m?`${f.length} participants`:y?.username?`@${y.username}`:"Direct message"})]}),e.jsx("button",{type:"button",onClick:()=>t(!1),className:"icon-hit","aria-label":"Close",children:e.jsx(ne,{name:"close"})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:I,children:[e.jsx(fa,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:M,children:[e.jsx(ne,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),t(!1)},children:[e.jsx(ia,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),j?e.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",j]}):null]}),!m&&e.jsxs("div",{className:"mt-2 grid gap-2",children:[e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!w||!y||T(y)},disabled:!w,children:[e.jsx(ma,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),e.jsxs($,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:b,disabled:d||x&&!p,children:[e.jsx(Nn,{className:"h-4 w-4","aria-hidden":!0}),p?"Unblock":x?"Blocked":"Block"]}),(x||p)&&e.jsx("p",{className:"text-xs text-muted-foreground",children:x&&!p?"This user has blocked you.":p?"You blocked this user.":null})]}),m&&e.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),e.jsx("div",{className:"grid gap-1",children:f.map(S=>e.jsx(Si,{participant:S,onClick:S.username&&S.id!==o?()=>T(S):void 0},S.id))})]})]})})};function ki(){const[s,t]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{t(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),s}const Ii=2;function Ei(s){const{items:t,onJumpToItemIndex:r,minQueryLen:o=Ii}=s,[a,l]=n.useState(!1),[c,y]=n.useState(""),[m,p]=n.useState(0),x=c.trim().toLowerCase(),d=x.length>=o,b=n.useMemo(()=>{if(!d)return[];const N=[];for(let R=0;R<t.length;R++){const E=t[R];if(E.meta.deleted)continue;const F=ln(E.message.body);F&&F.toLowerCase().includes(x)&&N.push(R)}return N},[t,x,d]),h=n.useMemo(()=>{const N=new Set;for(const R of b){const E=t[R]?.message.id;E&&N.add(E)}return N},[t,b]),f=b.length;n.useEffect(()=>{p(0)},[x]),n.useEffect(()=>{f!==0&&(m<0&&p(0),m>f-1&&p(f-1))},[m,f]);const w=n.useCallback(N=>{if(f===0)return;const R=(N%f+f)%f;p(R);const E=b[R];typeof E=="number"&&r?.(E)},[f,b,r]),j=n.useCallback(()=>{w(m+1)},[m,w]),v=n.useCallback(()=>{w(m-1)},[m,w]),I=n.useCallback(()=>{w(0)},[w]),M=n.useCallback(()=>{y(""),p(0)},[]),T=n.useCallback(()=>{l(!1),y(""),p(0)},[]),S=n.useMemo(()=>{if(f===0)return null;const N=b[m];return t[N]?.message.id??null},[m,t,f,b]);return{query:c,setQuery:y,isOpen:a,setIsOpen:l,matchCount:f,activeMatchNumber:f===0?0:m+1,activeMatchIndex:f===0?-1:m,activeMessageId:S,isMatch:N=>h.has(N),jumpNext:j,jumpPrev:v,jumpToFirst:I,clear:M,close:T}}function Ti(s,t,r,o){if(!r||typeof r!="object"||typeof r.id!="string")return!0;const a=o?.allowAppend??!0,l=o?.forceFailOnce??!1,c=o?.isMountedRef,y=o?.schedule??((d,b)=>{if(!(typeof window>"u"||typeof window.setTimeout!="function"))return window.setTimeout(d,b)});let m=!1;const p=()=>{try{return s.setQueryData(t,d=>{if(l&&!m)throw m=!0,new Error("forced cache updater failure");return mn(d,r,{allowAppend:a})}),!0}catch{return!1}};if(p())return!0;try{s.invalidateQueries?.({queryKey:t})}catch{}const x=[120,400,900];for(const d of x)y(()=>{c&&!c.current||p()},d);return!1}function Ai(s,t){return Jt({queryKey:fn(s),enabled:!!s&&t,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await Y.rpc("assistant_reply_status_v1",{p_conversation_id:s});if(o){const a=(o.message??"").toLowerCase();if(a.includes("does not exist")||a.includes("function")||a.includes("schema"))return null;throw new Error(o.message)}return r??null}})}const Zi=()=>{const{conversationId:s}=Fr(),t=s??null,r=dn(),{user:o}=Qt(),a=ve(),l=n.useRef(!0);n.useEffect(()=>(l.current=!0,()=>{l.current=!1}),[]);const c=n.useRef(!1);n.useEffect(()=>{},[]);const y=n.useCallback((i,u)=>{if(!t)return!0;const C=Se(t),_=c.current;return _&&(c.current=!1),Ti(a,C,i,{allowAppend:u?.allowAppend??!0,forceFailOnce:_,isMountedRef:l})},[t,a]),{getString:m,getNumber:p}=Rs(),x=n.useMemo(()=>m("ux.assistant.username","movinesta").toLowerCase(),[m]),d=n.useMemo(()=>m("ux.presence.label_online","Online"),[m]),b=n.useMemo(()=>m("ux.presence.label_active_recently","Active recently"),[m]),h=n.useMemo(()=>m("ux.presence.label_active_prefix","Active"),[m]),f=n.useMemo(()=>{const i=p("ux.messages.search.min_query_chars",2),u=Number.isFinite(i)?Math.trunc(i):2;return Math.max(1,Math.min(10,u))},[p]),{data:w,isLoading:j}=qr(),v=o?.id??null,I=oa(),M=n.useMemo(()=>!t||!w?null:w.find(i=>i.id===t)??null,[t,w]),T=M?.isMuted??!1,[S,N]=n.useState(!1),R=n.useCallback(()=>{if(!t)return;if(!v){re.error("Please sign in to manage messages.");return}const i=M?.isMuted??!1,u=M?.mutedUntil??null,C=M?.isHidden??!1;st(a,v,t,_=>({..._,isMuted:!1,mutedUntil:null})),re.show("Unmuted notifications."),nn(v,t,{muted:!1,hidden:C,mutedUntil:null}).then(({ok:_})=>{_||(st(a,v,t,D=>({...D,isMuted:i,mutedUntil:u})),re.error("Couldn't update preferences."))})},[t,v,M,a]),E=n.useCallback(i=>{if(!t)return;if(!v){re.error("Please sign in to manage messages.");return}const u=M?.isMuted??!1,C=M?.mutedUntil??null,_=M?.isHidden??!1;let D=!1,P=null;i.kind==="indefinite"?(D=!0,P=null):(D=!1,P=new Date(Date.now()+i.minutes*6e4).toISOString()),st(a,v,t,Re=>({...Re,isMuted:!0,mutedUntil:P})),re.show(`Muted notifications for ${i.label}.`),nn(v,t,{muted:D,hidden:_,mutedUntil:P}).then(({ok:Re})=>{Re||(st(a,v,t,wt=>({...wt,isMuted:u,mutedUntil:C})),re.error("Couldn't update preferences."))})},[t,v,M,a]),F=n.useCallback(()=>{if(T){R();return}N(!0)},[T,R]),A=ci({currentUserId:o?.id??null}),{data:U,isLoading:z,isError:H,error:le,loadOlder:je,hasMore:xe,isLoadingOlder:Mt,pollWhenRealtimeDown:Ye}=Ba(t,{onInsert:A}),Xe=n.useRef(new Set);n.useEffect(()=>{if(!t||!U||U.length===0)return;const i=Xe.current,u=new Set(U.map(C=>C.id));for(const C of U)i.has(C.id)||A(C);Xe.current=u},[t,U,A]);const{draft:de,setDraft:Ce}=ti({conversationId:t,hydrate:()=>{queueMicrotask(()=>{const i=ot.current;i&&(i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,140)}px`)})}}),{sendError:rt,lastFailedPayload:Ue,failedMessages:Rt,clearBannerState:ye,onSendFailed:at,onSendRecovered:Oe,consumeLastFailedForRetry:es,consumeFailedMessageForRetry:Ne,discardFailedMessage:ke}=li({conversationId:t,setDraft:i=>Ce(i),messages:U}),K=M?.isGroup??!1,{getStatus:St}=Br(),q=n.useMemo(()=>{if(!M)return null;const i=M.participants.filter(u=>!u.isSelf);return i.length>0?i[0]:M.participants.length===1?M.participants[0]:null},[M]),Ie=n.useMemo(()=>K||!q?.id?null:St(q.id),[St,K,q?.id]),Ct=pa(K?null:q?.id??null),Fe=n.useMemo(()=>{const i=Ct.data??null,u=un(i);return u?u==="Just now"?"now":u:null},[Ct.data]),X=n.useMemo(()=>{if(I?.conversationId&&t===I.conversationId)return!0;const i=q;return i?i.username?.toLowerCase()===x:!1},[I?.conversationId,t,q,x]),be=Ai(t,X).data??null,[qe,g]=n.useState(!1),[k,O]=n.useState(null),W=n.useRef(null),Q=n.useRef(""),te=n.useRef(null),[ae,ie]=n.useState(null),fe=G.useRef({inFlight:!1,queuedMessageId:null}),me=n.useRef(null),Ze=n.useRef(null);n.useEffect(()=>()=>{W.current&&(W.current.abort(),W.current=null),me.current&&(window.clearTimeout(me.current),me.current=null),Ze.current=null},[]);const[ce,kt]=n.useState(null),It=n.useCallback(async i=>{if(!(!t||!v)){if(fe.current.inFlight){fe.current.queuedMessageId=i;return}fe.current.inFlight=!0,fe.current.queuedMessageId=null,g(!0),kt(null);try{const u="https://strhxqxvsrecfilfojtc.supabase.co",C="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0cmh4cXh2c3JlY2ZpbGZvanRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTUyNDAsImV4cCI6MjA3OTE3MTI0MH0.DZE2vpUTEqAAIMzT5GUxeV99d98RjDcG-a5IhUtasrI",{data:_}=await Y.auth.getSession(),D=_?.session?.access_token??null,P={"Content-Type":"application/json",apikey:C};D&&(P.Authorization=`Bearer ${D}`);const Re=async ue=>{const pe=await ue.text();if(!pe)return{message:`Assistant failed (${ue.status})`,code:null};try{const Z=JSON.parse(pe);return{message:Z?.message??Z?.error??Z?.details??pe,code:Z?.code??Z?.errorCode??Z?.error_code??null}}catch{return{message:pe,code:null}}},wt=(ue,pe)=>{if(ue===415)return!0;const Z=`${pe.code??""} ${pe.message??""}`.toLowerCase();return Z.includes("stream")&&Z.includes("support")},$t=async ue=>{const pe={...P,Accept:ue?"text/event-stream":"application/json"},Z=new AbortController;ue&&(W.current=Z);const ge=await fetch(`${u}/functions/v1/assistant-chat-reply`,{method:"POST",headers:pe,body:JSON.stringify({conversationId:t,userMessageId:i,stream:ue}),signal:Z.signal});if(!ge.ok){const J=await Re(ge);if(ue&&wt(ge.status,J))return{fallback:!0};throw new Error(J.message??`Assistant failed (${ge.status})`)}const Rr=ge.headers.get("Content-Type")??"";if(!ue||!Rr.includes("text/event-stream")||!ge.body){O(null),ie(null);let J=null;try{J=await ge.json()}catch{J=null}if(J&&J.ok===!1)throw new Error(J.message??J.error??"Assistant failed");try{const We=J?.messageRow;if(!y(We,{allowAppend:!0})&&(typeof J?.messageId=="string"?J.messageId:null)){const he=Se(t);a.invalidateQueries({queryKey:he})}}catch{}return{fallback:!1}}O(""),Q.current="",ie(null);const Sr=ge.body.getReader(),Cr=new TextDecoder;let vt="",xs="message",zt=[];const kr=(J,We)=>{if(J==="delta")try{const V=JSON.parse(We),ee=typeof V?.text=="string"?V.text:"";ee&&(Q.current+=ee,te.current===null&&(te.current=requestAnimationFrame(()=>{const he=Q.current;Q.current="",te.current=null,he&&O(Ht=>`${Ht??""}${he}`)})))}catch{}if(J==="done"){if(te.current!==null&&(cancelAnimationFrame(te.current),te.current=null),Q.current){const V=Q.current;Q.current="",O(ee=>`${ee??""}${V}`)}try{const V=JSON.parse(We),ee=Array.isArray(V?.citations)?V.citations.slice(0,8):null,he=V?.messageRow,Ht=typeof he?.id=="string"?he.id:typeof V?.messageId=="string"?V.messageId:null;if((Ht||ee)&&ie({messageId:Ht,citations:ee||null}),he&&typeof he=="object"&&typeof he.id=="string"){if(y(he,{allowAppend:!0})){O(null);return}try{const Ir=Se(t);a.invalidateQueries({queryKey:Ir})}catch{}}}catch{ie(null)}}if(J==="error")try{const V=JSON.parse(We);throw new Error(V?.message??"Assistant failed")}catch{throw new Error("Assistant failed")}};for(;;){const{value:J,done:We}=await Sr.read();if(We)break;vt+=Cr.decode(J,{stream:!0});let V;for(;(V=vt.indexOf(`
`))>=0;){const ee=vt.slice(0,V).replace(/\r$/,"");if(vt=vt.slice(V+1),!ee.trim()){zt.length&&(kr(xs,zt.join(`
`)),zt=[],xs="message");continue}if(ee.startsWith("event:")){xs=ee.slice(6).trim();continue}ee.startsWith("data:")&&zt.push(ee.slice(5).trimStart())}}return{fallback:!1}};(await $t(!0)).fallback&&(O(null),ie(null),await $t(!1))}catch(u){te.current!==null&&(cancelAnimationFrame(te.current),te.current=null),Q.current="",O(null),ie(null),kt({userMessageId:i,error:u?.message||"Assistant failed"})}finally{g(!1),W.current=null,a.invalidateQueries({queryKey:Se(t)}),a.invalidateQueries({queryKey:js(v)}),a.invalidateQueries({queryKey:fn(t)}),fe.current.inFlight=!1;const u=fe.current.queuedMessageId;fe.current.queuedMessageId=null,u&&u!==i&&It(u)}}},[t,v,a]),Ts=n.useCallback(i=>{!t||!v||X&&(Ze.current=i,me.current&&window.clearTimeout(me.current),me.current=window.setTimeout(()=>{const u=Ze.current;Ze.current=null,me.current=null,u&&It(u)},600))},[t,v,X,It]),kn=n.useCallback(async(i,u)=>{if(t)try{const{data:C,error:_}=await Y.functions.invoke("assistant-message-action",{body:{conversationId:t,messageId:i,actionId:u}});if(_)throw new Error(_.message||"Action failed");if(!C?.ok)throw new Error(C?.error||"Action failed");const D=C?.toast;D&&re.success(D);const P=C?.navigateTo;P&&r(P)}catch(C){const _=C instanceof Error?C.message:String(C);re.error(_||"Action failed")}finally{t&&a.invalidateQueries({queryKey:Se(t)}),v&&a.invalidateQueries({queryKey:js(v)})}},[t,v,r,a]),it=M?.title??q?.displayName??q?.username??"Conversation",As=Xr(t,{onFailed:at,onRecovered:Oe,otherUserId:K?null:q?.id??null}),et=n.useCallback((i,u)=>{ye(),As.mutate({text:i.text,attachmentPath:i.attachmentPath,attachmentKind:i.attachmentKind??null,clientId:i.clientId,tempId:u?.tempId},{onSuccess:async C=>{ye(),X&&t&&v&&(i.text.trim().length>0||i.attachmentPath)&&Ts(C.id)}})},[ye,t,v,X,Ts,As]),ot=n.useRef(null),ts=n.useRef(null),Be=n.useRef(!1),In=n.useMemo(()=>{const i=new Map;if(!M)return i;for(const u of M.participants)i.set(u.id,u);return i},[M]),{youBlocked:lt,blockedYou:oe,isBlocked:Pe,block:Et,unblock:Tt}=Zr(K?null:q?.id??null),{imageInputRef:En,attachmentInputRef:Tn,isUploadingAttachment:An,pendingAttachment:Ln,uploadError:_n,clearPendingAttachment:Dn,cancelAttachmentUpload:Un,clearUploadError:On,handleImageSelected:Fn,handleAttachmentSelected:qn,sendAttachmentFile:Bn,openImagePicker:Pn,openAttachmentPicker:$n}=ea({conversationId:t,userId:v,isBlocked:Pe,blockedYou:oe,attemptSend:et}),ct=!Pe&&!oe,ss=!!q&&!K,zn=Et.isPending||Tt.isPending,[Hn,Ls]=n.useState(!1),Kn=n.useCallback(()=>{if(ss){if(lt){Tt.mutate();return}oe||Et.mutate()}},[Et,oe,ss,Tt,lt]),ns=ss?{label:lt?"Unblock":oe?"Blocked":"Block",onClick:()=>{lt?Tt.mutate():oe||Et.mutate()}}:null,{headerRef:Qn,headerHeight:Jn,composerHeight:Wn,isAtBottom:$e,setIsAtBottom:Ee,handleComposerHeightChange:_s,showEmojiPicker:Vn,setShowEmojiPicker:At}=si({showComposer:ct}),[Gn,Lt]=n.useState(!1),[Ds,Us]=n.useState(0);n.useEffect(()=>{if(typeof window>"u")return;const i=window.visualViewport;if(!i){Us(0);return}const u=()=>{const C=Math.max(0,window.innerHeight-i.height-i.offsetTop);Us(C)};return u(),i.addEventListener("resize",u),i.addEventListener("scroll",u),window.addEventListener("orientationchange",u),()=>{i.removeEventListener("resize",u),i.removeEventListener("scroll",u),window.removeEventListener("orientationchange",u)}},[]);const Os=ct?Math.max(Wn,0)+24+Ds:40+Ds,Yn=`${Os}px`,Fs=Math.max(80,Os+32),Xn=n.useMemo(()=>M?.participants.find(i=>i.isSelf)?.displayName??"You",[M]),{remoteTypingUsers:Te,noteLocalInputActivity:Zn,stopTyping:er}=ei({conversationId:t,userId:o?.id??null,displayName:Xn}),{data:qs}=Xa(t);ri({conversationId:t,userId:o?.id??null,isAtBottom:$e===!0&&Gn,messages:U});const{reactionsByMessageId:tr,toggleReaction:Bs}=Ya(t),sr=n.useCallback((i,u)=>{Bs.mutate({messageId:i,emoji:u})},[Bs]),Ae=n.useRef(null),rs=n.useRef(!1),ze=n.useRef(null),ut=n.useRef(null),_t=n.useRef(!1),tt=n.useRef(!1),dt=n.useRef(!1),[Ps,He]=n.useState(0),ft=n.useRef(null),[Le,nr]=n.useState(null),$s=n.useRef(new Map),rr=n.useCallback(i=>{ft.current=i,nr(i)},[]),mt=n.useRef(!1),[zs,Dt]=n.useState(!0),as=n.useRef(!0),pt=ki();n.useEffect(()=>{as.current=zs},[zs]);const{activeActionMessageId:ar,openMessageActions:Hs,closeMessageActions:Ut,hiddenMessageIds:Ks,hideMessageForMe:ir,deleteDialog:Ke,openDeleteDialog:or,closeDeleteDialog:is,editingMessage:Qe,openEditDialog:lr,updateEditingText:cr,closeEditDialog:os,editTextareaRef:ur,editError:dr,setEditError:Qs}=ni({conversationId:t,currentUserId:v,showComposer:ct,isBlocked:Pe,blockedYou:oe,composerTextareaRef:ot}),Ot=za({messages:U,currentUserId:v,hiddenMessageIds:Ks}),fr=n.useMemo(()=>Ot?[Ot]:[],[Ot]),{data:mr}=Za(t,fr),Js=ii(t),Ws=oi(t),{visibleMessages:L}=$a({messages:U,conversation:M,currentUserId:v,participantsById:In,reactionsByMessageId:tr,hiddenMessageIds:Ks,deliveryReceipts:mr??[],readReceipts:qs??[],failedMessages:Rt,lastOwnMessageId:Ot});n.useEffect(()=>{const i=ae?.messageId??null;if(!i)return;if((U??[]).some(_=>String(_?.id??"")===String(i))){O(null),ie(null);return}const C=window.setTimeout(()=>{O(null),ie(null)},8e3);return()=>window.clearTimeout(C)},[ae?.messageId,U]);const ls=n.useMemo(()=>{if(!k||!t||!q?.id)return null;const i={id:`assistant_stream_${t}`,conversationId:t,senderId:q.id,createdAt:new Date().toISOString(),body:{type:"text",text:k},attachmentUrl:null,text:k},u=Array.isArray(ae?.citations)?ae?.citations:null;return u&&u.length&&(i.meta={ai:{ui:{citations:u}}}),{message:i,meta:{...Nt(i.body),streaming:!0},sender:q,isSelf:!1,deliveryStatus:null,showDeliveryStatus:!1,reactions:[]}},[k,ae,t,q]),{firstUnreadIndex:gt,lastReadMessageId:_e,hasUnread:ht,isReady:cs}=ui({conversationId:t,userId:o?.id??null,conversation:M,readReceipts:qs,visibleMessages:L}),Vs=n.useMemo(()=>{if(!cs||!ht)return 0;let i=gt;if(i==null&&typeof _e=="string"&&_e){const u=L.findIndex(C=>C.message.id===_e);i=u>=0?u+1:null}return i==null?0:L.slice(i).filter(u=>!u.isSelf&&!u.meta.deleted).length},[gt,ht,_e,cs,L]),Ft=L.length>0,xt=n.useRef(L),Gs=n.useRef(xe),Je=n.useRef(null),us=n.useRef(!1),ds=n.useRef(!1),fs=n.useRef(!1),qt=n.useMemo(()=>{if(!ls)return L;const i=ae?.messageId??null;return i&&L.some(u=>u.message.id===i)?L:[...L,ls]},[ae?.messageId,ls,L]),we=pt?"auto":"smooth",se=n.useCallback(i=>{const u=ft.current;u&&(mt.current=!0,requestAnimationFrame(()=>{u.scrollTo({top:u.scrollHeight,behavior:i??we}),requestAnimationFrame(()=>{mt.current=!1})}))},[we]),ms=n.useCallback(()=>{_t.current=!0,Dt(!0),Ee(!0),Lt(!0),se("auto")},[se,Ee]),yt=n.useCallback((i,u)=>{const C=$s.current.get(i);return C?(mt.current=!0,requestAnimationFrame(()=>{C.scrollIntoView({block:u?.align??"end",behavior:u?.behavior??we}),requestAnimationFrame(()=>{mt.current=!1})}),!0):!1},[we]);n.useEffect(()=>{xt.current=L},[L]),n.useEffect(()=>{Gs.current=xe},[xe]);const Bt=n.useRef(null),pr=n.useCallback(()=>{const i=ft.current;i&&(Bt.current={active:!0,prevScrollHeight:i.scrollHeight,prevScrollTop:i.scrollTop,prevCount:xt.current.length})},[]);G.useLayoutEffect(()=>{const i=Bt.current,u=ft.current;if(!i?.active||!u||L.length<=i.prevCount)return;const _=u.scrollHeight-i.prevScrollHeight;u.scrollTop=i.prevScrollTop+_,Bt.current=null},[L.length]),n.useEffect(()=>{tt.current=!1,ze.current=null,He(0)},[t]),n.useEffect(()=>{if(tt.current||!Ft||!ft.current)return;const i=L.length-1;i<0||(tt.current=!0,requestAnimationFrame(()=>{se("auto"),Lt(!0),Ee(!0),Dt(!0),ze.current=L[i]?.message.id??null,He(0)}))},[t,Ft,se,Le,Ee,L]),n.useEffect(()=>{const i=ut.current;if(!i)return;if(!L.some(_=>_.message.id===i)){ut.current=null;return}yt(i,{align:"end",behavior:"auto"})&&(ut.current=null)},[yt,L]);const Pt=L.length>0?L[L.length-1].message.id:null;n.useEffect(()=>{Pt&&_t.current&&(_t.current=!1,se("auto"))},[Pt,se]),n.useEffect(()=>{Pt&&tt.current&&as.current&&(Bt.current?.active||ut.current||se(we))},[Pt,we,se]),n.useEffect(()=>{const i=k!==null;i&&!ds.current&&(us.current=as.current),!i&&ds.current&&(us.current=!1),ds.current=i},[k]),G.useLayoutEffect(()=>{if(!k||!us.current)return;fs.current=!0;const i=()=>{fs.current&&(se("auto"),Je.current=requestAnimationFrame(i))};return Je.current!==null&&cancelAnimationFrame(Je.current),Je.current=requestAnimationFrame(i),()=>{fs.current=!1,Je.current!==null&&(cancelAnimationFrame(Je.current),Je.current=null)}},[k,se]),n.useEffect(()=>{if(!Le)return;const i=()=>{const _=Le.scrollHeight-Le.scrollTop-Le.clientHeight<=Fs;Dt(D=>D===_?D:_),Ee(D=>D===_?D:_),Lt(!0)};i();const u=()=>{i(),mt.current||(tt.current=!0,dt.current=!1)};return Le.addEventListener("scroll",u,{passive:!0}),()=>Le.removeEventListener("scroll",u)},[Le,Fs,Ee]),n.useEffect(()=>{const i=L.length?L[L.length-1]?.message.id??null:null;if($e===!0){ze.current=i,He(0);return}if(!i)return;const u=ze.current;if(u===i)return;const C=u?L.findIndex(P=>P.message.id===u):-1;if(u&&C<0){ze.current=i,He(0);return}const D=L.slice(Math.max(0,C+1)).filter(P=>!P.isSelf).length;D<=0||He(D)},[$e,L]),n.useEffect(()=>()=>{Ae.current!=null&&window.clearTimeout(Ae.current)},[]);const gr=()=>{const i=es();i&&et(i.payload,{tempId:i.tempId??void 0})},hr=i=>{Ae.current!=null&&window.clearTimeout(Ae.current),rs.current=!1,Ae.current=window.setTimeout(()=>{rs.current=!0,Hs(i)},500)},xr=()=>{Ae.current!=null&&(window.clearTimeout(Ae.current),Ae.current=null)},yr=n.useCallback(i=>{const u=Ne(i.id);u&&et(u,{tempId:i.id})},[et,Ne]),br=n.useCallback(i=>{ke(i.id)},[ke]),wr=n.useCallback(i=>{if(i<0)return;const u=xt.current[i]?.message.id??null;u&&yt(u,{align:"center"})},[yt]),B=Ei({items:L,onJumpToItemIndex:i=>{Be.current=!0,wr(i)},minQueryLen:f}),De=B.query.trim().length>=f;n.useEffect(()=>{B.close()},[t,B.close]);const ps=()=>{Ut(),At(!1),B.setIsOpen(!0),queueMicrotask(()=>ts.current?.focus())},bt=()=>{B.close()};n.useEffect(()=>{const i=u=>{if(u.key==="Escape"){if(B.isOpen){u.preventDefault(),bt();return}Ut(),At(!1)}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Ut,bt,B.isOpen,At]),n.useEffect(()=>{Be.current=!1},[B.query]);const gs=n.useCallback(i=>{const u=L.length-1;if(u<0)return;const C=L[u]?.message.id??null;C&&(ze.current=C),He(0),se(i??we),window.setTimeout(()=>{ot.current?.focus()},pt?0:200)},[we,pt,L,se]),vr=n.useCallback(i=>{_s(i),$e===!0&&se("auto")},[_s,$e,se]),hs=n.useCallback(async i=>{if(ht&&!dt.current){dt.current=!0;try{let u=gt;if(u==null&&typeof _e=="string"&&_e){let _=0;for(;Gs.current&&_<8;){const D=xt.current.findIndex(P=>P.message.id===_e);if(D>=0){u=D+1;break}await je(),_+=1}}if(u==null)return;const C=xt.current[u]?.message.id??null;C&&yt(C,{align:"start",behavior:i??we}),window.setTimeout(()=>{ot.current?.focus()},pt?0:150)}finally{dt.current=!1}}},[gt,ht,cs,_e,je,pt,we]),jr=n.useCallback(i=>{if(!i.trim())return;ye(),tt.current=!0,dt.current=!1,_t.current=!0;const u=ta(),C=sa();Dt(!0),Ee(!0),Lt(!0),ut.current=u,et({text:i.trim(),attachmentPath:null,clientId:C},{tempId:u})},[et,ye,Ee]);n.useEffect(()=>{ze.current=null,He(0)},[t]),n.useEffect(()=>{const i=u=>{if(u.key.toLowerCase()==="f"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),ps();return}if(u.key==="End"||u.key==="ArrowDown"&&(u.metaKey||u.ctrlKey)||u.key==="End"&&(u.metaKey||u.ctrlKey)){u.preventDefault(),gs();return}u.key.toLowerCase()==="u"&&u.altKey&&(u.preventDefault(),hs())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[gs,hs,ps]);const Nr=n.useMemo(()=>{if(oe)return"You are blocked";if(Pe)return"You blocked them";if(X){if(k!==null)return"Streamingâ€¦";if(qe||be?.is_typing||be?.is_queued)return"Typingâ€¦"}if(Te.length>0)return K?Te.length===1?`${Te[0].displayName??"Someone"} typingâ€¦`:`${Te.length} typingâ€¦`:"Typingâ€¦";if(!K&&Ie){if(Ie==="online")return d;if(Ie==="away")return b}return!K&&Fe?Fe==="now"?d:`${h} ${Fe}`:M?.subtitle||(K?"Group chat":"Direct message")},[oe,Pe,X,qe,be?.is_typing,be?.is_queued,k,K,Ie,Fe,M?.subtitle,Te,d,b,h]),Mr=n.useMemo(()=>{const i=M?.participants??[],u=new Map(i.map(D=>[D.id,D])),C=[];for(const D of Te){const P=u.get(D.userId),Re=P?.displayName??D.displayName??"Someone";C.push({id:D.userId,displayName:Re,avatarUrl:P?.avatarUrl??null})}return X&&q?.id&&(qe||be?.is_typing||be?.is_queued)&&k===null&&(C.some(P=>P.id===q.id)||C.unshift({id:q.id,displayName:q.displayName??q.username??it??"Assistant",avatarUrl:q.avatarUrl??null})),C},[qe,k,be?.is_typing,be?.is_queued,M?.participants,it,X,q,Te]);return t?e.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background",children:[e.jsxs("div",{ref:Qn,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[e.jsxs("header",{className:"flex items-center justify-between page-pad py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>r(-1),className:"icon-hit","aria-label":"Go back",children:e.jsx(ne,{name:"arrow_back"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:q?.avatarUrl?e.jsx("img",{src:q.avatarUrl,alt:q.displayName??"Conversation",className:"h-full w-full object-cover"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(q?.displayName??it).slice(0,2).toUpperCase()})}),!K&&(Ie==="online"||Fe==="now")&&e.jsx("span",{className:Ss("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:it}),e.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:Nr})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Search in conversation",onClick:()=>{B.isOpen?bt():ps()},children:e.jsx(ne,{name:"search"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Video call",onClick:()=>re.show("Video calls are coming soon."),children:e.jsx(ne,{name:"videocam"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Conversation info",onClick:()=>Ls(!0),children:e.jsx(ne,{name:"info"})}),ns?e.jsx("button",{type:"button",onClick:ns.onClick,className:"icon-hit","aria-label":ns.label,children:e.jsx(Nn,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),B.isOpen&&e.jsxs("div",{className:"page-pad pb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:e.jsx(ne,{name:"search",className:"text-muted-foreground"})}),e.jsx("input",{ref:ts,value:B.query,onChange:i=>B.setQuery(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(i.preventDefault(),!De||B.matchCount===0)return;if(i.shiftKey){Be.current=!0,B.jumpPrev();return}if(!Be.current){B.jumpToFirst(),Be.current=!0;return}B.jumpNext()}i.key==="Escape"&&(i.preventDefault(),bt())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background",autoComplete:"off",spellCheck:!1}),B.query.trim()&&e.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 icon-hit","aria-label":"Clear search",onClick:()=>{B.clear(),queueMicrotask(()=>ts.current?.focus())},children:e.jsx(ne,{name:"close"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Previous match",disabled:!De||B.matchCount===0,onClick:()=>{Be.current=!0,B.jumpPrev()},children:e.jsx(ne,{name:"keyboard_arrow_up"})}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Next match",disabled:!De||B.matchCount===0,onClick:()=>{Be.current=!0,B.jumpNext()},children:e.jsx(ne,{name:"keyboard_arrow_down"})}),e.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:De?`${B.activeMatchNumber}/${B.matchCount}`:"0/0"}),e.jsx("button",{type:"button",className:"icon-hit","aria-label":"Close search",onClick:bt,children:e.jsx(ne,{name:"close"})})]})]}),De&&B.matchCount===0&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-muted/10",children:[Ye&&e.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center page-pad",children:e.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/85 px-3 py-1 text-[12px] text-muted-foreground shadow-sm backdrop-blur",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),e.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),e.jsx(di,{items:qt,isLoading:z&&!Ft,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:H?e.jsxs("div",{className:"mb-3 rounded-2xl border border-destructive/25 bg-destructive/10 px-3 py-2 text-[12px] text-destructive",children:[e.jsx("p",{className:"font-medium text-foreground",children:"We couldn't load this conversation."}),le instanceof Error&&e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:le.message})]}):void 0,emptyContent:Ft?void 0:e.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:K?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:K?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:e.jsxs(e.Fragment,{children:[e.jsx(gi,{users:Mr}),e.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:xe?e.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:Mt?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):e.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Yn,scrollerRef:rr,onStartReached:()=>{xe&&!Mt&&(pr(),je())},computeItemKey:(i,u)=>u.message.id,itemContent:(i,u)=>{const{message:C,meta:_,sender:D,isSelf:P,deliveryStatus:Re,reactions:wt,showDeliveryStatus:$t}=u,Ys=i>0?qt[i-1]?.message??null:null,ue=i<qt.length-1?qt[i+1]?.message??null:null,pe=Z=>{const ge=$s.current;Z?ge.set(C.id,Z):ge.delete(C.id)};return e.jsx("div",{ref:pe,"data-message-id":C.id,children:e.jsx(na,{message:C,meta:_,sender:D,isSelf:P,deliveryStatus:Re,showDeliveryStatus:$t,reactions:wt,index:i,previousMessage:Ys,nextMessage:ue,firstUnreadIndex:gt,activeActionMessageId:ar,longPressTriggeredRef:rs,onOpenMessageActions:Hs,onCloseMessageActions:Ut,onOpenEditDialog:lr,onOpenDeleteDialog:or,onToggleReaction:sr,onRetryMessage:yr,onDiscardFailedMessage:br,onAssistantAction:kn,onBubbleTouchStart:hr,onBubbleTouchEndOrCancel:xr,searchQuery:De?B.query:void 0,isSearchMatch:De?B.isMatch(C.id):!1,isActiveSearchMatch:De?B.activeMessageId===C.id:!1})})}}),e.jsx(mi,{show:!!(ht&&Vs>0&&$e!==!0),unreadCount:Vs,onClick:hs,shortcutHint:"Alt+U"}),e.jsx(fi,{show:$e!==!0&&Ps>0,pendingCount:Ps,onClick:gs,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),ce&&X&&ct&&e.jsx("div",{className:"page-pad pb-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ne,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),e.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:ce.error})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const i=ce.userMessageId;kt(null),It(i)},children:[e.jsx(ne,{name:"refresh",className:"text-base"}),"Retry"]}),e.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>kt(null),children:"Dismiss"})]})]})}),e.jsx(Ni,{show:ct,headerHeight:Jn,onHeightChange:vr,typingUsers:Te,isGroupConversation:K,draft:de,setDraft:Ce,textareaRef:ot,noteLocalInputActivity:Zn,stopTyping:er,onSendText:jr,onRequestScrollToBottom:ms,isUploadingAttachment:An,pendingAttachment:Ln,clearPendingAttachment:Dn,cancelAttachmentUpload:Un,sendError:!!rt,sendErrorMessage:rt,canRetrySend:!!Ue,onRetrySend:gr,uploadError:_n,clearUploadError:On,showEmojiPicker:Vn,setShowEmojiPicker:At,openCameraPicker:Pn,openAttachmentPicker:$n,imageInputRef:En,attachmentInputRef:Tn,onImageSelected:i=>{ms(),Fn(i)},onAttachmentSelected:i=>{ms(),qn(i)},onAttachmentFile:i=>Bn(i),disableSend:!!(Pe||oe)}),oe&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Pe&&!oe&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 page-pad py-3 text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),e.jsx(Mi,{open:!!Qe,editingMessage:Qe,onOpenChange:i=>{i||os()},onCancel:os,onTextChange:cr,textareaRef:ur,error:dr,isSaving:Js.isPending,onSave:()=>{if(!Qe)return;const i=Qe.text.trim();i&&(Qs(null),Js.mutate({messageId:Qe.messageId,text:i,currentBody:Qe.body,attachmentUrl:Qe.attachmentUrl},{onSuccess:()=>{os()},onError:()=>{Qs("Couldn't save changes. Please try again.")}}))}}),e.jsx(Ri,{open:!!Ke,deleteDialog:Ke,onOpenChange:i=>{i||is()},onHideForMe:()=>{Ke&&(ir(Ke.messageId),is())},onDeleteForEveryone:()=>{Ke&&Ws.mutate({messageId:Ke.messageId,attachmentUrl:Ke.attachmentUrl},{onSettled:()=>{is()}})},isDeleting:Ws.isPending}),t&&e.jsx(Ci,{open:Hn,onOpenChange:Ls,conversation:M,currentUserId:v,conversationId:t,isMuted:T,onToggleMute:F,otherParticipant:q,isGroupConversation:K,youBlocked:lt,blockedYou:oe,blockPending:zn,onBlockToggle:Kn}),t&&e.jsx(la,{open:S,onOpenChange:N,conversationTitle:it,onSelect:i=>E(i)})]}):e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center page-pad",children:e.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Pr,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Zi as default,Xr as useSendMessage};
