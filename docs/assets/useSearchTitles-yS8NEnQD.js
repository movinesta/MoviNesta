import{T,t as A,C as x,s as $,m as E,K as R}from"./index-CuXsBKB-.js";const M=n=>{if(n?.aborted)throw n.reason??new DOMException("Aborted","AbortError")};async function k(n,t){const l=n.map(async r=>{if(r.imdbId||!r.tmdbId)return r;M(t);try{const d=await T(`/${r.type==="tv"?"tv":"movie"}/${r.tmdbId}/external_ids`,{},t);return M(t),{...r,imdbId:d?.imdb_id??null}}catch(d){return console.warn("[externalMovieSearch] Failed to fetch external ids for",r.tmdbId,d),r}});return Promise.all(l)}async function q(n,t=1,l){const r=n.trim();if(!r)return{results:[],hasMore:!1};M(l);const d=await T("/search/multi",{query:r,include_adult:!1,page:t},l);M(l);const c=Array.isArray(d?.results)?d.results:[];if(!c.length)return{results:[],hasMore:!1};const a=typeof d?.total_pages=="number"?d.total_pages:1,h=c.filter(o=>!!(o&&typeof o.id=="number"&&(o.media_type==="movie"||o.media_type==="tv"))).slice(0,20).map(o=>{const y=o.media_type==="tv"?"tv":"movie",b=o.release_date??o.first_air_date??null,u=b?Number(String(b).slice(0,4)):null;return{tmdbId:Number(o.id),imdbId:o.imdb_id??null,title:o.title??o.name??"Untitled",year:Number.isNaN(u)?null:u,type:y,posterUrl:A(o.poster_path??null)}});return{results:await k(h,l),hasMore:t<a}}const p=n=>{if(n?.aborted)throw n.reason??new DOMException("Aborted","AbortError")},w=n=>{const t=E(n);return{id:t.id,title:t.title,year:t.year,type:t.type,source:"library",posterUrl:t.posterUrl??t.backdropUrl,originalLanguage:t.originalLanguage,ageRating:t.ageRating,imdbRating:t.imdbRating,rtTomatoMeter:t.rtTomatoMeter,imdbId:t.imdbId,tmdbId:t.tmdbId}},I=20,F=5,P=async()=>{try{const{data:n}=await $.auth.getSession();return!!n?.session?.access_token}catch{return!1}},U=async(n,t,l,r)=>{p(r);try{const m=await x("media-search",{query:n.trim(),page:l,limit:I,filters:t??{}},{signal:r,timeoutMs:2e4});if(m?.ok&&Array.isArray(m.results))return p(r),{results:m.results.map(w),hasMore:!!m.hasMore}}catch(m){console.warn("[search.service] media-search Edge Function failed, falling back",m)}const d=`
    id,
    kind,
    tmdb_id,
    tmdb_title,
    tmdb_name,
    tmdb_original_title,
    tmdb_original_name,
    tmdb_release_date,
    tmdb_first_air_date,
    tmdb_poster_path,
    tmdb_backdrop_path,
    tmdb_original_language,
    tmdb_genre_ids,
    omdb_title,
    omdb_year,
    omdb_language,
    omdb_imdb_id,
    omdb_imdb_rating,
    omdb_rating_rotten_tomatoes,
    omdb_poster,
    omdb_rated
  `,c=(l-1)*I;let a=$.from("media_items").select(d,{count:"exact"});a=a.range(c,c+I-1),r&&(a=a.abortSignal(r)),n&&(a=a.textSearch("search_vector",n.trim(),{config:"english",type:"websearch"})),t?.type&&t.type!=="all"&&(a=a.eq("kind",t.type==="series"?"series":t.type)),t?.genreIds?.length&&(a=a.overlaps("tmdb_genre_ids",t.genreIds));const h=typeof t?.minYear=="number",f=typeof t?.maxYear=="number";if(h||f){const m=h?`${t.minYear}-01-01`:null,e=f?`${t.maxYear}-12-31`:null,s=[];for(const i of["tmdb_release_date","tmdb_first_air_date"])m&&e?s.push(`and(${i}.gte.${m},${i}.lte.${e})`):m?s.push(`${i}.gte.${m}`):e&&s.push(`${i}.lte.${e}`);s.length&&(a=a.or(s.join(",")))}t?.originalLanguage&&(a=a.eq("tmdb_original_language",t.originalLanguage)),a=a.order("tmdb_release_date",{ascending:!1,nullsFirst:!1}).order("tmdb_first_air_date",{ascending:!1,nullsFirst:!1}).order("tmdb_title",{ascending:!0,nullsFirst:!0});const{data:o,error:y,count:b}=await a;if(y)throw new Error(y.message);p(r);const u=o??[],g=typeof b=="number"?b:void 0,v=g?c+u.length<g:u.length===I;return{results:u.map(w),hasMore:v}},N=async n=>{const{query:t,filters:l,page:r=1,signal:d}=n,c=t.trim();p(d);let a=[],h=!1;try{const{results:e,hasMore:s}=await U(c,l,r,d);a=e,h=s}catch(e){console.warn("[search.service] Supabase search failed, falling back to TMDb",e)}const{results:f,hasMore:o}=await q(c,r,d);if(p(d),!f.length&&a.length>0)return{results:a,hasMore:h};const y=new Set,b=new Set;for(const e of a)e.tmdbId&&y.add(e.tmdbId),e.imdbId&&b.add(e.imdbId);const u=f.filter(e=>!(e.tmdbId&&y.has(e.tmdbId)||e.imdbId&&b.has(e.imdbId))),g=new Map;if(u.length&&await P()){const e=u.filter(s=>s.tmdbId).slice(0,F).map(s=>({tmdbId:s.tmdbId??null,imdbId:s.imdbId??null,contentType:s.type==="tv"?"series":"movie"}));if(e.length)try{const s=await x("catalog-sync-batch",{items:e,options:{syncOmdb:!0,forceRefresh:!1}},{signal:d,timeoutMs:2e4});s?.ok&&Array.isArray(s.results)&&s.results.forEach(i=>{if(!i?.mediaItemId||!i.tmdbId||!i.contentType)return;const _=`${i.contentType}:${i.tmdbId}`;g.set(_,i.mediaItemId)})}catch(s){console.warn("[search.service] catalog-sync-batch failed",s)}}const v=await Promise.all(u.map(async e=>{p(d);const s=e.type==="tv"?"series":"movie",i=e.tmdbId?`${s}:${e.tmdbId}`:null,_=i&&g.get(i)?g.get(i):e.tmdbId?`${e.type==="tv"?"tv":"tmdb"}-${e.tmdbId}`:`tmdb-${Math.random()}`,S=!_.startsWith("tmdb-")&&!_.startsWith("tv-");return e.tmdbId&&y.add(e.tmdbId),e.imdbId&&b.add(e.imdbId),{id:_,title:e.title,year:e.year??null,type:s,source:S?"external-synced":"external-only",posterUrl:e.posterUrl,originalLanguage:null,ageRating:null,imdbRating:null,rtTomatoMeter:null,imdbId:e.imdbId??null,tmdbId:e.tmdbId}}));return{results:[...a,...v.filter(e=>!!e)],hasMore:h||o}},D=n=>{const{query:t,filters:l}=n,r=t.trim();return R({queryKey:["search","titles",{query:r,filters:l}],enabled:r.length>0,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,initialPageParam:1,getNextPageParam:(d,c)=>d.hasMore?c.length+1:void 0,queryFn:({signal:d,pageParam:c})=>N({query:r,filters:l,page:c??1,signal:d})})};export{D as u};
