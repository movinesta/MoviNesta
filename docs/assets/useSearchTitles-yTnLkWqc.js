import{r as I,H as M,t as S,s as v,o as E,v as A,A as R}from"./index-yaS868vE.js";const U=(s,e)=>{const[o,r]=I.useState(s);return I.useEffect(()=>{const d=window.setTimeout(()=>{r(s)},e);return()=>{window.clearTimeout(d)}},[s,e]),o},y=s=>{if(s?.aborted)throw s.reason??new DOMException("Aborted","AbortError")};async function $(s,e){const o=s.map(async r=>{if(r.imdbId||!r.tmdbId)return r;y(e);try{const d=await M(`/${r.type==="tv"?"tv":"movie"}/${r.tmdbId}/external_ids`,{},e);return y(e),{...r,imdbId:d?.imdb_id??null}}catch(d){return console.warn("[externalMovieSearch] Failed to fetch external ids for",r.tmdbId,d),r}});return Promise.all(o)}async function k(s,e=1,o){const r=s.trim();if(!r)return{results:[],hasMore:!1};y(o);const d=await M("/search/multi",{query:r,include_adult:!1,page:e},o);y(o);const m=Array.isArray(d?.results)?d.results:[];if(!m.length)return{results:[],hasMore:!1};const a=typeof d?.total_pages=="number"?d.total_pages:1,_=m.filter(n=>!!(n&&typeof n.id=="number"&&(n.media_type==="movie"||n.media_type==="tv"))).slice(0,20).map(n=>{const c=n.media_type==="tv"?"tv":"movie",b=n.release_date??n.first_air_date??null,u=b?Number(String(b).slice(0,4)):null;return{tmdbId:Number(n.id),imdbId:n.imdb_id??null,title:n.title??n.name??"Untitled",year:Number.isNaN(u)?null:u,type:c,posterUrl:S(n.poster_path??null)}});return{results:await $(_,o),hasMore:e<a}}const g=s=>{if(s?.aborted)throw s.reason??new DOMException("Aborted","AbortError")},w=s=>{const e=A(s);return{id:e.id,title:e.title,year:e.year,type:e.type,source:"library",posterUrl:e.posterUrl??e.backdropUrl,originalLanguage:e.originalLanguage,ageRating:e.ageRating,imdbRating:e.imdbRating,rtTomatoMeter:e.rtTomatoMeter,imdbId:e.imdbId,tmdbId:e.tmdbId}},p=20,F=5,q=async(s,e,o,r)=>{g(r);try{const i=await E("media-search",{query:s.trim(),page:o,limit:p,filters:e??{}},{signal:r,timeoutMs:2e4});if(i?.ok&&Array.isArray(i.results))return g(r),{results:i.results.map(w),hasMore:!!i.hasMore}}catch(i){console.warn("[search.service] media-search Edge Function failed, falling back",i)}const d=`
    id,
    kind,
    tmdb_id,
    tmdb_title,
    tmdb_name,
    tmdb_original_title,
    tmdb_original_name,
    tmdb_release_date,
    tmdb_first_air_date,
    tmdb_poster_path,
    tmdb_backdrop_path,
    tmdb_original_language,
    tmdb_genre_ids,
    omdb_title,
    omdb_year,
    omdb_language,
    omdb_imdb_id,
    omdb_imdb_rating,
    omdb_rating_rotten_tomatoes,
    omdb_poster,
    omdb_rated
  `,m=(o-1)*p;let a=v.from("media_items").select(d,{count:"exact"});if(a=a.range(m,m+p-1),r&&(a=a.abortSignal(r)),s&&(a=a.textSearch("search_vector",s.trim(),{config:"english",type:"websearch"})),e?.type&&e.type!=="all"&&(a=a.eq("kind",e.type==="series"?"series":e.type)),e?.genreIds?.length&&(a=a.overlaps("tmdb_genre_ids",e.genreIds)),typeof e?.minYear=="number"){const i=`${e.minYear}-01-01`;a=a.or(`tmdb_release_date.gte.${i},tmdb_first_air_date.gte.${i}`)}if(typeof e?.maxYear=="number"){const i=`${e.maxYear}-12-31`;a=a.or(`tmdb_release_date.lte.${i},tmdb_first_air_date.lte.${i}`)}e?.originalLanguage&&(a=a.eq("tmdb_original_language",e.originalLanguage)),a=a.order("tmdb_release_date",{ascending:!1,nullsFirst:!1}).order("tmdb_first_air_date",{ascending:!1,nullsFirst:!1}).order("tmdb_title",{ascending:!0,nullsFirst:!0});const{data:_,error:h,count:n}=await a;if(h)throw new Error(h.message);g(r);const c=_??[],b=typeof n=="number"?n:void 0,u=b?m+c.length<b:c.length===p;return{results:c.map(w),hasMore:u}},D=async s=>{const{query:e,filters:o,page:r=1,signal:d}=s,m=e.trim();g(d);let a=[],_=!1;try{const{results:t,hasMore:f}=await q(m,o,r,d);a=t,_=f}catch(t){console.warn("[search.service] Supabase search failed, falling back to TMDb",t)}const{results:h,hasMore:n}=await k(m,r,d);if(g(d),!h.length&&a.length>0)return{results:a,hasMore:_};const c=new Set,b=new Set;for(const t of a)t.tmdbId&&c.add(t.tmdbId),t.imdbId&&b.add(t.imdbId);const u=h.filter(t=>!(t.tmdbId&&c.has(t.tmdbId)||t.imdbId&&b.has(t.imdbId))),i=new Map;if(u.length)try{const{data:t,error:f}=await v.from("media_items").upsert(u.slice(0,F).map(l=>({tmdb_id:l.tmdbId,omdb_imdb_id:l.imdbId??null,kind:l.type==="tv"?"series":"movie",tmdb_title:l.title,tmdb_release_date:l.year?`${l.year}-01-01`:null})),{onConflict:"kind,tmdb_id"}).select("id, tmdb_id");f&&console.error("[search.service] Failed to upsert media_items. This might be due to missing RLS permissions or schema mismatch.",f),(t??[]).forEach(l=>{l.tmdb_id!=null&&l.id&&i.set(Number(l.tmdb_id),l.id)})}catch(t){console.warn("[search.service] media_items upsert failed",t)}const T=await Promise.all(u.map(async t=>{g(d);const f=t.type==="tv"?"series":"movie",l=t.tmdbId&&i.get(t.tmdbId)?i.get(t.tmdbId):`tmdb-${t.tmdbId??Math.random()}`,x=!l.startsWith("tmdb-");return t.tmdbId&&c.add(t.tmdbId),t.imdbId&&b.add(t.imdbId),{id:l,title:t.title,year:t.year??null,type:f,source:x?"external-synced":"external-only",posterUrl:t.posterUrl,originalLanguage:null,ageRating:null,imdbRating:null,rtTomatoMeter:null,imdbId:t.imdbId??null,tmdbId:t.tmdbId}}));return{results:[...a,...T.filter(t=>!!t)],hasMore:_||n}},L=s=>{const{query:e,filters:o}=s,r=e.trim();return R({queryKey:["search","titles",{query:r,filters:o}],enabled:r.length>0,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,initialPageParam:1,getNextPageParam:(d,m)=>d.hasMore?m.length+1:void 0,queryFn:({signal:d,pageParam:m})=>D({query:r,filters:o,page:m??1,signal:d})})};export{U as a,L as u};
