import{u as de,j as e,B as Ue,b as je,c as E,s as k,d as Ae,m as De,e as Le,f as Pe,g as Te,R as c,p as q,h as $e,t as ee,q as ge,i as be,k as Fe,l as Be}from"./index-BhYCkKJ1.js";import{u as Re}from"./useDocumentTitle-DKB_EjEW.js";import{D as qe,a as Ee,b as He,c as Oe}from"./dialog-DKXGxth9.js";import{P as We}from"./plus-C69Lhyvl.js";import{S as Ke,B as ze}from"./star-BI9e52uT.js";import{S as Ve}from"./sparkles-DiUSdMk5.js";import{M as _}from"./material-icon-DzJ3uwwf.js";import{V as Ye}from"./VerifiedBadge-Bqpsp2OE.js";import{D as Ge,a as Qe,b as Je,c as Xe,d as he,e as Ze,f as Q,g as ve}from"./dropdown-menu-DgwTfZ5k.js";import{u as et,a as tt}from"./useDiaryLibrary-DjiZyGrD.js";import"./index-D2Ybm6Xt.js";const J=({icon:t,title:r,description:n,onClick:a})=>e.jsxs("button",{type:"button",onClick:a,className:"soft-row-card soft-row-card-interactive flex w-full items-center gap-3 row-pad text-left",children:[e.jsx("span",{className:"inline-flex h-10 w-10 items-center justify-center rounded-full bg-muted/80",children:t}),e.jsxs("span",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"block truncate text-sm font-semibold text-foreground",children:r}),e.jsx("span",{className:"block truncate text-xs text-muted-foreground",children:n})]})]}),st=({open:t,onOpenChange:r})=>{const n=de(),a=()=>r(!1),l=d=>{a(),n(d)};return e.jsx(qe,{open:t,onOpenChange:r,children:e.jsxs(Ee,{className:"left-0 right-0 top-auto bottom-0 w-full max-w-none translate-x-0 translate-y-0 rounded-t-3xl rounded-b-none border border-border bg-card card-pad",children:[e.jsx("div",{className:"mx-auto mb-2 h-1.5 w-12 rounded-full bg-muted","aria-hidden":!0}),e.jsx(He,{className:"pb-1",children:e.jsx(Oe,{className:"text-center text-base text-foreground",children:"Create"})}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx(J,{icon:e.jsx(We,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Log a movie",description:"Pick a title and add it to your diary",onClick:()=>l("/search")}),e.jsx(J,{icon:e.jsx(Ke,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Write a review",description:"Find a title and leave your thoughts",onClick:()=>l("/search")}),e.jsx(J,{icon:e.jsx(ze,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Create a highlight",description:"Make a new list (Top movies, etc.)",onClick:()=>l("/me?createHighlight=1")}),e.jsx(J,{icon:e.jsx(Ve,{className:"h-5 w-5 text-muted-foreground","aria-hidden":!0}),title:"Discover",description:"Explore trending picks",onClick:()=>l("/search")})]}),e.jsx("div",{className:"pt-2",children:e.jsx(Ue,{type:"button",variant:"ghost",className:"w-full rounded-2xl border border-border bg-muted/60 text-foreground hover:bg-muted",onClick:a,children:"Cancel"})})]})})},rt=t=>t.length?t.find(n=>/top\s+movies/i.test(n.name))??t[0]:null,at=()=>{const{user:t}=je();return E({queryKey:["home","stories",t?.id??null],enabled:!!t?.id,staleTime:1e3*30,queryFn:async()=>{if(!t?.id)return[];const{data:r,error:n}=await k.from("follows").select("followed_id").eq("follower_id",t.id).limit(40);if(n)throw new Error(n.message);const a=(r??[]).map(o=>o.followed_id).filter(o=>!!o),l=Array.from(new Set([t.id,...a])).slice(0,41),{data:d,error:h}=await k.from("profiles_public").select("id, username, display_name, avatar_url").in("id",l);if(h)throw new Error(h.message);const p=d??[],U=new Map(p.map(o=>[o.id,o])),H=await Promise.all(l.map(async o=>{const f=U.get(o),m=await Ae(f?.avatar_url??null);return[o,m]})),O=new Map(H),{data:P,error:W}=await k.from("lists").select("id, user_id, name, is_public, updated_at, created_at").in("user_id",l).order("updated_at",{ascending:!1}).order("created_at",{ascending:!1}).limit(240);if(W)throw new Error(W.message);const T=P??[],g=new Map;for(const o of T){const f=g.get(o.user_id)??[];f.push(o),g.set(o.user_id,f)}const A=new Map;for(const o of l){const f=g.get(o)??[],m=o===t.id?f:f.filter(K=>K.is_public),b=rt(m);b&&A.set(o,b)}const I=Array.from(new Set(Array.from(A.values()).map(o=>o.id))),S=new Map;if(I.length){const{data:o,error:f}=await k.from("list_items").select("list_id, title_id, position, created_at").in("list_id",I).order("position",{ascending:!0}).order("created_at",{ascending:!0}).limit(400);f&&console.warn("[useHomeStories] Failed to load list_items",f.message);for(const m of o??[])!m?.list_id||!m?.title_id||S.has(m.list_id)||S.set(m.list_id,m.title_id)}const $=Array.from(new Set(Array.from(S.values()))),F=new Map;if($.length){const{data:o,error:f}=await k.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",$);if(f)console.warn("[useHomeStories] Failed to load media_items",f.message);else for(const m of o??[]){const b=De(m);F.set(m.id,b.posterUrl??b.backdropUrl??null)}}return[t.id,...l.filter(o=>o!==t.id)].map(o=>{const f=U.get(o),m=A.get(o),b=m?S.get(m.id)??null:null;return{userId:o,username:f?.username??null,displayName:f?.display_name??null,avatarUrl:O.get(o)??null,listId:m?.id??null,listName:m?.name??null,coverPosterUrl:b?F.get(b)??null:null}}).filter(o=>!!(o.username||o.displayName))}})},it=t=>t==="identity"||t==="official"||t==="trusted_verifier"||t==="subscription"?t:null;function nt(t){const r=t?.releaseYear?String(t.releaseYear):null,a=(Array.isArray(t?.genres)?t?.genres:[])[0]??null;return a&&r?`${a} • ${r}`:a||r||(t?.kind?t.kind:"Title")}function lt(t){const r=typeof t?.imdbRating=="number"?t.imdbRating:null,n=typeof t?.rtTomatoMeter=="number"?t.rtTomatoMeter:null,a=r!=null?r/2:null,l=n!=null?n/20:null,d=a??l;return d==null?void 0:Math.max(0,Math.min(5,d)).toFixed(1)}function ne(t){const r=(t?.mediaItemId??"").toString(),n=(t?.title??"").toString().trim();if(!r||!n)return null;const a=t?.kind==="movie"||t?.kind==="series"||t?.kind==="anime"?t.kind:null,l=(t?.posterUrl&&t.posterUrl.trim()?t.posterUrl:null)??(t?.tmdbPosterPath?ee(t.tmdbPosterPath,"w500"):null);return{id:r,title:n,subtitle:nt(t),rating:lt(t),imageUrl:l,kind:a}}function we(t){const r=[];t.year&&r.push(String(t.year)),t.type&&t.type!=="other"&&t.type!=="episode"&&r.push(t.type==="series"?"Series":t.type==="anime"?"Anime":"Movie");const n=r.join(" • ")||"In your diary";return{id:t.titleId,title:t.title,subtitle:n,rating:t.rating!=null?String(t.rating):void 0,imageUrl:t.posterUrl??null,kind:t.type??null}}async function ot(t){const{sessionId:r,mode:n,limit:a}=t,l=Fe(r,n,null);return Be({sessionId:r,mode:n,limit:a,seed:l})}function dt(t=new Date){const r=t.getHours();return r>=5&&r<12?"Good Morning":r>=12&&r<18?"Good Afternoon":"Good Evening"}function le(t,r){const n=(t||r||"").replace(/^@/,"").trim();if(!n)return"?";const a=n.split(/\s+/);return a.length===1?a[0].slice(0,2).toUpperCase():(a[0][0]+a[1][0]).toUpperCase()}const oe=({icon:t,label:r,onClick:n,showDot:a,badgeCount:l})=>{const d=typeof l=="number"&&l>0?l:0,h=d>9?"9+":String(d);return e.jsxs("button",{type:"button",onClick:n,className:"relative inline-flex h-11 w-11 items-center justify-center rounded-full text-foreground transition-colors hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":r,children:[e.jsx(_,{name:t,className:"text-[22px]",ariaLabel:r}),d?e.jsx("span",{className:"absolute -right-0.5 -top-0.5 inline-flex min-w-[18px] items-center justify-center rounded-full bg-primary px-1.5 py-0.5 text-[10px] font-bold leading-none text-primary-foreground shadow","aria-label":`${d} new items`,children:h}):a?e.jsx("span",{className:"absolute right-2.5 top-2.5 h-2 w-2 rounded-full bg-primary"}):null]})},X=({title:t,actionLabel:r="See All",onAction:n})=>e.jsxs("div",{className:"flex items-center justify-between page-pad pb-3",children:[e.jsx("h2",{className:"type-heading text-foreground",children:t}),n?e.jsx("button",{type:"button",onClick:n,className:"type-caption font-semibold text-primary transition-colors hover:text-primary/80",children:r}):null]}),Z=({item:t,onClick:r,menu:n})=>{const a=l=>{r&&(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),r())};return e.jsx("div",{className:"group flex flex-col gap-1 text-left",children:e.jsxs("div",{role:"button",tabIndex:0,onClick:r,onKeyDown:a,"aria-label":t.title,className:"outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:[e.jsxs("div",{className:"relative aspect-[2/3] w-full overflow-hidden rounded-xl bg-muted shadow",children:[t.imageUrl?e.jsx("img",{src:t.imageUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-muted to-muted/40"}),e.jsx("div",{className:"absolute inset-0 opacity-0 transition-opacity duration-200 group-hover:opacity-100 bg-gradient-to-t from-black/60 via-black/10 to-transparent"}),t.rating?e.jsxs("div",{className:"absolute left-2 top-2 inline-flex items-center gap-1 rounded-full bg-black/55 px-1.5 py-1 text-[10px] font-bold text-yellow-400",children:[e.jsx(_,{name:"star",filled:!0,className:"text-[14px]",ariaLabel:"Rating"}),e.jsx("span",{children:t.rating})]}):null,n?e.jsx("div",{className:"absolute right-2 top-2 z-20",children:n}):null]}),e.jsxs("div",{className:"min-w-0 pt-1",children:[e.jsx("h4",{className:"truncate text-sm font-bold text-foreground",children:t.title}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:t.subtitle})]})]})})},ye=({item:t,onClick:r,menu:n})=>{const a=l=>{r&&(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),r())};return e.jsx("div",{className:"group w-full text-left",children:e.jsx("div",{role:"button",tabIndex:0,onClick:r,onKeyDown:a,"aria-label":t.title,className:"outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:e.jsxs("div",{className:"relative aspect-[2/3] w-full overflow-hidden rounded-3xl bg-muted shadow-lg",children:[t.imageUrl?e.jsx("img",{src:t.imageUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-muted to-muted/40"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent opacity-80"}),t.rating?e.jsxs("div",{className:"absolute left-4 top-4 inline-flex items-center gap-1 rounded-full bg-black/55 px-2 py-1 text-xs font-bold text-yellow-400",children:[e.jsx(_,{name:"star",filled:!0,className:"text-[16px]",ariaLabel:"Rating"}),e.jsx("span",{children:t.rating})]}):null,n?e.jsx("div",{className:"absolute right-4 top-4 z-20",children:n}):null,e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white drop-shadow",children:t.title}),e.jsx("p",{className:"mt-1 text-sm text-white/80",children:t.subtitle})]})]})})})},ct=({item:t,currentStatus:r,onSetStatus:n,onOpenDetails:a,onRateAndReview:l})=>e.jsxs(Ge,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx("button",{type:"button",onClick:d=>d.stopPropagation(),className:"icon-hit-dark bg-black/45 hover:bg-black/55 backdrop-blur","aria-label":"More actions",children:e.jsx(_,{name:"more_vert",className:"text-[20px]",ariaLabel:"More"})})}),e.jsxs(Je,{align:"end",sideOffset:8,className:"w-56",children:[e.jsx(Xe,{className:"truncate",children:t.title}),e.jsx(he,{}),e.jsxs(Ze,{value:r??"none",onValueChange:d=>{d!=="none"&&n(d)},children:[e.jsx(Q,{value:"want_to_watch",children:"Watchlist"}),e.jsx(Q,{value:"watching",children:"Watching"}),e.jsx(Q,{value:"watched",children:"Watched"}),e.jsx(Q,{value:"dropped",children:"Dropped"})]}),e.jsx(he,{}),e.jsx(ve,{onSelect:d=>{d.preventDefault(),l()},children:"Rate & review"}),e.jsx(ve,{onSelect:d=>{d.preventDefault(),a()},children:"Open details"})]})]}),ut=t=>{switch(t.kind){case"friend-rating":return"rated";case"friend-review":return"reviewed";case"friend-watched":return"watched";case"watchlist-add":return"added to watchlist";case"watchlist-remove":return"removed from watchlist";case"recommendation":return"recommended";default:return""}},mt=({item:t})=>{const r=de(),n=t.title.posterUrl??null,a=t.kind==="friend-review"||t.kind==="friend-rating"?t.reviewSnippet??null:null,l=t.kind==="watchlist-add"?t.note??null:null,d=t.kind==="recommendation"?t.reason??null:null;let h=null;(t.kind==="friend-rating"||t.kind==="friend-review"||t.kind==="friend-watched")&&(h=typeof t.rating=="number"?t.rating:null);const p=()=>r(`/title/${t.title.id}`),U=()=>r(`/title/${t.title.id}/reviews`);return e.jsxs("div",{className:"flex gap-4 rounded-3xl border border-border/40 bg-card/70 p-4 shadow-sm",children:[e.jsx("div",{className:"h-10 w-10 shrink-0 overflow-hidden rounded-full bg-muted ring-1 ring-border/40",children:t.user.avatarUrl?e.jsx("img",{src:t.user.avatarUrl,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("div",{className:"grid h-full w-full place-items-center text-[10px] font-semibold text-muted-foreground",children:t.user.displayName.slice(0,2).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-1",children:[e.jsx("p",{className:"truncate text-sm font-bold text-foreground",children:t.user.displayName}),e.jsx(Ye,{isVerified:t.user.isVerified,type:it(t.user.verifiedType),label:t.user.verifiedLabel,verifiedAt:t.user.verifiedAt,org:t.user.verifiedOrg,className:"shrink-0 rounded-full p-0.5 text-primary/90 hover:text-primary"})]}),e.jsxs("p",{className:"mt-0.5 text-xs text-muted-foreground",children:[ut(t)," ",e.jsx("span",{className:"font-semibold text-foreground",children:t.title.name})]})]}),e.jsx("p",{className:"shrink-0 text-xs text-muted-foreground",children:t.relativeTime})]}),a?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:a}):null,l?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:l}):null,d?e.jsx("p",{className:"mt-3 text-sm leading-relaxed text-foreground/90",children:d}):null,e.jsxs("button",{type:"button",onClick:p,className:"soft-row-card soft-row-card-interactive mt-3 flex w-full min-h-11 items-center gap-3 p-2 text-left focus-visible:outline-none","aria-label":`Open ${t.title.name}`,children:[e.jsx("div",{className:"h-14 w-10 shrink-0 overflow-hidden rounded-lg bg-muted",children:n?e.jsx("img",{src:n,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-primary/40 via-background/20 to-primary/60"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"truncate text-xs font-bold text-foreground",children:t.title.name}),e.jsx("p",{className:"mt-0.5 text-[11px] text-muted-foreground",children:t.title.mediaType??"title"}),h!=null?e.jsxs("div",{className:"mt-1 inline-flex items-center gap-1 text-[11px] font-semibold text-yellow-400",children:[e.jsx(_,{name:"star",filled:!0,className:"text-[14px]",ariaLabel:"Rating"}),e.jsxs("span",{children:[h,"/5"]})]}):null]})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:p,className:"inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-xs font-bold text-primary-foreground transition hover:bg-primary/90",children:"Open"}),e.jsx("button",{type:"button",onClick:U,className:"inline-flex items-center justify-center rounded-full bg-white/5 px-4 py-2 text-xs font-bold text-foreground ring-1 ring-border/50 transition hover:bg-white/10",children:"Reviews"})]})]})]})},ft=()=>e.jsx("div",{className:"space-y-3",children:[0,1].map(t=>e.jsx("div",{className:"rounded-3xl border border-border/40 bg-card/60 p-4 shadow-sm",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-10 w-10 animate-pulse rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-3 w-40 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"h-3 w-56 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"h-14 w-full animate-pulse rounded-2xl bg-muted"})]})]})},`friends-activity-skeleton-${t}`))}),_t=()=>{Re("Home");const t=de(),r=Le(),{user:n}=je(),a=n?.id??null,{data:l}=Pe(),{data:d,isLoading:h}=at(),{items:p,isLoading:U,error:H,hasMore:O,isLoadingMore:P,loadMore:W}=Te(),{updateStatus:T}=et(),{entries:g,isLoading:A}=tt({status:"all",type:"all"}),I=c.useMemo(()=>new Map(g.map(s=>[s.titleId,s.status])),[g]),S=c.useMemo(()=>new Map(g.map(s=>[s.titleId,s.type??null])),[g]),$=c.useMemo(()=>g.filter(s=>s.status==="watching").slice(0,12).map(we),[g]),F=c.useMemo(()=>g.filter(s=>s.status==="want_to_watch").slice(0,12).map(we),[g]),te="home:lastSeenActivityAt",[o,f]=c.useState(()=>{try{return localStorage.getItem(te)}catch{return null}}),m=c.useMemo(()=>{if(!p.length)return 0;if(!o)return p.length;const s=new Date(o).getTime();return Number.isNaN(s)?p.length:p.filter(i=>new Date(i.createdAt).getTime()>s).length},[p,o]),b=c.useCallback(s=>{switch(s){case"want_to_watch":return"Watchlist";case"watching":return"Watching";case"watched":return"Watched";case"dropped":return"Dropped";default:return"Saved"}},[]),K=c.useCallback(async(s,i)=>{if(!a){q({title:"Sign in required",description:"Create an account to save titles.",variant:"info"});return}const u=s.kind??S.get(s.id)??null;if(!u){q({title:"Couldn't save",description:"This title is missing a content type.",variant:"error"});return}const v=I.get(s.id)??null;try{await T.mutateAsync({titleId:s.id,status:i,type:u,title:s.title,posterUrl:s.imageUrl??null}),q({title:"Saved",description:v?`Moved to ${b(i)}.`:`Added to ${b(i)}.`,variant:"success",action:v?{label:"Undo",onClick:()=>T.mutate({titleId:s.id,status:v,type:u,title:s.title,posterUrl:s.imageUrl??null})}:void 0})}catch(y){q({title:"Update failed",description:y?.message??"Please try again.",variant:"error"})}},[I,b,S,T,a]),C=c.useCallback(s=>s?.id?e.jsx(ct,{item:s,currentStatus:I.get(s.id)??null,onSetStatus:i=>K(s,i),onOpenDetails:()=>t(`/title/${s.id}`),onRateAndReview:()=>t(`/title/${s.id}/reviews?compose=1`)}):null,[t,K,I]),Ne=c.useMemo(()=>$e(),[]),{data:D,isLoading:B,error:M}=E({queryKey:["home-v2","deck","combined",a],enabled:!!a,queryFn:()=>ot({sessionId:Ne,mode:"combined",limit:60}),staleTime:10*6e4,gcTime:30*6e4,refetchOnWindowFocus:!1,refetchOnReconnect:!0}),j=c.useMemo(()=>D?.cards?.[0]??null,[D?.cards]),x=c.useMemo(()=>ne(j),[j]),w=x?.id??null,{data:L}=E({queryKey:["home-v2","hero-details",w],enabled:!!w,queryFn:async()=>{const{data:s,error:i}=await k.from("media_items").select("id, tmdb_overview, omdb_plot, tmdb_backdrop_path, tmdb_poster_path, tmdb_title, tmdb_name, omdb_title").eq("id",w).maybeSingle();if(i)throw i;return s??null},staleTime:5*6e4}),ce=c.useMemo(()=>(L?.tmdb_overview||L?.omdb_plot||"").trim()||null,[L?.tmdb_overview,L?.omdb_plot]),se=c.useMemo(()=>{const s=ee(L?.tmdb_backdrop_path??null,"w1280"),i=j?.tmdbBackdropPath?ee(j.tmdbBackdropPath,"w1280"):null,u=j?.tmdbPosterPath?ee(j.tmdbPosterPath,"w780"):null;return s??i??u??x?.imageUrl??null},[L?.tmdb_backdrop_path,j,x?.imageUrl]),{data:ke}=E({queryKey:["home-v2","recent-watched",a],enabled:!!a,queryFn:async()=>{const{data:s,error:i}=await k.from("library_entries").select("title_id, updated_at").eq("user_id",a).eq("status","watched").order("updated_at",{ascending:!1}).limit(1);if(i)throw i;return s?.[0]?.title_id??null},staleTime:6e4}),R=ke??w,{data:z}=E({queryKey:["home-v2","seed-item",R],enabled:!!R,queryFn:async()=>{const{data:s,error:i}=await k.from("media_items").select("id, tmdb_title, tmdb_name, omdb_title").eq("id",R).maybeSingle();if(i)throw i;return s??null},staleTime:5*6e4}),ue=c.useMemo(()=>[z?.tmdb_title,z?.tmdb_name,z?.omdb_title,x?.title].map(i=>typeof i=="string"?i.trim():"").find(i=>!!i)??null,[z,x?.title]),N=c.useMemo(()=>{const s=D?.cards??[],i=y=>String(y??"").trim().toLowerCase().replace(/-+/g,"_"),u=[],v=[];for(const y of s){const ie=i(y?.source);ie==="for_you"&&v.push(y),(ie==="trending"||ie==="popular")&&u.push(y)}return{trending:u,forYou:v}},[D?.cards]),V=c.useMemo(()=>{const s=new Set;return w&&s.add(w),(N.trending.length?N.trending:D?.cards??[]).filter(u=>u?.mediaItemId&&!s.has(u.mediaItemId)).map(ne).filter(Boolean)},[N.trending,D?.cards,w]),Y=V[0]??null,_e=V.slice(1,7),me=c.useMemo(()=>{const s=new Set;w&&s.add(w);const u=(N.forYou.length?N.forYou:N.trending).filter(v=>v?.mediaItemId&&!s.has(v.mediaItemId)).map(ne).filter(Boolean);return u.length?u:V},[N.forYou,N.trending,V,w]),G=me[0]??null,Ie=me.slice(1,7),[Se,fe]=c.useState(!1),pe=l?.displayName||l?.username||(l?"You":""),Ce=c.useMemo(()=>dt(),[]),xe=c.useMemo(()=>{const s=d??[],i=n?.id??null;return i?s.filter(u=>u.userId!==i):s},[n?.id,d]),Me=c.useCallback(()=>{a&&(q({title:"Refreshing…",description:"Updating your Home feed.",variant:"info",durationMs:1200}),r.invalidateQueries({queryKey:["home-v2"]}),r.invalidateQueries({queryKey:["home","stories",a]}),r.invalidateQueries({queryKey:ge.homeFeed(a)}),r.invalidateQueries({queryKey:ge.diaryLibrary(a)}))},[r,a]),[re,ae]=c.useState(3);return c.useEffect(()=>{ae(3)},[a]),e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx("header",{className:"sticky top-0 z-30 border-b border-border bg-background/85 backdrop-blur full-bleed",children:e.jsxs("div",{className:"mx-auto flex w-full max-w-5xl items-center justify-between page-pad py-3",children:[e.jsxs("button",{type:"button",onClick:()=>t("/me"),className:"flex items-center gap-3 rounded-2xl p-1 pr-2 transition-colors hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Open profile",children:[e.jsx("span",{className:"relative inline-flex h-10 w-10 overflow-hidden rounded-full ring-2 ring-primary/20",children:l?.avatarUrl?e.jsx("img",{src:l.avatarUrl,alt:pe||"Profile",className:"h-full w-full object-cover"}):e.jsx("span",{className:"grid h-full w-full place-items-center bg-muted text-[10px] font-semibold text-foreground",children:le(l?.displayName,l?.username)})}),e.jsxs("span",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:Ce}),e.jsx("span",{className:"text-lg font-bold leading-none tracking-tight text-foreground",children:pe||""})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{icon:"search",label:"Search",onClick:()=>t("/search")}),e.jsx(oe,{icon:"refresh",label:"Refresh",onClick:Me}),e.jsx(oe,{icon:"notifications",label:"Notifications",onClick:()=>{const s=new Date().toISOString();try{localStorage.setItem(te,s)}catch{}f(s),t("/activity")},badgeCount:m})]})]})}),e.jsx("section",{className:"page-pad",children:e.jsxs("div",{className:"rounded-3xl border border-border/60 bg-card/70 py-4 shadow-sm",children:[e.jsx("div",{className:"page-pad pb-2",children:e.jsx("h3",{className:"text-xs font-bold tracking-wider text-muted-foreground/80",children:"HAPPENING NOW"})}),e.jsxs("div",{className:"no-scrollbar flex w-full gap-3 overflow-x-auto page-pad py-1",children:[e.jsxs("button",{type:"button",onClick:()=>t("/me?createHighlight=1"),className:"flex min-w-[72px] flex-col items-center gap-2 rounded-2xl p-1 transition hover:bg-muted/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":"Add new highlight",children:[e.jsx("span",{className:"grid h-16 w-16 place-items-center rounded-full border-2 border-dashed border-muted-foreground/50",children:e.jsx(_,{name:"add",className:"text-[22px] text-muted-foreground"})}),e.jsx("span",{className:"w-[72px] truncate text-center text-xs font-medium text-muted-foreground",children:"Add New"})]}),h?Array.from({length:5}).map((s,i)=>e.jsxs("div",{className:"flex min-w-[72px] flex-col items-center gap-2",children:[e.jsx("div",{className:"h-16 w-16 animate-pulse rounded-full bg-muted"}),e.jsx("div",{className:"h-3 w-16 animate-pulse rounded bg-muted"})]},`story-skel-${i}`)):xe.length?xe.map(s=>{const i=s.displayName||s.username||"Someone",u=s.listName||"",v=s.listId?`/lists/${s.listId}`:s.username?`/u/${s.username}`:"/me",y=u?`${i} • ${u}`:i;return e.jsxs("button",{type:"button",onClick:()=>t(v),className:"flex w-[92px] shrink-0 flex-col items-center gap-2 rounded-2xl p-1 transition hover:bg-muted/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background","aria-label":y,children:[e.jsx("span",{className:"rounded-full bg-gradient-to-tr from-primary to-fuchsia-400 p-[2px]",children:e.jsxs("span",{className:"relative inline-flex h-[68px] w-[68px] items-center justify-center overflow-hidden rounded-full border-2 border-background bg-muted",children:[s.coverPosterUrl?e.jsx("img",{src:s.coverPosterUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover"}):s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:"",loading:"lazy",decoding:"async",className:"h-full w-full object-cover"}):e.jsx("span",{className:"text-xs font-semibold text-muted-foreground",children:le(s.displayName,s.username)}),e.jsx("span",{className:"absolute inset-0 bg-gradient-to-t from-black/55 via-black/10 to-transparent"}),e.jsx("span",{className:"absolute bottom-0 right-0 inline-flex h-8 w-8 overflow-hidden rounded-full border-2 border-background bg-muted",children:s.avatarUrl?e.jsx("img",{src:s.avatarUrl,alt:"",loading:"lazy",className:"h-full w-full object-cover"}):e.jsx("span",{className:"grid h-full w-full place-items-center text-[10px] font-semibold text-muted-foreground",children:le(s.displayName,s.username)})})]})}),e.jsxs("span",{className:"w-[92px]",children:[e.jsx("span",{className:"block truncate text-center text-xs font-semibold text-foreground",children:i}),u?e.jsx("span",{className:"block truncate text-center text-[10px] text-muted-foreground",children:u}):null]})]},`${s.userId}:${s.listId??"none"}`)}):e.jsx("div",{className:"flex items-center text-xs text-muted-foreground",children:"Follow people to see highlights."})]})]})}),e.jsx("section",{className:"page-pad",children:e.jsxs("div",{className:"group relative overflow-hidden rounded-3xl bg-card shadow-lg",children:[e.jsx("div",{className:"absolute inset-0 bg-cover bg-center",style:se?{backgroundImage:`url(${se})`}:void 0,"aria-hidden":!0}),se?null:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/35 via-background/30 to-primary/55"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/35 to-transparent"}),e.jsxs("div",{className:"relative z-10 flex min-h-[420px] flex-col justify-end p-5",children:[e.jsxs("div",{className:"mb-2 inline-flex items-center gap-2",children:[e.jsx("span",{className:"rounded-full bg-white/15 px-2.5 py-1 text-[10px] font-bold uppercase tracking-wider text-white backdrop-blur",children:"Top Pick"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:M?"Couldn't load recommendations":j?.why??"Recommended for you"})]}),e.jsx("h2",{className:"mb-2 text-3xl font-bold leading-tight tracking-tight text-white",children:a&&!x?.title&&B?e.jsx("span",{className:"block h-10 w-2/3 animate-pulse rounded bg-white/15"}):x?.title?x.title:a?"":"Sign in to get recommendations"}),ce?e.jsx("p",{className:"mb-4 line-clamp-2 text-sm text-white/80",children:ce}):null,e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>{x?.id?t(`/title/${x.id}`):t("/search")},className:be("flex h-12 flex-1 items-center justify-center gap-2 rounded-full bg-primary text-base font-bold text-primary-foreground shadow-lg","transition-all hover:bg-primary/90 active:scale-[0.98]","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background"),disabled:!x?.id,children:[e.jsx(_,{name:"play_arrow",filled:!0,className:"text-[20px]",ariaLabel:"Play"}),"View"]}),e.jsxs("button",{type:"button",onClick:()=>fe(!0),className:be("flex h-12 w-32 items-center justify-center gap-1 rounded-full bg-white/10 text-white shadow-lg backdrop-blur","transition-colors hover:bg-white/20","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background"),children:[e.jsx(_,{name:"add",className:"text-[22px]",ariaLabel:"Add"}),e.jsx("span",{className:"text-sm font-bold",children:"Add"})]}),x?.id?e.jsx("div",{className:"shrink-0",children:C(x)}):null]})]})]})}),a?e.jsxs("section",{className:"mt-6",children:[e.jsx(X,{title:"Continue Watching",actionLabel:"Diary",onAction:()=>t("/diary")}),e.jsx("div",{className:"no-scrollbar flex gap-3 overflow-x-auto page-pad pb-1",children:A?Array.from({length:8}).map((s,i)=>e.jsxs("div",{className:"w-32 shrink-0",children:[e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"}),e.jsx("div",{className:"mt-2 h-3 w-3/4 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-1/2 animate-pulse rounded bg-muted"})]},`cw-skel-${i}`)):$.length?$.map(s=>e.jsx("div",{className:"w-32 shrink-0",children:e.jsx(Z,{item:s,onClick:()=>t(`/title/${s.id}`),menu:C(s)})},`cw-${s.id}`)):e.jsxs("div",{className:"w-full rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:["Mark a show or movie as ",e.jsx("span",{className:"font-semibold",children:"Watching"})," to see it here."]})})]}):null,a?e.jsxs("section",{className:"mt-6",children:[e.jsx(X,{title:"Up Next",actionLabel:"Watchlist",onAction:()=>t("/diary")}),e.jsx("div",{className:"no-scrollbar flex gap-3 overflow-x-auto page-pad pb-1",children:A?Array.from({length:8}).map((s,i)=>e.jsxs("div",{className:"w-32 shrink-0",children:[e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"}),e.jsx("div",{className:"mt-2 h-3 w-3/4 animate-pulse rounded bg-muted"}),e.jsx("div",{className:"mt-1 h-3 w-1/2 animate-pulse rounded bg-muted"})]},`upnext-skel-${i}`)):F.length?F.map(s=>e.jsx("div",{className:"w-32 shrink-0",children:e.jsx(Z,{item:s,onClick:()=>t(`/title/${s.id}`),menu:C(s)})},`upnext-${s.id}`)):e.jsxs("div",{className:"w-full rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:["Add titles to your ",e.jsx("span",{className:"font-semibold",children:"Watchlist"})," to build your queue."]})})]}):null,e.jsxs("section",{children:[e.jsx(X,{title:"Trending Now",onAction:()=>t("/search")}),e.jsx("div",{className:"page-pad",children:M?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:M.message?M.message:"Couldn't load trending titles."}):B?e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-3xl bg-muted"}):Y?e.jsx(ye,{item:Y,onClick:()=>t(`/title/${Y.id}`),menu:C(Y)}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"No trending titles yet."})}),e.jsx("div",{className:"grid grid-cols-2 gap-x-4 gap-y-6 page-pad pt-6",children:B?Array.from({length:6}).map((s,i)=>e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"},`trending-skel-${i}`)):_e.map(s=>e.jsx(Z,{item:s,onClick:()=>t(`/title/${s.id}`),menu:C(s)},s.id))})]}),e.jsxs("section",{className:"page-pad",children:[e.jsx("h2",{className:"pb-2 text-xl font-bold tracking-tight text-foreground",children:"Friends' Activity"}),H?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:H}):null,U?e.jsx(ft,{}):p.length?e.jsxs("div",{className:"space-y-3",children:[p.slice(0,re).map(s=>e.jsx(mt,{item:s},s.id)),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[p.length>re||O?e.jsx("button",{type:"button",onClick:()=>{const s=re+3;if(s<=p.length){ae(s);return}O&&!P&&(W(),ae(s))},className:"inline-flex items-center justify-center rounded-full bg-white/5 px-4 py-2 text-xs font-bold text-foreground ring-1 ring-border/50 transition hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:opacity-60",disabled:P,children:P?"Loading…":"Load more"}):null,e.jsx("button",{type:"button",onClick:()=>t("/activity"),className:"inline-flex items-center justify-center rounded-full bg-primary px-4 py-2 text-xs font-bold text-primary-foreground transition hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-offset-2 focus-visible:ring-offset-background",children:"See all"})]})]}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"Your friends’ activity will show up here once they start rating, reviewing, or marking titles watched."})," "]}),e.jsxs("section",{children:[e.jsx(X,{title:ue?`Because you watched ${ue}`:"More for you",onAction:()=>{t(R?`/title/${R}`:"/search")}}),e.jsx("div",{className:"page-pad",children:M?e.jsx("div",{className:"rounded-2xl border border-destructive/40 bg-destructive/10 p-3 text-xs text-destructive",children:M.message?M.message:"Couldn't load recommendations."}):B?e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-3xl bg-muted"}):G?e.jsx(ye,{item:G,onClick:()=>t(`/title/${G.id}`),menu:C(G)}):e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-card/60 p-4 text-sm text-muted-foreground",children:"No recommendations yet."})}),e.jsx("div",{className:"grid grid-cols-2 gap-x-4 gap-y-6 page-pad pt-6 pb-2",children:B?Array.from({length:6}).map((s,i)=>e.jsx("div",{className:"aspect-[2/3] w-full animate-pulse rounded-xl bg-muted"},`because-skel-${i}`)):Ie.map(s=>e.jsx(Z,{item:s,onClick:()=>t(`/title/${s.id}`),menu:C(s)},s.id))})]}),e.jsx(st,{open:Se,onOpenChange:fe})]})};export{_t as default};
