import{u as te,J as se,H as re,R as g,c as O,a8 as ae,j as e,B,i as ne,L as ie,D as oe,e as le,b as de,x as ce,q as Z,h as ue,s as C,aJ as me,G as xe}from"./index-n01z0Q-I.js";import{R as W,S as L}from"./skeleton-BoUU6iSb.js";import{M as R}from"./material-icon-ik9c9RPC.js";import{V as ge}from"./VerifiedBadge-BK7Fjn_d.js";import{D as fe,a as be,b as pe,c as he}from"./dialog-xEYVlW9E.js";import{I as ve}from"./input-CjdTaUCP.js";import{T as _e}from"./textarea-YFcVWJTl.js";function z(s){try{return Intl.NumberFormat(void 0,{notation:"compact",maximumFractionDigits:1}).format(s)}catch{return String(s)}}function je(...s){return s.map(n=>typeof n=="string"?n.trim():"").find(n=>!!n)||"Reviews"}function ye(s){const r=new Date(s),n=Date.now(),o=Math.max(0,n-r.getTime()),a=Math.floor(o/6e4);if(a<1)return"Just now";if(a<60)return`${a}m ago`;const c=Math.floor(a/60);if(c<24)return`${c}h ago`;const u=Math.floor(c/24);if(u<7)return`${u}d ago`;const p=Math.floor(u/7);if(p<5)return`${p}w ago`;const m=Math.floor(u/30);return m<12?`${m}mo ago`:`${Math.floor(u/365)}y ago`}function Ne(){return e.jsx("div",{className:"full-bleed h-px bg-border/60"})}function Y({children:s,label:r,onClick:n}){return e.jsx("button",{type:"button","aria-label":r,onClick:n,className:"flex size-11 items-center justify-center rounded-full border border-border/60 bg-muted/60 text-foreground backdrop-blur-md transition hover:bg-muted active:scale-[0.98]",children:s})}function we({summary:s}){const r=[{star:5,count:s.stars_5},{star:4,count:s.stars_4},{star:3,count:s.stars_3},{star:2,count:s.stars_2},{star:1,count:s.stars_1}],n=r.reduce((o,a)=>o+a.count,0);return e.jsx("div",{className:"grid grid-cols-[12px_1fr_38px] items-center gap-x-3 gap-y-2",children:r.map(o=>{const a=n?Math.round(o.count/n*100):0;return e.jsxs(g.Fragment,{children:[e.jsx("p",{className:"text-xs font-medium text-foreground",children:o.star}),e.jsx("div",{className:"flex h-1.5 flex-1 overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"rounded-full bg-primary",style:{width:`${a}%`,opacity:.2+o.star/5*.8}})}),e.jsxs("p",{className:"text-right text-xs text-muted-foreground",children:[a,"%"]})]},o.star)})})}function Se({review:s,profile:r,reactions:n}){const o=(r?.display_name??r?.username??"?").split(/\s+/g).slice(0,2).map(v=>v.slice(0,1).toUpperCase()).join("").slice(0,2),a=s.rating==null?null:oe(s.rating),[c,u]=g.useState(!1),m=!!!s.spoiler||c;return e.jsxs("div",{className:"rounded-2xl border border-border bg-card/70 card-pad",children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[r?.avatar_url?e.jsx("img",{src:r.avatar_url,alt:r.display_name??r.username??"User",className:"size-10 rounded-full object-cover"}):e.jsx("div",{className:"flex size-10 items-center justify-center rounded-full bg-primary/20 font-bold text-primary",children:o}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:r?.display_name??r?.username??"User"}),r?.is_verified?e.jsx(ge,{isVerified:r?.is_verified??null,type:r.verified_type??null,label:r.verified_label??null,verifiedAt:r.verified_at??null,org:r.verified_by_org??null}):null]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ye(s.created_at)})]})]}),a!=null?e.jsxs("div",{className:"flex items-center gap-1 rounded-lg border border-border/60 bg-background/60 px-2 py-1",children:[e.jsx(R,{name:"star",className:"text-sm text-yellow-500",filled:!0}),e.jsx("span",{className:"text-xs font-semibold text-foreground",children:a.toFixed(1)})]}):null]}),s.headline?e.jsx("p",{className:"mb-2 text-sm font-semibold text-foreground",children:s.headline}):null,s.body?e.jsx("div",{className:"text-sm leading-relaxed text-muted-foreground",children:m?e.jsx("p",{children:s.body}):e.jsxs("div",{className:"rounded-xl border border-border bg-muted/40 p-3",children:[e.jsx("p",{className:"text-muted-foreground",children:"Spoiler warning"}),e.jsxs("button",{type:"button",className:"mt-2 inline-flex items-center gap-2 text-sm font-semibold text-primary",onClick:()=>u(!0),children:["View spoiler",e.jsx(R,{name:"chevron_right",className:"text-base"})]})]})}):null,e.jsxs("div",{className:"mt-4 flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 transition-colors hover:text-primary",children:[e.jsx(R,{name:"thumb_up",className:"text-base"}),e.jsx("span",{children:n.up?z(n.up):"0"})]}),e.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 transition-colors hover:text-red-400",children:[e.jsx(R,{name:"thumb_down",className:"text-base"}),e.jsx("span",{children:n.down?z(n.down):"0"})]}),e.jsx("button",{type:"button",className:"ml-auto rounded-full bg-muted/60 px-3 py-1 text-xs font-semibold text-foreground hover:bg-muted",children:"Reply"})]})]})}function ke({open:s,onOpenChange:r,titleName:n,titleId:o,contentType:a}){const c=le(),{user:u}=de(),[p,m]=g.useState(4),[v,D]=g.useState(""),[P,f]=g.useState(""),[A,I]=g.useState(!1),[F,M]=g.useState(null);g.useEffect(()=>{s||(M(null),D(""),f(""),I(!1),m(4))},[s]);const T=ce({mutationFn:async()=>{if(!u)throw new Error("SIGN_IN_REQUIRED");const d=me(p);if(d==null)throw new Error("INVALID_RATING");const _=ue(),j=[];j.push(Promise.resolve(C.from("reviews").insert({user_id:u.id,title_id:o,content_type:a,rating:d,headline:v.trim()||null,body:P.trim()||null,spoiler:A})).then(({error:x})=>{if(x)throw x})),j.push(Promise.resolve(C.from("ratings").upsert({user_id:u.id,title_id:o,content_type:a,rating:d},{onConflict:"user_id,title_id"})).then(({error:x})=>{if(x)throw x})),j.push(xe({sessionId:_,deckId:null,position:null,mediaItemId:o,eventType:"rating",rating0_10:d,source:"title_reviews",payload:{action:"rate_and_review",origin:"title_reviews"}})),await Promise.allSettled(j)},onSuccess:async()=>{M(null),r(!1),await c.invalidateQueries({queryKey:["title","reviews",o]}),await c.invalidateQueries({queryKey:["title","rating-summary",o]}),c.invalidateQueries({queryKey:Z.titleDetail(o)})},onError:d=>{if(d?.message==="SIGN_IN_REQUIRED"){M("Sign in to rate and review.");return}M(d?.message??"Failed to submit review.")}});return e.jsx(fe,{open:s,onOpenChange:r,children:e.jsxs(be,{className:"max-w-lg border-border bg-background text-foreground",children:[e.jsxs(pe,{children:[e.jsx(he,{children:"Rate & Review"}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:n})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold",children:"Your rating"}),e.jsxs("p",{className:"text-sm font-semibold text-foreground",children:[p.toFixed(1),"/5"]})]}),e.jsx("div",{className:"mt-2",children:e.jsx(W,{rating:p,size:20})}),e.jsx("input",{className:"mt-3 w-full",type:"range",min:0,max:5,step:.5,value:p,onChange:d=>m(Number(d.target.value))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold",children:"Headline"}),e.jsx(ve,{value:v,onChange:d=>D(d.target.value),placeholder:"Add a short headline",className:"border-border bg-background text-foreground placeholder:text-muted-foreground"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold",children:"Review"}),e.jsx(_e,{value:P,onChange:d=>f(d.target.value),placeholder:"Share your thoughts",className:"min-h-[120px] border-border bg-background text-foreground placeholder:text-muted-foreground"})]}),e.jsxs("label",{className:"flex items-center justify-between rounded-xl border border-border bg-muted/40 px-3 py-2.5",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Contains spoilers"}),e.jsx("input",{type:"checkbox",checked:A,onChange:d=>I(d.target.checked),className:"size-5 accent-primary"})]}),F?e.jsx("p",{className:"text-sm text-destructive",children:F}):null,e.jsxs("div",{className:"flex gap-3",children:[e.jsx(B,{variant:"secondary",className:"flex-1 border border-border bg-muted/60 text-foreground hover:bg-muted",onClick:()=>r(!1),disabled:T.isPending,children:"Cancel"}),e.jsx(B,{className:"flex-1",onClick:()=>T.mutate(),disabled:T.isPending,children:T.isPending?"Savingâ€¦":"Post"})]})]})]})})}function qe(){const s=te(),r=se(),[n,o]=re(),a=String(r.titleId??""),c=/^[0-9a-fA-F-]{36}$/.test(a),[u,p]=g.useState("recent"),[m,v]=g.useState(!1),[D,P]=g.useState(!1);g.useEffect(()=>{if(n.get("compose")==="1"){P(!0);const t=new URLSearchParams(n);t.delete("compose"),o(t,{replace:!0})}},[n,o]);const f=O({queryKey:Z.titleDetail(c?a:null),enabled:c,staleTime:1e3*60,queryFn:async()=>{const{data:t,error:l}=await C.from("media_items").select("id,kind,tmdb_title,tmdb_name,omdb_title,tmdb_release_date,tmdb_first_air_date,tmdb_genres,omdb_genre").eq("id",a).maybeSingle();if(l&&l.code!=="PGRST116")throw l;return t??null}}),A=(()=>{const t=f.data?.kind;return t==="anime"?"anime":t==="movie"?"movie":"series"})(),I=je(f.data?.tmdb_title,f.data?.tmdb_name,f.data?.omdb_title),F=(()=>{const t=f.data?.tmdb_release_date??f.data?.tmdb_first_air_date??null;if(!t)return null;const l=Number(String(t).slice(0,4));return Number.isNaN(l)?null:l})(),M=(()=>{const t=f.data?.tmdb_genres??[];if(Array.isArray(t)){const i=t.find(b=>b?.name);if(i?.name)return i.name}const l=f.data?.omdb_genre??null;return l?String(l).split(",")[0]?.trim()??null:null})(),d=[F?String(F):null,M].filter(Boolean).join(" â€¢ "),_=O({queryKey:["title","rating-summary",c?a:null],enabled:c,staleTime:1e3*60,queryFn:async()=>{const{data:t,error:l}=await C.rpc("get_title_rating_summary_v1",{p_title_id:a});if(l)return console.warn("[TitleReviewsPageV2] rating summary RPC error",l.message),null;const i=Array.isArray(t)?t[0]:t;return i?{title_id:String(i.title_id??a),reviews_count:Number(i.reviews_count??0),ratings_count:Number(i.ratings_count??0),average_rating_0_10:i.average_rating_0_10==null?null:Number(i.average_rating_0_10),average_rating_0_5:i.average_rating_0_5==null?null:Number(i.average_rating_0_5),stars_5:Number(i.stars_5??0),stars_4:Number(i.stars_4??0),stars_3:Number(i.stars_3??0),stars_2:Number(i.stars_2??0),stars_1:Number(i.stars_1??0)}:null}}),j=10,x=ae({queryKey:["title","reviews",a,u],enabled:c,initialPageParam:0,getNextPageParam:t=>t?.nextFrom??void 0,queryFn:async({pageParam:t})=>{const l=Number(t??0),i=l+j-1;let b=C.from("reviews").select("id,user_id,title_id,rating,headline,body,spoiler,created_at",{count:"exact"}).eq("title_id",a);u==="recent"?b=b.order("created_at",{ascending:!1}):u==="top"?b=b.order("rating",{ascending:!1,nullsFirst:!1}).order("created_at",{ascending:!1}):b=b.order("rating",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1});const{data:q,error:N,count:w}=await b.range(l,i);if(N)throw N;const h=q??[],H=Array.from(new Set(h.map(S=>S.user_id))),K=h.map(S=>S.id),J=new Map;if(H.length){const{data:S,error:$}=await C.from("profiles_public").select("id,username,display_name,avatar_url,is_verified,verified_type,verified_label,verified_at,verified_by_org").in("id",H);if(!$)for(const k of S??[])J.set(k.id,k)}const Q=new Map;if(K.length){const{data:S,error:$}=await C.from("review_reactions").select("review_id,emoji").in("review_id",K);if(!$)for(const k of S??[]){const G=Q.get(k.review_id)??{up:0,down:0};k.emoji==="ðŸ‘"&&(G.up+=1),k.emoji==="ðŸ‘Ž"&&(G.down+=1),Q.set(k.review_id,G)}}return{rows:h,profilesById:J,reactionsByReview:Q,totalCount:Number(w??0),nextFrom:h.length===j?i+1:null}}}),y=g.useMemo(()=>{const t=x.data?.pages??[],l=[],i=new Map,b=new Map;let q=0;for(const N of t){for(const w of N.rows)l.push(w);for(const[w,h]of N.profilesById.entries())i.set(w,h);for(const[w,h]of N.reactionsByReview.entries())b.set(w,h);q=Math.max(q,Number(N.totalCount??0))}return{reviews:l,profiles:i,reactions:b,totalCount:q}},[x.data]),U=g.useMemo(()=>m?y.reviews:y.reviews.filter(t=>!t.spoiler),[y.reviews,m]),E=_.data?.average_rating_0_5??null,X=E==null?"â€“":E.toFixed(1),V=_.data?.ratings_count??y.totalCount,ee=async()=>{const t=typeof window<"u"?window.location.href:"";try{navigator.share?await navigator.share({title:I,url:t}):navigator.clipboard&&(await navigator.clipboard.writeText(t),alert("Link copied"))}catch{}};return c?e.jsxs("div",{className:"relative min-h-[calc(100dvh-(5.5rem+env(safe-area-inset-bottom)))] bg-background pb-24",children:[e.jsxs("div",{className:"sticky top-0 z-30 flex items-center justify-between border-b border-border/60 bg-background/80 px-[var(--page-pad-x)] pb-3 pt-[calc(env(safe-area-inset-top)+0.75rem)] backdrop-blur relative full-bleed",children:[e.jsx(Y,{label:"Back",onClick:()=>s(-1),children:e.jsx(R,{name:"arrow_back"})}),e.jsxs("div",{className:"absolute left-1/2 w-[60%] -translate-x-1/2 text-center",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:f.isLoading?"":I}),e.jsx("p",{className:"truncate text-xs text-muted-foreground",children:d||"Ratings & reviews"})]}),e.jsx(Y,{label:"More",onClick:ee,children:e.jsx(R,{name:"more_vert"})})]}),e.jsxs("div",{className:"px-[var(--page-pad-x)] pt-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-6",children:[e.jsxs("div",{className:"flex min-w-[100px] flex-col items-center justify-center gap-1",children:[e.jsx("p",{className:"text-5xl font-black leading-none tracking-tight text-foreground",children:X}),e.jsx("div",{className:"mt-1",children:E!=null?e.jsx(W,{rating:E,size:14}):e.jsx(L,{className:"h-4 w-24"})}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:_.isLoading?"Loadingâ€¦":V?`${z(V)} verified ratings`:"No ratings yet"})]}),e.jsx("div",{className:"min-w-[200px] flex-1",children:_.data?e.jsx(we,{summary:_.data}):e.jsx(L,{className:"h-24 w-full"})})]}),e.jsx("div",{className:"mt-6 overflow-x-auto pb-2",children:e.jsxs("div",{className:"flex gap-2 pr-2",children:[[{k:"recent",label:"Most Recent"},{k:"top",label:"Highest Rated"},{k:"critical",label:"Critical"}].map(t=>e.jsx("button",{type:"button",onClick:()=>p(t.k),className:"flex h-9 shrink-0 items-center justify-center rounded-full border px-4 text-xs font-semibold transition "+(u===t.k?"border-primary bg-primary text-white":"border-border bg-muted/60 text-muted-foreground hover:bg-muted"),children:t.label},t.k)),e.jsxs("button",{type:"button",onClick:()=>v(t=>!t),className:ne("flex h-9 shrink-0 items-center gap-1.5 rounded-full border px-4 text-xs font-semibold transition",m?"border-primary bg-primary text-white":"border-border bg-muted/60 text-muted-foreground hover:bg-muted"),"aria-pressed":m,children:["Spoilers",e.jsx(R,{name:m?"visibility":"visibility_off",className:"text-base"})]})]})}),e.jsx("div",{className:"my-6",children:e.jsx(Ne,{})}),e.jsxs("div",{className:"flex flex-col stack-gap",children:[x.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-28 w-full rounded-2xl"}),e.jsx(L,{className:"h-28 w-full rounded-2xl"})]}):null,U.map(t=>e.jsx(Se,{review:t,profile:y.profiles.get(t.user_id)??null,reactions:y.reactions.get(t.id)??{up:0,down:0}},t.id)),!x.isLoading&&U.length===0?e.jsx("div",{className:"rounded-2xl border border-border bg-card/70 card-pad text-sm text-muted-foreground",children:y.reviews.length>0&&!m?"No spoiler-free reviews yet. Toggle spoilers to view all reviews.":"No reviews yet. Be the first to share your thoughts."}):null,x.hasNextPage?e.jsx(B,{variant:"secondary",className:"w-full rounded-full border border-border bg-muted/60 text-foreground hover:bg-muted",onClick:()=>x.fetchNextPage(),disabled:x.isFetchingNextPage,children:x.isFetchingNextPage?"Loadingâ€¦":"Load more"}):null]})]}),e.jsx("div",{className:"fixed inset-x-0 bottom-[calc(5.5rem+env(safe-area-inset-bottom))] z-40 px-[var(--page-pad-x)]",children:e.jsx(B,{className:"h-14 w-full rounded-full",onClick:()=>P(!0),children:"Rate & Review"})}),e.jsx(ke,{open:D,onOpenChange:P,titleName:I,titleId:a,contentType:A}),e.jsx("div",{className:"sr-only",children:e.jsx(ie,{to:`/title/${a}`,children:"Back to title"})})]}):e.jsxs("div",{className:"px-[var(--page-pad-x)] py-10 text-center text-muted-foreground",children:["This title link is invalid.",e.jsx("div",{className:"mt-4",children:e.jsx(B,{onClick:()=>s(-1),children:"Go back"})})]})}export{qe as default};
