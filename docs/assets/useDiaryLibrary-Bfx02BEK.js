import{b as f,c as h,e as D,w,q as s,s as g,aG as E,m as Q,D as L}from"./index-Cuvvv_Gr.js";const q=n=>n==="movie"||n==="series"||n==="anime"?n:n==="episode"?"series":"movie",I=(n,e)=>{const{user:r}=f(),c=e??r?.id??null,m=!!(r?.id&&r?.id===c),t=h({queryKey:["diary","library",c],enabled:!!c,queryFn:async()=>{if(!c)return[];const{data:i,error:l}=await g.from("library_entries").select("id, title_id, status, updated_at").eq("user_id",c).order("updated_at",{ascending:!1}).limit(500);if(l){const a=l.message??"",d=l.code==="42501"||a.toLowerCase().includes("permission denied")||a.toLowerCase().includes("rls");if(!m&&d)return[];throw new Error(l.message)}const o=i??[];if(!o.length)return[];const y=Array.from(new Set(o.map(a=>a.title_id).filter(a=>!!a)));let _=new Map;if(y.length){const{data:a,error:d}=await g.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",y);d?console.warn("[useDiaryLibrary] Failed to load titles for library entries",d.message):_=new Map(a.map(b=>[b.id,Q(b)]))}let p=new Map;if(y.length&&m){const{data:a,error:d}=await g.from("ratings").select("title_id, rating").eq("user_id",c).in("title_id",y);!d&&a?p=new Map(a.map(b=>[b.title_id,L(b.rating)])):d&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",d.message)}return o.map(a=>{const d=_.get(a.title_id),b=p.get(a.title_id)??null;return{id:a.id,titleId:a.title_id,status:a.status,updatedAt:a.updated_at,title:d?.title??"Untitled",year:d?.year??null,type:d?.type??null,posterUrl:d?.posterUrl??d?.backdropUrl??null,rating:b}})}});return{entries:(t.data??[]).filter(i=>!(n.status&&n.status!=="all"&&i.status!==n.status||n.type&&n.type!=="all"&&i.type!==n.type)),isLoading:t.isLoading,isError:t.isError,error:t.error instanceof Error?t.error.message:null}},K=n=>{const{user:e}=f(),r=e?.id??null;return h({queryKey:s.titleDiary(r,n),enabled:!!(r&&n),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!r||!n)return{status:null,rating:null};const[{data:c,error:m},{data:t,error:u}]=await Promise.all([g.from("library_entries").select("status").eq("user_id",r).eq("title_id",n).maybeSingle(),g.from("ratings").select("rating").eq("user_id",r).eq("title_id",n).maybeSingle()]);if(m&&m.code!=="PGRST116")throw m;if(u&&u.code!=="PGRST116")throw u;return{status:c?.status??null,rating:L(t?.rating??null)}}})},M=()=>{const{user:n}=f(),e=n?.id??null,r=D(),c=w({mutationFn:async({titleId:t,status:u,type:i})=>{if(!e)throw new Error("Not authenticated");if(!i)throw new Error("Content type is required");const l=q(i),{error:o}=await g.from("library_entries").upsert({user_id:e,title_id:t,status:u,updated_at:new Date().toISOString(),content_type:l},{onConflict:"user_id,title_id"});if(o)throw new Error(o.message);return{titleId:t,status:u}},onMutate:async t=>{if(!e)return{};await r.cancelQueries({queryKey:s.diaryLibrary(e)});const u=r.getQueryData(s.diaryLibrary(e)),i=new Date().toISOString();return r.setQueryData(s.diaryLibrary(e),l=>{const o=l??[],y=o.find(a=>a.titleId===t.titleId);return y?[{...y,status:t.status,updatedAt:i,type:t.type??y.type},...o.filter(d=>d.titleId!==t.titleId)]:!(t.title||t.posterUrl)?o:[{id:`tmp-${t.titleId}`,titleId:t.titleId,status:t.status,updatedAt:i,title:t.title??"Untitled",year:t.year??null,type:t.type??null,posterUrl:t.posterUrl??null,rating:null},...o]}),r.setQueryData(s.titleDiary(e,t.titleId),l=>({status:t.status,rating:l?.rating??null})),{prevLibrary:u}},onError:(t,u,i)=>{e&&i?.prevLibrary&&r.setQueryData(s.diaryLibrary(e),i.prevLibrary)},onSettled:()=>{e&&(r.invalidateQueries({queryKey:s.diaryLibrary(e)}),r.invalidateQueries({queryKey:s.diaryStats(e)}),r.invalidateQueries({queryKey:s.homeForYou(e)}),r.invalidateQueries({queryKey:s.titleDiary(e,void 0)}))}}),m=w({mutationFn:async({titleId:t,rating:u,type:i})=>{if(!e)throw new Error("Not authenticated");if(!i)throw new Error("Content type is required");const l=q(i);if(u==null){const{error:_}=await g.from("ratings").delete().eq("user_id",e).eq("title_id",t);if(_)throw new Error(_.message);return{titleId:t,rating:null}}const o=E(u);if(o==null)throw new Error("Invalid rating value");const{error:y}=await g.from("ratings").upsert({user_id:e,title_id:t,rating:o,updated_at:new Date().toISOString(),content_type:l},{onConflict:"user_id,title_id"});if(y)throw new Error(y.message);return{titleId:t,rating:u}},onMutate:async t=>{if(!e)return{};await r.cancelQueries({queryKey:s.diaryLibrary(e)});const u=r.getQueryData(s.diaryLibrary(e));return r.setQueryData(s.diaryLibrary(e),i=>{const l=i??[],o=l.findIndex(p=>p.titleId===t.titleId);if(o===-1)return l;const y={...l[o],rating:t.rating},_=[...l];return _[o]=y,_}),r.setQueryData(s.titleDiary(e,t.titleId),i=>({status:i?.status??null,rating:t.rating})),{prevLibrary:u}},onError:(t,u,i)=>{e&&i?.prevLibrary&&r.setQueryData(s.diaryLibrary(e),i.prevLibrary)},onSettled:()=>{e&&(r.invalidateQueries({queryKey:s.diaryLibrary(e)}),r.invalidateQueries({queryKey:s.diaryStats(e)}),r.invalidateQueries({queryKey:s.homeForYou(e)}),r.invalidateQueries({queryKey:s.titleDiary(e,void 0)}))}});return{updateStatus:c,updateRating:m}};export{I as a,K as b,M as u};
