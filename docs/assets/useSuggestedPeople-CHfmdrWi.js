import{c as w,b as L,d as Q,e as z,s as u}from"./index-yaS868vE.js";import{r as J}from"./resolveAvatarUrl-Bv46IzST.js";const V=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],te=w("copy",V);const X=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]],se=w("ellipsis",X);const Y=[["path",{d:"M2 21a8 8 0 0 1 13.292-6",key:"bjp14o"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M19 16v6",key:"tddt3s"}],["path",{d:"M22 19h-6",key:"vcuq98"}]],oe=w("user-round-plus",Y),G="moviNesta.suggestedPeople.dismissed.v1",N=s=>`${G}:${s}`,b=s=>{try{const n=localStorage.getItem(N(s));if(!n)return[];const i=JSON.parse(n);return Array.isArray(i)?i.filter(_=>typeof _=="string"):[]}catch{return[]}},H=(s,n)=>{const i=new Set(b(s));i.add(n);try{localStorage.setItem(N(s),JSON.stringify(Array.from(i)))}catch{}},re=()=>{const{user:s}=L(),n=Q();return{...z({queryKey:["suggested-people",s?.id??null],enabled:!!s?.id,staleTime:1e3*60*5,gcTime:1e3*60*30,queryFn:async()=>{if(!s?.id)return[];const a=s.id,U=new Set(b(a)),{data:q,error:h}=await u.from("follows").select("followed_id").eq("follower_id",a);h&&console.warn("[useSuggestedPeople] Failed to load follows",h.message);const C=new Set((q??[]).map(e=>e.followed_id)),v=new Set([a,...U,...C]),{data:P,error:S}=await u.from("ratings").select("title_id, rating").eq("user_id",a).order("rating",{ascending:!1}).limit(40);S&&console.warn("[useSuggestedPeople] Failed to load viewer ratings",S.message);const E=P?P.filter(e=>typeof e.title_id=="string"&&typeof e.rating=="number").slice(0,30):[],p=Array.from(new Set(E.map(e=>e.title_id))),T=new Map(E.map(e=>[e.title_id,e.rating??0])),{data:R,error:M}=await u.from("user_stats").select("user_id, followers_count, following_count").order("followers_count",{ascending:!1}).limit(60);M&&console.warn("[useSuggestedPeople] Failed to load user_stats",M.message);const k=(R??[]).filter(e=>!v.has(e.user_id)),m=k.map(e=>e.user_id).slice(0,40);if(!m.length)return[];const{data:B,error:x}=await u.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",m).limit(40);if(x)throw new Error(x.message);const D=new Map(k.map(e=>[e.user_id,{followersCount:e.followers_count??0,followingCount:e.following_count??0}]));let f=new Map;if(p.length>=5){const{data:e,error:t}=await u.from("ratings").select("user_id, title_id, rating").in("user_id",m).in("title_id",p).limit(2e3);if(t)console.warn("[useSuggestedPeople] Failed to load candidate ratings",t.message);else{const r=e??[],l=new Map;r.forEach(o=>{if(!o?.user_id)return;const c=l.get(o.user_id)??[];c.push(o),l.set(o.user_id,c)}),m.forEach(o=>{const A=(l.get(o)??[]).filter(d=>T.has(d.title_id)),g=A.length;if(!g){f.set(o,{commonTitlesCount:0,matchPercent:0,score:0});return}let F=0,y=0;A.forEach(d=>{const I=T.get(d.title_id);typeof I!="number"||typeof d.rating!="number"||(F+=Math.abs(I-d.rating),y+=1)});const $=y?F/y:0,j=g*10-$*2,K=Math.round(g/Math.max(1,p.length)*100);f.set(o,{commonTitlesCount:g,matchPercent:K,score:j})})}}const O=(B??[]).map(e=>{const t=D.get(e.id),r=f.get(e.id);return{id:e.id,username:e.username??null,displayName:e.display_name??null,avatarPathOrUrl:typeof e.avatar_url=="string"?e.avatar_url:null,bio:e.bio??null,followersCount:t?.followersCount??0,followingCount:t?.followingCount??0,isFollowing:C.has(e.id),commonTitlesCount:r?.commonTitlesCount,matchPercent:r?.matchPercent,_score:r?.score??0}}).filter(e=>!v.has(e.id));return(await Promise.all(O.map(async e=>{const t=await J(e.avatarPathOrUrl);return{id:e.id,username:e.username,displayName:e.displayName,avatarUrl:t,bio:e.bio,followersCount:e.followersCount,followingCount:e.followingCount,isFollowing:e.isFollowing,commonTitlesCount:e.commonTitlesCount,matchPercent:e.matchPercent}}))).map(e=>({person:e,score:f.get(e.id)?.score??0})).sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;const r=e.person.commonTitlesCount??0,l=t.person.commonTitlesCount??0;if(l!==r)return l-r;if(t.person.followersCount!==e.person.followersCount)return t.person.followersCount-e.person.followersCount;const o=(e.person.displayName??e.person.username??"").toLowerCase(),c=(t.person.displayName??t.person.username??"").toLowerCase();return o.localeCompare(c)}).map(e=>e.person).slice(0,15)}}),dismissPerson:a=>{s?.id&&(H(s.id,a),n.invalidateQueries({queryKey:["suggested-people",s.id]}))}}};export{te as C,se as E,oe as U,re as u};
