import{c as M,g as X,n as Y,h as re,o as J,s as w,r as d,j as e,R as zt,m as Ht,u as Vt,v as Wt,x as Ee,L as Gt,y as ct}from"./index-D8UbFo8l.js";import{f as Jt,b as Xt}from"./format-DWLSBLoY.js";import{H as Zt,A as es}from"./PageChrome-BL71Rgrf.js";import{U as ts}from"./users-CgaclyYW.js";import{I as ss}from"./info-BCT26bkj.js";import{L as G}from"./loader-circle-Dp3r3KYi.js";import{q as ns}from"./index-WHzSfndh.js";import{C as dt}from"./circle-alert-CyW31w4B.js";import{X as Me}from"./x-DI5KpeLJ.js";import"./brand-DTIDtbc4.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=M("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=M("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=M("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=M("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=M("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z",key:"1ykcvy"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=M("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=M("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=M("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=M("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=M("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]);async function bt(t,n,o){const{data:r,error:i}=await t.from("blocked_users").select("blocker_id, blocked_id").or(`and(blocker_id.eq.${n},blocked_id.eq.${o}),and(blocker_id.eq.${o},blocked_id.eq.${n})`);if(i)throw i;const u=r??[],f=u.some(m=>m.blocker_id===n&&m.blocked_id===o),c=u.some(m=>m.blocker_id===o&&m.blocked_id===n);return{youBlocked:f,blockedYou:c}}const ds=t=>{var y,k;const{user:n}=X(),o=(n==null?void 0:n.id)??null,r=Y(),i=["block-status",o,t],u=re({queryKey:i,enabled:!!(o&&t&&o!==t),staleTime:3e4,queryFn:async()=>{if(!o||!t||o===t)return{youBlocked:!1,blockedYou:!1};try{return await bt(w,o,t)}catch(x){console.error("[useBlockStatus] Failed to load block status",x);const N=x;throw new Error(N.message??"Failed to load block status")}}}),f=J({mutationFn:async()=>{if(!o||!t)throw new Error("Missing user ids for block operation.");const{error:x}=await w.from("blocked_users").upsert({blocker_id:o,blocked_id:t},{onConflict:"blocker_id,blocked_id"});if(x)throw console.error("[useBlockStatus] Failed to block user",x),new Error(x.message)},onSuccess:()=>{r.invalidateQueries({queryKey:i})}}),c=J({mutationFn:async()=>{if(!o||!t)throw new Error("Missing user ids for unblock operation.");const{error:x}=await w.from("blocked_users").delete().eq("blocker_id",o).eq("blocked_id",t);if(x)throw console.error("[useBlockStatus] Failed to unblock user",x),new Error(x.message)},onSuccess:()=>{r.invalidateQueries({queryKey:i})}}),m=((y=u.data)==null?void 0:y.youBlocked)??!1,p=((k=u.data)==null?void 0:k.blockedYou)??!1,g=m||p,v=f.isPending||c.isPending;return{youBlocked:m,blockedYou:p,isBlocked:g,isLoading:u.isLoading||v,isError:u.isError,error:u.error??null,block:f,unblock:c}},us=({isSelf:t,isDeleted:n})=>({bubbleColors:n?"bg-mn-bg-elevated/80 text-mn-text-muted border border-dashed border-mn-border-subtle/80":t?"bg-mn-primary/90 text-white shadow-md shadow-mn-primary/20":"bg-mn-bg-elevated text-mn-text-primary border border-mn-border-subtle/80 shadow-mn-soft",bubbleShape:t?"rounded-tr-3xl rounded-tl-3xl rounded-bl-3xl rounded-br-2xl":"rounded-tr-3xl rounded-tl-3xl rounded-br-3xl rounded-bl-2xl"}),xt=t=>{const n=new Date(t);return Number.isNaN(n.getTime())?"":Xt(n,{hour:"numeric",minute:"2-digit",hour12:!0})},Ie=(t,n)=>t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate(),ms=t=>{const n=new Date(t);if(Number.isNaN(n.getTime()))return"";const o=new Date,r=new Date;return r.setDate(o.getDate()-1),Ie(n,o)?"Today":Ie(n,r)?"Yesterday":Jt(n,{day:"numeric",month:"short",year:"numeric"})},ht=(t,n,o=180*1e3)=>{const r=new Date(t),i=new Date(n);return Number.isNaN(r.getTime())||Number.isNaN(i.getTime())?!1:i.getTime()-r.getTime()<=o},pt=t=>({id:t.id,conversationId:t.conversation_id,senderId:t.user_id,body:t.body??null,attachmentUrl:t.attachment_url??null,createdAt:t.created_at??new Date().toISOString()}),fs="id, conversation_id, user_id, body, attachment_url, created_at",gs=(t,n)=>{const o=Array.isArray(n)?n:[n],r=new Map;for(const i of t??[])r.set(i.id,i);for(const i of o)r.set(i.id,pt(i));return Array.from(r.values()).sort((i,u)=>new Date(i.createdAt??"").getTime()-new Date(u.createdAt??"").getTime())},xs=t=>{const n=Y(),o=re({queryKey:["conversation",t,"messages"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,staleTime:15e3,queryFn:async()=>{if(!t)return[];const{data:r,error:i}=await w.from("messages").select(fs).eq("conversation_id",t).order("created_at",{ascending:!0});if(i)throw console.error("[useConversationMessages] Failed to load messages",i),new Error(i.message);return(r??[]).map(pt)}});return d.useEffect(()=>{if(!t)return;const r=w.channel(`conversation-messages-${t}`),i=u=>{const f=u.new;!f||!f.id||f.conversation_id!==t||n.setQueryData(["conversation",t,"messages"],c=>gs(c,f))};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},i).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},i).subscribe(),()=>{w.removeChannel(r)}},[t,n]),o},hs=t=>["conversation",t,"reactions"],bs=t=>({id:t.id,conversationId:t.conversation_id,messageId:t.message_id,userId:t.user_id,emoji:t.emoji,createdAt:t.created_at}),ps=async t=>{const{data:n,error:o}=await w.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(o)throw console.error("[useConversationReactions] Failed to load reactions",o),new Error(o.message);return(n??[]).map(bs)},ys=t=>{const{user:n}=X(),o=(n==null?void 0:n.id)??null,r=Y(),i=hs(t),u=re({queryKey:i,enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:()=>t?ps(t):Promise.resolve([])}),f=J({mutationFn:async({messageId:m,emoji:p})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to react to messages.");const{error:g}=await w.from("message_reactions").insert({conversation_id:t,message_id:m,user_id:o,emoji:p});if(g){if((g==null?void 0:g.code)==="23505"){const{error:v}=await w.from("message_reactions").delete().eq("conversation_id",t).eq("message_id",m).eq("user_id",o).eq("emoji",p);if(v)throw console.error("[useConversationReactions] Failed to remove reaction",v),v;return}throw console.error("[useConversationReactions] Failed to toggle reaction",g),g}},onMutate:async({messageId:m,emoji:p})=>{if(!t||!o)return{previousReactions:void 0};await r.cancelQueries({queryKey:i});const g=r.getQueryData(i);return r.setQueryData(i,v=>{const y=v??[],k=y.findIndex(N=>N.messageId===m&&N.userId===o&&N.emoji===p);if(k>=0){const N=[...y];return N.splice(k,1),N}const x={id:`temp-${Date.now()}`,conversationId:t,messageId:m,userId:o,emoji:p,createdAt:new Date().toISOString()};return[...y,x]}),{previousReactions:g}},onError:(m,p,g)=>{t&&(g!=null&&g.previousReactions?r.setQueryData(i,g.previousReactions):r.invalidateQueries({queryKey:i}))},onSuccess:()=>{t&&r.invalidateQueries({queryKey:i})}}),c=d.useMemo(()=>{const m=new Map,p=u.data??[];for(const g of p){const v=m.get(g.messageId)??[];let y=v.find(k=>k.emoji===g.emoji);y?(y.count+=1,y.reactedBySelf=y.reactedBySelf||(o?g.userId===o:!1)):(y={count:1,emoji:g.emoji,reactedBySelf:!!(o&&g.userId===o)},v.push(y)),m.set(g.messageId,v)}return m},[u.data,o]);return{reactions:u.data??[],reactionsByMessageId:c,isLoadingReactions:u.isLoading,toggleReaction:f,queryKey:i}},vs=({conversation:t,isLoading:n,isGroupConversation:o,otherParticipant:r,onBack:i,onToggleBlock:u,blockPending:f=!1,youBlocked:c=!1})=>e.jsxs(Zt,{className:"min-h-[3.5rem] flex-shrink-0 py-3",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:i,className:"inline-flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-primary shadow-mn-soft transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:[e.jsx(es,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Back to messages"})]}),e.jsxs("div",{className:"flex min-w-0 items-center gap-3",children:[e.jsxs("div",{className:"relative flex h-11 w-11 flex-shrink-0 items-center justify-center overflow-hidden rounded-full bg-mn-bg-elevated ring-2 ring-mn-border-subtle",children:[e.jsx("div",{className:"absolute inset-0 rounded-full bg-gradient-to-br from-fuchsia-500/25 via-mn-primary/20 to-blue-500/25","aria-hidden":"true"}),e.jsx("div",{className:"relative flex h-9 w-9 items-center justify-center overflow-hidden rounded-full bg-mn-bg ring-1 ring-white/30",children:!o&&r?r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:r.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("span",{className:"text-[13px] font-semibold text-mn-text-primary",children:(r.displayName??"U").slice(0,2).toUpperCase()}):e.jsx(ts,{className:"h-4 w-4 text-mn-text-secondary","aria-hidden":"true"})})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h1",{className:"truncate text-[15px] font-heading font-semibold text-mn-text-primary",children:(t==null?void 0:t.title)??(r==null?void 0:r.displayName)??"Conversation"}),e.jsx("p",{className:"truncate text-[11px] text-mn-text-secondary",children:t?t.lastMessageAtLabel?`Active ${t.lastMessageAtLabel}`:t.subtitle??(o?`${t.participants.length} participants`:"Active now"):n?"Loadingâ€¦":"Details unavailable"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-mn-text-secondary",children:[t&&t.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Audio call",children:e.jsx(os,{className:"h-4 w-4","aria-hidden":"true"})}),t&&t.participants.length>1&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Video call",children:e.jsx(cs,{className:"h-4 w-4","aria-hidden":"true"})}),t&&e.jsx("button",{type:"button",className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/70 shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg","aria-label":"Conversation info",children:e.jsx(ss,{className:"h-4 w-4","aria-hidden":"true"})}),!o&&r&&u&&e.jsxs("button",{type:"button",disabled:f,onClick:u,className:"ml-1 hidden items-center gap-1 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 px-3 py-1.5 text-[11px] font-semibold text-mn-text-primary ring-1 ring-mn-border-subtle/70 transition hover:-translate-y-0.5 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg disabled:opacity-60 sm:inline-flex",children:[f&&e.jsx(G,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:c?"Unblock":"Block"})]})]})]});function ws({items:t,itemContent:n,isLoading:o,loadingContent:r,errorContent:i,emptyContent:u,footer:f,followOutput:c=!1,onAtBottomChange:m,computeItemKey:p}){const g=zt.useRef(null);return o?e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:r}):i?e.jsx("div",{className:"flex flex-1 flex-col px-4 py-4 text-sm",children:i}):t.length?e.jsx("div",{className:"relative flex flex-1",children:e.jsx(ns,{ref:g,data:t,style:{height:"100%",width:"100%"},className:"px-4 py-4",alignToBottom:!0,followOutput:c,atBottomStateChange:m,increaseViewportBy:400,computeItemKey:p,itemContent:(v,y)=>n(v,y),components:f?{Footer:()=>e.jsx("div",{className:"px-1 pb-2 pt-1 text-[11px] text-mn-text-muted",children:f})}:void 0})}):e.jsx("div",{className:"flex flex-1 items-center justify-center px-4 py-4 text-sm",children:u})}const js=({isSelf:t,isDeleted:n,children:o,className:r="",...i})=>{const{bubbleColors:u,bubbleShape:f}=us({isSelf:t,isDeleted:n});return e.jsx("button",{type:"button",className:`inline-flex max-w-[80%] px-4 py-2.5 text-[13px] ${f} ${u} select-none transition-transform duration-150 ease-out ${r}`,...i,children:e.jsx("div",{className:"flex flex-col",children:o})})},Ns=({children:t,...n})=>e.jsx("form",{...n,className:`border-t border-mn-border-subtle/80 bg-mn-bg/90 px-4 py-3 backdrop-blur ${n.className??""}`,children:t}),_s=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ™","ðŸ”¥","ðŸ˜"],Te="chat-media",ks=(t,n,o)=>{const r=o.split(".").pop()??"jpg",i=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():Date.now();return`message_attachments/${t}/${n}/${Date.now()}-${i}.${r}`},Cs=t=>re({queryKey:["conversation",t,"readReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?12e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:n,error:o}=await w.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1});if(o)throw console.error("[ConversationPage] Failed to load read receipts",o),new Error(o.message);return(n??[]).map(r=>({userId:r.user_id,lastReadAt:r.last_read_at??null,lastReadMessageId:r.last_read_message_id??null}))}}),Ss=t=>re({queryKey:["conversation",t,"deliveryReceipts"],enabled:!!t,refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?15e3:!1,refetchIntervalInBackground:!0,queryFn:async()=>{if(!t)return[];const{data:n,error:o}=await w.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).order("created_at",{ascending:!0});if(o)throw console.error("[ConversationPage] Failed to load delivery receipts",o),new Error(o.message);return(n??[]).map(r=>({id:r.id,conversationId:r.conversation_id,messageId:r.message_id,userId:r.user_id,deliveredAt:r.delivered_at??r.created_at}))}}),Rs=(t,n)=>{const{user:o}=X(),r=(o==null?void 0:o.id)??null,i=Y();return J({mutationFn:async({text:u,attachmentPath:f})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to send messages.");if(n!=null&&n.otherUserId){const y=await bt(w,r,n.otherUserId);if(y.youBlocked)throw new Error("You have blocked this user. Unblock them to send messages.");if(y.blockedYou)throw new Error("You cannot send messages because this user blocked you.")}const c=u.trim(),m=f&&c?{type:"text+image",text:c}:f?{type:"image",text:""}:{type:"text",text:c},{data:p,error:g}=await w.from("messages").insert({conversation_id:t,user_id:r,body:JSON.stringify(m),attachment_url:f??null}).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(g)throw console.error("[ConversationPage] Failed to send message",g),new Error(g.message);const v={id:p.id,conversationId:p.conversation_id,senderId:p.user_id,body:p.body??null,attachmentUrl:p.attachment_url??null,createdAt:p.created_at};try{await w.from("conversations").update({updated_at:new Date().toISOString()}).eq("id",t)}catch(y){console.error("[ConversationPage] Failed to update conversation timestamp",y)}return v},onMutate:async({text:u,attachmentPath:f})=>{if(!t||!r)return{previousMessages:void 0,tempId:null};const c=`temp-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,m=new Date().toISOString(),p={id:c,conversationId:t,senderId:r,body:JSON.stringify({type:"text",text:u.trim()}),attachmentUrl:f??null,createdAt:m};await i.cancelQueries({queryKey:["conversation",t,"messages"]});const g=i.getQueryData(["conversation",t,"messages"]);return i.setQueryData(["conversation",t,"messages"],v=>{const k=[...v??[],p];return k.sort((x,N)=>new Date(x.createdAt).getTime()-new Date(N.createdAt).getTime()),k}),{previousMessages:g,tempId:c,optimistic:p,payload:{text:u.trim(),attachmentPath:f??null}}},onError:(u,f,c)=>{if(console.error("[ConversationPage] sendMessage error",u),t){const{previousMessages:m,optimistic:p,payload:g,tempId:v}=c??{},y=m??i.getQueryData(["conversation",t,"messages"])??[],k=p?[...y,p]:[...y];k.sort((x,N)=>new Date(x.createdAt).getTime()-new Date(N.createdAt).getTime()),i.setQueryData(["conversation",t,"messages"],k),v&&g&&(n!=null&&n.onFailed)&&n.onFailed(v,g)}},onSuccess:(u,f,c)=>{if(!t)return;const m=c==null?void 0:c.tempId;i.setQueryData(["conversation",t,"messages"],p=>{const g=p??[],v=m?g.filter(x=>x.id!==m):g.filter(x=>x.id!==u.id),y=v.findIndex(x=>x.id===u.id);if(y>=0){const x=[...v];return x[y]=u,x}const k=[...v,u];return k.sort((x,N)=>new Date(x.createdAt).getTime()-new Date(N.createdAt).getTime()),k}),i.invalidateQueries({queryKey:["conversations"]}),n!=null&&n.onRecovered&&n.onRecovered((c==null?void 0:c.tempId)??null)}})},Ds=t=>{const{user:n}=X(),o=(n==null?void 0:n.id)??null,r=Y();return J({mutationFn:async({messageId:i,text:u})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to edit messages.");const c={type:"text",text:u.trim(),editedAt:new Date().toISOString()},{data:m,error:p}=await w.from("messages").update({body:JSON.stringify(c)}).eq("id",i).eq("user_id",o).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(p)throw console.error("[ConversationPage] Failed to edit message",p),new Error(p.message);return{id:m.id,conversationId:m.conversation_id,senderId:m.user_id,body:m.body??null,attachmentUrl:m.attachment_url??null,createdAt:m.created_at}},onSuccess:i=>{if(!t)return;const u=["conversation",t,"messages"];r.setQueryData(u,f=>f?f.map(c=>c.id===i.id?i:c):[i])}})},Es=t=>{const{user:n}=X(),o=(n==null?void 0:n.id)??null,r=Y();return J({mutationFn:async({messageId:i})=>{if(!t)throw new Error("Missing conversation id.");if(!o)throw new Error("You must be signed in to delete messages.");const f={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},{data:c,error:m}=await w.from("messages").update({body:JSON.stringify(f),attachment_url:null}).eq("id",i).eq("user_id",o).select("id, conversation_id, user_id, body, attachment_url, created_at").single();if(m)throw console.error("[ConversationPage] Failed to delete message",m),new Error(m.message);return{id:c.id,conversationId:c.conversation_id,senderId:c.user_id,body:c.body??null,attachmentUrl:c.attachment_url??null,createdAt:c.created_at}},onSuccess:i=>{if(!t)return;const u=["conversation",t,"messages"];r.setQueryData(u,f=>f?f.map(c=>c.id===i.id?i:c):[i]),r.invalidateQueries({queryKey:["conversations"]})}})},Ms=({path:t})=>{const[n,o]=d.useState(null),[r,i]=d.useState(!1);return d.useEffect(()=>{let u=!1;return(async()=>{const{data:c,error:m}=await w.storage.from(Te).createSignedUrl(t,3600);if(!u){if(m||!(c!=null&&c.signedUrl)){console.error("[ChatImage] createSignedUrl error",m),i(!0);return}o(c.signedUrl)}})(),()=>{u=!0}},[t]),r?e.jsx("div",{className:"mt-1 text-[11px] text-mn-text-muted",children:"Image unavailable."}):n?e.jsx("div",{className:"mt-1 overflow-hidden rounded-xl border border-mn-border-subtle/70 bg-mn-bg/80",children:e.jsx("img",{src:n,alt:"Attachment",className:"max-h-64 w-full object-cover",loading:"lazy"})}):e.jsx("div",{className:"mt-1 h-32 w-40 animate-pulse rounded-xl bg-mn-border-subtle/40"})},Qs=()=>{const{conversationId:t}=Ht(),n=t??null,o=Vt(),{user:r}=X(),i=Y(),{data:u,isLoading:f}=Wt(),{data:c,isLoading:m,isError:p,error:g}=xs(n),[v,y]=d.useState(""),[k,x]=d.useState(null),[N,D]=d.useState(null),[A,$]=d.useState(null),[me,fe]=d.useState({}),yt=(s,a)=>{x("Couldn't send. Please try again."),y(a.text),W(),$(a),fe(l=>({...l,[s]:a}))},vt=s=>{s&&fe(a=>{if(!(s in a))return a;const l={...a};return delete l[s],l})},S=d.useMemo(()=>!n||!u?null:u.find(s=>s.id===n)??null,[n,u]),B=(S==null?void 0:S.isGroup)??!1,q=d.useMemo(()=>{if(!S)return null;const s=S.participants.filter(a=>!a.isSelf);return s.length>0?s[0]:S.participants.length===1?S.participants[0]:null},[S]),wt=Rs(n,{onFailed:yt,onRecovered:vt,otherUserId:B?null:(q==null?void 0:q.id)??null}),[jt,Nt]=d.useState(!0),z=d.useRef(null),[ae,ie]=d.useState(!1),ge=d.useRef(null),xe=d.useRef(null),[_t,Ae]=d.useState(!1),[oe,qe]=d.useState(null),[I,Pe]=d.useState(null),[he,Le]=d.useState(!1),be=d.useRef(null);d.useEffect(()=>()=>{I&&URL.revokeObjectURL(I)},[I]),d.useEffect(()=>{c&&fe(s=>{const a=new Set(c.map(b=>b.id));let l=!1;const h={...s};for(const b of Object.keys(h))a.has(b)||(delete h[b],l=!0);return l?h:s})},[c]);const le=d.useMemo(()=>{const s=new Map;if(!S)return s;for(const a of S.participants)s.set(a.id,a);return s},[S]),{youBlocked:$e,blockedYou:P,isBlocked:F,isLoading:kt,block:Be,unblock:Fe}=ds(B?null:(q==null?void 0:q.id)??null),Ct=((c==null?void 0:c.length)??0)>0,St=f||m||kt,U=(r==null?void 0:r.id)??null,Ue=d.useMemo(()=>{if(!c||!U)return null;for(let s=c.length-1;s>=0;s-=1){const a=c[s];if(a.senderId===U&&!Ee(a.body).deleted)return a.id}return null},[c,U]),[H,pe]=d.useState([]),V=d.useRef(new Map),ye=d.useRef(null),Z=d.useRef({conversationId:null,messageId:null,userId:null}),O=d.useRef({isTyping:!1,timeoutId:null}),{data:Oe}=Cs(n),{reactionsByMessageId:Qe,toggleReaction:Ke,queryKey:ve}=ys(n),{data:Ye}=Ss(n),we=Ds(n),je=Es(n),L=d.useRef(null),ce=d.useRef(!1),[ze,ee]=d.useState(null),[He,Rt]=d.useState({}),[Ne,te]=d.useState(null),[Q,_e]=d.useState(null),Ve=d.useRef(null),We=d.useRef(null),ke=d.useRef(null),[Ge,de]=d.useState(null),se=d.useCallback(()=>{_e(null),de(null),ke.current&&ke.current.focus()},[]);d.useEffect(()=>{if(!Q)return;const s=Ve.current,a=s==null?void 0:s.querySelectorAll("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])"),l=h=>{if(!s)return;if(h.key==="Escape"){h.preventDefault(),se();return}if(h.key!=="Tab"||!a||a.length===0)return;const b=a[0],j=a[a.length-1];h.shiftKey?document.activeElement===b&&(h.preventDefault(),j.focus()):document.activeElement===j&&(h.preventDefault(),b.focus())};return s==null||s.addEventListener("keydown",l),queueMicrotask(()=>{var h;(h=We.current)==null||h.focus()}),()=>s==null?void 0:s.removeEventListener("keydown",l)},[Q,se]);const Je=d.useMemo(()=>c?c.map(s=>{const a=Ee(s.body),l=le.get(s.senderId)??null,h=(l==null?void 0:l.isSelf)??(U!=null&&s.senderId===U),b=Is(s,S??null,Ye,Oe,U,me),j=!!b&&h&&!a.deleted&&(b.status==="failed"||Ue===s.id);return{message:s,meta:a,sender:l,isSelf:h,deliveryStatus:b,showDeliveryStatus:j,reactions:Qe.get(s.id)??[]}}):[],[S,U,Ye,me,Ue,c,le,Qe,Oe]),ne=d.useMemo(()=>Je.filter(({message:s})=>!He[s.id]),[Je,He]),Dt=ne.length>0;d.useEffect(()=>{Z.current={conversationId:null,messageId:null,userId:null}},[n,r==null?void 0:r.id]),d.useEffect(()=>()=>{L.current!=null&&window.clearTimeout(L.current)},[]),d.useEffect(()=>{if(!n||!(r!=null&&r.id))return;const s=w.channel(`supabase_realtime_typing:conversation:${n}`,{config:{broadcast:{self:!1}}});return ye.current=s,s.on("broadcast",{event:"typing"},({payload:a})=>{const l=a;if(!l||l.userId===r.id)return;const h=le.get(l.userId),b=(h==null?void 0:h.displayName)??"Someone",j=l.userId,E=V.current.get(j);if(E!=null&&window.clearTimeout(E),l.isTyping){pe(C=>C.includes(b)?C:[...C,b]);const R=window.setTimeout(()=>{V.current.delete(j),pe(C=>C.filter(T=>T!==b))},4e3);V.current.set(j,R)}else V.current.delete(j),pe(R=>R.filter(C=>C!==b))}).subscribe(a=>{console.log("[ConversationPage] Typing channel status",a)}),()=>{V.current.forEach(a=>window.clearTimeout(a)),V.current.clear(),s&&w.removeChannel(s),ye.current=null}},[n,r==null?void 0:r.id,le]),d.useEffect(()=>{if(!n)return;const s=w.channel(`supabase_realtime_messages_publication:conversation:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${n}`},a=>{console.log("[ConversationPage] Realtime message payload",a);const l=a.new;if(r!=null&&r.id&&l.user_id===r.id)return;const h={id:l.id,conversationId:l.conversation_id,senderId:l.user_id,body:l.body,attachmentUrl:l.attachment_url,createdAt:l.created_at};i.setQueryData(["conversation",n,"messages"],b=>{const j=b??[];if(j.some(C=>C.id===h.id))return j;const R=[...j,h];return R.sort((C,T)=>new Date(C.createdAt).getTime()-new Date(T.createdAt).getTime()),R}),i.invalidateQueries({queryKey:["conversations"]}),r!=null&&r.id&&l.user_id!==r.id&&w.from("message_delivery_receipts").insert({conversation_id:l.conversation_id,message_id:l.id,user_id:r.id}).then(({error:b})=>{b&&console.error("[ConversationPage] Failed to insert delivery receipt",b)},b=>{console.error("[ConversationPage] Unexpected error inserting delivery receipt",b)})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${n}`},a=>{const l=a.new,h={id:l.id,conversationId:l.conversation_id,senderId:l.user_id,body:l.body,attachmentUrl:l.attachment_url,createdAt:l.created_at};i.setQueryData(["conversation",n,"messages"],b=>{const j=b??[],E=j.findIndex(C=>C.id===h.id);if(E===-1)return j;const R=[...j];return R[E]=h,R})});return s.subscribe(a=>{console.log("[ConversationPage] Realtime channel status (messages)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for messages",a)}),()=>{w.removeChannel(s)}},[n,i,r==null?void 0:r.id]),d.useEffect(()=>{if(!n||!c||c.length===0||!(r!=null&&r.id))return;const s=c[c.length-1];Z.current.conversationId===n&&Z.current.messageId===s.id&&Z.current.userId===r.id||w.from("message_read_receipts").upsert({conversation_id:n,user_id:r.id,last_read_message_id:s.id,last_read_at:new Date().toISOString()},{onConflict:"conversation_id,user_id"}).then(()=>{Z.current={conversationId:n,messageId:s.id,userId:r.id},i.invalidateQueries({queryKey:["conversations"]})},a=>{console.error("[ConversationPage] Failed to update read receipt",a)})},[n,c,r==null?void 0:r.id,i]),d.useEffect(()=>{if(!n)return;const s=w.channel(`supabase_realtime_read_receipts:conversation:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${n}`},()=>{i.invalidateQueries({queryKey:["conversation",n,"readReceipts"]})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${n}`},()=>{i.invalidateQueries({queryKey:["conversation",n,"readReceipts"]})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (read receipts)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for read receipts",a)});return()=>{w.removeChannel(s)}},[n,i]),d.useEffect(()=>{if(!n)return;const s=w.channel(`supabase_realtime_message_reactions:conversation:${n}`).on("postgres_changes",{event:"*",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${n}`},()=>{ve&&i.invalidateQueries({queryKey:ve})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (reactions)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for reactions",a)});return()=>{w.removeChannel(s)}},[n,i,ve]),d.useEffect(()=>{if(!n)return;const s=w.channel(`supabase_realtime_message_delivery_receipts:conversation:${n}`).on("postgres_changes",{event:"*",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${n}`},()=>{i.invalidateQueries({queryKey:["conversation",n,"deliveryReceipts"]})}).subscribe(a=>{console.log("[ConversationPage] Realtime channel status (delivery receipts)",a),a==="CHANNEL_ERROR"&&console.error("[ConversationPage] Realtime channel error for delivery receipts",a)});return()=>{w.removeChannel(s)}},[n,i]),d.useEffect(()=>{if(!ae)return;const s=a=>{const l=a.target;xe.current&&!xe.current.contains(l)&&ge.current&&!ge.current.contains(l)&&ie(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[ae]);const W=()=>{const s=z.current;if(!s)return;s.style.height="auto";const a=Math.min(140,s.scrollHeight);s.style.height=`${a}px`,s.style.overflowY=s.scrollHeight>a?"auto":"hidden"};d.useEffect(()=>{W()},[v]);const Ce=s=>{const a=ye.current;if(!a||!n||!r)return;const h=s.trim().length>0,b=O.current.isTyping;h&&!b&&(O.current.isTyping=!0,a.send({type:"broadcast",event:"typing",payload:{userId:r.id,isTyping:!0}})),O.current.timeoutId!=null&&window.clearTimeout(O.current.timeoutId),h?O.current.timeoutId=window.setTimeout(()=>{O.current.isTyping=!1,a.send({type:"broadcast",event:"typing",payload:{userId:r.id,isTyping:!1}})},3e3):!h&&b&&(O.current.isTyping=!1,a.send({type:"broadcast",event:"typing",payload:{userId:r.id,isTyping:!1}}))},Et=s=>{const a=s.target.value;y(a),W(),ae&&ie(!1),Ce(a)},Mt=s=>{s&&y(a=>{const l=`${a}${s}`;return W(),Ce(l),l})},Se=s=>{wt.mutate({text:s.text,attachmentPath:s.attachmentPath},{onError:a=>{console.error("[ConversationPage] sendMessage mutate error",a),x("Couldn't send. Please try again."),y(s.text),W(),$(s)},onSuccess:()=>{x(null),$(null)}})},It=s=>{if(s.preventDefault(),F||P)return;const a=v.trim();a&&(y(""),W(),x(null),$(null),Ce(""),Se({text:a,attachmentPath:null}))},Tt=()=>{A&&(x(null),Se(A))},At=()=>{var s;!n||!(r!=null&&r.id)||F||P||(s=be.current)==null||s.click()},qt=async s=>{var h;const a=(h=s.target.files)==null?void 0:h[0];if(s.target.value="",!a||!n||!(r!=null&&r.id)||F||P)return;const l=URL.createObjectURL(a);I&&URL.revokeObjectURL(I),qe(a),Pe(l),Ae(!0)},Xe=()=>{I&&URL.revokeObjectURL(I),Pe(null),qe(null),Ae(!1),D(null)},Pt=async()=>{if(!(!oe||!n||!(r!=null&&r.id))&&!(F||P)){D(null),Le(!0);try{const s=ks(n,r.id,oe.name),{error:a}=await w.storage.from(Te).upload(s,oe,{cacheControl:"3600",upsert:!1});if(a){console.error("[ConversationPage] image upload error",a),D("Upload failed. Please try another image.");return}const{error:l}=await w.storage.from(Te).createSignedUrl(s,3600);if(l){console.error("[ConversationPage] signed URL generation failed",l),D("Could not generate a secure download link.");return}Se({text:"",attachmentPath:s}),Xe()}catch(s){console.error("[ConversationPage] handleSendSelectedImage failed",s),D("Something went wrong while sending your image.")}finally{Le(!1)}}},Ze=s=>{F||P||Ee(s.body).deleted||(ee(s.id),z.current&&z.current.blur())},Lt=s=>{L.current!=null&&window.clearTimeout(L.current),ce.current=!1,L.current=window.setTimeout(()=>{ce.current=!0,Ze(s)},500)},et=()=>{L.current!=null&&(window.clearTimeout(L.current),L.current=null)};if(!n)return e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md rounded-mn-card border border-mn-border-subtle bg-mn-bg-elevated/80 px-5 py-6 text-center text-sm text-mn-text-primary shadow-mn-card",children:[e.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),e.jsx("p",{className:"mt-2 text-xs text-mn-text-secondary",children:"This page is meant to be opened from your messages list."}),e.jsx("p",{className:"mt-4",children:e.jsx(Gt,{to:"/messages",className:"inline-flex items-center justify-center rounded-full border border-mn-border-subtle bg-mn-bg px-3 py-1.5 text-[12px] font-medium text-mn-text-primary shadow-mn-soft transition hover:border-mn-primary/70 hover:text-mn-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:"Back to messages"})})]})});const $t=s=>{const a=me[s.id];a&&(y(a.text),$(a))};return e.jsxs("div",{className:"relative flex min-h-screen w-full flex-col items-stretch bg-mn-bg",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-10 top-4 h-32 rounded-full bg-gradient-to-r from-fuchsia-500/15 via-mn-primary/10 to-blue-500/15 blur-3xl","aria-hidden":"true"}),e.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 flex-col items-stretch rounded-none border border-mn-border-subtle/70 bg-mn-bg shadow-xl shadow-mn-primary/5 backdrop-blur sm:rounded-3xl",children:[e.jsx(vs,{conversation:S,isLoading:f,isGroupConversation:B,otherParticipant:q??void 0,onBack:()=>o("/messages"),onToggleBlock:!B&&q?()=>{$e?Fe.mutate():Be.mutate()}:void 0,blockPending:Be.isPending||Fe.isPending,youBlocked:$e}),e.jsxs("section",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col bg-gradient-to-b from-mn-bg via-mn-bg to-mn-bg",children:[e.jsx("div",{className:"pointer-events-none absolute inset-x-8 top-4 h-20 rounded-full bg-gradient-to-r from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 blur-3xl","aria-hidden":"true"}),e.jsx(ws,{items:ne,isLoading:St&&!Ct,loadingContent:e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-mn-border-subtle bg-mn-bg/80 px-3 py-1.5 text-[12px] text-mn-text-secondary",children:[e.jsx(G,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:p?e.jsxs("div",{className:"mb-3 rounded-md border border-mn-border-subtle bg-mn-bg/90 px-3 py-2 text-[12px] text-mn-error",children:[e.jsx("p",{className:"font-medium",children:"We couldn't load this conversation."}),g instanceof Error&&e.jsx("p",{className:"mt-1 text-[11px] text-mn-text-secondary",children:g.message})]}):void 0,emptyContent:Dt?void 0:e.jsxs("div",{className:"text-center text-[12px] text-mn-text-secondary",children:[e.jsx("p",{className:"font-medium",children:B?"No messages in this group yet.":"No messages yet."}),e.jsx("p",{className:"mt-1",children:B?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:H.length>0?e.jsxs("div",{className:"mt-1 flex items-center justify-start gap-2 text-[11px] text-mn-text-muted",children:[e.jsx("span",{children:B?H.length===1?`${H[0]} is typingâ€¦`:H.length===2?`${H[0]} and ${H[1]} are typingâ€¦`:"Several people are typingâ€¦":"Typingâ€¦"}),e.jsxs("span",{className:"inline-flex items-center gap-0.5","aria-hidden":"true",children:[e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"}),e.jsx("span",{className:"h-1.5 w-1.5 animate-bounce rounded-full bg-mn-text-muted"})]})]}):e.jsx("div",{className:"h-1","aria-hidden":!0}),followOutput:jt?"smooth":!1,onAtBottomChange:Nt,computeItemKey:(s,a)=>a.message.id,itemContent:(s,a)=>{var ot,lt;const{message:l,meta:h,sender:b,isSelf:j,deliveryStatus:E,reactions:R,showDeliveryStatus:C}=a,T=s>0?((ot=ne[s-1])==null?void 0:ot.message)??null:null,Re=s<ne.length-1?((lt=ne[s+1])==null?void 0:lt.message)??null:null,tt=T!=null&&T.senderId===l.senderId,st=Re!=null&&Re.senderId===l.senderId,Bt=tt&&ht(T.createdAt,l.createdAt),Ft=st&&ht(l.createdAt,Re.createdAt),Ut=!(tt&&Bt),Ot=!(st&&Ft),nt=s===0||T!=null&&!Ie(new Date(T.createdAt),new Date(l.createdAt)),Qt=s===0||nt?"mt-0":Ut?"mt-3":"mt-1.5",K=h.deleted===!0,rt=h.editedAt,at=h.deletedAt,it=(b==null?void 0:b.displayName)??(j?"You":"Someone"),ue=K?"This message was deleted":ct(l.body),Kt=(()=>{const _=j?"You":it;return K?`${_} deleted a message`:ue?`${_} said: ${ue}`:l.attachmentUrl?`${_} sent an attachment`:`${_} sent a message`})(),Yt=!j&&Ot,De=()=>{if(ce.current){ce.current=!1;return}ze===l.id?ee(null):Ze(l)};return e.jsxs("div",{className:"px-0",children:[nt&&e.jsx("div",{className:"my-4 flex items-center justify-center",children:e.jsxs("div",{className:"inline-flex items-center gap-3 text-[11px] text-mn-text-muted",children:[e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"}),e.jsx("span",{className:"rounded-full bg-mn-bg px-3 py-0.5 text-[11px] font-medium text-mn-text-secondary shadow-mn-soft/60 ring-1 ring-mn-border-subtle/70",children:ms(l.createdAt)}),e.jsx("span",{className:"h-px w-12 bg-gradient-to-r from-transparent via-mn-border-subtle to-transparent","aria-hidden":"true"})]})}),e.jsxs("div",{className:`flex w-full flex-col gap-0.5 ${Qt}`,children:[e.jsxs("div",{className:`flex w-full items-end gap-2 ${j?"justify-end":"justify-start"}`,children:[!j&&e.jsx(e.Fragment,{children:Yt?e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0 overflow-hidden rounded-full bg-mn-bg/80 ring-1 ring-mn-border-subtle",children:b!=null&&b.avatarUrl?e.jsx("img",{src:b.avatarUrl,alt:b.displayName??void 0,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] font-medium text-mn-text-secondary",children:it.slice(0,2).toUpperCase()})}):e.jsx("div",{className:"mt-auto h-7 w-7 flex-shrink-0"})}),e.jsxs(js,{isSelf:j,isDeleted:K,onClick:De,onContextMenu:_=>{_.preventDefault(),De()},onKeyDown:_=>{(_.key==="Enter"||_.key===" ")&&(_.preventDefault(),De())},onTouchStart:()=>Lt(l),onTouchEnd:et,onTouchCancel:et,"aria-label":Kt,children:[ue&&e.jsx("p",{className:"whitespace-pre-wrap break-all text-[13px] leading-snug",children:ue}),!K&&l.attachmentUrl&&e.jsx(Ms,{path:l.attachmentUrl})]})]}),R.length>0&&e.jsx("div",{className:`mt-0.5 flex w-full ${j?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsx("div",{className:"inline-flex flex-wrap items-center gap-1 rounded-full bg-mn-bg-elevated/80 px-1.5 py-0.5 text-[11px] text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/70",children:R.map(_=>e.jsxs("button",{type:"button",onClick:()=>Ke.mutate({messageId:l.id,emoji:_.emoji}),className:`inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 transition transform hover:bg-mn-bg hover:scale-110 active:scale-90 ${_.reactedBySelf?"bg-mn-primary/5 ring-1 ring-mn-primary/40":""}`,children:[e.jsx("span",{className:"text-[17px]",children:_.emoji}),_.count>1&&e.jsx("span",{className:"text-[10px] text-mn-text-secondary",children:_.count})]},_.emoji))})}),ze===l.id&&!K&&e.jsx("div",{className:`mt-1 flex w-full ${j?"justify-end pr-6":"justify-start pl-6"}`,children:e.jsxs("div",{className:"inline-flex flex-col items-stretch gap-1 rounded-2xl bg-mn-bg-elevated/95 px-2.5 py-1.5 text-[11px] text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/70 select-none",children:[e.jsx("div",{className:"flex items-center justify-center gap-1",children:_s.map(_=>e.jsx("button",{type:"button",onClick:()=>{Ke.mutate({messageId:l.id,emoji:_}),ee(null)},className:"flex h-7 w-7 items-center justify-center rounded-full transition transform hover:bg-mn-bg hover:-translate-y-0.5 hover:scale-110 active:scale-90",children:e.jsx("span",{className:"text-[17px]",children:_})},_))}),j&&e.jsxs("div",{className:"mt-1 flex items-center justify-end gap-2",children:[e.jsxs("button",{type:"button",onClick:_=>{ke.current=_.currentTarget,_e({messageId:l.id,text:ct(l.body)??""}),de(null),ee(null),z.current&&z.current.blur()},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] text-mn-text-secondary hover:bg-mn-bg",children:[e.jsx(is,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Edit"})]}),e.jsxs("button",{type:"button",onClick:()=>{ee(null),te({messageId:l.id})},className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] text-mn-error hover:bg-mn-error/10",children:[e.jsx(gt,{className:"h-3.5 w-3.5","aria-hidden":!0}),e.jsx("span",{children:"Delete"})]})]})]})}),C&&E&&e.jsx("div",{className:`flex items-center gap-1 text-[10px] text-mn-text-muted ${j?"justify-end pr-1":"justify-start pl-7"}`,children:E.status==="failed"?e.jsxs(e.Fragment,{children:[e.jsx(dt,{className:"h-3 w-3 text-mn-error","aria-hidden":!0}),e.jsx("span",{children:"Failed to send."}),e.jsx("button",{type:"button",className:"text-mn-error underline",onClick:()=>$t(l),children:"Retry"})]}):E.status==="delivered"?e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Delivered"})]}):e.jsxs(e.Fragment,{children:[e.jsx(rs,{className:"h-3 w-3","aria-hidden":!0}),e.jsx("span",{children:"Seen"})]})}),K&&at&&e.jsxs("p",{className:`text-[10px] text-mn-text-muted ${j?"text-right pr-1":"text-left pl-7"}`,children:["Deleted ",xt(at)]}),!K&&rt&&e.jsxs("p",{className:`text-[10px] text-mn-text-muted ${j?"text-right pr-1":"text-left pl-7"}`,children:["Edited ",xt(rt)]})]})]},l.id)}}),ae&&e.jsx("div",{ref:xe,className:"absolute bottom-[4.25rem] left-4 z-30 rounded-2xl border border-mn-border-subtle/60 bg-mn-bg-elevated/95 p-2 shadow-mn-card",children:e.jsx("div",{className:"flex max-w-[260px] flex-wrap gap-1.5",children:["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ”¥","â­","âœ¨","ðŸ‘€","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"].map(s=>e.jsx("button",{type:"button",onClick:()=>{Mt(s),ie(!1)},className:"inline-flex h-8 w-8 items-center justify-center rounded-full bg-mn-bg text-lg transition hover:bg-mn-bg/70",children:e.jsx("span",{children:s})},s))})})]}),!F&&!P&&e.jsxs(Ns,{onSubmit:It,className:"sticky bottom-0 z-20 flex-shrink-0 space-y-2",children:[k&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-mn-border-subtle/70 bg-mn-bg px-3 py-2 text-[11px] text-mn-error",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:"Couldn't send. Please try again."})]}),A&&e.jsx("button",{type:"button",onClick:Tt,className:"inline-flex items-center gap-1 rounded-full bg-mn-primary/10 px-2 py-1 text-[11px] font-semibold text-mn-primary ring-1 ring-mn-primary/40 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:e.jsx("span",{children:"Retry"})})]}),N&&e.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-mn-border-subtle/70 bg-mn-bg px-3 py-2 text-[11px] text-mn-error",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dt,{className:"h-3.5 w-3.5","aria-hidden":"true"}),e.jsx("p",{className:"font-semibold",children:N})]}),e.jsx("button",{type:"button",onClick:()=>D(null),className:"inline-flex items-center gap-1 rounded-full bg-mn-bg-elevated/80 px-2 py-1 text-[11px] font-semibold text-mn-text-secondary ring-1 ring-mn-border-subtle/70 transition hover:-translate-y-0.5 hover:text-mn-text-primary",children:e.jsx("span",{children:"Dismiss"})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",ref:ge,onClick:()=>ie(s=>!s),className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Add emoji",children:e.jsx(ls,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("button",{type:"button",onClick:At,className:"inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Send photo",children:e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("input",{type:"file",ref:be,accept:"image/*",className:"hidden",onChange:qt}),e.jsx("div",{className:"flex min-h-[44px] max-h-[160px] flex-1 items-center rounded-full bg-mn-bg px-4 py-2.5 text-[13px] text-mn-text-primary shadow-inner ring-1 ring-mn-border-subtle/70 focus-within:outline-none focus-within:ring-0 focus-within:shadow-none",children:e.jsx("textarea",{id:"conversation-message",value:v,ref:z,onChange:Et,onKeyDown:s=>{var a;s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),v.trim()&&((a=s.currentTarget.form)==null||a.requestSubmit()))},placeholder:"Messageâ€¦",rows:1,className:"max-h-[160px] flex-1 resize-none bg-transparent text-[13px] text-mn-text-primary outline-none placeholder:text-mn-text-muted focus:border-transparent focus:outline-none focus:ring-0 focus:shadow-none"})}),e.jsx("button",{type:"submit",onMouseDown:s=>s.preventDefault(),onTouchStart:s=>s.preventDefault(),disabled:!v.trim(),className:"inline-flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-full bg-gradient-to-r from-fuchsia-500 via-mn-primary to-blue-500 text-white shadow-lg shadow-mn-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:e.jsx(ft,{className:"h-4 w-4","aria-hidden":"true"})})]})]}),P&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You can't send messages because this user has blocked you."})}),F&&!P&&e.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-mn-border-subtle bg-mn-bg/95 px-4 py-3 text-center text-[11px] text-mn-text-muted",children:e.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),Q&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{ref:Ve,role:"dialog","aria-modal":"true","aria-labelledby":"edit-message-title",className:"w-[min(480px,calc(100%-2.5rem))] rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{id:"edit-message-title",className:"text-[15px] font-semibold text-mn-text-primary",children:"Edit message"}),e.jsx("button",{type:"button",onClick:se,className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close edit message",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("div",{className:"mt-3 rounded-2xl bg-mn-bg px-3 py-2 ring-1 ring-mn-border-subtle/70",children:e.jsx("textarea",{ref:We,value:Q.text,onChange:s=>_e(a=>a&&{...a,text:s.target.value}),rows:3,className:"w-full resize-none border-0 bg-transparent text-[13px] text-mn-text-primary outline-none focus:outline-none focus:ring-0"})}),Ge&&e.jsx("p",{className:"mt-2 text-[11px] text-mn-error",children:Ge}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2 text-[13px]",children:[e.jsx("button",{type:"button",onClick:se,className:"rounded-full px-3 py-1.5 text-mn-text-secondary hover:bg-mn-bg",children:"Cancel"}),e.jsxs("button",{type:"button",disabled:!Q.text.trim()||we.isPending,onClick:()=>{const s=Q.text.trim();s&&(de(null),we.mutate({messageId:Q.messageId,text:s},{onSuccess:()=>{se()},onError:()=>{de("Couldn't save changes. Please try again.")}}))},className:"inline-flex items-center gap-1 rounded-full bg-mn-primary px-3 py-1.5 text-white shadow-mn-soft disabled:cursor-not-allowed disabled:opacity-60",children:[we.isPending&&e.jsx(G,{className:"h-3 w-3 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Save"})]})]})]})}),Ne&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"w-[min(420px,calc(100%-2.5rem))] rounded-2xl border border-mn-border-subtle/80 bg-mn-bg-elevated p-5 shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-mn-error/10 text-mn-error",children:e.jsx(gt,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsx("h2",{className:"text-[15px] font-semibold text-mn-text-primary",children:"Delete message"})]}),e.jsx("button",{type:"button",onClick:()=>te(null),className:"inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-mn-bg text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close delete dialog",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})})]}),e.jsx("p",{className:"mt-3 text-[12px] text-mn-text-secondary",children:"Choose whether to remove this message only from your chat or from the conversation for everyone."}),e.jsxs("div",{className:"mt-5 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{Rt(s=>({...s,[Ne.messageId]:!0})),te(null)},className:"flex-1 rounded-full bg-mn-bg px-3 py-2 text-[13px] font-semibold text-mn-text-primary shadow-mn-soft ring-1 ring-mn-border-subtle/80 transition hover:-translate-y-0.5 hover:bg-mn-bg-elevated",children:"Delete for me"}),e.jsxs("button",{type:"button",disabled:je.isPending,onClick:()=>{je.mutate({messageId:Ne.messageId},{onSettled:()=>{te(null)}})},className:"flex-1 inline-flex items-center justify-center gap-1 rounded-full bg-mn-error px-3 py-2 text-[13px] font-semibold text-white shadow-mn-soft transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70",children:[je.isPending&&e.jsx(G,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),e.jsx("span",{children:"Delete for everyone"})]})]}),e.jsx("button",{type:"button",onClick:()=>te(null),className:"self-center text-[12px] text-mn-text-secondary hover:text-mn-text-primary",children:"Cancel"})]})]})}),_t&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-[min(520px,calc(100%-2rem))] rounded-3xl border border-mn-border-subtle/70 bg-mn-bg/95 p-5 shadow-2xl",children:[e.jsx("button",{type:"button",onClick:Xe,className:"absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full bg-mn-bg-elevated/80 text-mn-text-secondary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg","aria-label":"Close gallery picker",children:e.jsx(Me,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"flex items-start gap-3 pr-10",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-fuchsia-500/10 via-mn-primary/10 to-blue-500/10 text-mn-text-primary ring-1 ring-mn-border-subtle",children:e.jsx(ut,{className:"h-4 w-4","aria-hidden":"true"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-mn-text-primary",children:"Send from your gallery"}),e.jsx("p",{className:"text-[12px] text-mn-text-secondary",children:"Pick a recent photo to drop into the chatâ€”just like Instagram DMs."})]})]}),e.jsxs("div",{className:"mt-4 rounded-2xl border border-dashed border-mn-border-subtle/80 bg-mn-bg/80 p-4",children:[I?e.jsx("div",{className:"overflow-hidden rounded-xl border border-mn-border-subtle/70 bg-mn-bg-elevated/80",children:e.jsx("img",{src:I,alt:"Selected",className:"max-h-[320px] w-full object-cover"})}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-3 py-10 text-center text-mn-text-muted",children:[e.jsx(mt,{className:"h-8 w-8","aria-hidden":"true"}),e.jsx("p",{className:"text-[13px] text-mn-text-secondary",children:"Choose a photo from your camera roll."})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>{var s;return(s=be.current)==null?void 0:s.click()},className:"inline-flex items-center gap-2 rounded-full bg-mn-bg-elevated/80 px-4 py-2 text-[13px] font-semibold text-mn-text-primary shadow-mn-soft transition hover:-translate-y-0.5 hover:bg-mn-bg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mn-primary focus-visible:ring-offset-2 focus-visible:ring-offset-mn-bg",children:[e.jsx(mt,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:"Choose another photo"})]}),e.jsxs("button",{type:"button",onClick:Pt,disabled:!oe||he,className:"inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-fuchsia-500 via-mn-primary to-blue-500 px-4 py-2 text-[13px] font-semibold text-white shadow-lg shadow-mn-primary/30 transition hover:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-60",children:[he?e.jsx(G,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):e.jsx(ft,{className:"h-4 w-4","aria-hidden":"true"}),e.jsx("span",{children:he?"Sendingâ€¦":"Send photo"})]})]})]})]})})]})},Is=(t,n,o,r,i,u)=>{if(!n||!i||t.senderId!==i)return null;if(u[t.id])return{status:"failed"};if(t.id.startsWith("temp-"))return{status:"sending"};const f=n.participants.filter(N=>!N.isSelf);if(f.length===0)return null;const c=f.map(N=>N.id),m=new Date(t.createdAt).getTime(),v=(o??[]).filter(N=>N.messageId===t.id&&c.includes(N.userId)).length,y=r??[];let k=0,x=null;for(const N of f){const D=y.find($=>$.userId===N.id);if(!D||!D.lastReadAt)continue;const A=new Date(D.lastReadAt).getTime();Number.isNaN(A)||A>=m&&(k+=1,(x===null||A>x)&&(x=A))}return k===f.length&&f.length>0?{status:"seen",seenAt:x!=null?new Date(x).toISOString():null}:v>0?{status:"delivered"}:{status:"sent"}};export{Ms as ChatImage,Qs as default,Rs as useSendMessage};
