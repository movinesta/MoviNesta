import{b as p,c as q,e as D,w as f,q as o,s as b,aD as L,m as Q,D as h}from"./index-DHFRnTo7.js";const w=n=>n==="movie"||n==="series"||n==="anime"?n:n==="episode"?"series":"movie",S=(n,t)=>{const{user:r}=p(),_=t??r?.id??null,y=q({queryKey:["diary","library",_],enabled:!!_,queryFn:async()=>{if(!_)return[];const{data:i,error:a}=await b.from("library_entries").select("id, title_id, status, updated_at").eq("user_id",_).order("updated_at",{ascending:!1}).limit(500);if(a)throw new Error(a.message);const l=i??[];if(!l.length)return[];const s=Array.from(new Set(l.map(u=>u.title_id).filter(u=>!!u)));let c=new Map;if(s.length){const{data:u,error:d}=await b.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",s);d?console.warn("[useDiaryLibrary] Failed to load titles for library entries",d.message):c=new Map(u.map(g=>[g.id,Q(g)]))}let m=new Map;if(s.length){const{data:u,error:d}=await b.from("ratings").select("title_id, rating").eq("user_id",_).in("title_id",s);!d&&u?m=new Map(u.map(g=>[g.title_id,h(g.rating)])):d&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",d.message)}return l.map(u=>{const d=c.get(u.title_id),g=m.get(u.title_id)??null;return{id:u.id,titleId:u.title_id,status:u.status,updatedAt:u.updated_at,title:d?.title??"Untitled",year:d?.year??null,type:d?.type??null,posterUrl:d?.posterUrl??d?.backdropUrl??null,rating:g}})}});return{entries:(y.data??[]).filter(i=>!(n.status&&n.status!=="all"&&i.status!==n.status||n.type&&n.type!=="all"&&i.type!==n.type)),isLoading:y.isLoading,isError:y.isError,error:y.error instanceof Error?y.error.message:null}},I=n=>{const{user:t}=p(),r=t?.id??null;return q({queryKey:o.titleDiary(r,n),enabled:!!(r&&n),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!r||!n)return{status:null,rating:null};const[{data:_,error:y},{data:e,error:i}]=await Promise.all([b.from("library_entries").select("status").eq("user_id",r).eq("title_id",n).maybeSingle(),b.from("ratings").select("rating").eq("user_id",r).eq("title_id",n).maybeSingle()]);if(y&&y.code!=="PGRST116")throw y;if(i&&i.code!=="PGRST116")throw i;return{status:_?.status??null,rating:h(e?.rating??null)}}})},K=()=>{const{user:n}=p(),t=n?.id??null,r=D(),_=f({mutationFn:async({titleId:e,status:i,type:a})=>{if(!t)throw new Error("Not authenticated");if(!a)throw new Error("Content type is required");const l=w(a),{error:s}=await b.from("library_entries").upsert({user_id:t,title_id:e,status:i,updated_at:new Date().toISOString(),content_type:l},{onConflict:"user_id,title_id"});if(s)throw new Error(s.message);return{titleId:e,status:i}},onMutate:async e=>{if(!t)return{};await r.cancelQueries({queryKey:o.diaryLibrary(t)});const i=r.getQueryData(o.diaryLibrary(t)),a=new Date().toISOString();return r.setQueryData(o.diaryLibrary(t),l=>{const s=l??[],c=s.find(d=>d.titleId===e.titleId);return c?[{...c,status:e.status,updatedAt:a,type:e.type??c.type},...s.filter(g=>g.titleId!==e.titleId)]:!(e.title||e.posterUrl)?s:[{id:`tmp-${e.titleId}`,titleId:e.titleId,status:e.status,updatedAt:a,title:e.title??"Untitled",year:e.year??null,type:e.type??null,posterUrl:e.posterUrl??null,rating:null},...s]}),r.setQueryData(o.titleDiary(t,e.titleId),l=>({status:e.status,rating:l?.rating??null})),{prevLibrary:i}},onError:(e,i,a)=>{t&&a?.prevLibrary&&r.setQueryData(o.diaryLibrary(t),a.prevLibrary)},onSettled:()=>{t&&(r.invalidateQueries({queryKey:o.diaryLibrary(t)}),r.invalidateQueries({queryKey:o.diaryStats(t)}),r.invalidateQueries({queryKey:o.homeForYou(t)}),r.invalidateQueries({queryKey:o.titleDiary(t,void 0)}))}}),y=f({mutationFn:async({titleId:e,rating:i,type:a})=>{if(!t)throw new Error("Not authenticated");if(!a)throw new Error("Content type is required");const l=w(a);if(i==null){const{error:m}=await b.from("ratings").delete().eq("user_id",t).eq("title_id",e);if(m)throw new Error(m.message);return{titleId:e,rating:null}}const s=L(i);if(s==null)throw new Error("Invalid rating value");const{error:c}=await b.from("ratings").upsert({user_id:t,title_id:e,rating:s,updated_at:new Date().toISOString(),content_type:l},{onConflict:"user_id,title_id"});if(c)throw new Error(c.message);return{titleId:e,rating:i}},onMutate:async e=>{if(!t)return{};await r.cancelQueries({queryKey:o.diaryLibrary(t)});const i=r.getQueryData(o.diaryLibrary(t));return r.setQueryData(o.diaryLibrary(t),a=>{const l=a??[],s=l.findIndex(u=>u.titleId===e.titleId);if(s===-1)return l;const c={...l[s],rating:e.rating},m=[...l];return m[s]=c,m}),r.setQueryData(o.titleDiary(t,e.titleId),a=>({status:a?.status??null,rating:e.rating})),{prevLibrary:i}},onError:(e,i,a)=>{t&&a?.prevLibrary&&r.setQueryData(o.diaryLibrary(t),a.prevLibrary)},onSettled:()=>{t&&(r.invalidateQueries({queryKey:o.diaryLibrary(t)}),r.invalidateQueries({queryKey:o.diaryStats(t)}),r.invalidateQueries({queryKey:o.homeForYou(t)}),r.invalidateQueries({queryKey:o.titleDiary(t,void 0)}))}});return{updateStatus:_,updateRating:y}};export{S as a,I as b,K as u};
