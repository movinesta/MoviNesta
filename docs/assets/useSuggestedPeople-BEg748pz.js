import{b as L,e as $,c as k,s as d,d as X}from"./index-CuXsBKB-.js";const Y="moviNesta.suggestedPeople.dismissed.v1",M=s=>`${Y}:${s}`,N=s=>{try{const n=localStorage.getItem(M(s));if(!n)return[];const i=JSON.parse(n);return Array.isArray(i)?i.filter(y=>typeof y=="string"):[]}catch{return[]}},j=(s,n)=>{const i=new Set(N(s));i.add(n);try{localStorage.setItem(M(s),JSON.stringify(Array.from(i)))}catch{}},H=()=>{const{user:s}=L(),n=$();return{...k({queryKey:["suggested-people",s?.id??null],enabled:!!s?.id,staleTime:1e3*60*5,gcTime:1e3*60*30,queryFn:async()=>{if(!s?.id)return[];const a=s.id,R=new Set(N(a)),{data:U,error:_}=await d.from("follows").select("followed_id").eq("follower_id",a);_&&console.warn("[useSuggestedPeople] Failed to load follows",_.message);const h=new Set((U??[]).map(e=>e.followed_id)),C=new Set([a,...R,...h]),{data:v,error:P}=await d.from("ratings").select("title_id, rating").eq("user_id",a).order("rating",{ascending:!1}).limit(40);P&&console.warn("[useSuggestedPeople] Failed to load viewer ratings",P.message);const S=v?v.filter(e=>typeof e.title_id=="string"&&typeof e.rating=="number").slice(0,30):[],p=Array.from(new Set(S.map(e=>e.title_id))),T=new Map(S.map(e=>[e.title_id,e.rating??0])),{data:B,error:E}=await d.from("user_stats").select("user_id, followers_count, following_count").order("followers_count",{ascending:!1}).limit(60);E&&console.warn("[useSuggestedPeople] Failed to load user_stats",E.message);const A=(B??[]).filter(e=>!C.has(e.user_id)),m=A.map(e=>e.user_id).slice(0,40);if(!m.length)return[];const{data:D,error:F}=await d.from("profiles_public").select("id, username, display_name, avatar_url, bio").in("id",m).limit(40);if(F)throw new Error(F.message);const x=new Map(A.map(e=>[e.user_id,{followersCount:e.followers_count??0,followingCount:e.following_count??0}])),f=new Map;if(p.length>=5){const{data:e,error:t}=await d.from("ratings").select("user_id, title_id, rating").in("user_id",m).in("title_id",p).limit(2e3);if(t)console.warn("[useSuggestedPeople] Failed to load candidate ratings",t.message);else{const r=e??[],l=new Map;r.forEach(o=>{if(!o?.user_id)return;const c=l.get(o.user_id)??[];c.push(o),l.set(o.user_id,c)}),m.forEach(o=>{const I=(l.get(o)??[]).filter(u=>T.has(u.title_id)),g=I.length;if(!g){f.set(o,{commonTitlesCount:0,matchPercent:0,score:0});return}let b=0,w=0;I.forEach(u=>{const q=T.get(u.title_id);typeof q!="number"||typeof u.rating!="number"||(b+=Math.abs(q-u.rating),w+=1)});const K=w?b/w:0,Q=g*10-K*2,J=Math.round(g/Math.max(1,p.length)*100);f.set(o,{commonTitlesCount:g,matchPercent:J,score:Q})})}}const O=(D??[]).map(e=>{const t=x.get(e.id),r=f.get(e.id);return{id:e.id,username:e.username??null,displayName:e.display_name??null,avatarPathOrUrl:typeof e.avatar_url=="string"?e.avatar_url:null,bio:e.bio??null,followersCount:t?.followersCount??0,followingCount:t?.followingCount??0,isFollowing:h.has(e.id),commonTitlesCount:r?.commonTitlesCount,matchPercent:r?.matchPercent,_score:r?.score??0}}).filter(e=>!C.has(e.id));return(await Promise.all(O.map(async e=>{const t=await X(e.avatarPathOrUrl);return{id:e.id,username:e.username,displayName:e.displayName,avatarUrl:t,bio:e.bio,followersCount:e.followersCount,followingCount:e.followingCount,isFollowing:e.isFollowing,commonTitlesCount:e.commonTitlesCount,matchPercent:e.matchPercent}}))).map(e=>({person:e,score:f.get(e.id)?.score??0})).sort((e,t)=>{if(t.score!==e.score)return t.score-e.score;const r=e.person.commonTitlesCount??0,l=t.person.commonTitlesCount??0;if(l!==r)return l-r;if(t.person.followersCount!==e.person.followersCount)return t.person.followersCount-e.person.followersCount;const o=(e.person.displayName??e.person.username??"").toLowerCase(),c=(t.person.displayName??t.person.username??"").toLowerCase();return o.localeCompare(c)}).map(e=>e.person).slice(0,15)}}),dismissPerson:a=>{s?.id&&(j(s.id,a),n.invalidateQueries({queryKey:["suggested-people",s.id]}))}}};export{H as u};
