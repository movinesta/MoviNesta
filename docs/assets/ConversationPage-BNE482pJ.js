import{C as Qe,s as z,r as n,ap as Ne,e as te,a7 as Ln,aq as lt,b as ct,ar as Un,c as ut,w as It,as as ds,at as qn,au as Bn,aj as Et,o as Pn,av as fs,n as On,aw as hs,ax as Fn,ay as xs,am as St,N as ys,az as $n,R as G,j as s,i as Tt,E as ue,B as Q,aA as Hn,aB as Kn,aC as Qn,u as bs,an as K,aD as vs,I as zn,A as Jn,ao as ms,K as Vn,L as Wn}from"./index-CfTfJYoU.js";import{m as dt,a as Gn,b as Yn,M as _t,s as Xn,i as ws,c as Ms,d as Rs,e as js,f as Zn,n as er,r as Ns,g as Cs,h as tr,C as sr,j as nr,k as rr,S as ar,T as or,l as gs,u as ir,o as lr,p as cr,q as ur,t as dr,v as fr}from"./scroll-area-BCFt3Rtp.js";import{u as je}from"./conversationsCache-CKx9AURX.js";import{w as mr,a as gr,B as pr,u as hr,M as xr}from"./useAssistantCache-CvgGFn-k.js";import{B as yr}from"./bell-D1CEAIiq.js";import{T as Ss}from"./textarea-DKtbA0EV.js";import{C as br}from"./circle-alert-Cu2R71XH.js";import{D as At,a as Dt,b as ks,c as Lt,d as Is,e as Es}from"./dialog-BRBrZ1TA.js";import{M as V}from"./material-icon-NWvnVlF6.js";import{C as vr}from"./copy-Bv3lw6FN.js";import{U as wr}from"./user-DNCrN4XO.js";import{u as Mr}from"./useUserLastActive-CyZDxpqH.js";import"./format-BXv9LLlt.js";import"./plus-rw_vdmR_.js";import"./x-FYpVRaY2.js";import"./index-C3N8ArEg.js";import"./clock-DE6XxnqF.js";const Rr=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],jr=Qe("arrow-down",Rr);const Nr=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],Cr=Qe("camera",Nr);const Sr=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],kr=Qe("send",Sr);const Ir=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],Ts=Qe("shield-x",Ir);const Er=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],Tr=Qe("smile",Er),kt=new Map,_r=t=>{const e=kt.get(t);if(e)return e;const r=z.channel(`conversation-db-${t}`),o={conversationId:t,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.messageInsertListeners)u(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.messageUpdateListeners)u(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.readReceiptUpsertListeners)u(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.readReceiptUpsertListeners)u(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.deliveryReceiptUpsertListeners)u(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.deliveryReceiptUpsertListeners)u(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.reactionUpsertListeners)u(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.reactionUpsertListeners)u(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${t}`},a=>{const l=a;for(const u of o.reactionDeleteListeners)u(l)}),r.subscribe(a=>{const l=a;o.lastStatus=l;for(const u of o.statusListeners)u(l)}),kt.set(t,o),o},Ar=(t,e)=>{const r=_r(t);r.refCount+=1;const o=[];return e.onStatus&&(r.statusListeners.add(e.onStatus),o.push(()=>r.statusListeners.delete(e.onStatus)),r.lastStatus&&e.onStatus(r.lastStatus)),e.onMessageInsert&&(r.messageInsertListeners.add(e.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(e.onMessageInsert))),e.onMessageUpdate&&(r.messageUpdateListeners.add(e.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(e.onMessageUpdate))),e.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(e.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(e.onReadReceiptUpsert))),e.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(e.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(e.onDeliveryReceiptUpsert))),e.onReactionUpsert&&(r.reactionUpsertListeners.add(e.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(e.onReactionUpsert))),e.onReactionDelete&&(r.reactionDeleteListeners.add(e.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(e.onReactionDelete))),()=>{for(const a of o)a();if(r.refCount-=1,r.refCount<=0){try{z.removeChannel(r.channel)}catch{}kt.delete(t)}}},ft=(t,e,r)=>{n.useEffect(()=>{if(t)return Ar(t,e())},[t,e,...r])},Dr=5e3,Lr=1500,Ur=5e3,qr=t=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:t?Lr:Dr,refetchIntervalInBackground:!1}),Br=new Set(["SUBSCRIBED"]),Pr=t=>!Br.has(t),Or=t=>{const[e,r]=n.useState(!1),o=n.useRef(t);n.useEffect(()=>{Object.is(o.current,t)||(o.current=t,r(!1))},[t]);const a=n.useCallback(l=>{const u=Pr(l);r(h=>h===u?h:u)},[]);return{pollWhenRealtimeDown:e,onStatus:a}},mt=t=>{const{pollWhenRealtimeDown:e,onStatus:r}=Or(t);return{pollWhenRealtimeDown:e,onRealtimeStatus:r,refetchOptions:qr(e)}},Fr=t=>typeof t=="object"&&t!==null,_s=t=>t.new,$r=t=>t.old,Ce=(t,e)=>{if(!Fr(t))return null;const r=t[e];return typeof r=="string"?r:null},As=(t,e)=>Ce(t,"conversation_id")===e,Ds=40,it=1e5,Hr=t=>`"${t.replace(/"/g,'\\"')}"`,Kr=t=>{const e=Hr(t.createdAt),r=t.id;return`created_at.lt.${e},and(created_at.eq.${e},id.lt.${r})`},Qr=t=>{const e=Xn((t??[]).map(dt)),r=(t??[]).length>=Ds,o=e.length?{createdAt:e[0].createdAt,id:e[0].id}:null;return{items:e,hasMore:r,cursor:o}},zr=(t,e)=>{const r=n.useMemo(()=>Ne(t),[t]),o=te(),[a,l]=n.useState(it),{pollWhenRealtimeDown:u,onRealtimeStatus:h,refetchOptions:m}=mt(t),p=n.useRef(e);n.useEffect(()=>{p.current=e},[e]);const b=n.useRef({pages:0,total:0}),x=Ln({queryKey:r,enabled:!!t,initialPageParam:null,...m,staleTime:Ur,queryFn:async({pageParam:v})=>{if(!t)return{items:[],hasMore:!1,cursor:null};let d=z.from("messages").select(_t).eq("conversation_id",t).order("created_at",{ascending:!1}).order("id",{ascending:!1});v&&(d=d.or(Kr(v)));const{data:N,error:C}=await d.limit(Ds);if(C)throw console.error(`[useConversationMessages] Failed to load ${v?"older messages":"messages"}`,C),new Error(C.message);return Qr(N??[])},getNextPageParam:()=>{},getPreviousPageParam:v=>{if(v.hasMore)return v.cursor??void 0},structuralSharing:(v,d)=>Yn(v,d)});n.useEffect(()=>{const v=x.data?.pages??[],d=v.reduce((I,M)=>I+M.items.length,0),N=b.current;if(v.length===0){b.current={pages:0,total:0},l(it);return}if(N.pages===0){b.current={pages:v.length,total:d},l(it);return}const C=d-N.total,k=v.length-N.pages;C>0&&k>0&&l(I=>Math.max(0,I-C)),b.current={pages:v.length,total:d}},[x.data?.pages]);const y=n.useCallback(()=>{if(!t)return{};const v=(d,N)=>{const C=_s(d);if(!As(C,t)||!Ce(C,"id"))return;const I=C,M=dt(I);o.setQueryData(r,R=>Gn(R,I,{allowAppend:N==="insert"})),N==="insert"?p.current?.onInsert?.(M):p.current?.onUpdate?.(M)};return{onStatus:h,onMessageInsert:d=>{v(d,"insert")},onMessageUpdate:d=>{v(d,"update")}}},[t,h,o,r]);ft(t,y,[]),n.useEffect(()=>{l(it),b.current={pages:0,total:0}},[t]);const g=n.useMemo(()=>(x.data?.pages??[]).flatMap(d=>d.items),[x.data?.pages]),c=n.useCallback(async()=>{t&&x.hasPreviousPage&&await x.fetchPreviousPage()},[t,x]);return n.useMemo(()=>({data:g,dataUpdatedAt:x.dataUpdatedAt,isLoading:x.isLoading,isFetching:x.isFetching,isError:x.isError,error:x.error,refetch:x.refetch,loadOlder:c,hasMore:!!x.hasPreviousPage,isLoadingOlder:x.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:u}),[g,x.dataUpdatedAt,x.isLoading,x.isFetching,x.isError,x.error,x.refetch,c,x.hasPreviousPage,x.isFetchingPreviousPage,a,r,u])};function Jr(t){const{conversation:e,deliveryReceipts:r,readReceipts:o,currentUserId:a,failedMessages:l,onlyMessageIds:u,messageCreatedAtMsById:h}=t;if(!e||!a)return()=>null;const m=e.participants.filter(g=>!g.isSelf);if(m.length===0)return()=>null;const p=new Set(m.map(g=>g.id)),b=g=>{if(!g)return null;const c=h?.get(g);return c??null},x=new Map;for(const g of o??[]){let c=null;if(g.lastReadMessageId){const N=b(g.lastReadMessageId);N!=null&&(c=N),N==null&&(c=null)}else if(g.lastReadAt){const N=new Date(g.lastReadAt).getTime();Number.isNaN(N)||(c=N)}if(c==null)continue;const v=(()=>{if(!g.lastReadAt)return null;const N=new Date(g.lastReadAt).getTime();return Number.isNaN(N)?null:N})(),d=x.get(g.userId);if(!d||c>d.upToMs){x.set(g.userId,{upToMs:c,readAtMs:v});continue}c===d.upToMs&&v!=null&&(d.readAtMs==null||v>d.readAtMs)&&x.set(g.userId,{upToMs:c,readAtMs:v})}const y=new Map;for(const g of r??[]){if(!p.has(g.userId)||u&&!u.has(g.messageId))continue;let c=y.get(g.messageId);c||(c=new Set,y.set(g.messageId,c)),c.add(g.userId)}return g=>{if(g.senderId!==a)return null;if(l[g.id])return{status:"failed"};if(ws(g.id))return{status:"sending"};const c=(()=>{const C=new Date(g.createdAt??"").getTime();return Number.isNaN(C)?0:C})();let v=0,d=null;for(const C of m){const k=x.get(C.id);if(k&&k.upToMs>=c){v+=1;const I=k.readAtMs??k.upToMs;(d===null||I>d)&&(d=I)}}return v===m.length&&m.length>0?{status:"seen",seenAt:d!=null?new Date(d).toISOString():null}:(y.get(g.id)?.size??0)===m.length&&m.length>0?{status:"delivered"}:{status:"sent"}}}function Vr(t){const{messages:e,conversation:r,currentUserId:o,participantsById:a,reactionsByMessageId:l,hiddenMessageIds:u,deliveryReceipts:h,readReceipts:m,failedMessages:p,lastOwnMessageId:b}=t,x=n.useMemo(()=>{if(!e)return[];const g=new Set;b&&g.add(b);for(const d of Object.keys(p))g.add(d);const c=new Map;for(const d of e){const N=new Date(d.createdAt??"").getTime();Number.isNaN(N)||c.set(d.id,N)}const v=Jr({conversation:r??null,deliveryReceipts:h,readReceipts:m,currentUserId:o,failedMessages:p,onlyMessageIds:g,messageCreatedAtMsById:c});return e.map(d=>{const N=lt(d.body),C=a.get(d.senderId)??null,k=C?.isSelf??(o!=null&&d.senderId===o),I=k&&g.has(d.id)?v(d):null,M=!!I&&k&&!N.deleted&&(I.status==="failed"||b===d.id);return{message:d,meta:N,sender:C,isSelf:k,deliveryStatus:I,showDeliveryStatus:M,reactions:l.get(d.id)??[]}})},[r,o,h,p,b,e,a,l,m]),y=n.useMemo(()=>x.filter(({message:g})=>!u[g.id]),[x,u]);return{uiMessages:x,visibleMessages:y}}function Wr(t){const{messages:e,currentUserId:r,hiddenMessageIds:o}=t;return n.useMemo(()=>{if(!e||!r)return null;for(let a=e.length-1;a>=0;a-=1){const l=e[a];if(!(o[l.id]||l.senderId!==r||lt(l.body).deleted))return l.id}return null},[o,e,r])}const Gr=async t=>{const{data:e,error:r}=await z.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",t).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(e??[]).map(Rs)},Yr=async(t,e)=>{if(e.length===0)return[];const r=z.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",t).in("message_id",e),{data:o,error:a}=await r.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(o??[]).map(js)},Xr=async t=>{const{data:e,error:r}=await z.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",t).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(e??[]).map(Ms)},Zr=(t,e)=>{const r=new Map,o=new Map;for(const l of t){let u=r.get(l.messageId);u||(u=new Map,r.set(l.messageId,u),o.set(l.messageId,[]));let h=u.get(l.emoji);h||(h={emoji:l.emoji,count:0,reactedBySelf:!1},u.set(l.emoji,h),o.get(l.messageId).push(l.emoji)),h.count+=1,e&&l.userId===e&&(h.reactedBySelf=!0)}const a=new Map;for(const[l,u]of r.entries()){const h=o.get(l)??[];a.set(l,h.map(m=>u.get(m)).filter(Boolean))}return a},ea=(t,e,r)=>{const o=t??[],a=r.key(e),l=[...o],u=l.findIndex(h=>r.key(h)===a);return u>=0?l[u]=e:l.push(e),r.sort&&l.sort(r.sort),l},ta=(t,e,r)=>{const o=t??[];return o.length===0?[]:o.filter(a=>r.key(a)!==e)},Ut=t=>e=>{const r=_s(e);if(!As(r,t.conversationId)||t.extraGuard&&!t.extraGuard(r)||!(t.getRequiredId?t.getRequiredId(r):Ce(r,"id")))return;const a=r,l=t.mapRow(a);t.queryClient.setQueryData(t.queryKey,u=>ea(u,l,{key:t.key,sort:t.sort}))},sa=t=>e=>{const r=$r(e),o=t.getRowId?t.getRowId(r):Ce(r,"id");if(!o){t.invalidateWhenMissingId!==!1&&t.queryClient.invalidateQueries({queryKey:t.queryKey});return}t.queryClient.setQueryData(t.queryKey,a=>ta(a,o,{key:t.key}))},na=t=>{const{user:e}=ct(),r=e?.id??null,o=te(),a=n.useMemo(()=>Un(t),[t]),{pollWhenRealtimeDown:l,onRealtimeStatus:u,refetchOptions:h}=mt(t),m=ut({queryKey:a,enabled:!!t,...h,queryFn:()=>t?Xr(t):Promise.resolve([])}),p=n.useCallback(()=>{if(!t)return{};const y=Ut({conversationId:t,queryClient:o,queryKey:a,mapRow:Ms,key:c=>c.id,sort:(c,v)=>{const d=ds(c.createdAt),N=ds(v.createdAt);return d!==N?d-N:c.id.localeCompare(v.id)}}),g=sa({queryClient:o,queryKey:a,key:c=>c.id});return{onStatus:u,onReactionUpsert:y,onReactionDelete:g}},[t,u,o,a]);ft(t,p,[]);const b=It({mutationFn:async({messageId:y,emoji:g})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:c}=await z.from("message_reactions").insert({conversation_id:t,message_id:y,user_id:r,emoji:g});if(c){if(c?.code==="23505"){const{error:v}=await z.from("message_reactions").delete().eq("message_id",y).eq("user_id",r).eq("emoji",g);if(v)throw console.error("[useConversationReactions] Failed to remove reaction",v),v;return}throw console.error("[useConversationReactions] Failed to toggle reaction",c),c}},onMutate:async({messageId:y,emoji:g})=>{if(!t||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:a});const c=o.getQueryData(a);return o.setQueryData(a,v=>{const d=v??[],N=d.findIndex(k=>k.messageId===y&&k.userId===r&&k.emoji===g);if(N>=0){const k=[...d];return k.splice(N,1),k}const C={id:Zn(),conversationId:t,messageId:y,userId:r,emoji:g,createdAt:new Date().toISOString()};return[...d,C]}),{previousReactions:c}},onError:(y,g,c)=>{t&&(c?.previousReactions?o.setQueryData(a,c.previousReactions):o.invalidateQueries({queryKey:a}))},onSuccess:()=>{t&&o.invalidateQueries({queryKey:a})}}),x=n.useMemo(()=>{const y=m.data??[];return Zr(y,r)},[m.data,r]);return{reactions:m.data??[],reactionsByMessageId:x,isLoadingReactions:m.isLoading,toggleReaction:b,pollWhenRealtimeDown:l,queryKey:a}},ra=t=>{const e=te(),r=n.useMemo(()=>qn(t),[t]),{pollWhenRealtimeDown:o,onRealtimeStatus:a,refetchOptions:l}=mt(t),u=ut({queryKey:r,enabled:!!t,...l,queryFn:async()=>t?Gr(t):[]}),h=n.useCallback(()=>{if(!t)return{};const m=Ut({conversationId:t,queryClient:e,queryKey:r,mapRow:Rs,key:p=>p.userId,getRequiredId:p=>Ce(p,"user_id"),sort:(p,b)=>{const x=!p.lastReadAt,y=!b.lastReadAt;if(x&&y)return 0;if(x)return 1;if(y)return-1;const g=new Date(p.lastReadAt).getTime(),c=new Date(b.lastReadAt).getTime();return Number.isNaN(g)&&Number.isNaN(c)?0:Number.isNaN(g)?1:Number.isNaN(c)?-1:c-g}});return{onStatus:a,onReadReceiptUpsert:m}},[t,a,e,r]);return ft(t,h,[]),n.useMemo(()=>({...u,pollWhenRealtimeDown:o,queryKey:r}),[u,o,r])},aa=(t,e)=>{const r=te(),o=n.useMemo(()=>er(e,{excludeTemp:!0,sort:!0}),[e]),a=n.useMemo(()=>Bn(t,o),[t,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:u,refetchOptions:h}=mt(t),m=ut({queryKey:a,enabled:!!(t&&o.length>0),...h,queryFn:async()=>t?o.length===0?[]:Yr(t,o):[]}),p=n.useCallback(()=>{if(!t)return{};if(o.length===0)return{};const x=new Set(o),y=Ut({conversationId:t,queryClient:r,queryKey:a,mapRow:js,key:g=>g.id,extraGuard:g=>{const c=Ce(g,"message_id");return!!(c&&x.has(c))},sort:(g,c)=>{const v=new Date(g.deliveredAt??"").getTime(),d=new Date(c.deliveredAt??"").getTime(),N=Number.isNaN(v)?0:v,C=Number.isNaN(d)?0:d;return N-C}});return{onStatus:u,onDeliveryReceiptUpsert:y}},[t,o,u,r,a]),b=t&&o.length>0?t:null;return ft(b,p,[]),n.useMemo(()=>({...m,pollWhenRealtimeDown:l,queryKey:a}),[m,l,a])},oa=t=>{const{conversationId:e,userId:r,displayName:o}=t,{getNumber:a}=Et(),l=a("ux.typing.inactivity_ms",3e3),u=a("ux.typing.heartbeat_ms",2e3),h=a("ux.typing.remote_ttl_ms",5e3),[m,p]=n.useState({}),b=n.useRef(null),x=n.useRef(new Map),y=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),g=n.useCallback(async C=>{if(!e||!r||!o)return;const k=b.current;k&&await k.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:C}})},[e,r,o]),c=n.useCallback(async()=>{y.current.timeoutId!=null&&(window.clearTimeout(y.current.timeoutId),y.current.timeoutId=null),y.current.isTyping&&(y.current.isTyping=!1,y.current.lastSentAtMs=0,await g(!1))},[g]),v=n.useCallback(C=>{if(!e||!r||!o||!b.current)return;const I=y.current.isTyping;if(C){const M=Date.now();I?M-y.current.lastSentAtMs>u&&(y.current.lastSentAtMs=M,g(!0)):(y.current.isTyping=!0,y.current.lastSentAtMs=M,g(!0)),y.current.timeoutId!=null&&window.clearTimeout(y.current.timeoutId),y.current.timeoutId=window.setTimeout(()=>{y.current.isTyping=!1,y.current.lastSentAtMs=0,y.current.timeoutId=null,g(!1)},l);return}I&&c()},[g,e,o,c,u,l,r]),d=n.useCallback(()=>{p({}),x.current.forEach(C=>window.clearTimeout(C)),x.current.clear()},[]);return n.useEffect(()=>{if(!e)return;d();const C=z.channel(`supabase_realtime_typing:conversation:${e}`,{config:{broadcast:{self:!1}}});b.current=C,C.on("broadcast",{event:"typing"},({payload:M})=>{const R=M;if(!R?.userId||r&&R.userId===r)return;p(j=>{const L={...j};return R.isTyping&&R.displayName?L[R.userId]=R.displayName:delete L[R.userId],L});const w=x.current.get(R.userId);if(w!=null&&window.clearTimeout(w),R.isTyping){const j=window.setTimeout(()=>{p(L=>{const E={...L};return delete E[R.userId],E}),x.current.delete(R.userId)},h);x.current.set(R.userId,j)}else x.current.delete(R.userId)}).subscribe();const k=()=>{document.visibilityState==="hidden"&&c()},I=()=>{c()};return document.addEventListener("visibilitychange",k),window.addEventListener("beforeunload",I),window.addEventListener("pagehide",I),window.addEventListener("blur",I),()=>{document.removeEventListener("visibilitychange",k),window.removeEventListener("beforeunload",I),window.removeEventListener("pagehide",I),window.removeEventListener("blur",I),d(),c(),b.current&&(z.removeChannel(b.current),b.current=null)}},[e,c,r,d]),{remoteTypingUsers:n.useMemo(()=>Object.entries(m).map(([C,k])=>({userId:C,displayName:k})),[m]),noteLocalInputActivity:v,stopTyping:c}},ia=t=>{const{conversationId:e,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:a=250}=t,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const u=n.useMemo(()=>e?`${r}${e}`:null,[e,r]),[h,m]=n.useState("");return n.useEffect(()=>{if(!u){m(""),l.current?.("");return}const x=Pn(u)??"";m(x),l.current?.(x)},[u]),n.useEffect(()=>{if(!u)return;const b=window.setTimeout(()=>{h.trim().length===0?fs(u):On(u,h)},a);return()=>window.clearTimeout(b)},[u,a,h]),{draft:h,setDraft:m,clearDraft:()=>{u&&fs(u),m(""),l.current?.("")}}};function la({showComposer:t,initialHeaderHeight:e=72,initialComposerHeight:r=160}){const o=n.useRef(null),[a,l]=n.useState(e),[u,h]=n.useState(r),[m,p]=n.useState(null),[b,x]=n.useState(!1),y=n.useCallback(g=>h(Math.max(g,a)),[a]);return n.useEffect(()=>{const g=o.current;if(!g)return;const c=()=>l(Math.max(g.getBoundingClientRect().height,0));if(c(),typeof ResizeObserver>"u")return;const v=new ResizeObserver(c);return v.observe(g),()=>v.disconnect()},[]),n.useEffect(()=>{h(g=>Math.max(g,a))},[a]),n.useEffect(()=>{t||h(0)},[t]),{headerRef:o,headerHeight:a,composerHeight:u,isAtBottom:m,setIsAtBottom:p,handleComposerHeightChange:y,showEmojiPicker:b,setShowEmojiPicker:x}}const ca=({conversationId:t,currentUserId:e,showComposer:r,isBlocked:o,blockedYou:a,composerTextareaRef:l})=>{const[u,h]=n.useState(null),[m,p]=n.useState({}),[b,x]=n.useState(null),[y,g]=n.useState(null),[c,v]=n.useState(null),d=n.useRef(null),N=n.useRef(null);n.useEffect(()=>{if(!t||!e){p({});return}if(typeof window>"u")return;const E=`messages:hidden:${e}:${t}`;try{const q=window.localStorage.getItem(E);if(!q){p({});return}const F=JSON.parse(q);if(Array.isArray(F)){const $={};for(const X of F)typeof X=="string"&&X&&($[X]=!0);p($);return}if(F&&typeof F=="object"){const $={};for(const[X,ve]of Object.entries(F))ve&&($[X]=!0);p($);return}p({})}catch{p({})}},[t,e]),n.useEffect(()=>{if(!t||!e||typeof window>"u")return;const E=`messages:hidden:${e}:${t}`;try{const q=Object.keys(m).filter(F=>m[F]);window.localStorage.setItem(E,JSON.stringify(q))}catch{}},[t,e,m]);const C=n.useCallback(()=>{h(null)},[]);n.useEffect(()=>{if(!u||typeof document>"u")return;const E=F=>{const $=F.target;if(!($ instanceof Element)){h(null);return}$.closest(`[data-message-action-scope="${u}"]`)||h(null)},q=F=>{F.key==="Escape"&&h(null)};return document.addEventListener("pointerdown",E,!0),document.addEventListener("keydown",q),()=>{document.removeEventListener("pointerdown",E,!0),document.removeEventListener("keydown",q)}},[u]);const k=n.useCallback(E=>{o||a||lt(E.body).deleted||(h(E.id),l.current?.blur())},[a,l,o]),I=n.useCallback((E,q)=>{o||a||lt(E.body).deleted||(q&&(N.current=q),g({messageId:E.id,text:hs(E.body)??"",body:E.body??null,attachmentUrl:E.attachmentUrl??null}),v(null),C(),l.current?.blur())},[a,C,l,o]),M=n.useCallback(E=>{g(q=>q&&{...q,text:E})},[]),R=n.useCallback(()=>{g(null),v(null),N.current?.focus()},[]);n.useEffect(()=>{y&&queueMicrotask(()=>{d.current?.focus()})},[y]);const w=n.useCallback(E=>{o||a||(C(),x({messageId:E.id,attachmentUrl:E.attachmentUrl??null}),l.current?.blur())},[a,C,l,o]),j=n.useCallback(()=>{x(null)},[]),L=n.useCallback(E=>{p(q=>({...q,[E]:!0}))},[]);return n.useEffect(()=>{u===null&&r&&(y||b||queueMicrotask(()=>l.current?.focus()))},[u,b,y,r,l]),{activeActionMessageId:u,openMessageActions:k,closeMessageActions:C,hiddenMessageIds:m,hideMessageForMe:L,deleteDialog:b,openDeleteDialog:w,closeDeleteDialog:j,editingMessage:y,openEditDialog:I,updateEditingText:M,closeEditDialog:R,editTextareaRef:d,editError:c,setEditError:v}},ps=3e3;function ua(t){const{conversationId:e,userId:r,isAtBottom:o,messages:a}=t,l=te(),u=n.useRef({conversationId:null,messageId:null,userId:null}),h=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{u.current={conversationId:null,messageId:null,userId:null};const m=h.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null,m.lastSentAt=0},[e,r]),n.useEffect(()=>()=>{const m=h.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null},[]),n.useEffect(()=>{if(!e||!a||a.length===0||!r||!o)return;const m=a[a.length-1];if(ws(m.id)||u.current.conversationId===e&&u.current.messageId===m.id&&u.current.userId===r)return;const p=h.current,b=Date.now(),x=p.lastSentAt?b-p.lastSentAt:Number.POSITIVE_INFINITY,y=()=>{je(l,r,e,c=>c.hasUnread?{...c,hasUnread:!1}:c)},g=c=>{p.lastSentAt=Date.now();const v=new Date().toISOString();mr({conversation_id:e,user_id:r,last_read_message_id:c,last_read_at:v}).then(()=>{u.current={conversationId:e,messageId:c,userId:r},y()}).catch(d=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",d)})};if(x<ps){p.pending={conversationId:e,userId:r,messageId:m.id},p.timeoutId==null&&(p.timeoutId=window.setTimeout(()=>{const c=h.current.pending;h.current.pending=null,h.current.timeoutId=null,c&&(u.current.conversationId===c.conversationId&&u.current.messageId===c.messageId&&u.current.userId===c.userId||c.conversationId!==e||c.userId!==r||g(c.messageId))},Math.max(ps-x,0)));return}p.timeoutId!=null&&(window.clearTimeout(p.timeoutId),p.timeoutId=null,p.pending=null),g(m.id)},[e,a,r,l,o])}const da=new Set(["text","image","text+image","system"]),fa=t=>{const{user:e}=ct(),r=e?.id??null,o=te();return It({mutationFn:async({messageId:a,text:l,currentBody:u,attachmentUrl:h})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(h)throw new Error("Cannot edit messages with attachments.");const m=Fn(u,l),p=xs(m),b=da.has(p.type)?p.type:"text",{data:x,error:y}=await z.from("messages").update({body:m,message_type:b,text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(_t).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return dt(x)},onSuccess:a=>{if(!t)return;const l=Ne(t);o.setQueryData(l,u=>Ns(u,a))}})},ma=t=>{const{user:e}=ct(),r=e?.id??null,o=te();return It({mutationFn:async({messageId:a,attachmentUrl:l})=>{if(!t)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const h={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},m=JSON.stringify(h),p=xs(m),{data:b,error:x}=await z.from("messages").update({body:m,message_type:"system",text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null,attachment_url:null}).eq("id",a).eq("conversation_id",t).eq("user_id",r).select(_t).single();if(x)throw console.error("[useDeleteMessage] Failed to delete message",x),new Error(x.message);if(l)try{await Cs(l)}catch(g){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",g)}return dt(b)},onSuccess:a=>{if(!t)return;const l=Ne(t);o.setQueryData(l,u=>Ns(u,a)),o.invalidateQueries({queryKey:St(r)})}})};function ga(t){const{conversationId:e,setDraft:r,messages:o}=t,a=te(),[l,u]=n.useState(null),[h,m]=n.useState(null),[p,b]=n.useState(null),[x,y]=n.useState({}),g=n.useRef({});n.useEffect(()=>{g.current=x},[x]);const c=n.useRef(e);n.useEffect(()=>{e!==c.current&&(c.current=e,u(null),m(null),b(null),y({}),g.current={})},[e]),n.useEffect(()=>()=>{const M=Object.values(g.current),R=Array.from(new Set(M.map(w=>w.attachmentPath).filter(w=>typeof w=="string"&&w.length>0&&!tr(w))));R.length!==0&&z.storage.from(sr).remove(R).then(({error:w})=>{w&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)}).catch(w=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",w)})},[e]),n.useEffect(()=>{o&&y(M=>{const R=new Set(o.map(L=>L.id));let w=!1;const j={...M};for(const L of Object.keys(j))R.has(L)||(delete j[L],w=!0);return w?j:M})},[o]);const v=n.useCallback(()=>{u(null),m(null),b(null)},[]),d=n.useCallback((M,R,w)=>{u(w.message||"Couldn't send. Please try again."),R.text.trim()&&r(R.text),m(R),b(M),y(j=>({...j,[M]:R}))},[r]),N=n.useCallback(M=>{M&&(y(R=>{if(!(M in R))return R;const w={...R};return delete w[M],w}),M===p&&v())},[v,p]),C=n.useCallback(()=>{if(!h)return null;const M=p;return M&&y(R=>{if(!(M in R))return R;const w={...R};return delete w[M],w}),v(),{payload:h,tempId:M}},[v,h,p]),k=n.useCallback(M=>{const R=x[M];return R?(y(w=>{if(!(M in w))return w;const j={...w};return delete j[M],j}),M===p?v():u(null),R):null},[v,x,p]),I=n.useCallback(async M=>{if(!e)return;const R=x[M];if(!R)return;const w=Ne(e);if(a.setQueryData(w,j=>nr(j,M)),y(j=>{if(!(M in j))return j;const L={...j};return delete L[M],L}),M===p&&v(),R.attachmentPath)try{await Cs(R.attachmentPath)}catch(j){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",j)}},[v,e,x,p,a]);return{sendError:l,setSendError:u,lastFailedPayload:h,lastFailedTempId:p,failedMessages:x,clearBannerState:v,onSendFailed:d,onSendRecovered:N,consumeLastFailedForRetry:C,consumeFailedMessageForRetry:k,discardFailedMessage:I}}const pa=({currentUserId:t})=>{const e=te();return n.useCallback(r=>{je(e,t,r.conversationId,o=>{const a=!!(t&&r.senderId===t);return{...o,lastMessagePreview:$n(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:ys(r.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),t&&r.senderId!==t&&gr({conversation_id:r.conversationId,message_id:r.id,user_id:t})},[t,e])},ha=({conversationId:t,userId:e,conversation:r,readReceipts:o,visibleMessages:a})=>{const[l,u]=n.useState(void 0),[h,m]=n.useState(void 0);return n.useEffect(()=>{u(void 0),m(void 0)},[t,e]),n.useEffect(()=>{if(!t||!e||l!==void 0)return;const b=(o??[]).find(x=>x.userId===e)??null;u(b?.lastReadMessageId??null)},[t,l,o,e]),n.useEffect(()=>{!t||!e||h===void 0&&r&&m(!!r.hasUnread)},[r,t,h,e]),{firstUnreadIndex:n.useMemo(()=>{if(h===void 0||!h||a.length===0||l===void 0)return null;if(l===null)return 0;const b=a.findIndex(y=>y.message.id===l);if(b<0)return 0;const x=b+1;return x>=a.length?null:x},[h,l,a]),lastReadMessageId:l,hasUnread:h??!1,isReady:h!==void 0&&l!==void 0}};function xa(t){const{items:e=[],itemContent:r,isLoading:o,loadingContent:a,errorContent:l,emptyContent:u,header:h,footer:m,bottomPadding:p,scrollerRef:b,followOutput:x,onAtBottomChange:y,atBottomThreshold:g=80,onStartReached:c,computeItemKey:v,ariaLabel:d="Messages"}=t,N=G.useRef(null),C=G.useRef(!0),k=G.useRef(null),I=G.useRef(!1),M=G.useCallback(w=>{N.current=w,b&&(typeof b=="function"?b(w):b.current=w)},[b]),R=G.useCallback(w=>w.scrollHeight-w.scrollTop-w.clientHeight<=g,[g]);return G.useLayoutEffect(()=>{const w=N.current;if(!w)return;const j=E=>{C.current=E,k.current!==E&&(k.current=E,y?.(E))},L=()=>{const E=R(w);j(E),c&&(w.scrollTop<=24?I.current||(I.current=!0,c()):w.scrollTop>=80&&(I.current=!1))};return L(),w.addEventListener("scroll",L,{passive:!0}),()=>w.removeEventListener("scroll",L)},[R,y,c]),G.useEffect(()=>{const w=N.current;if(!w)return;const j=C.current,L=typeof x=="function"?x(j):x??!1;L&&j&&requestAnimationFrame(()=>{w.scrollTo({top:w.scrollHeight,behavior:L==="smooth"?"smooth":"auto"})})},[e.length]),o?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:a}):l?s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):e.length?s.jsx("div",{className:"h-full w-full",children:s.jsx("div",{ref:M,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":d,style:{paddingBottom:p??void 0},children:s.jsxs("div",{className:"px-4 pt-3",children:[h,s.jsx("div",{className:"space-y-0",children:e.map((w,j)=>s.jsx(G.Fragment,{children:r(j,w)},v?v(j,w):j))}),m]})})}):s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:u})}const ya=({show:t,pendingCount:e,onClick:r,shortcutHint:o})=>{if(!t)return null;const a=e>1?`Jump to latest message. ${e} new messages`:"Jump to latest message";return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," new message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(jr,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Jump to latest"}),e>0&&s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})},ba=({show:t,unreadCount:e,onClick:r,shortcutHint:o})=>{if(!t||e<=0)return null;const a=e===1?"Jump to the first unread message":`Jump to first unread message. ${e} unread messages`;return s.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[s.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," unread message",e===1?"":"s","."]}),s.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[s.jsx(yr,{className:"h-4 w-4","aria-hidden":!0}),s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx("span",{children:"Unread"}),s.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})};function va(t){const e=t.trim().split(/\s+/).filter(Boolean);return e.length===0?"?":e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]??""}${e[1][0]??""}`.toUpperCase()}function Ct({delayMs:t}){return s.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${t}ms`},"aria-hidden":"true"})}function wa({users:t,className:e}){if(!t.length)return null;const r=t.slice(0,3),o=Math.max(0,t.length-r.length);return s.jsxs("div",{className:Tt("mt-1 flex w-full items-end gap-2 justify-start",e),role:"status","aria-live":"polite","aria-label":t.length===1?`${t[0].displayName} is typing`:"People are typing",children:[s.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(a=>s.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:a.displayName,children:a.avatarUrl?s.jsx("img",{src:a.avatarUrl,alt:a.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:va(a.displayName)})},a.id)),o>0&&s.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:s.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),s.jsx(rr,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Ct,{delayMs:0}),s.jsx(Ct,{delayMs:120}),s.jsx(Ct,{delayMs:240})]})})]})}const Ma=({children:t,className:e,onHeightChange:r,minHeight:o,style:a,...l})=>{const u=G.useRef(null);return G.useEffect(()=>{if(!r||!u.current)return;const h=u.current,m=()=>r(h.getBoundingClientRect().height);m();const p=new ResizeObserver(m);return p.observe(h),()=>p.disconnect()},[r]),s.jsx("div",{ref:u,className:"fixed inset-x-0 bottom-0 z-40 w-full",children:s.jsx("div",{className:"w-full",children:s.jsx("form",{...l,className:Tt("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",e),style:{minHeight:o,...a},children:t})})})},Ra=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],ja=({show:t,headerHeight:e,onHeightChange:r,draft:o,setDraft:a,textareaRef:l,noteLocalInputActivity:u,stopTyping:h,onSendText:m,onRequestScrollToBottom:p,isUploadingImage:b,cancelImageUpload:x,sendError:y,sendErrorMessage:g,canRetrySend:c,onRetrySend:v,uploadError:d,clearUploadError:N,showEmojiPicker:C,setShowEmojiPicker:k,openCameraPicker:I,fileInputRef:M,onImageSelected:R,onImageFile:w,disableSend:j})=>{const{getNumber:L}=Et(),E=Math.max(1,Math.floor(L("ux.messages.max_message_chars",2e3))),q=Math.max(60,Math.floor(L("ux.messages.composer_max_height_px",140))),F=n.useCallback(T=>{const P=T.target.value,J=P.length>E?P.slice(0,E):P;a(J),C&&k(!1),u(J.trim().length>0);const Z=T.target;Z.style.height="auto";const Se=Math.min(Z.scrollHeight,q);Z.style.height=`${Se}px`},[q,E,u,a,k,C]),$=n.useCallback(T=>{T&&(a(P=>{const J=`${P}${T}`;return u(J.trim().length>0),J}),queueMicrotask(()=>{const P=l.current;P&&(P.style.height="auto",P.style.height=`${Math.min(P.scrollHeight,q)}px`)}))},[q,u,a,l]),X=n.useCallback(T=>{if(T.preventDefault(),j||b)return;const P=o.trim();P&&(a(""),h(),m(P))},[j,o,b,m,a,h]);if(!t)return null;const ve=j||!o.trim()||b,ze=b||j;return s.jsxs(Ma,{onSubmit:X,className:"space-y-2",onHeightChange:r,minHeight:e,onDragOver:T=>{!w||j||(T.preventDefault(),T.dataTransfer.dropEffect="copy",T.currentTarget.dataset.dragging="true")},onDragLeave:T=>{T.currentTarget.dataset.dragging="false"},onDrop:T=>{if(!w||j||b)return;T.preventDefault(),T.currentTarget.dataset.dragging="false";const P=T.dataTransfer.files;if(!P||P.length===0)return;const J=Array.from(P).find(Z=>Z.type.startsWith("image/"));J&&w(J)},children:[b&&s.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[s.jsx(ue,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold text-foreground",children:"Uploading imageâ€¦"})]}),s.jsx(Q,{type:"button",size:"sm",variant:"outline",onClick:x,children:"Cancel"})]}),y&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(ue,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:g??"Couldn't send. Please try again."})]}),c&&s.jsx(Q,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Retry"})]}),d&&s.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(br,{className:"h-3.5 w-3.5","aria-hidden":"true"}),s.jsx("p",{className:"font-semibold",children:d})]}),s.jsx(Q,{type:"button",size:"sm",variant:"ghost",onClick:N,children:"Dismiss"})]}),s.jsxs("div",{className:"flex w-full items-center gap-2",children:[s.jsxs(Hn,{open:C,onOpenChange:k,children:[s.jsx(Kn,{asChild:!0,children:s.jsx(Q,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:s.jsx(Tr,{className:"h-4 w-4","aria-hidden":"true"})})}),s.jsx(Qn,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:s.jsx(ar,{className:"max-h-64",children:s.jsx("div",{className:"grid grid-cols-9 gap-2",children:Ra.map(T=>s.jsx(Q,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{$(T),k(!1)},children:s.jsx("span",{children:T})},T))})})})]}),s.jsx(Q,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:I,"aria-label":"Send photo",disabled:ze,"aria-busy":b,children:s.jsx(Cr,{className:"h-4 w-4","aria-hidden":"true"})}),s.jsx("input",{type:"file",ref:M,accept:"image/*",className:"hidden",onChange:R}),s.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:s.jsx(Ss,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:F,onBlur:h,onPaste:T=>{if(!w||j||b)return;const P=T.clipboardData?.items;if(!P)return;const J=Array.from(P).find(Se=>Se.type.startsWith("image/"));if(!J)return;const Z=J.getAsFile();Z&&(T.preventDefault(),p?.(),w(Z))},onKeyDown:T=>{if(T.key==="Enter"&&!T.shiftKey){if(j||ve||!o.trim())return;T.preventDefault(),p?.(),T.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),s.jsx(Q,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:T=>T.preventDefault(),disabled:ve,"aria-label":"Send message","aria-busy":b,children:b?s.jsx(ue,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):s.jsx(kr,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},Na=({open:t,editingMessage:e,onOpenChange:r,onCancel:o,onTextChange:a,onSave:l,textareaRef:u,error:h,isSaving:m})=>s.jsx(At,{open:t,onOpenChange:r,children:s.jsxs(Dt,{children:[s.jsxs(ks,{children:[s.jsx(Lt,{children:"Edit message"}),s.jsx(Is,{children:"Update your message for everyone in the conversation."})]}),e&&s.jsx(Ss,{ref:u,value:e.text,onChange:p=>a(p.target.value),rows:3,className:"min-h-[120px]"}),h&&s.jsx("p",{className:"text-xs text-destructive",children:h}),s.jsxs(Es,{className:"gap-2",children:[s.jsx(Q,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),s.jsxs(Q,{type:"button",disabled:!e?.text.trim()||m,onClick:l,children:[m&&s.jsx(ue,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Save"})]})]})]})}),Ca=({open:t,deleteDialog:e,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:a,isDeleting:l})=>s.jsx(At,{open:t,onOpenChange:r,children:s.jsxs(Dt,{children:[s.jsxs(ks,{className:"gap-1",children:[s.jsxs(Lt,{className:"flex items-center gap-2 text-base",children:[s.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:s.jsx(or,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),s.jsx(Is,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),s.jsxs(Es,{className:"gap-2",children:[s.jsx(Q,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!e,children:"Hide for me"}),s.jsxs(Q,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!e,onClick:a,children:[l&&s.jsx(ue,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Delete for everyone"})]})]})]})}),Sa=({participant:t,onClick:e})=>{const r=(t.displayName??t.username??"?").slice(0,1).toUpperCase();return s.jsxs("button",{type:"button",onClick:e,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!e,children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:t.avatarUrl?s.jsx("img",{src:t.avatarUrl,alt:t.displayName,className:"h-full w-full object-cover",loading:"lazy"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),s.jsxs("div",{className:"min-w-0 flex-1",children:[s.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:t.displayName}),s.jsx("p",{className:"truncate text-xs text-muted-foreground",children:t.username?`@${t.username}`:t.isSelf?"You":""})]}),e?s.jsx(V,{name:"chevron_right",className:"text-muted-foreground"}):null]})},ka=({open:t,onOpenChange:e,conversation:r,currentUserId:o,conversationId:a,isMuted:l,onToggleMute:u,otherParticipant:h,isGroupConversation:m,youBlocked:p,blockedYou:b,blockPending:x,onBlockToggle:y})=>{const g=bs(),c=n.useMemo(()=>r?.participants??[],[r?.participants]),v=!m&&!!h?.username&&!h?.isSelf,[d,N]=n.useState(null);n.useEffect(()=>{const M=r?.mutedUntil;if(!l||!M){N(null);return}const R=Date.parse(M);if(!Number.isFinite(R)||R<=Date.now()){N(null);return}try{N(new Date(R).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{N(null)}},[r?.mutedUntil,l]);const C=async()=>{const M=`${window.location.origin}/messages/${a}`;await gs(M)?K.show("Conversation link copied."):K.error("Couldn't copy to clipboard.")},k=async()=>{await gs(a)?K.show("Conversation ID copied."):K.error("Couldn't copy to clipboard.")},I=M=>{if(!M.username){K.show("This profile can't be opened yet.");return}e(!1),g(`/u/${M.username}`)};return s.jsx(At,{open:t,onOpenChange:e,children:s.jsxs(Dt,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none sm:rounded-2xl sm:bottom-6 sm:rounded-b-2xl sm:translate-y-0",children:[s.jsxs("div",{className:"flex items-start justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx(Lt,{className:"text-base",children:"Conversation info"}),s.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:m?`${c.length} participants`:h?.username?`@${h.username}`:"Direct message"})]}),s.jsx("button",{type:"button",onClick:()=>e(!1),className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted/60 hover:text-foreground","aria-label":"Close",children:s.jsx(V,{name:"close"})})]}),s.jsxs("div",{className:"grid gap-2",children:[s.jsxs(Q,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:C,children:[s.jsx(vr,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),s.jsxs(Q,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:k,children:[s.jsx(V,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),s.jsxs(Q,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{u(),e(!1)},children:[s.jsx(pr,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),d?s.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",d]}):null]}),!m&&s.jsxs("div",{className:"mt-2 grid gap-2",children:[s.jsxs(Q,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!v||!h||I(h)},disabled:!v,children:[s.jsx(wr,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),s.jsxs(Q,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:y,disabled:x||b&&!p,children:[s.jsx(Ts,{className:"h-4 w-4","aria-hidden":!0}),p?"Unblock":b?"Blocked":"Block"]}),(b||p)&&s.jsx("p",{className:"text-xs text-muted-foreground",children:b&&!p?"This user has blocked you.":p?"You blocked this user.":null})]}),m&&s.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),s.jsx("div",{className:"grid gap-1",children:c.map(M=>s.jsx(Sa,{participant:M,onClick:M.username&&M.id!==o?()=>I(M):void 0},M.id))})]})]})})};function Ia(){const[t,e]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{e(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),t}const Ea=2;function Ta(t){const{items:e,onJumpToItemIndex:r,minQueryLen:o=Ea}=t,[a,l]=n.useState(!1),[u,h]=n.useState(""),[m,p]=n.useState(0),b=u.trim().toLowerCase(),x=b.length>=o,y=n.useMemo(()=>{if(!x)return[];const R=[];for(let w=0;w<e.length;w++){const j=e[w];if(j.meta.deleted)continue;const L=hs(j.message.body);L&&L.toLowerCase().includes(b)&&R.push(w)}return R},[e,b,x]),g=n.useMemo(()=>{const R=new Set;for(const w of y){const j=e[w]?.message.id;j&&R.add(j)}return R},[e,y]),c=y.length;n.useEffect(()=>{p(0)},[b]),n.useEffect(()=>{c!==0&&(m<0&&p(0),m>c-1&&p(c-1))},[m,c]);const v=n.useCallback(R=>{if(c===0)return;const w=(R%c+c)%c;p(w);const j=y[w];typeof j=="number"&&r?.(j)},[c,y,r]),d=n.useCallback(()=>{v(m+1)},[m,v]),N=n.useCallback(()=>{v(m-1)},[m,v]),C=n.useCallback(()=>{v(0)},[v]),k=n.useCallback(()=>{h(""),p(0)},[]),I=n.useCallback(()=>{l(!1),h(""),p(0)},[]),M=n.useMemo(()=>{if(c===0)return null;const R=y[m];return e[R]?.message.id??null},[m,e,c,y]);return{query:u,setQuery:h,isOpen:a,setIsOpen:l,matchCount:c,activeMatchNumber:c===0?0:m+1,activeMatchIndex:c===0?-1:m,activeMessageId:M,isMatch:R=>g.has(R),jumpNext:d,jumpPrev:N,jumpToFirst:C,clear:k,close:I}}function _a(t,e){return ut({queryKey:vs(t),enabled:!!t&&e,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!t)return null;const{data:r,error:o}=await z.rpc("assistant_reply_status_v1",{p_conversation_id:t});if(o){const a=(o.message??"").toLowerCase();if(a.includes("does not exist")||a.includes("function")||a.includes("schema"))return null;throw new Error(o.message)}return r??null}})}const Ya=()=>{const{conversationId:t}=zn(),e=t??null,r=bs(),{user:o}=ct(),a=te(),{getString:l,getNumber:u}=Et(),h=n.useMemo(()=>l("ux.assistant.username","movinesta").toLowerCase(),[l]),m=n.useMemo(()=>l("ux.presence.label_online","Online"),[l]),p=n.useMemo(()=>l("ux.presence.label_active_recently","Active recently"),[l]),b=n.useMemo(()=>l("ux.presence.label_active_prefix","Active"),[l]),x=n.useMemo(()=>{const i=u("ux.messages.search.min_query_chars",2),f=Number.isFinite(i)?Math.trunc(i):2;return Math.max(1,Math.min(10,f))},[u]),{data:y,isLoading:g}=Jn(),c=o?.id??null,v=hr(),d=n.useMemo(()=>!e||!y?null:y.find(i=>i.id===e)??null,[e,y]),N=d?.isMuted??!1,[C,k]=n.useState(!1),I=n.useCallback(()=>{if(!e)return;if(!c){K.error("Please sign in to manage messages.");return}const i=d?.isMuted??!1,f=d?.mutedUntil??null,S=d?.isHidden??!1;je(a,c,e,D=>({...D,isMuted:!1,mutedUntil:null})),K.show("Unmuted notifications."),ms(c,e,{muted:!1,hidden:S,mutedUntil:null}).then(({ok:D})=>{D||(je(a,c,e,_=>({..._,isMuted:i,mutedUntil:f})),K.error("Couldn't update preferences."))})},[e,c,d,a]),M=n.useCallback(i=>{if(!e)return;if(!c){K.error("Please sign in to manage messages.");return}const f=d?.isMuted??!1,S=d?.mutedUntil??null,D=d?.isHidden??!1;let _=!1,B=null;i.kind==="indefinite"?(_=!0,B=null):(_=!1,B=new Date(Date.now()+i.minutes*6e4).toISOString()),je(a,c,e,ce=>({...ce,isMuted:!0,mutedUntil:B})),K.show(`Muted notifications for ${i.label}.`),ms(c,e,{muted:_,hidden:D,mutedUntil:B}).then(({ok:ce})=>{ce||(je(a,c,e,Nt=>({...Nt,isMuted:f,mutedUntil:S})),K.error("Couldn't update preferences."))})},[e,c,d,a]),R=n.useCallback(()=>{if(N){I();return}k(!0)},[N,I]),w=pa({currentUserId:o?.id??null}),{data:j,isLoading:L,isError:E,error:q,loadOlder:F,hasMore:$,isLoadingOlder:X,pollWhenRealtimeDown:ve}=zr(e,{onInsert:w}),ze=n.useRef(new Set);n.useEffect(()=>{if(!e||!j||j.length===0)return;const i=ze.current,f=new Set(j.map(S=>S.id));for(const S of j)i.has(S.id)||w(S);ze.current=f},[e,j,w]);const{draft:T,setDraft:P}=ia({conversationId:e,hydrate:()=>{queueMicrotask(()=>{const i=_e.current;i&&(i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,140)}px`)})}}),{sendError:J,lastFailedPayload:Z,failedMessages:Se,clearBannerState:ke,onSendFailed:Ls,onSendRecovered:Us,consumeLastFailedForRetry:qs,consumeFailedMessageForRetry:qt,discardFailedMessage:Bt}=ga({conversationId:e,setDraft:i=>P(i),messages:j}),H=d?.isGroup??!1,{getStatus:Pt}=Vn(),O=n.useMemo(()=>{if(!d)return null;const i=d.participants.filter(f=>!f.isSelf);return i.length>0?i[0]:d.participants.length===1?d.participants[0]:null},[d]),Ie=n.useMemo(()=>H||!O?.id?null:Pt(O.id),[Pt,H,O?.id]),Ot=Mr(H?null:O?.id??null),Ee=n.useMemo(()=>{const i=Ot.data??null,f=ys(i);return f?f==="Just now"?"now":f:null},[Ot.data]),se=n.useMemo(()=>{if(v?.conversationId&&e===v.conversationId)return!0;const i=O;return i?i.username?.toLowerCase()===h:!1},[v?.conversationId,e,O,h]),Je=_a(e,se).data??null,[Ft,$t]=n.useState(!1),de=G.useRef({inFlight:!1,queuedMessageId:null}),fe=n.useRef(null),Ve=n.useRef(null);n.useEffect(()=>()=>{fe.current&&(window.clearTimeout(fe.current),fe.current=null),Ve.current=null},[]);const[gt,we]=n.useState(null),We=n.useCallback(async i=>{if(!(!e||!c)){if(de.current.inFlight){de.current.queuedMessageId=i;return}de.current.inFlight=!0,de.current.queuedMessageId=null,$t(!0),we(null);try{const{data:f,error:S}=await z.functions.invoke("assistant-chat-reply",{body:{conversationId:e,userMessageId:i}});if(S){const D=S?.context?.status??S?.status??null,_=String(S.message||"Assistant failed"),B=_.toLowerCase();D===429||B.includes("429")||B.includes("rate_limited")||B.includes("rate limit")||B.includes("too many requests")?K.show("Assistant queued â€” try again in a moment."):we({userMessageId:i,error:_})}else if(!f?.ok){const D=f?.code?String(f.code):"Assistant failed";D==="RATE_LIMITED"?K.show("Assistant queued â€” try again in a moment."):we({userMessageId:i,error:D})}}catch(f){we({userMessageId:i,error:f?.message||"Assistant failed"})}finally{$t(!1),a.invalidateQueries({queryKey:Ne(e)}),a.invalidateQueries({queryKey:St(c)}),a.invalidateQueries({queryKey:vs(e)}),de.current.inFlight=!1;const f=de.current.queuedMessageId;de.current.queuedMessageId=null,f&&f!==i&&We(f)}}},[e,c,a]),Ht=n.useCallback(i=>{!e||!c||se&&(Ve.current=i,fe.current&&window.clearTimeout(fe.current),fe.current=window.setTimeout(()=>{const f=Ve.current;Ve.current=null,fe.current=null,f&&We(f)},600))},[e,c,se,We]),Bs=n.useCallback(async(i,f)=>{if(e)try{const{data:S,error:D}=await z.functions.invoke("assistant-message-action",{body:{conversationId:e,messageId:i,actionId:f}});if(D)throw new Error(D.message||"Action failed");if(!S?.ok)throw new Error(S?.error||"Action failed");const _=S?.toast;_&&K.success(_);const B=S?.navigateTo;B&&r(B)}catch(S){const D=S instanceof Error?S.message:String(S);K.error(D||"Action failed")}finally{e&&a.invalidateQueries({queryKey:Ne(e)}),c&&a.invalidateQueries({queryKey:St(c)})}},[e,c,r,a]),Te=d?.title??O?.displayName??O?.username??"Conversation",Kt=ir(e,{onFailed:Ls,onRecovered:Us,otherUserId:H?null:O?.id??null}),Me=n.useCallback((i,f)=>{ke(),Kt.mutate({text:i.text,attachmentPath:i.attachmentPath,clientId:i.clientId,tempId:f?.tempId},{onSuccess:async S=>{ke(),se&&e&&c&&i.text.trim().length>0&&Ht(S.id)}})},[ke,e,c,se,Ht,Kt]),_e=n.useRef(null),pt=n.useRef(null),me=n.useRef(!1),Ps=n.useMemo(()=>{const i=new Map;if(!d)return i;for(const f of d.participants)i.set(f.id,f);return i},[d]),{youBlocked:Ae,blockedYou:W,isBlocked:ge,block:Ge,unblock:Ye}=lr(H?null:O?.id??null),{fileInputRef:Os,isUploadingImage:Fs,uploadError:$s,cancelImageUpload:Hs,clearUploadError:Ks,handleImageSelected:Qs,sendImageFile:zs,openFilePicker:Js}=cr({conversationId:e,userId:c,isBlocked:ge,blockedYou:W,attemptSend:Me}),De=!ge&&!W,ht=!!O&&!H,Vs=Ge.isPending||Ye.isPending,[Ws,Qt]=n.useState(!1),Gs=n.useCallback(()=>{if(ht){if(Ae){Ye.mutate();return}W||Ge.mutate()}},[Ge,W,ht,Ye,Ae]),xt=ht?{label:Ae?"Unblock":W?"Blocked":"Block",onClick:()=>{Ae?Ye.mutate():W||Ge.mutate()}}:null,{headerRef:Ys,headerHeight:Xs,composerHeight:Zs,isAtBottom:pe,setIsAtBottom:ne,handleComposerHeightChange:zt,showEmojiPicker:en,setShowEmojiPicker:Xe}=la({showComposer:De}),[tn,Ze]=n.useState(!1),Jt=De?Math.max(Zs,0)+24:40,sn=`${Jt}px`,Vt=Math.max(80,Jt+32),nn=n.useMemo(()=>d?.participants.find(i=>i.isSelf)?.displayName??"You",[d]),{remoteTypingUsers:re,noteLocalInputActivity:rn,stopTyping:an}=oa({conversationId:e,userId:o?.id??null,displayName:nn}),{data:Wt}=ra(e);ua({conversationId:e,userId:o?.id??null,isAtBottom:pe===!0&&tn,messages:j});const{reactionsByMessageId:on,toggleReaction:Gt}=na(e),ln=n.useCallback((i,f)=>{Gt.mutate({messageId:i,emoji:f})},[Gt]),ae=n.useRef(null),yt=n.useRef(!1),he=n.useRef(null),Le=n.useRef(null),et=n.useRef(!1),Re=n.useRef(!1),Ue=n.useRef(!1),[Yt,xe]=n.useState(0),qe=n.useRef(null),[oe,cn]=n.useState(null),Xt=n.useRef(new Map),un=n.useCallback(i=>{qe.current=i,cn(i)},[]),Be=n.useRef(!1),[Zt,tt]=n.useState(!0),es=n.useRef(!0),Pe=Ia();n.useEffect(()=>{es.current=Zt},[Zt]);const{activeActionMessageId:dn,openMessageActions:ts,closeMessageActions:st,hiddenMessageIds:ss,hideMessageForMe:fn,deleteDialog:ye,openDeleteDialog:mn,closeDeleteDialog:bt,editingMessage:be,openEditDialog:gn,updateEditingText:pn,closeEditDialog:vt,editTextareaRef:hn,editError:xn,setEditError:ns}=ca({conversationId:e,currentUserId:c,showComposer:De,isBlocked:ge,blockedYou:W,composerTextareaRef:_e}),nt=Wr({messages:j,currentUserId:c,hiddenMessageIds:ss}),yn=n.useMemo(()=>nt?[nt]:[],[nt]),{data:bn}=aa(e,yn),rs=fa(e),as=ma(e),{visibleMessages:A}=Vr({messages:j,conversation:d,currentUserId:c,participantsById:Ps,reactionsByMessageId:on,hiddenMessageIds:ss,deliveryReceipts:bn??[],readReceipts:Wt??[],failedMessages:Se,lastOwnMessageId:nt}),{firstUnreadIndex:Oe,lastReadMessageId:ie,hasUnread:Fe,isReady:wt}=ha({conversationId:e,userId:o?.id??null,conversation:d,readReceipts:Wt,visibleMessages:A}),os=n.useMemo(()=>{if(!wt||!Fe)return 0;let i=Oe;if(i==null&&typeof ie=="string"&&ie){const f=A.findIndex(S=>S.message.id===ie);i=f>=0?f+1:null}return i==null?0:A.slice(i).filter(f=>!f.isSelf&&!f.meta.deleted).length},[Oe,Fe,ie,wt,A]),rt=A.length>0,$e=n.useRef(A),is=n.useRef($),ee=Pe?"auto":"smooth",Y=n.useCallback(i=>{const f=qe.current;f&&(Be.current=!0,requestAnimationFrame(()=>{f.scrollTo({top:f.scrollHeight,behavior:i??ee}),requestAnimationFrame(()=>{Be.current=!1})}))},[ee]),ls=n.useCallback(()=>{et.current=!0,tt(!0),ne(!0),Ze(!0),Y("auto")},[Y,ne]),He=n.useCallback((i,f)=>{const S=Xt.current.get(i);return S?(Be.current=!0,requestAnimationFrame(()=>{S.scrollIntoView({block:f?.align??"end",behavior:f?.behavior??ee}),requestAnimationFrame(()=>{Be.current=!1})}),!0):!1},[ee]);n.useEffect(()=>{$e.current=A},[A]),n.useEffect(()=>{is.current=$},[$]);const at=n.useRef(null),vn=n.useCallback(()=>{const i=qe.current;i&&(at.current={active:!0,prevScrollHeight:i.scrollHeight,prevScrollTop:i.scrollTop,prevCount:$e.current.length})},[]);G.useLayoutEffect(()=>{const i=at.current,f=qe.current;if(!i?.active||!f||A.length<=i.prevCount)return;const D=f.scrollHeight-i.prevScrollHeight;f.scrollTop=i.prevScrollTop+D,at.current=null},[A.length]),n.useEffect(()=>{Re.current=!1,he.current=null,xe(0)},[e]),n.useEffect(()=>{if(Re.current||!rt||!qe.current)return;const i=A.length-1;i<0||(Re.current=!0,requestAnimationFrame(()=>{Y("auto"),Ze(!0),ne(!0),tt(!0),he.current=A[i]?.message.id??null,xe(0)}))},[e,rt,Y,oe,ne,A]),n.useEffect(()=>{const i=Le.current;if(!i)return;if(!A.some(D=>D.message.id===i)){Le.current=null;return}He(i,{align:"end",behavior:"auto"})&&(Le.current=null)},[He,A]);const ot=A.length>0?A[A.length-1].message.id:null;n.useEffect(()=>{ot&&et.current&&(et.current=!1,Y("auto"))},[ot,Y]),n.useEffect(()=>{ot&&Re.current&&es.current&&(at.current?.active||Le.current||Y(ee))},[ot,ee,Y]),n.useEffect(()=>{if(!oe)return;const i=()=>{const D=oe.scrollHeight-oe.scrollTop-oe.clientHeight<=Vt;tt(_=>_===D?_:D),ne(_=>_===D?_:D),Ze(!0)};i();const f=()=>{i(),Be.current||(Re.current=!0,Ue.current=!1)};return oe.addEventListener("scroll",f,{passive:!0}),()=>oe.removeEventListener("scroll",f)},[oe,Vt,ne]),n.useEffect(()=>{const i=A.length?A[A.length-1]?.message.id??null:null;if(pe===!0){he.current=i,xe(0);return}if(!i)return;const f=he.current;if(f===i)return;const S=f?A.findIndex(B=>B.message.id===f):-1;if(f&&S<0){he.current=i,xe(0);return}const _=A.slice(Math.max(0,S+1)).filter(B=>!B.isSelf).length;_<=0||xe(_)},[pe,A]),n.useEffect(()=>()=>{ae.current!=null&&window.clearTimeout(ae.current)},[]);const wn=()=>{const i=qs();i&&Me(i.payload,{tempId:i.tempId??void 0})},Mn=i=>{ae.current!=null&&window.clearTimeout(ae.current),yt.current=!1,ae.current=window.setTimeout(()=>{yt.current=!0,ts(i)},500)},Rn=()=>{ae.current!=null&&(window.clearTimeout(ae.current),ae.current=null)},jn=n.useCallback(i=>{const f=qt(i.id);f&&Me(f,{tempId:i.id})},[Me,qt]),Nn=n.useCallback(i=>{Bt(i.id)},[Bt]),Cn=n.useCallback(i=>{if(i<0)return;const f=$e.current[i]?.message.id??null;f&&He(f,{align:"center"})},[He]),U=Ta({items:A,onJumpToItemIndex:i=>{me.current=!0,Cn(i)},minQueryLen:x}),le=U.query.trim().length>=x;n.useEffect(()=>{U.close()},[e,U.close]);const Mt=()=>{st(),Xe(!1),U.setIsOpen(!0),queueMicrotask(()=>pt.current?.focus())},Ke=()=>{U.close()};n.useEffect(()=>{const i=f=>{if(f.key==="Escape"){if(U.isOpen){f.preventDefault(),Ke();return}st(),Xe(!1)}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[st,Ke,U.isOpen,Xe]),n.useEffect(()=>{me.current=!1},[U.query]);const Rt=n.useCallback(i=>{const f=A.length-1;if(f<0)return;const S=A[f]?.message.id??null;S&&(he.current=S),xe(0),Y(i??ee),window.setTimeout(()=>{_e.current?.focus()},Pe?0:200)},[ee,Pe,A,Y]),Sn=n.useCallback(i=>{zt(i),pe===!0&&Y("auto")},[zt,pe,Y]),jt=n.useCallback(async i=>{if(Fe&&!Ue.current){Ue.current=!0;try{let f=Oe;if(f==null&&typeof ie=="string"&&ie){let D=0;for(;is.current&&D<8;){const _=$e.current.findIndex(B=>B.message.id===ie);if(_>=0){f=_+1;break}await F(),D+=1}}if(f==null)return;const S=$e.current[f]?.message.id??null;S&&He(S,{align:"start",behavior:i??ee}),window.setTimeout(()=>{_e.current?.focus()},Pe?0:150)}finally{Ue.current=!1}}},[Oe,Fe,wt,ie,F,Pe,ee]),kn=n.useCallback(i=>{if(!i.trim())return;ke(),Re.current=!0,Ue.current=!1,et.current=!0;const f=ur(),S=dr();tt(!0),ne(!0),Ze(!0),Le.current=f,Me({text:i.trim(),attachmentPath:null,clientId:S},{tempId:f})},[Me,ke,ne]);n.useEffect(()=>{he.current=null,xe(0)},[e]),n.useEffect(()=>{const i=f=>{if(f.key.toLowerCase()==="f"&&(f.metaKey||f.ctrlKey)){f.preventDefault(),Mt();return}if(f.key==="End"||f.key==="ArrowDown"&&(f.metaKey||f.ctrlKey)||f.key==="End"&&(f.metaKey||f.ctrlKey)){f.preventDefault(),Rt();return}f.key.toLowerCase()==="u"&&f.altKey&&(f.preventDefault(),jt())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Rt,jt,Mt]);const In=n.useMemo(()=>{if(W)return"You are blocked";if(ge)return"You blocked them";if(re.length>0)return H?re.length===1?`${re[0].displayName??"Someone"} typingâ€¦`:`${re.length} typingâ€¦`:"Typingâ€¦";if(!H&&Ie){if(Ie==="online")return m;if(Ie==="away")return p}return!H&&Ee?Ee==="now"?m:`${b} ${Ee}`:d?.subtitle||(H?"Group chat":"Direct message")},[W,ge,H,Ie,Ee,d?.subtitle,re,m,p,b]),En=n.useMemo(()=>{const i=d?.participants??[],f=new Map(i.map(_=>[_.id,_])),S=[];for(const _ of re){const B=f.get(_.userId),ce=B?.displayName??_.displayName??"Someone";S.push({id:_.userId,displayName:ce,avatarUrl:B?.avatarUrl??null})}return se&&O?.id&&(Ft||Je?.is_typing||Je?.is_queued)&&(S.some(B=>B.id===O.id)||S.unshift({id:O.id,displayName:O.displayName??O.username??Te??"Assistant",avatarUrl:O.avatarUrl??null})),S},[Ft,Je?.is_typing,Je?.is_queued,d?.participants,Te,se,O,re]);return e?s.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[s.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[s.jsxs("div",{ref:Ys,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[s.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("button",{type:"button",onClick:()=>r(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:s.jsx(V,{name:"arrow_back"})}),s.jsxs("div",{className:"relative",children:[s.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:O?.avatarUrl?s.jsx("img",{src:O.avatarUrl,alt:O.displayName??"Conversation",className:"h-full w-full object-cover"}):s.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(O?.displayName??Te).slice(0,2).toUpperCase()})}),!H&&(Ie==="online"||Ee==="now")&&s.jsx("span",{className:Tt("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),s.jsxs("div",{className:"flex flex-col",children:[s.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:Te}),s.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:In})]})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Search in conversation",onClick:()=>{U.isOpen?Ke():Mt()},children:s.jsx(V,{name:"search"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",onClick:()=>K.show("Video calls are coming soon."),children:s.jsx(V,{name:"videocam"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",onClick:()=>Qt(!0),children:s.jsx(V,{name:"info"})}),xt?s.jsx("button",{type:"button",onClick:xt.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":xt.label,children:s.jsx(Ts,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),U.isOpen&&s.jsxs("div",{className:"px-4 pb-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:s.jsx(V,{name:"search",className:"text-muted-foreground"})}),s.jsx("input",{ref:pt,value:U.query,onChange:i=>U.setQuery(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(i.preventDefault(),!le||U.matchCount===0)return;if(i.shiftKey){me.current=!0,U.jumpPrev();return}if(!me.current){U.jumpToFirst(),me.current=!0;return}U.jumpNext()}i.key==="Escape"&&(i.preventDefault(),Ke())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary",autoComplete:"off",spellCheck:!1}),U.query.trim()&&s.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground transition hover:text-foreground","aria-label":"Clear search",onClick:()=>{U.clear(),queueMicrotask(()=>pt.current?.focus())},children:s.jsx(V,{name:"close"})})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Previous match",disabled:!le||U.matchCount===0,onClick:()=>{me.current=!0,U.jumpPrev()},children:s.jsx(V,{name:"keyboard_arrow_up"})}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Next match",disabled:!le||U.matchCount===0,onClick:()=>{me.current=!0,U.jumpNext()},children:s.jsx(V,{name:"keyboard_arrow_down"})}),s.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:le?`${U.activeMatchNumber}/${U.matchCount}`:"0/0"}),s.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Close search",onClick:Ke,children:s.jsx(V,{name:"close"})})]})]}),le&&U.matchCount===0&&s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),s.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[s.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[ve&&s.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:s.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[s.jsx(ue,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),s.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),s.jsx(xa,{items:A,isLoading:L&&!rt,loadingContent:s.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[s.jsx(ue,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),s.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:E?s.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[s.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),q instanceof Error&&s.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:q.message})]}):void 0,emptyContent:rt?void 0:s.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[s.jsx("p",{className:"font-medium text-foreground",children:H?"No messages in this group yet.":"No messages yet."}),s.jsx("p",{className:"mt-1",children:H?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:s.jsxs(s.Fragment,{children:[s.jsx(wa,{users:En}),s.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:$?s.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:X?s.jsxs("span",{className:"inline-flex items-center gap-2",children:[s.jsx(ue,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):s.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:sn,scrollerRef:un,onStartReached:()=>{$&&!X&&(vn(),F())},computeItemKey:(i,f)=>f.message.id,itemContent:(i,f)=>{const{message:S,meta:D,sender:_,isSelf:B,deliveryStatus:ce,reactions:Nt,showDeliveryStatus:Tn}=f,_n=i>0?A[i-1]?.message??null:null,An=i<A.length-1?A[i+1]?.message??null:null,Dn=cs=>{const us=Xt.current;cs?us.set(S.id,cs):us.delete(S.id)};return s.jsx("div",{ref:Dn,"data-message-id":S.id,children:s.jsx(fr,{message:S,meta:D,sender:_,isSelf:B,deliveryStatus:ce,showDeliveryStatus:Tn,reactions:Nt,index:i,previousMessage:_n,nextMessage:An,firstUnreadIndex:Oe,activeActionMessageId:dn,longPressTriggeredRef:yt,onOpenMessageActions:ts,onCloseMessageActions:st,onOpenEditDialog:gn,onOpenDeleteDialog:mn,onToggleReaction:ln,onRetryMessage:jn,onDiscardFailedMessage:Nn,onAssistantAction:Bs,onBubbleTouchStart:Mn,onBubbleTouchEndOrCancel:Rn,searchQuery:le?U.query:void 0,isSearchMatch:le?U.isMatch(S.id):!1,isActiveSearchMatch:le?U.activeMessageId===S.id:!1})})}}),s.jsx(ba,{show:!!(Fe&&os>0&&pe!==!0),unreadCount:os,onClick:jt,shortcutHint:"Alt+U"}),s.jsx(ya,{show:pe!==!0&&Yt>0,pendingCount:Yt,onClick:Rt,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),gt&&se&&De&&s.jsx("div",{className:"px-4 pb-2",children:s.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(V,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),s.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:gt.error})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const i=gt.userMessageId;we(null),We(i)},children:[s.jsx(V,{name:"refresh",className:"text-base"}),"Retry"]}),s.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>we(null),children:"Dismiss"})]})]})}),s.jsx(ja,{show:De,headerHeight:Xs,onHeightChange:Sn,typingUsers:re,isGroupConversation:H,draft:T,setDraft:P,textareaRef:_e,noteLocalInputActivity:rn,stopTyping:an,onSendText:kn,onRequestScrollToBottom:ls,isUploadingImage:Fs,cancelImageUpload:Hs,sendError:!!J,sendErrorMessage:J,canRetrySend:!!Z,onRetrySend:wn,uploadError:$s,clearUploadError:Ks,showEmojiPicker:en,setShowEmojiPicker:Xe,openCameraPicker:Js,fileInputRef:Os,onImageSelected:i=>{ls(),Qs(i)},onImageFile:i=>zs(i),disableSend:!!(ge||W)}),W&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You can't send messages because this user has blocked you."})}),ge&&!W&&s.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:s.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),s.jsx(Na,{open:!!be,editingMessage:be,onOpenChange:i=>{i||vt()},onCancel:vt,onTextChange:pn,textareaRef:hn,error:xn,isSaving:rs.isPending,onSave:()=>{if(!be)return;const i=be.text.trim();i&&(ns(null),rs.mutate({messageId:be.messageId,text:i,currentBody:be.body,attachmentUrl:be.attachmentUrl},{onSuccess:()=>{vt()},onError:()=>{ns("Couldn't save changes. Please try again.")}}))}}),s.jsx(Ca,{open:!!ye,deleteDialog:ye,onOpenChange:i=>{i||bt()},onHideForMe:()=>{ye&&(fn(ye.messageId),bt())},onDeleteForEveryone:()=>{ye&&as.mutate({messageId:ye.messageId,attachmentUrl:ye.attachmentUrl},{onSettled:()=>{bt()}})},isDeleting:as.isPending}),e&&s.jsx(ka,{open:Ws,onOpenChange:Qt,conversation:d,currentUserId:c,conversationId:e,isMuted:N,onToggleMute:R,otherParticipant:O,isGroupConversation:H,youBlocked:Ae,blockedYou:W,blockPending:Vs,onBlockToggle:Gs}),e&&s.jsx(xr,{open:C,onOpenChange:k,conversationTitle:Te,onSelect:i=>M(i)})]}):s.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:s.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[s.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),s.jsx("p",{className:"mt-4",children:s.jsx(Wn,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Ya as default,ir as useSendMessage};
