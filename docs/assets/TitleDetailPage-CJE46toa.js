import{j as e,y as fe,u as ge,R as D,g as be,i as $,h as he,q as B,o as ye,L as q,t as je,v as Ne,s as T,f as ve}from"./index-DwnuloBv.js";import{a as we,c as _e,d as ke,b as Ie}from"./diaryStatus-Ck6ZODvy.js";import{P as _}from"./PageChrome-CQ7wV0I-.js";import{C as O}from"./Chip-BVsegoci.js";import{T as Y}from"./TopBar-Cwkp26YK.js";import"./useMutation-DKHT9dyE.js";const ae=({value:s,max:l=5,disabled:o,onChange:g,size:y="sm"})=>{const b=s??0,a=y==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-xs transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-sm transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:l}).map((z,S)=>{const i=S+1,c=b>=i;return e.jsx("button",{type:"button",onClick:()=>{if(!g||o)return;g(b===i?null:i)},disabled:o,className:`${a} ${c?"border-primary/80 bg-primary/90 text-primary-foreground":"border-border bg-card/60 text-muted-foreground hover:border-primary/70 hover:text-primary/90"}`,"aria-label":`Rate ${i} star${i===1?"":"s"}`,children:"★"},i)})})},Te=({imdb_rating:s,rt_tomato_pct:l,metascore:o})=>{if(!(typeof s=="number"&&s>0||typeof l=="number"&&l>0||typeof o=="number"&&o>0))return null;const y=typeof s=="number"&&!Number.isNaN(s)&&s>0,b=typeof l=="number"&&!Number.isNaN(l)&&l>0,a=typeof o=="number"&&!Number.isNaN(o)&&o>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-muted-foreground",children:[y&&e.jsxs(O,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"IMDb"}),e.jsx("span",{children:s.toFixed(1)})]}),b&&e.jsxs(O,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"Tomatometer"}),e.jsxs("span",{children:[l,"%"]})]}),a&&e.jsxs(O,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"MC"}),e.jsx("span",{children:o})]})]})},Se=`
  id,
  kind,
  tmdb_title,
  tmdb_name,
  tmdb_original_title,
  tmdb_original_name,
  tmdb_release_date,
  tmdb_first_air_date,
  tmdb_runtime,
  tmdb_overview,
  tmdb_tagline,
  tmdb_backdrop_path,
  tmdb_poster_path,
  tmdb_original_language,
  tmdb_origin_country,
  tmdb_genres,
  omdb_title,
  omdb_plot,
  omdb_director,
  omdb_actors,
  omdb_language,
  omdb_country,
  omdb_imdb_rating,
  omdb_imdb_votes,
  omdb_metascore,
  omdb_rating_rotten_tomatoes,
  omdb_year,
  omdb_poster,
  omdb_rated,
  omdb_genre
`,Ce=s=>{if(!s)return null;const l=String(s).match(/(\d{1,3})/);if(!l)return null;const o=Number(l[1]);return Number.isFinite(o)?o:null},W=s=>{if(s==null)return null;const l=typeof s=="number"?s:Number(s);return Number.isFinite(l)?l:null},Ae=()=>{const{titleId:s}=fe(),l=ge(),[o,g]=D.useState(null),y=D.useMemo(()=>be(),[]),b=async t=>{if(!i?.id){alert("You need to be signed in to start a conversation.");return}if(i.id!==t){g(t);try{const r=await Ne("create-direct-conversation",{targetUserId:t},{timeoutMs:25e3});if(!r?.ok||!r.conversationId){const d=r?.errorCode;let p=r?.error??"Failed to get conversation id. Please try again.";d==="UNAUTHORIZED"?p="You need to be signed in to start a conversation.":d==="BAD_REQUEST_SELF_TARGET"?p="You can't start a conversation with yourself.":d==="SERVER_MISCONFIGURED"&&(p="Messaging is temporarily unavailable due to a server issue. Please try again later.");const w=new Error(p);throw w.code=d,w}l(`/messages/${r.conversationId}`)}catch(r){console.error("[TitleDetailPage] Failed to start conversation",r);const d=r instanceof Error?r.message:"Something went wrong while starting the conversation. Please try again.";alert(d)}finally{g(null)}}},{data:a,isLoading:z,isError:S}=$({queryKey:B.titleDetail(s),enabled:!!s,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!s)return null;const{data:t,error:r}=await T.from("media_items").select(Se).eq("id",s).maybeSingle();if(r)throw r;return t}}),{user:i}=he(),{updateStatus:c,updateRating:j}=we(),{data:ne}=_e(s),m=ne??{status:null,rating:null},{data:C,isLoading:ie}=$({queryKey:B.friendsTitleReactions(i?.id??null,s),enabled:!!(i?.id&&s),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!i?.id||!s)return[];const t=i.id,{data:r,error:d}=await T.from("follows").select("followed_id").eq("follower_id",t).limit(80);if(d)throw d;const p=(r??[]).map(n=>n.followed_id).filter(Boolean);if(!p.length)return[];const{data:w,error:te}=await T.from("ratings").select("user_id, rating, created_at").eq("title_id",s).in("user_id",p).order("rating",{ascending:!1}).limit(40);if(te)throw te;const re=(w??[]).map(n=>n.user_id);if(!re.length)return[];const{data:ue,error:se}=await T.from("profiles").select("id, display_name, username, avatar_url").in("id",re);if(se)throw se;const xe=new Map((ue??[]).map(n=>[n.id,{displayName:n.display_name??null,username:n.username??null,avatarUrl:n.avatar_url??null}])),pe=(w??[]).map(n=>{const f=n.user_id,F=xe.get(f);return{userId:f,displayName:F?.displayName??null,username:F?.username??null,avatarUrl:F?.avatarUrl??null,rating:n.rating??null,createdAt:n.created_at??null}}),A=new Map;for(const n of pe){const f=A.get(n.userId);(!f||(n.rating??0)>(f.rating??0))&&A.set(n.userId,n)}return Array.from(A.values()).sort((n,f)=>(f.rating??0)-(n.rating??0))}}),{data:le,isLoading:K}=$({queryKey:B.moreLikeThis(s),enabled:!!s,staleTime:1e3*60*10,gcTime:1e3*60*60,queryFn:async()=>{if(!s)return[];try{const{cards:t}=await ve({sessionId:y,mode:"combined",limit:18,seed:s},{timeoutMs:2e4});return(t??[]).map(r=>({id:String(r.mediaItemId),title:(r.title??"Untitled").trim()||"Untitled",year:r.releaseYear??null,tmdbPosterPath:r.tmdbPosterPath??null,posterUrl:r.posterUrl??null,source:null})).filter(r=>!!(r.id&&r.title))}catch(t){return console.warn("[TitleDetailPage] more-like-this failed",t),[]}}}),h=a?ye(a):null,P=h?.title??"Untitled",G=h?.year??null,u=h?.type??null,k=h?.posterUrl??null,I=h?.backdropUrl??null,N=W(a?.tmdb_runtime),V=a?.tmdb_genres,R=Array.isArray(V)?V.map(t=>{if(!t||typeof t!="object")return null;const r=t.name;return typeof r=="string"&&r.trim()?r.trim():null}).filter(t=>!!t):typeof a?.omdb_genre=="string"?a.omdb_genre.split(",").map(t=>t.trim()).filter(Boolean):[],Q=h?.originalLanguage??null,H=Array.isArray(a?.tmdb_origin_country)&&a.tmdb_origin_country.length?a.tmdb_origin_country[0]:a?.omdb_country??null,v=a?.omdb_plot??a?.tmdb_overview??null,E=a?.tmdb_tagline??null,oe=W(a?.omdb_imdb_rating),de=W(a?.omdb_metascore),ce=Ce(a?.omdb_rating_rotten_tomatoes);if(D.useEffect(()=>{const t=[k,I].filter(r=>!!r);t.length!==0&&t.forEach(r=>{const d=new Image;d.src=r})},[k,I]),!s)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(Y,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(_,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(z)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(Y,{title:"Loading title"}),e.jsx(_,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-card/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-card/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-card/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-card/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-card/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-card/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-card/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-card/40"})]})]})]})})]});if(S||!a)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(Y,{title:"Title not found"}),e.jsxs(_,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"We couldn't find that title."}),e.jsx(q,{to:"/search",className:"mt-3 inline-block text-sm text-primary underline",children:"Back to search"})]})]});const Z=typeof N=="number"&&N>0?`${Math.floor(N/60)}h ${N%60?`${N%60}m`:""}`.trim():null,M=u==="movie"?"Movie":u==="series"?"TV Series":u==="anime"?"Anime":a?.kind??null,J=le??[],x=[];G&&x.push(String(G)),M&&x.push(M),Z&&x.push(Z),H&&x.push(H),Q&&x.push(Q);const X=()=>i?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),L=t=>{if(!(!X()||c.isPending)){if(!u){alert("We couldn't determine the content type for this title yet.");return}c.mutate({titleId:a.id,status:t,type:u})}},ee=t=>{if(!(!X()||j.isPending)){if(!u){alert("We couldn't determine the content type for this title yet.");return}j.mutate({titleId:a.id,rating:t,type:u})}},me=x.length>0?x.join(" · "):"Title details",U=t=>m?.status===t;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-border bg-card/80 shadow-md",children:[e.jsxs("div",{className:"absolute inset-0",children:[I?e.jsx("img",{src:I,alt:P,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-background via-background/70 to-card"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-background via-background/80 to-background/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:k?e.jsx("img",{src:k,alt:P,className:"aspect-[2/3] w-full rounded-2xl object-cover shadow-lg",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-2xl border border-dashed border-border bg-background/70 text-xs text-muted-foreground",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.12em] text-muted-foreground",children:M??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground sm:text-3xl",children:P}),e.jsx("p",{className:"text-[12.5px] text-muted-foreground",children:me})]}),v&&e.jsx("p",{className:"max-w-3xl text-sm leading-relaxed text-muted-foreground sm:text-[14px]",children:v}),e.jsx(Te,{imdb_rating:oe,rt_tomato_pct:ce,metascore:de}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>L("want_to_watch"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${U("want_to_watch")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>L("watching"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${U("watching")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>L("watched"),disabled:c.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${U("watched")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-muted-foreground",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Your rating"}),e.jsx(ae,{value:m?.rating??null,disabled:j.isPending,onChange:ee}),m?.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[m.rating,"/10"]})]}),!i&&e.jsxs("p",{className:"text-[11.5px] text-muted-foreground",children:[e.jsx(q,{to:"/auth",className:"font-medium text-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsxs(_,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"More like this"}),K&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loading…"})]}),K?e.jsx("div",{className:"mt-3 flex gap-2 overflow-x-auto pb-1",children:Array.from({length:6}).map((t,r)=>e.jsx("div",{className:"h-40 w-28 flex-shrink-0 animate-pulse rounded-xl border border-border bg-card/70"},r))}):J.length>0?e.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2",children:J.map(t=>{const r=t.posterUrl??(t.tmdbPosterPath?je(t.tmdbPosterPath,"w342"):null);return e.jsxs("button",{type:"button",onClick:()=>l(`/title/${t.id}`),className:"flex w-28 flex-shrink-0 flex-col gap-1 text-left",children:[e.jsx("div",{className:"aspect-[2/3] w-28 overflow-hidden rounded-xl border border-border bg-card/80",children:r?e.jsx("img",{src:r,alt:t.title,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] text-muted-foreground",children:"No poster"})}),e.jsx("span",{className:"line-clamp-2 text-[12px] text-foreground",children:t.title}),t.year&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:t.year})]},t.id)})}):e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"No similar titles yet."})]}),e.jsx(_,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-background/80 px-3 py-3 text-[12px] text-muted-foreground",children:[E&&e.jsx("p",{className:"text-sm font-medium text-foreground",children:E}),v&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-muted-foreground",children:v}),!E&&!v&&e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"We don't have a plot summary for this title yet."}),R&&R.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:R.slice(0,6).map(t=>e.jsx("span",{className:"rounded-full border border-border px-2 py-[2px] text-xs text-muted-foreground",children:t},t))}),(a.omdb_director||a.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-muted-foreground",children:[a.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Director:"})," ",a.omdb_director]}),a.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Cast:"})," ",a.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),i&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs",children:[e.jsx("span",{className:Ie(m?.status),children:ke(m?.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Rating"}),e.jsx(ae,{value:m?.rating??null,disabled:j.isPending,onChange:ee})]})]})]}),!i&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to see your diary status and ratings for this title."})]}),i&&!ie&&C&&C.length>0&&e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:C.slice(0,4).map(t=>{const r=t.displayName??(t.username?`@${t.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-card text-xs font-semibold text-foreground",children:t.avatarUrl?e.jsx("img",{src:t.avatarUrl,alt:r??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(r??"?")[0]?.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-foreground",children:r}),t.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Rated ",t.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(q,{to:t.username?`/u/${t.username}`:`/u/${t.userId}`,className:"text-xs font-medium text-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>b(t.userId),disabled:o===t.userId,className:"text-xs font-medium text-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:o===t.userId?"Starting…":"Message"})]})]},t.userId)})})]})]})})})]})};export{Ae as default};
