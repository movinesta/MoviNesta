import{c as M,h as D,i as W,s as L,o as C,j as e,R as T,L as j,M as R,r as I}from"./index-BJNwabbL.js";import{Y as q}from"./index-CYeLqM6J.js";import{a as Y}from"./format-DWLSBLoY.js";import{F as w}from"./film-TltTMGlh.js";import{S as B}from"./sparkles-BOrWKM71.js";import{U as K}from"./users-CZPPKxh2.js";import{B as z}from"./bookmark-plus-Ca0thsHG.js";import{S as F}from"./star-eAeRTQdR.js";import{u as P,a as Q,d as G,b as H}from"./diaryStatus-d6O9GDSI.js";const J=[["path",{d:"M2 5h20",key:"1fs1ex"}],["path",{d:"M6 12h12",key:"8npq4p"}],["path",{d:"M9 19h6",key:"456am0"}]],A=M("list-filter",J),V=a=>{switch(a){case"rating_created":return"rating";case"review_created":return"review";case"watchlist_added":return"watchlist";case"follow_created":return"follow";default:return"other"}},m=a=>typeof a=="string"?a:void 0,U=a=>typeof a=="number"&&Number.isFinite(a)?a:void 0,X=(a,d)=>{if(!d||typeof d!="object")return null;const s=d;switch(a){case"rating_created":{const n=U(s.rating);return n===void 0?null:{event_type:a,rating:n,headline:m(s.headline),emoji:m(s.emoji)}}case"review_created":return{event_type:a,rating:U(s.rating),review_snippet:m(s.review_snippet),headline:m(s.headline),emoji:m(s.emoji)};case"watchlist_added":case"watchlist_removed":return{event_type:a,extra:m(s.extra)};case"follow_created":return{event_type:a,extra:m(s.extra)};case"comment_created":case"reply_created":return{event_type:a,extra:m(s.extra)};case"list_created":case"list_item_added":return{event_type:a,extra:m(s.extra)};case"message_sent":return{event_type:a,extra:m(s.extra)};default:return null}},Z=a=>{const{user:d}=D(),s=a??d?.id??null,n=W({queryKey:["diary","timeline",s],enabled:!!s,queryFn:async()=>{if(!s)return[];const{data:c,error:h}=await L.from("activity_events").select("id, created_at, event_type, title_id, payload").eq("user_id",s).order("created_at",{ascending:!1}).limit(100);if(h)throw new Error(h.message);if(!c?.length)return[];const u=Array.from(new Set(c.map(l=>l.title_id).filter(l=>!!l)));let p=new Map;if(u.length){const{data:l,error:o}=await L.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",u);!o&&l?p=new Map(l.map(r=>[r.id,C(r)])):o&&console.warn("[useDiaryTimeline] Failed to load titles",o.message)}return c.map(l=>{const o=l.title_id?p.get(l.title_id)??null:null,r=V(l.event_type),i=X(l.event_type,l.payload);return{id:l.id,createdAt:l.created_at,kind:r,titleId:l.title_id,title:o?.title??null,year:o?.year??null,posterUrl:o?.posterUrl??o?.backdropUrl??null,rating:i?.event_type==="rating_created"?i.rating:i?.event_type==="review_created"?i.rating??null:null,reviewSnippet:i?.event_type==="review_created"?i.review_snippet??null:null,headline:i?.event_type==="rating_created"||i?.event_type==="review_created"?i.headline??null:null,extra:i?.extra??null,emoji:i?.event_type==="rating_created"||i?.event_type==="review_created"?i.emoji??null:null}})}});return{items:n.data??[],isLoading:n.isLoading,isError:n.isError,error:n.error instanceof Error?n.error.message:null}},O=a=>{switch(a.kind){case"rating":return a.rating!=null?`Rated ${a.rating.toFixed(1)}★`:"Rated";case"review":return"Wrote a review";case"watchlist":return"Updated watchlist";case"follow":return"Followed someone";default:return"Activity"}},ee=a=>{switch(a){case"rating":return F;case"review":return R;case"watchlist":return z;case"follow":return K;default:return B}},ue=({userId:a,isOwnProfile:d=!1,displayName:s,username:n})=>{const{items:c,isLoading:h,isError:u,error:p}=Z(a),l=s||(n?`@${n}`:"this user");return h?e.jsx("div",{className:"px-2 pb-4",children:e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((o,r)=>e.jsxs("div",{className:"flex gap-3 rounded-2xl border border-border bg-card/80 p-3 shadow-lg",children:[e.jsx("div",{className:"h-12 w-8 rounded bg-background/60"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-2",children:[e.jsx("div",{className:"h-3 w-1/3 rounded bg-background/70"}),e.jsx("div",{className:"h-3 w-2/3 rounded bg-background/80"}),e.jsx("div",{className:"h-2.5 w-1/2 rounded bg-background/80"})]})]},r))})}):u?e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-destructive/40 bg-destructive/5 p-4 text-center text-xs text-foreground shadow-lg",children:[e.jsxs("p",{className:"font-semibold",children:["Unable to load ",d?"your":"this profile&apos;s"," activity."]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:p??"Please try again in a moment."})]})}):c.length?e.jsx("div",{className:"px-2 pb-4",children:e.jsx(q,{style:{height:"70vh"},data:c,computeItemKey:(o,r)=>r.id,components:{List:T.forwardRef(function(r,i){return e.jsx("ol",{ref:i,className:"space-y-3",...r})})},itemContent:(o,r)=>{const i=ee(r.kind),f=r.titleId?`/title/${r.titleId}`:null;return e.jsx("li",{className:"pb-1",children:e.jsxs("article",{className:"flex gap-3 rounded-2xl border border-border bg-card/80 p-3 shadow-lg",children:[e.jsx("div",{className:"relative h-16 w-11 overflow-hidden rounded bg-background/70",children:r.posterUrl?e.jsx("img",{src:r.posterUrl,alt:r.title??"",className:"h-full w-full object-cover"}):e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-xs text-muted-foreground",children:[e.jsx(w,{className:"mr-1 h-3.5 w-3.5"}),"No poster"]})}),e.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:e.jsxs("span",{className:"flex items-center gap-1 rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-foreground",children:[e.jsx(i,{className:"h-3 w-3","aria-hidden":"true"}),O(r)]})}),e.jsx("span",{className:"shrink-0 text-xs text-muted-foreground",children:Y(r.createdAt)})]}),e.jsx("div",{className:"min-w-0",children:f?e.jsxs(j,{to:f,className:"line-clamp-2 text-sm font-medium text-foreground hover:underline",children:[r.title??"Untitled",r.year?e.jsxs("span",{className:"ml-1 text-xs text-muted-foreground",children:["(",r.year,")"]}):null]}):e.jsx("p",{className:"line-clamp-2 text-sm font-medium text-foreground",children:r.title??"Activity"})}),r.reviewSnippet&&e.jsxs("p",{className:"line-clamp-2 text-xs text-muted-foreground",children:["“",r.reviewSnippet,"”"]}),r.extra&&e.jsx("p",{className:"text-xs text-muted-foreground",children:r.extra})]})]})},r.id)}})}):e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-border bg-card/80 p-5 text-center text-xs text-muted-foreground shadow-lg",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-2xl bg-primary/15",children:e.jsx(w,{className:"h-5 w-5 text-primary","aria-hidden":"true"})}),e.jsx("p",{className:"font-heading text-sm font-semibold text-foreground",children:d?"Your diary is waiting":`${l}'s diary is quiet`}),e.jsx("p",{className:"mt-1 text-xs",children:d?"As you rate titles, write reviews, and update your library, they’ll show up here in a cozy, chronological timeline.":"When they rate titles, share reviews, or log films, their updates will collect here for you to browse."})]})})},te=[{value:"all",label:"All"},{value:"want_to_watch",label:"Want to Watch"},{value:"watching",label:"Watching"},{value:"watched",label:"Watched"},{value:"dropped",label:"Dropped"}],re=[{value:"all",label:"All types"},{value:"movie",label:"Movies"},{value:"series",label:"Series"},{value:"anime",label:"Anime"}],xe=({userId:a,isOwnProfile:d=!1,displayName:s,username:n})=>{const[c,h]=I.useState("all"),[u,p]=I.useState("all"),{entries:l,isLoading:o,isError:r,error:i}=P({status:c==="all"?void 0:c,type:u==="all"?void 0:u},a),{updateStatus:f,updateRating:_}=Q(),N=f.isPending||_.isPending,b=d,k=s||(n?`@${n}`:"this user");return o?e.jsxs("div",{className:"px-2 pb-4",children:[e.jsx("div",{className:"mb-3 flex items-center justify-between gap-2 px-1 text-xs text-muted-foreground",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(A,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:d?"Loading your library…":`Loading ${k}’s library…`})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Array.from({length:6}).map((t,v)=>e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card/80 shadow-lg",children:[e.jsx("div",{className:"h-40 w-full bg-background/70"}),e.jsxs("div",{className:"space-y-1.5 p-2.5",children:[e.jsx("div",{className:"h-3 w-3/4 rounded bg-background/70"}),e.jsx("div",{className:"h-2.5 w-1/2 rounded bg-background/80"}),e.jsx("div",{className:"h-2.5 w-2/3 rounded bg-background/80"})]})]},v))})]}):r?e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-destructive/40 bg-destructive/5 p-4 text-center text-xs text-foreground shadow-lg",children:[e.jsxs("p",{className:"font-semibold",children:["Unable to load ",d?"your":"their"," library."]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:i??"Please try again in a moment."})]})}):l.length?e.jsxs("div",{className:"px-2 pb-4",children:[e.jsxs("div",{className:"mb-3 flex flex-wrap items-center justify-between gap-2 px-1 text-xs",children:[e.jsx("div",{className:"flex flex-wrap gap-1",children:te.map(t=>{const v=c===t.value;return e.jsx("button",{type:"button",onClick:()=>h(t.value),className:`rounded-full border px-2.5 py-1 text-xs transition ${v?"border-primary/60 bg-primary text-foreground shadow-sm":"border-border bg-card/80 text-muted-foreground hover:border-border hover:text-foreground"}`,children:t.label},t.value)})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(A,{className:"h-3.5 w-3.5 text-muted-foreground","aria-hidden":"true"}),e.jsxs("label",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx("span",{children:"Type"}),e.jsx("select",{value:u,onChange:t=>p(t.target.value),className:"rounded-full border border-border bg-card/80 px-2 py-1 text-xs text-foreground",children:re.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 sm:grid-cols-3",children:l.length===0?e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center py-12 text-center text-sm text-muted-foreground",children:[e.jsx("p",{className:"font-medium text-foreground",children:d?"Your diary is empty":"No diary entries yet"}),e.jsx("p",{className:"mt-1 max-w-xs text-xs text-muted-foreground",children:d?"Start by searching for a movie or show and adding it to your diary.":"When they start logging what they watch, it will show up here."}),d&&e.jsx(j,{to:"/search",className:"mt-4 inline-flex items-center rounded-full bg-primary px-4 py-1.5 text-xs font-medium text-primary-foreground shadow-sm hover:bg-primary/90",children:"Search titles"})]}):l.map(t=>{const v=()=>{if(!b)return;const x=["want_to_watch","watching","watched","dropped"],g=x.indexOf(t.status),y=x[(g+1)%x.length];f.mutate({titleId:t.titleId,status:y,type:t.type})},$=x=>{if(!b)return;const g=t.rating===x?null:x;_.mutate({titleId:t.titleId,rating:g,type:t.type})},S=`/title/${t.titleId}`;return e.jsxs("article",{className:"group flex flex-col overflow-hidden rounded-2xl border border-border bg-card/80 shadow-lg",children:[e.jsx(j,{to:S,className:"relative block",children:e.jsx("div",{className:"aspect-[2/3] w-full overflow-hidden bg-background/80",children:t.posterUrl?e.jsx("img",{src:t.posterUrl,alt:t.title,className:"h-full w-full object-cover transition-transform duration-200 group-hover:scale-[1.03]"}):e.jsxs("div",{className:"flex h-full w-full items-center justify-center text-xs text-muted-foreground",children:[e.jsx(w,{className:"mr-1 h-4 w-4"}),"No poster"]})})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-1.5 p-2.5",children:[e.jsxs("div",{className:"min-h-[2.4rem]",children:[e.jsx(j,{to:S,className:"line-clamp-2 text-sm font-medium text-foreground hover:underline",children:t.title}),t.year&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["(",t.year,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-1",children:[e.jsx("button",{type:"button",onClick:v,disabled:N||!b,className:`rounded-full border px-2 py-0.5 text-[9px] font-medium transition ${H(t.status??null)} ${N?"opacity-70":b?"hover:border-primary/70 hover:bg-primary":"opacity-80"}`,children:G(t.status??null)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:5}).map((x,g)=>{const y=g+1,E=(t.rating??0)>=y;return e.jsx("button",{type:"button",className:"p-0.5",disabled:N||!b,onClick:()=>$(y),children:e.jsx(F,{className:`h-3.5 w-3.5 ${E?"fill-yellow-400 text-yellow-300":"text-muted-foreground"}`})},g)})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.rating!=null?`${t.rating}/5`:"No rating"})]})]})]})]},t.id)})})]}):e.jsx("div",{className:"flex min-h-[40vh] items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-sm rounded-2xl border border-border bg-card/80 p-5 text-center text-xs text-muted-foreground shadow-lg",children:[e.jsx("div",{className:"mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-2xl bg-primary/15",children:e.jsx(w,{className:"h-5 w-5 text-primary","aria-hidden":"true"})}),e.jsx("p",{className:"font-heading text-sm font-semibold text-foreground",children:d?"Your library is empty":`${k}'s library is empty`}),e.jsx("p",{className:"mt-1 text-xs",children:d?"As you add titles to your Watchlist and mark them as watched, this tab will turn into a sortable diary of everything you’ve seen.":"When they add titles to their Watchlist or mark them watched, you’ll be able to browse their picks here."})]})})};export{ue as D,xe as a};
