import{k as g,b as q,q as d,s as _,l as w,v as h}from"./index-DyWq_Gt8.js";import{u as p}from"./useMutation-C5YwRx1y.js";const v=(a,e)=>{const{user:t}=g(),u=e??t?.id??null,s=w({queryKey:["diary","library",u],enabled:!!u,queryFn:async()=>{if(!u)return[];const{data:r,error:y}=await _.from("library_entries").select("id, title_id, status, updated_at").eq("user_id",u).order("updated_at",{ascending:!1}).limit(500);if(y)throw new Error(y.message);const l=r??[];if(!l.length)return[];const m=Array.from(new Set(l.map(i=>i.title_id).filter(i=>!!i)));let b=new Map;if(m.length){const{data:i,error:n}=await _.from("media_items").select(`id,
             kind,
             tmdb_title,
             tmdb_name,
             tmdb_original_title,
             tmdb_original_name,
             tmdb_release_date,
             tmdb_first_air_date,
             tmdb_poster_path,
             tmdb_backdrop_path,
             tmdb_original_language,
             omdb_title,
             omdb_year,
             omdb_language,
             omdb_imdb_id,
             omdb_imdb_rating,
             omdb_rating_rotten_tomatoes,
             omdb_poster,
             omdb_rated,
             tmdb_id`).in("id",m);n?console.warn("[useDiaryLibrary] Failed to load titles for library entries",n.message):b=new Map(i.map(c=>[c.id,h(c)]))}let f=new Map;if(m.length){const{data:i,error:n}=await _.from("ratings").select("title_id, rating").eq("user_id",u).in("title_id",m);!n&&i?f=new Map(i.map(c=>[c.title_id,c.rating])):n&&console.warn("[useDiaryLibrary] Failed to load ratings for library entries",n.message)}return l.map(i=>{const n=b.get(i.title_id),c=f.get(i.title_id)??null;return{id:i.id,titleId:i.title_id,status:i.status,updatedAt:i.updated_at,title:n?.title??"Untitled",year:n?.year??null,type:n?.type??null,posterUrl:n?.posterUrl??n?.backdropUrl??null,rating:c}})}});return{entries:(s.data??[]).filter(r=>!(a.status&&a.status!=="all"&&r.status!==a.status||a.type&&a.type!=="all"&&r.type!==a.type)),isLoading:s.isLoading,isError:s.isError,error:s.error instanceof Error?s.error.message:null}},D=a=>{const{user:e}=g(),t=e?.id??null;return w({queryKey:d.titleDiary(t,a),enabled:!!(t&&a),staleTime:1e3*30,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!t||!a)return{status:null,rating:null};const[{data:u,error:s},{data:o,error:r}]=await Promise.all([_.from("library_entries").select("status").eq("user_id",t).eq("title_id",a).maybeSingle(),_.from("ratings").select("rating").eq("user_id",t).eq("title_id",a).maybeSingle()]);if(s&&s.code!=="PGRST116")throw s;if(r&&r.code!=="PGRST116")throw r;return{status:u?.status??null,rating:o?.rating??null}}})},K=()=>{const{user:a}=g(),e=a?.id??null,t=q(),u=p({mutationFn:async({titleId:o,status:r,type:y})=>{if(!e)throw new Error("Not authenticated");if(!y)throw new Error("Content type is required");const{error:l}=await _.from("library_entries").upsert({user_id:e,title_id:o,status:r,updated_at:new Date().toISOString(),content_type:y},{onConflict:"user_id,title_id"});if(l)throw new Error(l.message);return{titleId:o,status:r}},onSuccess:()=>{e&&(t.invalidateQueries({queryKey:d.diaryLibrary(e)}),t.invalidateQueries({queryKey:d.diaryStats(e)}),t.invalidateQueries({queryKey:d.homeForYou(e)}),t.invalidateQueries({queryKey:d.titleDiary(e,void 0)}))}}),s=p({mutationFn:async({titleId:o,rating:r,type:y})=>{if(!e)throw new Error("Not authenticated");if(!y)throw new Error("Content type is required");if(r==null){const{error:m}=await _.from("ratings").delete().eq("user_id",e).eq("title_id",o);if(m)throw new Error(m.message);return{titleId:o,rating:null}}const{error:l}=await _.from("ratings").upsert({user_id:e,title_id:o,rating:r,updated_at:new Date().toISOString(),content_type:y},{onConflict:"user_id,title_id"});if(l)throw new Error(l.message);return{titleId:o,rating:r}},onSuccess:()=>{e&&(t.invalidateQueries({queryKey:d.diaryLibrary(e)}),t.invalidateQueries({queryKey:d.diaryStats(e)}),t.invalidateQueries({queryKey:d.homeForYou(e)}),t.invalidateQueries({queryKey:d.titleDiary(e,void 0)}))}});return{updateStatus:u,updateRating:s}};export{K as a,D as b,v as u};
