import{C as Ue,s as z,r as n,ap as me,e as ce,a7 as ur,aq as lt,b as Dt,ar as dr,c as Lt,w as ns,as as Us,at as fr,au as mr,aj as rs,o as gr,av as Os,n as pr,aw as Fs,ax as hr,ay as $s,am as ts,N as Hs,az as xr,R as X,j as t,i as as,B as K,E as Ne,aA as yr,aB as br,aC as vr,u as Ks,an as G,aD as Qs,I as wr,A as Mr,ao as qs,K as jr,L as Rr}from"./index-B1gR2HyV.js";import{m as Ut,a as zs,b as Nr,M as os,s as Cr,i as Js,c as Vs,d as Ws,e as Gs,f as Sr,n as kr,r as Ys,g as Zs,h as Ir,C as Er,j as Tr,k as _r,F as Ar,S as Dr,T as Lr,l as Ps,u as Ur,o as Or,p as qr,q as Pr,t as Br,v as Fr}from"./scroll-area-C73h5lOF.js";import{u as Pe}from"./conversationsCache-CVhhJqhn.js";import{w as $r,a as Hr,B as Kr,u as Qr,M as zr}from"./useAssistantCache-CvOs5MbJ.js";import{B as Jr}from"./bell-BWLPvCrT.js";import{T as Xs}from"./textarea-BL7WUtYQ.js";import{C as Vr}from"./circle-alert-DSoZrRVH.js";import{D as is,a as ls,b as en,c as cs,d as tn,e as sn}from"./dialog-JvJB_ZLZ.js";import{M as W}from"./material-icon-D-BoV6fd.js";import{C as Wr}from"./copy-CEOjqdt5.js";import{U as Gr}from"./user-4LgnbUbq.js";import{u as Yr}from"./useUserLastActive-B5eqoNK5.js";import"./format-BXv9LLlt.js";import"./plus-0vXhlSCG.js";import"./x-KxSQUesR.js";import"./index-C4Lj_15j.js";import"./clock-7VgTcbXE.js";const Zr=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Xr=Ue("arrow-down",Zr);const ea=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],ta=Ue("camera",ea);const sa=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],na=Ue("paperclip",sa);const ra=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],aa=Ue("send",ra);const oa=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m14.5 9.5-5 5",key:"17q4r4"}],["path",{d:"m9.5 9.5 5 5",key:"18nt4w"}]],nn=Ue("shield-x",oa);const ia=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]],la=Ue("smile",ia);const ca=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],ua=Ue("volume-2",ca),ss=new Map,da=s=>{const e=ss.get(s);if(e)return e;const r=z.channel(`conversation-db-${s}`),o={conversationId:s,channel:r,refCount:0,lastStatus:null,statusListeners:new Set,messageInsertListeners:new Set,messageUpdateListeners:new Set,readReceiptUpsertListeners:new Set,deliveryReceiptUpsertListeners:new Set,reactionUpsertListeners:new Set,reactionDeleteListeners:new Set};return r.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.messageInsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.messageUpdateListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_read_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.readReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_delivery_receipts",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.deliveryReceiptUpsertListeners)c(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionUpsertListeners)c(l)}).on("postgres_changes",{event:"DELETE",schema:"public",table:"message_reactions",filter:`conversation_id=eq.${s}`},a=>{const l=a;for(const c of o.reactionDeleteListeners)c(l)}),r.subscribe(a=>{const l=a;o.lastStatus=l;for(const c of o.statusListeners)c(l)}),ss.set(s,o),o},fa=(s,e)=>{const r=da(s);r.refCount+=1;const o=[];return e.onStatus&&(r.statusListeners.add(e.onStatus),o.push(()=>r.statusListeners.delete(e.onStatus)),r.lastStatus&&e.onStatus(r.lastStatus)),e.onMessageInsert&&(r.messageInsertListeners.add(e.onMessageInsert),o.push(()=>r.messageInsertListeners.delete(e.onMessageInsert))),e.onMessageUpdate&&(r.messageUpdateListeners.add(e.onMessageUpdate),o.push(()=>r.messageUpdateListeners.delete(e.onMessageUpdate))),e.onReadReceiptUpsert&&(r.readReceiptUpsertListeners.add(e.onReadReceiptUpsert),o.push(()=>r.readReceiptUpsertListeners.delete(e.onReadReceiptUpsert))),e.onDeliveryReceiptUpsert&&(r.deliveryReceiptUpsertListeners.add(e.onDeliveryReceiptUpsert),o.push(()=>r.deliveryReceiptUpsertListeners.delete(e.onDeliveryReceiptUpsert))),e.onReactionUpsert&&(r.reactionUpsertListeners.add(e.onReactionUpsert),o.push(()=>r.reactionUpsertListeners.delete(e.onReactionUpsert))),e.onReactionDelete&&(r.reactionDeleteListeners.add(e.onReactionDelete),o.push(()=>r.reactionDeleteListeners.delete(e.onReactionDelete))),()=>{for(const a of o)a();if(r.refCount-=1,r.refCount<=0){try{z.removeChannel(r.channel)}catch{}ss.delete(s)}}},Ot=(s,e,r)=>{n.useEffect(()=>{if(s)return fa(s,e())},[s,e,...r])},ma=5e3,ga=1500,pa=5e3,ha=s=>({refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchInterval:s?ga:ma,refetchIntervalInBackground:!1}),xa=new Set(["SUBSCRIBED"]),ya=s=>!xa.has(s),ba=s=>{const[e,r]=n.useState(!1),o=n.useRef(s);n.useEffect(()=>{Object.is(o.current,s)||(o.current=s,r(!1))},[s]);const a=n.useCallback(l=>{const c=ya(l);r(h=>h===c?h:c)},[]);return{pollWhenRealtimeDown:e,onStatus:a}},qt=s=>{const{pollWhenRealtimeDown:e,onStatus:r}=ba(s);return{pollWhenRealtimeDown:e,onRealtimeStatus:r,refetchOptions:ha(e)}},va=s=>typeof s=="object"&&s!==null,rn=s=>s.new,wa=s=>s.old,Be=(s,e)=>{if(!va(s))return null;const r=s[e];return typeof r=="string"?r:null},an=(s,e)=>Be(s,"conversation_id")===e,on=40,At=1e5,Ma=s=>`"${s.replace(/"/g,'\\"')}"`,ja=s=>{const e=Ma(s.createdAt),r=s.id;return`created_at.lt.${e},and(created_at.eq.${e},id.lt.${r})`},Ra=s=>{const e=Cr((s??[]).map(Ut)),r=(s??[]).length>=on,o=e.length?{createdAt:e[0].createdAt,id:e[0].id}:null;return{items:e,hasMore:r,cursor:o}},Na=(s,e)=>{const r=n.useMemo(()=>me(s),[s]),o=ce(),[a,l]=n.useState(At),{pollWhenRealtimeDown:c,onRealtimeStatus:h,refetchOptions:m}=qt(s),p=n.useRef(e);n.useEffect(()=>{p.current=e},[e]);const x=n.useRef({pages:0,total:0}),u=ur({queryKey:r,enabled:!!s,initialPageParam:null,...m,staleTime:pa,queryFn:async({pageParam:b})=>{if(!s)return{items:[],hasMore:!1,cursor:null};let w=z.from("messages").select(os).eq("conversation_id",s).order("created_at",{ascending:!1}).order("id",{ascending:!1});b&&(w=w.or(ja(b)));const{data:v,error:C}=await w.limit(on);if(C)throw console.error(`[useConversationMessages] Failed to load ${b?"older messages":"messages"}`,C),new Error(C.message);return Ra(v??[])},getNextPageParam:()=>{},getPreviousPageParam:b=>{if(b.hasMore)return b.cursor??void 0},structuralSharing:(b,w)=>Nr(b,w)});n.useEffect(()=>{const b=u.data?.pages??[],w=b.reduce((I,j)=>I+j.items.length,0),v=x.current;if(b.length===0){x.current={pages:0,total:0},l(At);return}if(v.pages===0){x.current={pages:b.length,total:w},l(At);return}const C=w-v.total,M=b.length-v.pages;C>0&&M>0&&l(I=>Math.max(0,I-C)),x.current={pages:b.length,total:w}},[u.data?.pages]);const y=n.useCallback(()=>{if(!s)return{};const b=(w,v)=>{const C=rn(w);if(!an(C,s)||!Be(C,"id"))return;const I=C,j=Ut(I);o.setQueryData(r,N=>zs(N,I,{allowAppend:v==="insert"})),v==="insert"?p.current?.onInsert?.(j):p.current?.onUpdate?.(j)};return{onStatus:h,onMessageInsert:w=>{b(w,"insert")},onMessageUpdate:w=>{b(w,"update")}}},[s,h,o,r]);Ot(s,y,[]),n.useEffect(()=>{l(At),x.current={pages:0,total:0}},[s]);const g=n.useMemo(()=>(u.data?.pages??[]).flatMap(w=>w.items),[u.data?.pages]),f=n.useCallback(async()=>{s&&u.hasPreviousPage&&await u.fetchPreviousPage()},[s,u]);return n.useMemo(()=>({data:g,dataUpdatedAt:u.dataUpdatedAt,isLoading:u.isLoading,isFetching:u.isFetching,isError:u.isError,error:u.error,refetch:u.refetch,loadOlder:f,hasMore:!!u.hasPreviousPage,isLoadingOlder:u.isFetchingPreviousPage,firstItemIndex:a,queryKey:r,pollWhenRealtimeDown:c}),[g,u.dataUpdatedAt,u.isLoading,u.isFetching,u.isError,u.error,u.refetch,f,u.hasPreviousPage,u.isFetchingPreviousPage,a,r,c])};function Ca(s){const{conversation:e,deliveryReceipts:r,readReceipts:o,currentUserId:a,failedMessages:l,onlyMessageIds:c,messageCreatedAtMsById:h}=s;if(!e||!a)return()=>null;const m=e.participants.filter(g=>!g.isSelf);if(m.length===0)return()=>null;const p=new Set(m.map(g=>g.id)),x=g=>{if(!g)return null;const f=h?.get(g);return f??null},u=new Map;for(const g of o??[]){let f=null;if(g.lastReadMessageId){const v=x(g.lastReadMessageId);v!=null&&(f=v),v==null&&(f=null)}else if(g.lastReadAt){const v=new Date(g.lastReadAt).getTime();Number.isNaN(v)||(f=v)}if(f==null)continue;const b=(()=>{if(!g.lastReadAt)return null;const v=new Date(g.lastReadAt).getTime();return Number.isNaN(v)?null:v})(),w=u.get(g.userId);if(!w||f>w.upToMs){u.set(g.userId,{upToMs:f,readAtMs:b});continue}f===w.upToMs&&b!=null&&(w.readAtMs==null||b>w.readAtMs)&&u.set(g.userId,{upToMs:f,readAtMs:b})}const y=new Map;for(const g of r??[]){if(!p.has(g.userId)||c&&!c.has(g.messageId))continue;let f=y.get(g.messageId);f||(f=new Set,y.set(g.messageId,f)),f.add(g.userId)}return g=>{if(g.senderId!==a)return null;if(l[g.id])return{status:"failed"};if(Js(g.id))return{status:"sending"};const f=(()=>{const C=new Date(g.createdAt??"").getTime();return Number.isNaN(C)?0:C})();let b=0,w=null;for(const C of m){const M=u.get(C.id);if(M&&M.upToMs>=f){b+=1;const I=M.readAtMs??M.upToMs;(w===null||I>w)&&(w=I)}}return b===m.length&&m.length>0?{status:"seen",seenAt:w!=null?new Date(w).toISOString():null}:(y.get(g.id)?.size??0)===m.length&&m.length>0?{status:"delivered"}:{status:"sent"}}}function Sa(s){const{messages:e,conversation:r,currentUserId:o,participantsById:a,reactionsByMessageId:l,hiddenMessageIds:c,deliveryReceipts:h,readReceipts:m,failedMessages:p,lastOwnMessageId:x}=s,u=n.useMemo(()=>{if(!e)return[];const g=new Set;x&&g.add(x);for(const w of Object.keys(p))g.add(w);const f=new Map;for(const w of e){const v=new Date(w.createdAt??"").getTime();Number.isNaN(v)||f.set(w.id,v)}const b=Ca({conversation:r??null,deliveryReceipts:h,readReceipts:m,currentUserId:o,failedMessages:p,onlyMessageIds:g,messageCreatedAtMsById:f});return e.map(w=>{const v=lt(w.body),C=a.get(w.senderId)??null,M=C?.isSelf??(o!=null&&w.senderId===o),I=M&&g.has(w.id)?b(w):null,j=!!I&&M&&!v.deleted&&(I.status==="failed"||x===w.id);return{message:w,meta:v,sender:C,isSelf:M,deliveryStatus:I,showDeliveryStatus:j,reactions:l.get(w.id)??[]}})},[r,o,h,p,x,e,a,l,m]),y=n.useMemo(()=>u.filter(({message:g})=>!c[g.id]),[u,c]);return{uiMessages:u,visibleMessages:y}}function ka(s){const{messages:e,currentUserId:r,hiddenMessageIds:o}=s;return n.useMemo(()=>{if(!e||!r)return null;for(let a=e.length-1;a>=0;a-=1){const l=e[a];if(!(o[l.id]||l.senderId!==r||lt(l.body).deleted))return l.id}return null},[o,e,r])}const Ia=async s=>{const{data:e,error:r}=await z.from("message_read_receipts").select("user_id, conversation_id, last_read_at, last_read_message_id").eq("conversation_id",s).order("last_read_at",{ascending:!1}).returns();if(r)throw console.error("[useConversationReadReceipts] Failed to load",r),new Error(r.message);return(e??[]).map(Ws)},Ea=async(s,e)=>{if(e.length===0)return[];const r=z.from("message_delivery_receipts").select("id, conversation_id, message_id, user_id, delivered_at, created_at").eq("conversation_id",s).in("message_id",e),{data:o,error:a}=await r.order("created_at",{ascending:!0}).returns();if(a)throw console.error("[useConversationDeliveryReceipts] Failed to load",a),new Error(a.message);return(o??[]).map(Gs)},Ta=async s=>{const{data:e,error:r}=await z.from("message_reactions").select("id, conversation_id, message_id, user_id, emoji, created_at").eq("conversation_id",s).order("created_at",{ascending:!0}).returns();if(r)throw console.error("[useConversationReactions] Failed to load reactions",r),new Error(r.message);return(e??[]).map(Vs)},_a=(s,e)=>{const r=new Map,o=new Map;for(const l of s){let c=r.get(l.messageId);c||(c=new Map,r.set(l.messageId,c),o.set(l.messageId,[]));let h=c.get(l.emoji);h||(h={emoji:l.emoji,count:0,reactedBySelf:!1},c.set(l.emoji,h),o.get(l.messageId).push(l.emoji)),h.count+=1,e&&l.userId===e&&(h.reactedBySelf=!0)}const a=new Map;for(const[l,c]of r.entries()){const h=o.get(l)??[];a.set(l,h.map(m=>c.get(m)).filter(Boolean))}return a},Aa=(s,e,r)=>{const o=s??[],a=r.key(e),l=[...o],c=l.findIndex(h=>r.key(h)===a);return c>=0?l[c]=e:l.push(e),r.sort&&l.sort(r.sort),l},Da=(s,e,r)=>{const o=s??[];return o.length===0?[]:o.filter(a=>r.key(a)!==e)},us=s=>e=>{const r=rn(e);if(!an(r,s.conversationId)||s.extraGuard&&!s.extraGuard(r)||!(s.getRequiredId?s.getRequiredId(r):Be(r,"id")))return;const a=r,l=s.mapRow(a);s.queryClient.setQueryData(s.queryKey,c=>Aa(c,l,{key:s.key,sort:s.sort}))},La=s=>e=>{const r=wa(e),o=s.getRowId?s.getRowId(r):Be(r,"id");if(!o){s.invalidateWhenMissingId!==!1&&s.queryClient.invalidateQueries({queryKey:s.queryKey});return}s.queryClient.setQueryData(s.queryKey,a=>Da(a,o,{key:s.key}))},Ua=s=>{const{user:e}=Dt(),r=e?.id??null,o=ce(),a=n.useMemo(()=>dr(s),[s]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:h}=qt(s),m=Lt({queryKey:a,enabled:!!s,...h,queryFn:()=>s?Ta(s):Promise.resolve([])}),p=n.useCallback(()=>{if(!s)return{};const y=us({conversationId:s,queryClient:o,queryKey:a,mapRow:Vs,key:f=>f.id,sort:(f,b)=>{const w=Us(f.createdAt),v=Us(b.createdAt);return w!==v?w-v:f.id.localeCompare(b.id)}}),g=La({queryClient:o,queryKey:a,key:f=>f.id});return{onStatus:c,onReactionUpsert:y,onReactionDelete:g}},[s,c,o,a]);Ot(s,p,[]);const x=ns({mutationFn:async({messageId:y,emoji:g})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to react to messages.");const{error:f}=await z.from("message_reactions").insert({conversation_id:s,message_id:y,user_id:r,emoji:g});if(f){if(f?.code==="23505"){const{error:b}=await z.from("message_reactions").delete().eq("message_id",y).eq("user_id",r).eq("emoji",g);if(b)throw console.error("[useConversationReactions] Failed to remove reaction",b),b;return}throw console.error("[useConversationReactions] Failed to toggle reaction",f),f}},onMutate:async({messageId:y,emoji:g})=>{if(!s||!r)return{previousReactions:void 0};await o.cancelQueries({queryKey:a});const f=o.getQueryData(a);return o.setQueryData(a,b=>{const w=b??[],v=w.findIndex(M=>M.messageId===y&&M.userId===r&&M.emoji===g);if(v>=0){const M=[...w];return M.splice(v,1),M}const C={id:Sr(),conversationId:s,messageId:y,userId:r,emoji:g,createdAt:new Date().toISOString()};return[...w,C]}),{previousReactions:f}},onError:(y,g,f)=>{s&&(f?.previousReactions?o.setQueryData(a,f.previousReactions):o.invalidateQueries({queryKey:a}))},onSuccess:()=>{s&&o.invalidateQueries({queryKey:a})}}),u=n.useMemo(()=>{const y=m.data??[];return _a(y,r)},[m.data,r]);return{reactions:m.data??[],reactionsByMessageId:u,isLoadingReactions:m.isLoading,toggleReaction:x,pollWhenRealtimeDown:l,queryKey:a}},Oa=s=>{const e=ce(),r=n.useMemo(()=>fr(s),[s]),{pollWhenRealtimeDown:o,onRealtimeStatus:a,refetchOptions:l}=qt(s),c=Lt({queryKey:r,enabled:!!s,...l,queryFn:async()=>s?Ia(s):[]}),h=n.useCallback(()=>{if(!s)return{};const m=us({conversationId:s,queryClient:e,queryKey:r,mapRow:Ws,key:p=>p.userId,getRequiredId:p=>Be(p,"user_id"),sort:(p,x)=>{const u=!p.lastReadAt,y=!x.lastReadAt;if(u&&y)return 0;if(u)return 1;if(y)return-1;const g=new Date(p.lastReadAt).getTime(),f=new Date(x.lastReadAt).getTime();return Number.isNaN(g)&&Number.isNaN(f)?0:Number.isNaN(g)?1:Number.isNaN(f)?-1:f-g}});return{onStatus:a,onReadReceiptUpsert:m}},[s,a,e,r]);return Ot(s,h,[]),n.useMemo(()=>({...c,pollWhenRealtimeDown:o,queryKey:r}),[c,o,r])},qa=(s,e)=>{const r=ce(),o=n.useMemo(()=>kr(e,{excludeTemp:!0,sort:!0}),[e]),a=n.useMemo(()=>mr(s,o),[s,o]),{pollWhenRealtimeDown:l,onRealtimeStatus:c,refetchOptions:h}=qt(s),m=Lt({queryKey:a,enabled:!!(s&&o.length>0),...h,queryFn:async()=>s?o.length===0?[]:Ea(s,o):[]}),p=n.useCallback(()=>{if(!s)return{};if(o.length===0)return{};const u=new Set(o),y=us({conversationId:s,queryClient:r,queryKey:a,mapRow:Gs,key:g=>g.id,extraGuard:g=>{const f=Be(g,"message_id");return!!(f&&u.has(f))},sort:(g,f)=>{const b=new Date(g.deliveredAt??"").getTime(),w=new Date(f.deliveredAt??"").getTime(),v=Number.isNaN(b)?0:b,C=Number.isNaN(w)?0:w;return v-C}});return{onStatus:c,onDeliveryReceiptUpsert:y}},[s,o,c,r,a]),x=s&&o.length>0?s:null;return Ot(x,p,[]),n.useMemo(()=>({...m,pollWhenRealtimeDown:l,queryKey:a}),[m,l,a])},Pa=s=>{const{conversationId:e,userId:r,displayName:o}=s,{getNumber:a}=rs(),l=a("ux.typing.inactivity_ms",3e3),c=a("ux.typing.heartbeat_ms",2e3),h=a("ux.typing.remote_ttl_ms",5e3),[m,p]=n.useState({}),x=n.useRef(null),u=n.useRef(new Map),y=n.useRef({isTyping:!1,timeoutId:null,lastSentAtMs:0}),g=n.useCallback(async C=>{if(!e||!r||!o)return;const M=x.current;M&&await M.send({type:"broadcast",event:"typing",payload:{userId:r,displayName:o,isTyping:C}})},[e,r,o]),f=n.useCallback(async()=>{y.current.timeoutId!=null&&(window.clearTimeout(y.current.timeoutId),y.current.timeoutId=null),y.current.isTyping&&(y.current.isTyping=!1,y.current.lastSentAtMs=0,await g(!1))},[g]),b=n.useCallback(C=>{if(!e||!r||!o||!x.current)return;const I=y.current.isTyping;if(C){const j=Date.now();I?j-y.current.lastSentAtMs>c&&(y.current.lastSentAtMs=j,g(!0)):(y.current.isTyping=!0,y.current.lastSentAtMs=j,g(!0)),y.current.timeoutId!=null&&window.clearTimeout(y.current.timeoutId),y.current.timeoutId=window.setTimeout(()=>{y.current.isTyping=!1,y.current.lastSentAtMs=0,y.current.timeoutId=null,g(!1)},l);return}I&&f()},[g,e,o,f,c,l,r]),w=n.useCallback(()=>{p({}),u.current.forEach(C=>window.clearTimeout(C)),u.current.clear()},[]);return n.useEffect(()=>{if(!e)return;w();const C=z.channel(`supabase_realtime_typing:conversation:${e}`,{config:{broadcast:{self:!1}}});x.current=C,C.on("broadcast",{event:"typing"},({payload:j})=>{const N=j;if(!N?.userId||r&&N.userId===r)return;p(k=>{const U={...k};return N.isTyping&&N.displayName?U[N.userId]=N.displayName:delete U[N.userId],U});const R=u.current.get(N.userId);if(R!=null&&window.clearTimeout(R),N.isTyping){const k=window.setTimeout(()=>{p(U=>{const E={...U};return delete E[N.userId],E}),u.current.delete(N.userId)},h);u.current.set(N.userId,k)}else u.current.delete(N.userId)}).subscribe();const M=()=>{document.visibilityState==="hidden"&&f()},I=()=>{f()};return document.addEventListener("visibilitychange",M),window.addEventListener("beforeunload",I),window.addEventListener("pagehide",I),window.addEventListener("blur",I),()=>{document.removeEventListener("visibilitychange",M),window.removeEventListener("beforeunload",I),window.removeEventListener("pagehide",I),window.removeEventListener("blur",I),w(),f(),x.current&&(z.removeChannel(x.current),x.current=null)}},[e,f,r,w]),{remoteTypingUsers:n.useMemo(()=>Object.entries(m).map(([C,M])=>({userId:C,displayName:M})),[m]),noteLocalInputActivity:b,stopTyping:f}},Ba=s=>{const{conversationId:e,storageKeyPrefix:r="messages:draft:",hydrate:o,debounceMs:a=250}=s,l=n.useRef(o);n.useEffect(()=>{l.current=o},[o]);const c=n.useMemo(()=>e?`${r}${e}`:null,[e,r]),[h,m]=n.useState("");return n.useEffect(()=>{if(!c){m(""),l.current?.("");return}const u=gr(c)??"";m(u),l.current?.(u)},[c]),n.useEffect(()=>{if(!c)return;const x=window.setTimeout(()=>{h.trim().length===0?Os(c):pr(c,h)},a);return()=>window.clearTimeout(x)},[c,a,h]),{draft:h,setDraft:m,clearDraft:()=>{c&&Os(c),m(""),l.current?.("")}}};function Fa({showComposer:s,initialHeaderHeight:e=72,initialComposerHeight:r=160}){const o=n.useRef(null),[a,l]=n.useState(e),[c,h]=n.useState(r),[m,p]=n.useState(null),[x,u]=n.useState(!1),y=n.useCallback(g=>h(Math.max(g,a)),[a]);return n.useEffect(()=>{const g=o.current;if(!g)return;const f=()=>l(Math.max(g.getBoundingClientRect().height,0));if(f(),typeof ResizeObserver>"u")return;const b=new ResizeObserver(f);return b.observe(g),()=>b.disconnect()},[]),n.useEffect(()=>{h(g=>Math.max(g,a))},[a]),n.useEffect(()=>{s||h(0)},[s]),{headerRef:o,headerHeight:a,composerHeight:c,isAtBottom:m,setIsAtBottom:p,handleComposerHeightChange:y,showEmojiPicker:x,setShowEmojiPicker:u}}const $a=({conversationId:s,currentUserId:e,showComposer:r,isBlocked:o,blockedYou:a,composerTextareaRef:l})=>{const[c,h]=n.useState(null),[m,p]=n.useState({}),[x,u]=n.useState(null),[y,g]=n.useState(null),[f,b]=n.useState(null),w=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{if(!s||!e){p({});return}if(typeof window>"u")return;const E=`messages:hidden:${e}:${s}`;try{const D=window.localStorage.getItem(E);if(!D){p({});return}const F=JSON.parse(D);if(Array.isArray(F)){const $={};for(const ee of F)typeof ee=="string"&&ee&&($[ee]=!0);p($);return}if(F&&typeof F=="object"){const $={};for(const[ee,ue]of Object.entries(F))ue&&($[ee]=!0);p($);return}p({})}catch{p({})}},[s,e]),n.useEffect(()=>{if(!s||!e||typeof window>"u")return;const E=`messages:hidden:${e}:${s}`;try{const D=Object.keys(m).filter(F=>m[F]);window.localStorage.setItem(E,JSON.stringify(D))}catch{}},[s,e,m]);const C=n.useCallback(()=>{h(null)},[]);n.useEffect(()=>{if(!c||typeof document>"u")return;const E=F=>{const $=F.target;if(!($ instanceof Element)){h(null);return}$.closest(`[data-message-action-scope="${c}"]`)||h(null)},D=F=>{F.key==="Escape"&&h(null)};return document.addEventListener("pointerdown",E,!0),document.addEventListener("keydown",D),()=>{document.removeEventListener("pointerdown",E,!0),document.removeEventListener("keydown",D)}},[c]);const M=n.useCallback(E=>{o||a||lt(E.body).deleted||(h(E.id),l.current?.blur())},[a,l,o]),I=n.useCallback((E,D)=>{o||a||lt(E.body).deleted||(D&&(v.current=D),g({messageId:E.id,text:Fs(E.body)??"",body:E.body??null,attachmentUrl:E.attachmentUrl??null}),b(null),C(),l.current?.blur())},[a,C,l,o]),j=n.useCallback(E=>{g(D=>D&&{...D,text:E})},[]),N=n.useCallback(()=>{g(null),b(null),v.current?.focus()},[]);n.useEffect(()=>{y&&queueMicrotask(()=>{w.current?.focus()})},[y]);const R=n.useCallback(E=>{o||a||(C(),u({messageId:E.id,attachmentUrl:E.attachmentUrl??null}),l.current?.blur())},[a,C,l,o]),k=n.useCallback(()=>{u(null)},[]),U=n.useCallback(E=>{p(D=>({...D,[E]:!0}))},[]);return n.useEffect(()=>{c===null&&r&&(y||x||queueMicrotask(()=>l.current?.focus()))},[c,x,y,r,l]),{activeActionMessageId:c,openMessageActions:M,closeMessageActions:C,hiddenMessageIds:m,hideMessageForMe:U,deleteDialog:x,openDeleteDialog:R,closeDeleteDialog:k,editingMessage:y,openEditDialog:I,updateEditingText:j,closeEditDialog:N,editTextareaRef:w,editError:f,setEditError:b}},Bs=3e3;function Ha(s){const{conversationId:e,userId:r,isAtBottom:o,messages:a}=s,l=ce(),c=n.useRef({conversationId:null,messageId:null,userId:null}),h=n.useRef({lastSentAt:0,timeoutId:null,pending:null});n.useEffect(()=>{c.current={conversationId:null,messageId:null,userId:null};const m=h.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null,m.pending=null,m.lastSentAt=0},[e,r]),n.useEffect(()=>()=>{const m=h.current;m.timeoutId!=null&&window.clearTimeout(m.timeoutId),m.timeoutId=null},[]),n.useEffect(()=>{if(!e||!a||a.length===0||!r||!o)return;const m=a[a.length-1];if(Js(m.id)||c.current.conversationId===e&&c.current.messageId===m.id&&c.current.userId===r)return;const p=h.current,x=Date.now(),u=p.lastSentAt?x-p.lastSentAt:Number.POSITIVE_INFINITY,y=()=>{Pe(l,r,e,f=>f.hasUnread?{...f,hasUnread:!1}:f)},g=f=>{p.lastSentAt=Date.now();const b=new Date().toISOString();$r({conversation_id:e,user_id:r,last_read_message_id:f,last_read_at:b}).then(()=>{c.current={conversationId:e,messageId:f,userId:r},y()}).catch(w=>{console.error("[useConversationReadReceiptWriter] Failed to update read receipt",w)})};if(u<Bs){p.pending={conversationId:e,userId:r,messageId:m.id},p.timeoutId==null&&(p.timeoutId=window.setTimeout(()=>{const f=h.current.pending;h.current.pending=null,h.current.timeoutId=null,f&&(c.current.conversationId===f.conversationId&&c.current.messageId===f.messageId&&c.current.userId===f.userId||f.conversationId!==e||f.userId!==r||g(f.messageId))},Math.max(Bs-u,0)));return}p.timeoutId!=null&&(window.clearTimeout(p.timeoutId),p.timeoutId=null,p.pending=null),g(m.id)},[e,a,r,l,o])}const Ka=new Set(["text","image","text+image","system"]),Qa=s=>{const{user:e}=Dt(),r=e?.id??null,o=ce();return ns({mutationFn:async({messageId:a,text:l,currentBody:c,attachmentUrl:h})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to edit messages.");if(h)throw new Error("Cannot edit messages with attachments.");const m=hr(c,l),p=$s(m),x=Ka.has(p.type)?p.type:"text",{data:u,error:y}=await z.from("messages").update({body:m,message_type:x,text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null}).eq("id",a).eq("conversation_id",s).eq("user_id",r).select(os).single();if(y)throw console.error("[useEditMessage] Failed to edit message",y),new Error(y.message);return Ut(u)},onSuccess:a=>{if(!s)return;const l=me(s);o.setQueryData(l,c=>Ys(c,a))}})},za=s=>{const{user:e}=Dt(),r=e?.id??null,o=ce();return ns({mutationFn:async({messageId:a,attachmentUrl:l})=>{if(!s)throw new Error("Missing conversation id.");if(!r)throw new Error("You must be signed in to delete messages.");const h={type:"system",text:"",deleted:!0,deletedAt:new Date().toISOString()},m=JSON.stringify(h),p=$s(m),{data:x,error:u}=await z.from("messages").update({body:m,message_type:"system",text:p.text.trim()?p.text:null,client_id:p.clientId??null,meta:p.meta??null,attachment_url:null}).eq("id",a).eq("conversation_id",s).eq("user_id",r).select(os).single();if(u)throw console.error("[useDeleteMessage] Failed to delete message",u),new Error(u.message);if(l)try{await Zs(l)}catch(g){console.warn("[useDeleteMessage] Deleted message but failed to remove attachment",g)}return Ut(x)},onSuccess:a=>{if(!s)return;const l=me(s);o.setQueryData(l,c=>Ys(c,a)),o.invalidateQueries({queryKey:ts(r)})}})};function Ja(s){const{conversationId:e,setDraft:r,messages:o}=s,a=ce(),[l,c]=n.useState(null),[h,m]=n.useState(null),[p,x]=n.useState(null),[u,y]=n.useState({}),g=n.useRef({});n.useEffect(()=>{g.current=u},[u]);const f=n.useRef(e);n.useEffect(()=>{e!==f.current&&(f.current=e,c(null),m(null),x(null),y({}),g.current={})},[e]),n.useEffect(()=>()=>{const j=Object.values(g.current),N=Array.from(new Set(j.map(R=>R.attachmentPath).filter(R=>typeof R=="string"&&R.length>0&&!Ir(R))));N.length!==0&&z.storage.from(Er).remove(N).then(({error:R})=>{R&&console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)}).catch(R=>{console.error("[useFailedOutgoingMessages] Failed to cleanup orphaned attachments",R)})},[e]),n.useEffect(()=>{o&&y(j=>{const N=new Set(o.map(U=>U.id));let R=!1;const k={...j};for(const U of Object.keys(k))N.has(U)||(delete k[U],R=!0);return R?k:j})},[o]);const b=n.useCallback(()=>{c(null),m(null),x(null)},[]),w=n.useCallback((j,N,R)=>{c(R.message||"Couldn't send. Please try again."),N.text.trim()&&r(N.text),m(N),x(j),y(k=>({...k,[j]:N}))},[r]),v=n.useCallback(j=>{j&&(y(N=>{if(!(j in N))return N;const R={...N};return delete R[j],R}),j===p&&b())},[b,p]),C=n.useCallback(()=>{if(!h)return null;const j=p;return j&&y(N=>{if(!(j in N))return N;const R={...N};return delete R[j],R}),b(),{payload:h,tempId:j}},[b,h,p]),M=n.useCallback(j=>{const N=u[j];return N?(y(R=>{if(!(j in R))return R;const k={...R};return delete k[j],k}),j===p?b():c(null),N):null},[b,u,p]),I=n.useCallback(async j=>{if(!e)return;const N=u[j];if(!N)return;const R=me(e);if(a.setQueryData(R,k=>Tr(k,j)),y(k=>{if(!(j in k))return k;const U={...k};return delete U[j],U}),j===p&&b(),N.attachmentPath)try{await Zs(N.attachmentPath)}catch(k){console.error("[useFailedOutgoingMessages] Failed to remove orphaned attachment",k)}},[b,e,u,p,a]);return{sendError:l,setSendError:c,lastFailedPayload:h,lastFailedTempId:p,failedMessages:u,clearBannerState:b,onSendFailed:w,onSendRecovered:v,consumeLastFailedForRetry:C,consumeFailedMessageForRetry:M,discardFailedMessage:I}}const Va=({currentUserId:s})=>{const e=ce();return n.useCallback(r=>{Pe(e,s,r.conversationId,o=>{const a=!!(s&&r.senderId===s);return{...o,lastMessagePreview:xr(r.body)??o.lastMessagePreview,lastMessageAt:r.createdAt??o.lastMessageAt,lastMessageAtLabel:Hs(r.createdAt??null),hasUnread:!a,lastMessageIsFromSelf:a,lastMessageSeenByOthers:a?!1:o.lastMessageSeenByOthers}},{moveToTop:!0}),s&&r.senderId!==s&&Hr({conversation_id:r.conversationId,message_id:r.id,user_id:s})},[s,e])},Wa=({conversationId:s,userId:e,conversation:r,readReceipts:o,visibleMessages:a})=>{const[l,c]=n.useState(void 0),[h,m]=n.useState(void 0);return n.useEffect(()=>{c(void 0),m(void 0)},[s,e]),n.useEffect(()=>{if(!s||!e||l!==void 0)return;const x=(o??[]).find(u=>u.userId===e)??null;c(x?.lastReadMessageId??null)},[s,l,o,e]),n.useEffect(()=>{!s||!e||h===void 0&&r&&m(!!r.hasUnread)},[r,s,h,e]),{firstUnreadIndex:n.useMemo(()=>{if(h===void 0||!h||a.length===0||l===void 0)return null;if(l===null)return 0;const x=a.findIndex(y=>y.message.id===l);if(x<0)return 0;const u=x+1;return u>=a.length?null:u},[h,l,a]),lastReadMessageId:l,hasUnread:h??!1,isReady:h!==void 0&&l!==void 0}};function Ga(s){const{items:e=[],itemContent:r,isLoading:o,loadingContent:a,errorContent:l,emptyContent:c,header:h,footer:m,bottomPadding:p,scrollerRef:x,followOutput:u,onAtBottomChange:y,atBottomThreshold:g=80,onStartReached:f,computeItemKey:b,ariaLabel:w="Messages"}=s,v=X.useRef(null),C=X.useRef(!0),M=X.useRef(null),I=X.useRef(!1),j=X.useCallback(R=>{v.current=R,x&&(typeof x=="function"?x(R):x.current=R)},[x]),N=X.useCallback(R=>R.scrollHeight-R.scrollTop-R.clientHeight<=g,[g]);return X.useLayoutEffect(()=>{const R=v.current;if(!R)return;const k=E=>{C.current=E,M.current!==E&&(M.current=E,y?.(E))},U=()=>{const E=N(R);k(E),f&&(R.scrollTop<=24?I.current||(I.current=!0,f()):R.scrollTop>=80&&(I.current=!1))};return U(),R.addEventListener("scroll",U,{passive:!0}),()=>R.removeEventListener("scroll",U)},[N,y,f]),X.useEffect(()=>{const R=v.current;if(!R)return;const k=C.current,U=typeof u=="function"?u(k):u??!1;U&&k&&requestAnimationFrame(()=>{R.scrollTo({top:R.scrollHeight,behavior:U==="smooth"?"smooth":"auto"})})},[e.length]),o?t.jsx("div",{className:"flex h-full w-full items-center justify-center",children:a}):l?t.jsx("div",{className:"flex h-full w-full items-center justify-center",children:l}):e.length?t.jsx("div",{className:"h-full w-full",children:t.jsx("div",{ref:j,className:"h-full w-full overflow-y-auto overscroll-contain scrollbar-hide",role:"log","aria-label":w,style:{paddingBottom:p??void 0},children:t.jsxs("div",{className:"px-4 pt-3",children:[h,t.jsx("div",{className:"space-y-0",children:e.map((R,k)=>t.jsx(X.Fragment,{children:r(k,R)},b?b(k,R):k))}),m]})})}):t.jsx("div",{className:"flex h-full w-full items-center justify-center",children:c})}const Ya=({show:s,pendingCount:e,onClick:r,shortcutHint:o})=>{if(!s)return null;const a=e>1?`Jump to latest message. ${e} new messages`:"Jump to latest message";return t.jsxs("div",{className:"pointer-events-none absolute inset-x-0 bottom-[calc(env(safe-area-inset-bottom,0)+72px)] z-20 flex justify-center px-3",children:[t.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," new message",e===1?"":"s","."]}),t.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-border bg-background/90 px-3 py-1 text-xs font-medium text-foreground shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[t.jsx(Xr,{className:"h-4 w-4","aria-hidden":!0}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx("span",{children:"Jump to latest"}),e>0&&t.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})},Za=({show:s,unreadCount:e,onClick:r,shortcutHint:o})=>{if(!s||e<=0)return null;const a=e===1?"Jump to the first unread message":`Jump to first unread message. ${e} unread messages`;return t.jsxs("div",{className:"pointer-events-none absolute inset-x-0 top-[calc(env(safe-area-inset-top,0)+56px)] z-20 flex justify-center px-3",children:[t.jsxs("div",{className:"sr-only","aria-live":"polite",children:[e," unread message",e===1?"":"s","."]}),t.jsxs("button",{type:"button",className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-primary/40 bg-background/90 px-3 py-1 text-[12px] font-medium text-primary shadow-md backdrop-blur supports-[backdrop-filter]:backdrop-blur",onClick:r,"aria-label":a,title:o?`${a} (${o})`:a,children:[t.jsx(Jr,{className:"h-4 w-4","aria-hidden":!0}),t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx("span",{children:"Unread"}),t.jsx("span",{className:"inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-primary/10 px-2 py-[2px] text-[11px] font-semibold text-primary",children:e})]})]})]})};function Xa(s){const e=s.trim().split(/\s+/).filter(Boolean);return e.length===0?"?":e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]??""}${e[1][0]??""}`.toUpperCase()}function es({delayMs:s}){return t.jsx("span",{className:"h-2 w-2 rounded-full bg-foreground/35 animate-bounce",style:{animationDelay:`${s}ms`},"aria-hidden":"true"})}function eo({users:s,className:e}){if(!s.length)return null;const r=s.slice(0,3),o=Math.max(0,s.length-r.length);return t.jsxs("div",{className:as("mt-1 flex w-full items-end gap-2 justify-start",e),role:"status","aria-live":"polite","aria-label":s.length===1?`${s[0].displayName} is typing`:"People are typing",children:[t.jsxs("div",{className:"relative flex items-end -space-x-2",children:[r.map(a=>t.jsx("div",{className:"h-7 w-7 flex-shrink-0 overflow-hidden rounded-full border-2 border-background bg-muted shadow-sm",title:a.displayName,children:a.avatarUrl?t.jsx("img",{src:a.avatarUrl,alt:a.displayName,className:"h-full w-full object-cover",loading:"lazy"}):t.jsx("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:Xa(a.displayName)})},a.id)),o>0&&t.jsx("div",{className:"h-7 w-7 flex-shrink-0 rounded-full border-2 border-background bg-muted shadow-sm",children:t.jsxs("div",{className:"flex h-full w-full items-center justify-center text-[10px] font-semibold text-muted-foreground",children:["+",o]})})]}),t.jsx(_r,{isSelf:!1,isDeleted:!1,role:"status",tabIndex:-1,className:"pointer-events-none px-3 py-2 text-sm",children:t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(es,{delayMs:0}),t.jsx(es,{delayMs:120}),t.jsx(es,{delayMs:240})]})})]})}const to=({children:s,className:e,onHeightChange:r,minHeight:o,style:a,...l})=>{const c=X.useRef(null);return X.useEffect(()=>{if(!r||!c.current)return;const h=c.current,m=()=>r(h.getBoundingClientRect().height);m();const p=new ResizeObserver(m);return p.observe(h),()=>p.disconnect()},[r]),t.jsx("div",{ref:c,className:"fixed inset-x-0 bottom-0 z-40 w-full",children:t.jsx("div",{className:"w-full",children:t.jsx("form",{...l,className:as("flex w-full flex-col gap-2 border-t border-border bg-background/95 p-3 shadow-[0_-12px_40px_rgba(0,0,0,0.15)] backdrop-blur-xl",e),style:{minHeight:o,...a},children:s})})})},so=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ¤©","ðŸ¥¹","ðŸ™‚","ðŸ™ƒ","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜’","ðŸ˜­","ðŸ˜¢","ðŸ˜¡","ðŸ¤¯","ðŸ¥³","ðŸ‘","ðŸ‘Ž","ðŸ™Œ","ðŸ‘","ðŸ™","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ©µ","ðŸª„","âœ¨","ðŸ”¥","â­","ðŸŒ™","ðŸŽ¬","ðŸ¿","ðŸŽ‰","ðŸ’¯"],no=({show:s,headerHeight:e,onHeightChange:r,draft:o,setDraft:a,textareaRef:l,noteLocalInputActivity:c,stopTyping:h,onSendText:m,onRequestScrollToBottom:p,isUploadingAttachment:x,pendingAttachment:u,clearPendingAttachment:y,cancelAttachmentUpload:g,sendError:f,sendErrorMessage:b,canRetrySend:w,onRetrySend:v,uploadError:C,clearUploadError:M,showEmojiPicker:I,setShowEmojiPicker:j,openCameraPicker:N,onImageSelected:R,openAttachmentPicker:k,imageInputRef:U,attachmentInputRef:E,onAttachmentSelected:D,onAttachmentFile:F,disableSend:$})=>{const{getNumber:ee}=rs(),ue=Math.max(1,Math.floor(ee("ux.messages.max_message_chars",2e3))),oe=Math.max(60,Math.floor(ee("ux.messages.composer_max_height_px",140))),ct=n.useCallback(T=>{const P=T.target.value,Y=P.length>ue?P.slice(0,ue):P;a(Y),I&&j(!1),c(Y.trim().length>0);const ge=T.target;ge.style.height="auto";const Fe=Math.min(ge.scrollHeight,oe);ge.style.height=`${Fe}px`},[oe,ue,c,a,j,I]),Pt=n.useCallback(T=>{T&&(a(P=>{const Y=`${P}${T}`;return c(Y.trim().length>0),Y}),queueMicrotask(()=>{const P=l.current;P&&(P.style.height="auto",P.style.height=`${Math.min(P.scrollHeight,oe)}px`)}))},[oe,c,a,l]),ut=n.useCallback(T=>{if(T.preventDefault(),$||x)return;const P=o.trim();P&&(a(""),h(),m(P))},[$,o,x,m,a,h]);if(!s)return null;const dt=$||!o.trim()||x,ft=x||$,mt=x||$,gt=u?x?"Uploadingâ€¦":C?"Upload failed":"Ready":null;return t.jsxs(to,{onSubmit:ut,className:"space-y-2",onHeightChange:r,minHeight:e,onDragOver:T=>{!F||$||(T.preventDefault(),T.dataTransfer.dropEffect="copy",T.currentTarget.dataset.dragging="true")},onDragLeave:T=>{T.currentTarget.dataset.dragging="false"},onDrop:T=>{if(!F||$||x)return;T.preventDefault(),T.currentTarget.dataset.dragging="false";const P=T.dataTransfer.files;if(!P||P.length===0)return;const Y=Array.from(P)[0];Y&&F(Y)},children:[u&&t.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[u.kind==="image"&&u.previewUrl?t.jsx("img",{src:u.previewUrl,alt:"",className:"h-12 w-12 rounded-lg object-cover"}):u.kind==="audio"&&u.previewUrl?t.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:t.jsx(ua,{className:"h-5 w-5","aria-hidden":"true"})}):t.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-lg bg-muted/60",children:t.jsx(Ar,{className:"h-5 w-5","aria-hidden":"true"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("p",{className:"text-xs font-semibold text-foreground",children:u.name}),t.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[u.sizeLabel,gt?` â€¢ ${gt}`:""]}),u.kind==="audio"&&u.previewUrl?t.jsx("audio",{controls:!0,src:u.previewUrl,className:"mt-2 w-52",children:t.jsx("track",{kind:"captions",srcLang:"en",label:"Captions"})}):null]})]}),t.jsx(K,{type:"button",size:"sm",variant:"outline",onClick:x?g:y,children:x?"Cancel":"Remove"})]}),x&&t.jsxs("div",{role:"status",className:"flex items-center justify-between gap-3 rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:[t.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[t.jsx(Ne,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),t.jsx("p",{className:"font-semibold text-foreground",children:"Uploading attachmentâ€¦"})]}),t.jsx(K,{type:"button",size:"sm",variant:"outline",onClick:g,children:"Cancel"})]}),f&&t.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ne,{className:"h-3.5 w-3.5","aria-hidden":"true"}),t.jsx("p",{className:"font-semibold",children:b??"Couldn't send. Please try again."})]}),w&&t.jsx(K,{type:"button",size:"sm",variant:"outline",onClick:v,children:"Retry"})]}),C&&t.jsxs("div",{role:"alert",className:"flex items-center justify-between gap-3 rounded-xl border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Vr,{className:"h-3.5 w-3.5","aria-hidden":"true"}),t.jsx("p",{className:"font-semibold",children:C})]}),t.jsx(K,{type:"button",size:"sm",variant:"ghost",onClick:M,children:"Dismiss"})]}),t.jsxs("div",{className:"flex w-full items-center gap-2",children:[t.jsxs(yr,{open:I,onOpenChange:j,children:[t.jsx(br,{asChild:!0,children:t.jsx(K,{type:"button",variant:"ghost",size:"icon","aria-label":"Add emoji",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",children:t.jsx(la,{className:"h-4 w-4","aria-hidden":"true"})})}),t.jsx(vr,{side:"top",align:"start",className:"rounded-2xl border border-border bg-card/95 p-3 shadow-2xl backdrop-blur",children:t.jsx(Dr,{className:"max-h-64",children:t.jsx("div",{className:"grid grid-cols-9 gap-2",children:so.map(T=>t.jsx(K,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-xl text-lg transition hover:bg-muted/60",onClick:()=>{Pt(T),j(!1)},children:t.jsx("span",{children:T})},T))})})})]}),t.jsx(K,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:N,"aria-label":"Send photo",disabled:ft,"aria-busy":x,children:t.jsx(ta,{className:"h-4 w-4","aria-hidden":"true"})}),t.jsx("input",{type:"file",ref:U,accept:"image/*",className:"hidden",onChange:R}),t.jsx(K,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full bg-muted/60 text-muted-foreground shadow-sm transition hover:bg-muted hover:text-foreground",onClick:k,"aria-label":"Add attachment",disabled:mt,"aria-busy":x,children:t.jsx(na,{className:"h-4 w-4","aria-hidden":"true"})}),t.jsx("input",{type:"file",ref:E,accept:"image/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain,text/csv,application/rtf",className:"hidden",onChange:D}),t.jsx("div",{className:"flex max-h-[160px] flex-1 items-end gap-2 rounded-2xl border border-border bg-background/60 px-3 py-2 shadow-inner",children:t.jsx(Xs,{id:"conversation-message",value:o,ref:l,rows:1,autoComplete:"off",onChange:ct,onBlur:h,onPaste:T=>{if(!F||$||x)return;const P=T.clipboardData?.items;if(!P)return;const Y=Array.from(P).find(Fe=>Fe.type.startsWith("image/"));if(!Y)return;const ge=Y.getAsFile();ge&&(T.preventDefault(),p?.(),F(ge))},onKeyDown:T=>{if(T.key==="Enter"&&!T.shiftKey){if($||dt||!o.trim())return;T.preventDefault(),p?.(),T.currentTarget.form?.requestSubmit()}},placeholder:"Message",className:"min-h-[38px] max-h-[140px] flex-1 resize-none border-0 bg-transparent px-0 py-0 text-sm leading-6 text-foreground shadow-none placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-0"})}),t.jsx(K,{type:"submit",variant:"default",size:"icon",className:"h-10 w-10 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90",onMouseDown:T=>T.preventDefault(),disabled:dt,"aria-label":"Send message","aria-busy":x,children:x?t.jsx(Ne,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):t.jsx(aa,{className:"h-4 w-4","aria-hidden":"true"})})]})]})},ro=({open:s,editingMessage:e,onOpenChange:r,onCancel:o,onTextChange:a,onSave:l,textareaRef:c,error:h,isSaving:m})=>t.jsx(is,{open:s,onOpenChange:r,children:t.jsxs(ls,{children:[t.jsxs(en,{children:[t.jsx(cs,{children:"Edit message"}),t.jsx(tn,{children:"Update your message for everyone in the conversation."})]}),e&&t.jsx(Xs,{ref:c,value:e.text,onChange:p=>a(p.target.value),rows:3,className:"min-h-[120px]"}),h&&t.jsx("p",{className:"text-xs text-destructive",children:h}),t.jsxs(sn,{className:"gap-2",children:[t.jsx(K,{type:"button",variant:"ghost",onClick:o,children:"Cancel"}),t.jsxs(K,{type:"button",disabled:!e?.text.trim()||m,onClick:l,children:[m&&t.jsx(Ne,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),t.jsx("span",{children:"Save"})]})]})]})}),ao=({open:s,deleteDialog:e,onOpenChange:r,onHideForMe:o,onDeleteForEveryone:a,isDeleting:l})=>t.jsx(is,{open:s,onOpenChange:r,children:t.jsxs(ls,{children:[t.jsxs(en,{className:"gap-1",children:[t.jsxs(cs,{className:"flex items-center gap-2 text-base",children:[t.jsx("span",{className:"flex h-8 w-8 items-center justify-center rounded-md bg-destructive/10 text-destructive",children:t.jsx(Lr,{className:"h-4 w-4","aria-hidden":!0})}),"Delete message"]}),t.jsx(tn,{children:"Choose whether to hide this message only for you or delete it for everyone."})]}),t.jsxs(sn,{className:"gap-2",children:[t.jsx(K,{type:"button",variant:"outline",className:"flex-1",onClick:o,disabled:!e,children:"Hide for me"}),t.jsxs(K,{type:"button",variant:"destructive",className:"flex-1",disabled:l||!e,onClick:a,children:[l&&t.jsx(Ne,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}),t.jsx("span",{children:"Delete for everyone"})]})]})]})}),oo=({participant:s,onClick:e})=>{const r=(s.displayName??s.username??"?").slice(0,1).toUpperCase();return t.jsxs("button",{type:"button",onClick:e,className:"flex w-full items-center gap-3 rounded-2xl px-3 py-2 text-left transition hover:bg-muted/60",disabled:!e,children:[t.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:s.avatarUrl?t.jsx("img",{src:s.avatarUrl,alt:s.displayName,className:"h-full w-full object-cover",loading:"lazy"}):t.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:r})}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:s.displayName}),t.jsx("p",{className:"truncate text-xs text-muted-foreground",children:s.username?`@${s.username}`:s.isSelf?"You":""})]}),e?t.jsx(W,{name:"chevron_right",className:"text-muted-foreground"}):null]})},io=({open:s,onOpenChange:e,conversation:r,currentUserId:o,conversationId:a,isMuted:l,onToggleMute:c,otherParticipant:h,isGroupConversation:m,youBlocked:p,blockedYou:x,blockPending:u,onBlockToggle:y})=>{const g=Ks(),f=n.useMemo(()=>r?.participants??[],[r?.participants]),b=!m&&!!h?.username&&!h?.isSelf,[w,v]=n.useState(null);n.useEffect(()=>{const j=r?.mutedUntil;if(!l||!j){v(null);return}const N=Date.parse(j);if(!Number.isFinite(N)||N<=Date.now()){v(null);return}try{v(new Date(N).toLocaleString(void 0,{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}))}catch{v(null)}},[r?.mutedUntil,l]);const C=async()=>{const j=`${window.location.origin}/messages/${a}`;await Ps(j)?G.show("Conversation link copied."):G.error("Couldn't copy to clipboard.")},M=async()=>{await Ps(a)?G.show("Conversation ID copied."):G.error("Couldn't copy to clipboard.")},I=j=>{if(!j.username){G.show("This profile can't be opened yet.");return}e(!1),g(`/u/${j.username}`)};return t.jsx(is,{open:s,onOpenChange:e,children:t.jsxs(ls,{className:"top-auto bottom-0 translate-y-0 left-1/2 w-full max-w-3xl rounded-b-none sm:rounded-2xl sm:bottom-6 sm:rounded-b-2xl sm:translate-y-0",children:[t.jsxs("div",{className:"flex items-start justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx(cs,{className:"text-base",children:"Conversation info"}),t.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:m?`${f.length} participants`:h?.username?`@${h.username}`:"Direct message"})]}),t.jsx("button",{type:"button",onClick:()=>e(!1),className:"rounded-full p-2 text-muted-foreground transition hover:bg-muted/60 hover:text-foreground","aria-label":"Close",children:t.jsx(W,{name:"close"})})]}),t.jsxs("div",{className:"grid gap-2",children:[t.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:C,children:[t.jsx(Wr,{className:"h-4 w-4","aria-hidden":!0}),"Copy conversation link"]}),t.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:M,children:[t.jsx(W,{name:"tag",className:"text-base",ariaLabel:"Conversation id"}),"Copy conversation ID"]}),t.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{c(),e(!1)},children:[t.jsx(Kr,{className:"h-4 w-4","aria-hidden":!0}),l?"Unmute notifications":"Mute notifications"]}),w?t.jsxs("p",{className:"-mt-1 px-1 text-xs text-muted-foreground",children:["Muted until ",w]}):null]}),!m&&t.jsxs("div",{className:"mt-2 grid gap-2",children:[t.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:()=>{!b||!h||I(h)},disabled:!b,children:[t.jsx(Gr,{className:"h-4 w-4","aria-hidden":!0}),"View profile"]}),t.jsxs(K,{type:"button",variant:"outline",className:"justify-start gap-2 rounded-2xl",onClick:y,disabled:u||x&&!p,children:[t.jsx(nn,{className:"h-4 w-4","aria-hidden":!0}),p?"Unblock":x?"Blocked":"Block"]}),(x||p)&&t.jsx("p",{className:"text-xs text-muted-foreground",children:x&&!p?"This user has blocked you.":p?"You blocked this user.":null})]}),m&&t.jsx("div",{className:"mt-2 rounded-2xl border border-border bg-muted/30 p-3 text-xs text-muted-foreground",children:"Group admin controls (invite, leave, roles) are coming soon."}),t.jsxs("div",{className:"mt-4",children:[t.jsx("div",{className:"mb-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Participants"}),t.jsx("div",{className:"grid gap-1",children:f.map(j=>t.jsx(oo,{participant:j,onClick:j.username&&j.id!==o?()=>I(j):void 0},j.id))})]})]})})};function lo(){const[s,e]=n.useState(!1);return n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const r=window.matchMedia("(prefers-reduced-motion: reduce)"),o=()=>{e(r.matches)};return o(),typeof r.addEventListener=="function"?(r.addEventListener("change",o),()=>r.removeEventListener("change",o)):(r.addListener(o),()=>r.removeListener(o))},[]),s}const co=2;function uo(s){const{items:e,onJumpToItemIndex:r,minQueryLen:o=co}=s,[a,l]=n.useState(!1),[c,h]=n.useState(""),[m,p]=n.useState(0),x=c.trim().toLowerCase(),u=x.length>=o,y=n.useMemo(()=>{if(!u)return[];const N=[];for(let R=0;R<e.length;R++){const k=e[R];if(k.meta.deleted)continue;const U=Fs(k.message.body);U&&U.toLowerCase().includes(x)&&N.push(R)}return N},[e,x,u]),g=n.useMemo(()=>{const N=new Set;for(const R of y){const k=e[R]?.message.id;k&&N.add(k)}return N},[e,y]),f=y.length;n.useEffect(()=>{p(0)},[x]),n.useEffect(()=>{f!==0&&(m<0&&p(0),m>f-1&&p(f-1))},[m,f]);const b=n.useCallback(N=>{if(f===0)return;const R=(N%f+f)%f;p(R);const k=y[R];typeof k=="number"&&r?.(k)},[f,y,r]),w=n.useCallback(()=>{b(m+1)},[m,b]),v=n.useCallback(()=>{b(m-1)},[m,b]),C=n.useCallback(()=>{b(0)},[b]),M=n.useCallback(()=>{h(""),p(0)},[]),I=n.useCallback(()=>{l(!1),h(""),p(0)},[]),j=n.useMemo(()=>{if(f===0)return null;const N=y[m];return e[N]?.message.id??null},[m,e,f,y]);return{query:c,setQuery:h,isOpen:a,setIsOpen:l,matchCount:f,activeMatchNumber:f===0?0:m+1,activeMatchIndex:f===0?-1:m,activeMessageId:j,isMatch:N=>g.has(N),jumpNext:w,jumpPrev:v,jumpToFirst:C,clear:M,close:I}}function fo(s,e,r,o){if(!r||typeof r!="object"||typeof r.id!="string")return!0;const a=o?.allowAppend??!0,l=o?.forceFailOnce??!1,c=o?.isMountedRef,h=o?.schedule??((u,y)=>{if(!(typeof window>"u"||typeof window.setTimeout!="function"))return window.setTimeout(u,y)});let m=!1;const p=()=>{try{return s.setQueryData(e,u=>{if(l&&!m)throw m=!0,new Error("forced cache updater failure");return zs(u,r,{allowAppend:a})}),!0}catch{return!1}};if(p())return!0;try{s.invalidateQueries?.({queryKey:e})}catch{}const x=[120,400,900];for(const u of x)h(()=>{c&&!c.current||p()},u);return!1}function mo(s,e){return Lt({queryKey:Qs(s),enabled:!!s&&e,staleTime:1e3,refetchInterval:r=>{const o=r.state.data;return o?.is_typing||o?.is_queued?2e3:!1},queryFn:async()=>{if(!s)return null;const{data:r,error:o}=await z.rpc("assistant_reply_status_v1",{p_conversation_id:s});if(o){const a=(o.message??"").toLowerCase();if(a.includes("does not exist")||a.includes("function")||a.includes("schema"))return null;throw new Error(o.message)}return r??null}})}const Ao=()=>{const{conversationId:s}=wr(),e=s??null,r=Ks(),{user:o}=Dt(),a=ce(),l=n.useRef(!0);n.useEffect(()=>(l.current=!0,()=>{l.current=!1}),[]);const c=n.useRef(!1);n.useEffect(()=>{},[]);const h=n.useCallback((i,d)=>{if(!e)return!0;const S=me(e),_=c.current;return _&&(c.current=!1),fo(a,S,i,{allowAppend:d?.allowAppend??!0,forceFailOnce:_,isMountedRef:l})},[e,a]),{getString:m,getNumber:p}=rs(),x=n.useMemo(()=>m("ux.assistant.username","movinesta").toLowerCase(),[m]),u=n.useMemo(()=>m("ux.presence.label_online","Online"),[m]),y=n.useMemo(()=>m("ux.presence.label_active_recently","Active recently"),[m]),g=n.useMemo(()=>m("ux.presence.label_active_prefix","Active"),[m]),f=n.useMemo(()=>{const i=p("ux.messages.search.min_query_chars",2),d=Number.isFinite(i)?Math.trunc(i):2;return Math.max(1,Math.min(10,d))},[p]),{data:b,isLoading:w}=Mr(),v=o?.id??null,C=Qr(),M=n.useMemo(()=>!e||!b?null:b.find(i=>i.id===e)??null,[e,b]),I=M?.isMuted??!1,[j,N]=n.useState(!1),R=n.useCallback(()=>{if(!e)return;if(!v){G.error("Please sign in to manage messages.");return}const i=M?.isMuted??!1,d=M?.mutedUntil??null,S=M?.isHidden??!1;Pe(a,v,e,_=>({..._,isMuted:!1,mutedUntil:null})),G.show("Unmuted notifications."),qs(v,e,{muted:!1,hidden:S,mutedUntil:null}).then(({ok:_})=>{_||(Pe(a,v,e,A=>({...A,isMuted:i,mutedUntil:d})),G.error("Couldn't update preferences."))})},[e,v,M,a]),k=n.useCallback(i=>{if(!e)return;if(!v){G.error("Please sign in to manage messages.");return}const d=M?.isMuted??!1,S=M?.mutedUntil??null,_=M?.isHidden??!1;let A=!1,B=null;i.kind==="indefinite"?(A=!0,B=null):(A=!1,B=new Date(Date.now()+i.minutes*6e4).toISOString()),Pe(a,v,e,fe=>({...fe,isMuted:!0,mutedUntil:B})),G.show(`Muted notifications for ${i.label}.`),qs(v,e,{muted:A,hidden:_,mutedUntil:B}).then(({ok:fe})=>{fe||(Pe(a,v,e,ot=>({...ot,isMuted:d,mutedUntil:S})),G.error("Couldn't update preferences."))})},[e,v,M,a]),U=n.useCallback(()=>{if(I){R();return}N(!0)},[I,R]),E=Va({currentUserId:o?.id??null}),{data:D,isLoading:F,isError:$,error:ee,loadOlder:ue,hasMore:oe,isLoadingOlder:ct,pollWhenRealtimeDown:Pt}=Na(e,{onInsert:E}),ut=n.useRef(new Set);n.useEffect(()=>{if(!e||!D||D.length===0)return;const i=ut.current,d=new Set(D.map(S=>S.id));for(const S of D)i.has(S.id)||E(S);ut.current=d},[e,D,E]);const{draft:dt,setDraft:ft}=Ba({conversationId:e,hydrate:()=>{queueMicrotask(()=>{const i=Je.current;i&&(i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,140)}px`)})}}),{sendError:mt,lastFailedPayload:gt,failedMessages:T,clearBannerState:P,onSendFailed:Y,onSendRecovered:ge,consumeLastFailedForRetry:Fe,consumeFailedMessageForRetry:ds,discardFailedMessage:fs}=Ja({conversationId:e,setDraft:i=>ft(i),messages:D}),Q=M?.isGroup??!1,{getStatus:ms}=jr(),q=n.useMemo(()=>{if(!M)return null;const i=M.participants.filter(d=>!d.isSelf);return i.length>0?i[0]:M.participants.length===1?M.participants[0]:null},[M]),$e=n.useMemo(()=>Q||!q?.id?null:ms(q.id),[ms,Q,q?.id]),gs=Yr(Q?null:q?.id??null),He=n.useMemo(()=>{const i=gs.data??null,d=Hs(i);return d?d==="Just now"?"now":d:null},[gs.data]),ie=n.useMemo(()=>{if(C?.conversationId&&e===C.conversationId)return!0;const i=q;return i?i.username?.toLowerCase()===x:!1},[C?.conversationId,e,q,x]),pe=mo(e,ie).data??null,[pt,ps]=n.useState(!1),[he,xe]=n.useState(null),Ke=n.useRef(null),[Qe,de]=n.useState(null),Ce=X.useRef({inFlight:!1,queuedMessageId:null}),Se=n.useRef(null),ht=n.useRef(null);n.useEffect(()=>()=>{Ke.current&&(Ke.current.abort(),Ke.current=null),Se.current&&(window.clearTimeout(Se.current),Se.current=null),ht.current=null},[]);const[Bt,xt]=n.useState(null),yt=n.useCallback(async i=>{if(!(!e||!v)){if(Ce.current.inFlight){Ce.current.queuedMessageId=i;return}Ce.current.inFlight=!0,Ce.current.queuedMessageId=null,ps(!0),xt(null);try{const d="https://strhxqxvsrecfilfojtc.supabase.co",S="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0cmh4cXh2c3JlY2ZpbGZvanRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTUyNDAsImV4cCI6MjA3OTE3MTI0MH0.DZE2vpUTEqAAIMzT5GUxeV99d98RjDcG-a5IhUtasrI",{data:_}=await z.auth.getSession(),A=_?.session?.access_token??null,B={"Content-Type":"application/json",apikey:S};A&&(B.Authorization=`Bearer ${A}`);const fe=async se=>{const re=await se.text();if(!re)return{message:`Assistant failed (${se.status})`,code:null};try{const J=JSON.parse(re);return{message:J?.message??J?.error??J?.details??re,code:J?.code??J?.errorCode??J?.error_code??null}}catch{return{message:re,code:null}}},ot=(se,re)=>{if(se===415)return!0;const J=`${re.code??""} ${re.message??""}`.toLowerCase();return J.includes("stream")&&J.includes("support")},Tt=async se=>{const re={...B,Accept:se?"text/event-stream":"application/json"},J=new AbortController;se&&(Ke.current=J);const ae=await fetch(`${d}/functions/v1/assistant-chat-reply`,{method:"POST",headers:re,body:JSON.stringify({conversationId:e,userMessageId:i,stream:se}),signal:J.signal});if(!ae.ok){const H=await fe(ae);if(se&&ot(ae.status,H))return{fallback:!0};throw new Error(H.message??`Assistant failed (${ae.status})`)}const ar=ae.headers.get("Content-Type")??"";if(!se||!ar.includes("text/event-stream")||!ae.body){xe(null),de(null);let H=null;try{H=await ae.json()}catch{H=null}if(H&&H.ok===!1)throw new Error(H.message??H.error??"Assistant failed");try{const Le=H?.messageRow;if(!h(Le,{allowAppend:!0})&&(typeof H?.messageId=="string"?H.messageId:null)){const Re=me(e);a.invalidateQueries({queryKey:Re})}}catch{}return{fallback:!1}}xe(""),de(null);const or=ae.body.getReader(),ir=new TextDecoder;let it="",Xt="message",_t=[];const lr=(H,Le)=>{if(H==="delta")try{const V=JSON.parse(Le),ne=typeof V?.text=="string"?V.text:"";ne&&xe(Re=>`${Re??""}${ne}`)}catch{}if(H==="done")try{const V=JSON.parse(Le),ne=Array.isArray(V?.citations)?V.citations.slice(0,8):null,Re=V?.messageRow;if(Re&&typeof Re=="object"&&typeof Re.id=="string"){if(h(Re,{allowAppend:!0})){xe(null),de(null);return}try{const cr=me(e);a.invalidateQueries({queryKey:cr})}catch{}}de({messageId:typeof V?.messageId=="string"?V.messageId:null,citations:ne||null})}catch{de(null)}if(H==="error")try{const V=JSON.parse(Le);throw new Error(V?.message??"Assistant failed")}catch{throw new Error("Assistant failed")}};for(;;){const{value:H,done:Le}=await or.read();if(Le)break;it+=ir.decode(H,{stream:!0});let V;for(;(V=it.indexOf(`
`))>=0;){const ne=it.slice(0,V).replace(/\r$/,"");if(it=it.slice(V+1),!ne.trim()){_t.length&&(lr(Xt,_t.join(`
`)),_t=[],Xt="message");continue}if(ne.startsWith("event:")){Xt=ne.slice(6).trim();continue}ne.startsWith("data:")&&_t.push(ne.slice(5).trimStart())}}return{fallback:!1}};(await Tt(!0)).fallback&&(xe(null),de(null),await Tt(!1))}catch(d){xe(null),de(null),xt({userMessageId:i,error:d?.message||"Assistant failed"})}finally{ps(!1),Ke.current=null,a.invalidateQueries({queryKey:me(e)}),a.invalidateQueries({queryKey:ts(v)}),a.invalidateQueries({queryKey:Qs(e)}),Ce.current.inFlight=!1;const d=Ce.current.queuedMessageId;Ce.current.queuedMessageId=null,d&&d!==i&&yt(d)}}},[e,v,a]),hs=n.useCallback(i=>{!e||!v||ie&&(ht.current=i,Se.current&&window.clearTimeout(Se.current),Se.current=window.setTimeout(()=>{const d=ht.current;ht.current=null,Se.current=null,d&&yt(d)},600))},[e,v,ie,yt]),ln=n.useCallback(async(i,d)=>{if(e)try{const{data:S,error:_}=await z.functions.invoke("assistant-message-action",{body:{conversationId:e,messageId:i,actionId:d}});if(_)throw new Error(_.message||"Action failed");if(!S?.ok)throw new Error(S?.error||"Action failed");const A=S?.toast;A&&G.success(A);const B=S?.navigateTo;B&&r(B)}catch(S){const _=S instanceof Error?S.message:String(S);G.error(_||"Action failed")}finally{e&&a.invalidateQueries({queryKey:me(e)}),v&&a.invalidateQueries({queryKey:ts(v)})}},[e,v,r,a]),ze=M?.title??q?.displayName??q?.username??"Conversation",xs=Ur(e,{onFailed:Y,onRecovered:ge,otherUserId:Q?null:q?.id??null}),Oe=n.useCallback((i,d)=>{P(),xs.mutate({text:i.text,attachmentPath:i.attachmentPath,attachmentKind:i.attachmentKind??null,clientId:i.clientId,tempId:d?.tempId},{onSuccess:async S=>{P(),ie&&e&&v&&(i.text.trim().length>0||i.attachmentPath)&&hs(S.id)}})},[P,e,v,ie,hs,xs]),Je=n.useRef(null),Ft=n.useRef(null),ke=n.useRef(!1),cn=n.useMemo(()=>{const i=new Map;if(!M)return i;for(const d of M.participants)i.set(d.id,d);return i},[M]),{youBlocked:Ve,blockedYou:Z,isBlocked:Ie,block:bt,unblock:vt}=Or(Q?null:q?.id??null),{imageInputRef:un,attachmentInputRef:dn,isUploadingAttachment:fn,pendingAttachment:mn,uploadError:gn,clearPendingAttachment:pn,cancelAttachmentUpload:hn,clearUploadError:xn,handleImageSelected:yn,handleAttachmentSelected:bn,sendAttachmentFile:vn,openImagePicker:wn,openAttachmentPicker:Mn}=qr({conversationId:e,userId:v,isBlocked:Ie,blockedYou:Z,attemptSend:Oe}),We=!Ie&&!Z,$t=!!q&&!Q,jn=bt.isPending||vt.isPending,[Rn,ys]=n.useState(!1),Nn=n.useCallback(()=>{if($t){if(Ve){vt.mutate();return}Z||bt.mutate()}},[bt,Z,$t,vt,Ve]),Ht=$t?{label:Ve?"Unblock":Z?"Blocked":"Block",onClick:()=>{Ve?vt.mutate():Z||bt.mutate()}}:null,{headerRef:Cn,headerHeight:Sn,composerHeight:kn,isAtBottom:Ee,setIsAtBottom:ye,handleComposerHeightChange:bs,showEmojiPicker:In,setShowEmojiPicker:wt}=Fa({showComposer:We}),[En,Mt]=n.useState(!1),vs=We?Math.max(kn,0)+24:40,Tn=`${vs}px`,ws=Math.max(80,vs+32),_n=n.useMemo(()=>M?.participants.find(i=>i.isSelf)?.displayName??"You",[M]),{remoteTypingUsers:be,noteLocalInputActivity:An,stopTyping:Dn}=Pa({conversationId:e,userId:o?.id??null,displayName:_n}),{data:Ms}=Oa(e);Ha({conversationId:e,userId:o?.id??null,isAtBottom:Ee===!0&&En,messages:D});const{reactionsByMessageId:Ln,toggleReaction:js}=Ua(e),Un=n.useCallback((i,d)=>{js.mutate({messageId:i,emoji:d})},[js]),ve=n.useRef(null),Kt=n.useRef(!1),Te=n.useRef(null),Ge=n.useRef(null),jt=n.useRef(!1),qe=n.useRef(!1),Ye=n.useRef(!1),[Rs,_e]=n.useState(0),Ze=n.useRef(null),[we,On]=n.useState(null),Ns=n.useRef(new Map),qn=n.useCallback(i=>{Ze.current=i,On(i)},[]),Xe=n.useRef(!1),[Cs,Rt]=n.useState(!0),Ss=n.useRef(!0),et=lo();n.useEffect(()=>{Ss.current=Cs},[Cs]);const{activeActionMessageId:Pn,openMessageActions:ks,closeMessageActions:Nt,hiddenMessageIds:Is,hideMessageForMe:Bn,deleteDialog:Ae,openDeleteDialog:Fn,closeDeleteDialog:Qt,editingMessage:De,openEditDialog:$n,updateEditingText:Hn,closeEditDialog:zt,editTextareaRef:Kn,editError:Qn,setEditError:Es}=$a({conversationId:e,currentUserId:v,showComposer:We,isBlocked:Ie,blockedYou:Z,composerTextareaRef:Je}),Ct=ka({messages:D,currentUserId:v,hiddenMessageIds:Is}),zn=n.useMemo(()=>Ct?[Ct]:[],[Ct]),{data:Jn}=qa(e,zn),Ts=Qa(e),_s=za(e),{visibleMessages:L}=Sa({messages:D,conversation:M,currentUserId:v,participantsById:cn,reactionsByMessageId:Ln,hiddenMessageIds:Is,deliveryReceipts:Jn??[],readReceipts:Ms??[],failedMessages:T,lastOwnMessageId:Ct});n.useEffect(()=>{const i=Qe?.messageId??null;if(!i)return;if((D??[]).some(_=>String(_?.id??"")===String(i))){xe(null),de(null);return}const S=window.setTimeout(()=>{xe(null),de(null)},8e3);return()=>window.clearTimeout(S)},[Qe?.messageId,D]);const Jt=n.useMemo(()=>{if(!he||!e||!q?.id)return null;const i={id:`assistant_stream_${e}`,conversationId:e,senderId:q.id,createdAt:new Date().toISOString(),body:{type:"text",text:he},attachmentUrl:null,text:he},d=Array.isArray(Qe?.citations)?Qe?.citations:null;return d&&d.length&&(i.meta={ai:{ui:{citations:d}}}),{message:i,meta:{...lt(i.body),streaming:!0},sender:q,isSelf:!1,deliveryStatus:null,showDeliveryStatus:!1,reactions:[]}},[he,Qe,e,q]),{firstUnreadIndex:tt,lastReadMessageId:Me,hasUnread:st,isReady:Vt}=Wa({conversationId:e,userId:o?.id??null,conversation:M,readReceipts:Ms,visibleMessages:L}),As=n.useMemo(()=>{if(!Vt||!st)return 0;let i=tt;if(i==null&&typeof Me=="string"&&Me){const d=L.findIndex(S=>S.message.id===Me);i=d>=0?d+1:null}return i==null?0:L.slice(i).filter(d=>!d.isSelf&&!d.meta.deleted).length},[tt,st,Me,Vt,L]),St=L.length>0,nt=n.useRef(L),Ds=n.useRef(oe),kt=n.useMemo(()=>Jt?[...L,Jt]:L,[Jt,L]),le=et?"auto":"smooth",te=n.useCallback(i=>{const d=Ze.current;d&&(Xe.current=!0,requestAnimationFrame(()=>{d.scrollTo({top:d.scrollHeight,behavior:i??le}),requestAnimationFrame(()=>{Xe.current=!1})}))},[le]),Wt=n.useCallback(()=>{jt.current=!0,Rt(!0),ye(!0),Mt(!0),te("auto")},[te,ye]),rt=n.useCallback((i,d)=>{const S=Ns.current.get(i);return S?(Xe.current=!0,requestAnimationFrame(()=>{S.scrollIntoView({block:d?.align??"end",behavior:d?.behavior??le}),requestAnimationFrame(()=>{Xe.current=!1})}),!0):!1},[le]);n.useEffect(()=>{nt.current=L},[L]),n.useEffect(()=>{Ds.current=oe},[oe]);const It=n.useRef(null),Vn=n.useCallback(()=>{const i=Ze.current;i&&(It.current={active:!0,prevScrollHeight:i.scrollHeight,prevScrollTop:i.scrollTop,prevCount:nt.current.length})},[]);X.useLayoutEffect(()=>{const i=It.current,d=Ze.current;if(!i?.active||!d||L.length<=i.prevCount)return;const _=d.scrollHeight-i.prevScrollHeight;d.scrollTop=i.prevScrollTop+_,It.current=null},[L.length]),n.useEffect(()=>{qe.current=!1,Te.current=null,_e(0)},[e]),n.useEffect(()=>{if(qe.current||!St||!Ze.current)return;const i=L.length-1;i<0||(qe.current=!0,requestAnimationFrame(()=>{te("auto"),Mt(!0),ye(!0),Rt(!0),Te.current=L[i]?.message.id??null,_e(0)}))},[e,St,te,we,ye,L]),n.useEffect(()=>{const i=Ge.current;if(!i)return;if(!L.some(_=>_.message.id===i)){Ge.current=null;return}rt(i,{align:"end",behavior:"auto"})&&(Ge.current=null)},[rt,L]);const Et=L.length>0?L[L.length-1].message.id:null;n.useEffect(()=>{Et&&jt.current&&(jt.current=!1,te("auto"))},[Et,te]),n.useEffect(()=>{Et&&qe.current&&Ss.current&&(It.current?.active||Ge.current||te(le))},[Et,le,te]),n.useEffect(()=>{if(!we)return;const i=()=>{const _=we.scrollHeight-we.scrollTop-we.clientHeight<=ws;Rt(A=>A===_?A:_),ye(A=>A===_?A:_),Mt(!0)};i();const d=()=>{i(),Xe.current||(qe.current=!0,Ye.current=!1)};return we.addEventListener("scroll",d,{passive:!0}),()=>we.removeEventListener("scroll",d)},[we,ws,ye]),n.useEffect(()=>{const i=L.length?L[L.length-1]?.message.id??null:null;if(Ee===!0){Te.current=i,_e(0);return}if(!i)return;const d=Te.current;if(d===i)return;const S=d?L.findIndex(B=>B.message.id===d):-1;if(d&&S<0){Te.current=i,_e(0);return}const A=L.slice(Math.max(0,S+1)).filter(B=>!B.isSelf).length;A<=0||_e(A)},[Ee,L]),n.useEffect(()=>()=>{ve.current!=null&&window.clearTimeout(ve.current)},[]);const Wn=()=>{const i=Fe();i&&Oe(i.payload,{tempId:i.tempId??void 0})},Gn=i=>{ve.current!=null&&window.clearTimeout(ve.current),Kt.current=!1,ve.current=window.setTimeout(()=>{Kt.current=!0,ks(i)},500)},Yn=()=>{ve.current!=null&&(window.clearTimeout(ve.current),ve.current=null)},Zn=n.useCallback(i=>{const d=ds(i.id);d&&Oe(d,{tempId:i.id})},[Oe,ds]),Xn=n.useCallback(i=>{fs(i.id)},[fs]),er=n.useCallback(i=>{if(i<0)return;const d=nt.current[i]?.message.id??null;d&&rt(d,{align:"center"})},[rt]),O=uo({items:L,onJumpToItemIndex:i=>{ke.current=!0,er(i)},minQueryLen:f}),je=O.query.trim().length>=f;n.useEffect(()=>{O.close()},[e,O.close]);const Gt=()=>{Nt(),wt(!1),O.setIsOpen(!0),queueMicrotask(()=>Ft.current?.focus())},at=()=>{O.close()};n.useEffect(()=>{const i=d=>{if(d.key==="Escape"){if(O.isOpen){d.preventDefault(),at();return}Nt(),wt(!1)}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Nt,at,O.isOpen,wt]),n.useEffect(()=>{ke.current=!1},[O.query]);const Yt=n.useCallback(i=>{const d=L.length-1;if(d<0)return;const S=L[d]?.message.id??null;S&&(Te.current=S),_e(0),te(i??le),window.setTimeout(()=>{Je.current?.focus()},et?0:200)},[le,et,L,te]),tr=n.useCallback(i=>{bs(i),Ee===!0&&te("auto")},[bs,Ee,te]),Zt=n.useCallback(async i=>{if(st&&!Ye.current){Ye.current=!0;try{let d=tt;if(d==null&&typeof Me=="string"&&Me){let _=0;for(;Ds.current&&_<8;){const A=nt.current.findIndex(B=>B.message.id===Me);if(A>=0){d=A+1;break}await ue(),_+=1}}if(d==null)return;const S=nt.current[d]?.message.id??null;S&&rt(S,{align:"start",behavior:i??le}),window.setTimeout(()=>{Je.current?.focus()},et?0:150)}finally{Ye.current=!1}}},[tt,st,Vt,Me,ue,et,le]),sr=n.useCallback(i=>{if(!i.trim())return;P(),qe.current=!0,Ye.current=!1,jt.current=!0;const d=Pr(),S=Br();Rt(!0),ye(!0),Mt(!0),Ge.current=d,Oe({text:i.trim(),attachmentPath:null,clientId:S},{tempId:d})},[Oe,P,ye]);n.useEffect(()=>{Te.current=null,_e(0)},[e]),n.useEffect(()=>{const i=d=>{if(d.key.toLowerCase()==="f"&&(d.metaKey||d.ctrlKey)){d.preventDefault(),Gt();return}if(d.key==="End"||d.key==="ArrowDown"&&(d.metaKey||d.ctrlKey)||d.key==="End"&&(d.metaKey||d.ctrlKey)){d.preventDefault(),Yt();return}d.key.toLowerCase()==="u"&&d.altKey&&(d.preventDefault(),Zt())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[Yt,Zt,Gt]);const nr=n.useMemo(()=>{if(Z)return"You are blocked";if(Ie)return"You blocked them";if(ie){if(he!==null)return"Streamingâ€¦";if(pt||pe?.is_typing||pe?.is_queued)return"Typingâ€¦"}if(be.length>0)return Q?be.length===1?`${be[0].displayName??"Someone"} typingâ€¦`:`${be.length} typingâ€¦`:"Typingâ€¦";if(!Q&&$e){if($e==="online")return u;if($e==="away")return y}return!Q&&He?He==="now"?u:`${g} ${He}`:M?.subtitle||(Q?"Group chat":"Direct message")},[Z,Ie,ie,pt,pe?.is_typing,pe?.is_queued,he,Q,$e,He,M?.subtitle,be,u,y,g]),rr=n.useMemo(()=>{const i=M?.participants??[],d=new Map(i.map(A=>[A.id,A])),S=[];for(const A of be){const B=d.get(A.userId),fe=B?.displayName??A.displayName??"Someone";S.push({id:A.userId,displayName:fe,avatarUrl:B?.avatarUrl??null})}return ie&&q?.id&&(pt||he!==null||pe?.is_typing||pe?.is_queued)&&(S.some(B=>B.id===q.id)||S.unshift({id:q.id,displayName:q.displayName??q.username??ze??"Assistant",avatarUrl:q.avatarUrl??null})),S},[pt,he,pe?.is_typing,pe?.is_queued,M?.participants,ze,ie,q,be]);return e?t.jsxs("div",{className:"conversation-page relative flex h-[100dvh] w-full flex-col items-stretch overflow-hidden bg-background text-foreground",children:[t.jsxs("div",{className:"mx-auto flex h-full w-full max-w-3xl flex-1 min-h-0 flex-col items-stretch rounded-none border border-border bg-background sm:rounded-2xl",children:[t.jsxs("div",{ref:Cn,className:"sticky top-0 z-30 border-b border-border bg-background/90 backdrop-blur-md",children:[t.jsxs("header",{className:"flex items-center justify-between px-4 py-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{type:"button",onClick:()=>r(-1),className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Go back",children:t.jsx(W,{name:"arrow_back"})}),t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full bg-muted",children:q?.avatarUrl?t.jsx("img",{src:q.avatarUrl,alt:q.displayName??"Conversation",className:"h-full w-full object-cover"}):t.jsx("div",{className:"flex h-full w-full items-center justify-center text-xs font-semibold text-foreground/80",children:(q?.displayName??ze).slice(0,2).toUpperCase()})}),!Q&&($e==="online"||He==="now")&&t.jsx("span",{className:as("absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-background","bg-green-500"),title:"Online"})]}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("h1",{className:"text-base font-bold leading-none text-foreground",children:ze}),t.jsx("p",{className:"mt-1 text-xs font-medium text-primary",children:nr})]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Search in conversation",onClick:()=>{O.isOpen?at():Gt()},children:t.jsx(W,{name:"search"})}),t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Video call",onClick:()=>G.show("Video calls are coming soon."),children:t.jsx(W,{name:"videocam"})}),t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Conversation info",onClick:()=>ys(!0),children:t.jsx(W,{name:"info"})}),Ht?t.jsx("button",{type:"button",onClick:Ht.onClick,className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":Ht.label,children:t.jsx(nn,{className:"h-4 w-4","aria-hidden":"true"})}):null]})]}),O.isOpen&&t.jsxs("div",{className:"px-4 pb-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx("div",{className:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3",children:t.jsx(W,{name:"search",className:"text-muted-foreground"})}),t.jsx("input",{ref:Ft,value:O.query,onChange:i=>O.setQuery(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(i.preventDefault(),!je||O.matchCount===0)return;if(i.shiftKey){ke.current=!0,O.jumpPrev();return}if(!ke.current){O.jumpToFirst(),ke.current=!0;return}O.jumpNext()}i.key==="Escape"&&(i.preventDefault(),at())},placeholder:"Search messages...",className:"block w-full rounded-full border border-input bg-background py-2.5 pl-10 pr-10 text-sm text-foreground placeholder:text-muted-foreground shadow-sm focus:outline-none focus:ring-2 focus:ring-primary",autoComplete:"off",spellCheck:!1}),O.query.trim()&&t.jsx("button",{type:"button",className:"absolute inset-y-0 right-0 flex items-center pr-3 text-muted-foreground transition hover:text-foreground","aria-label":"Clear search",onClick:()=>{O.clear(),queueMicrotask(()=>Ft.current?.focus())},children:t.jsx(W,{name:"close"})})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Previous match",disabled:!je||O.matchCount===0,onClick:()=>{ke.current=!0,O.jumpPrev()},children:t.jsx(W,{name:"keyboard_arrow_up"})}),t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground disabled:opacity-50","aria-label":"Next match",disabled:!je||O.matchCount===0,onClick:()=>{ke.current=!0,O.jumpNext()},children:t.jsx(W,{name:"keyboard_arrow_down"})}),t.jsx("div",{className:"min-w-[56px] text-right text-xs font-medium text-muted-foreground",children:je?`${O.activeMatchNumber}/${O.matchCount}`:"0/0"}),t.jsx("button",{type:"button",className:"rounded-full p-2 text-muted-foreground transition-colors hover:bg-muted/60 hover:text-foreground","aria-label":"Close search",onClick:at,children:t.jsx(W,{name:"close"})})]})]}),je&&O.matchCount===0&&t.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"No matches found."})]})]}),t.jsxs("section",{className:"flex min-h-0 flex-1 flex-col overflow-hidden",children:[t.jsxs("div",{className:"relative flex min-h-0 flex-1 flex-col overflow-hidden bg-background",children:[Pt&&t.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-2 z-20 flex justify-center px-4",children:t.jsxs("div",{className:"pointer-events-auto inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50/95 px-3 py-1 text-[12px] text-amber-800 shadow-sm",children:[t.jsx(Ne,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":!0}),t.jsx("span",{children:"Live updates slowed â€” polling for changes"})]})}),t.jsx(Ga,{items:kt,isLoading:F&&!St,loadingContent:t.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-border/60 bg-background/80 px-3 py-1.5 text-[12px] text-muted-foreground",children:[t.jsx(Ne,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),t.jsx("span",{children:"Loading messagesâ€¦"})]}),errorContent:$?t.jsxs("div",{className:"mb-3 rounded-md border border-red-500/30 bg-red-500/10 px-3 py-2 text-[12px] text-red-200",children:[t.jsx("p",{className:"font-medium text-red-100",children:"We couldn't load this conversation."}),ee instanceof Error&&t.jsx("p",{className:"mt-1 text-xs text-red-200/70",children:ee.message})]}):void 0,emptyContent:St?void 0:t.jsxs("div",{className:"text-center text-[12px] text-muted-foreground",children:[t.jsx("p",{className:"font-medium text-foreground",children:Q?"No messages in this group yet.":"No messages yet."}),t.jsx("p",{className:"mt-1",children:Q?"Be the first to start the conversation.":"Say hi to start the conversation."})]}),footer:t.jsxs(t.Fragment,{children:[t.jsx(eo,{users:rr}),t.jsx("div",{className:"h-1","aria-hidden":!0})]}),header:oe?t.jsx("div",{className:"flex items-center justify-center pb-2 text-xs text-muted-foreground",children:ct?t.jsxs("span",{className:"inline-flex items-center gap-2",children:[t.jsx(Ne,{className:"h-3.5 w-3.5 animate-spin","aria-hidden":"true"}),"Loading older messagesâ€¦"]}):t.jsx("span",{children:"Scroll up to load older messages"})}):null,bottomPadding:Tn,scrollerRef:qn,onStartReached:()=>{oe&&!ct&&(Vn(),ue())},computeItemKey:(i,d)=>d.message.id,itemContent:(i,d)=>{const{message:S,meta:_,sender:A,isSelf:B,deliveryStatus:fe,reactions:ot,showDeliveryStatus:Tt}=d,Ls=i>0?kt[i-1]?.message??null:null,se=i<kt.length-1?kt[i+1]?.message??null:null,re=J=>{const ae=Ns.current;J?ae.set(S.id,J):ae.delete(S.id)};return t.jsx("div",{ref:re,"data-message-id":S.id,children:t.jsx(Fr,{message:S,meta:_,sender:A,isSelf:B,deliveryStatus:fe,showDeliveryStatus:Tt,reactions:ot,index:i,previousMessage:Ls,nextMessage:se,firstUnreadIndex:tt,activeActionMessageId:Pn,longPressTriggeredRef:Kt,onOpenMessageActions:ks,onCloseMessageActions:Nt,onOpenEditDialog:$n,onOpenDeleteDialog:Fn,onToggleReaction:Un,onRetryMessage:Zn,onDiscardFailedMessage:Xn,onAssistantAction:ln,onBubbleTouchStart:Gn,onBubbleTouchEndOrCancel:Yn,searchQuery:je?O.query:void 0,isSearchMatch:je?O.isMatch(S.id):!1,isActiveSearchMatch:je?O.activeMessageId===S.id:!1})})}}),t.jsx(Za,{show:!!(st&&As>0&&Ee!==!0),unreadCount:As,onClick:Zt,shortcutHint:"Alt+U"}),t.jsx(Ya,{show:Ee!==!0&&Rs>0,pendingCount:Rs,onClick:Yt,shortcutHint:typeof navigator<"u"&&navigator.platform?.includes("Mac")?"âŒ˜+â†“":"End"})]}),Bt&&ie&&We&&t.jsx("div",{className:"px-4 pb-2",children:t.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-xl border bg-background/95 p-2 shadow-sm",children:[t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(W,{name:"error",className:"mt-0.5 text-destructive",ariaLabel:"Error"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold leading-snug",children:"Assistant didn't reply"}),t.jsx("div",{className:"text-[11px] text-muted-foreground leading-snug",children:Bt.error})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 rounded-full border px-3 py-1 text-xs font-semibold hover:bg-muted",onClick:()=>{const i=Bt.userMessageId;xt(null),yt(i)},children:[t.jsx(W,{name:"refresh",className:"text-base"}),"Retry"]}),t.jsx("button",{type:"button",className:"inline-flex items-center rounded-full px-2 py-1 text-xs text-muted-foreground hover:bg-muted",onClick:()=>xt(null),children:"Dismiss"})]})]})}),t.jsx(no,{show:We,headerHeight:Sn,onHeightChange:tr,typingUsers:be,isGroupConversation:Q,draft:dt,setDraft:ft,textareaRef:Je,noteLocalInputActivity:An,stopTyping:Dn,onSendText:sr,onRequestScrollToBottom:Wt,isUploadingAttachment:fn,pendingAttachment:mn,clearPendingAttachment:pn,cancelAttachmentUpload:hn,sendError:!!mt,sendErrorMessage:mt,canRetrySend:!!gt,onRetrySend:Wn,uploadError:gn,clearUploadError:xn,showEmojiPicker:In,setShowEmojiPicker:wt,openCameraPicker:wn,openAttachmentPicker:Mn,imageInputRef:un,attachmentInputRef:dn,onImageSelected:i=>{Wt(),yn(i)},onAttachmentSelected:i=>{Wt(),bn(i)},onAttachmentFile:i=>vn(i),disableSend:!!(Ie||Z)}),Z&&t.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:t.jsx("p",{children:"You can't send messages because this user has blocked you."})}),Ie&&!Z&&t.jsx("div",{className:"sticky bottom-0 z-10 flex-shrink-0 border-t border-border bg-background/95 px-4 py-3 text-center text-xs text-muted-foreground",children:t.jsx("p",{children:"You've blocked this user. Unblock them to continue the conversation."})})]})]}),t.jsx(ro,{open:!!De,editingMessage:De,onOpenChange:i=>{i||zt()},onCancel:zt,onTextChange:Hn,textareaRef:Kn,error:Qn,isSaving:Ts.isPending,onSave:()=>{if(!De)return;const i=De.text.trim();i&&(Es(null),Ts.mutate({messageId:De.messageId,text:i,currentBody:De.body,attachmentUrl:De.attachmentUrl},{onSuccess:()=>{zt()},onError:()=>{Es("Couldn't save changes. Please try again.")}}))}}),t.jsx(ao,{open:!!Ae,deleteDialog:Ae,onOpenChange:i=>{i||Qt()},onHideForMe:()=>{Ae&&(Bn(Ae.messageId),Qt())},onDeleteForEveryone:()=>{Ae&&_s.mutate({messageId:Ae.messageId,attachmentUrl:Ae.attachmentUrl},{onSettled:()=>{Qt()}})},isDeleting:_s.isPending}),e&&t.jsx(io,{open:Rn,onOpenChange:ys,conversation:M,currentUserId:v,conversationId:e,isMuted:I,onToggleMute:U,otherParticipant:q,isGroupConversation:Q,youBlocked:Ve,blockedYou:Z,blockPending:jn,onBlockToggle:Nn}),e&&t.jsx(zr,{open:j,onOpenChange:N,conversationTitle:ze,onSelect:i=>k(i)})]}):t.jsx("div",{className:"flex min-h-[60vh] items-center justify-center px-4",children:t.jsxs("div",{className:"max-w-md rounded-xl border border-border bg-card px-5 py-6 text-center text-sm text-foreground",children:[t.jsx("h1",{className:"text-base font-heading font-semibold",children:"Conversation not found"}),t.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"This page is meant to be opened from your messages list."}),t.jsx("p",{className:"mt-4",children:t.jsx(Rr,{to:"/messages",className:"inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-[12px] font-medium text-foreground",children:"Back to messages"})})]})})};export{Ao as default,Ur as useSendMessage};
