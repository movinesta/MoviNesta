import{j as e,o as ue,u as xe,R as X,e as F,d as pe,q as M,t as ee,L as A,k as te,s as k}from"./index-DlWPTL3h.js";import{u as ge,a as fe}from"./useDiaryLibrary-DtONFBgO.js";import{d as he,a as be}from"./diaryStatus-BH3whMXG.js";import{P as N}from"./PageChrome-Ca0Bw2H1.js";import{C as $}from"./Chip-BH3yo9Vz.js";import{T as D}from"./TopBar-Cwkp26YK.js";const re=({value:a,max:c=5,disabled:o,onChange:g,size:h="sm"})=>{const t=a??0,b=h==="sm"?"inline-flex h-5 w-5 items-center justify-center rounded-full border text-xs transition":"inline-flex h-6 w-6 items-center justify-center rounded-full border text-sm transition";return e.jsx("div",{className:"flex items-center gap-0.5",children:Array.from({length:c}).map((U,l)=>{const d=l+1,f=t>=d;return e.jsx("button",{type:"button",onClick:()=>{if(!g||o)return;g(t===d?null:d)},disabled:o,className:`${b} ${f?"border-primary/80 bg-primary/90 text-primary-foreground":"border-border bg-card/60 text-muted-foreground hover:border-primary/70 hover:text-primary/90"}`,"aria-label":`Rate ${d} star${d===1?"":"s"}`,children:"★"},d)})})},ye=({imdb_rating:a,rt_tomato_pct:c,metascore:o})=>{if(!(typeof a=="number"&&a>0||typeof c=="number"&&c>0||typeof o=="number"&&o>0))return null;const h=typeof a=="number"&&!Number.isNaN(a)&&a>0,t=typeof c=="number"&&!Number.isNaN(c)&&c>0,b=typeof o=="number"&&!Number.isNaN(o)&&o>0;return e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-muted-foreground",children:[h&&e.jsxs($,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"IMDb"}),e.jsx("span",{children:a.toFixed(1)})]}),t&&e.jsxs($,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"Tomatometer"}),e.jsxs("span",{children:[c,"%"]})]}),b&&e.jsxs($,{variant:"outline",className:"gap-1 px-2 py-0.5",children:[e.jsx("span",{className:"font-semibold",children:"MC"}),e.jsx("span",{children:o})]})]})},Te=()=>{const{titleId:a}=ue(),c=xe(),[o,g]=X.useState(null),h=async r=>{if(!l?.id){alert("You need to be signed in to start a conversation.");return}if(l.id!==r){g(r);try{const s=await te("create-direct-conversation",{targetUserId:r},{timeoutMs:25e3});if(!s?.ok||!s.conversationId){const i=s?.errorCode;let x=s?.error??"Failed to get conversation id. Please try again.";i==="UNAUTHORIZED"?x="You need to be signed in to start a conversation.":i==="BAD_REQUEST_SELF_TARGET"?x="You can't start a conversation with yourself.":i==="SERVER_MISCONFIGURED"&&(x="Messaging is temporarily unavailable due to a server issue. Please try again later.");const v=new Error(x);throw v.code=i,v}c(`/messages/${s.conversationId}`)}catch(s){console.error("[TitleDetailPage] Failed to start conversation",s);const i=s instanceof Error?s.message:"Something went wrong while starting the conversation. Please try again.";alert(i)}finally{g(null)}}},{data:t,isLoading:b,isError:U}=F({queryKey:M.titleDetail(a),enabled:!!a,staleTime:1e3*60*30,gcTime:1e3*60*60,refetchOnWindowFocus:!1,queryFn:async()=>{if(!a)return null;const{data:r,error:s}=await k.from("titles").select(`
          title_id,
          content_type,
          primary_title,
          original_title,
          sort_title,
          release_year,
          release_date,
          runtime_minutes,
          tmdb_runtime,
          tmdb_episode_run_time,
          plot,
          tmdb_overview,
          tagline,
          omdb_director,
          omdb_actors,
          genres,
          tmdb_genre_names,
          language,
          omdb_language,
          tmdb_original_language,
          country,
          omdb_country,
          imdb_rating,
          imdb_votes,
          metascore,
          rt_tomato_pct,
          poster_url,
          tmdb_poster_path,
          backdrop_url
        `).eq("title_id",a).maybeSingle();if(s)throw s;return r}}),{user:l}=pe(),{updateStatus:d,updateRating:f}=ge(),{data:q}=fe(a),m=q??{status:null,rating:null},{data:T,isLoading:se}=F({queryKey:M.friendsTitleReactions(l?.id??null,a),enabled:!!(l?.id&&a),staleTime:1e3*60,refetchOnWindowFocus:!0,refetchOnReconnect:!0,queryFn:async()=>{if(!l?.id||!a)return[];const r=l.id,{data:s,error:i}=await k.from("follows").select("followed_id").eq("follower_id",r).limit(80);if(i)throw i;const x=(s??[]).map(n=>n.followed_id).filter(Boolean);if(!x.length)return[];const{data:v,error:H}=await k.from("ratings").select("user_id, rating, created_at").eq("title_id",a).in("user_id",x).order("rating",{ascending:!1}).limit(40);if(H)throw H;const Z=(v??[]).map(n=>n.user_id);if(!Z.length)return[];const{data:de,error:J}=await k.from("profiles").select("id, display_name, username, avatar_url").in("id",Z);if(J)throw J;const ce=new Map((de??[]).map(n=>[n.id,{displayName:n.display_name??null,username:n.username??null,avatarUrl:n.avatar_url??null}])),me=(v??[]).map(n=>{const p=n.user_id,L=ce.get(p);return{userId:p,displayName:L?.displayName??null,username:L?.username??null,avatarUrl:L?.avatarUrl??null,rating:n.rating??null,createdAt:n.created_at??null}}),E=new Map;for(const n of me){const p=E.get(n.userId);(!p||(n.rating??0)>(p.rating??0))&&E.set(n.userId,n)}return Array.from(E.values()).sort((n,p)=>(p.rating??0)-(n.rating??0))}}),{data:ae,isLoading:B}=F({queryKey:M.moreLikeThis(a),enabled:!!a,staleTime:1e3*60*10,gcTime:1e3*60*60,queryFn:async()=>{if(!a)return[];const r=await te("swipe-more-like-this",{titleId:a},{timeoutMs:25e3});return(Array.isArray(r?.cards)?r.cards:[]).filter(i=>!!(i?.id&&i?.title))}}),w=t?t.poster_url??ee(t.tmdb_poster_path,"w500"):null,_=t?t.backdrop_url:null;if(X.useEffect(()=>{const r=[w,_].filter(s=>!!s);r.length!==0&&r.forEach(s=>{const i=new Image;i.src=s})},[w,_]),!a)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(D,{title:"Title details",subtitle:"Pick something from search, your diary, or the feed to see its details."}),e.jsx(N,{children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No title was specified for this page. Try opening it from search, your diary, or the"," ","home feed."]})})]});if(b)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(D,{title:"Loading title"}),e.jsx(N,{children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"h-40 w-28 animate-pulse rounded-2xl bg-card/60 sm:h-52 sm:w-36"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-4 w-2/3 animate-pulse rounded bg-card/60"}),e.jsx("div",{className:"h-3 w-1/3 animate-pulse rounded bg-card/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"h-3 w-full animate-pulse rounded bg-card/40"}),e.jsx("div",{className:"h-3 w-5/6 animate-pulse rounded bg-card/30"}),e.jsx("div",{className:"h-3 w-3/4 animate-pulse rounded bg-card/30"})]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("div",{className:"h-6 w-20 animate-pulse rounded-full bg-card/50"}),e.jsx("div",{className:"h-6 w-24 animate-pulse rounded-full bg-card/40"})]})]})]})})]});if(U||!t)return e.jsxs("div",{className:"flex flex-1 flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsx(D,{title:"Title not found"}),e.jsxs(N,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"We couldn't find that title."}),e.jsx(A,{to:"/search",className:"mt-3 inline-block text-sm text-primary underline",children:"Back to search"})]})]});const I=t.primary_title??t.original_title??"Untitled",Y=t.release_year??(t.release_date?new Date(t.release_date).getFullYear():null),y=t.runtime_minutes??t.tmdb_runtime??(Array.isArray(t.tmdb_episode_run_time)&&t.tmdb_episode_run_time.length>0?t.tmdb_episode_run_time[0]:null),O=typeof y=="number"&&y>0?`${Math.floor(y/60)}h ${y%60?`${y%60}m`:""}`.trim():null,S=t.content_type==="movie"?"Movie":t.content_type==="series"?"TV Series":t.content_type??null,z=t.language??t.omdb_language??t.tmdb_original_language??null,K=t.country??t.omdb_country??null,C=t.genres&&t.genres.length>0&&t.genres||t.tmdb_genre_names&&t.tmdb_genre_names.length>0&&t.tmdb_genre_names||[],j=t.plot??t.tmdb_overview??null,W=ae??[],u=[];Y&&u.push(String(Y)),S&&u.push(S),O&&u.push(O),K&&u.push(K),z&&u.push(z);const ne=t.imdb_rating,ie=t.metascore,le=t.rt_tomato_pct,V=t.content_type==="movie"||t.content_type==="series"?t.content_type:null,G=()=>l?!0:(alert("Sign in to save this title to your diary or leave a rating."),!1),R=r=>{!G()||d.isPending||d.mutate({titleId:t.title_id,status:r,type:V})},Q=r=>{!G()||f.isPending||f.mutate({titleId:t.title_id,rating:r,type:V})},oe=u.length>0?u.join(" · "):"Title details",P=r=>m?.status===r;return e.jsxs("div",{className:"mx-auto flex min-h-[60vh] max-w-5xl flex-col gap-4 px-3 pb-6 pt-2 sm:px-4 lg:px-6",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-3xl border border-border bg-card/80 shadow-md",children:[e.jsxs("div",{className:"absolute inset-0",children:[_?e.jsx("img",{src:_,alt:I,className:"h-full w-full scale-105 object-cover blur-[1px]"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-background via-background/70 to-card"}),e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-r from-background via-background/80 to-background/40"})]}),e.jsxs("div",{className:"relative z-10 flex flex-col gap-4 p-4 sm:p-6 md:flex-row md:items-end",children:[e.jsx("div",{className:"w-28 flex-shrink-0 sm:w-32 md:w-40",children:w?e.jsx("img",{src:w,alt:I,className:"aspect-[2/3] w-full rounded-2xl object-cover shadow-lg",loading:"lazy"}):e.jsx("div",{className:"flex aspect-[2/3] items-center justify-center rounded-2xl border border-dashed border-border bg-background/70 text-xs text-muted-foreground",children:"No poster available"})}),e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.12em] text-muted-foreground",children:S??"Title"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground sm:text-3xl",children:I}),e.jsx("p",{className:"text-[12.5px] text-muted-foreground",children:oe})]}),j&&e.jsx("p",{className:"max-w-3xl text-sm leading-relaxed text-muted-foreground sm:text-[14px]",children:j}),e.jsx(ye,{imdb_rating:ne,rt_tomato_pct:le,metascore:ie}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>R("want_to_watch"),disabled:d.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${P("want_to_watch")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Add to watchlist"}),e.jsx("button",{type:"button",onClick:()=>R("watching"),disabled:d.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${P("watching")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"I’m watching"}),e.jsx("button",{type:"button",onClick:()=>R("watched"),disabled:d.isPending,className:`inline-flex items-center rounded-full border px-3 py-1 text-[11.5px] font-semibold transition ${P("watched")?"border-primary bg-primary/10 text-primary":"border-border bg-background text-foreground hover:border-primary/60 hover:text-primary"}`,children:"Log as watched"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-[12px] text-muted-foreground",children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Your rating"}),e.jsx(re,{value:m?.rating??null,disabled:f.isPending,onChange:Q}),m?.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[m.rating,"/10"]})]}),!l&&e.jsxs("p",{className:"text-[11.5px] text-muted-foreground",children:[e.jsx(A,{to:"/auth",className:"font-medium text-primary underline",children:"Sign in"})," ","to log this title, rate it, or add it to your watchlist."]})]})]})]}),e.jsxs(N,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"More like this"}),B&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Loading…"})]}),B?e.jsx("div",{className:"mt-3 flex gap-2 overflow-x-auto pb-1",children:Array.from({length:6}).map((r,s)=>e.jsx("div",{className:"h-40 w-28 flex-shrink-0 animate-pulse rounded-xl border border-border bg-card/70"},s))}):W.length>0?e.jsx("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2",children:W.map(r=>{const s=r.posterUrl??(r.tmdbPosterPath?ee(r.tmdbPosterPath,"w342"):null);return e.jsxs("button",{type:"button",onClick:()=>c(`/title/${r.id}`),className:"flex w-28 flex-shrink-0 flex-col gap-1 text-left",children:[e.jsx("div",{className:"aspect-[2/3] w-28 overflow-hidden rounded-xl border border-border bg-card/80",children:s?e.jsx("img",{src:s,alt:r.title,className:"h-full w-full object-cover",loading:"lazy"}):e.jsx("div",{className:"flex h-full w-full items-center justify-center text-[11px] text-muted-foreground",children:"No poster"})}),e.jsx("span",{className:"line-clamp-2 text-[12px] text-foreground",children:r.title}),r.year&&e.jsx("span",{className:"text-[11px] text-muted-foreground",children:r.year})]},r.id)})}):e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"No similar titles yet."})]}),e.jsx(N,{children:e.jsx("div",{className:"flex flex-col gap-4 md:flex-row",children:e.jsxs("div",{className:"flex flex-1 flex-col gap-3",children:[e.jsxs("div",{className:"rounded-2xl border border-border bg-background/80 px-3 py-3 text-[12px] text-muted-foreground",children:[t.tagline&&e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.tagline}),j&&e.jsx("p",{className:"mt-1 text-[12.5px] leading-relaxed text-muted-foreground",children:j}),!t.tagline&&!j&&e.jsx("p",{className:"text-[12px] text-muted-foreground",children:"We don't have a plot summary for this title yet."}),C&&C.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:C.slice(0,6).map(r=>e.jsx("span",{className:"rounded-full border border-border px-2 py-[2px] text-xs text-muted-foreground",children:r},r))}),(t.omdb_director||t.omdb_actors)&&e.jsxs("div",{className:"mt-2 space-y-1 text-[11.5px] text-muted-foreground",children:[t.omdb_director&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Director:"})," ",t.omdb_director]}),t.omdb_actors&&e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-foreground",children:"Cast:"})," ",t.omdb_actors]})]})]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Your diary"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"Keep this title synced with the same diary data used across MoviNesta."})]}),l&&e.jsxs("div",{className:"flex flex-col items-end gap-2 text-xs",children:[e.jsx("span",{className:be(m?.status),children:he(m?.status)}),e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Rating"}),e.jsx(re,{value:m?.rating??null,disabled:f.isPending,onChange:Q})]})]})]}),!l&&e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Sign in to see your diary status and ratings for this title."})]}),l&&!se&&T&&T.length>0&&e.jsxs("div",{className:"rounded-2xl border border-border bg-card/80 px-3 py-3 text-[12px] text-muted-foreground",children:[e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:"Friends who liked this"}),e.jsx("p",{className:"mt-0.5 text-[11.5px] text-muted-foreground",children:"See which friends have rated this title and how they felt about it."})]})}),e.jsx("div",{className:"mt-2 flex flex-col gap-2",children:T.slice(0,4).map(r=>{const s=r.displayName??(r.username?`@${r.username}`:"Friend");return e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-xl border border-border bg-background/80 px-2.5 py-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-card text-xs font-semibold text-foreground",children:r.avatarUrl?e.jsx("img",{src:r.avatarUrl,alt:s??"Friend avatar",className:"h-7 w-7 rounded-full object-cover"}):(s??"?")[0]?.toUpperCase()}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[11.5px] font-medium text-foreground",children:s}),r.rating!=null&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Rated ",r.rating,"/10"]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(A,{to:r.username?`/u/${r.username}`:`/u/${r.userId}`,className:"text-xs font-medium text-primary underline",children:"View profile"}),e.jsx("button",{type:"button",onClick:()=>h(r.userId),disabled:o===r.userId,className:"text-xs font-medium text-primary/90 underline disabled:cursor-not-allowed disabled:opacity-60",children:o===r.userId?"Starting…":"Message"})]})]},r.userId)})})]})]})})})]})};export{Te as default};
